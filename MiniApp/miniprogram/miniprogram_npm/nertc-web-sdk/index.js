module.exports = (function() {
var __MODS__ = {};
var __DEFINE__ = function(modId, func, req) { var m = { exports: {}, _tempexports: {} }; __MODS__[modId] = { status: 0, func: func, req: req, m: m }; };
var __REQUIRE__ = function(modId, source) { if(!__MODS__[modId]) return require(source); if(!__MODS__[modId].status) { var m = __MODS__[modId].m; m._exports = m._tempexports; var desp = Object.getOwnPropertyDescriptor(m, "exports"); if (desp && desp.configurable) Object.defineProperty(m, "exports", { set: function (val) { if(typeof val === "object" && val !== m._exports) { m._exports.__proto__ = val.__proto__; Object.keys(val).forEach(function (k) { m._exports[k] = val[k]; }); } m._tempexports = val }, get: function () { return m._tempexports; } }); __MODS__[modId].status = 1; __MODS__[modId].func(__MODS__[modId].req, m, m.exports); } return __MODS__[modId].m.exports; };
var __REQUIRE_WILDCARD__ = function(obj) { if(obj && obj.__esModule) { return obj; } else { var newObj = {}; if(obj != null) { for(var k in obj) { if (Object.prototype.hasOwnProperty.call(obj, k)) newObj[k] = obj[k]; } } newObj.default = obj; return newObj; } };
var __REQUIRE_DEFAULT__ = function(obj) { return obj && obj.__esModule ? obj.default : obj; };
__DEFINE__(1670910583241, function(require, module, exports) {
/*! NeRTC 4.6.25|BUILD v4.6.25-0-gd2caa70b production */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.NERTC=t():e.NERTC=t()}(window,(function(){return function(e){var t={};function i(r){if(t[r])return t[r].exports;var s=t[r]={i:r,l:!1,exports:{}};return e[r].call(s.exports,s,s.exports,i),s.l=!0,s.exports}return i.m=e,i.c=t,i.d=function(e,t,r){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)i.d(r,s,function(t){return e[t]}.bind(null,s));return r},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=204)}([function(e,t){var i=e.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=i)},function(e,t,i){var r=i(32)("wks"),s=i(23),a=i(0).Symbol,o="function"==typeof a;(e.exports=function(e){return r[e]||(r[e]=o&&a[e]||(o?a:s)("Symbol."+e))}).store=r},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.IS_MIBROWSER=t.ELECTRON_VERSION=t.IS_ELECTRON=t.IS_UCBROWSER=t.IS_WX=t.IS_LINUX=t.MACOS_VERSION=t.IS_MAC=t.WIN_VERSION=t.IS_WIN=t.IPADQQB_VERSION=t.IS_IPADQQB=t.MACQQB_VERSION=t.IS_MACQQB=t.WQQB_VERSION=t.IS_WQQB=t.MQQB_VERSION=t.IS_MQQB=t.IS_X5MQQB=t.WECHAT_MAJOR_VERSION=t.WECHAT_VERSION=t.IS_WECHAT=t.IE_VERSION=t.IS_IE=t.IS_IE8=t.XWEB_VERSION=t.IS_XWEB=t.TBS_VERSION=t.IS_TBS=t.SOGOU_VERSION=t.IS_SOGOU=t.SOGOUM_VERSION=t.IS_SOGOUM=t.EDG_VERSION=t.EDG_MAJOR_VERSION=t.IS_EDG=t.EDGE_VERSION=t.IS_EDGE=t.FIREFOX_MAJOR_VERSION=t.FIREFOX_VERSION=t.IS_FIREFOX=t.ANDROID_VERSION=t.IS_ANDROID=t.IOS_VERSION=t.IS_IOS=t.IS_IPOD=t.IS_IPHONE=t.IS_IPAD=t.USER_LANGUAGE=t.USER_AGENT=void 0,t.IS_EN=t.IS_ZH=t.IS_LOCAL=t.IS_IOS_SAFARI=t.IS_MAC_SAFARI=t.SAFARI_VERSION=t.SAFARI_MAJOR_VERSION=t.IS_ANY_SAFARI=t.IS_SAFARI=t.CHROME_VERSION=t.CHROME_MAJOR_VERSION=t.IS_CHROME=t.IS_CHROME_ONLY=t.VIVO_VERSION=t.IS_VIVOBROWSER=t.OPPO_VERSION=t.IS_OPPOBROWSER=t.SAMSUNG_VERSION=t.IS_SAMSUNGBROWSER=t.HUAWEI_VERSION=t.IS_HUAWEIBROWSER=t.MI_VERSION=void 0,t.USER_AGENT=window.navigator&&window.navigator.userAgent||"",t.USER_LANGUAGE=window.navigator&&window.navigator.language,t.IS_IPAD=/iPad/i.test(t.USER_AGENT),t.IS_IPHONE=/iPhone/i.test(t.USER_AGENT)&&!t.IS_IPAD,t.IS_IPOD=/iPod/i.test(t.USER_AGENT),t.IS_IOS=t.IS_IPHONE||t.IS_IPAD||t.IS_IPOD,t.IOS_VERSION=t.IS_IOS&&function(){const e=t.USER_AGENT.match(/\b[0-9]+_[0-9]+(?:_[0-9]+)?\b/)||[""];return e&&e[0]?e[0].replace(/_/g,"."):null}(),t.IS_ANDROID=/Android/i.test(t.USER_AGENT),t.ANDROID_VERSION=t.IS_ANDROID&&function(){const e=t.USER_AGENT.match(/Android (\d+)(?:\.(\d+))?(?:\.(\d+))*/i);if(!e)return null;const i=e[1],r=e[2],s=e[3];return i&&r&&s?i+"."+r+"."+s:i&&r?i+"."+r:i||null}(),t.IS_FIREFOX=/Firefox/i.test(t.USER_AGENT),t.FIREFOX_VERSION=t.IS_FIREFOX&&function(){const e=navigator.userAgent.match(/Firefox\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.FIREFOX_MAJOR_VERSION=t.IS_FIREFOX&&function(){const e=t.USER_AGENT.match(/Firefox\/(\d+)/);return e&&e[1]?parseFloat(e[1]):null}(),t.IS_EDGE=/Edge\//i.test(t.USER_AGENT),t.EDGE_VERSION=t.IS_EDGE&&function(){var e=t.USER_AGENT.match(/Edge\/(\d+)/i);if(e&&e[1])return e[1]}(),t.IS_EDG=/Edg\//i.test(t.USER_AGENT),t.EDG_MAJOR_VERSION=t.IS_EDG&&function(){const e=t.USER_AGENT.match(/Edg\/(\d+)/);return e&&e[1]?parseFloat(e[1]):null}(),t.EDG_VERSION=t.IS_EDG&&function(){const e=t.USER_AGENT.match(/Edg\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IS_SOGOUM=/SogouMobileBrowser\//i.test(t.USER_AGENT),t.SOGOUM_VERSION=t.IS_SOGOUM&&function(){const e=t.USER_AGENT.match(/SogouMobileBrowser\/(\d+)/);return e&&e[1]?parseFloat(e[1]):null}(),t.IS_SOGOU=/MetaSr\s/i.test(t.USER_AGENT),t.SOGOU_VERSION=t.IS_SOGOU&&function(){const e=t.USER_AGENT.match(/MetaSr(\s\d+(\.\d+)+)/);return e&&e[1]?parseFloat(e[1]):null}(),t.IS_TBS=/TBS\/\d+/i.test(t.USER_AGENT),t.TBS_VERSION=t.IS_TBS&&function(){var e=t.USER_AGENT.match(/TBS\/(\d+)/i);if(e&&e[1])return e[1]}(),t.IS_XWEB=/XWEB\/\d+/i.test(t.USER_AGENT),t.XWEB_VERSION=t.IS_XWEB&&function(){var e=t.USER_AGENT.match(/XWEB\/(\d+)/i);if(e&&e[1])return e[1]}(),t.IS_IE8=/MSIE\s8\.0/.test(t.USER_AGENT),t.IS_IE=/MSIE\/\d+/i.test(t.USER_AGENT),t.IE_VERSION=t.IS_IE&&function(){const e=/MSIE\s(\d+)\.\d/.exec(t.USER_AGENT);let i=e&&parseFloat(e[1]);return!i&&/Trident\/7.0/i.test(t.USER_AGENT)&&/rv:11.0/.test(t.USER_AGENT)&&(i=11),i}(),t.IS_WECHAT=/(micromessenger|webbrowser)/i.test(t.USER_AGENT),t.WECHAT_VERSION=t.IS_WECHAT&&function(){var e=navigator.userAgent.match(/MicroMessenger\/([\d.]+)/);if(e&&e[1])return e[1]}(),t.WECHAT_MAJOR_VERSION=t.IS_WECHAT&&function(){var e=t.USER_AGENT.match(/MicroMessenger\/(\d+)/i);if(e&&e[1])return parseFloat(e[1])}(),t.IS_X5MQQB=!t.IS_TBS&&/MQQBrowser\/\d+/i.test(t.USER_AGENT)&&/COVC\/\d+/i.test(t.USER_AGENT),t.IS_MQQB=!t.IS_TBS&&/MQQBrowser\/\d+/i.test(t.USER_AGENT)&&!/COVC\/\d+/i.test(t.USER_AGENT),t.MQQB_VERSION=(t.IS_MQQB||t.IS_X5MQQB)&&function(){const e=t.USER_AGENT.match(/ MQQBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IS_WQQB=!t.IS_TBS&&/ QQBrowser\/\d+/i.test(t.USER_AGENT),t.WQQB_VERSION=t.IS_WQQB&&function(){const e=t.USER_AGENT.match(/ QQBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IS_MACQQB=!t.IS_TBS&&/QQBrowserLite\/\d+/i.test(t.USER_AGENT),t.MACQQB_VERSION=t.IS_MACQQB&&function(){const e=t.USER_AGENT.match(/QQBrowserLite\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IS_IPADQQB=!t.IS_TBS&&/MQBHD\/\d+/i.test(t.USER_AGENT),t.IPADQQB_VERSION=t.IS_IPADQQB&&function(){const e=t.USER_AGENT.match(/MQBHD\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IS_WIN=/Windows/i.test(t.USER_AGENT),t.WIN_VERSION=t.IS_WIN&&function(){const e=t.USER_AGENT.match(/Windows NT (\d+)(?:\.(\d+))?(?:\.(\d+))*/i),i=e&&e[1],r=e&&e[2];return i&&r?i+"."+r:i||null}(),t.IS_MAC=!t.IS_IOS&&/MAC OS X/i.test(t.USER_AGENT),t.MACOS_VERSION=t.IS_MAC&&function(){const e=t.USER_AGENT.match(/\b[0-9]+_[0-9]+(?:_[0-9]+)?\b/)||[""];return e&&e[0]?e[0].replace(/_/g,"."):null}(),t.IS_LINUX=!t.IS_ANDROID&&/Linux/i.test(t.USER_AGENT),t.IS_WX=/MicroMessenger/i.test(t.USER_AGENT),t.IS_UCBROWSER=/UCBrowser/i.test(t.USER_AGENT),t.IS_ELECTRON=/Electron/i.test(t.USER_AGENT),t.ELECTRON_VERSION=t.IS_ELECTRON&&function(){const e=t.USER_AGENT.match(/Electron\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IS_MIBROWSER=/MiuiBrowser/i.test(t.USER_AGENT),t.MI_VERSION=t.IS_MIBROWSER&&function(){const e=t.USER_AGENT.match(/MiuiBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IS_HUAWEIBROWSER=/HuaweiBrowser/i.test(t.USER_AGENT),t.HUAWEI_VERSION=t.IS_HUAWEIBROWSER&&function(){const e=t.USER_AGENT.match(/HuaweiBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IS_SAMSUNGBROWSER=/SamsungBrowser/i.test(t.USER_AGENT),t.SAMSUNG_VERSION=t.IS_SAMSUNGBROWSER&&function(){const e=t.USER_AGENT.match(/SamsungBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IS_OPPOBROWSER=/HeyTapBrowser/i.test(t.USER_AGENT),t.OPPO_VERSION=t.IS_OPPOBROWSER&&function(){const e=t.USER_AGENT.match(/HeyTapBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IS_VIVOBROWSER=/VivoBrowser/i.test(t.USER_AGENT),t.VIVO_VERSION=t.IS_VIVOBROWSER&&function(){const e=t.USER_AGENT.match(/VivoBrowser\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IS_CHROME_ONLY=/Chrome/i.test(t.USER_AGENT),t.IS_CHROME=!t.IS_EDGE&&!t.IS_SOGOU&&!t.IS_SOGOUM&&!t.IS_TBS&&!t.IS_XWEB&&!t.IS_EDG&&!t.IS_WQQB&&!t.IS_MIBROWSER&&!t.IS_HUAWEIBROWSER&&!t.IS_SAMSUNGBROWSER&&!t.IS_OPPOBROWSER&&!t.IS_VIVOBROWSER&&/Chrome/i.test(t.USER_AGENT),t.CHROME_MAJOR_VERSION=t.IS_CHROME&&function(){const e=t.USER_AGENT.match(/Chrome\/(\d+)/);return e&&e[1]?parseFloat(e[1]):null}(),t.CHROME_VERSION=t.IS_CHROME&&function(){const e=t.USER_AGENT.match(/Chrome\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IS_SAFARI=!t.IS_CHROME_ONLY&&!t.IS_MQQB&&!t.IS_X5MQQB&&!t.IS_MACQQB&&!t.IS_IPADQQB&&/Safari/i.test(t.USER_AGENT),t.IS_ANY_SAFARI=t.IS_SAFARI||t.IS_IOS,t.SAFARI_MAJOR_VERSION=t.IS_SAFARI&&function(){const e=t.USER_AGENT.match(/Version\/(\d+)/);return e&&e[1]?parseFloat(e[1]):null}(),t.SAFARI_VERSION=t.IS_SAFARI&&function(){const e=t.USER_AGENT.match(/Version\/([\d.]+)/);return e&&e[1]?e[1]:null}(),t.IS_MAC_SAFARI=t.IS_SAFARI&&t.IS_MAC,t.IS_IOS_SAFARI=t.IS_SAFARI&&t.IS_IOS,t.IS_LOCAL="file:"===window.location.protocol||"localhost"===window.location.hostname||/^\d+\.\d+\.\d+\.\d+$/.test(window.location.hostname),t.IS_ZH=/zh/i.test(t.USER_LANGUAGE),t.IS_EN=/en/i.test(t.USER_LANGUAGE)},function(e,t){var i=e.exports={version:"2.6.12"};"number"==typeof __e&&(__e=i)},function(e,t,i){var r=i(8);e.exports=function(e){if(!r(e))throw TypeError(e+" is not an object!");return e}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.getParameters=void 0;const r=i(117);let s={tracks:{audio:[],video:[]},shimVideoOrientation:"never",shimCanvas:"ios151",clients:[],localStreams:[],debugG2:!1,enableAlerter:"never",videoLowMaxWidth:320,videoLowMaxHeight:180,videoLowFramerate:15,videoLowCheckCanvasBlank:"ios",screenLowMaxWidth:320,screenLowMaxHeight:180,screenLowFramerate:15,controlOnPaused:!0,hideControlOnResume:!0,maxTransportRebuildCnt:Number.MAX_SAFE_INTEGER,logLevel:r.loglevels.INFO,forceListenDeviceChange:!0,codecOptions:{audio:{opusStereo:!0,opusDtx:!0},video:{high:{videoGoogleStartBitrate:1e3},low:{videoGoogleStartBitrate:500}},screen:{high:{videoGoogleStartBitrate:2e3},low:{videoGoogleStartBitrate:500}}},screenFocus:!0,allowEmptyMedia:!0,keepLocalstreamOnLeave:!1,joinFirstTimeout:2e3,joinMaxRetry:3,reconnectionFirstTimeout:2e3,reconnectionMaxRetry:3,leaveOnUnload:!0,trustOnOnline:!1,h264Wait:1e3,encoderWatermarkLimit:1,encoderWatermarkFontFamily:"Verdana",forceEncodedInsertableStreams:!1,forceCustomEncryptionOff:!1,h264StrictHigh:!1,enableTcpCandidate:!0,enableUdpCandidate:!0,maxEventLoopLagWarning:3,audioInputcompatMode:"auto",fireBackupDelay:5e3,audioAslFlag:!0,keepAspectRatio:!1,disableLBSService:!1,protooMessageTimeout:3e4,reuseMid:!0,playMediaTimeout:3e3,disableWebAudio:!1,disable2dContext:!1,disableWebGLContext:!1,shimLocalCanvas:"safari"};try{if(location.search&&"function"==typeof URLSearchParams){const e=new URLSearchParams(location.search);let t;for(t in s){const i=s[t],r=e.get(t);if(r){let e=null;"string"==typeof i?e=r:"boolean"==typeof i?"true"!==r&&"false"!==r||(e="true"===r):"number"==typeof i&&(e=Number(r),Number(r)>Number.MIN_SAFE_INTEGER&&(e=Number(r))),null!==e&&i!==e&&(console.warn(`NERTC 通过URL改变了私有化变量：${t}:`,i,"=>",e),s[t]=e)}}}}catch(e){}t.getParameters=()=>s},function(e,t,i){var r=i(7),s=i(22);e.exports=i(9)?function(e,t,i){return r.f(e,t,s(1,i))}:function(e,t,i){return e[t]=i,e}},function(e,t,i){var r=i(4),s=i(41),a=i(29),o=Object.defineProperty;t.f=i(9)?Object.defineProperty:function(e,t,i){if(r(e),t=a(t,!0),r(i),s)try{return o(e,t,i)}catch(e){}if("get"in i||"set"in i)throw TypeError("Accessors not supported!");return"value"in i&&(e[t]=i.value),e}},function(e,t){e.exports=function(e){return"object"==typeof e?null!==e:"function"==typeof e}},function(e,t,i){e.exports=!i(21)((function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a}))},function(e,t){var i={}.hasOwnProperty;e.exports=function(e,t){return i.call(e,t)}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0});t.default={AUTO_PLAY_NOT_ALLOWED:41030,UNKNOWN:99999,INVALID_PARAMETER_ERROR:1e4,NOT_SUPPORT_ERROR:10001,NETWORK_ERROR:10002,NETWORK_REQUEST_ERROR:10003,SERVER_ERROR:10004,MEDIA_SERVER_ERROR:10005,SIGNALLING_ERROR:10006,SIGNALLING_SERVER_ERROR:10007,API_CALL_SEQUENCE_ERROR:10008,INVALID_OPERATION_ERROR:10009,LOCALSTREAM_ERROR:10010,LOCALSTREAM_NOT_FOUND_ERROR:10011,UNKNOWN_TYPE_ERROR:10012,UNDEFINED_ERROR:10013,UNAVAILABLE_ERROR:10014,BANNED_BY_SERVER:10015,SOCKET_INIT_ERROR:10016,JOIN_FAILED:10100,REPEAT_JOIN_ERROR:10101,MEETING_ERROR:10102,ROOM_SERVER_ERROR:10103,USER_NOT_IN_CHANNEL_ERROR:10104,EVENT_UPLOAD_ERROR:10105,NOT_FOUND_ERROR:10106,SDP_ERROR:10107,ADD_TASK_FAILED_ERROR:10201,DELETE_TASK_FAILED_ERROR:10202,UPDATE_TASKS_FAILED_ERROR:10203,TASK_ERROR:10204,PLAY_NOT_START_ERROR:10205,APPDATA_OVERRIDE_ERROR:10206,WEBGL_NOT_SUPPORT_ERROR:10401,WEBGL_LOSE_CONTEXT_ERROR:10402,WEBGL_RESTORED_FAILD_ERROR:10403,BASIC_BEAUTY_RES_ERROR:10404,ADV_BEAUTY_RES_ERROR:10405,PLUGIN_LOADED_ERROR:10406,PLUGIN_ERROR:10407,FORMAT_AUDIO_ERROR:10420,AUDIO_MIX_FILE_ERROR:10421,AUDIO_MIX_STATE_ERROR:10422,AUDIO_EFFECT_STATE_ERROR:10423,AUDIO_EFFECT_FILE_LOST_ERROR:10424,AUDIO_MIX_DECODE_FAILED_ERROR:10425,AUDIO_MIXING_ERROR:10426,AUDIO_EFFECT_ERROR:10427,SET_ENCRYPTION_MODE_ERROR:10440,PROXY_ERROR:10441,RECORDING_ERROR:10450,RECORDING_NOT_START_ERROR:10451,WATERMARKS_EXCEEDED_ERROR:10460,LBS_REQUEST_ERROR:10461,LBS_JSON_ERROR:10462,NO_STATS_ERROR:10470,NO_PUBLISH_PERMISSSION:10500,NO_SUBSCRIBE_PERMISSSION:10501}},function(e,t,i){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=r(i(11));class a extends Error{constructor(e){let t=e.url?e.url:"https://doc.yunxin.163.com/docs/interface/NERTC_SDK/Latest/Web/api/index.html#errorCode",i=e.advice?` advice: ${e.advice} `:"";super(e.message+` <${function(e){for(let t in s.default)if(s.default[t]===e)return t;return"UNKNOWN"}(e.code)} ${e.code.toString()}> `+i+t),this.code_=e.code,this.message_=e.message,this.advice_=e.advice,this.extraCode_=e.extraCode}get code(){return this.code_}get message(){return this.message_}get advice(){return this.advice_}getCode(){return this.code_}getMessage(){return this.message_}getProposal(){return this.advice_}getExtraCode(){return this.extraCode_}}t.default=a},function(e,t,i){var r=Object.prototype.hasOwnProperty,s="~";function a(){}function o(e,t,i){this.fn=e,this.context=t,this.once=i||!1}function n(){this._events=new a,this._eventsCount=0}Object.create&&(a.prototype=Object.create(null),(new a).__proto__||(s=!1)),n.prototype.eventNames=function(){var e,t,i=[];if(0===this._eventsCount)return i;for(t in e=this._events)r.call(e,t)&&i.push(s?t.slice(1):t);return Object.getOwnPropertySymbols?i.concat(Object.getOwnPropertySymbols(e)):i},n.prototype.listeners=function(e,t){var i=s?s+e:e,r=this._events[i];if(t)return!!r;if(!r)return[];if(r.fn)return[r.fn];for(var a=0,o=r.length,n=new Array(o);a<o;a++)n[a]=r[a].fn;return n},n.prototype.emit=function(e,t,i,r,a,o){var n=s?s+e:e;if(!this._events[n])return!1;var d,c,l=this._events[n],u=arguments.length;if(l.fn){switch(l.once&&this.removeListener(e,l.fn,void 0,!0),u){case 1:return l.fn.call(l.context),!0;case 2:return l.fn.call(l.context,t),!0;case 3:return l.fn.call(l.context,t,i),!0;case 4:return l.fn.call(l.context,t,i,r),!0;case 5:return l.fn.call(l.context,t,i,r,a),!0;case 6:return l.fn.call(l.context,t,i,r,a,o),!0}for(c=1,d=new Array(u-1);c<u;c++)d[c-1]=arguments[c];l.fn.apply(l.context,d)}else{var h,p=l.length;for(c=0;c<p;c++)switch(l[c].once&&this.removeListener(e,l[c].fn,void 0,!0),u){case 1:l[c].fn.call(l[c].context);break;case 2:l[c].fn.call(l[c].context,t);break;case 3:l[c].fn.call(l[c].context,t,i);break;case 4:l[c].fn.call(l[c].context,t,i,r);break;default:if(!d)for(h=1,d=new Array(u-1);h<u;h++)d[h-1]=arguments[h];l[c].fn.apply(l[c].context,d)}}return!0},n.prototype.on=function(e,t,i){var r=new o(t,i||this),a=s?s+e:e;return this._events[a]?this._events[a].fn?this._events[a]=[this._events[a],r]:this._events[a].push(r):(this._events[a]=r,this._eventsCount++),this},n.prototype.once=function(e,t,i){var r=new o(t,i||this,!0),a=s?s+e:e;return this._events[a]?this._events[a].fn?this._events[a]=[this._events[a],r]:this._events[a].push(r):(this._events[a]=r,this._eventsCount++),this},n.prototype.removeListener=function(e,t,i,r){var o=s?s+e:e;if(!this._events[o])return this;if(!t)return 0==--this._eventsCount?this._events=new a:delete this._events[o],this;var n=this._events[o];if(n.fn)n.fn!==t||r&&!n.once||i&&n.context!==i||(0==--this._eventsCount?this._events=new a:delete this._events[o]);else{for(var d=0,c=[],l=n.length;d<l;d++)(n[d].fn!==t||r&&!n[d].once||i&&n[d].context!==i)&&c.push(n[d]);c.length?this._events[o]=1===c.length?c[0]:c:0==--this._eventsCount?this._events=new a:delete this._events[o]}return this},n.prototype.removeAllListeners=function(e){var t;return e?(t=s?s+e:e,this._events[t]&&(0==--this._eventsCount?this._events=new a:delete this._events[t])):(this._events=new a,this._eventsCount=0),this},n.prototype.off=n.prototype.removeListener,n.prototype.addListener=n.prototype.on,n.prototype.setMaxListeners=function(){return this},n.prefixed=s,n.EventEmitter=n,e.exports=n},function(e,t,i){var r=i(80),s=i(27);e.exports=function(e){return r(s(e))}},function(e,t){e.exports=!0},function(e,t,i){var r=i(0),s=i(3),a=i(19),o=i(6),n=i(10),d=function(e,t,i){var c,l,u,h=e&d.F,p=e&d.G,m=e&d.S,f=e&d.P,g=e&d.B,v=e&d.W,_=p?s:s[t]||(s[t]={}),S=_.prototype,y=p?r:m?r[t]:(r[t]||{}).prototype;for(c in p&&(i=t),i)(l=!h&&y&&void 0!==y[c])&&n(_,c)||(u=l?y[c]:i[c],_[c]=p&&"function"!=typeof y[c]?i[c]:g&&l?a(u,r):v&&y[c]==u?function(e){var t=function(t,i,r){if(this instanceof e){switch(arguments.length){case 0:return new e;case 1:return new e(t);case 2:return new e(t,i)}return new e(t,i,r)}return e.apply(this,arguments)};return t.prototype=e.prototype,t}(u):f&&"function"==typeof u?a(Function.call,u):u,f&&((_.virtual||(_.virtual={}))[c]=u,e&d.R&&S&&!S[c]&&o(S,c,u)))};d.F=1,d.G=2,d.S=4,d.P=8,d.B=16,d.W=32,d.U=64,d.R=128,e.exports=d},function(e,t){e.exports={}},function(e,t){var i={}.toString;e.exports=function(e){return i.call(e).slice(8,-1)}},function(e,t,i){var r=i(20);e.exports=function(e,t,i){if(r(e),void 0===t)return e;switch(i){case 1:return function(i){return e.call(t,i)};case 2:return function(i,r){return e.call(t,i,r)};case 3:return function(i,r,s){return e.call(t,i,r,s)}}return function(){return e.apply(t,arguments)}}},function(e,t){e.exports=function(e){if("function"!=typeof e)throw TypeError(e+" is not a function!");return e}},function(e,t){e.exports=function(e){try{return!!e()}catch(e){return!0}}},function(e,t){e.exports=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}}},function(e,t){var i=0,r=Math.random();e.exports=function(e){return"Symbol(".concat(void 0===e?"":e,")_",(++i+r).toString(36))}},function(e,t,i){var r=i(7).f,s=i(10),a=i(1)("toStringTag");e.exports=function(e,t,i){e&&!s(e=i?e:e.prototype,a)&&r(e,a,{configurable:!0,value:t})}},function(e,t,i){var r,s,a=e.exports=i(57),o=i(179);a.codegen=i(259),a.fetch=i(260),a.path=i(261),a.fs=a.inquire("fs"),a.toArray=function(e){if(e){for(var t=Object.keys(e),i=new Array(t.length),r=0;r<t.length;)i[r]=e[t[r++]];return i}return[]},a.toObject=function(e){for(var t={},i=0;i<e.length;){var r=e[i++],s=e[i++];void 0!==s&&(t[r]=s)}return t};var n=/\\/g,d=/"/g;a.isReserved=function(e){return/^(?:do|if|in|for|let|new|try|var|case|else|enum|eval|false|null|this|true|void|with|break|catch|class|const|super|throw|while|yield|delete|export|import|public|return|static|switch|typeof|default|extends|finally|package|private|continue|debugger|function|arguments|interface|protected|implements|instanceof)$/.test(e)},a.safeProp=function(e){return!/^[$\w_]+$/.test(e)||a.isReserved(e)?'["'+e.replace(n,"\\\\").replace(d,'\\"')+'"]':"."+e},a.ucFirst=function(e){return e.charAt(0).toUpperCase()+e.substring(1)};var c=/_([a-z])/g;a.camelCase=function(e){return e.substring(0,1)+e.substring(1).replace(c,(function(e,t){return t.toUpperCase()}))},a.compareFieldsById=function(e,t){return e.id-t.id},a.decorateType=function(e,t){if(e.$type)return t&&e.$type.name!==t&&(a.decorateRoot.remove(e.$type),e.$type.name=t,a.decorateRoot.add(e.$type)),e.$type;r||(r=i(181));var s=new r(t||e.name);return a.decorateRoot.add(s),s.ctor=e,Object.defineProperty(e,"$type",{value:s,enumerable:!1}),Object.defineProperty(e.prototype,"$type",{value:s,enumerable:!1}),s};var l=0;a.decorateEnum=function(e){if(e.$type)return e.$type;s||(s=i(58));var t=new s("Enum"+l++,e);return a.decorateRoot.add(t),Object.defineProperty(e,"$type",{value:t,enumerable:!1}),t},a.setProperty=function(e,t,i){if("object"!=typeof e)throw TypeError("dst must be an object");if(!t)throw TypeError("path must be specified");return function e(t,i,r){var s=i.shift();if(i.length>0)t[s]=e(t[s]||{},i,r);else{var a=t[s];a&&(r=[].concat(a).concat(r)),t[s]=r}return t}(e,t=t.split("."),i)},Object.defineProperty(a,"decorateRoot",{get:function(){return o.decorated||(o.decorated=new(i(189)))}})},function(e,t){var i=Math.ceil,r=Math.floor;e.exports=function(e){return isNaN(e=+e)?0:(e>0?r:i)(e)}},function(e,t){e.exports=function(e){if(null==e)throw TypeError("Can't call method on  "+e);return e}},function(e,t,i){var r=i(8),s=i(0).document,a=r(s)&&r(s.createElement);e.exports=function(e){return a?s.createElement(e):{}}},function(e,t,i){var r=i(8);e.exports=function(e,t){if(!r(e))return e;var i,s;if(t&&"function"==typeof(i=e.toString)&&!r(s=i.call(e)))return s;if("function"==typeof(i=e.valueOf)&&!r(s=i.call(e)))return s;if(!t&&"function"==typeof(i=e.toString)&&!r(s=i.call(e)))return s;throw TypeError("Can't convert object to primitive value")}},function(e,t,i){var r=i(44),s=i(33);e.exports=Object.keys||function(e){return r(e,s)}},function(e,t,i){var r=i(32)("keys"),s=i(23);e.exports=function(e){return r[e]||(r[e]=s(e))}},function(e,t,i){var r=i(3),s=i(0),a=s["__core-js_shared__"]||(s["__core-js_shared__"]={});(e.exports=function(e,t){return a[e]||(a[e]=void 0!==t?t:{})})("versions",[]).push({version:r.version,mode:i(15)?"pure":"global",copyright:"© 2020 Denis Pushkarev (zloirock.ru)"})},function(e,t){e.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(e,t,i){var r=i(20);function s(e){var t,i;this.promise=new e((function(e,r){if(void 0!==t||void 0!==i)throw TypeError("Bad Promise constructor");t=e,i=r})),this.resolve=r(t),this.reject=r(i)}e.exports.f=function(e){return new s(e)}},function(e,t,i){t.f=i(1)},function(e,t,i){var r=i(0),s=i(3),a=i(15),o=i(35),n=i(7).f;e.exports=function(e){var t=s.Symbol||(s.Symbol=a?{}:r.Symbol||{});"_"==e.charAt(0)||e in t||n(t,e,{value:o.f(e)})}},function(e,t){t.f={}.propertyIsEnumerable},function(e,t){},function(e,t,i){var r=i(77)(!0);i(40)(String,"String",(function(e){this._t=String(e),this._i=0}),(function(){var e,t=this._t,i=this._i;return i>=t.length?{value:void 0,done:!0}:(e=r(t,i),this._i+=e.length,{value:e,done:!1})}))},function(e,t,i){var r=i(15),s=i(16),a=i(42),o=i(6),n=i(17),d=i(78),c=i(24),l=i(83),u=i(1)("iterator"),h=!([].keys&&"next"in[].keys()),p=function(){return this};e.exports=function(e,t,i,m,f,g,v){d(i,t,m);var _,S,y,R=function(e){if(!h&&e in I)return I[e];switch(e){case"keys":case"values":return function(){return new i(this,e)}}return function(){return new i(this,e)}},b=t+" Iterator",T="values"==f,w=!1,I=e.prototype,E=I[u]||I["@@iterator"]||f&&I[f],A=E||R(f),C=f?T?R("entries"):A:void 0,P="Array"==t&&I.entries||E;if(P&&(y=l(P.call(new e)))!==Object.prototype&&y.next&&(c(y,b,!0),r||"function"==typeof y[u]||o(y,u,p)),T&&E&&"values"!==E.name&&(w=!0,A=function(){return E.call(this)}),r&&!v||!h&&!w&&I[u]||o(I,u,A),n[t]=A,n[b]=p,f)if(_={values:T?A:R("values"),keys:g?A:R("keys"),entries:C},v)for(S in _)S in I||a(I,S,_[S]);else s(s.P+s.F*(h||w),t,_);return _}},function(e,t,i){e.exports=!i(9)&&!i(21)((function(){return 7!=Object.defineProperty(i(28)("div"),"a",{get:function(){return 7}}).a}))},function(e,t,i){e.exports=i(6)},function(e,t,i){var r=i(4),s=i(79),a=i(33),o=i(31)("IE_PROTO"),n=function(){},d=function(){var e,t=i(28)("iframe"),r=a.length;for(t.style.display="none",i(46).appendChild(t),t.src="javascript:",(e=t.contentWindow.document).open(),e.write("<script>document.F=Object<\/script>"),e.close(),d=e.F;r--;)delete d.prototype[a[r]];return d()};e.exports=Object.create||function(e,t){var i;return null!==e?(n.prototype=r(e),i=new n,n.prototype=null,i[o]=e):i=d(),void 0===t?i:s(i,t)}},function(e,t,i){var r=i(10),s=i(14),a=i(81)(!1),o=i(31)("IE_PROTO");e.exports=function(e,t){var i,n=s(e),d=0,c=[];for(i in n)i!=o&&r(n,i)&&c.push(i);for(;t.length>d;)r(n,i=t[d++])&&(~a(c,i)||c.push(i));return c}},function(e,t,i){var r=i(26),s=Math.min;e.exports=function(e){return e>0?s(r(e),9007199254740991):0}},function(e,t,i){var r=i(0).document;e.exports=r&&r.documentElement},function(e,t,i){var r=i(27);e.exports=function(e){return Object(r(e))}},function(e,t,i){i(84);for(var r=i(0),s=i(6),a=i(17),o=i(1)("toStringTag"),n="CSSRuleList,CSSStyleDeclaration,CSSValueList,ClientRectList,DOMRectList,DOMStringList,DOMTokenList,DataTransferItemList,FileList,HTMLAllCollection,HTMLCollection,HTMLFormElement,HTMLSelectElement,MediaList,MimeTypeArray,NamedNodeMap,NodeList,PaintRequestList,Plugin,PluginArray,SVGLengthList,SVGNumberList,SVGPathSegList,SVGPointList,SVGStringList,SVGTransformList,SourceBufferList,StyleSheetList,TextTrackCueList,TextTrackList,TouchList".split(","),d=0;d<n.length;d++){var c=n[d],l=r[c],u=l&&l.prototype;u&&!u[o]&&s(u,o,c),a[c]=a.Array}},function(e,t,i){var r=i(18),s=i(1)("toStringTag"),a="Arguments"==r(function(){return arguments}());e.exports=function(e){var t,i,o;return void 0===e?"Undefined":null===e?"Null":"string"==typeof(i=function(e,t){try{return e[t]}catch(e){}}(t=Object(e),s))?i:a?r(t):"Object"==(o=r(t))&&"function"==typeof t.callee?"Arguments":o}},function(e,t,i){var r=i(4),s=i(20),a=i(1)("species");e.exports=function(e,t){var i,o=r(e).constructor;return void 0===o||null==(i=r(o)[a])?t:s(i)}},function(e,t,i){var r,s,a,o=i(19),n=i(93),d=i(46),c=i(28),l=i(0),u=l.process,h=l.setImmediate,p=l.clearImmediate,m=l.MessageChannel,f=l.Dispatch,g=0,v={},_=function(){var e=+this;if(v.hasOwnProperty(e)){var t=v[e];delete v[e],t()}},S=function(e){_.call(e.data)};h&&p||(h=function(e){for(var t=[],i=1;arguments.length>i;)t.push(arguments[i++]);return v[++g]=function(){n("function"==typeof e?e:Function(e),t)},r(g),g},p=function(e){delete v[e]},"process"==i(18)(u)?r=function(e){u.nextTick(o(_,e,1))}:f&&f.now?r=function(e){f.now(o(_,e,1))}:m?(a=(s=new m).port2,s.port1.onmessage=S,r=o(a.postMessage,a,1)):l.addEventListener&&"function"==typeof postMessage&&!l.importScripts?(r=function(e){l.postMessage(e+"","*")},l.addEventListener("message",S,!1)):r="onreadystatechange"in c("script")?function(e){d.appendChild(c("script")).onreadystatechange=function(){d.removeChild(this),_.call(e)}}:function(e){setTimeout(o(_,e,1),0)}),e.exports={set:h,clear:p}},function(e,t){e.exports=function(e){try{return{e:!1,v:e()}}catch(e){return{e:!0,v:e}}}},function(e,t,i){var r=i(4),s=i(8),a=i(34);e.exports=function(e,t){if(r(e),s(t)&&t.constructor===e)return t;var i=a.f(e);return(0,i.resolve)(t),i.promise}},function(e,t){t.f=Object.getOwnPropertySymbols},function(e,t,i){var r=i(44),s=i(33).concat("length","prototype");t.f=Object.getOwnPropertyNames||function(e){return r(e,s)}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.Logger=void 0;const r=i(117),s=i(61),a=i(116),o=i(5),n="mediasoup-client";let d=window;t.Logger={debug(e,...t){const i=e?`${n}:${e}`:""+n;t=Array.prototype.slice.call(arguments);this.formatArgs("DEBUG",t,i),o.getParameters().logLevel<=r.loglevels.DEBUG&&console.debug.apply(console,t),d.logUpload&&d.wsTransport&&d.wsTransport.sendLog(t)},warn(e,...t){const i=e?`${n}:${e}`:""+n;t=Array.prototype.slice.call(arguments);this.formatArgs("WARN",t,i),o.getParameters().logLevel<=r.loglevels.WARNING&&console.warn.apply(console,t),d.logUpload&&d.wsTransport&&d.wsTransport.sendLog(t)},error(e,...t){const i=e?`${n}:${e}`:""+n;t=Array.prototype.slice.call(arguments);this.formatArgs("ERROR",t,i),o.getParameters().logLevel<=r.loglevels.ERROR&&console.error.apply(console,t),d.logUpload&&d.wsTransport&&d.wsTransport.sendLog(t)},formatArgs(e,t,i){let r=new Date,o=this.formatTimeUnit(""+(r.getMonth()+1))+"-"+this.formatTimeUnit(""+r.getDate())+" "+this.formatTimeUnit(""+r.getHours())+":"+this.formatTimeUnit(""+r.getMinutes())+":"+this.formatTimeUnit(""+r.getSeconds())+":"+this.formatTimeUnit(""+r.getMilliseconds(),3),n=`[NERTC:${e}:${a.updateLogIndex()} ${o} ${i.toUpperCase()}]  `;for(let e=t.length-1;e>=0;e--)t[e]=s.formatSingleArg(t[e]);return t.unshift(n),t},formatTimeUnit(e,t){t=t||2;for(var i=""+e;i.length<t;)i="0"+i;return i}}},function(e,t,i){(function(e){var r=t;function s(e,t,i){for(var r=Object.keys(t),s=0;s<r.length;++s)void 0!==e[r[s]]&&i||(e[r[s]]=t[r[s]]);return e}function a(e){function t(e,i){if(!(this instanceof t))return new t(e,i);Object.defineProperty(this,"message",{get:function(){return e}}),Error.captureStackTrace?Error.captureStackTrace(this,t):Object.defineProperty(this,"stack",{value:(new Error).stack||""}),i&&s(this,i)}return(t.prototype=Object.create(Error.prototype)).constructor=t,Object.defineProperty(t.prototype,"name",{get:function(){return e}}),t.prototype.toString=function(){return this.name+": "+this.message},t}r.asPromise=i(176),r.base64=i(250),r.EventEmitter=i(251),r.float=i(252),r.inquire=i(177),r.utf8=i(253),r.pool=i(254),r.LongBits=i(255),r.isNode=Boolean(void 0!==e&&e&&e.process&&e.process.versions&&e.process.versions.node),r.global=r.isNode&&e||"undefined"!=typeof window&&window||"undefined"!=typeof self&&self||this,r.emptyArray=Object.freeze?Object.freeze([]):[],r.emptyObject=Object.freeze?Object.freeze({}):{},r.isInteger=Number.isInteger||function(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e},r.isString=function(e){return"string"==typeof e||e instanceof String},r.isObject=function(e){return e&&"object"==typeof e},r.isset=r.isSet=function(e,t){var i=e[t];return!(null==i||!e.hasOwnProperty(t))&&("object"!=typeof i||(Array.isArray(i)?i.length:Object.keys(i).length)>0)},r.Buffer=function(){try{var e=r.inquire("buffer").Buffer;return e.prototype.utf8Write?e:null}catch(e){return null}}(),r._Buffer_from=null,r._Buffer_allocUnsafe=null,r.newBuffer=function(e){return"number"==typeof e?r.Buffer?r._Buffer_allocUnsafe(e):new r.Array(e):r.Buffer?r._Buffer_from(e):"undefined"==typeof Uint8Array?e:new Uint8Array(e)},r.Array="undefined"!=typeof Uint8Array?Uint8Array:Array,r.Long=r.global.dcodeIO&&r.global.dcodeIO.Long||r.global.Long||r.inquire("long"),r.key2Re=/^true|false|0|1$/,r.key32Re=/^-?(?:0|[1-9][0-9]*)$/,r.key64Re=/^(?:[\\x00-\\xff]{8}|-?(?:0|[1-9][0-9]*))$/,r.longToHash=function(e){return e?r.LongBits.from(e).toHash():r.LongBits.zeroHash},r.longFromHash=function(e,t){var i=r.LongBits.fromHash(e);return r.Long?r.Long.fromBits(i.lo,i.hi,t):i.toNumber(Boolean(t))},r.merge=s,r.lcFirst=function(e){return e.charAt(0).toLowerCase()+e.substring(1)},r.newError=a,r.ProtocolError=a("ProtocolError"),r.oneOfGetter=function(e){for(var t={},i=0;i<e.length;++i)t[e[i]]=1;return function(){for(var e=Object.keys(this),i=e.length-1;i>-1;--i)if(1===t[e[i]]&&void 0!==this[e[i]]&&null!==this[e[i]])return e[i]}},r.oneOfSetter=function(e){return function(t){for(var i=0;i<e.length;++i)e[i]!==t&&delete this[e[i]]}},r.toJSONOptions={longs:String,enums:String,bytes:String,json:!0},r._configure=function(){var e=r.Buffer;e?(r._Buffer_from=e.from!==Uint8Array.from&&e.from||function(t,i){return new e(t,i)},r._Buffer_allocUnsafe=e.allocUnsafe||function(t){return new e(t)}):r._Buffer_from=r._Buffer_allocUnsafe=null}}).call(this,i(64))},function(e,t,i){e.exports=o;var r=i(119);((o.prototype=Object.create(r.prototype)).constructor=o).className="Enum";var s=i(126),a=i(25);function o(e,t,i,s,a){if(r.call(this,e,i),t&&"object"!=typeof t)throw TypeError("values must be an object");if(this.valuesById={},this.values=Object.create(this.valuesById),this.comment=s,this.comments=a||{},this.reserved=void 0,t)for(var o=Object.keys(t),n=0;n<o.length;++n)"number"==typeof t[o[n]]&&(this.valuesById[this.values[o[n]]=t[o[n]]]=o[n])}o.fromJSON=function(e,t){var i=new o(e,t.values,t.options,t.comment,t.comments);return i.reserved=t.reserved,i},o.prototype.toJSON=function(e){var t=!!e&&Boolean(e.keepComments);return a.toObject(["options",this.options,"values",this.values,"reserved",this.reserved&&this.reserved.length?this.reserved:void 0,"comment",t?this.comment:void 0,"comments",t?this.comments:void 0])},o.prototype.add=function(e,t,i){if(!a.isString(e))throw TypeError("name must be a string");if(!a.isInteger(t))throw TypeError("id must be an integer");if(void 0!==this.values[e])throw Error("duplicate name '"+e+"' in "+this);if(this.isReservedId(t))throw Error("id "+t+" is reserved in "+this);if(this.isReservedName(e))throw Error("name '"+e+"' is reserved in "+this);if(void 0!==this.valuesById[t]){if(!this.options||!this.options.allow_alias)throw Error("duplicate id "+t+" in "+this);this.values[e]=t}else this.valuesById[this.values[e]=t]=e;return this.comments[e]=i||null,this},o.prototype.remove=function(e){if(!a.isString(e))throw TypeError("name must be a string");var t=this.values[e];if(null==t)throw Error("name '"+e+"' does not exist in "+this);return delete this.valuesById[t],delete this.values[e],delete this.comments[e],this},o.prototype.isReservedId=function(e){return s.isReservedId(this.reserved,e)},o.prototype.isReservedName=function(e){return s.isReservedName(this.reserved,e)}},function(e,t,i){e.exports=i(73)},function(e,t,i){t.__esModule=!0;var r,s=i(75),a=(r=s)&&r.__esModule?r:{default:r};t.default=function(e){return function(){var t=e.apply(this,arguments);return new a.default((function(e,i){return function r(s,o){try{var n=t[s](o),d=n.value}catch(e){return void i(e)}if(!n.done)return a.default.resolve(d).then((function(e){r("next",e)}),(function(e){r("throw",e)}));e(d)}("next")}))}}},function(e,t,i){function r(e,t=1,i=1){return e<=1?i:r(e-1,i,t+i)}Object.defineProperty(t,"__esModule",{value:!0}),t.getDomInfo=t.makePrintable=t.formatSingleArg=t.deepCopy=t.randomId=t.generateUUID=t.getReconnectionTimeout=t.fibonacci=void 0,t.fibonacci=r,t.getReconnectionTimeout=function(e){const t=Math.round(e/2)+1;return t>6?13e3:1e3*r(t)};t.generateUUID=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))};function s(e){if(window.RTCRtpSender&&e instanceof RTCRtpSender){return`[RTCRtpSender track: ${s(e.track)}]`}if(e instanceof MediaStreamTrack){const t=e;return`[MediaStreamTrack kind:${t.kind} label:${t.label} readyState:${t.readyState} id: ${t.id} enabled:${t.enabled} muted: ${t.muted}]`}if(e instanceof HTMLElement){const t=e;return`[${t.tagName}.${t.className} ${t.clientWidth}x${t.clientHeight}]`}if(e instanceof MediaStream){const t=e;return`[MediaStream active:${t.active} a:${t.getAudioTracks().length} v:${t.getVideoTracks().length}]`}return e}t.randomId=function(){return"xxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))},t.deepCopy=function e(t){var i=Array.isArray(t)?[]:{};for(var r in t)t.hasOwnProperty(r)&&("object"==typeof t[r]&&null!==t[r]?i[r]=e(t[r]):i[r]=t[r]);return i},t.formatSingleArg=s,t.makePrintable=function e(t,i,r=[]){if("object"!=typeof t||!(null==t?void 0:t.hasOwnProperty))return t;var a=Array.isArray(t)?[]:{};for(var o in t)if(t.hasOwnProperty(o)){const n=s(t[o]);n&&("client"===o&&n.adapterRef||["adapterRef","sdkRef","logger","_events"].indexOf(o)>-1||(n&&"object"==typeof n?r.indexOf(n)>-1?a[o]="[Circular obj]":(r.push(a[o]),i>=1?a[o]=e(n,i-1,r):(null==n?void 0:n.toString)?a[o]=n.toString():a[o]=typeof n):a[o]=n))}return a},t.getDomInfo=function(e){if(!e)return""+e;let t=e.tagName;return e.id&&(t+="#"+e.id),e.className&&(t+="."+e.className),(e.offsetWidth||e.offsetHeight)&&(t+=` ${e.offsetWidth}x${e.offsetHeight}`),t}},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.WebAudio=t.getAudioLevelDestination=t.getAudioContext=t.tryResumeAudioContext=void 0;const n=i(13),d=i(162),c=o(i(11)),l=o(i(12)),u=i(145),h=a(i(2)),p=i(5),m=u.RtcSupport.checkWebAudio();let f;class g{constructor(e){this.id=e.id,this.label=e.label,this.audioNode=e.audioNode,this.gainNode=e.context.createGain(),this.type=e.type,this.audioNode.connect(this.gainNode)}connect(e){this.gainNode.connect(e)}disconnect(){try{this.audioNode.disconnect(this.gainNode)}catch(e){}this.gainNode.disconnect()}}function v(){return f?"suspended"===f.state&&(f.resume().catch(e=>{}),!0):null}function _(){return f?(v(),f):p.getParameters().disableWebAudio?null:m.WebAudio&&m.MediaStream?(f=new window.AudioContext,f):null}t.tryResumeAudioContext=v,t.getAudioContext=_;let S=null;t.getAudioLevelDestination=function(){if(!S){const e=_();e&&(S=e.createMediaStreamDestination())}return S};class y extends n.EventEmitter{constructor(e){super();const{logger:t,isAnalyze:i=!1,isRemote:r=!1}=e;this.support=m.WebAudio&&m.MediaStream,this.gain=1,this.logger=t,this.audioInArr=[],this.isAnalyze=i,this.isRemote=r||!1,this.instant=0,this.slow=0,this.clip=0,this.mediaHelper=e.mediaHelper,this.mixAudioConf={state:d.AuidoMixingState.UNSTART,audioSource:null,gainFilter:null,replace:!1,cycle:0,pauseTime:0,startTime:0,totalTime:0,volume:1,playStartTime:0,setPlayStartTime:0,auidoMixingEnd:null},this.context=_(),this.context?(this.destination=this.createDestination(),this.musicDestination=this.createDestination(),this.analyzeDestination=this.createDestination()):(this.destination=null,this.musicDestination=null,this.analyzeDestination=null),this.support&&(this.resetMixConf(),this.init())}createDestination(){if(!this.context)throw new Error("AudioContextRequired");try{return new MediaStreamAudioDestinationNode(this.context)}catch(e){if("TypeError"===e.name)return this.context.createMediaStreamDestination();throw e}}createSource(e){if(!this.context)throw new Error("AudioContextRequired");try{return new MediaStreamAudioSourceNode(this.context,e)}catch(t){if("TypeError"===t.name)return this.context.createMediaStreamSource(e.mediaStream);throw t}}init(){this.isAnalyze&&this.initMonitor(),this.initWebAudio(),this.initAudioIn()}initMonitor(){var e=this;this.context?(this.script=this.context.createScriptProcessor(0,1,1)).onaudioprocess=function(t){var i,r=t.inputBuffer.getChannelData(0),s=0,a=0;for(i=0;i<r.length;++i)s+=Math.abs(r[i]),Math.abs(r[i])>.99&&(a+=1);e.instant=Math.sqrt(s/r.length),e.slow=.95*e.slow+.05*e.instant,e.clip=a/r.length;let o=t.inputBuffer,n=t.outputBuffer;n.copyToChannel&&n.copyToChannel(o.getChannelData(0),0,0)}:e.logger.error("initMonitor:参数不够")}initWebAudio(){this.context&&this.destination?(this.gainFilter=this.context.createGain(),this.gainFilter.gain.value=this.gain):this.logger.error("initMonitor:参数不够")}initAudioIn(){var e,t,i;const r=this;if(!r.context||!r.gainFilter||!r.destination)return this.logger.error("initAudioIn:参数不够"),null;let s=(null===(t=null===(e=this.mediaHelper.audio.stageAIProcessing)||void 0===e?void 0:e.node)||void 0===t?void 0:t.audioNode)||null,a=null===(i=this.mediaHelper.audio.stageAIProcessing)||void 0===i?void 0:i.enabled;if(s)if(a)s.connect(r.gainFilter);else try{s.disconnect(r.gainFilter)}catch(e){}for(var o=0;o<r.audioInArr.length;o++){const e=r.audioInArr[o];if(s)if(a){try{e.gainNode.disconnect(r.gainFilter)}catch(e){}e.connect(s)}else{try{e.gainNode.disconnect(s)}catch(e){}e.connect(r.gainFilter)}else e.connect(r.gainFilter)}r.mixAudioConf.state===d.AuidoMixingState.UNSTART&&(r.script&&r.analyzeDestination&&(r.gainFilter.connect(r.script),r.script.connect(r.analyzeDestination)),r.gainFilter.connect(r.destination)),this.logger.log("WebAudio: initAudioIn: 初始化音频 state: ",r.context.state),"running"!==r.context.state&&r.context.resume().then(()=>{this.context&&this.logger.log("WebAudio: addMs: 状态变更成功 state: ",this.context.state)}).catch(e=>{this.logger.log("WebAudio: addMs: 状态变更出错: ",e.name,e.message,e),this.context&&this.context.resume()})}updateTracks(e){for(let t=this.audioInArr.length-1;t>=0;t--){const i=this.audioInArr[t];e.find(e=>e.track&&i&&e.track.id===i.id)||(this.logger.log("updateTracks，删除",i.label,i.id),this.audioInArr.splice(t,1),i.disconnect())}for(let t=e.length-1;t>=0;t--){const i=e[t];if(!this.audioInArr.find(e=>i.track&&i.track.id===e.id)&&i.track)if(this.context){const e=new MediaStream;e.addTrack(i.track);const t={context:this.context,id:i.track.id,label:i.track.label,audioNode:this.createSource({mediaStream:e}),type:i.type},r=new g(t);r.gainNode.gain.value=this.gain,this.audioInArr.push(r)}else this.logger.error("updateTracks：没有audioContext")}this.initAudioIn()}removeTrack(e){for(let t=this.audioInArr.length-1;t>=0;t--){const i=this.audioInArr[t];i.id===e.id&&(this.logger.log("removeTrack，删除track",e.id,e.label),this.audioInArr.splice(t,1),i.disconnect())}}setGain(e,t){for(let i=0;i<this.audioInArr.length;i++){const r=this.audioInArr[i];t&&t!==r.type||(this.logger.log("WebAudio.setGain",t,e,r.type,r.label,r.id),r.gainNode.gain.value=e)}t||(this.gain=e)}getGain(){if(this.gainFilter)return this.gain}getGainMin(){let e=1;for(let t=0;t<this.audioInArr.length;t++){const i=this.audioInArr[t];i.gainNode.gain.value<e&&(e=i.gainNode.gain.value)}return e}stop(){this.gainFilter&&(this.script?this.script.disconnect(0):this.gainFilter.disconnect(0),this.instant=0)}start(){this.gainFilter&&this.destination&&(this.script&&this.analyzeDestination&&(this.gainFilter.connect(this.script),this.script.connect(this.analyzeDestination)),this.gainFilter.connect(this.destination))}resetMixConf(){var e,t;if(null===(e=this.mixAudioConf.audioSource)||void 0===e||e.disconnect(0),null===(t=this.mixAudioConf.gainFilter)||void 0===t||t.disconnect(0),this.mixAudioConf.replace&&(this.logger.log("伴音停止了，恢复mic"),this.gainFilter&&this.destination)){for(var i=0;i<this.audioInArr.length;i++){this.audioInArr[i].gainNode.connect(this.gainFilter)}this.script&&this.analyzeDestination&&(this.gainFilter.connect(this.script),this.script.connect(this.analyzeDestination)),this.gainFilter.connect(this.destination)}this.mixAudioConf={state:d.AuidoMixingState.UNSTART,audioSource:null,gainFilter:null,replace:!1,cycle:0,pauseTime:0,startTime:0,totalTime:0,volume:1,playStartTime:0,setPlayStartTime:0,auidoMixingEnd:null},this.gainFilter&&1===this.gainFilter.gain.value&&this.emit("audioFilePlaybackCompleted")}startMix(e){if(!this.context||!this.destination||!this.gainFilter){this.logger.error("startMix:不支持伴音");let e="webAudio_startMix: webAudio is not supported in this browser",t="webAudio_startMix: 当前浏览器不支持 webAudio",i="The latest version of the Chrome browser is recommended",r="建议使用最新版的 Chrome 浏览器",s=h.IS_ZH?t:e,a=h.IS_ZH?r:i;return Promise.reject(new l.default({code:c.default.NOT_SUPPORT_ERROR,message:s,advice:a}))}if(this.logger.log("开始混音: ",JSON.stringify(e)),this.mixAudioConf.audioSource=this.context.createBufferSource(),this.mixAudioConf.gainFilter=this.context.createGain(),this.mixAudioConf.audioSource.buffer=e.buffer,this.mixAudioConf.replace=e.replace,this.mixAudioConf.cycle=e.cycle,this.mixAudioConf.playStartTime=e.playStartTime,this.mixAudioConf.volume=e.volume?e.volume/255:1,this.mixAudioConf.auidoMixingEnd=e.auidoMixingEnd,this.mixAudioConf.audioSource.connect(this.mixAudioConf.gainFilter),this.mixAudioConf.gainFilter.connect(this.gainFilter),this.musicDestination&&this.mixAudioConf.gainFilter.connect(this.musicDestination),e.replace)for(var t=0;t<this.audioInArr.length;t++){const e=this.audioInArr[t];try{e.gainNode.disconnect(this.gainFilter),this.logger.log(`已断开音频：【${e.label}】`)}catch(t){"InvalidAccessError"===t.name?this.logger.log(`音频断开前未连接：【${e.label}】`):this.logger.error(`无法断开音频:【${e.label}】${t.name}`,t.message)}}if(this.mixAudioConf.audioSource.onended=e=>{this.audioEnd(e)},this.mixAudioConf.totalTime=e.buffer.duration,(this.mixAudioConf.playStartTime<0||this.mixAudioConf.playStartTime>=this.mixAudioConf.totalTime)&&(this.mixAudioConf.playStartTime=0),this.logger.log("设置音量:",this.mixAudioConf.volume),this.mixAudioConf.gainFilter.gain.value=this.mixAudioConf.volume,e.loopback&&e.cycle>1){this.mixAudioConf.audioSource.loop=e.loopback;const t=e.cycle*this.mixAudioConf.totalTime-this.mixAudioConf.playStartTime;this.logger.log("循环播放: options.playStartTime: ",this.mixAudioConf.playStartTime),this.logger.log("循环播放: totalTime: ",t),this.mixAudioConf.audioSource.start(0,this.mixAudioConf.playStartTime,t-1)}else e.loopback&&1==e.cycle?(this.mixAudioConf.audioSource.loop=!1,this.mixAudioConf.audioSource.start(0,this.mixAudioConf.playStartTime)):(this.logger.log("无限循环播放 loop: ",e.loopback),this.mixAudioConf.audioSource.loop=e.loopback,this.mixAudioConf.audioSource.start(0,this.mixAudioConf.playStartTime));return this.mixAudioConf.state=d.AuidoMixingState.PLAYED,this.mixAudioConf.startTime=Date.now(),Promise.resolve()}pauseAudioMixing(){if(!this.mixAudioConf.audioSource||!this.mixAudioConf.gainFilter)return void this.logger.error("pauseAudioMixing:参数不够");this.logger.log("暂停混音"),this.mixAudioConf.audioSource.onended=null,this.mixAudioConf.audioSource.disconnect(0),this.mixAudioConf.gainFilter.disconnect(0),this.mixAudioConf.audioSource.stop(),this.mixAudioConf.pauseTime=Date.now(),this.mixAudioConf.state=d.AuidoMixingState.PAUSED;let e=(this.mixAudioConf.pauseTime-this.mixAudioConf.startTime)/1e3+this.mixAudioConf.playStartTime;return this.logger.log("已经播放的时间: ",e),e>this.mixAudioConf.totalTime&&(e%=this.mixAudioConf.totalTime),this.logger.log("暂停位置:",e),Promise.resolve()}resumeAudioMixing(e){return this.logger.log("恢复混音"),this.mixAudioConf.pauseTime=0,e.volume=255*this.mixAudioConf.volume,this.startMix(e)}stopAudioMixing(e=!0){if(!this.mixAudioConf.audioSource||!this.mixAudioConf.gainFilter){this.logger.error("stopAudioMixing: 接口调用逻辑异常");let e="webAudio_stopAudioMixing: Interface call logic exception",t="webAudio_stopAudioMixing: 接口调用逻辑异常",i="Please make sure to call this interface after the audioMixing is started/paused",r="请确保在开启/暂停伴音的状态下再调用该接口",s=h.IS_ZH?t:e,a=h.IS_ZH?r:i;return Promise.reject(new l.default({code:c.default.AUDIO_MIX_STATE_ERROR,message:s,advice:a}))}return this.logger.log("开始停止混音, isFinished: ",e),this.mixAudioConf.audioSource.onended=null,this.mixAudioConf.audioSource.disconnect(0),this.mixAudioConf.gainFilter.disconnect(0),this.mixAudioConf.audioSource.stop(),this.mixAudioConf.state=d.AuidoMixingState.STOPED,e&&this.resetMixConf(),this.logger.log("混音已停止"),Promise.resolve()}audioEnd(e){if(this.mixAudioConf.state===d.AuidoMixingState.PLAYED){if(!(this.mixAudioConf.audioSource&&this.mixAudioConf.audioSource.loop&&this.mixAudioConf.cycle<=0))return this.logger.log("伴音播放完成: ",this.mixAudioConf),this.mixAudioConf.audioSource&&(this.mixAudioConf.audioSource.onended=null),this.mixAudioConf.auidoMixingEnd&&(this.mixAudioConf.auidoMixingEnd(e),this.mixAudioConf.auidoMixingEnd=null),this.resetMixConf(),Promise.resolve();this.logger.log("无限循环时，伴音播放完成event: ",e)}else this.logger.error("audioEnd:参数不够")}setAudioMixingVolume(e){if(this.mixAudioConf.gainFilter)return this.mixAudioConf.gainFilter.gain.value=e/255,this.mixAudioConf.volume=this.mixAudioConf.gainFilter.gain.value,Promise.resolve();this.logger.error("setAudioMixingVolume:参数不够")}setAudioMixingPlayTime(e){return this.mixAudioConf.state===d.AuidoMixingState.PLAYED&&(this.mixAudioConf.setPlayStartTime=e.playStartTime),e.volume=255*this.mixAudioConf.volume,this.startMix(e)}getAudioMixingPlayedTime(){let e=Date.now();this.mixAudioConf.state==d.AuidoMixingState.PAUSED&&this.mixAudioConf.pauseTime&&(this.logger.log("当前是暂停状态"),e=this.mixAudioConf.pauseTime);let t=(e-this.mixAudioConf.startTime)/1e3+this.mixAudioConf.playStartTime;return t>this.mixAudioConf.totalTime&&(t%=this.mixAudioConf.totalTime),{playedTime:t}}getAudioMixingTotalTime(){return{totalTime:this.mixAudioConf.totalTime}}createAudioBufferSource(e){if(!this.context||!this.destination||!this.gainFilter){this.logger.error("webAudio_createAudioBufferSource: 接口调用状态异常");let e="webAudio_createAudioBufferSource: Interface call status exception",t="webAudio_createAudioBufferSource: 接口调用状态异常",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=h.IS_ZH?t:e,a=h.IS_ZH?r:i;throw new l.default({code:c.default.AUDIO_EFFECT_STATE_ERROR,message:s,advice:a})}const t=this.context.createBufferSource();t.buffer=e;const i=this.context.createGain();t.connect(i);return{sourceNode:t,gainNode:i}}startAudioEffectMix(e){if(!this.context||!this.destination||!this.gainFilter){this.logger.error("webAudio_startAudioEffectMix: 接口调用状态异常");let e="webAudio_startAudioEffectMix: Interface call status exception",t="webAudio_startAudioEffectMix: 接口调用状态异常",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=h.IS_ZH?t:e,a=h.IS_ZH?r:i;return Promise.reject(new l.default({code:c.default.AUDIO_EFFECT_STATE_ERROR,message:s,advice:a}))}const{sourceNode:t,gainNode:i,playOverTime:r,playStartTime:s,volume:a,cycle:o}=e;i&&t&&(this.logger.log("startAudioEffectMix: ",JSON.stringify(e)),i.connect(this.gainFilter),this.musicDestination&&i.connect(this.musicDestination),i.gain.value=a/100,o>1?(t.loop=!0,t.start(0,s,r)):(t.loop=!1,t.start(0,s)),this.mixAudioConf.state=d.AuidoMixingState.PLAYED,this.mixAudioConf.startTime=Date.now())}stopAudioEffectMix(e){const{sourceNode:t,gainNode:i,playOverTime:r,playStartTime:s,volume:a,cycle:o}=e;if(!i||!t){this.logger.error("webAudio_stopAudioEffectMix: 接口调用状态异常");let e="webAudio_stopAudioEffectMix: Interface call status exception",t="webAudio_startAudioEffectMix: 接口调用状态异常",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=h.IS_ZH?t:e,a=h.IS_ZH?r:i;return Promise.reject(new l.default({code:c.default.AUDIO_EFFECT_STATE_ERROR,message:s,advice:a}))}this.logger.log("stopAudioEffectMix: ",JSON.stringify(e)),t.onended=null,t.disconnect(0),i.disconnect(0),t.stop()}destroy(){this.logger.log("AudioContext 清除"),this.instant=0,this.slow=0,this.clip=0,this.gainFilter&&this.gainFilter.disconnect(0),this.script&&this.script.disconnect(0);for(let e=0;e<this.audioInArr.length;e++)this.audioInArr[e]&&this.audioInArr[e].disconnect();this.audioInArr=[]}getVolumeData(){return this.instant.toFixed(2)}}t.WebAudio=y},function(e,t){var i,r,s=e.exports={};function a(){throw new Error("setTimeout has not been defined")}function o(){throw new Error("clearTimeout has not been defined")}function n(e){if(i===setTimeout)return setTimeout(e,0);if((i===a||!i)&&setTimeout)return i=setTimeout,setTimeout(e,0);try{return i(e,0)}catch(t){try{return i.call(null,e,0)}catch(t){return i.call(this,e,0)}}}!function(){try{i="function"==typeof setTimeout?setTimeout:a}catch(e){i=a}try{r="function"==typeof clearTimeout?clearTimeout:o}catch(e){r=o}}();var d,c=[],l=!1,u=-1;function h(){l&&d&&(l=!1,d.length?c=d.concat(c):u=-1,c.length&&p())}function p(){if(!l){var e=n(h);l=!0;for(var t=c.length;t;){for(d=c,c=[];++u<t;)d&&d[u].run();u=-1,t=c.length}d=null,l=!1,function(e){if(r===clearTimeout)return clearTimeout(e);if((r===o||!r)&&clearTimeout)return r=clearTimeout,clearTimeout(e);try{r(e)}catch(t){try{return r.call(null,e)}catch(t){return r.call(this,e)}}}(e)}}function m(e,t){this.fun=e,this.array=t}function f(){}s.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)t[i-1]=arguments[i];c.push(new m(e,t)),1!==c.length||l||n(p)},m.prototype.run=function(){this.fun.apply(null,this.array)},s.title="browser",s.browser=!0,s.env={},s.argv=[],s.version="",s.versions={},s.on=f,s.addListener=f,s.once=f,s.off=f,s.removeListener=f,s.removeAllListeners=f,s.emit=f,s.prependListener=f,s.prependOnceListener=f,s.listeners=function(e){return[]},s.binding=function(e){throw new Error("process.binding is not supported")},s.cwd=function(){return"/"},s.chdir=function(e){throw new Error("process.chdir is not supported")},s.umask=function(){return 0}},function(e,t){var i;i=function(){return this}();try{i=i||new Function("return this")()}catch(e){"object"==typeof window&&(i=window)}e.exports=i},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.SDK_VERSION=t.roomsTaskUrl=t.lbsUrl=t.LBS_BUILD_CONFIG=t.getCloudProxyInfoUrl=t.getChannelInfoUrl=t.ENV=t.ENGINE_VERSION=t.createChannelUrl=t.checkSumUrl=t.BUILD=void 0;t.SDK_VERSION="4.6.25";t.ENGINE_VERSION="4.6.25.0";t.BUILD="v4.6.25-0-gd2caa70b";const r=i(206);Object.defineProperty(t,"ENV",{enumerable:!0,get:function(){return r.ENV}}),Object.defineProperty(t,"LBS_BUILD_CONFIG",{enumerable:!0,get:function(){return r.LBS_BUILD_CONFIG}});const s=r.Config.checkSumUrl;t.checkSumUrl=s;const a=r.Config.createChannelUrl;t.createChannelUrl=a;const o=r.Config.getChannelInfoUrl;t.getChannelInfoUrl=o;const n=r.Config.roomsTaskUrl;t.roomsTaskUrl=n;const d=r.Config.getCloudProxyInfoUrl;t.getCloudProxyInfoUrl=d;const c=r.Config.lbsUrl;t.lbsUrl=c},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.RTCEventEmitter=void 0;const r=i(13);class s extends r.EventEmitter{constructor(){super(),this._events||(this._events={})}safeEmit(e,...t){try{e.match(/^@/)||this.emit("@"+e,...t),this.emit(e,...t)}catch(t){(this.logger||console).error(`Error on event ${e}: ${t.name} ${t.message}`,t.stack)}}}t.RTCEventEmitter=s},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.getBrowserInfo=t.getOSInfo=void 0;const o=a(i(2)),n=new Map([[o.IS_ANDROID,["Android",o.ANDROID_VERSION]],[o.IS_IOS,["iOS",o.IOS_VERSION]],[o.IS_WIN,["Windows",o.WIN_VERSION]],[o.IS_MAC,["MacOS",o.MACOS_VERSION]]]);t.getOSInfo=function(){let e="unknown",t="unknown";return n.get(!0)&&(e=n.get(!0)[0],t=n.get(!0)[1]),{osName:e,osVersion:t}};const d=new Map([[o.IS_FIREFOX,["Firefox",o.FIREFOX_VERSION]],[o.IS_EDG,["Edg",o.EDG_VERSION]],[o.IS_CHROME,["Chrome",o.CHROME_VERSION]],[o.IS_SAFARI,["Safari",o.SAFARI_VERSION]],[o.IS_WECHAT,["WeChat",o.WECHAT_VERSION]],[o.IS_WQQB,["QQ(Win)",o.WQQB_VERSION]],[o.IS_MQQB,["QQ(Mobile)",o.MQQB_VERSION]],[o.IS_X5MQQB,["QQ(Mobile X5)",o.MQQB_VERSION]],[o.IS_MACQQB,["QQ(Mac)",o.MACQQB_VERSION]],[o.IS_IPADQQB,["QQ(iPad)",o.IPADQQB_VERSION]],[o.IS_MIBROWSER,["MI",o.MI_VERSION]],[o.IS_HUAWEIBROWSER,["HW",o.HUAWEI_VERSION]],[o.IS_SAMSUNGBROWSER,["Samsung",o.SAMSUNG_VERSION]],[o.IS_OPPOBROWSER,["OPPO",o.OPPO_VERSION]],[o.IS_VIVOBROWSER,["VIVO",o.VIVO_VERSION]],[o.IS_EDGE,["EDGE",o.EDGE_VERSION]],[o.IS_SOGOUM,["SogouMobile",o.SOGOUM_VERSION]],[o.IS_SOGOU,["Sogou",o.SOGOU_VERSION]],[o.IS_ELECTRON,["Sogou",o.ELECTRON_VERSION]]]);t.getBrowserInfo=function(){let e="unknown",t="unknown";return d.get(!0)&&(e=d.get(!0)[0],t=d.get(!0)[1]),{browserName:e,browserVersion:t}}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.reduceCodecs=t.getSupportedCodecs=t.VideoCodecList=void 0;const r=i(5),s=i(138);function a(e){const t={video:[],audio:[]};return e.match(/ H264/i)&&t.video.push("H264"),e.match(/ VP8/i)&&t.video.push("VP8"),e.match(/ opus/i)&&t.audio.push("OPUS"),t}function o(e,t,i){const s={video:[],audio:[]};if(t&&t.codecs&&t.codecs.length)for(let i=0;i<t.codecs.length;i++){const a=t.codecs[i];"video/H264"==a.mimeType&&-1===s.video.indexOf("H264")&&("recv"===e&&a.sdpFmtpLine&&a.sdpFmtpLine.indexOf("profile-level-id")>-1?r.getParameters().h264StrictHigh?a.sdpFmtpLine.indexOf("profile-level-id=64")>-1&&s.video.push("H264"):s.video.push("H264"):-1===s.video.indexOf("H264")&&s.video.push("H264")),"video/VP8"==a.mimeType&&-1===s.video.indexOf("VP8")&&s.video.push("VP8")}if(i&&i.codecs&&i.codecs.length)for(let e=0;e<i.codecs.length;e++){"audio/opus"==i.codecs[e].mimeType&&s.audio.push("OPUS")}return s}t.VideoCodecList=["H264","VP8"],t.getSupportedCodecs=async function(e="recv",t=RTCPeerConnection){if("recv"===e){if("undefined"!=typeof RTCRtpReceiver&&RTCRtpReceiver.getCapabilities){return o(e,RTCRtpReceiver.getCapabilities("video"),RTCRtpReceiver.getCapabilities("audio"))}{const e=new t({});e.addTransceiver("audio",{direction:"recvonly"}),e.addTransceiver("video",{direction:"recvonly"});const i=await e.createOffer({});if(e.close(),!i.sdp)return!1;return a(i.sdp)}}if("undefined"!=typeof RTCRtpSender&&RTCRtpSender.getCapabilities){return o(e,RTCRtpSender.getCapabilities("video"),RTCRtpSender.getCapabilities("audio"))}{const e=new t({});let i=new s.RTCCanvas("canvas");const r=i._canvas.captureStream(0);e.addTrack(r.getVideoTracks()[0],r);const o=await e.createOffer({});if(e.close(),!o.sdp)return!1;const n=a(o.sdp);return i.destroy(),n}},t.reduceCodecs=function(e,i){const r=[];for(let s=0;s<e.length;s++)e[s].mimeType&&i&&t.VideoCodecList.indexOf(e[s].mimeType.split("/")[1])>-1&&e[s].mimeType!==i.mimeType?s++:r.push(e[s]);return r}},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.isExistOptions=t.checkValidString=t.checkValidInteger=t.checkValidFloat=t.checkValidBoolean=t.checkExists=void 0;const n=o(i(11)),d=o(i(12)),c=a(i(2));t.checkValidInteger=e=>{const t=(e=>Number.isInteger(e.value)?"number"==typeof e.min&&e.value<e.min?{result:!1,zhMsg:"参数小于最小值 "+e.min,enMsg:"The parameter is less than the minimum value "+e.min}:"number"==typeof e.max&&e.value>e.max?{result:!1,zhMsg:"参数大于最大值 "+e.max,enMsg:"The parameter is greater than the maximum value "+e.max}:{result:!0}:{result:!1,zhMsg:"参数不是整数",enMsg:"Parameter is not Number"})(e);if(!t.result){let i=c.IS_ZH?`checkValidInteger: 参数错误: ${e.tag}:${t.zhMsg}`:`checkValidInteger: invalid parameter: ${e.tag}:${t.enMsg}`;throw new d.default({code:n.default.INVALID_PARAMETER_ERROR,message:i})}};t.checkValidBoolean=e=>{const t=(e=>"boolean"!=typeof e.value?{result:!1,enMsg:"The parameter is not Boolean",zhMsg:"参数不是布尔类型"}:{result:!0})(e);if(!t.result){let i=c.IS_ZH?`checkValidBoolean: 参数错误: ${e.tag}:${t.zhMsg}`:`checkValidBoolean: invalid parameter: ${e.tag}:${t.enMsg}`;throw new d.default({code:n.default.INVALID_PARAMETER_ERROR,message:i})}};t.checkValidString=e=>{const t=(e=>"string"!=typeof e.value?{result:!1,zhMsg:"参数不是字符串",enMsg:"The parameter is not String"}:"number"==typeof e.min&&e.value.length<e.min?{result:!1,zhMsg:"参数长度最小值"+e.min,enMsg:"The parameter is less than the minimum value "+e.min}:"number"==typeof e.max&&e.value.length>e.max?{result:!1,zhMsg:"参数长度大于最大值"+e.max,enMsg:"The parameter is greater than the maximum value "+e.max}:{result:!0})(e);if(!t.result){let i=c.IS_ZH?`checkValidString: 参数错误: ${e.tag}:${t.zhMsg}`:`checkValidString: invalid parameter: ${e.tag}:${t.enMsg}`;throw new d.default({code:n.default.INVALID_PARAMETER_ERROR,message:i})}};t.checkValidFloat=e=>{const t=(e=>Number.isFinite(e.value)?"number"==typeof e.min&&e.value<e.min?{result:!1,zhMsg:"参数小于最小值"+e.min,enMsg:"The parameter is less than the minimum value "+e.min}:"number"==typeof e.max&&e.value>e.max?{result:!1,zhMsg:"参数大于最大值"+e.max,enMsg:"The parameter is greater than the maximum value "+e.max}:{result:!0}:{result:!1,zhMsg:"参数不是float类型",enMsg:"The parameter is not float"})(e);if(!t.result){let i=c.IS_ZH?`checkValidFloat: 参数错误: ${e.tag}:${t.zhMsg}`:`checkValidFloat: invalid parameter: ${e.tag}:${t.enMsg}`;throw new d.default({code:n.default.INVALID_PARAMETER_ERROR,message:i})}};const l=e=>void 0===e.value||null===e.value?{result:!1,zhMsg:"未填必选参数",enMsg:"Missing required parameters"}:{result:!0};t.isExistOptions=l;t.checkExists=e=>{const t=l(e);if(!t.result){let i=c.IS_ZH?`checkExists: 参数错误: ${e.tag}:${t.zhMsg}`:`checkExists: invalid parameter: ${e.tag}:${t.enMsg}`;throw new d.default({code:n.default.INVALID_PARAMETER_ERROR,message:i})}}},function(e,t,i){var r;!function(s){var a,o=/^-?(?:\d+(?:\.\d*)?|\.\d+)(?:e[+-]?\d+)?$/i,n=Math.ceil,d=Math.floor,c="[BigNumber Error] ",l=c+"Number primitive has more than 15 significant digits: ",u=1e14,h=[1,10,100,1e3,1e4,1e5,1e6,1e7,1e8,1e9,1e10,1e11,1e12,1e13],p=1e9;function m(e){var t=0|e;return e>0||e===t?t:t-1}function f(e){for(var t,i,r=1,s=e.length,a=e[0]+"";r<s;){for(i=14-(t=e[r++]+"").length;i--;t="0"+t);a+=t}for(s=a.length;48===a.charCodeAt(--s););return a.slice(0,s+1||1)}function g(e,t){var i,r,s=e.c,a=t.c,o=e.s,n=t.s,d=e.e,c=t.e;if(!o||!n)return null;if(i=s&&!s[0],r=a&&!a[0],i||r)return i?r?0:-n:o;if(o!=n)return o;if(i=o<0,r=d==c,!s||!a)return r?0:!s^i?1:-1;if(!r)return d>c^i?1:-1;for(n=(d=s.length)<(c=a.length)?d:c,o=0;o<n;o++)if(s[o]!=a[o])return s[o]>a[o]^i?1:-1;return d==c?0:d>c^i?1:-1}function v(e,t,i,r){if(e<t||e>i||e!==d(e))throw Error(c+(r||"Argument")+("number"==typeof e?e<t||e>i?" out of range: ":" not an integer: ":" not a primitive number: ")+String(e))}function _(e){var t=e.c.length-1;return m(e.e/14)==t&&e.c[t]%2!=0}function S(e,t){return(e.length>1?e.charAt(0)+"."+e.slice(1):e)+(t<0?"e":"e+")+t}function y(e,t,i){var r,s;if(t<0){for(s=i+".";++t;s+=i);e=s+e}else if(++t>(r=e.length)){for(s=i,t-=r;--t;s+=i);e+=s}else t<r&&(e=e.slice(0,t)+"."+e.slice(t));return e}(a=function e(t){var i,r,s,a,R,b,T,w,I,E=V.prototype={constructor:V,toString:null,valueOf:null},A=new V(1),C=20,P=4,k=-7,O=21,x=-1e7,D=1e7,M=!1,N=1,L=0,H={prefix:"",groupSize:3,secondaryGroupSize:0,groupSeparator:",",decimalSeparator:".",fractionGroupSize:0,fractionGroupSeparator:" ",suffix:""},F="0123456789abcdefghijklmnopqrstuvwxyz";function V(e,t){var i,a,n,c,u,h,p,m,f=this;if(!(f instanceof V))return new V(e,t);if(null==t){if(e&&!0===e._isBigNumber)return f.s=e.s,void(!e.c||e.e>D?f.c=f.e=null:e.e<x?f.c=[f.e=0]:(f.e=e.e,f.c=e.c.slice()));if((h="number"==typeof e)&&0*e==0){if(f.s=1/e<0?(e=-e,-1):1,e===~~e){for(c=0,u=e;u>=10;u/=10,c++);return void(c>D?f.c=f.e=null:(f.e=c,f.c=[e]))}m=String(e)}else{if(!o.test(m=String(e)))return s(f,m,h);f.s=45==m.charCodeAt(0)?(m=m.slice(1),-1):1}(c=m.indexOf("."))>-1&&(m=m.replace(".","")),(u=m.search(/e/i))>0?(c<0&&(c=u),c+=+m.slice(u+1),m=m.substring(0,u)):c<0&&(c=m.length)}else{if(v(t,2,F.length,"Base"),10==t)return $(f=new V(e),C+f.e+1,P);if(m=String(e),h="number"==typeof e){if(0*e!=0)return s(f,m,h,t);if(f.s=1/e<0?(m=m.slice(1),-1):1,V.DEBUG&&m.replace(/^0\.0*|\./,"").length>15)throw Error(l+e)}else f.s=45===m.charCodeAt(0)?(m=m.slice(1),-1):1;for(i=F.slice(0,t),c=u=0,p=m.length;u<p;u++)if(i.indexOf(a=m.charAt(u))<0){if("."==a){if(u>c){c=p;continue}}else if(!n&&(m==m.toUpperCase()&&(m=m.toLowerCase())||m==m.toLowerCase()&&(m=m.toUpperCase()))){n=!0,u=-1,c=0;continue}return s(f,String(e),h,t)}h=!1,(c=(m=r(m,t,10,f.s)).indexOf("."))>-1?m=m.replace(".",""):c=m.length}for(u=0;48===m.charCodeAt(u);u++);for(p=m.length;48===m.charCodeAt(--p););if(m=m.slice(u,++p)){if(p-=u,h&&V.DEBUG&&p>15&&(e>9007199254740991||e!==d(e)))throw Error(l+f.s*e);if((c=c-u-1)>D)f.c=f.e=null;else if(c<x)f.c=[f.e=0];else{if(f.e=c,f.c=[],u=(c+1)%14,c<0&&(u+=14),u<p){for(u&&f.c.push(+m.slice(0,u)),p-=14;u<p;)f.c.push(+m.slice(u,u+=14));u=14-(m=m.slice(u)).length}else u-=p;for(;u--;m+="0");f.c.push(+m)}}else f.c=[f.e=0]}function j(e,t,i,r){var s,a,o,n,d;if(null==i?i=P:v(i,0,8),!e.c)return e.toString();if(s=e.c[0],o=e.e,null==t)d=f(e.c),d=1==r||2==r&&(o<=k||o>=O)?S(d,o):y(d,o,"0");else if(a=(e=$(new V(e),t,i)).e,n=(d=f(e.c)).length,1==r||2==r&&(t<=a||a<=k)){for(;n<t;d+="0",n++);d=S(d,a)}else if(t-=o,d=y(d,a,"0"),a+1>n){if(--t>0)for(d+=".";t--;d+="0");}else if((t+=a-n)>0)for(a+1==n&&(d+=".");t--;d+="0");return e.s<0&&s?"-"+d:d}function B(e,t){for(var i,r=1,s=new V(e[0]);r<e.length;r++){if(!(i=new V(e[r])).s){s=i;break}t.call(s,i)&&(s=i)}return s}function U(e,t,i){for(var r=1,s=t.length;!t[--s];t.pop());for(s=t[0];s>=10;s/=10,r++);return(i=r+14*i-1)>D?e.c=e.e=null:i<x?e.c=[e.e=0]:(e.e=i,e.c=t),e}function $(e,t,i,r){var s,a,o,c,l,p,m,f=e.c,g=h;if(f){e:{for(s=1,c=f[0];c>=10;c/=10,s++);if((a=t-s)<0)a+=14,o=t,m=(l=f[p=0])/g[s-o-1]%10|0;else if((p=n((a+1)/14))>=f.length){if(!r)break e;for(;f.length<=p;f.push(0));l=m=0,s=1,o=(a%=14)-14+1}else{for(l=c=f[p],s=1;c>=10;c/=10,s++);m=(o=(a%=14)-14+s)<0?0:l/g[s-o-1]%10|0}if(r=r||t<0||null!=f[p+1]||(o<0?l:l%g[s-o-1]),r=i<4?(m||r)&&(0==i||i==(e.s<0?3:2)):m>5||5==m&&(4==i||r||6==i&&(a>0?o>0?l/g[s-o]:0:f[p-1])%10&1||i==(e.s<0?8:7)),t<1||!f[0])return f.length=0,r?(t-=e.e+1,f[0]=g[(14-t%14)%14],e.e=-t||0):f[0]=e.e=0,e;if(0==a?(f.length=p,c=1,p--):(f.length=p+1,c=g[14-a],f[p]=o>0?d(l/g[s-o]%g[o])*c:0),r)for(;;){if(0==p){for(a=1,o=f[0];o>=10;o/=10,a++);for(o=f[0]+=c,c=1;o>=10;o/=10,c++);a!=c&&(e.e++,f[0]==u&&(f[0]=1));break}if(f[p]+=c,f[p]!=u)break;f[p--]=0,c=1}for(a=f.length;0===f[--a];f.pop());}e.e>D?e.c=e.e=null:e.e<x&&(e.c=[e.e=0])}return e}function W(e){var t,i=e.e;return null===i?e.toString():(t=f(e.c),t=i<=k||i>=O?S(t,i):y(t,i,"0"),e.s<0?"-"+t:t)}return V.clone=e,V.ROUND_UP=0,V.ROUND_DOWN=1,V.ROUND_CEIL=2,V.ROUND_FLOOR=3,V.ROUND_HALF_UP=4,V.ROUND_HALF_DOWN=5,V.ROUND_HALF_EVEN=6,V.ROUND_HALF_CEIL=7,V.ROUND_HALF_FLOOR=8,V.EUCLID=9,V.config=V.set=function(e){var t,i;if(null!=e){if("object"!=typeof e)throw Error(c+"Object expected: "+e);if(e.hasOwnProperty(t="DECIMAL_PLACES")&&(v(i=e[t],0,p,t),C=i),e.hasOwnProperty(t="ROUNDING_MODE")&&(v(i=e[t],0,8,t),P=i),e.hasOwnProperty(t="EXPONENTIAL_AT")&&((i=e[t])&&i.pop?(v(i[0],-p,0,t),v(i[1],0,p,t),k=i[0],O=i[1]):(v(i,-p,p,t),k=-(O=i<0?-i:i))),e.hasOwnProperty(t="RANGE"))if((i=e[t])&&i.pop)v(i[0],-p,-1,t),v(i[1],1,p,t),x=i[0],D=i[1];else{if(v(i,-p,p,t),!i)throw Error(c+t+" cannot be zero: "+i);x=-(D=i<0?-i:i)}if(e.hasOwnProperty(t="CRYPTO")){if((i=e[t])!==!!i)throw Error(c+t+" not true or false: "+i);if(i){if("undefined"==typeof crypto||!crypto||!crypto.getRandomValues&&!crypto.randomBytes)throw M=!i,Error(c+"crypto unavailable");M=i}else M=i}if(e.hasOwnProperty(t="MODULO_MODE")&&(v(i=e[t],0,9,t),N=i),e.hasOwnProperty(t="POW_PRECISION")&&(v(i=e[t],0,p,t),L=i),e.hasOwnProperty(t="FORMAT")){if("object"!=typeof(i=e[t]))throw Error(c+t+" not an object: "+i);H=i}if(e.hasOwnProperty(t="ALPHABET")){if("string"!=typeof(i=e[t])||/^.?$|[+\-.\s]|(.).*\1/.test(i))throw Error(c+t+" invalid: "+i);F=i}}return{DECIMAL_PLACES:C,ROUNDING_MODE:P,EXPONENTIAL_AT:[k,O],RANGE:[x,D],CRYPTO:M,MODULO_MODE:N,POW_PRECISION:L,FORMAT:H,ALPHABET:F}},V.isBigNumber=function(e){if(!e||!0!==e._isBigNumber)return!1;if(!V.DEBUG)return!0;var t,i,r=e.c,s=e.e,a=e.s;e:if("[object Array]"=={}.toString.call(r)){if((1===a||-1===a)&&s>=-p&&s<=p&&s===d(s)){if(0===r[0]){if(0===s&&1===r.length)return!0;break e}if((t=(s+1)%14)<1&&(t+=14),String(r[0]).length==t){for(t=0;t<r.length;t++)if((i=r[t])<0||i>=u||i!==d(i))break e;if(0!==i)return!0}}}else if(null===r&&null===s&&(null===a||1===a||-1===a))return!0;throw Error(c+"Invalid BigNumber: "+e)},V.maximum=V.max=function(){return B(arguments,E.lt)},V.minimum=V.min=function(){return B(arguments,E.gt)},V.random=(a=9007199254740992*Math.random()&2097151?function(){return d(9007199254740992*Math.random())}:function(){return 8388608*(1073741824*Math.random()|0)+(8388608*Math.random()|0)},function(e){var t,i,r,s,o,l=0,u=[],m=new V(A);if(null==e?e=C:v(e,0,p),s=n(e/14),M)if(crypto.getRandomValues){for(t=crypto.getRandomValues(new Uint32Array(s*=2));l<s;)(o=131072*t[l]+(t[l+1]>>>11))>=9e15?(i=crypto.getRandomValues(new Uint32Array(2)),t[l]=i[0],t[l+1]=i[1]):(u.push(o%1e14),l+=2);l=s/2}else{if(!crypto.randomBytes)throw M=!1,Error(c+"crypto unavailable");for(t=crypto.randomBytes(s*=7);l<s;)(o=281474976710656*(31&t[l])+1099511627776*t[l+1]+4294967296*t[l+2]+16777216*t[l+3]+(t[l+4]<<16)+(t[l+5]<<8)+t[l+6])>=9e15?crypto.randomBytes(7).copy(t,l):(u.push(o%1e14),l+=7);l=s/7}if(!M)for(;l<s;)(o=a())<9e15&&(u[l++]=o%1e14);for(e%=14,(s=u[--l])&&e&&(o=h[14-e],u[l]=d(s/o)*o);0===u[l];u.pop(),l--);if(l<0)u=[r=0];else{for(r=-1;0===u[0];u.splice(0,1),r-=14);for(l=1,o=u[0];o>=10;o/=10,l++);l<14&&(r-=14-l)}return m.e=r,m.c=u,m}),V.sum=function(){for(var e=1,t=arguments,i=new V(t[0]);e<t.length;)i=i.plus(t[e++]);return i},r=function(){function e(e,t,i,r){for(var s,a,o=[0],n=0,d=e.length;n<d;){for(a=o.length;a--;o[a]*=t);for(o[0]+=r.indexOf(e.charAt(n++)),s=0;s<o.length;s++)o[s]>i-1&&(null==o[s+1]&&(o[s+1]=0),o[s+1]+=o[s]/i|0,o[s]%=i)}return o.reverse()}return function(t,r,s,a,o){var n,d,c,l,u,h,p,m,g=t.indexOf("."),v=C,_=P;for(g>=0&&(l=L,L=0,t=t.replace(".",""),h=(m=new V(r)).pow(t.length-g),L=l,m.c=e(y(f(h.c),h.e,"0"),10,s,"0123456789"),m.e=m.c.length),c=l=(p=e(t,r,s,o?(n=F,"0123456789"):(n="0123456789",F))).length;0==p[--l];p.pop());if(!p[0])return n.charAt(0);if(g<0?--c:(h.c=p,h.e=c,h.s=a,p=(h=i(h,m,v,_,s)).c,u=h.r,c=h.e),g=p[d=c+v+1],l=s/2,u=u||d<0||null!=p[d+1],u=_<4?(null!=g||u)&&(0==_||_==(h.s<0?3:2)):g>l||g==l&&(4==_||u||6==_&&1&p[d-1]||_==(h.s<0?8:7)),d<1||!p[0])t=u?y(n.charAt(1),-v,n.charAt(0)):n.charAt(0);else{if(p.length=d,u)for(--s;++p[--d]>s;)p[d]=0,d||(++c,p=[1].concat(p));for(l=p.length;!p[--l];);for(g=0,t="";g<=l;t+=n.charAt(p[g++]));t=y(t,c,n.charAt(0))}return t}}(),i=function(){function e(e,t,i){var r,s,a,o,n=0,d=e.length,c=t%1e7,l=t/1e7|0;for(e=e.slice();d--;)n=((s=c*(a=e[d]%1e7)+(r=l*a+(o=e[d]/1e7|0)*c)%1e7*1e7+n)/i|0)+(r/1e7|0)+l*o,e[d]=s%i;return n&&(e=[n].concat(e)),e}function t(e,t,i,r){var s,a;if(i!=r)a=i>r?1:-1;else for(s=a=0;s<i;s++)if(e[s]!=t[s]){a=e[s]>t[s]?1:-1;break}return a}function i(e,t,i,r){for(var s=0;i--;)e[i]-=s,s=e[i]<t[i]?1:0,e[i]=s*r+e[i]-t[i];for(;!e[0]&&e.length>1;e.splice(0,1));}return function(r,s,a,o,n){var c,l,h,p,f,g,v,_,S,y,R,b,T,w,I,E,A,C=r.s==s.s?1:-1,P=r.c,k=s.c;if(!(P&&P[0]&&k&&k[0]))return new V(r.s&&s.s&&(P?!k||P[0]!=k[0]:k)?P&&0==P[0]||!k?0*C:C/0:NaN);for(S=(_=new V(C)).c=[],C=a+(l=r.e-s.e)+1,n||(n=u,l=m(r.e/14)-m(s.e/14),C=C/14|0),h=0;k[h]==(P[h]||0);h++);if(k[h]>(P[h]||0)&&l--,C<0)S.push(1),p=!0;else{for(w=P.length,E=k.length,h=0,C+=2,(f=d(n/(k[0]+1)))>1&&(k=e(k,f,n),P=e(P,f,n),E=k.length,w=P.length),T=E,R=(y=P.slice(0,E)).length;R<E;y[R++]=0);A=k.slice(),A=[0].concat(A),I=k[0],k[1]>=n/2&&I++;do{if(f=0,(c=t(k,y,E,R))<0){if(b=y[0],E!=R&&(b=b*n+(y[1]||0)),(f=d(b/I))>1)for(f>=n&&(f=n-1),v=(g=e(k,f,n)).length,R=y.length;1==t(g,y,v,R);)f--,i(g,E<v?A:k,v,n),v=g.length,c=1;else 0==f&&(c=f=1),v=(g=k.slice()).length;if(v<R&&(g=[0].concat(g)),i(y,g,R,n),R=y.length,-1==c)for(;t(k,y,E,R)<1;)f++,i(y,E<R?A:k,R,n),R=y.length}else 0===c&&(f++,y=[0]);S[h++]=f,y[0]?y[R++]=P[T]||0:(y=[P[T]],R=1)}while((T++<w||null!=y[0])&&C--);p=null!=y[0],S[0]||S.splice(0,1)}if(n==u){for(h=1,C=S[0];C>=10;C/=10,h++);$(_,a+(_.e=h+14*l-1)+1,o,p)}else _.e=l,_.r=+p;return _}}(),R=/^(-?)0([xbo])(?=\w[\w.]*$)/i,b=/^([^.]+)\.$/,T=/^\.([^.]+)$/,w=/^-?(Infinity|NaN)$/,I=/^\s*\+(?=[\w.])|^\s+|\s+$/g,s=function(e,t,i,r){var s,a=i?t:t.replace(I,"");if(w.test(a))e.s=isNaN(a)?null:a<0?-1:1;else{if(!i&&(a=a.replace(R,(function(e,t,i){return s="x"==(i=i.toLowerCase())?16:"b"==i?2:8,r&&r!=s?e:t})),r&&(s=r,a=a.replace(b,"$1").replace(T,"0.$1")),t!=a))return new V(a,s);if(V.DEBUG)throw Error(c+"Not a"+(r?" base "+r:"")+" number: "+t);e.s=null}e.c=e.e=null},E.absoluteValue=E.abs=function(){var e=new V(this);return e.s<0&&(e.s=1),e},E.comparedTo=function(e,t){return g(this,new V(e,t))},E.decimalPlaces=E.dp=function(e,t){var i,r,s,a=this;if(null!=e)return v(e,0,p),null==t?t=P:v(t,0,8),$(new V(a),e+a.e+1,t);if(!(i=a.c))return null;if(r=14*((s=i.length-1)-m(this.e/14)),s=i[s])for(;s%10==0;s/=10,r--);return r<0&&(r=0),r},E.dividedBy=E.div=function(e,t){return i(this,new V(e,t),C,P)},E.dividedToIntegerBy=E.idiv=function(e,t){return i(this,new V(e,t),0,1)},E.exponentiatedBy=E.pow=function(e,t){var i,r,s,a,o,l,u,h,p=this;if((e=new V(e)).c&&!e.isInteger())throw Error(c+"Exponent not an integer: "+W(e));if(null!=t&&(t=new V(t)),o=e.e>14,!p.c||!p.c[0]||1==p.c[0]&&!p.e&&1==p.c.length||!e.c||!e.c[0])return h=new V(Math.pow(+W(p),o?2-_(e):+W(e))),t?h.mod(t):h;if(l=e.s<0,t){if(t.c?!t.c[0]:!t.s)return new V(NaN);(r=!l&&p.isInteger()&&t.isInteger())&&(p=p.mod(t))}else{if(e.e>9&&(p.e>0||p.e<-1||(0==p.e?p.c[0]>1||o&&p.c[1]>=24e7:p.c[0]<8e13||o&&p.c[0]<=9999975e7)))return a=p.s<0&&_(e)?-0:0,p.e>-1&&(a=1/a),new V(l?1/a:a);L&&(a=n(L/14+2))}for(o?(i=new V(.5),l&&(e.s=1),u=_(e)):u=(s=Math.abs(+W(e)))%2,h=new V(A);;){if(u){if(!(h=h.times(p)).c)break;a?h.c.length>a&&(h.c.length=a):r&&(h=h.mod(t))}if(s){if(0===(s=d(s/2)))break;u=s%2}else if($(e=e.times(i),e.e+1,1),e.e>14)u=_(e);else{if(0===(s=+W(e)))break;u=s%2}p=p.times(p),a?p.c&&p.c.length>a&&(p.c.length=a):r&&(p=p.mod(t))}return r?h:(l&&(h=A.div(h)),t?h.mod(t):a?$(h,L,P,void 0):h)},E.integerValue=function(e){var t=new V(this);return null==e?e=P:v(e,0,8),$(t,t.e+1,e)},E.isEqualTo=E.eq=function(e,t){return 0===g(this,new V(e,t))},E.isFinite=function(){return!!this.c},E.isGreaterThan=E.gt=function(e,t){return g(this,new V(e,t))>0},E.isGreaterThanOrEqualTo=E.gte=function(e,t){return 1===(t=g(this,new V(e,t)))||0===t},E.isInteger=function(){return!!this.c&&m(this.e/14)>this.c.length-2},E.isLessThan=E.lt=function(e,t){return g(this,new V(e,t))<0},E.isLessThanOrEqualTo=E.lte=function(e,t){return-1===(t=g(this,new V(e,t)))||0===t},E.isNaN=function(){return!this.s},E.isNegative=function(){return this.s<0},E.isPositive=function(){return this.s>0},E.isZero=function(){return!!this.c&&0==this.c[0]},E.minus=function(e,t){var i,r,s,a,o=this,n=o.s;if(t=(e=new V(e,t)).s,!n||!t)return new V(NaN);if(n!=t)return e.s=-t,o.plus(e);var d=o.e/14,c=e.e/14,l=o.c,h=e.c;if(!d||!c){if(!l||!h)return l?(e.s=-t,e):new V(h?o:NaN);if(!l[0]||!h[0])return h[0]?(e.s=-t,e):new V(l[0]?o:3==P?-0:0)}if(d=m(d),c=m(c),l=l.slice(),n=d-c){for((a=n<0)?(n=-n,s=l):(c=d,s=h),s.reverse(),t=n;t--;s.push(0));s.reverse()}else for(r=(a=(n=l.length)<(t=h.length))?n:t,n=t=0;t<r;t++)if(l[t]!=h[t]){a=l[t]<h[t];break}if(a&&(s=l,l=h,h=s,e.s=-e.s),(t=(r=h.length)-(i=l.length))>0)for(;t--;l[i++]=0);for(t=u-1;r>n;){if(l[--r]<h[r]){for(i=r;i&&!l[--i];l[i]=t);--l[i],l[r]+=u}l[r]-=h[r]}for(;0==l[0];l.splice(0,1),--c);return l[0]?U(e,l,c):(e.s=3==P?-1:1,e.c=[e.e=0],e)},E.modulo=E.mod=function(e,t){var r,s,a=this;return e=new V(e,t),!a.c||!e.s||e.c&&!e.c[0]?new V(NaN):!e.c||a.c&&!a.c[0]?new V(a):(9==N?(s=e.s,e.s=1,r=i(a,e,0,3),e.s=s,r.s*=s):r=i(a,e,0,N),(e=a.minus(r.times(e))).c[0]||1!=N||(e.s=a.s),e)},E.multipliedBy=E.times=function(e,t){var i,r,s,a,o,n,d,c,l,h,p,f,g,v,_=this,S=_.c,y=(e=new V(e,t)).c;if(!(S&&y&&S[0]&&y[0]))return!_.s||!e.s||S&&!S[0]&&!y||y&&!y[0]&&!S?e.c=e.e=e.s=null:(e.s*=_.s,S&&y?(e.c=[0],e.e=0):e.c=e.e=null),e;for(r=m(_.e/14)+m(e.e/14),e.s*=_.s,(d=S.length)<(h=y.length)&&(g=S,S=y,y=g,s=d,d=h,h=s),s=d+h,g=[];s--;g.push(0));for(v=u,1e7,s=h;--s>=0;){for(i=0,p=y[s]%1e7,f=y[s]/1e7|0,a=s+(o=d);a>s;)i=((c=p*(c=S[--o]%1e7)+(n=f*c+(l=S[o]/1e7|0)*p)%1e7*1e7+g[a]+i)/v|0)+(n/1e7|0)+f*l,g[a--]=c%v;g[a]=i}return i?++r:g.splice(0,1),U(e,g,r)},E.negated=function(){var e=new V(this);return e.s=-e.s||null,e},E.plus=function(e,t){var i,r=this,s=r.s;if(t=(e=new V(e,t)).s,!s||!t)return new V(NaN);if(s!=t)return e.s=-t,r.minus(e);var a=r.e/14,o=e.e/14,n=r.c,d=e.c;if(!a||!o){if(!n||!d)return new V(s/0);if(!n[0]||!d[0])return d[0]?e:new V(n[0]?r:0*s)}if(a=m(a),o=m(o),n=n.slice(),s=a-o){for(s>0?(o=a,i=d):(s=-s,i=n),i.reverse();s--;i.push(0));i.reverse()}for((s=n.length)-(t=d.length)<0&&(i=d,d=n,n=i,t=s),s=0;t;)s=(n[--t]=n[t]+d[t]+s)/u|0,n[t]=u===n[t]?0:n[t]%u;return s&&(n=[s].concat(n),++o),U(e,n,o)},E.precision=E.sd=function(e,t){var i,r,s,a=this;if(null!=e&&e!==!!e)return v(e,1,p),null==t?t=P:v(t,0,8),$(new V(a),e,t);if(!(i=a.c))return null;if(r=14*(s=i.length-1)+1,s=i[s]){for(;s%10==0;s/=10,r--);for(s=i[0];s>=10;s/=10,r++);}return e&&a.e+1>r&&(r=a.e+1),r},E.shiftedBy=function(e){return v(e,-9007199254740991,9007199254740991),this.times("1e"+e)},E.squareRoot=E.sqrt=function(){var e,t,r,s,a,o=this,n=o.c,d=o.s,c=o.e,l=C+4,u=new V("0.5");if(1!==d||!n||!n[0])return new V(!d||d<0&&(!n||n[0])?NaN:n?o:1/0);if(0==(d=Math.sqrt(+W(o)))||d==1/0?(((t=f(n)).length+c)%2==0&&(t+="0"),d=Math.sqrt(+t),c=m((c+1)/2)-(c<0||c%2),r=new V(t=d==1/0?"5e"+c:(t=d.toExponential()).slice(0,t.indexOf("e")+1)+c)):r=new V(d+""),r.c[0])for((d=(c=r.e)+l)<3&&(d=0);;)if(a=r,r=u.times(a.plus(i(o,a,l,1))),f(a.c).slice(0,d)===(t=f(r.c)).slice(0,d)){if(r.e<c&&--d,"9999"!=(t=t.slice(d-3,d+1))&&(s||"4999"!=t)){+t&&(+t.slice(1)||"5"!=t.charAt(0))||($(r,r.e+C+2,1),e=!r.times(r).eq(o));break}if(!s&&($(a,a.e+C+2,0),a.times(a).eq(o))){r=a;break}l+=4,d+=4,s=1}return $(r,r.e+C+1,P,e)},E.toExponential=function(e,t){return null!=e&&(v(e,0,p),e++),j(this,e,t,1)},E.toFixed=function(e,t){return null!=e&&(v(e,0,p),e=e+this.e+1),j(this,e,t)},E.toFormat=function(e,t,i){var r,s=this;if(null==i)null!=e&&t&&"object"==typeof t?(i=t,t=null):e&&"object"==typeof e?(i=e,e=t=null):i=H;else if("object"!=typeof i)throw Error(c+"Argument not an object: "+i);if(r=s.toFixed(e,t),s.c){var a,o=r.split("."),n=+i.groupSize,d=+i.secondaryGroupSize,l=i.groupSeparator||"",u=o[0],h=o[1],p=s.s<0,m=p?u.slice(1):u,f=m.length;if(d&&(a=n,n=d,d=a,f-=a),n>0&&f>0){for(a=f%n||n,u=m.substr(0,a);a<f;a+=n)u+=l+m.substr(a,n);d>0&&(u+=l+m.slice(a)),p&&(u="-"+u)}r=h?u+(i.decimalSeparator||"")+((d=+i.fractionGroupSize)?h.replace(new RegExp("\\d{"+d+"}\\B","g"),"$&"+(i.fractionGroupSeparator||"")):h):u}return(i.prefix||"")+r+(i.suffix||"")},E.toFraction=function(e){var t,r,s,a,o,n,d,l,u,p,m,g,v=this,_=v.c;if(null!=e&&(!(d=new V(e)).isInteger()&&(d.c||1!==d.s)||d.lt(A)))throw Error(c+"Argument "+(d.isInteger()?"out of range: ":"not an integer: ")+W(d));if(!_)return new V(v);for(t=new V(A),u=r=new V(A),s=l=new V(A),g=f(_),o=t.e=g.length-v.e-1,t.c[0]=h[(n=o%14)<0?14+n:n],e=!e||d.comparedTo(t)>0?o>0?t:u:d,n=D,D=1/0,d=new V(g),l.c[0]=0;p=i(d,t,0,1),1!=(a=r.plus(p.times(s))).comparedTo(e);)r=s,s=a,u=l.plus(p.times(a=u)),l=a,t=d.minus(p.times(a=t)),d=a;return a=i(e.minus(r),s,0,1),l=l.plus(a.times(u)),r=r.plus(a.times(s)),l.s=u.s=v.s,m=i(u,s,o*=2,P).minus(v).abs().comparedTo(i(l,r,o,P).minus(v).abs())<1?[u,s]:[l,r],D=n,m},E.toNumber=function(){return+W(this)},E.toPrecision=function(e,t){return null!=e&&v(e,1,p),j(this,e,t,2)},E.toString=function(e){var t,i=this,s=i.s,a=i.e;return null===a?s?(t="Infinity",s<0&&(t="-"+t)):t="NaN":(null==e?t=a<=k||a>=O?S(f(i.c),a):y(f(i.c),a,"0"):10===e?t=y(f((i=$(new V(i),C+a+1,P)).c),i.e,"0"):(v(e,2,F.length,"Base"),t=r(y(f(i.c),a,"0"),10,e,s,!0)),s<0&&i.c[0]&&(t="-"+t)),t},E.valueOf=E.toJSON=function(){return W(this)},E._isBigNumber=!0,null!=t&&V.set(t),V}()).default=a.BigNumber=a,void 0===(r=function(){return a}.call(t,i,t,e))||(e.exports=r)}()},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.generateRandomNumber=t.clone=void 0,t.clone=function(e,t={}){return void 0===e?t:JSON.parse(JSON.stringify(e))},t.generateRandomNumber=function(){return Math.round(1e7*Math.random())}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.NeAudioNode=t.NeAudioNodeNullable=void 0;const r=i(66);let s=0;class a extends r.RTCEventEmitter{constructor(e,t){super(),this.id=s++,this.connectedTo=[],this.connectedFrom=[],this.tag=e,this.audioNode=t}connect(e){this.audioNode&&e.audioNode&&this.audioNode.connect(e.audioNode),-1===this.connectedTo.indexOf(e)&&this.connectedTo.push(e),-1===e.connectedFrom.indexOf(this)&&e.connectedFrom.push(this)}disconnect(e){this.audioNode&&e.audioNode&&this.audioNode.disconnect(e.audioNode),-1!==this.connectedTo.indexOf(e)&&this.connectedTo.splice(this.connectedTo.indexOf(e),1),-1===e.connectedFrom.indexOf(this)&&e.connectedFrom.splice(e.connectedFrom.indexOf(this),1)}isConnectedTo(e){return this.connectedTo.indexOf(e)>-1}isConnectedFrom(e){return this.connectedFrom.indexOf(e)>-1}disconnectFromAll(){this.connectedFrom.forEach(e=>{e.audioNode&&this.audioNode&&e.audioNode.disconnect(this.audioNode);const t=e.connectedTo.indexOf(this);t>-1&&e.connectedTo.splice(t,1)}),this.connectedFrom.length=0}disconnectToAll(){this.connectedTo.forEach(e=>{e.audioNode&&this.audioNode&&this.audioNode.disconnect(e.audioNode);const t=e.connectedFrom.indexOf(this);t>-1&&e.connectedFrom.splice(t,1)}),this.connectedTo.length=0}updateNode(e){this.connectedTo.forEach(t=>{t.audioNode&&(this.audioNode&&this.audioNode.disconnect(t.audioNode),e.connect(t.audioNode))}),this.connectedFrom.forEach(t=>{t.audioNode&&(this.audioNode&&t.audioNode.disconnect(this.audioNode),t.audioNode.connect(e))}),this.audioNode=e}}t.NeAudioNodeNullable=a;t.NeAudioNode=class extends a{constructor(e,t){super(e,t),this.tag=e,this.audioNode=t}}},function(e,t,i){var r=function(){return this}()||Function("return this")(),s=r.regeneratorRuntime&&Object.getOwnPropertyNames(r).indexOf("regeneratorRuntime")>=0,a=s&&r.regeneratorRuntime;if(r.regeneratorRuntime=void 0,e.exports=i(74),s)r.regeneratorRuntime=a;else try{delete r.regeneratorRuntime}catch(e){r.regeneratorRuntime=void 0}},function(e,t){!function(t){var i=Object.prototype,r=i.hasOwnProperty,s="function"==typeof Symbol?Symbol:{},a=s.iterator||"@@iterator",o=s.asyncIterator||"@@asyncIterator",n=s.toStringTag||"@@toStringTag",d="object"==typeof e,c=t.regeneratorRuntime;if(c)d&&(e.exports=c);else{(c=t.regeneratorRuntime=d?e.exports:{}).wrap=f;var l={},u={};u[a]=function(){return this};var h=Object.getPrototypeOf,p=h&&h(h(E([])));p&&p!==i&&r.call(p,a)&&(u=p);var m=S.prototype=v.prototype=Object.create(u);_.prototype=m.constructor=S,S.constructor=_,S[n]=_.displayName="GeneratorFunction",c.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===_||"GeneratorFunction"===(t.displayName||t.name))},c.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,S):(e.__proto__=S,n in e||(e[n]="GeneratorFunction")),e.prototype=Object.create(m),e},c.awrap=function(e){return{__await:e}},y(R.prototype),R.prototype[o]=function(){return this},c.AsyncIterator=R,c.async=function(e,t,i,r){var s=new R(f(e,t,i,r));return c.isGeneratorFunction(t)?s:s.next().then((function(e){return e.done?e.value:s.next()}))},y(m),m[n]="Generator",m[a]=function(){return this},m.toString=function(){return"[object Generator]"},c.keys=function(e){var t=[];for(var i in e)t.push(i);return t.reverse(),function i(){for(;t.length;){var r=t.pop();if(r in e)return i.value=r,i.done=!1,i}return i.done=!0,i}},c.values=E,I.prototype={constructor:I,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(w),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function i(i,r){return o.type="throw",o.arg=e,t.next=i,r&&(t.method="next",t.arg=void 0),!!r}for(var s=this.tryEntries.length-1;s>=0;--s){var a=this.tryEntries[s],o=a.completion;if("root"===a.tryLoc)return i("end");if(a.tryLoc<=this.prev){var n=r.call(a,"catchLoc"),d=r.call(a,"finallyLoc");if(n&&d){if(this.prev<a.catchLoc)return i(a.catchLoc,!0);if(this.prev<a.finallyLoc)return i(a.finallyLoc)}else if(n){if(this.prev<a.catchLoc)return i(a.catchLoc,!0)}else{if(!d)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return i(a.finallyLoc)}}}},abrupt:function(e,t){for(var i=this.tryEntries.length-1;i>=0;--i){var s=this.tryEntries[i];if(s.tryLoc<=this.prev&&r.call(s,"finallyLoc")&&this.prev<s.finallyLoc){var a=s;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var o=a?a.completion:{};return o.type=e,o.arg=t,a?(this.method="next",this.next=a.finallyLoc,l):this.complete(o)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var i=this.tryEntries[t];if(i.finallyLoc===e)return this.complete(i.completion,i.afterLoc),w(i),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var i=this.tryEntries[t];if(i.tryLoc===e){var r=i.completion;if("throw"===r.type){var s=r.arg;w(i)}return s}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,i){return this.delegate={iterator:E(e),resultName:t,nextLoc:i},"next"===this.method&&(this.arg=void 0),l}}}function f(e,t,i,r){var s=t&&t.prototype instanceof v?t:v,a=Object.create(s.prototype),o=new I(r||[]);return a._invoke=function(e,t,i){var r="suspendedStart";return function(s,a){if("executing"===r)throw new Error("Generator is already running");if("completed"===r){if("throw"===s)throw a;return A()}for(i.method=s,i.arg=a;;){var o=i.delegate;if(o){var n=b(o,i);if(n){if(n===l)continue;return n}}if("next"===i.method)i.sent=i._sent=i.arg;else if("throw"===i.method){if("suspendedStart"===r)throw r="completed",i.arg;i.dispatchException(i.arg)}else"return"===i.method&&i.abrupt("return",i.arg);r="executing";var d=g(e,t,i);if("normal"===d.type){if(r=i.done?"completed":"suspendedYield",d.arg===l)continue;return{value:d.arg,done:i.done}}"throw"===d.type&&(r="completed",i.method="throw",i.arg=d.arg)}}}(e,i,o),a}function g(e,t,i){try{return{type:"normal",arg:e.call(t,i)}}catch(e){return{type:"throw",arg:e}}}function v(){}function _(){}function S(){}function y(e){["next","throw","return"].forEach((function(t){e[t]=function(e){return this._invoke(t,e)}}))}function R(e){var t;this._invoke=function(i,s){function a(){return new Promise((function(t,a){!function t(i,s,a,o){var n=g(e[i],e,s);if("throw"!==n.type){var d=n.arg,c=d.value;return c&&"object"==typeof c&&r.call(c,"__await")?Promise.resolve(c.__await).then((function(e){t("next",e,a,o)}),(function(e){t("throw",e,a,o)})):Promise.resolve(c).then((function(e){d.value=e,a(d)}),o)}o(n.arg)}(i,s,t,a)}))}return t=t?t.then(a,a):a()}}function b(e,t){var i=e.iterator[t.method];if(void 0===i){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,b(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var r=g(i,e.iterator,t.arg);if("throw"===r.type)return t.method="throw",t.arg=r.arg,t.delegate=null,l;var s=r.arg;return s?s.done?(t[e.resultName]=s.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):s:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function T(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function w(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function I(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(T,this),this.reset(!0)}function E(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var i=-1,s=function t(){for(;++i<e.length;)if(r.call(e,i))return t.value=e[i],t.done=!1,t;return t.value=void 0,t.done=!0,t};return s.next=s}}return{next:A}}function A(){return{value:void 0,done:!0}}}(function(){return this}()||Function("return this")())},function(e,t,i){e.exports={default:i(76),__esModule:!0}},function(e,t,i){i(38),i(39),i(48),i(87),i(99),i(100),e.exports=i(3).Promise},function(e,t,i){var r=i(26),s=i(27);e.exports=function(e){return function(t,i){var a,o,n=String(s(t)),d=r(i),c=n.length;return d<0||d>=c?e?"":void 0:(a=n.charCodeAt(d))<55296||a>56319||d+1===c||(o=n.charCodeAt(d+1))<56320||o>57343?e?n.charAt(d):a:e?n.slice(d,d+2):o-56320+(a-55296<<10)+65536}}},function(e,t,i){var r=i(43),s=i(22),a=i(24),o={};i(6)(o,i(1)("iterator"),(function(){return this})),e.exports=function(e,t,i){e.prototype=r(o,{next:s(1,i)}),a(e,t+" Iterator")}},function(e,t,i){var r=i(7),s=i(4),a=i(30);e.exports=i(9)?Object.defineProperties:function(e,t){s(e);for(var i,o=a(t),n=o.length,d=0;n>d;)r.f(e,i=o[d++],t[i]);return e}},function(e,t,i){var r=i(18);e.exports=Object("z").propertyIsEnumerable(0)?Object:function(e){return"String"==r(e)?e.split(""):Object(e)}},function(e,t,i){var r=i(14),s=i(45),a=i(82);e.exports=function(e){return function(t,i,o){var n,d=r(t),c=s(d.length),l=a(o,c);if(e&&i!=i){for(;c>l;)if((n=d[l++])!=n)return!0}else for(;c>l;l++)if((e||l in d)&&d[l]===i)return e||l||0;return!e&&-1}}},function(e,t,i){var r=i(26),s=Math.max,a=Math.min;e.exports=function(e,t){return(e=r(e))<0?s(e+t,0):a(e,t)}},function(e,t,i){var r=i(10),s=i(47),a=i(31)("IE_PROTO"),o=Object.prototype;e.exports=Object.getPrototypeOf||function(e){return e=s(e),r(e,a)?e[a]:"function"==typeof e.constructor&&e instanceof e.constructor?e.constructor.prototype:e instanceof Object?o:null}},function(e,t,i){var r=i(85),s=i(86),a=i(17),o=i(14);e.exports=i(40)(Array,"Array",(function(e,t){this._t=o(e),this._i=0,this._k=t}),(function(){var e=this._t,t=this._k,i=this._i++;return!e||i>=e.length?(this._t=void 0,s(1)):s(0,"keys"==t?i:"values"==t?e[i]:[i,e[i]])}),"values"),a.Arguments=a.Array,r("keys"),r("values"),r("entries")},function(e,t){e.exports=function(){}},function(e,t){e.exports=function(e,t){return{value:t,done:!!e}}},function(e,t,i){var r,s,a,o,n=i(15),d=i(0),c=i(19),l=i(49),u=i(16),h=i(8),p=i(20),m=i(88),f=i(89),g=i(50),v=i(51).set,_=i(94)(),S=i(34),y=i(52),R=i(95),b=i(53),T=d.TypeError,w=d.process,I=w&&w.versions,E=I&&I.v8||"",A=d.Promise,C="process"==l(w),P=function(){},k=s=S.f,O=!!function(){try{var e=A.resolve(1),t=(e.constructor={})[i(1)("species")]=function(e){e(P,P)};return(C||"function"==typeof PromiseRejectionEvent)&&e.then(P)instanceof t&&0!==E.indexOf("6.6")&&-1===R.indexOf("Chrome/66")}catch(e){}}(),x=function(e){var t;return!(!h(e)||"function"!=typeof(t=e.then))&&t},D=function(e,t){if(!e._n){e._n=!0;var i=e._c;_((function(){for(var r=e._v,s=1==e._s,a=0,o=function(t){var i,a,o,n=s?t.ok:t.fail,d=t.resolve,c=t.reject,l=t.domain;try{n?(s||(2==e._h&&L(e),e._h=1),!0===n?i=r:(l&&l.enter(),i=n(r),l&&(l.exit(),o=!0)),i===t.promise?c(T("Promise-chain cycle")):(a=x(i))?a.call(i,d,c):d(i)):c(r)}catch(e){l&&!o&&l.exit(),c(e)}};i.length>a;)o(i[a++]);e._c=[],e._n=!1,t&&!e._h&&M(e)}))}},M=function(e){v.call(d,(function(){var t,i,r,s=e._v,a=N(e);if(a&&(t=y((function(){C?w.emit("unhandledRejection",s,e):(i=d.onunhandledrejection)?i({promise:e,reason:s}):(r=d.console)&&r.error&&r.error("Unhandled promise rejection",s)})),e._h=C||N(e)?2:1),e._a=void 0,a&&t.e)throw t.v}))},N=function(e){return 1!==e._h&&0===(e._a||e._c).length},L=function(e){v.call(d,(function(){var t;C?w.emit("rejectionHandled",e):(t=d.onrejectionhandled)&&t({promise:e,reason:e._v})}))},H=function(e){var t=this;t._d||(t._d=!0,(t=t._w||t)._v=e,t._s=2,t._a||(t._a=t._c.slice()),D(t,!0))},F=function(e){var t,i=this;if(!i._d){i._d=!0,i=i._w||i;try{if(i===e)throw T("Promise can't be resolved itself");(t=x(e))?_((function(){var r={_w:i,_d:!1};try{t.call(e,c(F,r,1),c(H,r,1))}catch(e){H.call(r,e)}})):(i._v=e,i._s=1,D(i,!1))}catch(e){H.call({_w:i,_d:!1},e)}}};O||(A=function(e){m(this,A,"Promise","_h"),p(e),r.call(this);try{e(c(F,this,1),c(H,this,1))}catch(e){H.call(this,e)}},(r=function(e){this._c=[],this._a=void 0,this._s=0,this._d=!1,this._v=void 0,this._h=0,this._n=!1}).prototype=i(96)(A.prototype,{then:function(e,t){var i=k(g(this,A));return i.ok="function"!=typeof e||e,i.fail="function"==typeof t&&t,i.domain=C?w.domain:void 0,this._c.push(i),this._a&&this._a.push(i),this._s&&D(this,!1),i.promise},catch:function(e){return this.then(void 0,e)}}),a=function(){var e=new r;this.promise=e,this.resolve=c(F,e,1),this.reject=c(H,e,1)},S.f=k=function(e){return e===A||e===o?new a(e):s(e)}),u(u.G+u.W+u.F*!O,{Promise:A}),i(24)(A,"Promise"),i(97)("Promise"),o=i(3).Promise,u(u.S+u.F*!O,"Promise",{reject:function(e){var t=k(this);return(0,t.reject)(e),t.promise}}),u(u.S+u.F*(n||!O),"Promise",{resolve:function(e){return b(n&&this===o?A:this,e)}}),u(u.S+u.F*!(O&&i(98)((function(e){A.all(e).catch(P)}))),"Promise",{all:function(e){var t=this,i=k(t),r=i.resolve,s=i.reject,a=y((function(){var i=[],a=0,o=1;f(e,!1,(function(e){var n=a++,d=!1;i.push(void 0),o++,t.resolve(e).then((function(e){d||(d=!0,i[n]=e,--o||r(i))}),s)})),--o||r(i)}));return a.e&&s(a.v),i.promise},race:function(e){var t=this,i=k(t),r=i.reject,s=y((function(){f(e,!1,(function(e){t.resolve(e).then(i.resolve,r)}))}));return s.e&&r(s.v),i.promise}})},function(e,t){e.exports=function(e,t,i,r){if(!(e instanceof t)||void 0!==r&&r in e)throw TypeError(i+": incorrect invocation!");return e}},function(e,t,i){var r=i(19),s=i(90),a=i(91),o=i(4),n=i(45),d=i(92),c={},l={};(t=e.exports=function(e,t,i,u,h){var p,m,f,g,v=h?function(){return e}:d(e),_=r(i,u,t?2:1),S=0;if("function"!=typeof v)throw TypeError(e+" is not iterable!");if(a(v)){for(p=n(e.length);p>S;S++)if((g=t?_(o(m=e[S])[0],m[1]):_(e[S]))===c||g===l)return g}else for(f=v.call(e);!(m=f.next()).done;)if((g=s(f,_,m.value,t))===c||g===l)return g}).BREAK=c,t.RETURN=l},function(e,t,i){var r=i(4);e.exports=function(e,t,i,s){try{return s?t(r(i)[0],i[1]):t(i)}catch(t){var a=e.return;throw void 0!==a&&r(a.call(e)),t}}},function(e,t,i){var r=i(17),s=i(1)("iterator"),a=Array.prototype;e.exports=function(e){return void 0!==e&&(r.Array===e||a[s]===e)}},function(e,t,i){var r=i(49),s=i(1)("iterator"),a=i(17);e.exports=i(3).getIteratorMethod=function(e){if(null!=e)return e[s]||e["@@iterator"]||a[r(e)]}},function(e,t){e.exports=function(e,t,i){var r=void 0===i;switch(t.length){case 0:return r?e():e.call(i);case 1:return r?e(t[0]):e.call(i,t[0]);case 2:return r?e(t[0],t[1]):e.call(i,t[0],t[1]);case 3:return r?e(t[0],t[1],t[2]):e.call(i,t[0],t[1],t[2]);case 4:return r?e(t[0],t[1],t[2],t[3]):e.call(i,t[0],t[1],t[2],t[3])}return e.apply(i,t)}},function(e,t,i){var r=i(0),s=i(51).set,a=r.MutationObserver||r.WebKitMutationObserver,o=r.process,n=r.Promise,d="process"==i(18)(o);e.exports=function(){var e,t,i,c=function(){var r,s;for(d&&(r=o.domain)&&r.exit();e;){s=e.fn,e=e.next;try{s()}catch(r){throw e?i():t=void 0,r}}t=void 0,r&&r.enter()};if(d)i=function(){o.nextTick(c)};else if(!a||r.navigator&&r.navigator.standalone)if(n&&n.resolve){var l=n.resolve(void 0);i=function(){l.then(c)}}else i=function(){s.call(r,c)};else{var u=!0,h=document.createTextNode("");new a(c).observe(h,{characterData:!0}),i=function(){h.data=u=!u}}return function(r){var s={fn:r,next:void 0};t&&(t.next=s),e||(e=s,i()),t=s}}},function(e,t,i){var r=i(0).navigator;e.exports=r&&r.userAgent||""},function(e,t,i){var r=i(6);e.exports=function(e,t,i){for(var s in t)i&&e[s]?e[s]=t[s]:r(e,s,t[s]);return e}},function(e,t,i){var r=i(0),s=i(3),a=i(7),o=i(9),n=i(1)("species");e.exports=function(e){var t="function"==typeof s[e]?s[e]:r[e];o&&t&&!t[n]&&a.f(t,n,{configurable:!0,get:function(){return this}})}},function(e,t,i){var r=i(1)("iterator"),s=!1;try{var a=[7][r]();a.return=function(){s=!0},Array.from(a,(function(){throw 2}))}catch(e){}e.exports=function(e,t){if(!t&&!s)return!1;var i=!1;try{var a=[7],o=a[r]();o.next=function(){return{done:i=!0}},a[r]=function(){return o},e(a)}catch(e){}return i}},function(e,t,i){var r=i(16),s=i(3),a=i(0),o=i(50),n=i(53);r(r.P+r.R,"Promise",{finally:function(e){var t=o(this,s.Promise||a.Promise),i="function"==typeof e;return this.then(i?function(i){return n(t,e()).then((function(){return i}))}:e,i?function(i){return n(t,e()).then((function(){throw i}))}:e)}})},function(e,t,i){var r=i(16),s=i(34),a=i(52);r(r.S,"Promise",{try:function(e){var t=s.f(this),i=a(e);return(i.e?t.reject:t.resolve)(i.v),t.promise}})},function(e,t,i){t.__esModule=!0;var r=o(i(102)),s=o(i(104)),a="function"==typeof s.default&&"symbol"==typeof r.default?function(e){return typeof e}:function(e){return e&&"function"==typeof s.default&&e.constructor===s.default&&e!==s.default.prototype?"symbol":typeof e};function o(e){return e&&e.__esModule?e:{default:e}}t.default="function"==typeof s.default&&"symbol"===a(r.default)?function(e){return void 0===e?"undefined":a(e)}:function(e){return e&&"function"==typeof s.default&&e.constructor===s.default&&e!==s.default.prototype?"symbol":void 0===e?"undefined":a(e)}},function(e,t,i){e.exports={default:i(103),__esModule:!0}},function(e,t,i){i(39),i(48),e.exports=i(35).f("iterator")},function(e,t,i){e.exports={default:i(105),__esModule:!0}},function(e,t,i){i(106),i(38),i(112),i(113),e.exports=i(3).Symbol},function(e,t,i){var r=i(0),s=i(10),a=i(9),o=i(16),n=i(42),d=i(107).KEY,c=i(21),l=i(32),u=i(24),h=i(23),p=i(1),m=i(35),f=i(36),g=i(108),v=i(109),_=i(4),S=i(8),y=i(47),R=i(14),b=i(29),T=i(22),w=i(43),I=i(110),E=i(111),A=i(54),C=i(7),P=i(30),k=E.f,O=C.f,x=I.f,D=r.Symbol,M=r.JSON,N=M&&M.stringify,L=p("_hidden"),H=p("toPrimitive"),F={}.propertyIsEnumerable,V=l("symbol-registry"),j=l("symbols"),B=l("op-symbols"),U=Object.prototype,$="function"==typeof D&&!!A.f,W=r.QObject,Z=!W||!W.prototype||!W.prototype.findChild,q=a&&c((function(){return 7!=w(O({},"a",{get:function(){return O(this,"a",{value:7}).a}})).a}))?function(e,t,i){var r=k(U,t);r&&delete U[t],O(e,t,i),r&&e!==U&&O(U,t,r)}:O,G=function(e){var t=j[e]=w(D.prototype);return t._k=e,t},z=$&&"symbol"==typeof D.iterator?function(e){return"symbol"==typeof e}:function(e){return e instanceof D},J=function(e,t,i){return e===U&&J(B,t,i),_(e),t=b(t,!0),_(i),s(j,t)?(i.enumerable?(s(e,L)&&e[L][t]&&(e[L][t]=!1),i=w(i,{enumerable:T(0,!1)})):(s(e,L)||O(e,L,T(1,{})),e[L][t]=!0),q(e,t,i)):O(e,t,i)},Y=function(e,t){_(e);for(var i,r=g(t=R(t)),s=0,a=r.length;a>s;)J(e,i=r[s++],t[i]);return e},Q=function(e){var t=F.call(this,e=b(e,!0));return!(this===U&&s(j,e)&&!s(B,e))&&(!(t||!s(this,e)||!s(j,e)||s(this,L)&&this[L][e])||t)},X=function(e,t){if(e=R(e),t=b(t,!0),e!==U||!s(j,t)||s(B,t)){var i=k(e,t);return!i||!s(j,t)||s(e,L)&&e[L][t]||(i.enumerable=!0),i}},K=function(e){for(var t,i=x(R(e)),r=[],a=0;i.length>a;)s(j,t=i[a++])||t==L||t==d||r.push(t);return r},ee=function(e){for(var t,i=e===U,r=x(i?B:R(e)),a=[],o=0;r.length>o;)!s(j,t=r[o++])||i&&!s(U,t)||a.push(j[t]);return a};$||(n((D=function(){if(this instanceof D)throw TypeError("Symbol is not a constructor!");var e=h(arguments.length>0?arguments[0]:void 0),t=function(i){this===U&&t.call(B,i),s(this,L)&&s(this[L],e)&&(this[L][e]=!1),q(this,e,T(1,i))};return a&&Z&&q(U,e,{configurable:!0,set:t}),G(e)}).prototype,"toString",(function(){return this._k})),E.f=X,C.f=J,i(55).f=I.f=K,i(37).f=Q,A.f=ee,a&&!i(15)&&n(U,"propertyIsEnumerable",Q,!0),m.f=function(e){return G(p(e))}),o(o.G+o.W+o.F*!$,{Symbol:D});for(var te="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),ie=0;te.length>ie;)p(te[ie++]);for(var re=P(p.store),se=0;re.length>se;)f(re[se++]);o(o.S+o.F*!$,"Symbol",{for:function(e){return s(V,e+="")?V[e]:V[e]=D(e)},keyFor:function(e){if(!z(e))throw TypeError(e+" is not a symbol!");for(var t in V)if(V[t]===e)return t},useSetter:function(){Z=!0},useSimple:function(){Z=!1}}),o(o.S+o.F*!$,"Object",{create:function(e,t){return void 0===t?w(e):Y(w(e),t)},defineProperty:J,defineProperties:Y,getOwnPropertyDescriptor:X,getOwnPropertyNames:K,getOwnPropertySymbols:ee});var ae=c((function(){A.f(1)}));o(o.S+o.F*ae,"Object",{getOwnPropertySymbols:function(e){return A.f(y(e))}}),M&&o(o.S+o.F*(!$||c((function(){var e=D();return"[null]"!=N([e])||"{}"!=N({a:e})||"{}"!=N(Object(e))}))),"JSON",{stringify:function(e){for(var t,i,r=[e],s=1;arguments.length>s;)r.push(arguments[s++]);if(i=t=r[1],(S(t)||void 0!==e)&&!z(e))return v(t)||(t=function(e,t){if("function"==typeof i&&(t=i.call(this,e,t)),!z(t))return t}),r[1]=t,N.apply(M,r)}}),D.prototype[H]||i(6)(D.prototype,H,D.prototype.valueOf),u(D,"Symbol"),u(Math,"Math",!0),u(r.JSON,"JSON",!0)},function(e,t,i){var r=i(23)("meta"),s=i(8),a=i(10),o=i(7).f,n=0,d=Object.isExtensible||function(){return!0},c=!i(21)((function(){return d(Object.preventExtensions({}))})),l=function(e){o(e,r,{value:{i:"O"+ ++n,w:{}}})},u=e.exports={KEY:r,NEED:!1,fastKey:function(e,t){if(!s(e))return"symbol"==typeof e?e:("string"==typeof e?"S":"P")+e;if(!a(e,r)){if(!d(e))return"F";if(!t)return"E";l(e)}return e[r].i},getWeak:function(e,t){if(!a(e,r)){if(!d(e))return!0;if(!t)return!1;l(e)}return e[r].w},onFreeze:function(e){return c&&u.NEED&&d(e)&&!a(e,r)&&l(e),e}}},function(e,t,i){var r=i(30),s=i(54),a=i(37);e.exports=function(e){var t=r(e),i=s.f;if(i)for(var o,n=i(e),d=a.f,c=0;n.length>c;)d.call(e,o=n[c++])&&t.push(o);return t}},function(e,t,i){var r=i(18);e.exports=Array.isArray||function(e){return"Array"==r(e)}},function(e,t,i){var r=i(14),s=i(55).f,a={}.toString,o="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];e.exports.f=function(e){return o&&"[object Window]"==a.call(e)?function(e){try{return s(e)}catch(e){return o.slice()}}(e):s(r(e))}},function(e,t,i){var r=i(37),s=i(22),a=i(14),o=i(29),n=i(10),d=i(41),c=Object.getOwnPropertyDescriptor;t.f=i(9)?c:function(e,t){if(e=a(e),t=o(t,!0),d)try{return c(e,t)}catch(e){}if(n(e,t))return s(!r.f.call(e,t),e[t])}},function(e,t,i){i(36)("asyncIterator")},function(e,t,i){i(36)("observable")},function(e,t,i){function r(e){return e>0&&0==(e&e-1)}function s(e,t,i){fetch(e+"?rdn="+Date.now()).then(e=>e.arrayBuffer()).then(r=>{let s=!1;const a=new Blob([r],{type:"image/*"}),o=new Image;new URL(e,window.location.href).origin!==window.location.origin&&(o.crossOrigin="anonymous"),o.onload=()=>{s||(s=!0,null==t||t(o))},o.onerror=e=>{null==i||i(e)},o.src=URL.createObjectURL(a),setTimeout(()=>{!s&&o.complete&&o.naturalHeight>0&&(s=!0,null==t||t(o))},0)}).catch(e=>{null==i||i(e)})}function a(e,t=3,i,r){let a=null;const o=(n=0)=>{(n+=1)<=t?s(e,e=>{null==i||i(e)},e=>{a=e,o(n)}):null==r||r(a)};o()}Object.defineProperty(t,"__esModule",{value:!0}),t.loadImageBatch=t.retryLoadImage=t.loadImage=t.createTexture=t.imgDataSize=t.toNthPower=t.isNthPower=void 0,t.isNthPower=r,t.toNthPower=function(e){if(r(e))return e;const t=[4096,2048,1024,512,256,128,64,32,16,8,4,2,1];let i=1/0;for(let r=0;r<t.length;r++){const s=t[r],a=Math.abs(e-s);if(e>=s)return a>i?t[r-1]:s;i=a}return 1},t.imgDataSize=function(e,t,i){if(i=null!=i?i:Math.min(t)){const i=Math.max(e,t);if(i>512){const r=i/512;return{width:e/r>>0,height:t/r>>0}}}return{width:e,height:t}},t.createTexture=function e(t,i,r){const s=t.createTexture();if(!s)return console.error(`texture:[${i}] created error.`),null;const a=Object.assign({flipY:!0,wrapS:"clamp",wrapT:"clamp",genMipMaps:!1},r),o={clamp:t.CLAMP_TO_EDGE,repeat:t.REPEAT,mirror:t.MIRRORED_REPEAT},n={glTexture:s,source:i,refresh(){const{source:e,glTexture:i,opts:r}=n,{genMipMaps:s}=r,a=t.TEXTURE_2D;t.bindTexture(a,i);const{flipY:d}=r;d?t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!0):t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.texParameteri(a,t.TEXTURE_WRAP_S,o[r.wrapS]),t.texParameteri(a,t.TEXTURE_WRAP_T,o[r.wrapT]),t.texParameteri(a,t.TEXTURE_MIN_FILTER,s?t.LINEAR_MIPMAP_LINEAR:t.LINEAR),t.texParameteri(a,t.TEXTURE_MAG_FILTER,t.LINEAR),"width"in r&&"height"in r?t.texImage2D(a,0,t.RGBA,r.width,r.height,0,t.RGBA,t.UNSIGNED_BYTE,e):null!==e&&t.texImage2D(a,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),s&&t.generateMipmap(a)},updateMipMap(){const{glTexture:e,opts:i}=n,{genMipMaps:r}=i;if(!r)return;const s=t.TEXTURE_2D;t.bindTexture(s,e),t.generateMipmap(s)},clone:()=>e(t,n.source,n.opts),opts:a};return n.refresh(),n},t.loadImage=s,t.retryLoadImage=a,t.loadImageBatch=function(e,t=3,i){let r={},s=[];const o=()=>{Object.keys(r).length+s.length===e.length&&(null==i||i(r,s))};e.forEach(e=>{a(e,t,t=>{r[e]=t,o()},()=>{s.push(e),o()})})}},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Device=t.alerter=void 0;const n=o(i(11)),d=o(i(12)),c=i(66),l=i(116),u=i(144);Object.defineProperty(t,"alerter",{enumerable:!0,get:function(){return u.alerter}});const h=i(146),p=i(5),m=a(i(2));class f extends c.RTCEventEmitter{constructor(){super(),this.deviceChangeDetectionTimer=null,this.deviceInited=!1,this.hasPerm={audioIn:!1,video:!1,audioOut:!1},this.deviceHistory={audioIn:[],video:[],audioOut:[]},this.compatAudioInputList=h.compatAudioInputList,this.onUserGestureNeeded=null,this.logger=new l.Logger({tagGen:()=>`Device m${this.deviceHistory.audioIn.length}c${this.deviceHistory.video.length}s${this.deviceHistory.audioOut.length}`}),this.handleDeviceChange=this.detectDeviceChange.bind(this),this.onUserGestureNeeded=this.defaultHandleUserGestureNeeded.bind(this),u.alerter.addListener("@user-gesture-fired",()=>{this.safeEmit("user-gesture-fired")})}async getDevices(e){if(!navigator.mediaDevices){this.logger.error("navigator.mediaDevices is "+navigator.mediaDevices);let e="getDevices: mediaDevices is not support in your browser",t="getDevices: 当前浏览器不支持 mediaDevices",i="The latest version of the Chrome browser is recommended",r="建议使用最新版的 Chrome 浏览器",s=m.IS_ZH?t:e,a=m.IS_ZH?r:i;throw new d.default({code:n.default.NOT_SUPPORT_ERROR,message:s,advice:a,url:"https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/enumerateDevices"})}if(!navigator.mediaDevices.enumerateDevices){this.logger.error("navigator.mediaDevices is "+navigator.mediaDevices.enumerateDevices);let e="getDevices: enumerateDevices is not support in your browser",t="getDevices: 当前浏览器不支持 enumerateDevices",i="The latest version of the Chrome browser is recommended",r="建议使用最新版的 Chrome 浏览器",s=m.IS_ZH?t:e,a=m.IS_ZH?r:i;throw new d.default({code:n.default.NOT_SUPPORT_ERROR,message:s,advice:a,url:"https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/enumerateDevices"})}let t={video:[],audioIn:[],audioOut:[]},i=await navigator.mediaDevices.enumerateDevices(),r=null;if(e.requestPerm){const t=i.find(t=>e.audioinput&&"audioinput"==t.kind&&!t.label),s=i.find(t=>e.videoinput&&"videoinput"==t.kind&&!t.label);if(t||s)try{r=await navigator.mediaDevices.getUserMedia({audio:t,video:s})}catch(e){this.logger.error(e.name,e.message,e.stack)}}return i=await navigator.mediaDevices.enumerateDevices(),i.forEach((function(i){if(e.videoinput&&"videoinput"===i.kind){let r={deviceId:i.deviceId,label:i.label||(e.noFillLabel?i.label:"camera "+(t.video.length+1))};e.groupId&&(r.groupId=i.groupId),t.video.push(r)}else if(e.audioinput&&"audioinput"===i.kind){let r;r={deviceId:i.deviceId,label:i.label||(e.noFillLabel?i.label:"microphone "+(t.audioIn.length+1))},e.groupId&&(r.groupId=i.groupId),t.audioIn.push(r)}else if(e.audiooutput&&"audiooutput"===i.kind){let r={deviceId:i.deviceId,label:i.label||(e.noFillLabel?i.label:"speaker "+(t.audioOut.length+1))};e.groupId&&(r.groupId=i.groupId),t.audioOut.push(r)}r&&r.getTracks().forEach(e=>{e.stop()})})),t}async getCameras(e){const t=await this.getDevices({videoinput:!0,requestPerm:e});return t?t.video:[]}async getMicrophones(e){const t=await this.getDevices({audioinput:!0,requestPerm:e});return t?t.audioIn:[]}async getSpeakers(e){const t=await this.getDevices({audioinput:!0,audiooutput:!0,requestPerm:e});return t?t.audioOut:[]}async detectDeviceChange(){let e={audioIn:{added:[],changed:[],removed:[]},video:{added:[],changed:[],removed:[]},audioOut:{added:[],changed:[],removed:[]}};const t=await this.getDevices({audioinput:!0,audiooutput:!0,videoinput:!0,requestPerm:!1,groupId:!0,noFillLabel:!0});["audioIn","video","audioOut"].forEach(i=>{if(this.deviceInited){const r=t[i].find(e=>e.deviceId&&e.label);r?this.hasPerm[i]?(t[i].forEach(t=>{const r=this.deviceHistory[i].find(e=>e.deviceId===t.deviceId||""===e.deviceId&&"default"===t.deviceId);if(r){if(r.label!==t.label||r.groupId!==t.groupId){let s=`检测到设备改变：${i}: deviceId ${t.deviceId}`;r.label!==t.label?s+=`【Label ${r.label} => ${t.label}】`:s+=" Label "+t.label,r.groupId!==t.groupId&&(s+="【groupId changed】"),this.logger.log(s),e[i].changed.push(t)}}else this.logger.log(`检测到设备新增：${i}: deviceId ${t.deviceId} 【${t.label}】`),e[i].added.push(t)}),this.deviceHistory[i].forEach(r=>{t[i].find(e=>r.deviceId===e.deviceId||""===r.deviceId&&"default"===e.deviceId)||(this.logger.log(`检测到设备拔出：${i}: deviceId ${r.deviceId} 【${r.label}】`),e[i].removed.push(r))}),this.deviceHistory[i]=t[i],e[i].added.forEach(e=>{"audioIn"===i?this.emit("recording-device-changed",{device:e,state:"ACTIVE"}):"video"===i?this.emit("camera-changed",{device:e,state:"ACTIVE"}):"audioOut"===i&&this.emit("playout-device-changed",{device:e,state:"ACTIVE"})}),e[i].changed.forEach(e=>{"audioIn"===i?this.emit("recording-device-changed",{device:e,state:"CHANGED"}):"video"===i?this.emit("camera-changed",{device:e,state:"CHANGED"}):"audioOut"===i&&this.emit("playout-device-changed",{device:e,state:"CHANGED"})}),e[i].removed.forEach(e=>{"audioIn"===i?this.emit("recording-device-changed",{device:e,state:"INACTIVE"}):"video"===i?this.emit("camera-changed",{device:e,state:"INACTIVE"}):"audioOut"===i&&this.emit("playout-device-changed",{device:e,state:"INACTIVE"})})):(this.hasPerm[i]=!0,this.deviceHistory[i]=t[i],"audioIn"===i?(this.logger.log(`麦克风设备：${r.deviceId}【${r.label}】`),this.emit("recording-device-init")):"video"===i?(this.logger.log(`摄像头设备：【${t[i].map(e=>e.label).join("】【")}】`),this.emit("camera-init")):"audioOut"===i&&(this.logger.log(`扬声器设备：${r.deviceId}【${r.label}】`),this.emit("playout-device-init"))):this.deviceHistory[i]=t[i]}else this.deviceHistory[i]=t[i]}),this.deviceInited||(this.deviceInited=!0,t.audioIn.length||this.logger.error("未侦测到可用麦克风"),t.video.length||this.logger.error("未侦测到可用摄像头"))}async startDeviceChangeDetection(){navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices?(this.deviceChangeDetectionTimer&&clearInterval(this.deviceChangeDetectionTimer),await this.handleDeviceChange(),navigator.mediaDevices.ondevicechange?navigator.mediaDevices.ondevicechange===this.handleDeviceChange||(p.getParameters().forceListenDeviceChange?navigator.mediaDevices.ondevicechange=this.handleDeviceChange:this.logger.warn("系统设备枚举回调已被占用，设备枚举实效性将受到影响")):navigator.mediaDevices.ondevicechange=this.handleDeviceChange,this.deviceChangeDetectionTimer=setInterval(this.handleDeviceChange,1e3)):this.logger.warn("当前环境不支持设备枚举")}stopDeviceChangeDetection(){this.logger.log("停止监听浏览器设备变化"),this.deviceChangeDetectionTimer&&(clearInterval(this.deviceChangeDetectionTimer),this.deviceChangeDetectionTimer=null),navigator.mediaDevices&&navigator.mediaDevices.ondevicechange&&(navigator.mediaDevices.ondevicechange=null),this.deviceInited=!1,this.deviceHistory.audioIn=[],this.deviceHistory.audioOut=[],this.deviceHistory.video=[],this.hasPerm.audioIn=!1,this.hasPerm.video=!1,this.hasPerm.audioOut=!1}enableCompatMode(){this.logger.log("开启兼容模式"),h.compatAudioInputList.enabled=!0,this.handleDeviceChange()}disableCompatMode(){this.logger.log("关闭兼容模式。"),h.compatAudioInputList.enabled=!1,this.handleDeviceChange()}defaultHandleUserGestureNeeded(e){const t=`由于浏览器限制，该操作需手势触发。<br/>${e.name}<br/>${e.message}<br/>点击此处以继续`;u.alerter.alert(t),this.logger.warn('为避免看到这个消息，您应该实现 Device.onUserGestureNeeded 方法，引导用户作出手势，并触发 Device.on("user-gesture-fired")事件。')}clean(){}}const g=new f;t.Device=g},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.Logger=t.updateLogIndex=void 0;const r=i(5),s=i(117),a=i(208),o=i(67),n=i(61);let d=0,c=[];function l(){return d++,(""+d).padStart(4,"0")}t.updateLogIndex=l;class u{constructor(e){this.style="color:#1cb977;",this.options=e,this.api="log",this.tagGen=e.tagGen,e.isSavedLogs&&(this.logHelper=new a.logHelper(e)),this.supportedBrowsers=["Chrome","Safari","Firefox","Chrome Mobile","Electron"],this.cs=console}getChild(e){const t=Object.assign({},this.options),i=new u(t);return i.tagGen=e,i.parent=this,i}debug(){this.logHelper&&this.logHelper.log(arguments);var e=this.formatArgs("DEBUG",[].slice.call(arguments,0));r.getParameters().logLevel<=s.loglevels.DEBUG&&this._log("debug",e),p(e)}log(){this.logHelper&&this.logHelper.log(arguments);var e=this.formatArgs("LOG",[].slice.call(arguments,0));if(-1!==this.supportedBrowsers.indexOf(o.getBrowserInfo().browserName)&&"string"==typeof e[0]){e[0]="%c"+e[0],e.splice(1,0,this.style);for(let t=2;t<e.length&&"string"==typeof e[t];t++)e[0]+="%c"+e[t],e[t]=""}r.getParameters().logLevel<=s.loglevels.INFO&&this._log("log",e),p(e)}info(){this.logHelper&&this.logHelper.log(arguments);var e=this.formatArgs("INFO",[].slice.call(arguments,0));-1!==this.supportedBrowsers.indexOf(o.getBrowserInfo().browserName)&&"string"==typeof e[0]&&(e[0]="%c"+e[0],e.splice(1,0,this.style)),r.getParameters().logLevel<=s.loglevels.INFO&&this._log("info",e),p(e)}warn(){this.logHelper&&this.logHelper.log(arguments);var e=this.formatArgs("WARN",[].slice.call(arguments,0));-1!==this.supportedBrowsers.indexOf(o.getBrowserInfo().browserName)&&"string"==typeof e[0]&&(e[0]="%c"+e[0],e.splice(1,0,this.style)),r.getParameters().logLevel<=s.loglevels.WARNING&&this._log("warn",e),p(e)}error(){this.logHelper&&this.logHelper.log(arguments);var e=this.formatArgs("ERROR",[].slice.call(arguments,0));-1!==this.supportedBrowsers.indexOf(o.getBrowserInfo().browserName)&&"string"==typeof e[0]&&(e[0]="%c"+e[0],e.splice(1,0,this.style)),r.getParameters().logLevel<=s.loglevels.ERROR&&this._log("error",e),p(e)}_log(e,t){let i=this.options.logFunc,r=null;if(i&&(i[e]&&(r=i[e]),"function"==typeof r))r.apply(i,t);else if(this.cs[e])try{this.cs[e].apply?this.chrome(e,t):this.ie(e,t)}catch(e){}}chrome(e,t){o.getBrowserInfo().browserName;this.cs[e]?this.cs[e].apply(this.cs,t):this.cs.log?this.cs.log.apply(this.cs,t):this.ie(e,t)}ie(e,t){var i=this;t.forEach((function(t){i.cs[e](JSON.stringify(t,null,4))}))}formatArgs(e,t){var i=new Date,r=h(""+(i.getMonth()+1))+"-"+h(""+i.getDate())+" "+h(""+i.getHours())+":"+h(""+i.getMinutes())+":"+h(""+i.getSeconds())+":"+h(""+i.getMilliseconds(),3);let s=this,a="";for(let e=0;e<3&&(s.tagGen&&(a=`[${s.tagGen()}]`+a),s.parent);e++)s=s.parent;return a=`[NERTC:${e}:${l()} ${r}]${a}`,t.splice(0,0,a),t.forEach((function(e,i){e=n.formatSingleArg(e),t[i]="object"==typeof e?function e(t,i=[]){if(!(t=n.formatSingleArg(t))||"object"!=typeof t)return t;let r={};for(let s in t)t.hasOwnProperty&&!t.hasOwnProperty(s)||(t[s]&&"object"==typeof t[s]?-1!==i.indexOf(t[s])?r[s]="[Circular obj]":(i.push(t[s]),r[s]=e(t[s],i)):r[s]=t[s]);return r}(e):e})),t}}t.Logger=u;var h=function(e,t){t=t||2;for(var i=""+e;i.length<t;)i="0"+i;return i};function p(e){let t=window;if(t.logUpload)if(t.wsTransport)c.length&&(c.forEach(e=>{t.wsTransport&&t.wsTransport.sendLog(e.args)}),c=[]),t.wsTransport&&t.wsTransport.sendLog(e);else{let t=Date.now();try{c.length&&c[c.length-1].args[0].replace("[NERTC","[缓存][NERTC")}catch(e){}c.push({time:t,args:e})}}},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.loglevelMap=t.loglevels=void 0;const o=a(i(207)),n=i(5);let d=window;!function(e){e[e.DEBUG=0]="DEBUG",e[e.INFO=1]="INFO",e[e.WARNING=2]="WARNING",e[e.ERROR=3]="ERROR",e[e.NONE=4]="NONE"}(t.loglevels||(t.loglevels={})),t.loglevelMap={0:"DEBUG",1:"INFO",2:"WARNING",3:"ERROR",4:"NONE"};const c={setLogLevel(e){n.getParameters().logLevel!==e&&(o.info(`NERTC LogLevel was changed: ${t.loglevelMap[n.getParameters().logLevel]} => ${t.loglevelMap[e]}`),n.getParameters().logLevel=e)},enableLogUpload(){d.logUpload=!0},disableLogUpload(){d.logUpload=!1}};c.disableLogUpload(),o.setLevel("INFO"),t.default=c},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.getStream=t.getScreenStream=t.emptyStreamWith=t.watchTrack=void 0;const r=i(173),s=i(146),a=i(115),o=i(5),n=i(62),d=i(240),c=i(241),l=new(i(116).Logger)({tagGen:()=>"GUM"});t.getStream=async function(e,t){if(e.audio){if(!e.audio.deviceId){const i=a.Device.deviceHistory.audioIn.find(e=>"default"===e.deviceId);i&&(t.log("getStream：音频使用默认设备"+i.label),e.audio.deviceId={exact:i.deviceId})}s.compatAudioInputList.enabled&&(t.log("兼容模式：constraint强制将channelCount设为2，echoCancellation设为false"),e.audio.channelCount=2,e.audio.echoCancellation=!1)}t.log("getLocalStream constraint:",JSON.stringify(e));try{const i=await navigator.mediaDevices.getUserMedia(e);t.log("获取到媒体流: ",i.id);const a=i.getTracks();for(let e=0;e<a.length;e++){const l=a[e];if(m(l),"video"===l.kind){if(d.canShimCanvas()){t.warn("使用canvas track取代videoTrack",l.label);const e=d.shimCanvas(l);m(e),i.removeTrack(l),i.addTrack(e)}}else if("audio"===l.kind&&s.compatAudioInputList.enabled){const e=l.getSettings?l.getSettings():{};e.channelCount&&e.channelCount>=2?t.log("该设备支持兼容模式："+l.label,e):t.warn("该设备为单声道设备，强行开启兼容模式(右声道无声)："+l.label,e);const a=n.getAudioContext();if(a){const e=a.createChannelSplitter(2),n=a.createMediaStreamDestination(),d=new MediaStream([l]),u=a.createMediaStreamSource(d),h=new r.AudioLevel({stream:d,logger:t,sourceNode:u});let p=0;"left"===o.getParameters().audioInputcompatMode?(t.log("兼容模式：仅使用左声道"),p=0):"right"===o.getParameters().audioInputcompatMode?(t.log("兼容模式：仅使用右声道"),p=1):"auto"===o.getParameters().audioInputcompatMode&&(t.log("兼容模式：在左右声道间根据音量切换"),h.on("channel-state-change",i=>{"leftLoud"===i.state&&1===p?(t.log("兼容模式切换至左声道：",l.label),e.disconnect(n),e.connect(n,0),p=0):"rightLoud"===i.state&&0===p&&(t.log("兼容模式切换至右声道：",l.label),e.disconnect(n),e.connect(n,1),p=1)})),u.connect(e),e.connect(n,p);const f=n.stream.getTracks()[0];m(f),s.compatAudioInputList.compatTracks.push({source:l,dest:f}),c.syncTrackState(l,f,"bidirectional"),i.removeTrack(l),i.addTrack(f),t.log("getStream：启用兼容模式成功")}}}return i}catch(e){return t.error("getUserMedia error: ",e.name),Promise.reject(e)}},t.getScreenStream=async function(e,t){var i;let r;t.log("getScreenStream constraint:",JSON.stringify(e,null," ")),navigator.getDisplayMedia||navigator.mediaDevices.getDisplayMedia;try{r=await navigator.mediaDevices.getDisplayMedia(e)}catch(s){if(!((null===(i=null==s?void 0:s.message)||void 0===i?void 0:i.indexOf("user gesture"))>-1&&a.Device.onUserGestureNeeded))throw t.error("屏幕共享获取失败: ",s.name,s.message),s;t.warn("荧幕共享获取中断，需要手势触发。"),a.Device.onUserGestureNeeded(s);try{r=await new Promise((t,i)=>{a.Device.once("user-gesture-fired",()=>{navigator.mediaDevices.getDisplayMedia(e).then(t).catch(i)})})}catch(e){throw t.error("第二次屏幕共享获取失败: ",e.name,e.message),e}}return(e=>{t.log("获取到屏幕共享流: ",e.id);e.getTracks().forEach(e=>{m(e),"video"===e.kind&&o.getParameters().screenFocus&&(e.focus?(t.log("屏幕共享不跳转到被共享页面"),e.focus("no-focus-change")):t.log("当前浏览器不支持屏幕共享跳转控制"))}),Promise.resolve(e)})(r),r};let u=Date.now();let h=0;const p=()=>{const e=o.getParameters().tracks.video,t=o.getParameters().tracks.audio,i=Date.now();if(i-u>5e3&&h<o.getParameters().maxEventLoopLagWarning){let e=`侦测到主线程事件循环从卡死中恢复。卡顿时间：${i-u-1e3}毫秒。`;e+="这可能是由于页面切往后台、设备休眠、频繁的dom操作、阻塞性代码引起的。",e+=`当前页面页面是否隐藏：${document.hidden}，可见性：${document.visibilityState}，网络状态：${navigator.onLine}。`,h+=1,h===o.getParameters().maxEventLoopLagWarning&&(e+="今后不再提示。"),l.warn(e)}u=i,e.forEach((e,t)=>{if(e&&!e.endedAt&&"ended"===e.readyState){l.log(`VIDEOTRACK#${t} 已停止：【${e.label}】`),e.endedAt=i;const r=new CustomEvent("neTrackEnded");e.dispatchEvent(r)}}),t.forEach((e,t)=>{if(e&&!e.endedAt&&"ended"===e.readyState){l.log(`AUDIOTRACK#${t} 已停止：【${e.label}】`),e.endedAt=i;const r=new CustomEvent("neTrackEnded");e.dispatchEvent(r)}})};function m(e){if(e)if("ended"===e.readyState&&l.error("注意：输入的track已经停止：",e),"audio"===e.kind){const t=o.getParameters().tracks.audio;l.log("获取到的设备类型: AUDIOTRACK#"+t.length,e.kind,e.label,e.id,JSON.stringify(e.getSettings()));const i=t.findIndex(t=>e===t);i>-1?(l.warn(`注意：AUDIOTRACK#${t.length} 与 AUDIOTRACK#${i} 相同`),t.push(null)):(e.addEventListener("ended",p),t.push(e))}else{const t=o.getParameters().tracks.video;l.log("获取到的设备类型: VIDEOTRACK#"+t.length,e.kind,e.label,e.id,JSON.stringify(e.getSettings()));const i=t.findIndex(t=>e===t);i>-1?(l.warn(`注意：AUDIOTRACK#${t.length} 与 VIDEOTRACK#${i} 相同`),t.push(null)):(e.addEventListener("ended",p),t.push(e))}}setInterval(p,1e3),t.watchTrack=m,t.emptyStreamWith=function(e,t){let i=!1;e.getTracks().forEach(r=>{r!==t?(e.removeTrack(r),e.onremovetrack&&e.onremovetrack({track:r})):i=!0}),!i&&t&&(e.addTrack(t),e.onaddtrack&&e.onaddtrack({track:t}))}},function(e,t,i){e.exports=a,a.className="ReflectionObject";var r,s=i(25);function a(e,t){if(!s.isString(e))throw TypeError("name must be a string");if(t&&!s.isObject(t))throw TypeError("options must be an object");this.options=t,this.parsedOptions=null,this.name=e,this.parent=null,this.resolved=!1,this.comment=null,this.filename=null}Object.defineProperties(a.prototype,{root:{get:function(){for(var e=this;null!==e.parent;)e=e.parent;return e}},fullName:{get:function(){for(var e=[this.name],t=this.parent;t;)e.unshift(t.name),t=t.parent;return e.join(".")}}}),a.prototype.toJSON=function(){throw Error()},a.prototype.onAdd=function(e){this.parent&&this.parent!==e&&this.parent.remove(this),this.parent=e,this.resolved=!1;var t=e.root;t instanceof r&&t._handleAdd(this)},a.prototype.onRemove=function(e){var t=e.root;t instanceof r&&t._handleRemove(this),this.parent=null,this.resolved=!1},a.prototype.resolve=function(){return this.resolved||this.root instanceof r&&(this.resolved=!0),this},a.prototype.getOption=function(e){if(this.options)return this.options[e]},a.prototype.setOption=function(e,t,i){return i&&this.options&&void 0!==this.options[e]||((this.options||(this.options={}))[e]=t),this},a.prototype.setParsedOption=function(e,t,i){this.parsedOptions||(this.parsedOptions=[]);var r=this.parsedOptions;if(i){var a=r.find((function(t){return Object.prototype.hasOwnProperty.call(t,e)}));if(a){var o=a[e];s.setProperty(o,i,t)}else(a={})[e]=s.setProperty({},i,t),r.push(a)}else{var n={};n[e]=t,r.push(n)}return this},a.prototype.setOptions=function(e,t){if(e)for(var i=Object.keys(e),r=0;r<i.length;++r)this.setOption(i[r],e[i[r]],t);return this},a.prototype.toString=function(){var e=this.constructor.className,t=this.fullName;return t.length?e+" "+t:e},a._configure=function(e){r=e}},function(e,t,i){e.exports=c;var r=i(119);((c.prototype=Object.create(r.prototype)).constructor=c).className="Field";var s,a=i(58),o=i(127),n=i(25),d=/^required|optional|repeated$/;function c(e,t,i,s,a,c,l){if(n.isObject(s)?(l=a,c=s,s=a=void 0):n.isObject(a)&&(l=c,c=a,a=void 0),r.call(this,e,c),!n.isInteger(t)||t<0)throw TypeError("id must be a non-negative integer");if(!n.isString(i))throw TypeError("type must be a string");if(void 0!==s&&!d.test(s=s.toString().toLowerCase()))throw TypeError("rule must be a string rule");if(void 0!==a&&!n.isString(a))throw TypeError("extend must be a string");"proto3_optional"===s&&(s="optional"),this.rule=s&&"optional"!==s?s:void 0,this.type=i,this.id=t,this.extend=a||void 0,this.required="required"===s,this.optional=!this.required,this.repeated="repeated"===s,this.map=!1,this.message=null,this.partOf=null,this.typeDefault=null,this.defaultValue=null,this.long=!!n.Long&&void 0!==o.long[i],this.bytes="bytes"===i,this.resolvedType=null,this.extensionField=null,this.declaringField=null,this._packed=null,this.comment=l}c.fromJSON=function(e,t){return new c(e,t.id,t.type,t.rule,t.extend,t.options,t.comment)},Object.defineProperty(c.prototype,"packed",{get:function(){return null===this._packed&&(this._packed=!1!==this.getOption("packed")),this._packed}}),c.prototype.setOption=function(e,t,i){return"packed"===e&&(this._packed=null),r.prototype.setOption.call(this,e,t,i)},c.prototype.toJSON=function(e){var t=!!e&&Boolean(e.keepComments);return n.toObject(["rule","optional"!==this.rule&&this.rule||void 0,"type",this.type,"id",this.id,"extend",this.extend,"options",this.options,"comment",t?this.comment:void 0])},c.prototype.resolve=function(){if(this.resolved)return this;if(void 0===(this.typeDefault=o.defaults[this.type])&&(this.resolvedType=(this.declaringField?this.declaringField.parent:this.parent).lookupTypeOrEnum(this.type),this.resolvedType instanceof s?this.typeDefault=null:this.typeDefault=this.resolvedType.values[Object.keys(this.resolvedType.values)[0]]),this.options&&null!=this.options.default&&(this.typeDefault=this.options.default,this.resolvedType instanceof a&&"string"==typeof this.typeDefault&&(this.typeDefault=this.resolvedType.values[this.typeDefault])),this.options&&(!0!==this.options.packed&&(void 0===this.options.packed||!this.resolvedType||this.resolvedType instanceof a)||delete this.options.packed,Object.keys(this.options).length||(this.options=void 0)),this.long)this.typeDefault=n.Long.fromNumber(this.typeDefault,"u"===this.type.charAt(0)),Object.freeze&&Object.freeze(this.typeDefault);else if(this.bytes&&"string"==typeof this.typeDefault){var e;n.base64.test(this.typeDefault)?n.base64.decode(this.typeDefault,e=n.newBuffer(n.base64.length(this.typeDefault)),0):n.utf8.write(this.typeDefault,e=n.newBuffer(n.utf8.length(this.typeDefault)),0),this.typeDefault=e}return this.map?this.defaultValue=n.emptyObject:this.repeated?this.defaultValue=n.emptyArray:this.defaultValue=this.typeDefault,this.parent instanceof s&&(this.parent.ctor.prototype[this.name]=this.defaultValue),r.prototype.resolve.call(this)},c.d=function(e,t,i,r){return"function"==typeof t?t=n.decorateType(t).name:t&&"object"==typeof t&&(t=n.decorateEnum(t).name),function(s,a){n.decorateType(s.constructor).add(new c(a,e,t,i,{default:r}))}},c._configure=function(e){s=e}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.EnhancedEventEmitter=void 0;const r=i(166),s=i(56),a="EnhancedEventEmitter";class o extends r.EventEmitter{constructor(){super(),this.setMaxListeners(1/0)}safeEmit(e,...t){const i=this.listenerCount(e);try{return this.emit(e,...t)}catch(t){return s.Logger.error(a,"safeEmit() | event listener threw an error [event:%s]:%o",e,t),Boolean(i)}}async safeEmitAsPromise(e,...t){return new Promise((i,r)=>{try{this.emit(e,...t,i,r)}catch(t){s.Logger.error(a,"safeEmitAsPromise() | event listener threw an error [event:%s]:%o",e,t),r(t)}})}}t.EnhancedEventEmitter=o},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.InvalidStateError=t.UnsupportedError=void 0;class r extends Error{constructor(e){super(e),this.name="UnsupportedError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,r):this.stack=new Error(e).stack}}t.UnsupportedError=r;class s extends Error{constructor(e){super(e),this.name="InvalidStateError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,s):this.stack=new Error(e).stack}}t.InvalidStateError=s},function(e,t,i){var r=i(219),s=i(220);t.write=s,t.parse=r.parse,t.parseParams=r.parseParams,t.parseFmtpConfig=r.parseFmtpConfig,t.parsePayloads=r.parsePayloads,t.parseRemoteCandidates=r.parseRemoteCandidates,t.parseImageAttributes=r.parseImageAttributes,t.parseSimulcastStreamList=r.parseSimulcastStreamList},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.canReceive=t.canSend=t.generateProbatorRtpParameters=t.reduceCodecs=t.getSendingRemoteRtpParameters=t.getSendingRtpParameters=t.getRecvRtpCapabilities=t.getExtendedRtpCapabilities=t.validateSctpStreamParameters=t.validateSctpParameters=t.validateNumSctpStreams=t.validateSctpCapabilities=t.validateRtcpParameters=t.validateRtpEncodingParameters=t.validateRtpHeaderExtensionParameters=t.validateRtpCodecParameters=t.validateRtpParameters=t.validateRtpHeaderExtension=t.validateRtcpFeedback=t.validateRtpCodecCapability=t.validateRtpCapabilities=void 0;const o=a(i(221)),n=a(i(71));function d(e){const t=new RegExp("^(audio|video)/(.+)","i");if("object"!=typeof e)throw new TypeError("codec is not an object");if(!e.mimeType||"string"!=typeof e.mimeType)throw new TypeError("missing codec.mimeType");const i=t.exec(e.mimeType);if(!i)throw new TypeError("invalid codec.mimeType");if(e.kind=i[1].toLowerCase(),e.preferredPayloadType&&"number"!=typeof e.preferredPayloadType)throw new TypeError("invalid codec.preferredPayloadType");if("number"!=typeof e.clockRate)throw new TypeError("missing codec.clockRate");"audio"===e.kind?"number"!=typeof e.channels&&(e.channels=1):delete e.channels,e.parameters&&"object"==typeof e.parameters||(e.parameters={});for(const t of Object.keys(e.parameters)){let i=e.parameters[t];if(void 0===i&&(e.parameters[t]="",i=""),"string"!=typeof i&&"number"!=typeof i)throw new TypeError(`invalid codec parameter [key:${t}s, value:${i}]`);if("apt"===t&&"number"!=typeof i)throw new TypeError("invalid codec apt parameter")}e.rtcpFeedback&&Array.isArray(e.rtcpFeedback)||(e.rtcpFeedback=[]);for(const t of e.rtcpFeedback)c(t)}function c(e){if("object"!=typeof e)throw new TypeError("fb is not an object");if(!e.type||"string"!=typeof e.type)throw new TypeError("missing fb.type");e.parameter&&"string"==typeof e.parameter||(e.parameter="")}function l(e){if("object"!=typeof e)throw new TypeError("ext is not an object");if(e.kind&&"string"==typeof e.kind||(e.kind=""),""!==e.kind&&"audio"!==e.kind&&"video"!==e.kind)throw new TypeError("invalid ext.kind");if(!e.uri||"string"!=typeof e.uri)throw new TypeError("missing ext.uri");if("number"!=typeof e.preferredId)throw new TypeError("missing ext.preferredId");if(e.preferredEncrypt&&"boolean"!=typeof e.preferredEncrypt)throw new TypeError("invalid ext.preferredEncrypt");if(e.preferredEncrypt||(e.preferredEncrypt=!1),e.direction&&"string"!=typeof e.direction)throw new TypeError("invalid ext.direction");e.direction||(e.direction="sendrecv")}function u(e){if("object"!=typeof e)throw new TypeError("params is not an object");if(e.mid&&"string"!=typeof e.mid)throw new TypeError("params.mid is not a string");if(!Array.isArray(e.codecs))throw new TypeError("missing params.codecs");for(const t of e.codecs)h(t);if(e.headerExtensions&&!Array.isArray(e.headerExtensions))throw new TypeError("params.headerExtensions is not an array");e.headerExtensions||(e.headerExtensions=[]);for(const t of e.headerExtensions)p(t);if(e.encodings&&!Array.isArray(e.encodings))throw new TypeError("params.encodings is not an array");e.encodings||(e.encodings=[]);for(const t of e.encodings)m(t);if(e.rtcp&&"object"!=typeof e.rtcp)throw new TypeError("params.rtcp is not an object");e.rtcp||(e.rtcp={}),f(e.rtcp)}function h(e){const t=new RegExp("^(audio|video)/(.+)","i");if("object"!=typeof e)throw new TypeError("codec is not an object");if(!e.mimeType||"string"!=typeof e.mimeType)throw new TypeError("missing codec.mimeType");const i=t.exec(e.mimeType);if(!i)throw new TypeError("invalid codec.mimeType");if("number"!=typeof e.payloadType)throw new TypeError("missing codec.payloadType");if("number"!=typeof e.clockRate)throw new TypeError("missing codec.clockRate");"audio"===i[1].toLowerCase()?"number"!=typeof e.channels&&(e.channels=1):delete e.channels,e.parameters&&"object"==typeof e.parameters||(e.parameters={});for(const t of Object.keys(e.parameters)){let i=e.parameters[t];if(void 0===i&&(e.parameters[t]="",i=""),"string"!=typeof i&&"number"!=typeof i)throw new TypeError(`invalid codec parameter [key:${t}s, value:${i}]`);if("apt"===t&&"number"!=typeof i)throw new TypeError("invalid codec apt parameter")}e.rtcpFeedback&&Array.isArray(e.rtcpFeedback)||(e.rtcpFeedback=[]);for(const t of e.rtcpFeedback)c(t)}function p(e){if("object"!=typeof e)throw new TypeError("ext is not an object");if(!e.uri||"string"!=typeof e.uri)throw new TypeError("missing ext.uri");if("number"!=typeof e.id)throw new TypeError("missing ext.id");if(e.encrypt&&"boolean"!=typeof e.encrypt)throw new TypeError("invalid ext.encrypt");e.encrypt||(e.encrypt=!1),e.parameters&&"object"==typeof e.parameters||(e.parameters={});for(const t of Object.keys(e.parameters)){let i=e.parameters[t];if(void 0===i&&(e.parameters[t]="",i=""),"string"!=typeof i&&"number"!=typeof i)throw new TypeError("invalid header extension parameter")}}function m(e){if("object"!=typeof e)throw new TypeError("encoding is not an object");if(e.ssrc&&"number"!=typeof e.ssrc)throw new TypeError("invalid encoding.ssrc");if(e.rid&&"string"!=typeof e.rid)throw new TypeError("invalid encoding.rid");if(e.rtx&&"object"!=typeof e.rtx)throw new TypeError("invalid encoding.rtx");if(e.rtx&&"number"!=typeof e.rtx.ssrc)throw new TypeError("missing encoding.rtx.ssrc");if(e.dtx&&"boolean"==typeof e.dtx||(e.dtx=!1),e.scalabilityMode&&"string"!=typeof e.scalabilityMode)throw new TypeError("invalid encoding.scalabilityMode")}function f(e){if("object"!=typeof e)throw new TypeError("rtcp is not an object");if(e.cname&&"string"!=typeof e.cname)throw new TypeError("invalid rtcp.cname");e.reducedSize&&"boolean"==typeof e.reducedSize||(e.reducedSize=!0)}function g(e){if("object"!=typeof e)throw new TypeError("numStreams is not an object");if("number"!=typeof e.OS)throw new TypeError("missing numStreams.OS");if("number"!=typeof e.MIS)throw new TypeError("missing numStreams.MIS")}function v(e){return!!e&&/.+\/rtx$/i.test(e.mimeType)}function _(e,t,{strict:i=!1,modify:r=!1}={}){const s=e.mimeType.toLowerCase();if(s!==t.mimeType.toLowerCase())return!1;if(e.clockRate!==t.clockRate)return!1;if(e.channels!==t.channels)return!1;switch(s){case"video/h264":if((e.parameters["packetization-mode"]||0)!==(t.parameters["packetization-mode"]||0))return!1;if(i){if(!o.isSameProfile(e.parameters,t.parameters))return!1;let i;try{i=o.generateProfileLevelIdForAnswer(e.parameters,t.parameters)}catch(e){return!1}r&&(i?e.parameters["profile-level-id"]=i:delete e.parameters["profile-level-id"])}break;case"video/vp9":if(i){if((e.parameters["profile-id"]||0)!==(t.parameters["profile-id"]||0))return!1}}return!0}function S(e,t){return(!e.kind||!t.kind||e.kind===t.kind)&&e.uri===t.uri}function y(e,t){const i=[];for(const r of e.rtcpFeedback||[]){const e=(t.rtcpFeedback||[]).find(e=>e.type===r.type&&(e.parameter===r.parameter||!e.parameter&&!r.parameter));e&&i.push(e)}return i}t.validateRtpCapabilities=function(e){if("object"!=typeof e)throw new TypeError("caps is not an object");if(e.codecs&&!Array.isArray(e.codecs))throw new TypeError("caps.codecs is not an array");e.codecs||(e.codecs=[]);for(const t of e.codecs)d(t);if(e.headerExtensions&&!Array.isArray(e.headerExtensions))throw new TypeError("caps.headerExtensions is not an array");e.headerExtensions||(e.headerExtensions=[]);for(const t of e.headerExtensions)l(t)},t.validateRtpCodecCapability=d,t.validateRtcpFeedback=c,t.validateRtpHeaderExtension=l,t.validateRtpParameters=u,t.validateRtpCodecParameters=h,t.validateRtpHeaderExtensionParameters=p,t.validateRtpEncodingParameters=m,t.validateRtcpParameters=f,t.validateSctpCapabilities=function(e){if("object"!=typeof e)throw new TypeError("caps is not an object");if(!e.numStreams||"object"!=typeof e.numStreams)throw new TypeError("missing caps.numStreams");g(e.numStreams)},t.validateNumSctpStreams=g,t.validateSctpParameters=function(e){if("object"!=typeof e)throw new TypeError("params is not an object");if("number"!=typeof e.port)throw new TypeError("missing params.port");if("number"!=typeof e.OS)throw new TypeError("missing params.OS");if("number"!=typeof e.MIS)throw new TypeError("missing params.MIS");if("number"!=typeof e.maxMessageSize)throw new TypeError("missing params.maxMessageSize")},t.validateSctpStreamParameters=function(e){if("object"!=typeof e)throw new TypeError("params is not an object");if("number"!=typeof e.streamId)throw new TypeError("missing params.streamId");let t=!1;if("boolean"==typeof e.ordered?t=!0:e.ordered=!0,e.maxPacketLifeTime&&"number"!=typeof e.maxPacketLifeTime)throw new TypeError("invalid params.maxPacketLifeTime");if(e.maxRetransmits&&"number"!=typeof e.maxRetransmits)throw new TypeError("invalid params.maxRetransmits");if(e.maxPacketLifeTime&&e.maxRetransmits)throw new TypeError("cannot provide both maxPacketLifeTime and maxRetransmits");if(t&&e.ordered&&(e.maxPacketLifeTime||e.maxRetransmits))throw new TypeError("cannot be ordered with maxPacketLifeTime or maxRetransmits");if(t||!e.maxPacketLifeTime&&!e.maxRetransmits||(e.ordered=!1),e.label&&"string"!=typeof e.label)throw new TypeError("invalid params.label");if(e.protocol&&"string"!=typeof e.protocol)throw new TypeError("invalid params.protocol")},t.getExtendedRtpCapabilities=function(e,t){const i={codecs:[],headerExtensions:[]};for(const r of t.codecs||[]){if(v(r))continue;const t=(e.codecs||[]).find(e=>_(e,r,{strict:!0,modify:!0}));if(!t)continue;const s={mimeType:t.mimeType,kind:t.kind,clockRate:t.clockRate,channels:t.channels,localPayloadType:t.preferredPayloadType,localRtxPayloadType:void 0,remotePayloadType:r.preferredPayloadType,remoteRtxPayloadType:void 0,localParameters:t.parameters,remoteParameters:r.parameters,rtcpFeedback:y(t,r)};i.codecs.push(s)}for(const r of i.codecs){const i=e.codecs.find(e=>v(e)&&e.parameters.apt===r.localPayloadType),s=t.codecs.find(e=>v(e)&&e.parameters.apt===r.remotePayloadType);i&&s&&(r.localRtxPayloadType=i.preferredPayloadType,r.remoteRtxPayloadType=s.preferredPayloadType)}for(const r of t.headerExtensions){const t=e.headerExtensions.find(e=>S(e,r));if(!t)continue;const s={kind:r.kind,uri:r.uri,sendId:t.preferredId,recvId:r.preferredId,encrypt:t.preferredEncrypt,direction:"sendrecv"};switch(r.direction){case"sendrecv":s.direction="sendrecv";break;case"recvonly":s.direction="sendonly";break;case"sendonly":s.direction="recvonly";break;case"inactive":s.direction="inactive"}i.headerExtensions.push(s)}return i},t.getRecvRtpCapabilities=function(e){const t={codecs:[],headerExtensions:[]};for(const i of e.codecs){const e={mimeType:i.mimeType,kind:i.kind,preferredPayloadType:i.localPayloadType,clockRate:i.clockRate,channels:i.channels,parameters:i.localParameters,rtcpFeedback:i.rtcpFeedback};if(t.codecs.push(e),!i.localRtxPayloadType)continue;const r={mimeType:i.kind+"/rtx",kind:i.kind,preferredPayloadType:i.localRtxPayloadType,clockRate:i.clockRate,parameters:{apt:i.localPayloadType},rtcpFeedback:[]};t.codecs.push(r)}for(const i of e.headerExtensions){if("sendrecv"!==i.direction&&"recvonly"!==i.direction)continue;const e={kind:i.kind,uri:i.uri,preferredId:i.sendId,preferredEncrypt:i.encrypt,direction:i.direction};t.headerExtensions.push(e)}return t},t.getSendingRtpParameters=function(e,t){const i={mid:void 0,codecs:[],headerExtensions:[],encodings:[],rtcp:{}};for(const r of t.codecs){if(r.kind!==e)continue;const t={mimeType:r.mimeType,payloadType:r.localPayloadType,clockRate:r.clockRate,channels:r.channels,parameters:r.localParameters,rtcpFeedback:r.rtcpFeedback};if(i.codecs.push(t),r.localRtxPayloadType){const e={mimeType:r.kind+"/rtx",payloadType:r.localRtxPayloadType,clockRate:r.clockRate,parameters:{apt:r.localPayloadType},rtcpFeedback:[]};i.codecs.push(e)}}for(const r of t.headerExtensions){if(r.kind&&r.kind!==e||"sendrecv"!==r.direction&&"sendonly"!==r.direction)continue;const t={uri:r.uri,id:r.sendId,encrypt:r.encrypt,parameters:{}};i.headerExtensions.push(t)}return i},t.getSendingRemoteRtpParameters=function(e,t){const i={mid:void 0,codecs:[],headerExtensions:[],encodings:[],rtcp:{}};for(const r of t.codecs){if(r.kind!==e)continue;const t={mimeType:r.mimeType,payloadType:r.localPayloadType,clockRate:r.clockRate,channels:r.channels,parameters:r.remoteParameters,rtcpFeedback:r.rtcpFeedback};if(i.codecs.push(t),r.localRtxPayloadType){const e={mimeType:r.kind+"/rtx",payloadType:r.localRtxPayloadType,clockRate:r.clockRate,parameters:{apt:r.localPayloadType},rtcpFeedback:[]};i.codecs.push(e)}}for(const r of t.headerExtensions){if(r.kind&&r.kind!==e||"sendrecv"!==r.direction&&"sendonly"!==r.direction)continue;const t={uri:r.uri,id:r.sendId,encrypt:r.encrypt,parameters:{}};i.headerExtensions.push(t)}if(i.headerExtensions.some(e=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===e.uri))for(const e of i.codecs)e.rtcpFeedback=(e.rtcpFeedback||[]).filter(e=>"goog-remb"!==e.type);else if(i.headerExtensions.some(e=>"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"===e.uri))for(const e of i.codecs)e.rtcpFeedback=(e.rtcpFeedback||[]).filter(e=>"transport-cc"!==e.type);else for(const e of i.codecs)e.rtcpFeedback=(e.rtcpFeedback||[]).filter(e=>"transport-cc"!==e.type&&"goog-remb"!==e.type);return i},t.reduceCodecs=function(e,t){const i=[];if(t){for(let r=0;r<e.length;++r)if(_(e[r],t)){i.push(e[r]),v(e[r+1])&&i.push(e[r+1]);break}if(0===i.length)throw new TypeError("no matching codec found")}else i.push(e[0]),v(e[1])&&i.push(e[1]);return i},t.generateProbatorRtpParameters=function(e,t){u(e=n.clone(e,{}));const i={mid:"probator",codecs:[],headerExtensions:[],encodings:[{ssrc:t}],rtcp:{cname:"probator"}};return i.codecs.push(e.codecs[0]),i.codecs[0].payloadType=127,i.headerExtensions=e.headerExtensions,i},t.canSend=function(e,t){return t.codecs.some(t=>t.kind===e)},t.canReceive=function(e,t){if(u(e),0===e.codecs.length)return!1;for(let i in e.codecs)if("video/rtx"!==e.codecs[i].mimeType)for(let r in t.codecs)if(t.codecs[r].localPayloadType===e.codecs[i].payloadType)return!0;return!1}},function(e,t,i){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.getBlobUrl=void 0;const s=r(i(235)),a=r(i(236)),o=r(i(237)),n=r(i(238)),d=r(i(239)),c={volumeProcessor:{blobParts:[a.default],options:{type:"text/javascript; charset=utf-8"},url:""},audioWorkletAgentProcessor:{blobParts:[d.default],options:{type:"text/javascript; charset=utf-8"},url:""},webWorkerTimer:{blobParts:[o.default],options:{type:"text/javascript; charset=utf-8"},url:""},audioAIProcessor:{blobParts:[n.default],options:{type:"text/javascript; charset=utf-8"},url:""},rtcTimer:{blobParts:[s.default],options:{type:"text/js-worker"},url:""}};t.getBlobUrl=function(e){if(!c[e].url){const t=new Blob(c[e].blobParts,c[e].options);c[e].url=window.URL.createObjectURL(t)}return c[e].url}},function(e,t,i){e.exports=u;var r=i(119);((u.prototype=Object.create(r.prototype)).constructor=u).className="Namespace";var s,a,o,n=i(120),d=i(141),c=i(25);function l(e,t){if(e&&e.length){for(var i={},r=0;r<e.length;++r)i[e[r].name]=e[r].toJSON(t);return i}}function u(e,t){r.call(this,e,t),this.nested=void 0,this._nestedArray=null}function h(e){return e._nestedArray=null,e}u.fromJSON=function(e,t){return new u(e,t.options).addJSON(t.nested)},u.arrayToJSON=l,u.isReservedId=function(e,t){if(e)for(var i=0;i<e.length;++i)if("string"!=typeof e[i]&&e[i][0]<=t&&e[i][1]>t)return!0;return!1},u.isReservedName=function(e,t){if(e)for(var i=0;i<e.length;++i)if(e[i]===t)return!0;return!1},Object.defineProperty(u.prototype,"nestedArray",{get:function(){return this._nestedArray||(this._nestedArray=c.toArray(this.nested))}}),u.prototype.toJSON=function(e){return c.toObject(["options",this.options,"nested",l(this.nestedArray,e)])},u.prototype.addJSON=function(e){if(e)for(var t,i=Object.keys(e),r=0;r<i.length;++r)t=e[i[r]],this.add((void 0!==t.fields?s.fromJSON:void 0!==t.values?o.fromJSON:void 0!==t.methods?a.fromJSON:void 0!==t.id?n.fromJSON:u.fromJSON)(i[r],t));return this},u.prototype.get=function(e){return this.nested&&this.nested[e]||null},u.prototype.getEnum=function(e){if(this.nested&&this.nested[e]instanceof o)return this.nested[e].values;throw Error("no such enum: "+e)},u.prototype.add=function(e){if(!(e instanceof n&&void 0!==e.extend||e instanceof s||e instanceof o||e instanceof a||e instanceof u||e instanceof d))throw TypeError("object must be a valid nested object");if(this.nested){var t=this.get(e.name);if(t){if(!(t instanceof u&&e instanceof u)||t instanceof s||t instanceof a)throw Error("duplicate name '"+e.name+"' in "+this);for(var i=t.nestedArray,r=0;r<i.length;++r)e.add(i[r]);this.remove(t),this.nested||(this.nested={}),e.setOptions(t.options,!0)}}else this.nested={};return this.nested[e.name]=e,e.onAdd(this),h(this)},u.prototype.remove=function(e){if(!(e instanceof r))throw TypeError("object must be a ReflectionObject");if(e.parent!==this)throw Error(e+" is not a member of "+this);return delete this.nested[e.name],Object.keys(this.nested).length||(this.nested=void 0),e.onRemove(this),h(this)},u.prototype.define=function(e,t){if(c.isString(e))e=e.split(".");else if(!Array.isArray(e))throw TypeError("illegal path");if(e&&e.length&&""===e[0])throw Error("path must be relative");for(var i=this;e.length>0;){var r=e.shift();if(i.nested&&i.nested[r]){if(!((i=i.nested[r])instanceof u))throw Error("path conflicts with non-namespace objects")}else i.add(i=new u(r))}return t&&i.addJSON(t),i},u.prototype.resolveAll=function(){for(var e=this.nestedArray,t=0;t<e.length;)e[t]instanceof u?e[t++].resolveAll():e[t++].resolve();return this.resolve()},u.prototype.lookup=function(e,t,i){if("boolean"==typeof t?(i=t,t=void 0):t&&!Array.isArray(t)&&(t=[t]),c.isString(e)&&e.length){if("."===e)return this.root;e=e.split(".")}else if(!e.length)return this;if(""===e[0])return this.root.lookup(e.slice(1),t);var r=this.get(e[0]);if(r){if(1===e.length){if(!t||t.indexOf(r.constructor)>-1)return r}else if(r instanceof u&&(r=r.lookup(e.slice(1),t,!0)))return r}else for(var s=0;s<this.nestedArray.length;++s)if(this._nestedArray[s]instanceof u&&(r=this._nestedArray[s].lookup(e,t,!0)))return r;return null===this.parent||i?null:this.parent.lookup(e,t)},u.prototype.lookupType=function(e){var t=this.lookup(e,[s]);if(!t)throw Error("no such type: "+e);return t},u.prototype.lookupEnum=function(e){var t=this.lookup(e,[o]);if(!t)throw Error("no such Enum '"+e+"' in "+this);return t},u.prototype.lookupTypeOrEnum=function(e){var t=this.lookup(e,[s,o]);if(!t)throw Error("no such Type or Enum '"+e+"' in "+this);return t},u.prototype.lookupService=function(e){var t=this.lookup(e,[a]);if(!t)throw Error("no such Service '"+e+"' in "+this);return t},u._configure=function(e,t,i){s=e,a=t,o=i}},function(e,t,i){var r=t,s=i(25),a=["double","float","int32","uint32","sint32","fixed32","sfixed32","int64","uint64","sint64","fixed64","sfixed64","bool","string","bytes"];function o(e,t){var i=0,r={};for(t|=0;i<e.length;)r[a[i+t]]=e[i++];return r}r.basic=o([1,5,0,0,0,5,5,0,0,0,1,1,0,2,2]),r.defaults=o([0,0,0,0,0,0,0,0,0,0,0,0,!1,"",s.emptyArray,null]),r.long=o([0,0,0,1,1],7),r.mapKey=o([0,0,0,5,5,0,0,0,1,1,0,2],2),r.packed=o([1,5,0,0,0,5,5,0,0,0,1,1,0])},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.createFrameBuffer=void 0;const r=i(114);t.createFrameBuffer=function(e,t,i,s){const a=e.createFramebuffer();if(!a)return console.error("framebuffer created error."),null;const o=r.createTexture(e,null,{width:t,height:i,genMipMaps:null!=s&&s});return o?(e.bindFramebuffer(e.FRAMEBUFFER,a),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,o.glTexture,0),e.bindFramebuffer(e.FRAMEBUFFER,null),{framebuffer:a,targetTexture:o,bind:t=>{t?e.bindFramebuffer(e.FRAMEBUFFER,null):e.bindFramebuffer(e.FRAMEBUFFER,a)}}):null}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.Program=void 0;const r=i(300),s=i(158),a=i(301),o=i(302);t.Program=class{constructor(e,t){this.shaders={},this.uniforms={},this.attributes={},this.indices=null,this.gl=e,this.draw=t,this._program=e.createProgram(),this.setShader(r.defaultShader.vShader,"VERTEX"),this.setShader(r.defaultShader.fShader,"FRAGMENT")}get program(){return this._program||console.error("program create error."),this._program}parseUniforms(){const e=o.parseUniforms(this.gl,this.program);for(const t in e)t in this.uniforms&&e[t].setter(this.uniforms[t].value);this.uniforms=e}parseAttributes(){const e=this.gl,t=s.parseAttributes(this.gl,this.program);for(const i in this.attributes){const r=this.attributes[i];if(i in t){const e=r.attributeBuffer;e&&t[i].bufferSetter(e)}else e.deleteBuffer(r.buffer)}this.attributes=t}get count(){const e=this.attributes;let t=-1;for(const i in e){const r=e[i];-1!==t&&t!==r.count&&console.warn("inconsistent attribute length."),t=Math.max(t,r.count)}return t}setShader(e,t){const i=this.gl,s=this.program,o=a.createShader(i,e,t);if(o){const e=this.shaders[t];e&&(i.detachShader(s,e),i.deleteShader(e)),i.attachShader(s,o),this.shaders[t]=o,this.shaders.VERTEX&&this.shaders.FRAGMENT&&(i.linkProgram(s),this.parseUniforms(),this.parseAttributes())}else"VERTEX"===t?this.setShader(r.defaultShader.vShader,"VERTEX"):this.setShader(r.defaultShader.fShader,"FRAGMENT")}getUniform(e){var t;const i=null!==(t=this.uniforms[e])&&void 0!==t?t:null;return i||console.warn(`uniform:[${e}] does not exist.`),i}setUniform(e,t){var i;null===(i=this.getUniform(e))||void 0===i||i.setter(t)}updateUniform(e,t){var i;const r=this.getUniform(e);null==r||r.setter(null!==(i=t(r.value))&&void 0!==i?i:r.value)}setAttributeBuffer(e){var t;e&&(null===(t=this.getAttribute(e.name))||void 0===t||t.bufferSetter(e))}getAttribute(e){return this.attributes[e]||console.warn(`attribute:[${e}] does not exist.`),this.attributes[e]}setAttribute(e,t){var i;null===(i=this.getAttribute(e))||void 0===i||i.setter(t)}updateAttribute(e,t){var i;const r=this.getAttribute(e);null==r||r.setter(null!==(i=t(r.typedArray))&&void 0!==i?i:r.typedArray)}setIndices(e){if(e&&"indices"===e.name){const t=this.gl;t.bindBuffer(e.target,e.buffer),t.bufferData(e.target,e.typedArray,e.usage)}this.indices=e}render(){const e=this.gl,t=this.program;e.useProgram(t);const i=this.uniforms;for(const e in i)i[e].setter();const r=this.attributes;for(const e in r){r[e].setter()}this.indices&&e.bindBuffer(this.indices.target,this.indices.buffer),this.draw?this.draw():e.drawArrays(e.TRIANGLE_STRIP,0,this.count)}destroy(e=!0){var t,i;const r=this.gl;if(e){for(const e in this.attributes){const t=this.attributes[e];if(t){const i=r.getAttribLocation(this.program,e);r.disableVertexAttribArray(i),r.deleteBuffer(t.buffer)}}this.indices&&r.deleteBuffer(this.indices.buffer)}r.deleteShader(null!==(t=this.shaders.VERTEX)&&void 0!==t?t:null),r.deleteShader(null!==(i=this.shaders.FRAGMENT)&&void 0!==i?i:null),r.deleteProgram(this.program)}}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.baseTextureShader=void 0,t.baseTextureShader={vShader:"\n    attribute vec4 position;\n    attribute vec2 uv;\n    varying vec2 vuv;\n    void main() {\n        gl_Position = position;\n        vuv = uv;\n    }\n",fShader:"\n    #ifdef GL_FRAGMENT_PRECISION_HIGH\n        precision highp float;\n    #else\n        precision mediump float;\n    #endif\n\n    uniform sampler2D map;\n    varying vec2 vuv;\n    void main() {\n        gl_FragColor = texture2D(map, vuv);\n    }\n",yFlipFShader:"\n    #ifdef GL_FRAGMENT_PRECISION_HIGH\n        precision highp float;\n    #else\n        precision mediump float;\n    #endif\n\n    uniform sampler2D map;\n    varying vec2 vuv;\n    void main() {\n        gl_FragColor = texture2D(map, vec2(vuv.x, 1.0 - vuv.y));\n    }\n"}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.Filter=void 0;const r=i(13);class s extends r.EventEmitter{constructor(e,t,i,r){super(),this.programs={},this.framebuffers={},this.renderer=e,this._map=t,this.posBuffer=i,this.uvBuffer=r}get map(){return this._map}set map(e){}get output(){return this._map}updateSize(){}render(){}destroy(e=!0){this.removeAllListeners();const t=this.renderer.gl,i=this.framebuffers,r=this.programs;for(const e in i){const r=i[e];r.bind(!0),null==t||t.deleteTexture(r.targetTexture.glTexture),null==t||t.deleteFramebuffer(r.framebuffer)}for(const t in r){r[t].destroy(e)}}}t.Filter=s},,,,,,function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.STREAM_TYPE=t.NERTC_VIDEO_QUALITY_REV=t.NERTC_VIDEO_QUALITY=t.NERTC_VIDEO_QUALITY_ENUM=t.NERTC_RECORD_VIDEO_FRAME_RATE=t.NERTC_RECORD_VIDEO_QUALITY=t.VIDEO_FRAME_RATE=t.VIDEO_FRAME_RATE_ENUM=void 0,function(e){e[e.CHAT_VIDEO_FRAME_RATE_NORMAL=0]="CHAT_VIDEO_FRAME_RATE_NORMAL",e[e.CHAT_VIDEO_FRAME_RATE_5=1]="CHAT_VIDEO_FRAME_RATE_5",e[e.CHAT_VIDEO_FRAME_RATE_10=2]="CHAT_VIDEO_FRAME_RATE_10",e[e.CHAT_VIDEO_FRAME_RATE_15=3]="CHAT_VIDEO_FRAME_RATE_15",e[e.CHAT_VIDEO_FRAME_RATE_20=4]="CHAT_VIDEO_FRAME_RATE_20",e[e.CHAT_VIDEO_FRAME_RATE_25=5]="CHAT_VIDEO_FRAME_RATE_25",e[e.CHAT_VIDEO_FRAME_RATE_30=6]="CHAT_VIDEO_FRAME_RATE_30"}(t.VIDEO_FRAME_RATE_ENUM||(t.VIDEO_FRAME_RATE_ENUM={})),t.VIDEO_FRAME_RATE={CHAT_VIDEO_FRAME_RATE_NORMAL:0,CHAT_VIDEO_FRAME_RATE_5:1,CHAT_VIDEO_FRAME_RATE_10:2,CHAT_VIDEO_FRAME_RATE_15:3,CHAT_VIDEO_FRAME_RATE_20:4,CHAT_VIDEO_FRAME_RATE_25:5,CHAT_VIDEO_FRAME_RATE_30:6},t.NERTC_RECORD_VIDEO_QUALITY={RECORD_VIDEO_QUALITY_360p:360,RECORD_VIDEO_QUALITY_480p:480,RECORD_VIDEO_QUALITY_720p:720},t.NERTC_RECORD_VIDEO_FRAME_RATE={RECORD_VIDEO_FRAME_RATE_15:15,RECORD_VIDEO_FRAME_RATE_30:30},function(e){e[e.VIDEO_QUALITY_180p=2]="VIDEO_QUALITY_180p",e[e.VIDEO_QUALITY_480p=4]="VIDEO_QUALITY_480p",e[e.VIDEO_QUALITY_720p=8]="VIDEO_QUALITY_720p",e[e.VIDEO_QUALITY_1080p=16]="VIDEO_QUALITY_1080p"}(t.NERTC_VIDEO_QUALITY_ENUM||(t.NERTC_VIDEO_QUALITY_ENUM={})),t.NERTC_VIDEO_QUALITY={VIDEO_QUALITY_180p:2,VIDEO_QUALITY_480p:4,VIDEO_QUALITY_720p:8,VIDEO_QUALITY_1080p:16},t.NERTC_VIDEO_QUALITY_REV={[t.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_180p]:"320x180",[t.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_480p]:"640x480",[t.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_720p]:"1280x720",[t.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_1080p]:"1920x1080"},t.STREAM_TYPE={HIGH:0,LOW:1}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.RTCCanvas=void 0;const r=i(139);t.RTCCanvas=class{constructor(e,t){this.isAppend=!1,this.title=e,this.isAppend=t,this.createCanvas()}get _canvas(){return this.canvas}get _ctx(){return this.ctx}createCanvas(){this.canvas=document.createElement("canvas"),this.ctx=r.get2DContext(this.canvas),this.isAppend&&document.body.appendChild(this.canvas)}setSize(e,t){this.canvas&&(this.canvas.width=e,this.canvas.height=t)}destroy(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.isAppend&&document.body.removeChild(this.canvas),this.canvas=null}}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.getWebGLContext=t.get2DContext=void 0;const r=i(5);t.get2DContext=function(e,t){return r.getParameters().disable2dContext?null:e.getContext("2d",t)},t.getWebGLContext=function(e,t){return r.getParameters().disableWebGLContext?null:e.getContext("webgl",t)}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.HandlerInterface=void 0;const r=i(121);class s extends r.EnhancedEventEmitter{constructor(){super()}}t.HandlerInterface=s},function(e,t,i){e.exports=o;var r=i(119);((o.prototype=Object.create(r.prototype)).constructor=o).className="OneOf";var s=i(120),a=i(25);function o(e,t,i,s){if(Array.isArray(t)||(i=t,t=void 0),r.call(this,e,i),void 0!==t&&!Array.isArray(t))throw TypeError("fieldNames must be an Array");this.oneof=t||[],this.fieldsArray=[],this.comment=s}function n(e){if(e.parent)for(var t=0;t<e.fieldsArray.length;++t)e.fieldsArray[t].parent||e.parent.add(e.fieldsArray[t])}o.fromJSON=function(e,t){return new o(e,t.oneof,t.options,t.comment)},o.prototype.toJSON=function(e){var t=!!e&&Boolean(e.keepComments);return a.toObject(["options",this.options,"oneof",this.oneof,"comment",t?this.comment:void 0])},o.prototype.add=function(e){if(!(e instanceof s))throw TypeError("field must be a Field");return e.parent&&e.parent!==this.parent&&e.parent.remove(e),this.oneof.push(e.name),this.fieldsArray.push(e),e.partOf=this,n(this),this},o.prototype.remove=function(e){if(!(e instanceof s))throw TypeError("field must be a Field");var t=this.fieldsArray.indexOf(e);if(t<0)throw Error(e+" is not a member of "+this);return this.fieldsArray.splice(t,1),(t=this.oneof.indexOf(e.name))>-1&&this.oneof.splice(t,1),e.partOf=null,this},o.prototype.onAdd=function(e){r.prototype.onAdd.call(this,e);for(var t=0;t<this.oneof.length;++t){var i=e.get(this.oneof[t]);i&&!i.partOf&&(i.partOf=this,this.fieldsArray.push(i))}n(this)},o.prototype.onRemove=function(e){for(var t,i=0;i<this.fieldsArray.length;++i)(t=this.fieldsArray[i]).parent&&t.parent.remove(t);r.prototype.onRemove.call(this,e)},o.d=function(){for(var e=new Array(arguments.length),t=0;t<arguments.length;)e[t]=arguments[t++];return function(t,i){a.decorateType(t.constructor).add(new o(i,e)),Object.defineProperty(t,i,{get:a.oneOfGetter(e),set:a.oneOfSetter(e)})}}},function(e,t,i){var r=i(269).stringify,s=i(270);e.exports=function(e){return{parse:s(e),stringify:r}},e.exports.parse=s(),e.exports.stringify=r},function(e,t,i){var r=i(117),s=i(116),a=i(5);i(168);e.exports=class{constructor(e){this.formatTimeUnit=function(e,t){t=t||2;for(var i=""+e;i.length<t;)i="0"+i;return i},this.prefix=e?"protoo-client:"+e:"protoo-client"}debug(){var e=Array.prototype.slice.call(arguments);this.formatArgs(e),(0,a.getParameters)().logLevel<=r.loglevels.DEBUG&&console.debug.apply(console,e),window.logUpload&&window.wsTransport&&window.wsTransport.sendLog(e)}warn(){var e=Array.prototype.slice.call(arguments);this.formatArgs(e),(0,a.getParameters)().logLevel<=r.loglevels.WARNING&&console.warn.apply(console,e),window.logUpload&&window.wsTransport&&window.wsTransport.sendLog(e)}error(){var e=Array.prototype.slice.call(arguments);this.formatArgs(e),(0,a.getParameters)().logLevel<=r.loglevels.ERROR&&console.error.apply(console,e),window.logUpload&&window.wsTransport&&window.wsTransport.sendLog(e)}formatArgs(e){var t=new Date,i=this.formatTimeUnit(""+(t.getMonth()+1))+"-"+this.formatTimeUnit(""+t.getDate())+" "+this.formatTimeUnit(""+t.getHours())+":"+this.formatTimeUnit(""+t.getMinutes())+":"+this.formatTimeUnit(""+t.getSeconds())+":"+this.formatTimeUnit(""+t.getMilliseconds(),3),r="[NERTC:LOG:"+(0,s.updateLogIndex)()+" "+i+" "+this.prefix.toUpperCase()+"]";return e.unshift(r),e}}},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.alerter=void 0;const o=i(161),n=a(i(2)),d=i(66),c=i(5),l=i(62);class u extends d.RTCEventEmitter{constructor(){super(...arguments),this.elem=null}alert(e,t){t||(t={resume:!1}),this.elem||(this.elem=document.createElement("div"),this.elem.style.fontSize="20px",this.elem.style.position="fixed",this.elem.style.background="yellow",this.elem.style.margin="auto",this.elem.style.width="100%",this.elem.style.zIndex="9999",this.elem.style.top="0",this.elem.addEventListener("click",()=>{var e;(null===(e=this.elem)||void 0===e?void 0:e.parentNode)&&this.elem.parentNode.removeChild(this.elem),this.safeEmit("@user-gesture-fired")})),this.elem.style.display="block",this.elem.innerHTML=e,document.body.appendChild(this.elem),t.resume&&this.elem.addEventListener("click",h,{once:!0})}watchClient(e){e.addListener("@pairing-join-start",()=>{if(0===o.systemChecker.checkCnt||"always"===c.getParameters().enableAlerter){const e=72;if(n.IS_CHROME&&(n.IS_MAC||n.IS_WIN)&&n.CHROME_MAJOR_VERSION&&n.CHROME_MAJOR_VERSION<e){let e=`您当前正在使用的Chrome浏览器版本为${n.CHROME_MAJOR_VERSION}, 不在NERTC的支持范围。请更新您的浏览器。<br/>您看到这条提示是因为您未调用 NERTC.checkSystemRequirements()，并且浏览器版本过低。`;this.alert(e)}}}),e.addListener("@connection-state-change",t=>{if("DISCONNECTING"===t.curState&&"CONNECTING"===t.prevState&&(e._events&&!e._events["connection-state-change"]&&!e._events.SOCKET_ERROR||"always"===c.getParameters().enableAlerter)){let e="由于网络原因，您当前已经退出房间。<br/>您看到这条提示是因为您未监听 connection-state-change 或 SOCKET_ERROR 事件，并且加入房间后意外退出了房间。";this.alert(e)}})}watchLocalStream(e){e.on("@notAllowedError",t=>{if(!e._events.notAllowedError||"always"===c.getParameters().enableAlerter){let e="音频播放需要手势触发。<br/>您看到这条提示是因为您未监听 notAllowedError 事件，并且遇到了浏览器自动播放策略问题。";this.alert(e,{resume:!0})}})}watchRemoteStream(e){e.on("@notAllowedError",t=>{if(!e._events.notAllowedError||"always"===c.getParameters().enableAlerter){let e="音频播放需要手势触发。<br/>您看到这条提示是因为您未监听 notAllowedError 事件，并且遇到了浏览器自动播放策略问题。";this.alert(e,{resume:!0})}})}}function h(){var e,t,i,r,s,a,o,n,d,u,h,p;const m=c.getParameters().clients;for(let o=0;o<m.length;o++){const n=m[o];if(!n.destroyed)for(let o in n.adapterRef.remoteStreamMap){const d=n.adapterRef.remoteStreamMap[o];(null===(t=null===(e=d._play)||void 0===e?void 0:e.audioDom)||void 0===t?void 0:t.paused)&&(d.logger.warn("尝试恢复音频播放"),d._play.audioDom.play()),(null===(r=null===(i=d._play)||void 0===i?void 0:i.videoDom)||void 0===r?void 0:r.paused)&&(d.logger.warn("尝试恢复视频播放"),d._play.videoDom.play()),(null===(a=null===(s=d._play)||void 0===s?void 0:s.screenDom)||void 0===a?void 0:a.paused)&&(d.logger.warn("尝试恢复屏幕共享播放"),d._play.screenDom.play())}}const f=c.getParameters().localStreams;for(let e=0;e<f.length;e++){const t=f[e];t.destroyed||((null===(n=null===(o=t._play)||void 0===o?void 0:o.audioDom)||void 0===n?void 0:n.paused)&&(t.logger.warn("尝试恢复音频播放"),t._play.audioDom.play()),(null===(u=null===(d=t._play)||void 0===d?void 0:d.videoDom)||void 0===u?void 0:u.paused)&&(t.logger.warn("尝试恢复视频播放"),t._play.videoDom.play()),(null===(p=null===(h=t._play)||void 0===h?void 0:h.screenDom)||void 0===p?void 0:p.paused)&&(t.logger.warn("尝试恢复屏幕共享播放"),t._play.screenDom.play()))}const g=l.getAudioContext();"suspended"===(null==g?void 0:g.state)&&(m[0]&&m[0].logger.warn("尝试恢复 AudioContext"),g.resume())}t.alerter=new u},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.isHttpProtocol=t.checkRTCCompatibility=t.isBrowserSupported=t.isScreenShareSupport=t.isMediaDevicesSupported=t.isWebRTCSupported=t.RtcSupport=void 0;const o=i(115),n=i(68),d=a(i(2)),c=i(67);let l={result:!1,detail:{isBrowserSupported:!1,isWebRTCSupported:!1,isMediaDevicesSupported:!1,isH264EncodeSupported:!1,isVp8EncodeSupported:!1,isH264DecodeSupported:!1,isVp8DecodeSupported:!1}};var u=null;d.IS_IOS&&d.IS_WECHAT||(u=navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||navigator.mediaDevices&&navigator.mediaDevices.getUserMedia);var h=window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext,p=window.RTCPeerConnection=window.RTCPeerConnection||window.webkitRTCPeerConnection||window.mozRTCPeerConnection,m=window.MediaStream=window.MediaStream||window.webkitMediaStream;function f(e){let t;return t||(t=document.createElement("video")),!!t.canPlayType({ogg:'video/ogg; codecs="theora"',h264:'video/mp4; codecs="avc1.42E01E"',webm:'video/webm; codecs="vp8, vorbis"',vp9:'video/webm; codecs="vp9"',hls:'application/x-mpegURL; codecs="avc1.42E01E"'}[e]||e)}const g={WebRTC:!!p&&!!m,RTCPeerConnection:!!p,Vp8:f("webm"),Vp9:f("vp9"),H264:f("h264"),GetUserMedia:!!u&&!!navigator.mediaDevices,DataChannel:!!(p&&"undefined"!=typeof RTCDataChannel&&p.prototype&&p.prototype.createDataChannel),WebAudio:!(!h||!h.prototype.createMediaStreamSource),MediaStream:!!m};function v(){let e=c.getBrowserInfo().browserName,t=c.getBrowserInfo().browserVersion;return t=t&&t.match(/\d+/)[0],{prefix:e,version:t}}const _={checkWebRtc:()=>g,checkWebAudio:()=>({WebAudio:g.WebAudio,MediaStream:g.MediaStream}),checkCompatibility(){let e=Object.assign(v(),{system:c.getOSInfo().osName+" "+c.getOSInfo().osVersion,browser:c.getBrowserInfo().browserName,version:c.getBrowserInfo().browserVersion});return new Promise((function(t,i){(async()=>{const i=Object.assign(e,g,{ScreenSharing:!1}),r=await o.Device.getDevices({audiooutput:!0,audioinput:!0,videoinput:!0,requestPerm:!0}).catch(e=>t(i));i.MicrophoneList=r&&r.audioIn||[],i.CameraList=r&&r.video||[],i.Microphone=r&&r.audioIn&&r.audioIn.length>0||!1,i.Camera=r&&r.video&&r.video.length>0||!1,t(i)})()}))},checkVersion:()=>v()};t.RtcSupport=_;t.isWebRTCSupported=function(){return["RTCPeerConnection","webkitRTCPeerConnection","RTCIceGatherer"].filter(e=>e in window).length>0};t.isMediaDevicesSupported=function(){if(!navigator.mediaDevices)return!1;const e=["getUserMedia","enumerateDevices"];return e.filter(e=>e in navigator.mediaDevices).length===e.length};t.isScreenShareSupport=function(){if(d.IS_ELECTRON)return!0;{let e=navigator.mediaDevices;return!(!e||!e.getDisplayMedia)}};t.isBrowserSupported=function(){return!!(d.IS_CHROME&&d.CHROME_MAJOR_VERSION>=72)||(!!(d.IS_MAC_SAFARI&&d.SAFARI_MAJOR_VERSION>=12)||(!(!(d.IS_IOS_SAFARI&&d.SAFARI_MAJOR_VERSION>=13)||d.IS_WECHAT)||(!!(d.IS_EDG&&d.EDG_MAJOR_VERSION>=80)||(!!(d.IS_FIREFOX&&d.FIREFOX_MAJOR_VERSION>=66)||(!(!d.IS_IOS||!d.IS_MQQB)||(!!(d.IS_IOS&&d.IOS_VERSION&&parseFloat(d.IOS_VERSION)>=14.3&&d.IS_WECHAT&&d.WECHAT_VERSION&&parseFloat(d.WECHAT_VERSION)>=6.5)||!(!d.IS_ANDROID||!d.IS_TBS&&!d.IS_XWEB)))))))};t.checkRTCCompatibility=async function(){if(l.result)return l;const e=t.isBrowserSupported(),i=t.isWebRTCSupported(),r=t.isMediaDevicesSupported(),s=await n.getSupportedCodecs("send"),a=await n.getSupportedCodecs("recv");return l.detail.isBrowserSupported=e,l.detail.isWebRTCSupported=i,l.detail.isMediaDevicesSupported=r,l.detail.isH264EncodeSupported=s.video.indexOf("H264")>-1,l.detail.isVp8EncodeSupported=s.video.indexOf("VP8")>-1,l.detail.isH264DecodeSupported=a.video.indexOf("H264")>-1,l.detail.isVp8DecodeSupported=a.video.indexOf("VP8")>-1,l.result=e&&i&&r&&(l.detail.isH264EncodeSupported||l.detail.isVp8EncodeSupported)&&(l.detail.isH264EncodeSupported||l.detail.isVp8EncodeSupported),l};const S="file:"===location.protocol||"localhost"===location.hostname||/^\d+\.\d+\.\d+\.\d+$/.test(location.hostname);t.isHttpProtocol=function(){return"http:"===location.protocol&&!S}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.compatAudioInputList=void 0;t.compatAudioInputList=new class{constructor(){this.enabled=!1,this.compatTracks=[]}findSource(e){const t=this.compatTracks.find(t=>t.dest.id===e);return t?t.source:null}}},function(e,t,i){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.encryptionModeToInt=t.EncryptionModes=t.Encryption=void 0;const s=i(13),a=r(i(148)),o={none:-1,"sm4-128-ecb":0};t.EncryptionModes=o,t.encryptionModeToInt=function(e){return"none"===e||"sm4-128-ecb"===e?o[e]:void 0};class n extends s.EventEmitter{constructor(e){super(),this.encryptionMode="none",this.encryptionSecret="",this.encodedInsertableStreams=!1,this.adapterRef=e}setEncryptionMode(e){this.encryptionMode=e}setEncryptionSecret(e){this.encryptionSecret=a.default(e)}handleUpstreamTransform(e,t,i){e.index++,1===e.index&&this.adapterRef.logger.log("生成第一帧上行自定义加密（明文）。长度:",t.data.byteLength,e.mediaType,e.streamType),this.adapterRef.instance.safeEmit("sender-transform",{uid:this.adapterRef.channelInfo.uid,mediaType:e.mediaType,streamType:e.streamType,encodedFrame:t,controller:i})}handleDownstreamTransform(e,t,i){e.index++,1===e.index&&this.adapterRef.logger.log("收到第一帧下行自定义加密（密文）。长度:",t.data.byteLength,e.uid,e.mediaType),this.adapterRef.instance.safeEmit("receiver-transform",{uid:e.uid,mediaType:e.mediaType,encodedFrame:t,controller:i})}}t.Encryption=n},function(e,t,i){var r,s,a,o,n;r=i(209),s=i(163).utf8,a=i(210),o=i(163).bin,(n=function(e,t){e.constructor==String?e=t&&"binary"===t.encoding?o.stringToBytes(e):s.stringToBytes(e):a(e)?e=Array.prototype.slice.call(e,0):Array.isArray(e)||e.constructor===Uint8Array||(e=e.toString());for(var i=r.bytesToWords(e),d=8*e.length,c=1732584193,l=-271733879,u=-1732584194,h=271733878,p=0;p<i.length;p++)i[p]=16711935&(i[p]<<8|i[p]>>>24)|4278255360&(i[p]<<24|i[p]>>>8);i[d>>>5]|=128<<d%32,i[14+(d+64>>>9<<4)]=d;var m=n._ff,f=n._gg,g=n._hh,v=n._ii;for(p=0;p<i.length;p+=16){var _=c,S=l,y=u,R=h;c=m(c,l,u,h,i[p+0],7,-680876936),h=m(h,c,l,u,i[p+1],12,-389564586),u=m(u,h,c,l,i[p+2],17,606105819),l=m(l,u,h,c,i[p+3],22,-1044525330),c=m(c,l,u,h,i[p+4],7,-176418897),h=m(h,c,l,u,i[p+5],12,1200080426),u=m(u,h,c,l,i[p+6],17,-1473231341),l=m(l,u,h,c,i[p+7],22,-45705983),c=m(c,l,u,h,i[p+8],7,1770035416),h=m(h,c,l,u,i[p+9],12,-1958414417),u=m(u,h,c,l,i[p+10],17,-42063),l=m(l,u,h,c,i[p+11],22,-1990404162),c=m(c,l,u,h,i[p+12],7,1804603682),h=m(h,c,l,u,i[p+13],12,-40341101),u=m(u,h,c,l,i[p+14],17,-1502002290),c=f(c,l=m(l,u,h,c,i[p+15],22,1236535329),u,h,i[p+1],5,-165796510),h=f(h,c,l,u,i[p+6],9,-1069501632),u=f(u,h,c,l,i[p+11],14,643717713),l=f(l,u,h,c,i[p+0],20,-373897302),c=f(c,l,u,h,i[p+5],5,-701558691),h=f(h,c,l,u,i[p+10],9,38016083),u=f(u,h,c,l,i[p+15],14,-660478335),l=f(l,u,h,c,i[p+4],20,-405537848),c=f(c,l,u,h,i[p+9],5,568446438),h=f(h,c,l,u,i[p+14],9,-1019803690),u=f(u,h,c,l,i[p+3],14,-187363961),l=f(l,u,h,c,i[p+8],20,1163531501),c=f(c,l,u,h,i[p+13],5,-1444681467),h=f(h,c,l,u,i[p+2],9,-51403784),u=f(u,h,c,l,i[p+7],14,1735328473),c=g(c,l=f(l,u,h,c,i[p+12],20,-1926607734),u,h,i[p+5],4,-378558),h=g(h,c,l,u,i[p+8],11,-2022574463),u=g(u,h,c,l,i[p+11],16,1839030562),l=g(l,u,h,c,i[p+14],23,-35309556),c=g(c,l,u,h,i[p+1],4,-1530992060),h=g(h,c,l,u,i[p+4],11,1272893353),u=g(u,h,c,l,i[p+7],16,-155497632),l=g(l,u,h,c,i[p+10],23,-1094730640),c=g(c,l,u,h,i[p+13],4,681279174),h=g(h,c,l,u,i[p+0],11,-358537222),u=g(u,h,c,l,i[p+3],16,-722521979),l=g(l,u,h,c,i[p+6],23,76029189),c=g(c,l,u,h,i[p+9],4,-640364487),h=g(h,c,l,u,i[p+12],11,-421815835),u=g(u,h,c,l,i[p+15],16,530742520),c=v(c,l=g(l,u,h,c,i[p+2],23,-995338651),u,h,i[p+0],6,-198630844),h=v(h,c,l,u,i[p+7],10,1126891415),u=v(u,h,c,l,i[p+14],15,-1416354905),l=v(l,u,h,c,i[p+5],21,-57434055),c=v(c,l,u,h,i[p+12],6,1700485571),h=v(h,c,l,u,i[p+3],10,-1894986606),u=v(u,h,c,l,i[p+10],15,-1051523),l=v(l,u,h,c,i[p+1],21,-2054922799),c=v(c,l,u,h,i[p+8],6,1873313359),h=v(h,c,l,u,i[p+15],10,-30611744),u=v(u,h,c,l,i[p+6],15,-1560198380),l=v(l,u,h,c,i[p+13],21,1309151649),c=v(c,l,u,h,i[p+4],6,-145523070),h=v(h,c,l,u,i[p+11],10,-1120210379),u=v(u,h,c,l,i[p+2],15,718787259),l=v(l,u,h,c,i[p+9],21,-343485551),c=c+_>>>0,l=l+S>>>0,u=u+y>>>0,h=h+R>>>0}return r.endian([c,l,u,h])})._ff=function(e,t,i,r,s,a,o){var n=e+(t&i|~t&r)+(s>>>0)+o;return(n<<a|n>>>32-a)+t},n._gg=function(e,t,i,r,s,a,o){var n=e+(t&r|i&~r)+(s>>>0)+o;return(n<<a|n>>>32-a)+t},n._hh=function(e,t,i,r,s,a,o){var n=e+(t^i^r)+(s>>>0)+o;return(n<<a|n>>>32-a)+t},n._ii=function(e,t,i,r,s,a,o){var n=e+(i^(t|~r))+(s>>>0)+o;return(n<<a|n>>>32-a)+t},n._blocksize=16,n._digestsize=16,e.exports=function(e,t){if(null==e)throw new Error("Illegal argument "+e);var i=r.wordsToBytes(n(e,t));return t&&t.asBytes?i:t&&t.asString?o.bytesToString(i):r.bytesToHex(i)}},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Record=void 0;const n=i(13),d=o(i(11)),c=o(i(12)),l=a(i(2));class u extends n.EventEmitter{constructor(e){super(),this._status={recordedChunks:[],isRecording:!1,stream:null,option:null,contentTypes:[],mimeType:"",audioController:null,opStream:null,state:"init",timer:null,fileName:null,recordId:0,recordStatus:"init",recordUrl:null,startTime:null,endTime:null},this._recorder=null,this.logger=e.logger.getChild(()=>"recorder "+this._status.recordStatus),this._reset(),this.client=e.client}async start(e){const{stream:t=null,uid:i="0",type:r="video",reset:s=!1,recordName:a}=e;this.logger.log("开始本地录制: ",JSON.stringify(e,null,""));let o=null;if(!window.MediaRecorder||!MediaRecorder.isTypeSupported||!l.IS_CHROME){this.logger.log("浏览器不支持本地录制"),o="RecordBrowserNotSupport";let e="Record.start: recording is not supported in this browser",t="Record.start: 当前浏览器不支持本地录制",i="The latest version of the Chrome browser is recommended",r="建议使用最新版的 Chrome 浏览器",s=l.IS_ZH?t:e,a=l.IS_ZH?r:i;throw new c.default({code:d.default.NOT_SUPPORT_ERROR,message:s,advice:a})}if(this._status.isRecording){this.logger.log("当前正在录制中"),o="RecordInRecording";let e="Record.start: invalid operation",t="Record.start: 操作异常",i="in recording",r="当前正在录制中",s=l.IS_ZH?t:e,a=l.IS_ZH?r:i;throw new c.default({code:d.default.INVALID_OPERATION_ERROR,message:s,advice:a})}if(this._status.recordUrl&&"downloaded"!==this._status.recordStatus){if(!e.reset){this.logger.log("MediaRecordHelper: start : 请先下载或重置上一段录制文件"),o="RecordFileExsit";let e="Record.start: invalid operation",t="Record.start: 操作异常",i="Please download or reset the previous recording first",r="请先下载或重置上一段录制文件",s=l.IS_ZH?t:e,a=l.IS_ZH?r:i;throw new c.default({code:d.default.INVALID_OPERATION_ERROR,message:s,advice:a})}this.logger.warn("MediaRecordHelper: start: 存在未下载视频，强制清除..."),await this.clean()}o&&this.client.apiFrequencyControl({name:"startMediaRecording",code:-1,param:JSON.stringify({reason:o,uid:i,mediaType:r,recordName:""},null," ")}),this._status.stream=t,this._status.option=e,this._status.fileName=this._getFilename(a),this._status.startTime=this._getTimeStamp();let n=["video/mp4;codecs=opus","video/webm","video/webm;codecs=h264","video/x-matroska;codecs=opus","video/invalid"];if("audio"===e.type&&(n=["audio/wav","audio/ogg","audio/pcm","audio/webm"]),!(this._status.mimeType=this._validation(n)[0]))return"RecordBrowserNotSupport";try{await this._format(),await this._start(),this.client.apiFrequencyControl({name:"startMediaRecording",code:0,param:JSON.stringify({uid:i,mediaType:r,recordName:""},null," ")})}catch(e){this.logger.error("录制start error: ",e.name,e.message,e),this.client.apiFrequencyControl({name:"startMediaRecording",code:-1,param:JSON.stringify({reason:"录制接口 error",uid:i,mediaType:r,recordName:""},null," ")});let t="Record.start: start interface error",s="Record.start: 录制接口异常",a="Please contact CommsEase technical support",o="请联系云信技术支持",n=l.IS_ZH?s:t,u=l.IS_ZH?o:a;return Promise.reject(new c.default({code:d.default.RECORDING_ERROR,message:n,advice:u}))}}stop(e){let t=null;return this._status.isRecording&&this._recorder||(this.logger.log("当前没有进行录制"),t="RecordNotExist"),this._recorder&&"started"!==this._status.state&&(this.logger.warn("MediaRecordHelper: record stopping when "+this._recorder.state),t="RecordStateError"),t?(e&&!1===e.isUser||this.client.apiFrequencyControl({name:"stopMediaRecording",code:-1,param:""}),Promise.resolve()):(this._status.state="stopped",this._status.recordStatus="stopping",new Promise((t,i)=>{if(!this._recorder){let e="Record.stop: stop interface error, record is not found",t="Record.stop: 录制接口异常, 未找到 record",r="Please contact CommsEase technical support",s="请联系云信技术支持",a=l.IS_ZH?t:e,o=l.IS_ZH?s:r;return i(new c.default({code:d.default.RECORDING_ERROR,message:a,advice:o}))}this._status.fileName=this._status.fileName,this._recorder.onstop=()=>{this._onStop(t)},this._recorder.stop(),this.client.apiFrequencyControl({name:"stopMediaRecording",code:0,param:""}),e&&e.isUser&&this.client.apiFrequencyControl({name:"stopMediaRecording",code:-1,param:""})}))}play(e){return"stopped"!==this._status.state?(this.client.apiFrequencyControl({name:"playMediaRecording",code:-1,param:JSON.stringify({reason:"RecordStateError"},null," ")}),this.logger.warn("MediaRecordHelper: record stopping when "+(this._recorder&&this._recorder.state)),Promise.resolve()):(this.client.apiFrequencyControl({name:"playMediaRecording",code:0,param:JSON.stringify({recordId:""},null," ")}),this._play(e))}download(e=!0){return Promise.resolve().then(()=>this._status.isRecording?(this.logger.log("MediaRecordHelper: download: 正在录制中，立即停止..."),this.stop({isUser:!1})):Promise.resolve()).then(()=>{if(this._status.recordUrl){const e=document.createElement("a");document.body.appendChild(e),e.style.display="none",e.href=this._status.recordUrl,e.download=(this._status.fileName||this._getTimeStamp())+".webm",e.click(),this._status.recordStatus="downloaded"}else this.logger.log("MediaRecordHelper: download: cannot download media without url ...");return e&&this.client.apiFrequencyControl({name:"downloadMediaRecording",code:0,param:""}),Promise.resolve(this._status)})}async clean(){this.client.apiFrequencyControl({name:"cleanMediaRecording",code:0,param:""}),this._status.isRecording&&this._recorder&&await this.stop(),this._status.recordUrl&&(window.URL.revokeObjectURL(this._status.recordUrl),this._status.recordUrl=null),this._destroy(),this._status.recordStatus="init"}leave(e={uid:0}){if(!this._status.isRecording||!this._recorder)return Promise.resolve();const{uid:t}=e;return t&&this._status.option?t===+this._status.option.uid?this.stop():void 0:Promise.resolve()}pause(){this._recorder&&this._recorder.pause()}resume(){this._recorder&&this._recorder.resume()}_reset(){this._recorder=null,Object.assign(this._status,{recordedChunks:[],isRecording:!1,stream:null,option:null,contentTypes:[],mimeType:"",audioController:null,opStream:null,state:"init",timer:null,fileName:null,recordId:0,recordStatus:"init",recordUrl:null,startTime:null,endTime:null})}_getTimeStamp(){return Math.floor(Date.now()/1e3)}_getFilename(e){let t="";e&&(t+=e+"_");const i=new Date;return t+=`${i.getFullYear()}${(i.getMonth()+1).toString().padStart(2,"0")}${i.getDate().toString().padStart(2,"0")}`,t+=`${i.getHours().toString().padStart(2,"0")}${i.getMinutes().toString().padStart(2,"0")}${i.getSeconds().toString().padStart(2,"0")}${i.getMilliseconds().toString().padStart(3,"0")}`,t}_validation(e){return e.filter(e=>MediaRecorder.isTypeSupported(e))}_format(){let e=this._status.stream;this._status.option;return new Promise((t,i)=>{let r=new MediaStream;if(!e){let e="Record._format: stream is undefined",t="Record._format: stream 未明确",r="Please contact CommsEase technical support",s="请联系云信技术支持",a=l.IS_ZH?t:e,o=l.IS_ZH?s:r;return i(new c.default({code:d.default.UNDEFINED_ERROR,message:a,advice:o}))}if(this._matchLocalStreamConstructor(e.constructor.toString())&&(e=[e]),Array.isArray(e)){if(e.forEach(e=>{e&&this._matchLocalStreamConstructor(e.constructor.toString())&&e.getTracks().forEach(e=>{r.addTrack(e)})}),0===r.getTracks().length)return this.logger.error("_format: No tracks available"),t(r);this._status.opStream=r,t(r)}})}_matchLocalStreamConstructor(e){return/(LocalMediaStream|MediaStream)/.test(e)}_start(){let e={audioBitsPerSecond:128e3,videoBitsPerSecond:25e5,mimeType:this._status.mimeType};if(!this._status.opStream){let e="Record._start: stream is undefined",t="Record._start: stream 未明确",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=l.IS_ZH?t:e,a=l.IS_ZH?r:i;return Promise.reject(new c.default({code:d.default.UNDEFINED_ERROR,message:s,advice:a}))}const t=this._status.opStream.getAudioTracks();let i;i=t.length>1?new MediaStream([t[0]]):this._status.opStream;let r=this._recorder=new MediaRecorder(i,e);return r.ondataavailable=this._onDataAvailable.bind(this),r.onstop=()=>{this.logger.log("MediaRecordHelper: _start: record stop automatically ..."),this._onStop()},this._status.recordUrl&&(window.URL.revokeObjectURL(this._status.recordUrl),this._status.recordUrl=null),this._status.recordedChunks=[],this._status.isRecording=!0,this._status.state="started",this._status.recordId+=1,this._status.recordStatus="starting",this._recorder.start(),this._clearTimer(),this._startTimer(),Promise.resolve(this._status.recordId)}_startTimer(){this._status.timer||(this._status.timer=setInterval(()=>{this.logger.log(`MediaRecordHelper: startTimer: ${(new Date).toLocaleString()} --\x3e MediaRecorder status: ${this._recorder&&this._recorder.state}`)},5e3))}_onStop(e){this.logger.log("MediaRecordHelper: _onStop: record stoped !!!"),this._clearTimer(),this._status.recordStatus="stopped",this._status.isRecording=!1,this._status.endTime=this._getTimeStamp();let t=new Blob(this._status.recordedChunks,{type:this._status.mimeType});this._status.recordUrl=URL.createObjectURL(t),this.emit("media-recording-stopped",this.getRecordStatus()),e&&e(this._status.fileName)}_play(e){let t=null;if(-1!=this._status.mimeType.indexOf("audio"))t=document.createElement("audio");else{if(-1==this._status.mimeType.indexOf("video")){let e="_play: MIME type ${this._status.mimeType} is not supported in this browser",t="_play: 当前浏览器不支持 MIME type "+this._status.mimeType,i="The latest version of the Chrome browser is recommended",r="建议使用最新版的 Chrome 浏览器",s=l.IS_ZH?t:e,a=l.IS_ZH?r:i;return Promise.reject(new c.default({code:d.default.NOT_SUPPORT_ERROR,message:s,advice:a}))}t=document.createElement("video"),t.autoplay=!0}if(!this._status.recordUrl){let e="Record._play: record url is undefined",t="Record._play: 录制 url 未明确",i="please make sure record url exists",r="请确保录制 url 正确",s=l.IS_ZH?t:e,a=l.IS_ZH?r:i;return Promise.reject(new c.default({code:d.default.UNDEFINED_ERROR,message:s,advice:a}))}return e.appendChild(t),t.srcObject=null,t.src=this._status.recordUrl,t.controls=!1,t.play(),Promise.resolve(this._status.option)}async _destroy(){this._status.audioController&&this._status.audioController.destroy(),this._status.isRecording&&await this.stop({isUser:!1}),this._clearTimer(),this._recorder=null,Object.assign(this._status,{stream:null,recordedChunks:[],isRecording:!1,audioController:null,status:"init"})}_clearTimer(){this._status.timer&&(clearInterval(this._status.timer),this._status.timer=null)}_onDataAvailable(e){if(this._status.recordStatus="recording",this.logger.log("MediaRecordHelper: ondataavailable: data received"),!(e.data.size>0))return this.logger.warn("MediaRecordHelper: ondataavailable: no data"),void this.stop();this._status.recordedChunks.push(e.data)}checkIsRecording(){return this._status.isRecording}getRecordStatus(){const e=Object.assign({id:this._status.recordId,type:this._status.mimeType,name:this._status.fileName,status:this._status.recordStatus,isRecording:this._status.isRecording,startTime:this._status.startTime,endTime:this._status.endTime},this._status.option);return this.client.apiFrequencyControl({name:"listMediaRecording",code:0,param:""}),e}destroy(){this._destroy()}}t.Record=u},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.applyCodecParameters=t.getCname=t.extractDtlsParameters=t.extractRtpCapabilities=void 0;const n=a(i(123)),d=a(i(2)),c=o(i(11)),l=o(i(12));t.extractRtpCapabilities=function({sdpObject:e}){const t=new Map,i=[];let r=!1,s=!1;for(const a of e.media){const e=a.type;switch(e){case"audio":if(r)continue;r=!0;break;case"video":if(s)continue;s=!0;break;default:continue}for(const i of a.rtp){const r={kind:e,mimeType:`${e}/${i.codec}`,preferredPayloadType:i.payload,clockRate:i.rate,channels:i.encoding,parameters:{},rtcpFeedback:[]};t.set(r.preferredPayloadType,r)}for(const e of a.fmtp||[]){const i=n.parseParams(e.config),r=t.get(e.payload);r&&(i&&i.hasOwnProperty("profile-level-id")&&(i["profile-level-id"]=String(i["profile-level-id"])),r.parameters=i)}for(const e of a.rtcpFb||[]){const i=t.get(e.payload);if(!i)continue;const r={type:e.type,parameter:e.subtype};r.parameter||delete r.parameter,i.rtcpFeedback.push(r)}for(const t of a.ext||[]){if(t["encrypt-uri"])continue;const r={kind:e,uri:t.uri,preferredId:t.value};i.push(r)}}return{codecs:Array.from(t.values()),headerExtensions:i}},t.extractDtlsParameters=function({sdpObject:e}){const t=(e.media||[]).find(e=>e.iceUfrag&&0!==e.port);if(!t){let e="extractDtlsParameters: active media section is found",t="extractDtlsParameters: active media 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=d.IS_ZH?t:e,a=d.IS_ZH?r:i;throw new l.default({code:c.default.SDP_ERROR,message:s,advice:a})}const i=t.fingerprint||e.fingerprint;let r;switch(t.setup){case"active":r="client";break;case"passive":r="server";break;case"actpass":r="auto"}return{role:r,fingerprints:[{algorithm:i.type,value:i.hash}]}},t.getCname=function({offerMediaObject:e}){const t=(e.ssrcs||[]).find(e=>"cname"===e.attribute);return t?t.value:""},t.applyCodecParameters=function({offerRtpParameters:e,answerMediaObject:t}){for(const i of e.codecs){const e=i.mimeType.toLowerCase();if("audio/opus"!==e)continue;if(!(t.rtp||[]).find(e=>e.payload===i.payloadType))continue;t.fmtp=t.fmtp||[];let r=t.fmtp.find(e=>e.payload===i.payloadType);r||(r={payload:i.payloadType,config:""},t.fmtp.push(r));const s=n.parseParams(r.config);switch(e){case"audio/opus":{const e=i.parameters["sprop-stereo"];void 0!==e&&(s.stereo=e?1:0);break}}r.config="";for(const e of Object.keys(s))r.config&&(r.config+=";"),r.config+=`${e}=${s[e]}`}}},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.RemoteSdp=void 0;const n=a(i(123)),d=a(i(2)),c=o(i(11)),l=o(i(12)),u=i(5),h=i(56),p=i(224);t.RemoteSdp=class{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:r,plainRtpParameters:s,planB:a=!1}){if(this._mediaSections=[],this._midToIndex=new Map,this._iceParameters=e,this._iceCandidates=t,this._dtlsParameters=i,this._sctpParameters=r,this._plainRtpParameters=s,this._planB=a,this._sdpObject={version:0,origin:{address:"0.0.0.0",ipVer:4,netType:"IN",sessionId:1e4,sessionVersion:0,username:"mediasoup-client"},name:"-",timing:{start:0,stop:0},media:[]},e&&e.iceLite&&(this._sdpObject.icelite="ice-lite"),i){this._sdpObject.msidSemantic={semantic:"WMS",token:"*"};const e=this._dtlsParameters.fingerprints.length;this._sdpObject.fingerprint={type:i.fingerprints[e-1].algorithm,hash:i.fingerprints[e-1].value},this._sdpObject.groups=[{type:"BUNDLE",mids:""}]}s&&(this._sdpObject.origin.address=s.ip,this._sdpObject.origin.ipVer=s.ipVersion)}updateIceParameters(e){h.Logger.debug("RemoteSdp","updateIceParameters() [iceParameters:%o]",e),this._iceParameters=e,this._sdpObject.icelite=e.iceLite?"ice-lite":void 0;for(const t of this._mediaSections)t.setIceParameters(e)}updateDtlsRole(e){h.Logger.debug("RemoteSdp",`updateDtlsRole() [role: ${e}]`),this._dtlsParameters.role=e;for(const t of this._mediaSections)t.setDtlsRole(e)}getNextMediaSectionIdx(){if(u.getParameters().reuseMid)for(let e=0;e<this._mediaSections.length;++e){const t=this._mediaSections[e];if(t.closed)return{idx:e,reuseMid:t.mid}}return{idx:this._mediaSections.length}}send({offerMediaObjectArr:e,reuseMid:t,offerRtpParameters:i,answerRtpParameters:r,codecOptions:s,extmapAllowMixed:a=!1}){e.length&&e.forEach((e,o)=>{if(!e)return;const n=new p.AnswerMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,plainRtpParameters:this._plainRtpParameters,planB:this._planB,offerMediaObject:e,offerRtpParameters:i,answerRtpParameters:r,codecOptions:s?s[o]:void 0,extmapAllowMixed:a});t?this._replaceMediaSection(n,t):this._addMediaSection(n)})}receive({mid:e,kind:t,offerRtpParameters:i,streamId:r,trackId:s,reuseMid:a=null,reuseMediaSection:o}){const n=this._midToIndex.get(e);let d;void 0!==n&&(d=this._mediaSections[n]),d?(d=new p.OfferMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,plainRtpParameters:this._plainRtpParameters,planB:this._planB,mid:e,kind:t,offerRtpParameters:i,streamId:r,trackId:s}),this._replaceMediaSection(d,e)):(d=new p.OfferMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,plainRtpParameters:this._plainRtpParameters,planB:this._planB,mid:e,kind:t,offerRtpParameters:i,streamId:r,trackId:s}),null===a?this._addMediaSection(d):this._replaceMediaSection(d,a))}disableMediaSection(e){const t=this._midToIndex.get(e);if(void 0===t){let t=`disableMediaSection: no media section found with mid '${e}'`,i=`disableMediaSection: media 中找不到 mid '${e}'`,r="Please contact CommsEase technical support",s="请联系云信技术支持",a=d.IS_ZH?i:t,o=d.IS_ZH?s:r;throw new l.default({code:c.default.SDP_ERROR,message:a,advice:o})}this._mediaSections[t].disable()}closeMediaSection(e){const t=this._midToIndex.get(e);if(void 0===t){let t=`closeMediaSection: no media section found with mid '${e}'`,i=`closeMediaSection: media 中找不到 mid '${e}'`,r="Please contact CommsEase technical support",s="请联系云信技术支持",a=d.IS_ZH?i:t,o=d.IS_ZH?s:r;throw new l.default({code:c.default.SDP_ERROR,message:a,advice:o})}const i=this._mediaSections[t];e===this._firstMid&&h.Logger.debug("RemoteSdp","closeMediaSection() | cannot close first media section, disabling it instead [mid:%s]",e),i.close()}planBStopReceiving({mid:e,offerRtpParameters:t}){const i=this._midToIndex.get(e);if(void 0===i){let t=`planBStopReceiving: no media section found with mid '${e}'`,i=`planBStopReceiving: media 中找不到 mid '${e}'`,r="Please contact CommsEase technical support",s="请联系云信技术支持",a=d.IS_ZH?i:t,o=d.IS_ZH?s:r;throw new l.default({code:c.default.SDP_ERROR,message:a,advice:o})}const r=this._mediaSections[i];r.planBStopReceiving({offerRtpParameters:t}),this._replaceMediaSection(r)}sendSctpAssociation({offerMediaObject:e}){const t=new p.AnswerMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,sctpParameters:this._sctpParameters,plainRtpParameters:this._plainRtpParameters,offerMediaObject:e});this._addMediaSection(t)}receiveSctpAssociation({oldDataChannelSpec:e=!1}={}){const t=new p.OfferMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,sctpParameters:this._sctpParameters,plainRtpParameters:this._plainRtpParameters,mid:"datachannel",kind:"application",oldDataChannelSpec:e});this._addMediaSection(t)}getSdp(){return this._sdpObject.origin.sessionVersion++,this._sdpObject.media.sort((function(e,t){return e.mid-t.mid})),n.write(this._sdpObject)}_addMediaSection(e){this._firstMid||(this._firstMid=e.mid),this._mediaSections.push(e),this._midToIndex.set(e.mid,this._mediaSections.length-1),this._sdpObject.media.push(e.getObject()),this._regenerateBundleMids()}_replaceMediaSection(e,t){if("string"==typeof t){const i=this._midToIndex.get(t);if(void 0===i){let e=`_replaceMediaSection: no media section found for reuseMid '${t}'`,i=`_replaceMediaSection: media 中找不到 reuseMid '${t}'`,r="Please contact CommsEase technical support",s="请联系云信技术支持",a=d.IS_ZH?i:e,o=d.IS_ZH?s:r;throw new l.default({code:c.default.SDP_ERROR,message:a,advice:o})}const r=this._mediaSections[i];this._mediaSections[i]=e,this._midToIndex.delete(r.mid),this._midToIndex.set(e.mid,i),this._sdpObject.media[i]=e.getObject(),this._regenerateBundleMids()}else{const t=this._midToIndex.get(e.mid);if(void 0===t){let t=`_replaceMediaSection: no media section found with mid '${e.mid}'`,i=`_replaceMediaSection: media 中找不到 mid '${e.mid}'`,r="Please contact CommsEase technical support",s="请联系云信技术支持",a=d.IS_ZH?i:t,o=d.IS_ZH?s:r;throw new l.default({code:c.default.SDP_ERROR,message:a,advice:o})}this._mediaSections[t]=e,this._sdpObject.media[t]=e.getObject()}}_regenerateBundleMids(){this._dtlsParameters&&(this._sdpObject.groups[0].mids=this._mediaSections.filter(e=>!e.closed).map(e=>e.mid).join(" "))}}},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.addLegacySimulcast=t.getRtpEncodings=void 0;const n=o(i(11)),d=o(i(12)),c=a(i(2));t.getRtpEncodings=function({offerMediaObject:e}){const t=new Set;for(const i of e.ssrcs||[]){const e=i.id;t.add(e)}if(0===t.size){let e="getRtpEncodings: no a=ssrc lines found",t="getRtpEncodings: a=ssrc 行未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=c.IS_ZH?t:e,a=c.IS_ZH?r:i;throw new d.default({code:n.default.SDP_ERROR,message:s,advice:a})}const i=new Map;for(const r of e.ssrcGroups||[]){if("FID"!==r.semantics)continue;let[e,s]=r.ssrcs.split(/\s+/);e=Number(e),s=Number(s),t.has(e)&&(t.delete(e),t.delete(s),i.set(e,s))}for(const e of t)i.set(e,null);const r=[];for(const[e,t]of i){const i={ssrc:e};t&&(i.rtx={ssrc:t}),r.push(i)}return r},t.addLegacySimulcast=function({offerMediaObject:e,numStreams:t}){if(t<=1)throw new TypeError("numStreams must be greater than 1");const i=(e.ssrcs||[]).find(e=>"msid"===e.attribute);if(!i){let e="addLegacySimulcast: a=ssrc line with msid information is not found",t="addLegacySimulcast: a=ssrc 行的 msid 信息未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=c.IS_ZH?t:e,a=c.IS_ZH?r:i;throw new d.default({code:n.default.SDP_ERROR,message:s,advice:a})}const[r,s]=i.value.split(" "),a=i.id;let o;(e.ssrcGroups||[]).some(e=>{if("FID"!==e.semantics)return!1;const t=e.ssrcs.split(/\s+/);return Number(t[0])===a&&(o=Number(t[1]),!0)});const l=e.ssrcs.find(e=>"cname"===e.attribute);if(!l){let e="addLegacySimulcast: a=ssrc line with cname information is not found",t="addLegacySimulcast: a=ssrc 行的 cname 信息未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=c.IS_ZH?t:e,a=c.IS_ZH?r:i;throw new d.default({code:n.default.SDP_ERROR,message:s,advice:a})}const u=l.value,h=[],p=[];for(let e=0;e<t;++e)h.push(a+e),o&&p.push(o+e);e.ssrcGroups=[],e.ssrcs=[],e.ssrcGroups.push({semantics:"SIM",ssrcs:h.join(" ")});for(let t=0;t<h.length;++t){const i=h[t];e.ssrcs.push({id:i,attribute:"cname",value:u}),e.ssrcs.push({id:i,attribute:"msid",value:`${r} ${s}`})}for(let t=0;t<p.length;++t){const i=h[t],a=p[t];e.ssrcs.push({id:a,attribute:"cname",value:u}),e.ssrcs.push({id:a,attribute:"msid",value:`${r} ${s}`}),e.ssrcGroups.push({semantics:"FID",ssrcs:`${i} ${a}`})}}},function(e,t,i){e.exports=u;var r,s=i(57),a=s.LongBits,o=s.base64,n=s.utf8;function d(e,t,i){this.fn=e,this.len=t,this.next=void 0,this.val=i}function c(){}function l(e){this.head=e.head,this.tail=e.tail,this.len=e.len,this.next=e.states}function u(){this.len=0,this.head=new d(c,0,0),this.tail=this.head,this.states=null}var h=function(){return s.Buffer?function(){return(u.create=function(){return new r})()}:function(){return new u}};function p(e,t,i){t[i]=255&e}function m(e,t){this.len=e,this.next=void 0,this.val=t}function f(e,t,i){for(;e.hi;)t[i++]=127&e.lo|128,e.lo=(e.lo>>>7|e.hi<<25)>>>0,e.hi>>>=7;for(;e.lo>127;)t[i++]=127&e.lo|128,e.lo=e.lo>>>7;t[i++]=e.lo}function g(e,t,i){t[i]=255&e,t[i+1]=e>>>8&255,t[i+2]=e>>>16&255,t[i+3]=e>>>24}u.create=h(),u.alloc=function(e){return new s.Array(e)},s.Array!==Array&&(u.alloc=s.pool(u.alloc,s.Array.prototype.subarray)),u.prototype._push=function(e,t,i){return this.tail=this.tail.next=new d(e,t,i),this.len+=t,this},m.prototype=Object.create(d.prototype),m.prototype.fn=function(e,t,i){for(;e>127;)t[i++]=127&e|128,e>>>=7;t[i]=e},u.prototype.uint32=function(e){return this.len+=(this.tail=this.tail.next=new m((e>>>=0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this},u.prototype.int32=function(e){return e<0?this._push(f,10,a.fromNumber(e)):this.uint32(e)},u.prototype.sint32=function(e){return this.uint32((e<<1^e>>31)>>>0)},u.prototype.uint64=function(e){var t=a.from(e);return this._push(f,t.length(),t)},u.prototype.int64=u.prototype.uint64,u.prototype.sint64=function(e){var t=a.from(e).zzEncode();return this._push(f,t.length(),t)},u.prototype.bool=function(e){return this._push(p,1,e?1:0)},u.prototype.fixed32=function(e){return this._push(g,4,e>>>0)},u.prototype.sfixed32=u.prototype.fixed32,u.prototype.fixed64=function(e){var t=a.from(e);return this._push(g,4,t.lo)._push(g,4,t.hi)},u.prototype.sfixed64=u.prototype.fixed64,u.prototype.float=function(e){return this._push(s.float.writeFloatLE,4,e)},u.prototype.double=function(e){return this._push(s.float.writeDoubleLE,8,e)};var v=s.Array.prototype.set?function(e,t,i){t.set(e,i)}:function(e,t,i){for(var r=0;r<e.length;++r)t[i+r]=e[r]};u.prototype.bytes=function(e){var t=e.length>>>0;if(!t)return this._push(p,1,0);if(s.isString(e)){var i=u.alloc(t=o.length(e));o.decode(e,i,0),e=i}return this.uint32(t)._push(v,t,e)},u.prototype.string=function(e){var t=n.length(e);return t?this.uint32(t)._push(n.write,t,e):this._push(p,1,0)},u.prototype.fork=function(){return this.states=new l(this),this.head=this.tail=new d(c,0,0),this.len=0,this},u.prototype.reset=function(){return this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new d(c,0,0),this.len=0),this},u.prototype.ldelim=function(){var e=this.head,t=this.tail,i=this.len;return this.reset().uint32(i),i&&(this.tail.next=e.next,this.tail=t,this.len+=i),this},u.prototype.finish=function(){for(var e=this.head.next,t=this.constructor.alloc(this.len),i=0;e;)e.fn(e.val,t,i),i+=e.len,e=e.next;return t},u._configure=function(e){r=e,u.create=h(),r._configure()}},function(e,t,i){e.exports=d;var r,s=i(57),a=s.LongBits,o=s.utf8;function n(e,t){return RangeError("index out of range: "+e.pos+" + "+(t||1)+" > "+e.len)}function d(e){this.buf=e,this.pos=0,this.len=e.length}var c,l="undefined"!=typeof Uint8Array?function(e){if(e instanceof Uint8Array||Array.isArray(e))return new d(e);throw Error("illegal buffer")}:function(e){if(Array.isArray(e))return new d(e);throw Error("illegal buffer")},u=function(){return s.Buffer?function(e){return(d.create=function(e){return s.Buffer.isBuffer(e)?new r(e):l(e)})(e)}:l};function h(){var e=new a(0,0),t=0;if(!(this.len-this.pos>4)){for(;t<3;++t){if(this.pos>=this.len)throw n(this);if(e.lo=(e.lo|(127&this.buf[this.pos])<<7*t)>>>0,this.buf[this.pos++]<128)return e}return e.lo=(e.lo|(127&this.buf[this.pos++])<<7*t)>>>0,e}for(;t<4;++t)if(e.lo=(e.lo|(127&this.buf[this.pos])<<7*t)>>>0,this.buf[this.pos++]<128)return e;if(e.lo=(e.lo|(127&this.buf[this.pos])<<28)>>>0,e.hi=(e.hi|(127&this.buf[this.pos])>>4)>>>0,this.buf[this.pos++]<128)return e;if(t=0,this.len-this.pos>4){for(;t<5;++t)if(e.hi=(e.hi|(127&this.buf[this.pos])<<7*t+3)>>>0,this.buf[this.pos++]<128)return e}else for(;t<5;++t){if(this.pos>=this.len)throw n(this);if(e.hi=(e.hi|(127&this.buf[this.pos])<<7*t+3)>>>0,this.buf[this.pos++]<128)return e}throw Error("invalid varint encoding")}function p(e,t){return(e[t-4]|e[t-3]<<8|e[t-2]<<16|e[t-1]<<24)>>>0}function m(){if(this.pos+8>this.len)throw n(this,8);return new a(p(this.buf,this.pos+=4),p(this.buf,this.pos+=4))}d.create=u(),d.prototype._slice=s.Array.prototype.subarray||s.Array.prototype.slice,d.prototype.uint32=(c=4294967295,function(){if(c=(127&this.buf[this.pos])>>>0,this.buf[this.pos++]<128)return c;if(c=(c|(127&this.buf[this.pos])<<7)>>>0,this.buf[this.pos++]<128)return c;if(c=(c|(127&this.buf[this.pos])<<14)>>>0,this.buf[this.pos++]<128)return c;if(c=(c|(127&this.buf[this.pos])<<21)>>>0,this.buf[this.pos++]<128)return c;if(c=(c|(15&this.buf[this.pos])<<28)>>>0,this.buf[this.pos++]<128)return c;if((this.pos+=5)>this.len)throw this.pos=this.len,n(this,10);return c}),d.prototype.int32=function(){return 0|this.uint32()},d.prototype.sint32=function(){var e=this.uint32();return e>>>1^-(1&e)|0},d.prototype.bool=function(){return 0!==this.uint32()},d.prototype.fixed32=function(){if(this.pos+4>this.len)throw n(this,4);return p(this.buf,this.pos+=4)},d.prototype.sfixed32=function(){if(this.pos+4>this.len)throw n(this,4);return 0|p(this.buf,this.pos+=4)},d.prototype.float=function(){if(this.pos+4>this.len)throw n(this,4);var e=s.float.readFloatLE(this.buf,this.pos);return this.pos+=4,e},d.prototype.double=function(){if(this.pos+8>this.len)throw n(this,4);var e=s.float.readDoubleLE(this.buf,this.pos);return this.pos+=8,e},d.prototype.bytes=function(){var e=this.uint32(),t=this.pos,i=this.pos+e;if(i>this.len)throw n(this,e);return this.pos+=e,Array.isArray(this.buf)?this.buf.slice(t,i):t===i?new this.buf.constructor(0):this._slice.call(this.buf,t,i)},d.prototype.string=function(){var e=this.bytes();return o.read(e,0,e.length)},d.prototype.skip=function(e){if("number"==typeof e){if(this.pos+e>this.len)throw n(this,e);this.pos+=e}else do{if(this.pos>=this.len)throw n(this)}while(128&this.buf[this.pos++]);return this},d.prototype.skipType=function(e){switch(e){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;4!=(e=7&this.uint32());)this.skipType(e);break;case 5:this.skip(4);break;default:throw Error("invalid wire type "+e+" at offset "+this.pos)}return this},d._configure=function(e){r=e,d.create=u(),r._configure();var t=s.Long?"toLong":"toNumber";s.merge(d.prototype,{int64:function(){return h.call(this)[t](!1)},uint64:function(){return h.call(this)[t](!0)},sint64:function(){return h.call(this).zzDecode()[t](!1)},fixed64:function(){return m.call(this)[t](!0)},sfixed64:function(){return m.call(this)[t](!1)}})}},function(e,t,i){e.exports=s;var r=i(57);function s(e){if(e)for(var t=Object.keys(e),i=0;i<t.length;++i)this[t[i]]=e[t[i]]}s.create=function(e){return this.$type.create(e)},s.encode=function(e,t){return this.$type.encode(e,t)},s.encodeDelimited=function(e,t){return this.$type.encodeDelimited(e,t)},s.decode=function(e){return this.$type.decode(e)},s.decodeDelimited=function(e){return this.$type.decodeDelimited(e)},s.verify=function(e){return this.$type.verify(e)},s.fromObject=function(e){return this.$type.fromObject(e)},s.toObject=function(e,t){return this.$type.toObject(e,t)},s.prototype.toJSON=function(){return this.$type.toObject(this,r.toJSONOptions)}},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ajax=t.getFormData=void 0;const n=o(i(11)),d=o(i(12)),c=a(i(2));var l=i(142);t.getFormData=e=>Object.keys(e).map(t=>encodeURIComponent(t)+"="+encodeURIComponent(/Object/i.test(e[t])?JSON.stringify(e[t]):e[t])).join("&"),t.ajax=function(e){if(!e||!e.url){let e="ajax: parameter is not valid",t="ajax: 参数异常",i="Please input the correct parameter",r="请输入正确的参数",s=c.IS_ZH?t:e,a=c.IS_ZH?r:i;return Promise.reject(new d.default({code:n.default.NETWORK_REQUEST_ERROR,message:s,advice:a}))}e.dataType=e.dataType||"json";var i=new XMLHttpRequest;i.open(e.type||"GET",e.url,!0),i.responseType=""+e.dataType;const r=e.contentType||"application/json;charset=UTF-8";return i.setRequestHeader("Content-type",r),e.header&&Object.keys(e.header).map(t=>{e.header&&e.header[t]&&i.setRequestHeader(t,e.header[t])}),new Promise((s,a)=>{i.onload=function(){if(i.status>400){let e="ajax: response error",t="ajax: 相应异常",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=c.IS_ZH?t:e,a=c.IS_ZH?r:i;return Promise.reject(new d.default({code:n.default.NETWORK_REQUEST_ERROR,message:s,advice:a}))}var e=i.response;s(e)},i.onerror=function(e){a(e)},i.ontimeout=function(t){a({code:456,desc:"ERR_TIMED_OUT "+e.url})},r.indexOf("x-www-form-urlencoded")>=0?e.data?i.send(t.getFormData(e.data)):i.send():e.data?e.header&&"gzip"===e.header["Content-Encoding"]?i.send(e.data):i.send(l.stringify(e.data)):i.send()})}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.StageBase=void 0;t.StageBase=class{constructor(e){this.enabled=!1,this.node=null,this.state="UNINIT",this.context=e}isTransparent(){return!1}}},function(e,t,i){function r(e,t){return{ARRAY_BUFFER:e.ARRAY_BUFFER,ELEMENT_ARRAY_BUFFER:e.ELEMENT_ARRAY_BUFFER}[null!=t?t:"ARRAY_BUFFER"]}function s(e,t){return{STATIC_DRAW:e.STATIC_DRAW,DYNAMIC_DRAW:e.DYNAMIC_DRAW,STREAM_DRAW:e.STREAM_DRAW}[null!=t?t:"STATIC_DRAW"]}function a(e,t){const i={Int8Array:e.BYTE,Uint8Array:e.UNSIGNED_BYTE,Int16Array:e.SHORT,Uint16Array:e.UNSIGNED_SHORT,Int32Array:e.INT,Uint32Array:e.UNSIGNED_INT,Float32Array:e.FLOAT}[Object.prototype.toString.call(t).replace(/object|\[|\]|\s/g,"")];return void 0===i?(console.warn("attribute buffer type error.\n legal type may << Int8Array、Uint8Array、Int16Array、Uint16Array、Float32Array."),e.FLOAT):i}Object.defineProperty(t,"__esModule",{value:!0}),t.parseAttributes=t.createAttributeBuffer=void 0,t.createAttributeBuffer=function(e,t,i,o,n,d,c,l,u){const h=e.createBuffer();if(!h)return console.error("buffer created failed."),null;const p=i.length;return{type:a(e,i),buffer:h,name:t,typedArray:i,itemSize:null!=o?o:1,count:p/(null!=o?o:1)>>0,normalized:null!=c&&c,target:r(e,n),usage:s(e,d),stride:null!=l?l:0,offset:null!=u?u:0}},t.parseAttributes=function(e,t){const i=e.getProgramParameter(t,e.ACTIVE_ATTRIBUTES),o={};for(let n=0;n<i;n++){const i=e.getActiveAttrib(t,n);if(i){const{name:n}=i,d=e.getAttribLocation(t,n);if(null!==d){const t={type:e.FLOAT,buffer:null,typedArray:null,itemSize:1,count:0,normalized:!1,target:r(e),usage:s(e),stride:0,offset:0,setter:i=>{if(i){const{buffer:r}=t;if(!r)return void console.error(`buffer of attribute:[${n}] is not initialized.`);const{type:s}=t;if(a(e,i)!==s)return void console.error(`typedArray's type of attribute:[${n}] is inconsistent.`);t.typedArray=i;const{itemSize:o,normalized:c,target:l,usage:u,stride:h,offset:p}=t;e.bindBuffer(l,r),e.bufferData(l,i,u),e.enableVertexAttribArray(d),e.vertexAttribPointer(d,o,s,c,h,p)}else{const{buffer:i,type:r,itemSize:s,normalized:a,target:o,stride:n,offset:c}=t;e.bindBuffer(o,i),e.vertexAttribPointer(d,s,r,a,n,c)}},bufferSetter:e=>{if(e){const{name:i}=e;i===n&&(t.type=e.type,t.buffer=e.buffer,t.itemSize=e.itemSize,t.count=e.count,t.normalized=e.normalized,t.target=e.target,t.usage=e.usage,t.stride=e.stride,t.offset=e.offset,t.setter(e.typedArray))}},get attributeBuffer(){return null===t.buffer?null:{type:t.type,buffer:t.buffer,name:n,typedArray:t.typedArray,itemSize:t.itemSize,count:t.count,normalized:t.normalized,target:t.target,usage:t.usage,stride:t.stride,offset:t.offset}}};o[n]=t}else console.warn(`attribute:[${n}] is null.`)}}return o}},,,function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.checkSystemRequirements=t.systemChecker=void 0;const r=i(145);t.systemChecker=new class{constructor(){this.checkCnt=0}checkSystemRequirements(){return this.checkCnt++,window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection?navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?window.WebSocket?!!r.isBrowserSupported()||(console.warn("checkSystemRequirements: 不支持的浏览器。当前的 UserAgent为 "+navigator.userAgent),!1):(console.warn("checkSystemRequirements: 没有 WebSocket 对象。"),!1):(console.warn("checkSystemRequirements: 没有 getUserMedia 方法。请检查https是否启用。"),!1):(console.warn("checkSystemRequirements: 没有 RTCPeerConnection 对象。"),!1)}},t.checkSystemRequirements=function(){return t.systemChecker.checkSystemRequirements()}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.AuidoMixingState=void 0,t.AuidoMixingState={UNSTART:"MIX_UNSTART",STARTING:"MIX_STARTING",PLAYED:"MIX_PLAYING",PAUSED:"MIX_PAUSED",STOPED:"MIX_STOPED"}},function(e,t){var i={utf8:{stringToBytes:function(e){return i.bin.stringToBytes(unescape(encodeURIComponent(e)))},bytesToString:function(e){return decodeURIComponent(escape(i.bin.bytesToString(e)))}},bin:{stringToBytes:function(e){for(var t=[],i=0;i<e.length;i++)t.push(255&e.charCodeAt(i));return t},bytesToString:function(e){for(var t=[],i=0;i<e.length;i++)t.push(String.fromCharCode(e[i]));return t.join("")}}};e.exports=i},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.parseScalabilityMode=t.Device=t.detectDevice=t.version=t.types=void 0;const o=i(165);Object.defineProperty(t,"detectDevice",{enumerable:!0,get:function(){return o.detectDevice}}),Object.defineProperty(t,"Device",{enumerable:!0,get:function(){return o.Device}});const n=a(i(229));t.types=n,t.version="__MEDIASOUP_CLIENT_VERSION__";var d=i(232);Object.defineProperty(t,"parseScalabilityMode",{enumerable:!0,get:function(){return d.parse}})},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.Device=t.detectDevice=void 0;const o=i(121),n=i(122),d=i(218),c=i(225),l=i(226),u=i(56),h=a(i(124)),p=i(169),m=a(i(71)),f=a(i(2)),g=i(67),v="Device";function _(){return"object"==typeof navigator&&"string"==typeof navigator.userAgent?f.IS_CHROME_ONLY&&f.CHROME_MAJOR_VERSION&&f.CHROME_MAJOR_VERSION>=72?"Chrome74":f.IS_FIREFOX&&f.FIREFOX_MAJOR_VERSION&&f.FIREFOX_MAJOR_VERSION>=60?"Firefox60":f.IS_ANY_SAFARI&&f.SAFARI_MAJOR_VERSION&&f.SAFARI_MAJOR_VERSION>=12?"Safari12":(u.Logger.warn(v,"this._detectDevice() | browser not supported [name:%s, version:%s], using Chrome72 as default",g.getBrowserInfo().browserName,g.getBrowserInfo().browserVersion),"Chrome74"):(u.Logger.warn(v,"this._detectDevice() | unknown device, using Chrome 72 as default"),"Chrome74")}t.detectDevice=_;t.Device=class{constructor({handlerName:e,handlerFactory:t,Handler:i}={}){if(this._loaded=!1,this._observer=new o.EnhancedEventEmitter,u.Logger.debug(v,"constructor()"),i){if(u.Logger.warn(v,"constructor() | Handler option is DEPRECATED, use handlerName or handlerFactory instead"),"string"!=typeof i)throw new TypeError("non string Handler option no longer supported, use handlerFactory instead");e=i}if(e&&t)throw new TypeError("just one of handlerName or handlerInterface can be given");if(t)this._handlerFactory=t;else{if(e)u.Logger.debug(v,"constructor() | handler given: %s",e);else{if(!(e=_()))throw new n.UnsupportedError("device not supported");u.Logger.debug(v,"constructor() | detected handler: %s",e)}switch(e){case"Chrome74":this._handlerFactory=d.Chrome74.createFactory();break;case"Safari12":this._handlerFactory=l.Safari12.createFactory();break;case"Firefox60":this._handlerFactory=c.Firefox60.createFactory();break;default:u.Logger.warn(`unknown browser handlerName "${e}, using Chrome 74 as default"`),this._handlerFactory=d.Chrome74.createFactory()}}const r=this._handlerFactory();this._handlerName=r.name,r.close(),this._extendedRtpCapabilities=void 0,this._recvRtpCapabilities=void 0,this._canProduceByKind={audio:!1,video:!1},this._sctpCapabilities=void 0}get handlerName(){return this._handlerName}get loaded(){return this._loaded}get rtpCapabilities(){if(!this._loaded)throw new n.InvalidStateError("not loaded");return this._recvRtpCapabilities}get sctpCapabilities(){if(!this._loaded)throw new n.InvalidStateError("not loaded");return this._sctpCapabilities}get observer(){return this._observer}async load({routerRtpCapabilities:e}){let t;u.Logger.debug(v,"load()"),e=m.clone(e,void 0);try{if(this._loaded)throw new n.InvalidStateError("already loaded");h.validateRtpCapabilities(e),t=this._handlerFactory();const i=await t.getNativeRtpCapabilities();u.Logger.debug(v,"load() | got native RTP capabilities"),h.validateRtpCapabilities(i),this._extendedRtpCapabilities=h.getExtendedRtpCapabilities(i,e),u.Logger.debug(v,"load() | got extended RTP capabilities"),this._canProduceByKind.audio=h.canSend("audio",this._extendedRtpCapabilities),this._canProduceByKind.video=h.canSend("video",this._extendedRtpCapabilities),this._recvRtpCapabilities=h.getRecvRtpCapabilities(this._extendedRtpCapabilities),h.validateRtpCapabilities(this._recvRtpCapabilities),u.Logger.debug(v,"load() | got receiving RTP capabilities"),this._sctpCapabilities=await t.getNativeSctpCapabilities(),u.Logger.debug(v,"load() | got native SCTP capabilities"),h.validateSctpCapabilities(this._sctpCapabilities),u.Logger.debug(v,"load() succeeded"),this._loaded=!0,t.close()}catch(e){throw t&&t.close(),e}}canProduce(e){if(!this._loaded)throw new n.InvalidStateError("not loaded");if("audio"!==e&&"video"!==e)throw new TypeError(`invalid kind "${e}"`);return this._canProduceByKind[e]}createSendTransport({id:e,iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s,iceServers:a,iceTransportPolicy:o,additionalSettings:n,proprietaryConstraints:d,appData:c={}}){return u.Logger.debug(v,"createSendTransport()"),this._createTransport({direction:"send",id:e,iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s,iceServers:a,iceTransportPolicy:o,additionalSettings:n,proprietaryConstraints:d,appData:c})}createRecvTransport({id:e,iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s,iceServers:a,iceTransportPolicy:o,additionalSettings:n,proprietaryConstraints:d,appData:c={}}){return u.Logger.debug(v,"createRecvTransport()"),this._createTransport({direction:"recv",id:e,iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s,iceServers:a,iceTransportPolicy:o,additionalSettings:n,proprietaryConstraints:d,appData:c})}_createTransport({direction:e,id:t,iceParameters:i,iceCandidates:r,dtlsParameters:s,sctpParameters:a,iceServers:o,iceTransportPolicy:d,additionalSettings:c,proprietaryConstraints:l,appData:u={}}){if(!this._loaded)throw new n.InvalidStateError("not loaded");if(u&&"object"!=typeof u)throw new TypeError("if given, appData must be an object");const h=new p.Transport({direction:e,id:t,iceParameters:i,iceCandidates:r,dtlsParameters:s,sctpParameters:a,iceServers:o,iceTransportPolicy:d,additionalSettings:c,proprietaryConstraints:l,appData:u,handlerFactory:this._handlerFactory,extendedRtpCapabilities:this._extendedRtpCapabilities,canProduceByKind:this._canProduceByKind});return this._observer.safeEmit("newtransport",h),h}}},function(e,t,i){var r,s="object"==typeof Reflect?Reflect:null,a=s&&"function"==typeof s.apply?s.apply:function(e,t,i){return Function.prototype.apply.call(e,t,i)};r=s&&"function"==typeof s.ownKeys?s.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var o=Number.isNaN||function(e){return e!=e};function n(){n.init.call(this)}e.exports=n,e.exports.once=function(e,t){return new Promise((function(i,r){function s(i){e.removeListener(t,a),r(i)}function a(){"function"==typeof e.removeListener&&e.removeListener("error",s),i([].slice.call(arguments))}v(e,t,a,{once:!0}),"error"!==t&&function(e,t,i){"function"==typeof e.on&&v(e,"error",t,i)}(e,s,{once:!0})}))},n.EventEmitter=n,n.prototype._events=void 0,n.prototype._eventsCount=0,n.prototype._maxListeners=void 0;var d=10;function c(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function l(e){return void 0===e._maxListeners?n.defaultMaxListeners:e._maxListeners}function u(e,t,i,r){var s,a,o,n;if(c(i),void 0===(a=e._events)?(a=e._events=Object.create(null),e._eventsCount=0):(void 0!==a.newListener&&(e.emit("newListener",t,i.listener?i.listener:i),a=e._events),o=a[t]),void 0===o)o=a[t]=i,++e._eventsCount;else if("function"==typeof o?o=a[t]=r?[i,o]:[o,i]:r?o.unshift(i):o.push(i),(s=l(e))>0&&o.length>s&&!o.warned){o.warned=!0;var d=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");d.name="MaxListenersExceededWarning",d.emitter=e,d.type=t,d.count=o.length,n=d,console&&console.warn&&console.warn(n)}return e}function h(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function p(e,t,i){var r={fired:!1,wrapFn:void 0,target:e,type:t,listener:i},s=h.bind(r);return s.listener=i,r.wrapFn=s,s}function m(e,t,i){var r=e._events;if(void 0===r)return[];var s=r[t];return void 0===s?[]:"function"==typeof s?i?[s.listener||s]:[s]:i?function(e){for(var t=new Array(e.length),i=0;i<t.length;++i)t[i]=e[i].listener||e[i];return t}(s):g(s,s.length)}function f(e){var t=this._events;if(void 0!==t){var i=t[e];if("function"==typeof i)return 1;if(void 0!==i)return i.length}return 0}function g(e,t){for(var i=new Array(t),r=0;r<t;++r)i[r]=e[r];return i}function v(e,t,i,r){if("function"==typeof e.on)r.once?e.once(t,i):e.on(t,i);else{if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,(function s(a){r.once&&e.removeEventListener(t,s),i(a)}))}}Object.defineProperty(n,"defaultMaxListeners",{enumerable:!0,get:function(){return d},set:function(e){if("number"!=typeof e||e<0||o(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");d=e}}),n.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},n.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||o(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},n.prototype.getMaxListeners=function(){return l(this)},n.prototype.emit=function(e){for(var t=[],i=1;i<arguments.length;i++)t.push(arguments[i]);var r="error"===e,s=this._events;if(void 0!==s)r=r&&void 0===s.error;else if(!r)return!1;if(r){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var n=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw n.context=o,n}var d=s[e];if(void 0===d)return!1;if("function"==typeof d)a(d,this,t);else{var c=d.length,l=g(d,c);for(i=0;i<c;++i)a(l[i],this,t)}return!0},n.prototype.addListener=function(e,t){return u(this,e,t,!1)},n.prototype.on=n.prototype.addListener,n.prototype.prependListener=function(e,t){return u(this,e,t,!0)},n.prototype.once=function(e,t){return c(t),this.on(e,p(this,e,t)),this},n.prototype.prependOnceListener=function(e,t){return c(t),this.prependListener(e,p(this,e,t)),this},n.prototype.removeListener=function(e,t){var i,r,s,a,o;if(c(t),void 0===(r=this._events))return this;if(void 0===(i=r[e]))return this;if(i===t||i.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete r[e],r.removeListener&&this.emit("removeListener",e,i.listener||t));else if("function"!=typeof i){for(s=-1,a=i.length-1;a>=0;a--)if(i[a]===t||i[a].listener===t){o=i[a].listener,s=a;break}if(s<0)return this;0===s?i.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(i,s),1===i.length&&(r[e]=i[0]),void 0!==r.removeListener&&this.emit("removeListener",e,o||t)}return this},n.prototype.off=n.prototype.removeListener,n.prototype.removeAllListeners=function(e){var t,i,r;if(void 0===(i=this._events))return this;if(void 0===i.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==i[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete i[e]),this;if(0===arguments.length){var s,a=Object.keys(i);for(r=0;r<a.length;++r)"removeListener"!==(s=a[r])&&this.removeAllListeners(s);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=i[e]))this.removeListener(e,t);else if(void 0!==t)for(r=t.length-1;r>=0;r--)this.removeListener(e,t[r]);return this},n.prototype.listeners=function(e){return m(this,e,!0)},n.prototype.rawListeners=function(e){return m(this,e,!1)},n.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):f.call(e,t)},n.prototype.listenerCount=f,n.prototype.eventNames=function(){return this._eventsCount>0?r(this._events):[]}},function(e,t){var i=e.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return null!=e.address?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return null!=e.subtype?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return null!=e.sessionConfig?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=null!=e.raddr?" raddr %s rport %d":"%v%v",t+=null!=e.tcptype?" tcptype %s":"%v",null!=e.generation&&(t+=" generation %d"),t+=null!=e["network-id"]?" network-id %d":"%v",t+=null!=e["network-cost"]?" network-cost %d":"%v"}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return null!=e.attribute&&(t+=" %s",null!=e.value&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return null!=e.maxMessageSize?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return"ts-refclk:%s"+(null!=e.clksrcExt?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){var t="mediaclk:";return t+=null!=e.id?"id=%s %s":"%v%s",t+=null!=e.mediaClockValue?"=%s":"",t+=null!=e.rateNumerator?" rate=%s":"",t+=null!=e.rateDenominator?"/%s":""}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(i).forEach((function(e){i[e].forEach((function(e){e.reg||(e.reg=/(.*)/),e.format||(e.format="%s")}))}))},function(e,t,i){(function(r){t.formatArgs=function(t){if(t[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+t[0]+(this.useColors?"%c ":" ")+"+"+e.exports.humanize(this.diff),!this.useColors)return;const i="color: "+this.color;t.splice(1,0,i,"color: inherit");let r=0,s=0;t[0].replace(/%[a-zA-Z%]/g,e=>{"%%"!==e&&(r++,"%c"===e&&(s=r))}),t.splice(s,0,i)},t.save=function(e){try{e?t.storage.setItem("debug",e):t.storage.removeItem("debug")}catch(e){}},t.load=function(){let e;try{e=t.storage.getItem("debug")}catch(e){}!e&&void 0!==r&&"env"in r&&(e=r.env.DEBUG);return e},t.useColors=function(){if("undefined"!=typeof window&&window.process&&("renderer"===window.process.type||window.process.__nwjs))return!0;if("undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;return"undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},t.storage=function(){try{return localStorage}catch(e){}}(),t.destroy=(()=>{let e=!1;return()=>{e||(e=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],t.log=console.debug||console.log||(()=>{}),e.exports=i(222)(t);const{formatters:s}=e.exports;s.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}}).call(this,i(63))},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Transport=void 0;const n=i(228),d=o(i(11)),c=o(i(12)),l=a(i(2)),u=i(170),h=i(121),p=i(122),m=i(56),f=a(i(124)),g=i(171),v=a(i(71)),_="Transport";class S extends h.EnhancedEventEmitter{constructor({direction:e,id:t,iceParameters:i,iceCandidates:r,dtlsParameters:s,sctpParameters:a,iceServers:o,iceTransportPolicy:d,additionalSettings:c,proprietaryConstraints:l,appData:u,handlerFactory:f,extendedRtpCapabilities:g,canProduceByKind:S}){super(),this._closed=!1,this._connectionState="new",this._producers=new Map,this._consumers=new Map,this._probatorConsumerCreated=!1,this._awaitQueue=new n.AwaitQueue({ClosedErrorClass:p.InvalidStateError}),this._observer=new h.EnhancedEventEmitter,this.send=[],this.recv=[],m.Logger.debug(_,`constructor() [id: ${t}, direction: ${e}]`),this._id=t,this._direction=e,this._extendedRtpCapabilities=g,this._canProduceByKind=S,this._maxSctpMessageSize=a?a.maxMessageSize:null,delete(c=v.clone(c,{})).iceServers,delete c.iceTransportPolicy,delete c.bundlePolicy,delete c.rtcpMuxPolicy,delete c.sdpSemantics,this._handler=f(),this._handler.run({direction:e,iceParameters:i,iceCandidates:r,dtlsParameters:s,sctpParameters:a,iceServers:o,iceTransportPolicy:d,additionalSettings:c,proprietaryConstraints:l,extendedRtpCapabilities:g,appData:u}),this._appData=u,this._handleHandler()}get id(){return this._id}get closed(){return this._closed}get direction(){return this._direction}get handler(){return this._handler}get connectionState(){return this._connectionState}get appData(){return this._appData}set appData(e){let t=l.IS_ZH?"Transport: appData override 异常":"Transport: cannot override appData object",i=l.IS_ZH?"请联系云信技术支持":"Please contact CommsEase technical support";throw new c.default({code:d.default.APPDATA_OVERRIDE_ERROR,message:t,advice:i})}get observer(){return this._observer}close(){if(!this._closed){m.Logger.debug(_,"close()"),this._closed=!0,this._awaitQueue.close(),this._handler.close();for(const e of this._producers.values())e.transportClosed();this._producers.clear();for(const e of this._consumers.values())e.transportClosed();this._consumers.clear(),this._observer.safeEmit("close")}}async getStats(){if(this._closed)throw new p.InvalidStateError("closed");return this._handler.getTransportStats()}async restartIce({iceParameters:e}){if(m.Logger.debug(_,"restartIce()"),this._closed)throw new p.InvalidStateError("closed");if(!e)throw new TypeError("missing iceParameters");return this._awaitQueue.push(async()=>this._handler.restartIce(e),"transport.restartIce()")}async updateIceServers({iceServers:e}={}){if(m.Logger.debug(_,"updateIceServers()"),this._closed)throw new p.InvalidStateError("closed");if(!Array.isArray(e))throw new TypeError("missing iceServers");return this._handler.updateIceServers(e)}async produce({track:e,trackLow:t,encodings:i,codecOptions:r,codec:s,stopTracks:a=!1,disableTrackOnPause:o=!0,zeroRtpOnPause:n=!1,appData:d}){if(m.Logger.debug(_,"produce()"),!e)throw new TypeError("missing track");if("send"!==this._direction)throw new p.UnsupportedError("not a sending Transport");if(!this._canProduceByKind[e.kind])throw new p.UnsupportedError("cannot produce "+e.kind);if("ended"===e.readyState)throw new p.InvalidStateError("track ended");if(0===this.listenerCount("produce"))throw new TypeError('no "produce" listener set into this transport');if(d&&"object"!=typeof d)throw new TypeError("if given, appData must be an object");return this._awaitQueue.push(async()=>{let c;if(i&&!Array.isArray(i))throw TypeError("encodings must be an array");i&&0===i.length?c=void 0:i&&(c=i.map(e=>{const t={active:!0};return!1===e.active&&(t.active=!1),"boolean"==typeof e.dtx&&(t.dtx=e.dtx),"string"==typeof e.scalabilityMode&&(t.scalabilityMode=e.scalabilityMode),"number"==typeof e.scaleResolutionDownBy&&(t.scaleResolutionDownBy=e.scaleResolutionDownBy),"number"==typeof e.maxBitrate&&(t.maxBitrate=e.maxBitrate),"number"==typeof e.maxFramerate&&(t.maxFramerate=e.maxFramerate),"boolean"==typeof e.adaptivePtime&&(t.adaptivePtime=e.adaptivePtime),"string"==typeof e.priority&&(t.priority=e.priority),"string"==typeof e.networkPriority&&(t.networkPriority=e.networkPriority),t}));const{localId:l,localIdLow:u,rtpParameters:h,rtpSender:p,rtpSenderLow:m,dtlsParameters:v,offer:_}=await this._handler.send({track:e,trackLow:t,encodings:c,codecOptions:r,appData:d,codec:s});p&&this.updateSenderInfo(p,"screenShare"===d.mediaType?"screen":d.mediaType,"high",l),m&&u&&this.updateSenderInfo(m,"screenShare"===d.mediaType?"screen":d.mediaType,"low",u);try{f.validateRtpParameters(h);const{id:i}=await this.safeEmitAsPromise("produce",{kind:e.kind,rtpParameters:h,track:e,trackLow:t,appData:d,localDtlsParameters:v,offer:_}),r=new g.Producer({id:i,localId:l,localIdLow:u,rtpSender:p,rtpSenderLow:m,track:e,trackLow:t,rtpParameters:h,stopTracks:a,disableTrackOnPause:o,zeroRtpOnPause:n,appData:d});return this._producers.set(r.id,r),this._handleProducer(r),this._observer.safeEmit("newproducer",r),r}catch(e){throw this._handler.stopSending(l,d.mediaType).catch(()=>{}),e}},"transport.produce()").catch(e=>{throw e})}async fillRemoteRecvSdp({kind:e,appData:t,iceParameters:i,iceCandidates:r,dtlsParameters:s,sctpParameters:a,sendingRtpParameters:o,codecOptions:n,offer:d,audioProfile:c,codec:l}){await this._handler.fillRemoteRecvSdp({kind:e,appData:t,iceParameters:i,iceCandidates:r,dtlsParameters:s,sctpParameters:a,sendingRtpParameters:o,codecOptions:n,offer:d,codec:l,audioProfile:c})}async prepareLocalSdp(e,t,i){try{const{dtlsParameters:r,rtpCapabilities:s,offer:a,mid:o,iceUfragReg:n}=await this._handler.prepareLocalSdp(e,i);if(!this._recvRtpCapabilities||!f.canSend("audio",this._recvRtpCapabilities)||!f.canSend("video",this._recvRtpCapabilities)){let e=f.getExtendedRtpCapabilities(s,t);this._recvRtpCapabilities=f.getRecvRtpCapabilities(e),f.validateRtpCapabilities(this._recvRtpCapabilities)}return{dtlsParameters:r,rtpCapabilities:this._recvRtpCapabilities,offer:a,mid:o,iceUfragReg:n}}catch(e){throw e}}async recoverLocalSdp(e,t,i){try{return void await this._handler.recoverTransceiver(e,t,i)}catch(e){throw e}}updateSenderInfo(e,t,i,r){let s=this.send.find(t=>t.sender===e);return s?(s.mediaType!==t||s.streamType||i||s.localId!==r)&&(m.Logger.debug(_,`Sender Change. mediaType:${s.mediaType} => ${t}, StreamType: ${s.streamType} => ${i}, LocalId: ${s.localId} => ${r} index: ${s.index}`),s.mediaType=t,s.streamType=i,s.localId=r,s.index=0):(s={sender:e,mediaType:t,streamType:i,localId:r,index:0},this.send.unshift(s)),s}updateReceiverInfo(e,t,i,r){let s=this.recv.find(t=>t.receiver===e);return s?s.uid===t&&s.mediaType===i&&s.localId===r||(m.Logger.debug(_,`Receiver Change. uid:${s.uid} => ${t}, mediaType:${s.mediaType} => ${i} localId: ${s.localId} => ${r} index: ${s.index}`),s.uid=t,s.mediaType=i,s.localId=r,s.index=0):(s={receiver:e,uid:t,mediaType:i,localId:r,index:0},this.recv.unshift(s)),s}async consume({id:e,producerId:t,kind:i,uid:r,mediaType:s,rtpParameters:a,appData:o={},offer:n,iceParameters:d,iceCandidates:c,dtlsParameters:l,sctpParameters:h,probeSSrc:f}){if(m.Logger.debug(_,"consume()"),a=v.clone(a,void 0),this._closed)throw new p.InvalidStateError("closed");if("recv"!==this._direction)throw new p.UnsupportedError("not a receiving Transport");if("string"!=typeof e)throw new TypeError("missing id");if("string"!=typeof t)throw new TypeError("missing producerId");if("audio"!==i&&"video"!==i)throw new TypeError(`invalid kind '${i}'`);if(o&&"object"!=typeof o)throw new TypeError("if given, appData must be an object");return this._awaitQueue.push(async()=>{const{localId:p,rtpReceiver:m,track:g}=await this._handler.receive({iceParameters:d,iceCandidates:c,dtlsParameters:l,sctpParameters:h,trackId:e,kind:i,rtpParameters:a,offer:n,probeSSrc:f,remoteUid:o.remoteUid,extendedRtpCapabilities:this._extendedRtpCapabilities,appData:o});m&&this.updateReceiverInfo(m,r,s,p);const v=new u.Consumer({id:e,localId:p,producerId:t,rtpReceiver:m,track:g,rtpParameters:a,appData:o});return this._consumers.set(v.id,v),this._handleConsumer(v),this._observer.safeEmit("newconsumer",v),v},"transport.consume()")}_handleHandler(){const e=this._handler;e.on("@connect",({dtlsParameters:e},t,i)=>{this._closed?i(new p.InvalidStateError("closed")):this.safeEmit("connect",{dtlsParameters:e},t,i)}),e.on("@connectionstatechange",e=>{e!==this._connectionState&&(m.Logger.debug(_,"connection state changed to %s",e),this._connectionState=e,this._closed||this.safeEmit("connectionstatechange",e))})}_handleProducer(e){e.on("@close",()=>{this._closed||(m.Logger.warn(_,"producer 关闭: ",e.localId),this._awaitQueue.push(async()=>this._handler.stopSending(e.localId,e.appData.mediaType)).catch(e=>m.Logger.warn(_,"producer.close() failed:%o",e)))}),e.on("@replacetrack",(t,i,r)=>{this._awaitQueue.push(async()=>this._handler.replaceTrack(e.localId,t),"producer @replacetrack event").then(i).catch(r)}),e.on("@setmaxspatiallayer",(t,i,r)=>{this._awaitQueue.push(async()=>this._handler.setMaxSpatialLayer(e.localId,t),"producer @setmaxspatiallayer event").then(i).catch(r)}),e.on("@setrtpencodingparameters",(t,i,r)=>{this._awaitQueue.push(async()=>this._handler.setRtpEncodingParameters(e.localId,t),"producer @setrtpencodingparameters event").then(i).catch(r)}),e.on("@getstats",(t,i)=>{if(this._closed)return i(new p.InvalidStateError("closed"));this._handler.getSenderStats(e.localId).then(t).catch(i)})}_handleConsumer(e){e.on("@close",()=>{this._consumers.delete(e.id),this._closed||this._awaitQueue.push(async()=>this._handler.stopReceiving(e.localId),"consumer @close event").catch(()=>{})}),e.on("@getstats",(t,i)=>{if(this._closed)return i(new p.InvalidStateError("closed"));this._handler.getReceiverStats(e.localId).then(t).catch(i)})}}t.Transport=S},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Consumer=void 0;const n=o(i(11)),d=o(i(12)),c=a(i(2)),l=i(121),u=i(122),h=i(56),p="Consumer";class m extends l.EnhancedEventEmitter{constructor({id:e,localId:t,producerId:i,rtpReceiver:r,track:s,rtpParameters:a,appData:o}){super(),this._closed=!1,this._observer=new l.EnhancedEventEmitter,h.Logger.debug(p,"constructor()"),this._id=e,this._localId=t,this._producerId=i,this._rtpReceiver=r,this._track=s,this._rtpParameters=a,this._paused=!s.enabled,this._appData=o,this._onTrackEnded=this._onTrackEnded.bind(this),this._handleTrack()}get id(){return this._id}get localId(){return this._localId}get producerId(){return this._producerId}get closed(){return this._closed}get kind(){return this._track.kind}get rtpReceiver(){return this._rtpReceiver}get track(){return this._track}get rtpParameters(){return this._rtpParameters}get paused(){return this._paused}get appData(){return this._appData}set appData(e){let t=c.IS_ZH?"Consumer: appData override 异常":"Consumer: cannot override appData object",i=c.IS_ZH?"请联系云信技术支持":"Please contact CommsEase technical support";throw new d.default({code:n.default.APPDATA_OVERRIDE_ERROR,message:t,advice:i})}get observer(){return this._observer}close(){this._closed||(h.Logger.debug(p,"close()"),this._closed=!0,this._destroyTrack(),this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||(h.Logger.debug(p,"transportClosed()"),this._closed=!0,this._destroyTrack(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}async getStats(){if(this._closed)throw new u.InvalidStateError("closed");return this.safeEmitAsPromise("@getstats")}pause(){h.Logger.debug(p,"pause()"),this._closed?h.Logger.error(p,"pause() | Consumer closed"):(this._paused=!0,this._track.enabled=!1,this._observer.safeEmit("pause"))}resume(){h.Logger.debug(p,"resume()"),this._closed?h.Logger.error(p,"resume() | Consumer closed"):(this._paused=!1,this._track.enabled=!0,this._observer.safeEmit("resume"))}_onTrackEnded(){h.Logger.debug(p,'track "ended" event, %o, %s',this.id,this.kind),this.safeEmit("trackended"),this._observer.safeEmit("trackended")}_handleTrack(){this._track.addEventListener("ended",this._onTrackEnded)}_destroyTrack(){h.Logger.debug(p,"don not stop receiver track")}}t.Consumer=m},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Producer=void 0;const n=o(i(11)),d=o(i(12)),c=a(i(2)),l=i(5),u=i(121),h=i(122),p=i(56),m="Producer";class f extends u.EnhancedEventEmitter{constructor({id:e,localId:t,localIdLow:i,rtpSender:r,rtpSenderLow:s,track:a,trackLow:o,rtpParameters:n,stopTracks:d,disableTrackOnPause:c,zeroRtpOnPause:l,appData:h}){super(),this._closed=!1,this._observer=new u.EnhancedEventEmitter,p.Logger.debug(m,"constructor()",t),this._id=e,this._localId=t,this._localIdLow=i,this._rtpSender=r,this._rtpSenderLow=s,this._track=a,this._trackLow=o,this._kind=a.kind,this._rtpParameters=n,this._paused=!!c&&!a.enabled,this._maxSpatialLayer=void 0,this._stopTracks=d,this._disableTrackOnPause=c,this._zeroRtpOnPause=l,this._appData=h,this._onTrackEnded=this._onTrackEnded.bind(this),this._handleTrack()}get id(){return this._id}get localId(){return this._localId}get closed(){return this._closed}get kind(){return this._kind}get rtpSender(){return this._rtpSender}get track(){return this._track}get rtpParameters(){return this._rtpParameters}get paused(){return this._paused}get maxSpatialLayer(){return this._maxSpatialLayer}get appData(){return this._appData}set appData(e){let t=c.IS_ZH?"Producer: appData override 异常":"Producer: cannot override appData object",i=c.IS_ZH?"请联系云信技术支持":"Please contact CommsEase technical support";throw new d.default({code:n.default.APPDATA_OVERRIDE_ERROR,message:t,advice:i})}get observer(){return this._observer}close(){this._closed||(p.Logger.debug(m,"close()"),this._closed=!0,this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||(p.Logger.debug(m,"transportClosed()"),this._closed=!0,this.safeEmit("transportclose"),this._observer.safeEmit("close"))}async getStats(){if(this._closed)throw new h.InvalidStateError("closed");return this.safeEmitAsPromise("@getstats")}pause(){p.Logger.debug(m,"pause()"),this._closed?p.Logger.error(m,"pause() | Producer closed"):(this._paused=!0,this._disableTrackOnPause&&(this._track&&(this._track.enabled=!1),this._trackLow&&(this._trackLow.enabled=!1)),this._zeroRtpOnPause&&this.safeEmitAsPromise("@replacetrack",null).catch(()=>{}),this._observer.safeEmit("pause"))}resume(){p.Logger.debug(m,"resume()"),this._closed?p.Logger.error(m,"resume() | Producer closed"):(this._paused=!1,this._disableTrackOnPause&&(this._track&&(this._track.enabled=!0),this._trackLow&&(this._trackLow.enabled=!0)),this._zeroRtpOnPause&&this.safeEmitAsPromise("@replacetrack",this._track).catch(()=>{}),this._observer.safeEmit("resume"))}async replaceTrack({track:e}){if(p.Logger.debug(m,"replaceTrack()"),this._closed){if(e&&this._stopTracks)try{if("audio"===e.kind){const t=l.getParameters().tracks.audio.findIndex(t=>e===t);p.Logger.warn(`Stopping AUDIOTRACK#${t} ${e.id}, ${e.label}, ${e.readyState}`)}else{const t=l.getParameters().tracks.video.findIndex(t=>e===t);p.Logger.warn(`Stopping VIDEOTRACK#${t} ${e.id}, ${e.label}, ${e.readyState}`)}e.stop()}catch(e){}throw new h.InvalidStateError("closed")}if(e&&"ended"===e.readyState)throw new h.InvalidStateError("track ended");e!==this._track?(this._zeroRtpOnPause&&this._paused||await this.safeEmitAsPromise("@replacetrack",e),this._destroyTrack(),this._track=e,this._track&&this._disableTrackOnPause&&(this._paused?this._paused&&(this._track.enabled=!1):this._track.enabled=!0),this._handleTrack()):p.Logger.debug(m,"replaceTrack() | same track, ignored")}async setMaxSpatialLayer(e){if(this._closed)throw new h.InvalidStateError("closed");if("video"!==this._kind)throw new h.UnsupportedError("not a video Producer");if("number"!=typeof e)throw new TypeError("invalid spatialLayer");e!==this._maxSpatialLayer&&(await this.safeEmitAsPromise("@setmaxspatiallayer",e),this._maxSpatialLayer=e)}async setRtpEncodingParameters(e){if(this._closed)throw new h.InvalidStateError("closed");if("object"!=typeof e)throw new TypeError("invalid params");await this.safeEmitAsPromise("@setrtpencodingparameters",e)}_onTrackEnded(){p.Logger.debug(m,'track "ended" event'),this.safeEmit("trackended"),this._observer.safeEmit("trackended")}_handleTrack(){this._track&&this._track.addEventListener("ended",this._onTrackEnded)}_destroyTrack(){this._track&&p.Logger.warn(m,"don not stop sender track")}}t.Producer=f},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.getRTCTimer=void 0;const r=i(125);class s{constructor(e={from:{native:!0,worker:!0,webAudio:!0},minInterval:8}){this.history=[],this.timers=[void 0],this.worker=null,this.options=e;const t=e=>{const t={source:e,ts:Date.now()},i=this.history[this.history.length-1];if(!(i&&t.ts-i.ts<this.options.minInterval)){this.history.push(t),this.history.length>1e3&&this.history.shift();for(let e=0;e<this.timers.length;e++){const i=this.timers[e];if(i&&!(i.cntMax<=i.cnt||t.ts-i.lastCalledAt<i.interval-1)){i.cnt++,i.lastCalledAt=t.ts;try{i.handler()}catch(e){console.error(e)}}}}};e.from.native&&(this.nativeTimer=setInterval(()=>{t("native")},this.options.minInterval)),e.from.worker&&void 0!==typeof Worker&&(this.worker=new Worker(r.getBlobUrl("rtcTimer")),this.worker.onmessage=()=>{t("worker")})}setInterval(e,t){const i={handler:e,id:this.timers.length,interval:t,lastCalledAt:Date.now(),cnt:0,cntMax:Number.MAX_SAFE_INTEGER};return this.timers.push(i),i.id}clearInterval(e){if(!e)return;const t=this.timers[e];t&&(t.id===e?delete this.timers[e]:console.error("timer错位",e,t))}}let a=null;function o(){return a||(a=new s),a}t.getRTCTimer=o;Date.now()},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.AudioLevel=void 0;const r=i(13),s=i(125),a=i(62);let o="NOTREADY",n=null;class d extends r.EventEmitter{constructor(e){super(),this.volume=0,this.left=null,this.right=null,this.channelState="balance",this.stateChangeCnt=0,this.support=null,this.logger=e.logger.getChild(()=>{let e="AudioLevel";return e+="READY"!==o?" "+o:" "+this.channelState,this.stateChangeCnt&&(e+=" change"+this.stateChangeCnt),e});const t=a.getAudioContext(),i=e.stream;t&&(this.support={stream:i,context:t},this.updateStream(i,e.sourceNode))}async updateStream(e,t){if(this.logger.log("AudioLevel updateStream"),this.support){if(!t)try{t=this.support.context.createMediaStreamSource(e)}catch(i){if("TypeError"!==i.name)return void this.logger.error("无法创建MediaStreamAudioSourceNode",i.name,i.message);t=new MediaStreamAudioSourceNode(this.support.context,{mediaStream:e})}if(this.support.sourceNode&&this.support.sourceNode.disconnect(),this.support.sourceNode=t,!this.support.audioWorkletNode){if(!this.support.context.audioWorklet)return void this.logger.error("该环境不支持音量模块");n?"LOADING"===o&&await n:(o="LOADING",this.logger.log("正在载入音量模块"),n=this.support.context.audioWorklet.addModule(s.getBlobUrl("volumeProcessor")),await n,o="READY",this.logger.log("载入音量模块成功")),this.support.audioWorkletNode=new AudioWorkletNode(this.support.context,"vumeter"),this.support.audioWorkletNode.port.onmessage=e=>{var t,i;const r=Date.now(),s=Math.floor(r);if(this.volume=e.data.volume,e.data.left>-1)this.left||(this.left={volume:0,history:[]}),this.left.history.length&&this.left.history[0].sec===s||this.left.history.unshift({sec:s,sum:0}),this.left.volume=e.data.left,this.left.history[0].sum+=e.data.left,this.left.history.length>2&&this.left.history.pop();else{const e=this.channelState;this.channelState="mono",e!==this.channelState&&(this.stateChangeCnt++,this.stateChangeCnt<20&&this.logger.log(`声道状态变更 ${e} => ${this.channelState}`),this.emit("channel-state-change",{state:this.channelState,prev:e}))}if(e.data.right>-1&&(this.right||(this.right={volume:0,history:[]}),this.right.history.length&&this.right.history[0].sec===s||this.right.history.unshift({sec:s,sum:0}),this.right.volume=e.data.right,this.right.history[0].sum+=e.data.right,this.right.history.length>2&&this.right.history.pop()),(null===(t=this.left)||void 0===t?void 0:t.history[1])&&(null===(i=this.right)||void 0===i?void 0:i.history[1]))if(this.left.history[1].sum>4*this.right.history[1].sum){const e=this.channelState;this.channelState="leftLoud",e!==this.channelState&&(this.stateChangeCnt++,this.stateChangeCnt<20&&this.logger.log(`声道状态变更 ${e} => ${this.channelState}`),this.emit("channel-state-change",{state:this.channelState,prev:e}))}else if(this.right.history[1].sum>4*this.left.history[1].sum){const e=this.channelState;this.channelState="rightLoud",e!==this.channelState&&(this.stateChangeCnt++,this.stateChangeCnt<20&&this.logger.log(`声道状态变更 ${e} => ${this.channelState}`),this.emit("channel-state-change",{state:this.channelState,prev:e}))}else{if(this.left.history[1].sum>this.right.history[1].sum&&"leftLoud"!==this.channelState){const e=this.channelState;this.channelState="balance",e!==this.channelState&&(this.stateChangeCnt++,this.stateChangeCnt<20&&this.logger.log(`声道状态变更 ${e} => ${this.channelState}`),this.emit("channel-state-change",{state:this.channelState,prev:e}))}if(this.right.history[1].sum>this.left.history[1].sum&&"rightLoud"!==this.channelState){const e=this.channelState;this.channelState="balance",e!==this.channelState&&(this.stateChangeCnt++,this.stateChangeCnt<20&&this.logger.log(`声道状态变更 ${e} => ${this.channelState}`),this.emit("channel-state-change",{state:this.channelState,prev:e}))}}}}this.support.sourceNode.connect(this.support.audioWorkletNode);const i=a.getAudioLevelDestination();i&&this.support.audioWorkletNode.connect(i)}}getAudioLevel(){return this.volume}destroy(){this.logger.log("destroy() AudioLevel模块")}}t.AudioLevel=d},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.DataReport=void 0;const r=i(65),s=i(2);let a="https://statistic.live.126.net/statics/report/common/form";t.DataReport=class{constructor(e){this.configs=e||{};const t=e.adapterRef;e.sdkRef;this.adapterRef=t;let i=t.instance,r=t.channelInfo||{},{sessionConfig:s={}}=r;this.cid=r.cid||r.channelId||0,this.uid=r.uid||0;const a=i._params&&i._params.appkey;this.time=r.clientNtpTime-r.T4,this.common={name:"common",ver:"2.0",sdk_type:"nrtc2",session_id:this.adapterRef.deviceId,app_key:a},this.eventKeys=[],this.eventMap={},this.api=[],this.heartbeat=null}addEvent(e,t){return-1==this.eventKeys.indexOf(e)&&this.eventKeys.push(e),t.time?t.time=t.time+this.time:(this.adapterRef.logger.warn(`addEvent:事件${e}没有time属性。使用当前时间戳`),t.time=Date.now()),this.eventMap[e]=t,this}updateCommon(e){return Object.assign(this.common,e),this}setHeartbeat(e){this.heartbeat=e;const t=Object.keys(this.adapterRef.apiEvent),i=Object.keys(this.adapterRef.apiEvents),r=t.concat(i.filter(e=>!t.includes(e)));let s=[];for(let e in r){const t=r[e];this.adapterRef.apiEvents[t]&&this.adapterRef.apiEvents[t].length?(s=s.concat(this.adapterRef.apiEvents[t]),this.adapterRef.apiEvents[t]=[]):this.adapterRef.apiEvent[t]&&this.adapterRef.apiEvent[t].length&&(s=s.concat(this.adapterRef.apiEvent[t]),this.adapterRef.apiEvent[t]=[])}return this.api=this.api.concat(s),this}setNetworkChange(e){return this.addEvent("networkChange",e),this}setLogin(e){var t,i,a;e.sdk_ver=e.sdk_ver||r.SDK_VERSION,e.platform=e.platform||"Web",e.app_key=e.app_key||this.common.app_key,e.meeting_mode=e.meeting_mode||1,e.model=e.model,e.build=r.BUILD,e.supported_codec_send=null===(t=this.adapterRef.mediaCapability.supportedCodecSend)||void 0===t?void 0:t.join(","),e.supported_codec_recv=null===(i=this.adapterRef.mediaCapability.supportedCodecRecv)||void 0===i?void 0:i.join(","),e.preferred_codec_send=null===(a=this.adapterRef.mediaCapability.preferredCodecSend.video)||void 0===a?void 0:a.join(","),e.extra_info=JSON.stringify({userAgent:s.USER_AGENT}),e.lbs_addrs=this.adapterRef.lbsManager.getReportField("nrtc"),this.addEvent("login",e)}setRelogin(e){this.addEvent("relogin",e)}setLogout(e){this.addEvent("logout",e)}deviceAbnormal(e){this.addEvent("deviceAbnormal",e)}setDisconnect(e){this.addEvent("disconnect",e)}setRecvFirstFrame(e){this.addEvent("recvFirstFrame",e)}setSendFirstPackage(e){this.addEvent("firstPacketSent",e)}setRecvFirstPackage(e){this.addEvent("recvFirstPackage",e)}setFunction(e){this.addEvent("function",e)}setRequestLbs(e){this.addEvent("requestLBS",e)}setAudioVideoBanned(e){this.addEvent("audioVideoBanned",e)}setStreamException(e){this.addEvent("streamException",e)}reset(){this.eventKeys=[],this.api=[],this.heartbeat=null}send(e){let t={common:this.common};if(e||(e=this.eventKeys),this.heartbeat&&(t.heartbeat=this.heartbeat,this.api.length&&(this.api.forEach(e=>{e.uid||(e.uid=this.adapterRef.channelInfo&&this.adapterRef.channelInfo.uid),e.cid||(e.cid=this.adapterRef.channelInfo&&this.adapterRef.channelInfo.cid),e.param&&"object"==typeof e.param&&void 0!==e.param.clientUid&&(e.param.clientUid=e.uid)}),t.event={apiEvent:this.api},this.api=[])),e){if(e.length){let i=0,r={};for(let t=e.length-1;t>=0;t--){const s=e[t];this.eventMap[s]&&(i++,r[s]=this.eventMap[s],delete this.eventMap[s],e.splice(t,1))}i&&(t.event=r)}}else if(!this.heartbeat)return this;return this.adapterRef.instance._params.neRtcServerAddresses.statisticsServer&&(a=this.adapterRef.instance._params.neRtcServerAddresses.statisticsServer),this.adapterRef.lbsManager.ajax({type:"post",url:a,data:t,header:{sdktype:this.common.sdk_type,appkey:this.common.app_key,platform:"web",sdkver:r.SDK_VERSION}}).then(t=>{e===this.eventKeys&&this.reset()}).catch(e=>{this.adapterRef.logger.log("dataReport, send error: ",e.name,e.message,e),this.reset()}),this}}},function(e,t,i){e.exports=i(248)},function(e,t,i){e.exports=function(e,t){var i=new Array(arguments.length-1),r=0,s=2,a=!0;for(;s<arguments.length;)i[r++]=arguments[s++];return new Promise((function(s,o){i[r]=function(e){if(a)if(a=!1,e)o(e);else{for(var t=new Array(arguments.length-1),i=0;i<t.length;)t[i++]=arguments[i];s.apply(null,t)}};try{e.apply(t||null,i)}catch(e){a&&(a=!1,o(e))}}))}},function(module,exports,__webpack_require__){function inquire(moduleName){try{var mod=eval("quire".replace(/^/,"re"))(moduleName);if(mod&&(mod.length||Object.keys(mod).length))return mod}catch(e){}return null}module.exports=inquire},function(e,t,i){t.Service=i(258)},function(e,t,i){e.exports={}},function(e,t,i){e.exports=function(e){for(var t,i=a.codegen(["m","w"],e.name+"$encode")("if(!w)")("w=Writer.create()"),n=e.fieldsArray.slice().sort(a.compareFieldsById),d=0;d<n.length;++d){var c=n[d].resolve(),l=e._fieldsArray.indexOf(c),u=c.resolvedType instanceof r?"int32":c.type,h=s.basic[u];t="m"+a.safeProp(c.name),c.map?(i("if(%s!=null&&Object.hasOwnProperty.call(m,%j)){",t,c.name)("for(var ks=Object.keys(%s),i=0;i<ks.length;++i){",t)("w.uint32(%i).fork().uint32(%i).%s(ks[i])",(c.id<<3|2)>>>0,8|s.mapKey[c.keyType],c.keyType),void 0===h?i("types[%i].encode(%s[ks[i]],w.uint32(18).fork()).ldelim().ldelim()",l,t):i(".uint32(%i).%s(%s[ks[i]]).ldelim()",16|h,u,t),i("}")("}")):c.repeated?(i("if(%s!=null&&%s.length){",t,t),c.packed&&void 0!==s.packed[u]?i("w.uint32(%i).fork()",(c.id<<3|2)>>>0)("for(var i=0;i<%s.length;++i)",t)("w.%s(%s[i])",u,t)("w.ldelim()"):(i("for(var i=0;i<%s.length;++i)",t),void 0===h?o(i,c,l,t+"[i]"):i("w.uint32(%i).%s(%s[i])",(c.id<<3|h)>>>0,u,t)),i("}")):(c.optional&&i("if(%s!=null&&Object.hasOwnProperty.call(m,%j))",t,c.name),void 0===h?o(i,c,l,t):i("w.uint32(%i).%s(%s)",(c.id<<3|h)>>>0,u,t))}return i("return w")};var r=i(58),s=i(127),a=i(25);function o(e,t,i,r){return t.resolvedType.group?e("types[%i].encode(%s,w.uint32(%i)).uint32(%i)",i,r,(t.id<<3|3)>>>0,(t.id<<3|4)>>>0):e("types[%i].encode(%s,w.uint32(%i).fork()).ldelim()",i,r,(t.id<<3|2)>>>0)}},function(e,t,i){e.exports=_;var r=i(126);((_.prototype=Object.create(r.prototype)).constructor=_).className="Type";var s=i(58),a=i(141),o=i(120),n=i(182),d=i(183),c=i(155),l=i(154),u=i(153),h=i(25),p=i(180),m=i(185),f=i(186),g=i(187),v=i(188);function _(e,t){r.call(this,e,t),this.fields={},this.oneofs=void 0,this.extensions=void 0,this.reserved=void 0,this.group=void 0,this._fieldsById=null,this._fieldsArray=null,this._oneofsArray=null,this._ctor=null}function S(e){return e._fieldsById=e._fieldsArray=e._oneofsArray=null,delete e.encode,delete e.decode,delete e.verify,e}Object.defineProperties(_.prototype,{fieldsById:{get:function(){if(this._fieldsById)return this._fieldsById;this._fieldsById={};for(var e=Object.keys(this.fields),t=0;t<e.length;++t){var i=this.fields[e[t]],r=i.id;if(this._fieldsById[r])throw Error("duplicate id "+r+" in "+this);this._fieldsById[r]=i}return this._fieldsById}},fieldsArray:{get:function(){return this._fieldsArray||(this._fieldsArray=h.toArray(this.fields))}},oneofsArray:{get:function(){return this._oneofsArray||(this._oneofsArray=h.toArray(this.oneofs))}},ctor:{get:function(){return this._ctor||(this.ctor=_.generateConstructor(this)())},set:function(e){var t=e.prototype;t instanceof c||((e.prototype=new c).constructor=e,h.merge(e.prototype,t)),e.$type=e.prototype.$type=this,h.merge(e,c,!0),this._ctor=e;for(var i=0;i<this.fieldsArray.length;++i)this._fieldsArray[i].resolve();var r={};for(i=0;i<this.oneofsArray.length;++i)r[this._oneofsArray[i].resolve().name]={get:h.oneOfGetter(this._oneofsArray[i].oneof),set:h.oneOfSetter(this._oneofsArray[i].oneof)};i&&Object.defineProperties(e.prototype,r)}}}),_.generateConstructor=function(e){for(var t,i=h.codegen(["p"],e.name),r=0;r<e.fieldsArray.length;++r)(t=e._fieldsArray[r]).map?i("this%s={}",h.safeProp(t.name)):t.repeated&&i("this%s=[]",h.safeProp(t.name));return i("if(p)for(var ks=Object.keys(p),i=0;i<ks.length;++i)if(p[ks[i]]!=null)")("this[ks[i]]=p[ks[i]]")},_.fromJSON=function(e,t){var i=new _(e,t.options);i.extensions=t.extensions,i.reserved=t.reserved;for(var c=Object.keys(t.fields),l=0;l<c.length;++l)i.add((void 0!==t.fields[c[l]].keyType?n.fromJSON:o.fromJSON)(c[l],t.fields[c[l]]));if(t.oneofs)for(c=Object.keys(t.oneofs),l=0;l<c.length;++l)i.add(a.fromJSON(c[l],t.oneofs[c[l]]));if(t.nested)for(c=Object.keys(t.nested),l=0;l<c.length;++l){var u=t.nested[c[l]];i.add((void 0!==u.id?o.fromJSON:void 0!==u.fields?_.fromJSON:void 0!==u.values?s.fromJSON:void 0!==u.methods?d.fromJSON:r.fromJSON)(c[l],u))}return t.extensions&&t.extensions.length&&(i.extensions=t.extensions),t.reserved&&t.reserved.length&&(i.reserved=t.reserved),t.group&&(i.group=!0),t.comment&&(i.comment=t.comment),i},_.prototype.toJSON=function(e){var t=r.prototype.toJSON.call(this,e),i=!!e&&Boolean(e.keepComments);return h.toObject(["options",t&&t.options||void 0,"oneofs",r.arrayToJSON(this.oneofsArray,e),"fields",r.arrayToJSON(this.fieldsArray.filter((function(e){return!e.declaringField})),e)||{},"extensions",this.extensions&&this.extensions.length?this.extensions:void 0,"reserved",this.reserved&&this.reserved.length?this.reserved:void 0,"group",this.group||void 0,"nested",t&&t.nested||void 0,"comment",i?this.comment:void 0])},_.prototype.resolveAll=function(){for(var e=this.fieldsArray,t=0;t<e.length;)e[t++].resolve();var i=this.oneofsArray;for(t=0;t<i.length;)i[t++].resolve();return r.prototype.resolveAll.call(this)},_.prototype.get=function(e){return this.fields[e]||this.oneofs&&this.oneofs[e]||this.nested&&this.nested[e]||null},_.prototype.add=function(e){if(this.get(e.name))throw Error("duplicate name '"+e.name+"' in "+this);if(e instanceof o&&void 0===e.extend){if(this._fieldsById?this._fieldsById[e.id]:this.fieldsById[e.id])throw Error("duplicate id "+e.id+" in "+this);if(this.isReservedId(e.id))throw Error("id "+e.id+" is reserved in "+this);if(this.isReservedName(e.name))throw Error("name '"+e.name+"' is reserved in "+this);return e.parent&&e.parent.remove(e),this.fields[e.name]=e,e.message=this,e.onAdd(this),S(this)}return e instanceof a?(this.oneofs||(this.oneofs={}),this.oneofs[e.name]=e,e.onAdd(this),S(this)):r.prototype.add.call(this,e)},_.prototype.remove=function(e){if(e instanceof o&&void 0===e.extend){if(!this.fields||this.fields[e.name]!==e)throw Error(e+" is not a member of "+this);return delete this.fields[e.name],e.parent=null,e.onRemove(this),S(this)}if(e instanceof a){if(!this.oneofs||this.oneofs[e.name]!==e)throw Error(e+" is not a member of "+this);return delete this.oneofs[e.name],e.parent=null,e.onRemove(this),S(this)}return r.prototype.remove.call(this,e)},_.prototype.isReservedId=function(e){return r.isReservedId(this.reserved,e)},_.prototype.isReservedName=function(e){return r.isReservedName(this.reserved,e)},_.prototype.create=function(e){return new this.ctor(e)},_.prototype.setup=function(){for(var e=this.fullName,t=[],i=0;i<this.fieldsArray.length;++i)t.push(this._fieldsArray[i].resolve().resolvedType);this.encode=p(this)({Writer:u,types:t,util:h}),this.decode=m(this)({Reader:l,types:t,util:h}),this.verify=f(this)({types:t,util:h}),this.fromObject=g.fromObject(this)({types:t,util:h}),this.toObject=g.toObject(this)({types:t,util:h});var r=v[e];if(r){var s=Object.create(this);s.fromObject=this.fromObject,this.fromObject=r.fromObject.bind(s),s.toObject=this.toObject,this.toObject=r.toObject.bind(s)}return this},_.prototype.encode=function(e,t){return this.setup().encode(e,t)},_.prototype.encodeDelimited=function(e,t){return this.encode(e,t&&t.len?t.fork():t).ldelim()},_.prototype.decode=function(e,t){return this.setup().decode(e,t)},_.prototype.decodeDelimited=function(e){return e instanceof l||(e=l.create(e)),this.decode(e,e.uint32())},_.prototype.verify=function(e){return this.setup().verify(e)},_.prototype.fromObject=function(e){return this.setup().fromObject(e)},_.prototype.toObject=function(e,t){return this.setup().toObject(e,t)},_.d=function(e){return function(t){h.decorateType(t,e)}}},function(e,t,i){e.exports=o;var r=i(120);((o.prototype=Object.create(r.prototype)).constructor=o).className="MapField";var s=i(127),a=i(25);function o(e,t,i,s,o,n){if(r.call(this,e,t,s,void 0,void 0,o,n),!a.isString(i))throw TypeError("keyType must be a string");this.keyType=i,this.resolvedKeyType=null,this.map=!0}o.fromJSON=function(e,t){return new o(e,t.id,t.keyType,t.type,t.options,t.comment)},o.prototype.toJSON=function(e){var t=!!e&&Boolean(e.keepComments);return a.toObject(["keyType",this.keyType,"type",this.type,"id",this.id,"extend",this.extend,"options",this.options,"comment",t?this.comment:void 0])},o.prototype.resolve=function(){if(this.resolved)return this;if(void 0===s.mapKey[this.keyType])throw Error("invalid key type: "+this.keyType);return r.prototype.resolve.call(this)},o.d=function(e,t,i){return"function"==typeof i?i=a.decorateType(i).name:i&&"object"==typeof i&&(i=a.decorateEnum(i).name),function(r,s){a.decorateType(r.constructor).add(new o(s,e,t,i))}}},function(e,t,i){e.exports=n;var r=i(126);((n.prototype=Object.create(r.prototype)).constructor=n).className="Service";var s=i(184),a=i(25),o=i(178);function n(e,t){r.call(this,e,t),this.methods={},this._methodsArray=null}function d(e){return e._methodsArray=null,e}n.fromJSON=function(e,t){var i=new n(e,t.options);if(t.methods)for(var r=Object.keys(t.methods),a=0;a<r.length;++a)i.add(s.fromJSON(r[a],t.methods[r[a]]));return t.nested&&i.addJSON(t.nested),i.comment=t.comment,i},n.prototype.toJSON=function(e){var t=r.prototype.toJSON.call(this,e),i=!!e&&Boolean(e.keepComments);return a.toObject(["options",t&&t.options||void 0,"methods",r.arrayToJSON(this.methodsArray,e)||{},"nested",t&&t.nested||void 0,"comment",i?this.comment:void 0])},Object.defineProperty(n.prototype,"methodsArray",{get:function(){return this._methodsArray||(this._methodsArray=a.toArray(this.methods))}}),n.prototype.get=function(e){return this.methods[e]||r.prototype.get.call(this,e)},n.prototype.resolveAll=function(){for(var e=this.methodsArray,t=0;t<e.length;++t)e[t].resolve();return r.prototype.resolve.call(this)},n.prototype.add=function(e){if(this.get(e.name))throw Error("duplicate name '"+e.name+"' in "+this);return e instanceof s?(this.methods[e.name]=e,e.parent=this,d(this)):r.prototype.add.call(this,e)},n.prototype.remove=function(e){if(e instanceof s){if(this.methods[e.name]!==e)throw Error(e+" is not a member of "+this);return delete this.methods[e.name],e.parent=null,d(this)}return r.prototype.remove.call(this,e)},n.prototype.create=function(e,t,i){for(var r,s=new o.Service(e,t,i),n=0;n<this.methodsArray.length;++n){var d=a.lcFirst((r=this._methodsArray[n]).resolve().name).replace(/[^$\w_]/g,"");s[d]=a.codegen(["r","c"],a.isReserved(d)?d+"_":d)("return this.rpcCall(m,q,s,r,c)")({m:r,q:r.resolvedRequestType.ctor,s:r.resolvedResponseType.ctor})}return s}},function(e,t,i){e.exports=a;var r=i(119);((a.prototype=Object.create(r.prototype)).constructor=a).className="Method";var s=i(25);function a(e,t,i,a,o,n,d,c,l){if(s.isObject(o)?(d=o,o=n=void 0):s.isObject(n)&&(d=n,n=void 0),void 0!==t&&!s.isString(t))throw TypeError("type must be a string");if(!s.isString(i))throw TypeError("requestType must be a string");if(!s.isString(a))throw TypeError("responseType must be a string");r.call(this,e,d),this.type=t||"rpc",this.requestType=i,this.requestStream=!!o||void 0,this.responseType=a,this.responseStream=!!n||void 0,this.resolvedRequestType=null,this.resolvedResponseType=null,this.comment=c,this.parsedOptions=l}a.fromJSON=function(e,t){return new a(e,t.type,t.requestType,t.responseType,t.requestStream,t.responseStream,t.options,t.comment,t.parsedOptions)},a.prototype.toJSON=function(e){var t=!!e&&Boolean(e.keepComments);return s.toObject(["type","rpc"!==this.type&&this.type||void 0,"requestType",this.requestType,"requestStream",this.requestStream,"responseType",this.responseType,"responseStream",this.responseStream,"options",this.options,"comment",t?this.comment:void 0,"parsedOptions",this.parsedOptions])},a.prototype.resolve=function(){return this.resolved?this:(this.resolvedRequestType=this.parent.lookupType(this.requestType),this.resolvedResponseType=this.parent.lookupType(this.responseType),r.prototype.resolve.call(this))}},function(e,t,i){e.exports=function(e){var t=a.codegen(["r","l"],e.name+"$decode")("if(!(r instanceof Reader))")("r=Reader.create(r)")("var c=l===undefined?r.len:r.pos+l,m=new this.ctor"+(e.fieldsArray.filter((function(e){return e.map})).length?",k,value":""))("while(r.pos<c){")("var t=r.uint32()");e.group&&t("if((t&7)===4)")("break");t("switch(t>>>3){");for(var i=0;i<e.fieldsArray.length;++i){var n=e._fieldsArray[i].resolve(),d=n.resolvedType instanceof r?"int32":n.type,c="m"+a.safeProp(n.name);t("case %i:",n.id),n.map?(t("if(%s===util.emptyObject)",c)("%s={}",c)("var c2 = r.uint32()+r.pos"),void 0!==s.defaults[n.keyType]?t("k=%j",s.defaults[n.keyType]):t("k=null"),void 0!==s.defaults[d]?t("value=%j",s.defaults[d]):t("value=null"),t("while(r.pos<c2){")("var tag2=r.uint32()")("switch(tag2>>>3){")("case 1: k=r.%s(); break",n.keyType)("case 2:"),void 0===s.basic[d]?t("value=types[%i].decode(r,r.uint32())",i):t("value=r.%s()",d),t("break")("default:")("r.skipType(tag2&7)")("break")("}")("}"),void 0!==s.long[n.keyType]?t('%s[typeof k==="object"?util.longToHash(k):k]=value',c):t("%s[k]=value",c)):n.repeated?(t("if(!(%s&&%s.length))",c,c)("%s=[]",c),void 0!==s.packed[d]&&t("if((t&7)===2){")("var c2=r.uint32()+r.pos")("while(r.pos<c2)")("%s.push(r.%s())",c,d)("}else"),void 0===s.basic[d]?t(n.resolvedType.group?"%s.push(types[%i].decode(r))":"%s.push(types[%i].decode(r,r.uint32()))",c,i):t("%s.push(r.%s())",c,d)):void 0===s.basic[d]?t(n.resolvedType.group?"%s=types[%i].decode(r)":"%s=types[%i].decode(r,r.uint32())",c,i):t("%s=r.%s()",c,d),t("break")}for(t("default:")("r.skipType(t&7)")("break")("}")("}"),i=0;i<e._fieldsArray.length;++i){var l=e._fieldsArray[i];l.required&&t("if(!m.hasOwnProperty(%j))",l.name)("throw util.ProtocolError(%j,{instance:m})",o(l))}return t("return m")};var r=i(58),s=i(127),a=i(25);function o(e){return"missing required '"+e.name+"'"}},function(e,t,i){e.exports=function(e){var t=s.codegen(["m"],e.name+"$verify")('if(typeof m!=="object"||m===null)')("return%j","object expected"),i=e.oneofsArray,r={};i.length&&t("var p={}");for(var d=0;d<e.fieldsArray.length;++d){var c=e._fieldsArray[d].resolve(),l="m"+s.safeProp(c.name);if(c.optional&&t("if(%s!=null&&m.hasOwnProperty(%j)){",l,c.name),c.map)t("if(!util.isObject(%s))",l)("return%j",a(c,"object"))("var k=Object.keys(%s)",l)("for(var i=0;i<k.length;++i){"),n(t,c,"k[i]"),o(t,c,d,l+"[k[i]]")("}");else if(c.repeated)t("if(!Array.isArray(%s))",l)("return%j",a(c,"array"))("for(var i=0;i<%s.length;++i){",l),o(t,c,d,l+"[i]")("}");else{if(c.partOf){var u=s.safeProp(c.partOf.name);1===r[c.partOf.name]&&t("if(p%s===1)",u)("return%j",c.partOf.name+": multiple values"),r[c.partOf.name]=1,t("p%s=1",u)}o(t,c,d,l)}c.optional&&t("}")}return t("return null")};var r=i(58),s=i(25);function a(e,t){return e.name+": "+t+(e.repeated&&"array"!==t?"[]":e.map&&"object"!==t?"{k:"+e.keyType+"}":"")+" expected"}function o(e,t,i,s){if(t.resolvedType)if(t.resolvedType instanceof r){e("switch(%s){",s)("default:")("return%j",a(t,"enum value"));for(var o=Object.keys(t.resolvedType.values),n=0;n<o.length;++n)e("case %i:",t.resolvedType.values[o[n]]);e("break")("}")}else e("{")("var e=types[%i].verify(%s);",i,s)("if(e)")("return%j+e",t.name+".")("}");else switch(t.type){case"int32":case"uint32":case"sint32":case"fixed32":case"sfixed32":e("if(!util.isInteger(%s))",s)("return%j",a(t,"integer"));break;case"int64":case"uint64":case"sint64":case"fixed64":case"sfixed64":e("if(!util.isInteger(%s)&&!(%s&&util.isInteger(%s.low)&&util.isInteger(%s.high)))",s,s,s,s)("return%j",a(t,"integer|Long"));break;case"float":case"double":e('if(typeof %s!=="number")',s)("return%j",a(t,"number"));break;case"bool":e('if(typeof %s!=="boolean")',s)("return%j",a(t,"boolean"));break;case"string":e("if(!util.isString(%s))",s)("return%j",a(t,"string"));break;case"bytes":e('if(!(%s&&typeof %s.length==="number"||util.isString(%s)))',s,s,s)("return%j",a(t,"buffer"))}return e}function n(e,t,i){switch(t.keyType){case"int32":case"uint32":case"sint32":case"fixed32":case"sfixed32":e("if(!util.key32Re.test(%s))",i)("return%j",a(t,"integer key"));break;case"int64":case"uint64":case"sint64":case"fixed64":case"sfixed64":e("if(!util.key64Re.test(%s))",i)("return%j",a(t,"integer|Long key"));break;case"bool":e("if(!util.key2Re.test(%s))",i)("return%j",a(t,"boolean key"))}return e}},function(e,t,i){var r=t,s=i(58),a=i(25);function o(e,t,i,r){if(t.resolvedType)if(t.resolvedType instanceof s){e("switch(d%s){",r);for(var a=t.resolvedType.values,o=Object.keys(a),n=0;n<o.length;++n)t.repeated&&a[o[n]]===t.typeDefault&&e("default:"),e("case%j:",o[n])("case %i:",a[o[n]])("m%s=%j",r,a[o[n]])("break");e("}")}else e('if(typeof d%s!=="object")',r)("throw TypeError(%j)",t.fullName+": object expected")("m%s=types[%i].fromObject(d%s)",r,i,r);else{var d=!1;switch(t.type){case"double":case"float":e("m%s=Number(d%s)",r,r);break;case"uint32":case"fixed32":e("m%s=d%s>>>0",r,r);break;case"int32":case"sint32":case"sfixed32":e("m%s=d%s|0",r,r);break;case"uint64":d=!0;case"int64":case"sint64":case"fixed64":case"sfixed64":e("if(util.Long)")("(m%s=util.Long.fromValue(d%s)).unsigned=%j",r,r,d)('else if(typeof d%s==="string")',r)("m%s=parseInt(d%s,10)",r,r)('else if(typeof d%s==="number")',r)("m%s=d%s",r,r)('else if(typeof d%s==="object")',r)("m%s=new util.LongBits(d%s.low>>>0,d%s.high>>>0).toNumber(%s)",r,r,r,d?"true":"");break;case"bytes":e('if(typeof d%s==="string")',r)("util.base64.decode(d%s,m%s=util.newBuffer(util.base64.length(d%s)),0)",r,r,r)("else if(d%s.length)",r)("m%s=d%s",r,r);break;case"string":e("m%s=String(d%s)",r,r);break;case"bool":e("m%s=Boolean(d%s)",r,r)}}return e}function n(e,t,i,r){if(t.resolvedType)t.resolvedType instanceof s?e("d%s=o.enums===String?types[%i].values[m%s]:m%s",r,i,r,r):e("d%s=types[%i].toObject(m%s,o)",r,i,r);else{var a=!1;switch(t.type){case"double":case"float":e("d%s=o.json&&!isFinite(m%s)?String(m%s):m%s",r,r,r,r);break;case"uint64":a=!0;case"int64":case"sint64":case"fixed64":case"sfixed64":e('if(typeof m%s==="number")',r)("d%s=o.longs===String?String(m%s):m%s",r,r,r)("else")("d%s=o.longs===String?util.Long.prototype.toString.call(m%s):o.longs===Number?new util.LongBits(m%s.low>>>0,m%s.high>>>0).toNumber(%s):m%s",r,r,r,r,a?"true":"",r);break;case"bytes":e("d%s=o.bytes===String?util.base64.encode(m%s,0,m%s.length):o.bytes===Array?Array.prototype.slice.call(m%s):m%s",r,r,r,r,r);break;default:e("d%s=m%s",r,r)}}return e}r.fromObject=function(e){var t=e.fieldsArray,i=a.codegen(["d"],e.name+"$fromObject")("if(d instanceof this.ctor)")("return d");if(!t.length)return i("return new this.ctor");i("var m=new this.ctor");for(var r=0;r<t.length;++r){var n=t[r].resolve(),d=a.safeProp(n.name);n.map?(i("if(d%s){",d)('if(typeof d%s!=="object")',d)("throw TypeError(%j)",n.fullName+": object expected")("m%s={}",d)("for(var ks=Object.keys(d%s),i=0;i<ks.length;++i){",d),o(i,n,r,d+"[ks[i]]")("}")("}")):n.repeated?(i("if(d%s){",d)("if(!Array.isArray(d%s))",d)("throw TypeError(%j)",n.fullName+": array expected")("m%s=[]",d)("for(var i=0;i<d%s.length;++i){",d),o(i,n,r,d+"[i]")("}")("}")):(n.resolvedType instanceof s||i("if(d%s!=null){",d),o(i,n,r,d),n.resolvedType instanceof s||i("}"))}return i("return m")},r.toObject=function(e){var t=e.fieldsArray.slice().sort(a.compareFieldsById);if(!t.length)return a.codegen()("return {}");for(var i=a.codegen(["m","o"],e.name+"$toObject")("if(!o)")("o={}")("var d={}"),r=[],o=[],d=[],c=0;c<t.length;++c)t[c].partOf||(t[c].resolve().repeated?r:t[c].map?o:d).push(t[c]);if(r.length){for(i("if(o.arrays||o.defaults){"),c=0;c<r.length;++c)i("d%s=[]",a.safeProp(r[c].name));i("}")}if(o.length){for(i("if(o.objects||o.defaults){"),c=0;c<o.length;++c)i("d%s={}",a.safeProp(o[c].name));i("}")}if(d.length){for(i("if(o.defaults){"),c=0;c<d.length;++c){var l=d[c],u=a.safeProp(l.name);if(l.resolvedType instanceof s)i("d%s=o.enums===String?%j:%j",u,l.resolvedType.valuesById[l.typeDefault],l.typeDefault);else if(l.long)i("if(util.Long){")("var n=new util.Long(%i,%i,%j)",l.typeDefault.low,l.typeDefault.high,l.typeDefault.unsigned)("d%s=o.longs===String?n.toString():o.longs===Number?n.toNumber():n",u)("}else")("d%s=o.longs===String?%j:%i",u,l.typeDefault.toString(),l.typeDefault.toNumber());else if(l.bytes){var h="["+Array.prototype.slice.call(l.typeDefault).join(",")+"]";i("if(o.bytes===String)d%s=%j",u,String.fromCharCode.apply(String,l.typeDefault))("else{")("d%s=%s",u,h)("if(o.bytes!==Array)d%s=util.newBuffer(d%s)",u,u)("}")}else i("d%s=%j",u,l.typeDefault)}i("}")}var p=!1;for(c=0;c<t.length;++c){l=t[c];var m=e._fieldsArray.indexOf(l);u=a.safeProp(l.name);l.map?(p||(p=!0,i("var ks2")),i("if(m%s&&(ks2=Object.keys(m%s)).length){",u,u)("d%s={}",u)("for(var j=0;j<ks2.length;++j){"),n(i,l,m,u+"[ks2[j]]")("}")):l.repeated?(i("if(m%s&&m%s.length){",u,u)("d%s=[]",u)("for(var j=0;j<m%s.length;++j){",u),n(i,l,m,u+"[j]")("}")):(i("if(m%s!=null&&m.hasOwnProperty(%j)){",u,l.name),n(i,l,m,u),l.partOf&&i("if(o.oneofs)")("d%s=%j",a.safeProp(l.partOf.name),l.name)),i("}")}return i("return d")}},function(e,t,i){var r=t,s=i(155);r[".google.protobuf.Any"]={fromObject:function(e){if(e&&e["@type"]){var t=e["@type"].substring(e["@type"].lastIndexOf("/")+1),i=this.lookup(t);if(i){var r="."===e["@type"].charAt(0)?e["@type"].substr(1):e["@type"];return-1===r.indexOf("/")&&(r="/"+r),this.create({type_url:r,value:i.encode(i.fromObject(e)).finish()})}}return this.fromObject(e)},toObject:function(e,t){var i="",r="";if(t&&t.json&&e.type_url&&e.value){r=e.type_url.substring(e.type_url.lastIndexOf("/")+1),i=e.type_url.substring(0,e.type_url.lastIndexOf("/")+1);var a=this.lookup(r);a&&(e=a.decode(e.value))}if(!(e instanceof this.ctor)&&e instanceof s){var o=e.$type.toObject(e,t);return""===i&&(i="type.googleapis.com/"),r=i+("."===e.$type.fullName[0]?e.$type.fullName.substr(1):e.$type.fullName),o["@type"]=r,o}return this.toObject(e,t)}}},function(e,t,i){e.exports=u;var r=i(126);((u.prototype=Object.create(r.prototype)).constructor=u).className="Root";var s,a,o,n=i(120),d=i(58),c=i(141),l=i(25);function u(e){r.call(this,"",e),this.deferred=[],this.files=[]}function h(){}u.fromJSON=function(e,t){return t||(t=new u),e.options&&t.setOptions(e.options),t.addJSON(e.nested)},u.prototype.resolvePath=l.path.resolve,u.prototype.fetch=l.fetch,u.prototype.load=function e(t,i,r){"function"==typeof i&&(r=i,i=void 0);var s=this;if(!r)return l.asPromise(e,s,t,i);var n=r===h;function d(e,t){if(r){var i=r;if(r=null,n)throw e;i(e,t)}}function c(e){var t=e.lastIndexOf("google/protobuf/");if(t>-1){var i=e.substring(t);if(i in o)return i}return null}function u(e,t){try{if(l.isString(t)&&"{"===t.charAt(0)&&(t=JSON.parse(t)),l.isString(t)){a.filename=e;var r,o=a(t,s,i),u=0;if(o.imports)for(;u<o.imports.length;++u)(r=c(o.imports[u])||s.resolvePath(e,o.imports[u]))&&p(r);if(o.weakImports)for(u=0;u<o.weakImports.length;++u)(r=c(o.weakImports[u])||s.resolvePath(e,o.weakImports[u]))&&p(r,!0)}else s.setOptions(t.options).addJSON(t.nested)}catch(e){d(e)}n||m||d(null,s)}function p(e,t){if(!(s.files.indexOf(e)>-1))if(s.files.push(e),e in o)n?u(e,o[e]):(++m,setTimeout((function(){--m,u(e,o[e])})));else if(n){var i;try{i=l.fs.readFileSync(e).toString("utf8")}catch(e){return void(t||d(e))}u(e,i)}else++m,s.fetch(e,(function(i,a){--m,r&&(i?t?m||d(null,s):d(i):u(e,a))}))}var m=0;l.isString(t)&&(t=[t]);for(var f,g=0;g<t.length;++g)(f=s.resolvePath("",t[g]))&&p(f);if(n)return s;m||d(null,s)},u.prototype.loadSync=function(e,t){if(!l.isNode)throw Error("not supported");return this.load(e,t,h)},u.prototype.resolveAll=function(){if(this.deferred.length)throw Error("unresolvable extensions: "+this.deferred.map((function(e){return"'extend "+e.extend+"' in "+e.parent.fullName})).join(", "));return r.prototype.resolveAll.call(this)};var p=/^[A-Z]/;function m(e,t){var i=t.parent.lookup(t.extend);if(i){var r=new n(t.fullName,t.id,t.type,t.rule,void 0,t.options);return r.declaringField=t,t.extensionField=r,i.add(r),!0}return!1}u.prototype._handleAdd=function(e){if(e instanceof n)void 0===e.extend||e.extensionField||m(0,e)||this.deferred.push(e);else if(e instanceof d)p.test(e.name)&&(e.parent[e.name]=e.values);else if(!(e instanceof c)){if(e instanceof s)for(var t=0;t<this.deferred.length;)m(0,this.deferred[t])?this.deferred.splice(t,1):++t;for(var i=0;i<e.nestedArray.length;++i)this._handleAdd(e._nestedArray[i]);p.test(e.name)&&(e.parent[e.name]=e)}},u.prototype._handleRemove=function(e){if(e instanceof n){if(void 0!==e.extend)if(e.extensionField)e.extensionField.parent.remove(e.extensionField),e.extensionField=null;else{var t=this.deferred.indexOf(e);t>-1&&this.deferred.splice(t,1)}}else if(e instanceof d)p.test(e.name)&&delete e.parent[e.name];else if(e instanceof r){for(var i=0;i<e.nestedArray.length;++i)this._handleRemove(e._nestedArray[i]);p.test(e.name)&&delete e.parent[e.name]}},u._configure=function(e,t,i){s=e,a=t,o=i}},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.MediaHelper=void 0;const n=i(13),d=i(162),c=i(156),l=o(i(11)),u=o(i(12)),h=a(i(118)),p=i(118),m=i(69),f=i(271),g=a(i(2)),v=i(56),_=i(146),S=i(115),y=i(5),R=i(272),b=i(62),T=i(273);class w extends n.EventEmitter{constructor(e){super(),this.audio={audioStream:new MediaStream,audioSourceStream:new MediaStream,musicStream:new MediaStream,micStream:new MediaStream,pipeline:null,audioSource:null,micTrack:null,deviceInfo:{mic:{compatAudio:!1,label:""}},webAudio:null,micConstraint:null,mixAudioConf:{index:0,audioBuffer:{},sounds:{}},stageAIProcessing:null,audioRoutingEnabled:!1},this.video={videoStream:new MediaStream,renderStream:new MediaStream,low:null,cameraTrack:null,cameraConstraint:{video:{}},videoSource:null,preProcessingEnabled:!1,preProcessing:null,captureConfig:{high:{width:640,height:480,frameRate:15}},encoderConfig:{high:{maxBitrate:8e5,contentHint:null},low:{maxBitrate:1e5,contentHint:"motion"}}},this.screen={screenVideoStream:new MediaStream,renderStream:new MediaStream,low:null,screenVideoTrack:null,screenVideoSource:null,preProcessingEnabled:!1,preProcessing:null,captureConfig:{high:{width:1920,height:1080,frameRate:5}},encoderConfig:{high:{maxBitrate:15e5,contentHint:null},low:{maxBitrate:2e5,contentHint:"motion"}}},this.screenAudio={screenAudioStream:new MediaStream,screenAudioTrack:null,screenAudioSource:null,pipeline:null},this.listenToTrackEnded=e=>{e&&e.addEventListener("ended",()=>{this.logger.log("Track ended",e.label,e.id),this.stream===this.stream.client.adapterRef.localStream&&(e!==this.audio.micTrack&&e!==this.audio.audioSource||(this.logger.warn("音频轨道已停止"),this.stream.client.safeEmit("audioTrackEnded")),e!==this.video.cameraTrack&&e!==this.video.videoSource||(this.logger.warn("视频轨道已停止"),this.stream.client.safeEmit("videoTrackEnded")),(e===this.screen.screenVideoTrack||e===this.screen.screenVideoSource||e.label.indexOf("screen")>-1||e.label.indexOf("window")>-1||e.label.indexOf("web-")>-1)&&(this.logger.warn("屏幕共享已停止"),this.stream.client.safeEmit("stopScreenSharing")),e===this.screenAudio.screenAudioTrack&&(this.logger.warn("屏幕共享音频已停止"),this.stream.client.safeEmit("stopScreenAudio")))})},this.stream=e.stream,this.logger=e.stream.logger.getChild(()=>{var e;let t="mediaHelper";return this.audio.audioRoutingEnabled&&(t+=" WebAudio"),this.audio.webAudio&&(this.audio.webAudio.context&&"running"!==this.audio.webAudio.context.state&&(t+=" "+this.audio.webAudio.context.state),this.audio.webAudio.mixAudioConf.state!==d.AuidoMixingState.UNSTART&&(t+=" "+(null===(e=this.audio.webAudio)||void 0===e?void 0:e.mixAudioConf.state))),this.stream.mediaHelper!==this&&(t+="DETACHED"),t}),this.bindRenderStream(),S.Device.on("recording-device-changed",e=>{if(this.audio.micTrack&&this.audio.deviceInfo.mic.deviceId===e.device.deviceId)if("INACTIVE"===e.state)this.logger.error("当前使用的麦克风设备被移除，需重新启用设备",e.device),this.stream.emit("recording-device-changed",e);else{S.Device.deviceHistory.audioIn.find(e=>{e.groupId,this.audio.deviceInfo.mic.groupId})||(this.logger.error(`当前麦克风已由【${this.audio.deviceInfo.mic.label}】切换至【${e.device.label}】，可能会影响通话质量`),this.audio.deviceInfo.mic.label=e.device.label,this.audio.deviceInfo.mic.groupId=e.device.groupId,this.stream.emit("recording-device-changed",e))}})}getOrCreateAudioPipeline(e="audio"){let t;const i=b.getAudioContext();if(!i)return this.logger.error("getOrCreateAudioPipeline: AudioContext is not supported"),null;if("audio"===e)if(this.audio.pipeline?t=this.audio.pipeline:(t=new T.AudioPipeline({logger:this.logger,outputStream:this.audio.audioStream,context:i}),this.audio.pipeline=t,this.logger.log("getOrCreateAudioPipeline: 初始化成功")),this.stream.isRemote)t.inputs.remote.track!==this.audio.micTrack&&(this.logger.log("getOrCreateAudioPipeline: 更新输入的Track"),t.setInput("remote",this.audio.micTrack,"remote"+this.stream.streamID));else{const e=this.audio.micTrack||this.audio.audioSource;t.inputs.local.track!==e&&(this.logger.log("getOrCreateAudioPipeline: 更新输入的Track"),t.setInput("local",e,(null==e?void 0:e.label)||"empty"))}else if(this.screenAudio.pipeline?t=this.screenAudio.pipeline:(t=new T.AudioPipeline({logger:this.logger,outputStream:this.screenAudio.screenAudioStream,context:i}),this.screenAudio.pipeline=t,this.logger.log("getOrCreateAudioPipeline/screenAudio: 初始化成功")),this.stream.isRemote)t.inputs.remote.track!==this.screenAudio.screenAudioTrack&&(this.logger.log("getOrCreateAudioPipeline/screenAudio: 更新输入的Track"),t.setInput("remote",this.screenAudio.screenAudioTrack,`remote${this.stream.streamID}/screenAudio`));else{const e=this.screenAudio.screenAudioTrack||this.screenAudio.screenAudioSource;t.inputs.local.track!==e&&(this.logger.log("getOrCreateAudioPipeline/screenAudio: 更新输入的Track"),t.setInput("local",e,(null==e?void 0:e.label)||"empty"))}return t}bindRenderStream(){g.IS_SAFARI&&"safari"===y.getParameters().shimLocalCanvas||"all"===y.getParameters().shimLocalCanvas?(this.video.videoStream.onaddtrack=async e=>{if("undefined"!=typeof CanvasCaptureMediaStreamTrack&&e.track instanceof CanvasCaptureMediaStreamTrack){const t=f.pcCloneTrack(e.track);p.watchTrack(t),this.logger.warn("renderStream cloned track for video:",e.track,t),p.emptyStreamWith(this.video.renderStream,t)}else p.emptyStreamWith(this.video.renderStream,e.track)},this.video.videoStream.onremovetrack=e=>{p.emptyStreamWith(this.video.renderStream,null)},this.screen.screenVideoStream.onaddtrack=async e=>{if("undefined"!=typeof CanvasCaptureMediaStreamTrack&&e.track instanceof CanvasCaptureMediaStreamTrack){const t=f.pcCloneTrack(e.track);p.watchTrack(t),this.logger.warn("renderStream cloned track for screen:",e.track,t),p.emptyStreamWith(this.screen.renderStream,t)}else p.emptyStreamWith(this.screen.renderStream,e.track)},this.screen.screenVideoStream.onremovetrack=e=>{p.emptyStreamWith(this.screen.renderStream,null)}):(this.video.renderStream=this.video.videoStream,this.screen.renderStream=this.screen.screenVideoStream)}assertLive(){if(!this.stream.isRemote&&!this.stream.isRemote&&this.stream.destroyed){this._reset();let e="assertLive: localStream is destroyed",t="assertLive: localStream 已经销毁",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=g.IS_ZH?t:e,a=g.IS_ZH?r:i;throw new u.default({code:l.default.LOCALSTREAM_ERROR,message:s,advice:a})}}_reset(){this.stopAllEffects(),this.stream.isRemote||(this.audio.webAudio&&(this.audio.webAudio.off("audioFilePlaybackCompleted"),this.audio.webAudio.destroy()),this.audio.webAudio=null,this.audio.micConstraint=null,this.audio.audioRoutingEnabled=!1,this.audio.micTrack&&(this.audio.micTrack.stop(),this.audio.micTrack=null),this.video.low&&(this.video.low.destroy(),this.video.low=null),this.video.videoSource=null,this.video.cameraTrack&&(this.video.cameraTrack.stop(),this.video.cameraTrack=null),this.screen.screenVideoTrack&&(this.screen.screenVideoTrack.stop(),this.screen.screenVideoTrack=null),this.video.cameraConstraint={video:{}},this.screenAudio.screenAudioTrack&&(this.screenAudio.screenAudioTrack.stop(),this.screenAudio.screenAudioTrack=null),this.audio.mixAudioConf={index:0,audioBuffer:{},sounds:{}}),p.emptyStreamWith(this.audio.audioStream,null),p.emptyStreamWith(this.audio.musicStream,null),p.emptyStreamWith(this.audio.micStream,null),p.emptyStreamWith(this.screenAudio.screenAudioStream,null),p.emptyStreamWith(this.video.videoStream,null),p.emptyStreamWith(this.screen.screenVideoStream,null),p.emptyStreamWith(this.screenAudio.screenAudioStream,null)}updateWebAudio(){var e,t;if(!this.audio.webAudio){this.audio.webAudio=new b.WebAudio({mediaHelper:this,logger:this.logger}),this.audio.webAudio.on("audioFilePlaybackCompleted",this._audioFilePlaybackCompletedEvent.bind(this));const i=null===(t=null===(e=this.audio.webAudio)||void 0===e?void 0:e.musicDestination)||void 0===t?void 0:t.stream.getAudioTracks()[0];i&&p.emptyStreamWith(this.audio.musicStream,i)}this.audio.webAudio.updateTracks([{track:this.audio.micTrack||this.audio.audioSource,type:"microphone"}])}async getScreenSource(e){const{width:t,height:i,frameRate:r}=this.screen.captureConfig.high;try{return await h.getScreenStream({video:{width:{ideal:t},height:{ideal:i},frameRate:{ideal:r,max:r}}},this.logger)}catch(e){const t="screen";return e.message&&e.message.indexOf("ermission")>-1&&e.message.indexOf("denied")>-1?this.stream.client.safeEmit("accessDenied",t):e.message&&e.message.indexOf("not found")>-1?this.stream.client.safeEmit("notFound",t):e.message&&e.message.indexOf("not start video source")>-1?this.stream.client.safeEmit("beOccupied",t):this.stream.client.safeEmit("deviceError",t),this.stream.emit("device-error",{type:t,error:e}),Promise.reject(e)}}async getStream(e){let{audio:t=!1,audioDeviceId:i="",video:r=!1,videoDeviceId:s="",screen:a=!1,sourceId:o="",screenAudio:n=!1,facingMode:d="",audioSource:c=null,videoSource:l=null,screenAudioSource:u=null,screenVideoSource:m=null,deviceId:f=""}=e;if(c&&(t=!0),l&&(r=!0),m&&(a=!0),u&&(n=!0),this.stream.isRemote)this.logger.error("getStream: 远端流不能够调用getStream");else if(t||r||a||n){if(c){if("ended"===c.readyState)return void this.logger.error("不应输入已经停止的轨道:",c.kind,c.label);p.watchTrack(c),this.audio.audioSource=c,p.emptyStreamWith(this.audio.audioSourceStream,c),this.updateWebAudio(),this.audio.audioRoutingEnabled||(this.getAudioInputTracks().length>1?this.enableAudioRouting():(p.emptyStreamWith(this.audio.audioStream,c),this.updateAudioSender(c))),t=!1,this.stream.client.updateRecordingAudioStream()}if(l){if("ended"===l.readyState)return void this.logger.error("不应输入已经停止的轨道:",l.kind,l.label);p.watchTrack(l),this.video.videoSource=l,p.emptyStreamWith(this.video.videoStream,l),this.video.videoStream.getVideoTracks().length&&"string"==typeof this.video.encoderConfig.high.contentHint&&this.video.videoStream.getVideoTracks()[0].contentHint!==this.video.encoderConfig.high.contentHint&&(this.logger.log("应用 contentHint video high",this.video.encoderConfig.high.contentHint),this.video.videoStream.getVideoTracks()[0].contentHint=this.video.encoderConfig.high.contentHint),r=!1}if(u){if("ended"===u.readyState)return void this.logger.error("不应输入已经停止的轨道:",u.kind,u.label);p.watchTrack(u),this.screenAudio.screenAudioSource=u,p.emptyStreamWith(this.screenAudio.screenAudioStream,u),this.listenToTrackEnded(this.screenAudio.screenAudioSource),this.updateWebAudio(),this.audio.audioRoutingEnabled||(this.getAudioInputTracks().length>1?this.enableAudioRouting():(p.emptyStreamWith(this.audio.audioStream,u),this.updateAudioSender(u))),n=!1}if(m){if("ended"===m.readyState)return void this.logger.error("不应输入已经停止的轨道:",m.kind,m.label);p.watchTrack(m),this.screen.screenVideoSource=m,p.emptyStreamWith(this.screen.screenVideoStream,m),this.screen.screenVideoStream.getVideoTracks().length&&"string"==typeof this.screen.encoderConfig.high.contentHint&&this.screen.screenVideoStream.getVideoTracks()[0].contentHint!==this.screen.encoderConfig.high.contentHint&&(this.logger.log("应用 contentHint screen high",this.screen.encoderConfig.high.contentHint),this.screen.screenVideoStream.getVideoTracks()[0].contentHint=this.screen.encoderConfig.high.contentHint),a=!1}try{if(a){const{width:e,height:i,frameRate:r}=this.screen.captureConfig.high;if(o){const t=(await h.getStream({video:{mandatory:{maxWidth:e,maxHeight:i,maxFrameRate:r,minFrameRate:5,chromeMediaSource:"desktop",chromeMediaSourceId:o}}},this.logger)).getTracks()[0];this.video.cameraTrack=t,p.emptyStreamWith(this.video.videoStream,t),this.video.videoStream.getVideoTracks().length&&"string"==typeof this.video.encoderConfig.high.contentHint&&this.video.videoStream.getVideoTracks()[0].contentHint!==this.video.encoderConfig.high.contentHint&&(this.logger.log("应用 contentHint video high",this.video.encoderConfig.high.contentHint),this.video.videoStream.getVideoTracks()[0].contentHint=this.video.encoderConfig.high.contentHint)}else{let t=await h.getScreenStream({video:{width:{ideal:e},height:{ideal:i},frameRate:{ideal:r,max:r}},audio:n&&this.getAudioConstraints()?this.getAudioConstraints():n},this.logger);if(this.screen.screenVideoTrack=t.getVideoTracks()[0],this.listenToTrackEnded(this.screen.screenVideoTrack),p.emptyStreamWith(this.screen.screenVideoStream,this.screen.screenVideoTrack),this.screen.screenVideoStream.getVideoTracks().length&&"string"==typeof this.screen.encoderConfig.high.contentHint&&this.screen.screenVideoStream.getVideoTracks()[0].contentHint!==this.screen.encoderConfig.high.contentHint&&(this.logger.log("应用 contentHint screen high",this.screen.encoderConfig.high.contentHint),this.screen.screenVideoStream.getVideoTracks()[0].contentHint=this.screen.encoderConfig.high.contentHint),n){const e=t.getAudioTracks()[0];e?(this.screenAudio.screenAudioTrack=e,p.emptyStreamWith(this.screenAudio.screenAudioStream,e),this.listenToTrackEnded(e)):(this.logger.warn("getStream screenAudio: 未获取到屏幕共享音频"),this.stream.screenAudio=!1,this.stream.client.emit("error","screenAudioNotAllowed"))}}if(this.stream.client.apiEventReport("setFunction",{name:"set_screen",oper:"1",value:"success"}),t){let e=await h.getStream({audio:this.getAudioConstraints()},this.logger);this.audio.micTrack=e.getAudioTracks()[0],p.emptyStreamWith(this.audio.micStream,this.audio.micTrack),this.listenToTrackEnded(this.audio.micTrack),this.updateWebAudio(),this.audio.audioRoutingEnabled||(this.getAudioInputTracks().length>1?this.enableAudioRouting():(p.emptyStreamWith(this.audio.audioStream,this.audio.micTrack),this.updateAudioSender(this.audio.micTrack)));const t=_.compatAudioInputList.findSource(this.audio.micTrack.id);if(t){this.audio.deviceInfo.mic.compatAudio=!0;const e=t.getSettings();this.audio.deviceInfo.mic.label=t.label,this.audio.deviceInfo.mic.deviceId=e.deviceId,this.audio.deviceInfo.mic.groupId=e.groupId}else{this.audio.deviceInfo.mic.compatAudio=!1;const e=this.audio.micTrack.getSettings();this.audio.deviceInfo.mic.label=this.audio.micTrack.label,this.audio.deviceInfo.mic.deviceId=e.deviceId,this.audio.deviceInfo.mic.groupId=e.groupId}this.stream.client.apiEventReport("setFunction",{name:"set_mic",oper:"1",value:"success"})}}else if(n)this.logger.error("无法单独获取屏幕共享音频");else if(t||r){if(this.stream.isRemote)return void this.logger.error("MediaHelper.getStream:远端流不能调用getStream");const{height:e,width:a,frameRate:o}=this.video.captureConfig.high;let n={audio:t&&this.getAudioConstraints()?this.getAudioConstraints():void 0,video:r?{width:{ideal:a},height:{ideal:e},frameRate:{ideal:o||15}}:void 0};i&&n.audio&&(n.audio.deviceId={exact:i}),n.video&&(d?n.video.facingMode={exact:d}:s&&(n.video.deviceId={exact:s}));const c=await h.getStream(n,this.logger),l=c.getVideoTracks()[0],u=c.getAudioTracks()[0];if(u){this.audio.micTrack=u,this.listenToTrackEnded(this.audio.micTrack),p.emptyStreamWith(this.audio.micStream,this.audio.micTrack),this.updateWebAudio(),this.audio.audioRoutingEnabled||(this.getAudioInputTracks().length>1?this.enableAudioRouting():(p.emptyStreamWith(this.audio.audioStream,this.audio.micTrack),this.updateAudioSender(this.audio.micTrack)));const e=_.compatAudioInputList.findSource(this.audio.micTrack.id);if(e){this.audio.deviceInfo.mic.compatAudio=!0;const t=e.getSettings();this.audio.deviceInfo.mic.label=e.label,this.audio.deviceInfo.mic.deviceId=t.deviceId,this.audio.deviceInfo.mic.groupId=t.groupId}else{this.audio.deviceInfo.mic.compatAudio=!1;const e=this.audio.micTrack.getSettings();this.audio.deviceInfo.mic.label=this.audio.micTrack.label,this.audio.deviceInfo.mic.deviceId=e.deviceId,this.audio.deviceInfo.mic.groupId=e.groupId}this.stream.client.apiEventReport("setFunction",{name:"set_mic",oper:"1",value:"success"}),"object"==typeof n.audio&&(this.audio.micConstraint={audio:n.audio}),this.stream.client.updateRecordingAudioStream()}l&&(this.video.cameraTrack=l,p.emptyStreamWith(this.video.videoStream,l),this.video.videoStream.getVideoTracks().length&&"string"==typeof this.video.encoderConfig.high.contentHint&&this.video.videoStream.getVideoTracks()[0].contentHint!==this.video.encoderConfig.high.contentHint&&(this.logger.log("应用 contentHint video high",this.video.encoderConfig.high.contentHint),this.video.videoStream.getVideoTracks()[0].contentHint=this.video.encoderConfig.high.contentHint),this.listenToTrackEnded(this.video.cameraTrack),this.stream.client.apiEventReport("setFunction",{name:"set_camera",oper:"1",value:"success"}),"object"==typeof n.video&&(this.video.cameraConstraint={video:n.video}))}this.assertLive()}catch(e){this.logger.error("getStream error:",e.name,e.message);let i="audio";return t&&this.stream.client.apiEventReport("setFunction",{name:"set_mic",oper:"1",value:e.message}),r&&(i="video",this.stream.client.apiEventReport("setFunction",{name:"set_camera",oper:"1",value:e.message})),a&&(i="screen",this.stream.client.apiEventReport("setFunction",{name:"set_screen",oper:"1",value:e.message})),"NotAllowedError"===e.name?this.stream.client.safeEmit("accessDenied",i):"NotFoundError"===e.name?this.stream.client.safeEmit("notFound",i):"NotReadableError"===e.name?this.stream.client.safeEmit("beOccupied",i):"OverconstrainedError"===e.name&&this.stream.client.safeEmit("deviceError",i),this.stream.emit("device-error",{type:i,error:e}),this.stream.client.apiEventReport("setStreamException",{name:"pushStreamException",value:`getUserMediaError: ${e.name} + ${e.message}`,mediaType:i}),Promise.reject(e)}}else this.logger.error("getStream: 必须指定媒体类型")}async getSecondStream(e){var t;let{audio:i=!1,video:r=!1}=e;if(!i&&!r){this.logger.error("getSecondStream: 必须指定一个参数");let e="getSecondStream: invalid parameter",t="getSecondStream: 参数缺失",i="Please make sure audio/video is valid",r="必须指定一个参数",s=g.IS_ZH?t:e,a=g.IS_ZH?r:i;return Promise.reject(new u.default({code:l.default.INVALID_PARAMETER_ERROR,message:s,advice:a}))}if(this.stream.isRemote)return Promise.reject("getSecondStream:远端用户不能调用getSecondStream");try{const i=await h.getStream(e,this.logger),r=i.getAudioTracks()[0],s=i.getVideoTracks()[0];if(this.logger.log(`getSecondStream: ${r?r.label:""} ${s?s.label:""}`),r){"object"==typeof e.audio&&(this.audio.micConstraint={audio:e.audio}),this.audio.micTrack=r,this._stopTrack(this.audio.micStream),p.emptyStreamWith(this.audio.micStream,this.audio.micTrack),this.listenToTrackEnded(this.audio.micTrack),this.updateWebAudio(),this.audio.audioRoutingEnabled||(this.getAudioInputTracks().length>1?this.enableAudioRouting():(p.emptyStreamWith(this.audio.audioStream,this.audio.micTrack),this.updateAudioSender(this.audio.micTrack)));const t=_.compatAudioInputList.findSource(this.audio.micTrack.id);if(t){this.audio.deviceInfo.mic.compatAudio=!0;const e=t.getSettings();this.audio.deviceInfo.mic.label=t.label,this.audio.deviceInfo.mic.deviceId=e.deviceId,this.audio.deviceInfo.mic.groupId=e.groupId}else{this.audio.deviceInfo.mic.compatAudio=!1;const e=this.audio.micTrack.getSettings();this.audio.deviceInfo.mic.label=this.audio.micTrack.label,this.audio.deviceInfo.mic.deviceId=e.deviceId,this.audio.deviceInfo.mic.groupId=e.groupId}this.stream.client.updateRecordingAudioStream(),this.stream.client.apiEventReport("setFunction",{name:"set_mic",oper:"1",value:"success"})}if(s){"object"==typeof e.video&&(this.video.cameraConstraint={video:e.video}),this.video.cameraTrack=s,this._stopTrack(this.video.videoStream),p.emptyStreamWith(this.video.videoStream,this.video.cameraTrack),this.video.videoStream.getVideoTracks().length&&"string"==typeof this.video.encoderConfig.high.contentHint&&this.video.videoStream.getVideoTracks()[0].contentHint!==this.video.encoderConfig.high.contentHint&&(this.logger.log("应用 contentHint video high",this.video.encoderConfig.high.contentHint),this.video.videoStream.getVideoTracks()[0].contentHint=this.video.encoderConfig.high.contentHint),this.stream.client.apiEventReport("setFunction",{name:"set_camera",oper:"1",value:"success"});const i=null===(t=this.stream.Play)||void 0===t?void 0:t.videoView;i&&(await this.stream.play(i),"width"in this.stream.renderMode.local.video&&this.stream.setLocalRenderMode(this.stream.renderMode.local.video,"video"));const r=this.stream.getSender("video","high");(null==r?void 0:r.track)?r.replaceTrack(s):this.logger.warn("getSecondStream video: 此时未发布流")}}catch(e){this.logger.error("getStream error",e.message);const t=i?"set_mic":"set_camera";return this.stream.client.apiEventReport("setFunction",{name:t,oper:"1",value:e.message}),Promise.reject(e)}}convert(e){const t=e.resolution,i=e.frameRate;let r={width:640,height:480,frameRate:15};return 2===t?(r.width=320,r.height=180):4===t?(r.width=640,r.height=480):8===t||g.IS_IOS_SAFARI?(r.width=1280,r.height=720):16===t&&(r.width=1920,r.height=1080),0===i?r.frameRate=15:1===i?r.frameRate=5:2===i?r.frameRate=10:3===i?r.frameRate=15:4===i?r.frameRate=20:5===i?r.frameRate=25:6===i&&(r.frameRate=30),r}getAudioConstraints(){if(this.stream.isRemote)return void this.logger.error("Remote Stream dont have audio constraints");const e=this.stream.audioProcessing;let t={channelCount:1};switch(e&&(void 0!==e.AEC&&(t.echoCancellation=e.AEC,t.googEchoCancellation=e.AEC,t.googEchoCancellation2=e.AEC),void 0!==e.ANS&&(t.noiseSuppression=e.ANS,t.googNoiseSuppression=e.ANS,t.googNoiseSuppression2=e.ANS),void 0!==e.AGC&&(t.autoGainControl=e.AGC,t.googAutoGainControl=e.AGC,t.googAutoGainControl2=e.AGC)),this.stream.audioProfile){case"standard_stereo":case"high_quality_stereo":t.googAutoGainControl=!1,t.googAutoGainControl2=!1,t.echoCancellation=!1,t.googNoiseSuppression=!1,t.channelCount=2}return t}getTrackSettings(){const e={};try{if(this.audio.micTrack){const t=_.compatAudioInputList.findSource(this.audio.micTrack.id);e.mic=t?{compat:!0,settings:t.getSettings(),label:t.label,readyState:t.readyState}:{settings:this.audio.micTrack.getSettings(),label:this.audio.micTrack.label,readyState:this.audio.micTrack.readyState}}this.audio.audioSource&&(e.audioSource={settings:this.audio.audioSource.getSettings(),label:this.audio.audioSource.label,readyState:this.audio.audioSource.readyState}),this.video.cameraTrack&&(e.camera={settings:this.video.cameraTrack.getSettings(),label:this.video.cameraTrack.label,readyState:this.video.cameraTrack.readyState}),this.video.videoSource&&(e.videoSource={settings:this.video.videoSource.getSettings(),label:this.video.videoSource.label,readyState:this.video.videoSource.readyState}),this.screen.screenVideoTrack&&(e.screen={settings:this.screen.screenVideoTrack.getSettings(),label:this.screen.screenVideoTrack.label,readyState:this.screen.screenVideoTrack.readyState}),this.screen.screenVideoSource&&(e.screenVideoSource={settings:this.screen.screenVideoSource.getSettings(),label:this.screen.screenVideoSource.label,readyState:this.screen.screenVideoSource.readyState}),this.screenAudio.screenAudioTrack&&(e.screenAudio={settings:this.screenAudio.screenAudioTrack.getSettings(),label:this.screenAudio.screenAudioTrack.label,readyState:this.screenAudio.screenAudioTrack.readyState}),this.screenAudio.screenAudioSource&&(e.screenAudioSource={settings:this.screenAudio.screenAudioSource.getSettings(),label:this.screenAudio.screenAudioSource.label,readyState:this.screenAudio.screenAudioSource.readyState})}catch(t){e.errName=t.name,e.errMessage=t.message}return e}updateStream(e,t){var i,r,s,a;"audio"===e?(this.audio.micTrack=t,p.emptyStreamWith(this.audio.audioStream,t),(null===(i=this.stream._play)||void 0===i?void 0:i.audioDom)&&(this.stream._play.audioDom.srcObject=this.audio.audioStream)):"audioSlave"===e?(this.screenAudio.screenAudioTrack=t,p.emptyStreamWith(this.screenAudio.screenAudioStream,t),(null===(r=this.stream._play)||void 0===r?void 0:r.audioSlaveDom)&&(this.stream._play.audioSlaveDom.srcObject=this.audio.audioStream)):"video"===e?(this.video.cameraTrack=t,p.emptyStreamWith(this.video.videoStream,t),this.video.videoStream.getVideoTracks().length&&"string"==typeof this.video.encoderConfig.high.contentHint&&this.video.videoStream.getVideoTracks()[0].contentHint!==this.video.encoderConfig.high.contentHint&&(this.logger.log("应用 contentHint video high",this.video.encoderConfig.high.contentHint),this.video.videoStream.getVideoTracks()[0].contentHint=this.video.encoderConfig.high.contentHint),(null===(s=this.stream._play)||void 0===s?void 0:s.videoDom)&&(this.stream._play.videoDom.srcObject=this.video.renderStream)):"screen"===e&&(this.screen.screenVideoTrack=t,p.emptyStreamWith(this.screen.screenVideoStream,t),this.screen.screenVideoStream.getVideoTracks().length&&"string"==typeof this.screen.encoderConfig.high.contentHint&&this.screen.screenVideoStream.getVideoTracks()[0].contentHint!==this.screen.encoderConfig.high.contentHint&&(this.logger.log("应用 contentHint screen high",this.screen.encoderConfig.high.contentHint),this.screen.screenVideoStream.getVideoTracks()[0].contentHint=this.screen.encoderConfig.high.contentHint),(null===(a=this.stream._play)||void 0===a?void 0:a.screenDom)&&(this.stream._play.screenDom.srcObject=this.screen.renderStream))}stopStream(e){var t,i,r,s;let a="set_mic";"audio"===e?(null===(t=this.audio.micTrack)||void 0===t||t.stop(),this.audio.micTrack=null,p.emptyStreamWith(this.audio.micStream,null),this.audio.audioSource=null,p.emptyStreamWith(this.audio.audioSourceStream,null),this.updateWebAudio(),this.canDisableAudioRouting()&&this.disableAudioRouting()):"screenAudio"===e?(null===(i=this.screenAudio.screenAudioTrack)||void 0===i||i.stop(),this.screenAudio.screenAudioTrack=null,this.screenAudio.screenAudioSource=null,p.emptyStreamWith(this.screenAudio.screenAudioStream,null)):"video"===e?(a="set_camera",null===(r=this.video.cameraTrack)||void 0===r||r.stop(),this.video.cameraTrack=null,p.emptyStreamWith(this.video.videoStream,null)):"screen"===e&&(a="set_screen",null===(s=this.screen.screenVideoTrack)||void 0===s||s.stop(),this.screen.screenVideoTrack=null,p.emptyStreamWith(this.screen.screenVideoStream,null)),this.stream.client.apiEventReport("setFunction",{name:a,oper:"0",value:"success"})}_stopTrack(e){if(!e)return;if(this.stream.isRemote)return;this.logger.log("清除stream: ",e);const t=e.getTracks();this.logger.log("清除stream: ",...t),t&&0!==t.length&&t.forEach(t=>{if("audio"===t.kind){const e=y.getParameters().tracks.audio.findIndex(e=>t===e);v.Logger.warn(`Stopping AUDIOTRACK#${e} ${t.id}, ${t.label}, ${t.readyState}`)}else{const e=y.getParameters().tracks.video.findIndex(e=>t===e);v.Logger.warn(`Stopping VIDEOTRACK#${e} ${t.id}, ${t.label}, ${t.readyState}`)}t.stop(),e.removeTrack(t),this.audio.micTrack===t&&(this.audio.micTrack=null,this.audio.deviceInfo.mic={compatAudio:_.compatAudioInputList.enabled,label:""},this.updateWebAudio()),this.screenAudio.screenAudioTrack===t&&(this.screenAudio.screenAudioTrack=null,this.updateWebAudio()),this.video.cameraTrack===t&&(this.video.cameraTrack=null),this.screen.screenVideoTrack===t&&(this.screen.screenVideoTrack=null)})}getAudioTrack(){var e;return null===(e=this.audio)||void 0===e?void 0:e.audioStream.getAudioTracks()[0]}getVideoTrack(){var e;return null===(e=this.video)||void 0===e?void 0:e.videoStream.getVideoTracks()[0]}setGain(e,t){this.audio.webAudio?(this.logger.log("setGain",e),this.audio.webAudio.setGain(e,t),this.canDisableAudioRouting()&&this.disableAudioRouting()):this.logger.log("setGain: 缺失本地音频")}getGain(){var e;return(null===(e=this.audio.webAudio)||void 0===e?void 0:e.getVolumeData())||"0.0"}canDisableAudioRouting(){var e;let t=!0;if(!this.audio.webAudio)return!1;if(null===(e=this.audio.stageAIProcessing)||void 0===e?void 0:e.enabled)return!1;this.audio.webAudio.mixAudioConf.state!==d.AuidoMixingState.PLAYED&&this.audio.webAudio.mixAudioConf.state!==d.AuidoMixingState.PAUSED||(t=!1),Object.values(this.audio.mixAudioConf.sounds).forEach(e=>{"STARTING"!==e.state&&"PLAYED"!==e.state&&"PAUSED"!==e.state||(t=!1)});const i=this.audio.webAudio.getGainMin();return t&&1===i&&this.audio.webAudio.audioInArr.length<=1}_audioFilePlaybackCompletedEvent(){this.canDisableAudioRouting()&&this.disableAudioRouting()}startAudioMixing(e){this.logger.log("开始伴音:",JSON.stringify(e,null," ")),Object.assign(this.audio.mixAudioConf,e);let t=null;if(this.audio.mixAudioConf.audioFilePath?0!==this.getAudioInputTracks().length&&this.stream.pubStatus.audio.audio?this.audio.webAudio&&this.audio.webAudio.context||(this.logger.log("开始伴音: 不支持伴音功能"),t="BROWSER_NOT_SUPPORT"):(this.logger.log("开始伴音: 当前没有publish音频"),t="NOT_PUBLIST_AUDIO_YET"):(this.logger.log("开始伴音: 没有找到云端文件路径"),t="INVALID_ARGUMENTS"),t){if(this.stream.client.apiFrequencyControl({name:"startAudioMixing",code:-1,param:JSON.stringify(Object.assign(this.audio.mixAudioConf,{reason:t}),null," ")}),"INVALID_ARGUMENTS"===t){let e="startAudioMixing: audioFilePath not found",t="startAudioMixing: audioFilePath 参数缺失",i="Please make sure audioFilePath is valid",r="必须指定一个 audioFilePath 参数",s=g.IS_ZH?t:e,a=g.IS_ZH?r:i;return Promise.reject(new u.default({code:l.default.INVALID_PARAMETER_ERROR,message:s,advice:a}))}if("NOT_PUBLIST_AUDIO_YET"===t){let e="startAudioMixing: invalid operation",t="startAudioMixing: 操作异常",i="audio source is not published",r="音频还没有 publish",s=g.IS_ZH?t:e,a=g.IS_ZH?r:i;return Promise.reject(new u.default({code:l.default.INVALID_OPERATION_ERROR,message:s,advice:a}))}if("BROWSER_NOT_SUPPORT"===t){let e="startAudioMixing: audio mixing is not supported in this browser",t="startAudioMixing: 当前浏览器不支持伴音",i="The latest version of the Chrome browser is recommended",r="建议使用最新版的 Chrome 浏览器",s=g.IS_ZH?t:e,a=g.IS_ZH?r:i;return Promise.reject(new u.default({code:l.default.NOT_SUPPORT_ERROR,message:s,advice:a}))}}return this.stream.client.apiFrequencyControl({name:"startAudioMixing",code:0,param:JSON.stringify(this.audio.mixAudioConf,null," ")}),this.audio.webAudio&&(this.audio.webAudio.mixAudioConf&&this.audio.webAudio.mixAudioConf.audioSource&&this.audio.webAudio.mixAudioConf.state===d.AuidoMixingState.PLAYED&&(this.logger.log("startAudioMixing: 当前已经开启伴音，先关闭之前的伴音"),this.stopAudioMixing()),this.audio.webAudio.mixAudioConf.state,d.AuidoMixingState.STARTING),this.audio.mixAudioConf.audioFilePath&&this.audio.mixAudioConf.audioBuffer[this.audio.mixAudioConf.audioFilePath]?(this.logger.log("开始伴音, 已经加载过云端音乐"),this.startMix(this.audio.mixAudioConf.index)):(this.logger.log("开始伴音, 先加载云端音乐"),this.loadRemoteAudioFile(this.audio.mixAudioConf.index))}loadRemoteAudioFile(e){if(this.audio.mixAudioConf.audioFilePath)return c.ajax({url:this.audio.mixAudioConf.audioFilePath,type:"GET",dataType:"arraybuffer"}).then(t=>(this.logger.log("loadRemoteAudioFile 加载云端音乐成功"),new Promise((i,r)=>{if(this.audio.webAudio&&this.audio.webAudio.context)this.audio.webAudio.context.decodeAudioData(t,t=>{if(this.logger.log("loadRemoteAudioFile 云端音乐解码成功"),this.audio.mixAudioConf.audioFilePath)this.audio.mixAudioConf.audioBuffer[this.audio.mixAudioConf.audioFilePath]=t,this.startMix(e).then(e=>{i(e)});else{let e="loadRemoteAudioFile: audioFilePath error",t="loadRemoteAudioFile: audioFilePath 异常",i="Please contact CommsEase technical support",s="请联系云信技术支持",a=g.IS_ZH?t:e,o=g.IS_ZH?s:i;r(new u.default({code:l.default.AUDIO_MIX_FILE_ERROR,message:a,advice:o}))}},e=>{this.logger.log("loadRemoteAudioFile 云端音乐解码失败：",e);let t="loadRemoteAudioFile: remoteAudioFile create buffersource failed: "+e,i="loadRemoteAudioFile: 云端音乐解码失败: "+e,s=g.IS_ZH?i:t,a=g.IS_ZH?"请联系云信技术支持":"Please contact CommsEase technical support";r(new u.default({code:l.default.AUDIO_MIX_FILE_ERROR,message:s,advice:a}))});else{let e="loadRemoteAudioFile: load remote audio file is not supported in this browser",t="loadRemoteAudioFile: 当前浏览器不支持加载云端音频文件",i="The latest version of the Chrome browser is recommended",s="建议使用最新版的 Chrome 浏览器",a=g.IS_ZH?t:e,o=g.IS_ZH?s:i;r(new u.default({code:l.default.NOT_SUPPORT_ERROR,message:a,advice:o}))}}))).catch(e=>{this.logger.log("loadRemoteAudioFile 加载云端音乐失败: ",e.name,e.message,e);let t=`loadRemoteAudioFile: load audio failed: ${e.name} ${e.message}`,i=`loadRemoteAudioFile: 加载云端音乐失败: ${e.name} ${e.message}`,r=g.IS_ZH?i:t,s=g.IS_ZH?"请联系云信技术支持":"Please contact CommsEase technical support";return Promise.reject(new u.default({code:l.default.AUDIO_MIX_FILE_ERROR,message:r,advice:s}))});this.logger.error("audioFilePath未设置")}startMix(e){if(!this.audio.webAudio){this.logger.error("startMix:参数错误");let e="startMix: webAudio error",t="startMix: webAudio 异常",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=g.IS_ZH?t:e,a=g.IS_ZH?r:i;return Promise.reject(new u.default({code:l.default.AUDIO_MIXING_ERROR,message:s,advice:a}))}if(this.logger.log("startMix 开始混音:",JSON.stringify(this.audio.mixAudioConf)),e!==this.audio.mixAudioConf.index)return this.logger.log("startMix: 该次伴音已经取消"),Promise.resolve();this.audio.audioRoutingEnabled||this.enableAudioRouting();const{audioFilePath:t="",loopback:i=!1,replace:r=!1,cycle:s=0,playStartTime:a=0,volume:o=255,auidoMixingEnd:n=null}=this.audio.mixAudioConf;return this.audio.webAudio.startMix({buffer:this.audio.mixAudioConf.audioBuffer[t],loopback:i,replace:r,cycle:s,playStartTime:a,volume:o,auidoMixingEnd:n})}pauseAudioMixing(){let e=null;if(this.audio.webAudio&&this.audio.webAudio.context?this.audio.webAudio.mixAudioConf&&this.audio.webAudio.mixAudioConf.audioSource&&this.audio.webAudio.mixAudioConf.state!==d.AuidoMixingState.PAUSED?this.audio.webAudio.mixAudioConf&&this.audio.webAudio.mixAudioConf.audioSource&&this.audio.webAudio.mixAudioConf.state===d.AuidoMixingState.PLAYED||(this.logger.log("pauseAudioMixing: 当前没有开启伴音"),e="NOT_PLAY"):(this.logger.log("pauseAudioMixing: 已经暂停"),e="PAUSED"):(this.logger.log("pauseAudioMixing: 不支持伴音功能"),e="BROWSER_NOT_SUPPORT"),e){if(this.stream.client.apiFrequencyControl({name:"pauseAudioMixing",code:-1,param:JSON.stringify(Object.assign(this.audio.mixAudioConf,{reason:e}),null," ")}),"BROWSER_NOT_SUPPORT"===e){let e="pauseAudioMixing: audio mixing is not supported in this browser",t="pauseAudioMixing: 当前浏览器不支持伴音",i="The latest version of the Chrome browser is recommended",r="建议使用最新版的 Chrome 浏览器",s=g.IS_ZH?t:e,a=g.IS_ZH?r:i;return Promise.reject(new u.default({code:l.default.NOT_SUPPORT_ERROR,message:s,advice:a}))}if("PAUSED"===e){let e="pauseAudioMixing: invalid operation",t="pauseAudioMixing: 操作异常",i="has already been paused",r="伴音已暂停",s=g.IS_ZH?t:e,a=g.IS_ZH?r:i;return Promise.reject(new u.default({code:l.default.INVALID_OPERATION_ERROR,message:s,advice:a}))}if("NOT_PLAY"===e){let e="pauseAudioMixing: invalid operation",t="pauseAudioMixing: 操作异常",i="audio mixing is not open",r="伴音未开启",s=g.IS_ZH?t:e,a=g.IS_ZH?r:i;return Promise.reject(new u.default({code:l.default.INVALID_OPERATION_ERROR,message:s,advice:a}))}}return this.stream.client.apiFrequencyControl({name:"pauseAudioMixing",code:0,param:JSON.stringify(this.audio.mixAudioConf,null," ")}),this.audio.webAudio&&this.audio.webAudio.pauseAudioMixing()}resumeAudioMixing(){let e=null;if(this.audio.webAudio&&this.audio.webAudio.context?this.audio.webAudio.mixAudioConf&&this.audio.webAudio.mixAudioConf.audioSource?this.audio.webAudio.mixAudioConf.state!==d.AuidoMixingState.PAUSED&&(this.logger.log("resumeAudioMixing: 当前没有暂停伴音"),e="NOT_PAUSED"):(this.logger.log("resumeAudioMixing: 当前没有开启伴音"),e="NOT_OPEN"):(this.logger.log("resumeAudioMixing: 不支持伴音功能"),e="BROWSER_NOT_SUPPORT"),e){if(this.stream.client.apiFrequencyControl({name:"resumeAudioMixing",code:-1,param:JSON.stringify(Object.assign(this.audio.mixAudioConf,{reason:e}),null," ")}),"BROWSER_NOT_SUPPORT"===e){let e="resumeAudioMixing: audio mixing is not supported in this browser",t="resumeAudioMixing: 当前浏览器不支持伴音",i="The latest version of the Chrome browser is recommended",r="建议使用最新版的 Chrome 浏览器",s=g.IS_ZH?t:e,a=g.IS_ZH?r:i;return Promise.reject(new u.default({code:l.default.NOT_SUPPORT_ERROR,message:s,advice:a}))}if("NOT_OPEN"===e){let e="resumeAudioMixing: invalid operation",t="resumeAudioMixing: 操作异常",i="audio mixing is not open",r="伴音未开启",s=g.IS_ZH?t:e,a=g.IS_ZH?r:i;return Promise.reject(new u.default({code:l.default.INVALID_OPERATION_ERROR,message:s,advice:a}))}if("NOT_PAUSED"===e){let e="resumeAudioMixing: invalid operation",t="resumeAudioMixing: 操作异常",i="audio mixing is not paused",r="伴音未暂停",s=g.IS_ZH?t:e,a=g.IS_ZH?r:i;return Promise.reject(new u.default({code:l.default.INVALID_OPERATION_ERROR,message:s,advice:a}))}}if(this.stream.client.apiFrequencyControl({name:"resumeAudioMixing",code:0,param:JSON.stringify(this.audio.mixAudioConf,null," ")}),!this.audio.webAudio)return;let{audioFilePath:t="",loopback:i=!1,replace:r=!1,cycle:s=0,playStartTime:a=0,auidoMixingEnd:o=null}=this.audio.mixAudioConf,n=(this.audio.webAudio.mixAudioConf.pauseTime-this.audio.webAudio.mixAudioConf.startTime)/1e3+this.audio.webAudio.mixAudioConf.playStartTime;return n>this.audio.webAudio.mixAudioConf.totalTime&&(this.logger.log("播发过的圈数 playedCycle: ",Math.floor(n/this.audio.webAudio.mixAudioConf.totalTime)),s-=Math.floor(n/this.audio.webAudio.mixAudioConf.totalTime),this.audio.mixAudioConf.cycle=s),this.audio.webAudio.mixAudioConf.setPlayStartTime?(this.logger.log("暂停期间，用户设置混音播发时间: ",this.audio.webAudio.mixAudioConf.setPlayStartTime),a=this.audio.webAudio.mixAudioConf.setPlayStartTime,this.audio.webAudio.mixAudioConf.setPlayStartTime=0):(this.logger.log("恢复混音:",JSON.stringify(this.audio.webAudio.mixAudioConf)),this.logger.log("已经播放的时间: ",n),n>this.audio.webAudio.mixAudioConf.totalTime&&(n%=this.audio.webAudio.mixAudioConf.totalTime),a=n),this.logger.log("回复重置的时间点：",a),this.audio.webAudio.resumeAudioMixing({buffer:this.audio.mixAudioConf.audioBuffer[t],loopback:i,replace:r,cycle:s,playStartTime:a,auidoMixingEnd:o})}stopAudioMixing(e=!0){let t=null;if(this.audio.webAudio&&this.audio.webAudio.context?this.audio.webAudio.mixAudioConf&&this.audio.webAudio.mixAudioConf.audioSource||(this.logger.log("stopAudioMixing: 当前没有开启伴音"),t="NOT_OPEN"):(this.logger.log("stopAudioMixing: 不支持伴音功能"),t="BROWSER_NOT_SUPPORT"),t){if(this.stream.client.apiFrequencyControl({name:"stopAudioMixing",code:-1,param:JSON.stringify(Object.assign(this.audio.mixAudioConf,{reason:t}),null," ")}),"BROWSER_NOT_SUPPORT"===t){let e="stopAudioMixing: audio mixing is not supported in this browser",t="stopAudioMixing: 当前浏览器不支持伴音",i="The latest version of the Chrome browser is recommended",r="建议使用最新版的 Chrome 浏览器",s=g.IS_ZH?t:e,a=g.IS_ZH?r:i;return Promise.reject(new u.default({code:l.default.NOT_SUPPORT_ERROR,message:s,advice:a}))}if("NOT_OPEN"===t){let e="stopAudioMixing: invalid operation",t="stopAudioMixing: 操作异常",i="audio mixing is not open",r="伴音未开启",s=g.IS_ZH?t:e,a=g.IS_ZH?r:i;return Promise.reject(new u.default({code:l.default.INVALID_OPERATION_ERROR,message:s,advice:a}))}}return this.stream.client.apiFrequencyControl({name:"stopAudioMixing",code:0,param:JSON.stringify(this.audio.mixAudioConf,null," ")}),this.audio.webAudio.stopAudioMixing(e)}setAudioMixingVolume(e){let t=null;if(this.audio.webAudio&&this.audio.webAudio.context?this.audio.webAudio.mixAudioConf&&this.audio.webAudio.mixAudioConf.audioSource?Number.isInteger(e)?(e<0||e>255)&&(this.logger.log("setAudioMixingVolume: volume范围（0 - 255）"),t="INVALID_ARGUMENTS"):(this.logger.log("setAudioMixingVolume: volume不是整数"),t="INVALID_ARGUMENTS"):(this.logger.log("setAudioMixingVolume: 当前没有开启伴音"),t="NOT_OPEN"):(this.logger.log("setAudioMixingVolume: 不支持伴音功能"),t="BROWSER_NOT_SUPPORT"),t){if(this.stream.client.apiFrequencyControl({name:"adjustAudioMixingVolume",code:-1,param:JSON.stringify(Object.assign(this.audio.mixAudioConf,{reason:t,volume:e}),null," ")}),"BROWSER_NOT_SUPPORT"===t){let e="setAudioMixingVolume: audio mixing is not supported in this browser",t="setAudioMixingVolume: 当前浏览器不支持伴音",i="The latest version of the Chrome browser is recommended",r="建议使用最新版的 Chrome 浏览器",s=g.IS_ZH?t:e,a=g.IS_ZH?r:i;return Promise.reject(new u.default({code:l.default.NOT_SUPPORT_ERROR,message:s,advice:a}))}if("NOT_OPEN"===t){let e="setAudioMixingVolume: invalid operation",t="setAudioMixingVolume: 操作异常",i="audio mixing is not open",r="伴音未开启",s=g.IS_ZH?t:e,a=g.IS_ZH?r:i;return Promise.reject(new u.default({code:l.default.INVALID_OPERATION_ERROR,message:s,advice:a}))}if("INVALID_ARGUMENTS"===t){let e="setAudioMixingVolume: parameter(volume) out of bounds",t="setAudioMixingVolume: volume 参数越界",i="volume must be an integer in the range of (0 - 255)",r="volume 参数的值在 0 - 255 之间",s=g.IS_ZH?t:e,a=g.IS_ZH?r:i;return Promise.reject(new u.default({code:l.default.INVALID_PARAMETER_ERROR,message:s,advice:a}))}}return this.stream.client.apiFrequencyControl({name:"adjustAudioMixingVolume",code:0,param:JSON.stringify({volume:e},null," ")}),this.audio.webAudio&&this.audio.webAudio.setAudioMixingVolume(e)}setAudioMixingPlayTime(e){let t=null;if(this.audio.webAudio&&this.audio.webAudio.context)if(this.audio.webAudio.mixAudioConf&&this.audio.webAudio.mixAudioConf.audioSource){if(e<0)this.logger.log("setAudioMixingPlayTime: playStartTime小于0"),t="INVALID_ARGUMENTS";else if(e>=this.audio.webAudio.mixAudioConf.totalTime)this.logger.log("setAudioMixingPlayTime: playStartTime大于音频文件总时长了"),t="INVALID_ARGUMENTS";else if(this.audio.webAudio.mixAudioConf.state===d.AuidoMixingState.PAUSED)return this.audio.webAudio.mixAudioConf.setPlayStartTime=e,this.logger.log("setAudioMixingPlayTime: 当前正在暂停，记录设置的播发位置，在恢复伴音时，跳转到此次设置的播放位置"),Promise.resolve()}else this.logger.log("setAudioMixingPlayTime: 当前没有开启伴音"),t="NOT_OPEN";else this.logger.log("setAudioMixingPlayTime: 不支持伴音功能"),t="BROWSER_NOT_SUPPORT";if(t){if(this.stream.client.apiFrequencyControl({name:"setAudioMixingPosition",code:-1,param:JSON.stringify({playTime:e,reason:t},null," ")}),"BROWSER_NOT_SUPPORT"===t){let e="setAudioMixingPlayTime: audio mixing is not supported in this browser",t="setAudioMixingPlayTime: 当前浏览器不支持伴音",i="The latest version of the Chrome browser is recommended",r="建议使用最新版的 Chrome 浏览器",s=g.IS_ZH?t:e,a=g.IS_ZH?r:i;return Promise.reject(new u.default({code:l.default.NOT_SUPPORT_ERROR,message:s,advice:a}))}if("NOT_OPEN"===t){let e="setAudioMixingPlayTime: invalid operation",t="setAudioMixingPlayTime: 操作异常",i="audio mixing is not open",r="伴音未开启",s=g.IS_ZH?t:e,a=g.IS_ZH?r:i;return Promise.reject(new u.default({code:l.default.INVALID_OPERATION_ERROR,message:s,advice:a}))}if("INVALID_ARGUMENTS"===t){let e="setAudioMixingPlayTime: playStartTime exceeds total audio duration",t="setAudioMixingPlayTime: playStartTime 超过音频时长范围",i="playStartTime must be an integer in the range of total audio duration",r="playStartTime 的值应该在音频总时长范围内",s=g.IS_ZH?t:e,a=g.IS_ZH?r:i;return Promise.reject(new u.default({code:l.default.INVALID_PARAMETER_ERROR,message:s,advice:a}))}}return new Promise((t,i)=>{this.stopAudioMixing(!1).then(r=>{if(!this.audio.webAudio){i("webAudio not supported");let e="setAudioMixingPlayTime: webAudio is not supported in this browser",t="setAudioMixingPlayTime: 当前浏览器不支持 webAudio",r="The latest version of the Chrome browser is recommended",s="建议使用最新版的 Chrome 浏览器",a=g.IS_ZH?t:e,o=g.IS_ZH?s:r;return Promise.reject(new u.default({code:l.default.NOT_SUPPORT_ERROR,message:a,advice:o}))}this.audio.mixAudioConf.playStartTime=e;let{audioFilePath:s="",loopback:a=!1,replace:o=!1,cycle:n=0,playStartTime:d=0,auidoMixingEnd:c=null}=this.audio.mixAudioConf;this.logger.log("设置混音的播放位置:",this.audio.webAudio.mixAudioConf);let h=(Date.now()-this.audio.webAudio.mixAudioConf.startTime)/1e3+this.audio.webAudio.mixAudioConf.playStartTime;this.logger.log("已经播放的时间: ",h),h>this.audio.webAudio.mixAudioConf.totalTime&&(this.logger.log("播发过的圈数 playedCycle: ",Math.floor(h/this.audio.webAudio.mixAudioConf.totalTime)),n-=Math.floor(h/this.audio.webAudio.mixAudioConf.totalTime),this.audio.mixAudioConf.cycle=n),this.logger.log(`setAudioMixingPlayTime, playTime: ${e}, cycle: ${n}`),this.audio.webAudio.setAudioMixingPlayTime({buffer:this.audio.mixAudioConf.audioBuffer[s],loopback:a,replace:o,cycle:n,playStartTime:d,auidoMixingEnd:c}).then(i=>{this.stream.client.apiFrequencyControl({name:"setAudioMixingPosition",code:0,param:JSON.stringify({playTime:e},null," ")}),t(i)}).catch(t=>{this.stream.client.apiFrequencyControl({name:"setAudioMixingPosition",code:-1,param:JSON.stringify({playTime:e,reason:"重新播放伴音失败"},null," ")}),i(t)})}).catch(t=>(this.stream.client.apiFrequencyControl({name:"setAudioMixingPosition",code:-1,param:JSON.stringify({playTime:e,reason:"暂停当前播放失败"},null," ")}),Promise.reject(t)))})}getAudioMixingPlayedTime(){var e;return this.audio.webAudio&&this.audio.webAudio.context?this.audio.webAudio.mixAudioConf&&this.audio.webAudio.mixAudioConf.audioSource?(this.stream.client.apiFrequencyControl({name:"getAudioMixingPlayedTime",code:0,param:JSON.stringify({playTime:null===(e=this.audio.webAudio.getAudioMixingPlayedTime())||void 0===e?void 0:e.playedTime},null," ")}),this.audio.webAudio.getAudioMixingPlayedTime()):(this.logger.log("getAudioMixingPlayedTime: 当前没有开启伴音"),Promise.resolve()):(this.logger.log("getAudioMixingPlayedTime: 不支持伴音功能"),Promise.resolve())}getAudioMixingTotalTime(){var e;return this.audio.webAudio&&this.audio.webAudio.context?this.audio.webAudio.mixAudioConf&&this.audio.webAudio.mixAudioConf.audioSource?(this.stream.client.apiFrequencyControl({name:"getAudioMixingTotalTime",code:0,param:JSON.stringify({totalTime:null===(e=this.audio.webAudio.getAudioMixingTotalTime())||void 0===e?void 0:e.totalTime},null," ")}),this.audio.webAudio.getAudioMixingTotalTime()):(this.logger.log("getAudioMixingTotalTime: 当前没有开启伴音"),Promise.resolve()):(this.logger.log("startAudioMixing: 不支持伴音功能"),Promise.resolve())}isMixAuido(){return!!(this.audio.webAudio&&this.audio.webAudio.mixAudioConf&&this.audio.webAudio.mixAudioConf.audioSource)}_initSoundIfNotExists(e,t){this.audio.mixAudioConf.sounds[e]||(this.audio.mixAudioConf.sounds[e]={soundId:e,state:"UNSTART",filePath:t||"",volume:100,sourceNode:null,gainNode:null,cycle:1,playStartTime:0,playOverTime:0,pauseTime:0,startTime:0,totalTime:0,options:{}}),t&&(this.audio.mixAudioConf.sounds[e].filePath=t)}async playEffect(e,t){const{soundId:i,filePath:r,cycle:s=1}=e,a={tag:"Stream.playEffect:filePath",value:r};m.checkExists(a);const o={tag:"Stream.playEffect:soundId",value:i,min:1,max:1e4};m.isExistOptions(o).result&&m.checkValidInteger(o);const n={tag:"Stream.playEffect:cycle",value:s,min:1,max:1e4};if(m.isExistOptions(n).result&&m.checkValidInteger(n),this._initSoundIfNotExists(i,r),this.audio.audioRoutingEnabled||this.enableAudioRouting(),!this.audio.webAudio||!this.audio.webAudio.context){this.logger.log("playEffect: 浏览器不支持");let e="playEffect: audio effect is not supported in this browser",t="playEffect: 当前浏览器不支持音效功能",i="The latest version of the Chrome browser is recommended",r="建议使用最新版的 Chrome 浏览器",s=g.IS_ZH?t:e,a=g.IS_ZH?r:i;return Promise.reject(new u.default({code:l.default.NOT_SUPPORT_ERROR,message:s,advice:a}))}if(this.audio.mixAudioConf.sounds[i]&&("STARTING"===this.audio.mixAudioConf.sounds[i].state||"PLAYED"===this.audio.mixAudioConf.sounds[i].state||"PAUSED"===this.audio.mixAudioConf.sounds[i].state)&&(this.logger.log(`pauseEffect: 该音效文件正处于: ${this.audio.mixAudioConf.sounds[i].state} 状态`),void 0===t)){let e="playEffect: playStartTime error",t="playEffect: playStartTime 异常",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=g.IS_ZH?t:e,a=g.IS_ZH?r:i;return Promise.reject(new u.default({code:l.default.AUDIO_EFFECT_ERROR,message:s,advice:a}))}this.audio.mixAudioConf.sounds[i].state="STARTING",this.audio.mixAudioConf.audioBuffer[r]?this.logger.log("playEffect: 已经 load 音效文件"):(this.logger.log("playEffect, 先 load 音效文件"),await this.preloadEffect(i,r));try{const a=this.audio.webAudio.createAudioBufferSource(this.audio.mixAudioConf.audioBuffer[r]);this.audio.mixAudioConf.sounds[i].sourceNode=a.sourceNode,a&&a.sourceNode&&(a.sourceNode.onended=e=>{this.stopEffect(i)}),this.audio.mixAudioConf.sounds[i].gainNode=a.gainNode,this.audio.mixAudioConf.sounds[i].totalTime=this.audio.mixAudioConf.audioBuffer[r]&&this.audio.mixAudioConf.audioBuffer[r].duration,this.audio.mixAudioConf.sounds[i].cycle=s;const o=this.audio.mixAudioConf.audioBuffer[r]&&this.audio.mixAudioConf.audioBuffer[r].duration;this.audio.mixAudioConf.sounds[i].playOverTime=o,s>1&&(this.audio.mixAudioConf.sounds[i].playOverTime=s*o-this.audio.mixAudioConf.sounds[i].playStartTime),this.audio.mixAudioConf.sounds[i].playStartTime=t||0,this.audio.webAudio.startAudioEffectMix(this.audio.mixAudioConf.sounds[i]),this.audio.mixAudioConf.sounds[i].state="PLAYED",this.audio.mixAudioConf.sounds[i].startTime=Date.now(),this.stream.client.apiFrequencyControl({name:"playEffect",code:0,param:JSON.stringify(e,null," ")})}catch(e){}}async stopEffect(e){const t={tag:"Stream.stopEffect:soundId",value:e};m.isExistOptions(t).result&&m.checkValidInteger(t);if(!this.audio.webAudio||!this.audio.webAudio.context){this.logger.log("stopEffect: 浏览器不支持");let e="stopEffect: audio effect is not supported in this browser",t="stopEffect: 当前浏览器不支持音效功能",i="The latest version of the Chrome browser is recommended",r="建议使用最新版的 Chrome 浏览器",s=g.IS_ZH?t:e,a=g.IS_ZH?r:i;return Promise.reject(new u.default({code:l.default.NOT_SUPPORT_ERROR,message:s,advice:a}))}this.audio.webAudio.stopAudioEffectMix(this.audio.mixAudioConf.sounds[e]),this.audio.mixAudioConf.sounds[e].state="STOPED",this._audioFilePlaybackCompletedEvent(),this.stream.client.apiFrequencyControl({name:"stopEffect",code:0,param:JSON.stringify(e,null," ")})}async pauseEffect(e){const t={tag:"Stream.pauseEffect:soundId",value:e};m.isExistOptions(t).result&&m.checkValidInteger(t);let i=null;if(this.audio.mixAudioConf.sounds[e]||(this.logger.log("pauseEffect: 没有该音效文件"),i="SOUND_NOT_EXISTS"),this.audio.webAudio&&this.audio.webAudio.context?"PAUSED"===this.audio.mixAudioConf.sounds[e].state?(this.logger.log("pauseEffect: 已经暂停"),i="PAUSED"):"PLAYED"!==this.audio.mixAudioConf.sounds[e].state&&(this.logger.log("pauseEffect: 当前没有开启该音效"),i="NOT_PLAYED"):(this.logger.log("pauseEffect: 不支持音效功能"),i="BROWSER_NOT_SUPPORT"),i){if("BROWSER_NOT_SUPPORT"===i){let e="pauseEffect: audio effect is not supported in this browser",t="pauseEffect: 当前浏览器不支持音效功能",i="The latest version of the Chrome browser is recommended",r="建议使用最新版的 Chrome 浏览器",s=g.IS_ZH?t:e,a=g.IS_ZH?r:i;return Promise.reject(new u.default({code:l.default.NOT_SUPPORT_ERROR,message:s,advice:a}))}if("NOT_PLAYED"===i){let e="pauseEffect: invalid operation",t="pauseEffect: 操作异常",i="audio effect is not open",r="音效未开启",s=g.IS_ZH?t:e,a=g.IS_ZH?r:i;return Promise.reject(new u.default({code:l.default.INVALID_OPERATION_ERROR,message:s,advice:a}))}if("PAUSED"===i){let e="pauseEffect: invalid operation",t="pauseEffect: 操作异常",i="audio effect is paused",r="音效已暂停",s=g.IS_ZH?t:e,a=g.IS_ZH?r:i;return Promise.reject(new u.default({code:l.default.INVALID_OPERATION_ERROR,message:s,advice:a}))}if("SOUND_NOT_EXISTS"===i){let e="pauseEffect: audio effect file is not found",t="pauseEffect: 音效文件缺失",i="Please make sure the soundId correct",r="请确认 soundId 无误",s=g.IS_ZH?t:e,a=g.IS_ZH?r:i;return Promise.reject(new u.default({code:l.default.AUDIO_EFFECT_FILE_LOST_ERROR,message:s,advice:a}))}}if(!this.audio.webAudio)return;this.audio.webAudio.stopAudioEffectMix(this.audio.mixAudioConf.sounds[e]),this.audio.mixAudioConf.sounds[e].pauseTime=Date.now(),this.audio.mixAudioConf.sounds[e].state="PAUSED";let r=(this.audio.mixAudioConf.sounds[e].pauseTime-this.audio.mixAudioConf.sounds[e].startTime)/1e3+this.audio.mixAudioConf.sounds[e].playStartTime;this.logger.log("pauseEffect 已经播放的时间: ",r),r>this.audio.mixAudioConf.sounds[e].totalTime&&(r%=this.audio.mixAudioConf.sounds[e].totalTime),this.logger.log("pauseEffect 暂停位置: ",r),this.stream.client.apiFrequencyControl({name:"pauseEffect",code:0,param:JSON.stringify(e,null," ")})}async resumeEffect(e){const t={tag:"Stream.resumeEffect:soundId",value:e};m.isExistOptions(t).result&&m.checkValidInteger(t);let i=null;if(this.audio.mixAudioConf.sounds[e]||(this.logger.log("resumeEffect: 没有该音效文件"),i="SOUND_NOT_EXISTS"),this.audio.webAudio&&this.audio.webAudio.context?"PAUSED"!==this.audio.mixAudioConf.sounds[e].state&&(this.logger.log("resumeEffect: 当前没有暂停该音效文件"),i="NOT_PAUSED"):(this.logger.log("resumeEffect: 不支持音效功能"),i="BROWSER_NOT_SUPPORT"),i){if("BROWSER_NOT_SUPPORT"===i){let e="resumeEffect: audio effect is not supported in this browser",t="resumeEffect: 当前浏览器不支持音效功能",i="The latest version of the Chrome browser is recommended",r="建议使用最新版的 Chrome 浏览器",s=g.IS_ZH?t:e,a=g.IS_ZH?r:i;return Promise.reject(new u.default({code:l.default.NOT_SUPPORT_ERROR,message:s,advice:a}))}if("NOT_PAUSED"===i){let e="resumeEffect: invalid operation",t="resumeEffect: 操作异常",i="audio effect is not paused",r="音效未暂停",s=g.IS_ZH?t:e,a=g.IS_ZH?r:i;return Promise.reject(new u.default({code:l.default.INVALID_OPERATION_ERROR,message:s,advice:a}))}if("SOUND_NOT_EXISTS"===i){let e="resumeEffect: audio effect file is not found",t="resumeEffect: 音效文件缺失",i="Please make sure the soundId correct",r="请确认 soundId 无误",s=g.IS_ZH?t:e,a=g.IS_ZH?r:i;return Promise.reject(new u.default({code:l.default.AUDIO_EFFECT_FILE_LOST_ERROR,message:s,advice:a}))}}if(!this.audio.webAudio)return;let r=(this.audio.mixAudioConf.sounds[e].pauseTime-this.audio.mixAudioConf.sounds[e].startTime)/1e3+this.audio.mixAudioConf.sounds[e].playStartTime;if(this.logger.log("resumeEffect 已经播放的时间: ",r),r>this.audio.mixAudioConf.sounds[e].totalTime){const t=Math.floor(r/this.audio.mixAudioConf.sounds[e].totalTime);this.logger.log("播发过的圈数 playedCycle: ",t),r%=this.audio.mixAudioConf.sounds[e].totalTime,this.audio.mixAudioConf.sounds[e].cycle=this.audio.mixAudioConf.sounds[e].cycle-t}this.audio.mixAudioConf.sounds[e].playOverTime=this.audio.mixAudioConf.sounds[e].totalTime,this.audio.mixAudioConf.sounds[e].cycle>1&&(this.audio.mixAudioConf.sounds[e].playOverTime=this.audio.mixAudioConf.sounds[e].cycle*this.audio.mixAudioConf.sounds[e].totalTime-this.audio.mixAudioConf.sounds[e].playStartTime),r>this.audio.mixAudioConf.sounds[e].totalTime&&(r%=this.audio.mixAudioConf.sounds[e].totalTime),this.audio.mixAudioConf.sounds[e].playStartTime=r,this.logger.log("resumeEffect 回复重置的时间点：",r),this.playEffect({soundId:e,filePath:this.audio.mixAudioConf.sounds[e].filePath,cycle:this.audio.mixAudioConf.sounds[e].cycle},r),this.audio.mixAudioConf.sounds[e].state="PLAYED",this.audio.mixAudioConf.sounds[e].startTime=Date.now(),this.stream.client.apiFrequencyControl({name:"resumeEffect",code:0,param:JSON.stringify(e,null," ")})}async setVolumeOfEffect(e,t){var i;const r={tag:"Stream.setVolumeOfEffect:soundId",value:e,min:1};m.isExistOptions(r).result&&m.checkValidInteger(r);const s={tag:"Stream.setVolumeOfEffect:volume",value:t,min:0,max:100};m.isExistOptions(s).result&&m.checkValidInteger(s),this.logger.log(`setVolumeOfEffect 设置 ${e} 音效文件的音量: ${t}`),this._initSoundIfNotExists(e);let a=null;if(this.audio.webAudio&&this.audio.webAudio.context||(this.logger.log("setVolumeOfEffect: 不支持音效功能"),a="BROWSER_NOT_SUPPORT"),a){let e="setVolumeOfEffect: audio effect is not supported in this browser",t="setVolumeOfEffect: 当前浏览器不支持音效功能",i="The latest version of the Chrome browser is recommended",r="建议使用最新版的 Chrome 浏览器",s=g.IS_ZH?t:e,a=g.IS_ZH?r:i;return Promise.reject(new u.default({code:l.default.NOT_SUPPORT_ERROR,message:s,advice:a}))}const o=null===(i=this.audio.mixAudioConf.sounds[e])||void 0===i?void 0:i.gainNode;o?o.gain.value=t/100:this.logger.log("setVolumeOfEffect: no gainNode"),this.audio.mixAudioConf.sounds[e].volume=t,this.stream.client.apiFrequencyControl({name:"setVolumeOfEffect",code:0,param:JSON.stringify({soundId:e,volume:t},null," ")})}async preloadEffect(e,t){const i={tag:"Stream.preloadEffect:filePath",value:t};m.checkExists(i);const r={tag:"Stream.preloadEffect:soundId",value:e};if(m.isExistOptions(r).result&&m.checkValidInteger(r),this.logger.log(`preloadEffect 设置soundId: ${e}, 音效文件的filePath: ${t}`),this._initSoundIfNotExists(e,t),this.audio.audioRoutingEnabled||this.enableAudioRouting(),this.audio.mixAudioConf.audioBuffer[t])this.logger.log("preloadEffect: 已经 load 音效文件");else try{await this.loadAudioBuffer(t),this.stream.client.apiFrequencyControl({name:"preloadEffect",code:0,param:JSON.stringify({soundId:e,filePath:t},null," ")})}catch(e){this.logger.error("preloadEffect 错误: ",e.name,e.message,e),this.stream.client.apiFrequencyControl({name:"preloadEffect",code:-1,param:JSON.stringify({reason:e},null," ")})}}async unloadEffect(e){const t={tag:"Stream.unloadEffect:soundId",value:e,min:1};if(m.isExistOptions(t).result&&m.checkValidInteger(t),this.logger.log(`unloadEffect： ${e} 音效文件`),!this.audio.mixAudioConf.sounds[e]){this.logger.log("unloadEffect: 没有该音效文件");let e="unloadEffect: audio effect file is not found",t="unloadEffect: 音效文件缺失",i="Please make sure the soundId correct",r="请确认 soundId 无误",s=g.IS_ZH?t:e,a=g.IS_ZH?r:i;return Promise.reject(new u.default({code:l.default.AUDIO_EFFECT_FILE_LOST_ERROR,message:s,advice:a}))}if("UNSTART"!==this.audio.mixAudioConf.sounds[e].state&&"STOPED"!==this.audio.mixAudioConf.sounds[e].state){this.logger.log("unloadEffect: 该音效文件已经播放，请使用 stopEffect 方法");let e="unloadEffect: invalid operation",t="unloadEffect: 操作异常",i="this audioEffect file is playing, please use stopEffect method",r="该音效文件已经播放，请使用 stopEffect 方法",s=g.IS_ZH?t:e,a=g.IS_ZH?r:i;return Promise.reject(new u.default({code:l.default.INVALID_OPERATION_ERROR,message:s,advice:a}))}delete this.audio.mixAudioConf.audioBuffer[this.audio.mixAudioConf.sounds[e].filePath],delete this.audio.mixAudioConf.sounds[e],this.stream.client.apiFrequencyControl({name:"unloadEffect",code:0,param:JSON.stringify({soundId:e},null," ")})}getEffectsVolume(){this.logger.log("getEffectsVolume");const e=[];return Object.values(this.audio.mixAudioConf.sounds).forEach(t=>{e.push({soundId:t.soundId,volume:t.volume})}),this.stream.client.apiFrequencyControl({name:"getEffectsVolume",code:0,param:JSON.stringify(e,null,2)}),e}setEffectsVolume(e){const t={tag:"Stream.setEffectsVolume:volume",value:e,min:0,max:100};m.isExistOptions(t).result&&m.checkValidInteger(t),this.logger.log("setEffectsVolume, 设置音量: "+e),Object.values(this.audio.mixAudioConf.sounds).forEach(t=>{this.setVolumeOfEffect(t.soundId,e)}),this.stream.client.apiFrequencyControl({name:"setEffectsVolume",code:0,param:JSON.stringify({volume:e},null,2)})}async stopAllEffects(){this.logger.log("stopAllEffects"),Object.values(this.audio.mixAudioConf.sounds).forEach(e=>{"PLAYED"!==e.state&&"PAUSED"!==e.state||this.stopEffect(e.soundId)}),this.stream.client.apiFrequencyControl({name:"stopAllEffects",code:0,param:JSON.stringify("stopAllEffects",null,2)})}async pauseAllEffects(){this.logger.log("pauseAllEffects"),Object.values(this.audio.mixAudioConf.sounds).forEach(e=>{"PLAYED"===e.state&&this.pauseEffect(e.soundId)}),this.stream.client.apiFrequencyControl({name:"pauseAllEffects",code:0,param:JSON.stringify("pauseAllEffects",null,2)})}async resumeAllEffects(){this.logger.log("resumeAllEffects"),Object.values(this.audio.mixAudioConf.sounds).forEach(e=>{"PAUSED"===e.state&&this.resumeEffect(e.soundId)}),this.stream.client.apiFrequencyControl({name:"resumeAllEffects",code:0,param:JSON.stringify("resumeAllEffects",null,2)})}getAudioEffectsTotalTime(e){const{soundId:t,filePath:i,cycle:r=1}=e;if(!this.audio.mixAudioConf||"{}"===JSON.stringify(this.audio.mixAudioConf.sounds))return this.logger.log("getAudioEffectsTotalTime: 当前没有音效文件"),Promise.resolve();let s;return this._initSoundIfNotExists(t,i),"PLAYED"===this.audio.mixAudioConf.sounds[t].state&&(s=this.audio.mixAudioConf.sounds[t].totalTime),this.stream.client.apiFrequencyControl({name:"getAudioMixingTotalTime",code:0,param:JSON.stringify({totalTime:s},null," ")}),s}getAudioEffectsPlayedTime(e){const{soundId:t,filePath:i,cycle:r=1}=e;if(!this.audio.mixAudioConf||"{}"===JSON.stringify(this.audio.mixAudioConf.sounds))return this.logger.log("getAudioEffectsTotalTime: 当前没有音效文件"),Promise.resolve();this._initSoundIfNotExists(t,i);let s=Date.now();"PAUSED"==this.audio.mixAudioConf.sounds[t].state&&(this.logger.log("当前是暂停状态"),s=this.audio.mixAudioConf.sounds[t].pauseTime);let a=(s-this.audio.mixAudioConf.sounds[t].startTime)/1e3+this.audio.mixAudioConf.sounds[t].playStartTime;return a>this.audio.mixAudioConf.sounds[t].totalTime&&(a%=this.audio.mixAudioConf.sounds[t].totalTime),this.stream.client.apiFrequencyControl({name:"getAudioMixingPlayedTime",code:0,param:JSON.stringify({playTime:a},null," ")}),{playedTime:a}}loadAudioBuffer(e){return c.ajax({url:e,type:"GET",dataType:"arraybuffer"}).then(t=>(this.logger.log("loadAudioBuffer 加载 audio file 成功"),new Promise((i,r)=>{if(this.audio.webAudio&&this.audio.webAudio.context)this.audio.webAudio.context.decodeAudioData(t,t=>{this.logger.log("loadAudioBuffer audio file 解码成功"),this.audio.mixAudioConf.audioBuffer[e]=t,i(t)},e=>{this.logger.log("loadAudioBuffer 云端音乐解码失败：",e);let t=`loadAudioBuffer: audio decode failed: ${e.name} ${e.message}`,i=`loadAudioBuffer: 云端音乐解码失败: ${e.name} ${e.message}`,s=g.IS_ZH?i:t,a=g.IS_ZH?"请联系云信技术支持":"Please contact CommsEase technical support";r(new u.default({code:l.default.AUDIO_MIX_DECODE_FAILED_ERROR,message:s,advice:a}))});else{let e="loadAudioBuffer:  webAudio lost",t="loadAudioBuffer:  webAudio 丢失",i="Please contact CommsEase technical support",s="请联系云信技术支持",a=g.IS_ZH?t:e,o=g.IS_ZH?s:i;r(new u.default({code:l.default.AUDIO_MIX_FILE_ERROR,message:a,advice:o}))}}))).catch(e=>{this.logger.log("loadAudioBuffer 加载云端音乐失败: ",e);let t=`loadAudioBuffer: load audio failed: ${e.name} ${e.message}`,i=`loadAudioBuffer: 加载云端音乐失败: ${e.name} ${e.message}`,r=g.IS_ZH?i:t,s=g.IS_ZH?"请联系云信技术支持":"Please contact CommsEase technical support";return Promise.reject(new u.default({code:l.default.AUDIO_MIX_FILE_ERROR,message:r,advice:s}))})}getAudioInputTracks(){var e,t;let i=[];return"live"===(null===(e=this.audio.audioSource)||void 0===e?void 0:e.readyState)&&i.push(this.audio.audioSource),"live"===(null===(t=this.audio.micTrack)||void 0===t?void 0:t.readyState)&&i.push(this.audio.micTrack),i}getAudioSlaveInputTracks(){var e,t;let i=[];return"live"===(null===(e=this.screenAudio.screenAudioTrack)||void 0===e?void 0:e.readyState)&&i.push(this.screenAudio.screenAudioTrack),"live"===(null===(t=this.screenAudio.screenAudioSource)||void 0===t?void 0:t.readyState)&&i.push(this.screenAudio.screenAudioSource),i}enableAudioRouting(){if(this.audio.webAudio&&this.audio.webAudio.destination){this.audio.audioRoutingEnabled=!0;const e=this.audio.webAudio.destination.stream.getAudioTracks()[0];this.logger.log("enableAudioRouting: ",e.label);const t=this.audio.audioStream.getAudioTracks()[0];t&&(e.enabled=t.enabled,t.enabled=!0),p.emptyStreamWith(this.audio.audioStream,e),this.stream.audioLevelHelper&&this.stream.audioLevelHelper.updateStream(this.audio.audioStream),this.updateAudioSender(e)}else this.logger.log("enableAudioRouting: 已替换为Destination")}disableAudioRouting(){const e=this.getAudioInputTracks();if(e.length){1===e.length?this.logger.log("disableAudioRouting: ",e[0].label):this.logger.warn("disableAudioRouting: 仍然有多于一个输入",...e);const t=this.audio.audioStream.getAudioTracks()[0];p.emptyStreamWith(this.audio.audioStream,e[0]),e[0].enabled=t.enabled,t.enabled=!0,this.updateAudioSender(e[0])}else this.logger.log("disableAudioRouting quiet."),p.emptyStreamWith(this.audio.audioStream,null);this.audio.audioRoutingEnabled=!1}updateAudioSender(e){var t,i,r,s,a,o,n,d,c,l,u,h,p,m,f,g,v;if(this.stream.isRemote)throw new Error("updateAudioSender only for localStream");if(null===(i=null===(t=this.stream.getAdapterRef())||void 0===t?void 0:t._mediasoup)||void 0===i?void 0:i._micProducer)if(null===(a=null===(s=null===(r=this.stream.getAdapterRef())||void 0===r?void 0:r._mediasoup)||void 0===s?void 0:s._micProducer)||void 0===a?void 0:a._rtpSender)this.logger.info("updateAudioSender: 替换当前_micProducer的track",e.label),null===(c=null===(d=null===(n=null===(o=this.stream.getAdapterRef())||void 0===o?void 0:o._mediasoup)||void 0===n?void 0:n._micProducer)||void 0===d?void 0:d._rtpSender)||void 0===c||c.replaceTrack(e);else if(null===(p=null===(h=null===(u=null===(l=this.stream.getAdapterRef())||void 0===l?void 0:l._mediasoup)||void 0===u?void 0:u._sendTransport)||void 0===h?void 0:h.handler)||void 0===p?void 0:p._pc){const t=null===(g=null===(f=null===(m=this.stream.getAdapterRef())||void 0===m?void 0:m._mediasoup)||void 0===f?void 0:f._sendTransport)||void 0===g?void 0:g.handler._pc.audioSender;t&&(this.logger.info("updateAudioSender: 替换audioSender",null===(v=null==t?void 0:t.track)||void 0===v?void 0:v.label),t.replaceTrack(e))}}enablePreProcessing(e,t){R.enablePreProcessing(this,e,t)}disablePreProcessing(e,t=!1){R.disablePreProcessing(this,e,t)}canDisablePreProcessing(e){return R.canDisablePreProcessing(this,e)}getPreprocessingStats(e="video"){var t;const i=null===(t=this[e].preProcessing)||void 0===t?void 0:t.history;if(!(null==i?void 0:i.length))return null;const r=i[i.length-1].endTs-i[0].startTs,s={total:0};for(let e=0;e<i.length;e++){s.total+=i[e].endTs-i[e].startTs;for(let t of i[e].handlerTs)t.spent>0&&(s[t.name]||(s[t.name]=0),s[t.name]+=t.spent)}return{fps:1e3*i.length/r,load:s.total/r,delay:s.total/i.length,spent:s}}destroy(){this.logger.log("清除 meida"),this._reset()}}t.MediaHelper=w},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.StageAIProcessing=void 0;const r=i(157),s=i(277);class a extends r.StageBase{constructor(e,t){super(e),this.type="stageAIProcessing",this.node=null,this.audioWorkletAgent=null,this.AIDenoise=null,this.enableAIDenoise=!0,this.pluginList=[],this.logger=t,this.enabled=!1}hasPlugin(e){return-1!==this.pluginList.indexOf(e)}registerPlugin(e,t,i){"AIDenoise"===e&&(this.registerAIDenoisePlugin(t,i),this.pluginList.push("AIDenoise"))}registerAIDenoisePlugin(e,t){this.AIDenoise=e}async init(){var e;this.state="INITING",this.audioWorkletAgent||(this.audioWorkletAgent=new s.AudioWorkletAgent({logger:this.logger,context:this.context}),this.node=this.audioWorkletAgent.node,await this.audioWorkletAgent.init(),this.audioWorkletAgent.on("rawinputs",e=>{this.enabled&&this.AIDenoise&&this.AIDenoise.load&&this.AIDenoise.process(e.inputs[0],t=>{t.length&&(e.inputs[0]=t),this.audioWorkletAgent.outputData(e.inputs[0])})})),null===(e=this.AIDenoise)||void 0===e||e.init(),this.state="INITED"}unregisterAIDenoise(){this.AIDenoise&&(this.AIDenoise.destroy(),this.AIDenoise=null),this.state="UNINIT"}}t.StageAIProcessing=a},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Play=void 0;const n=i(13),d=o(i(11)),c=o(i(12)),l=a(i(2)),u=i(138),h=i(61),p=i(5),m=i(280),f=i(281),g=i(282);class v extends n.EventEmitter{constructor(e){super(),this.videoSize={width:0,height:0},this.screenSize={width:0,height:0},this.mask={enabled:!1},this._reset(),this.stream=e.stream,this.logger=e.stream.logger.getChild(()=>{var e,t;let i="player";return(null===(e=this.audioDom)||void 0===e?void 0:e.paused)&&(i+=" audio_paused"),(null===(t=this.audioSlaveDom)||void 0===t?void 0:t.paused)&&(i+=" audioSlave_paused"),this.stream._play!==this&&(i+=" DETACHED"),i}),this.videoDom=null,this.screenDom=null,this.audioDom=null,this.audioSlaveDom=null,this.videoContainerDom=null,this.screenContainerDom=null,this.videoView=null,this.screenView=null,this.volume=null,this.audioSlaveVolume=null,this.index=0,this.videoRenderMode={width:0,height:0,cut:!1},this.screenRenderMode={width:0,height:0,cut:!1},this.audioSinkId="",this.watermark={video:{canvasControl:m.createCanvasWatermarkControl(this.logger),encoderControl:f.createEncoderWatermarkControl(this.logger)},screen:{canvasControl:m.createCanvasWatermarkControl(this.logger),encoderControl:f.createEncoderWatermarkControl(this.logger)}}}get getVideoDom(){return this.videoContainerDom}_reset(){this.videoDom=null,this.screenDom=null,this.videoContainerDom=null,this.screenContainerDom=null,this.videoView=null,this.screenView=null,this.audioDom=null,this.audioSlaveDom=null,this.volume=null,this.index=0,this.videoRenderMode={width:0,height:0,cut:!1},this.screenRenderMode={width:0,height:0,cut:!1}}_initNodeVideo(e){if(this._initVideoContainer(e),this._initVideo(),this.videoDom&&this.videoContainerDom){if(this.videoContainerDom==this.videoDom.parentNode)return void this.logger.log("[Play] initVideoNode: 节点已挂载，请勿重复挂载");this.videoContainerDom.appendChild(this.videoDom),this.logger.log("[Play] initVideoNode")}}_initNodeScreen(){if(this._initScreenContainer(),this._initScreen(),this.screenDom&&this.screenContainerDom){if(this.screenContainerDom==this.screenDom.parentNode)return void this.logger.log("[Play] initscreenNode: 节点已挂载，请勿重复挂载");this.screenContainerDom.appendChild(this.screenDom),this.logger.log("[Play] initscreenNode, screenContainerDom: ",this.screenContainerDom.outerHTML)}}_initVideoContainer(e){this.videoView&&(this.videoContainerDom||(this.videoContainerDom=document.createElement("div"),this.videoContainerDom.className="local"===e?"nertc-video-container-local":"nertc-video-container-remote",this.videoContainerDom.style.overflow="hidden",this.videoContainerDom.style.position="relative",this.videoContainerDom.style.width=this.videoView.clientWidth+"px",this.videoContainerDom.style.height=this.videoView.clientHeight+"px",this.videoContainerDom.style.display="inline-block"))}_initScreenContainer(){this.screenContainerDom||(this.screenContainerDom=document.createElement("div"),this.screenContainerDom.className="nertc-screen-container",this.screenContainerDom.style.overflow="hidden",this.screenContainerDom.style.position="relative",this.screenContainerDom.style.width=this.screenRenderMode.width+"px",this.screenContainerDom.style.height=this.screenRenderMode.height+"px",this.screenContainerDom.style.display="inline-block")}_initVideo(){this.videoDom||(this.videoDom=document.createElement("video"),this.videoDom.style.position="absolute",this.videoDom.style.left="50%",this.videoDom.style.top="50%",this.videoDom.style.transform="translate(-50%,-50%)",this.videoDom.setAttribute("x-webkit-airplay","x-webkit-airplay"),this.videoDom.setAttribute("playsinline","playsinline"),this.videoDom.setAttribute("webkit-playsinline","webkit-playsinline"),this.videoDom.preload="auto",this.videoDom.dataset.uid=""+this.stream.getId(),this.videoDom.autoplay=!0,this.videoDom.muted=!0,this.videoSize.width=0,this.videoSize.height=0,this.videoDom.addEventListener("resize",e=>{if(!this.videoDom||this.videoDom!==e.target)return;const t=this.videoDom.videoWidth,i=this.videoDom.videoHeight;t===this.videoSize.width&&i===this.videoSize.height||(this.logger.log(`[Play] 主流视频分辨率发生变化：${this.videoSize.width}x${this.videoSize.height} => ${t}x${i}。当前父节点：${h.getDomInfo(this.videoView)}`),t>i&&this.videoSize.width>this.videoSize.height||t<i&&this.videoSize.width<this.videoSize.height||this.setVideoRender(),this.videoSize.width=t,this.videoSize.height=i)}),p.getParameters().controlOnPaused&&(this.videoDom.addEventListener("pause",this.showControlIfVideoPause.bind(this)),this.videoDom.addEventListener("play",this.handleVideoScreenPlay.bind(this)),this.videoDom.addEventListener("click",this.handleVideoScreenClick.bind(this))))}showControlIfVideoPause(){this.videoDom&&this.videoDom.paused&&this.logger.log("[Play] 可能遇到了播放问题","video"),this.screenDom&&this.screenDom.paused&&this.logger.log("[Play] 可能遇到了播放问题","screen")}handleVideoScreenClick(){this.audioDom&&this.audioDom.paused&&(this.logger.log("[Play] 侦测到视频点击，尝试恢复音频播放"),this.audioDom.play()),this.audioSlaveDom&&this.audioSlaveDom.paused&&(this.logger.log("[Play] 侦测到视频点击，尝试恢复音频辅流播放"),this.audioSlaveDom.play())}handleVideoScreenPlay(){this.videoDom&&!this.videoDom.paused&&this.logger.log("[Play] 侦测到视频播放"),this.screenDom&&!this.screenDom.paused&&this.logger.log("[Play] 侦测到辅流播放")}_initScreen(){this.screenDom||(this.screenDom=document.createElement("video"),this.screenDom.style.position="absolute",this.screenDom.style.left="50%",this.screenDom.style.top="50%",this.screenDom.style.transform="translate(-50%,-50%)",this.screenDom.setAttribute("x-webkit-airplay","x-webkit-airplay"),this.screenDom.setAttribute("playsinline","playsinline"),this.screenDom.setAttribute("webkit-playsinline","webkit-playsinline"),this.screenDom.preload="auto",this.screenDom.dataset.uid=""+this.stream.getId(),this.screenDom.autoplay=!0,this.screenDom.muted=!0,this.screenSize.width=0,this.screenSize.height=0,this.screenDom.addEventListener("resize",e=>{if(!this.screenDom||this.screenDom!==e.target)return;const t=this.screenDom.videoWidth,i=this.screenDom.videoHeight;t===this.screenSize.width&&i===this.screenSize.height||(this.logger.log(`[Play] 辅流视频分辨率发生变化：${this.screenSize.width}x${this.screenSize.height} => ${t}x${i}`),t>i&&this.screenSize.width>this.screenSize.height||t<i&&this.screenSize.width<this.screenSize.height||this.setScreenRender(),this.screenSize.width=t,this.screenSize.height=i)}),p.getParameters().controlOnPaused&&(this.screenDom.addEventListener("pause",this.showControlIfVideoPause.bind(this)),this.screenDom.addEventListener("play",this.handleVideoScreenPlay.bind(this)),this.screenDom.addEventListener("click",this.handleVideoScreenClick.bind(this))))}_removeUselessDom(){if(!this.videoView)return;for(var e=this.videoView.children.length-1;e>=0;e--)this.videoView.children[e].outerHTML.indexOf("data-uid=")&&(this.logger.log("[Play] 删除多余的节点: ",this.videoView.children[e].outerHTML),this.videoView.removeChild(this.videoView.children[e]))}_mountVideoToDom(){if(this.videoContainerDom){if(this.videoView==this.videoContainerDom.parentNode)return void this.logger.log("[Play] mountVideoToDom: 节点已挂载，请勿重复挂载");this.logger.log("[Play] mountVideoToDom"),this.videoView&&(this.videoView.appendChild(this.videoContainerDom),this.logger.log("[Play] 视频主流dom节点挂载成功。父节点："+h.getDomInfo(this.videoView)),this.watermark.video.canvasControl.watermarks.length?this.watermark.video.canvasControl.start(this.videoContainerDom):this.watermark.video.canvasControl.div=this.videoContainerDom)}}_mountScreenToDom(){if(this.screenContainerDom){if(this.screenView==this.screenContainerDom.parentNode)return void this.logger.log("[Play] mountScreenToDom: 节点已挂载，请勿重复挂载");this.logger.log("[Play] mountScreenToDom: screenContainerDom: ",this.screenContainerDom.outerHTML),this.screenView&&(this.screenView.appendChild(this.screenContainerDom),this.logger.log("[Play] 视频辅流dom节点挂载成功。父节点："+h.getDomInfo(this.screenView)),this.watermark.screen.canvasControl.watermarks.length?this.watermark.screen.canvasControl.start(this.screenContainerDom):this.watermark.screen.canvasControl.div=this.screenContainerDom)}}async resume(){const e=this.audioDom&&this.audioDom.paused,t=this.audioSlaveDom&&this.audioSlaveDom.paused,i=this.videoDom&&this.videoDom.paused,r=this.screenDom&&this.screenDom.paused,s=[];this.audioDom&&this.audioDom.paused&&s.push(this.audioDom.play()),this.audioSlaveDom&&this.audioSlaveDom.paused&&s.push(this.audioSlaveDom.play()),this.videoDom&&this.videoDom.paused&&s.push(this.videoDom.play()),this.screenDom&&this.screenDom.paused&&s.push(this.screenDom.play());try{await Promise.all(s)}catch(e){if(this.logger.error("[Resume] 恢复播放 出现问题:",e.name,e.message),"notAllowedError"===e.name||"NotAllowedError"===e.name){let t="resume: "+e.message,i="resume: 浏览器自动播放受限: "+e.name,r="Please refer to the suggested link for processing --\x3e ",s="请参考提示的链接进行处理 --\x3e ",a=l.IS_ZH?i:t,o=l.IS_ZH?s:r;throw new c.default({code:d.default.AUTO_PLAY_NOT_ALLOWED,url:"https://doc.yunxin.163.com/docs/jcyOTA0ODM/jM3NDE0NTI?platformId=50082",message:a,advice:o})}}e&&this.logger.log("[Resume] 恢复播放音频"+(this.audioDom&&!this.audioDom.paused?"成功":"失败")),t&&this.logger.log("[Resume] 恢复播放音辅流"+(this.audioSlaveDom&&!this.audioSlaveDom.paused?"成功":"失败")),i&&this.logger.log("[Resume] 恢复播放视频"+(this.videoDom&&!this.videoDom.paused?"成功":"失败")),r&&this.logger.log("[Resume] 恢复播放辅流"+(this.screenDom&&!this.screenDom.paused?"成功":"失败"))}async playAudioStream(e,t){if(!e)return;if(this.audioDom||(this.audioDom=document.createElement("audio")),this.audioDom.muted=!!t,this.audioDom.srcObject=e,this.audioSinkId&&e.getAudioTracks().length)try{this.logger.log("[Play] 音频尝试使用输出设备",this.audioSinkId),await this.audioDom.setSinkId(this.audioSinkId),this.logger.log("[Play] 音频使用输出设备成功",this.audioSinkId)}catch(e){this.logger.error("[Play] 音频输出设备切换失败",e.name,e.message,e)}if(!e.active)return;await this.isPlayAudioStream()&&this.logger.log("[Play] 音频播放正常");try{this.audioDom.muted=!1,await g.playMedia(this.audioDom,p.getParameters().playMediaTimeout),this.logger.log("[Play] 播放音频完成，当前播放状态:",this.audioDom&&this.audioDom.played&&this.audioDom.played.length),this.stream.client.updateRecordingAudioStream()}catch(e){if(this.logger.warn("[Play] 播放音频出现问题: ",e.name,e.message,e),"notAllowedError"===e.name||"NotAllowedError"===e.name){let t="playAudioStream: "+e.message,i="playAudioStream: 浏览器自动播放受限: "+e.name,r="Please refer to the suggested link for processing --\x3e ",s="请参考提示的链接进行处理 --\x3e ",a=l.IS_ZH?i:t,o=l.IS_ZH?s:r;throw new c.default({code:d.default.AUTO_PLAY_NOT_ALLOWED,url:"https://doc.yunxin.163.com/docs/jcyOTA0ODM/jM3NDE0NTI?platformId=50082",message:a,advice:o})}}}async playAudioSlaveStream(e,t){if(!e)return;if(this.audioSlaveDom||(this.audioSlaveDom=document.createElement("audio")),this.audioSlaveDom.muted=!!t,this.audioSlaveDom.srcObject=e,this.audioSinkId&&e.getAudioTracks().length)try{this.logger.log("[Play] 音频辅流尝试使用输出设备",this.audioSinkId),await this.audioDom.setSinkId(this.audioSinkId),this.logger.log("[Play] 音频辅流使用输出设备成功",this.audioSinkId)}catch(e){this.logger.error("[Play] 音频辅流输出设备切换失败",e.name,e.message,e)}if(!e.active)return;await this.isPlayAudioSlaveStream()&&this.logger.log("[Play] 音频辅流播放正常");try{this.audioSlaveDom.muted=!1,await g.playMedia(this.audioSlaveDom,p.getParameters().playMediaTimeout),this.logger.log("[Play] 播放音频完成，当前播放状态:",this.audioSlaveDom&&this.audioSlaveDom.played&&this.audioSlaveDom.played.length)}catch(e){if(this.logger.warn("[Play] 播放音频出现问题: ",e.name,e.message,e),"notAllowedError"===e.name||"NotAllowedError"===e.name){let t="playAudioSlaveStream: "+e.message,i="playAudioSlaveStream: 浏览器自动播放受限: "+e.name,r="Please refer to the suggested link for processing --\x3e ",s="请参考提示的链接进行处理 --\x3e ",a=l.IS_ZH?i:t,o=l.IS_ZH?s:r;throw new c.default({code:d.default.AUTO_PLAY_NOT_ALLOWED,url:"https://doc.yunxin.163.com/docs/jcyOTA0ODM/jM3NDE0NTI?platformId=50082",message:a,advice:o})}}}async stopPlayAudioStream(){this.audioDom&&(this.audioDom.muted=!0,this.audioDom.srcObject=null)}async stopPlayAudioSlaveStream(){this.audioSlaveDom&&(this.audioSlaveDom.muted=!0,this.audioSlaveDom.srcObject=null)}setPlayVolume(e){this.volume=e,this.audioDom&&(this.audioDom.volume=e/255)}setPlayAudioSlaveVolume(e){this.audioSlaveVolume=e,this.audioSlaveDom&&(this.audioSlaveDom.volume=e/255)}async isPlayAudioStream(e=!0){var t;const i=async e=>{if(e&&await new Promise(t=>{setTimeout(t,e)}),this.audioDom){let e=this.audioDom.played.length;return e>=1?this.audioDom.played.end(e-1):0}return 0};if(!(null===(t=this.audioDom)||void 0===t?void 0:t.srcObject)||this.audioDom.paused)return!1;const r=await i(0);if(!r)return!1;const s=await i(500);return!!s&&s>r}async isPlayAudioSlaveStream(e=!0){const t=async e=>{if(e&&await new Promise(t=>{setTimeout(t,e)}),this.audioSlaveDom){let e=this.audioSlaveDom.played.length;return e>=1?this.audioSlaveDom.played.end(e-1):0}return 0};if(!this.audioSlaveDom||!this.audioSlaveDom.srcObject)return!e;const i=await t(0);if(!i)return!1;const r=await t(500);return!!r&&r>i}async isPlayVideoStream(){var e;const t=async e=>{var t;e&&await new Promise(t=>{setTimeout(t,e)});const i=null===(t=this.videoDom)||void 0===t?void 0:t.getVideoPlaybackQuality();return i?i.totalVideoFrames:0};if(!(null===(e=this.videoDom)||void 0===e?void 0:e.srcObject)||this.videoDom.paused)return!1;const i=await t(0);if(!i)return!1;for(let e=0;e<3e3;e+=50){if(await t(50)>i)return!0}return!1}async isPlayScreenStream(){var e;const t=async e=>{var t;e&&await new Promise(t=>{setTimeout(t,e)});const i=null===(t=this.screenDom)||void 0===t?void 0:t.getVideoPlaybackQuality();return i?i.totalVideoFrames:0};if(!(null===(e=this.screenDom)||void 0===e?void 0:e.srcObject)||this.screenDom.paused)return!1;const i=await t(0);if(!i)return!1;for(let e=0;e<3e3;e+=50){if(await t(50)>i)return!0}return!1}async isPlayStreamError(e){switch(e){case"audio":return this.isPlayAudioStream();case"video":return this.isPlayVideoStream();case"screen":return this.isPlayScreenStream();default:return!0}}async playVideoStream(e,t,i){var r,s,a,o,n,u;if(e&&t)if((null===(r=this.videoDom)||void 0===r?void 0:r.srcObject)!==e)if(this.videoView=t,this._initNodeVideo(i),this._mountVideoToDom(),this.videoDom){this.mask.enabled&&this.enableMask();try{const t=e.getVideoTracks()[0];t?this.logger.log(`[Play] 开始加载主流播放视频源：视频参数 "${t.label}",enabled ${t.enabled} , ${JSON.stringify(t.getSettings())}`):this.logger.error("[Play] 加载主流播放视频源失败：没有视频源"),this.videoDom.srcObject=e,await g.playMedia(this.videoDom,p.getParameters().playMediaTimeout),this.logger.log(`[Play] 成功加载主流播放视频源：当前视频实际分辨率${null===(s=this.videoDom)||void 0===s?void 0:s.videoWidth}x${null===(a=this.videoDom)||void 0===a?void 0:a.videoHeight}，显示宽高${null===(o=this.videoDom)||void 0===o?void 0:o.offsetWidth}x${null===(n=this.videoDom)||void 0===n?void 0:n.offsetHeight}`),(null===(u=this.videoDom)||void 0===u?void 0:u.paused)&&p.getParameters().controlOnPaused&&this.showControlIfVideoPause()}catch(e){if(this.logger.warn("[Play] 播放视频出现问题:",e.name,e.message,e),"notAllowedError"===e.name||"NotAllowedError"===e.name){let t="playVideoStream: "+e.message,i="playVideoStream: 浏览器自动播放受限: "+e.name,r="Please refer to the suggested link for processing --\x3e ",s="请参考提示的链接进行处理 --\x3e ",a=l.IS_ZH?i:t,o=l.IS_ZH?s:r;throw new c.default({code:d.default.AUTO_PLAY_NOT_ALLOWED,url:"https://doc.yunxin.163.com/docs/jcyOTA0ODM/jM3NDE0NTI?platformId=50082",message:a,advice:o})}}}else this.logger.error("[Play] 没有视频源");else this.logger.log("[Play] playVideoStream：跳过重复的播放请求")}async playScreenStream(e,t){var i,r,s,a,o,n;if(e&&t)if((null===(i=this.screenDom)||void 0===i?void 0:i.srcObject)!==e)if(this.logger.log(`[Play] 播放辅流视频, id: ${e.id}, active state: ${e.active}`),this.screenView=t,this._initNodeScreen(),this._mountScreenToDom(),this.screenDom){this.mask.enabled&&this.enableMask();try{const t=e.getVideoTracks()[0];t?this.logger.log(`[Play] 开始加载辅流播放视频源：视频参数 "${t.label}",enabled ${t.enabled} , ${JSON.stringify(t.getSettings())}`):this.logger.error("[Play] 加载主流播放视频源失败：没有视频源"),this.screenDom.srcObject=e,await g.playMedia(this.screenDom,p.getParameters().playMediaTimeout),this.logger.log(`[Play] 成功加载辅流播放视频源：当前视频实际分辨率${null===(r=this.screenDom)||void 0===r?void 0:r.videoWidth}x${null===(s=this.screenDom)||void 0===s?void 0:s.videoHeight}，显示宽高${null===(a=this.screenDom)||void 0===a?void 0:a.offsetWidth}x${null===(o=this.screenDom)||void 0===o?void 0:o.offsetHeight}`),(null===(n=this.screenDom)||void 0===n?void 0:n.paused)&&p.getParameters().controlOnPaused&&this.showControlIfVideoPause()}catch(e){if(this.logger.warn("[Play] 播放辅流出现问题:",e.name,e.message,e),"notAllowedError"===e.name||"NotAllowedError"===e.name){let t="playScreenStream: "+e.message,i="playScreenStream: 浏览器自动播放受限: "+e.name,r="Please refer to the suggested link for processing --\x3e ",s="请参考提示的链接进行处理 --\x3e ",a=l.IS_ZH?i:t,o=l.IS_ZH?s:r;throw new c.default({code:d.default.AUTO_PLAY_NOT_ALLOWED,url:"https://doc.yunxin.163.com/docs/jcyOTA0ODM/jM3NDE0NTI?platformId=50082",message:a,advice:o})}}}else this.logger.error("[Play] 辅流没有视频源");else this.logger.log("[Play] playScreenStream：跳过重复的播放请求")}async stopPlayVideoStream(){if(this.logger.log("stopPlayVideoStream 停止播发视频"),this.videoContainerDom&&this.videoDom){this.videoContainerDom==this.videoDom.parentNode?(this.logger.log("清除 videoDom"),this.videoContainerDom.removeChild(this.videoDom)):this.videoContainerDom.lastChild&&(this.logger.log("videoContainerDom 删除子节点"),this.videoContainerDom.removeChild(this.videoContainerDom.lastChild));try{this.videoDom.remove(),this.videoDom.srcObject=null,this.videoDom=null}catch(e){this.logger.log("stopPlayVideoStream e: ",e)}}this.videoView&&this.videoContainerDom&&(this.videoView==this.videoContainerDom.parentNode?(this.logger.log("清除 videoContainerDom"),this.videoView.removeChild(this.videoContainerDom)):this.videoView.lastChild&&(this.logger.log("videoView 删除子节点"),this.videoView.removeChild(this.videoView.lastChild),this.videoView.innerHTML=""),this.videoContainerDom=null,this.videoView=null)}async stopPlayScreenStream(){if(this.logger.log("stopPlayScreenStream: 停止播发屏幕共享"),this.screenContainerDom&&this.screenDom){this.screenContainerDom.removeChild(this.screenDom);try{this.screenDom.remove(),this.screenDom.srcObject=null,this.screenDom=null}catch(e){this.logger.log("stopPlayScreenStream: 停止播发屏幕共享",e.name,e.message)}}this.screenView&&this.screenContainerDom&&(this.screenView.removeChild(this.screenContainerDom),this.screenContainerDom=null,this.screenView=null)}setVideoRender(e){if(!this.videoDom)return;if(e?(this.logger.log("[Play] setVideoRender() options: "+JSON.stringify(e)),this.videoRenderMode=Object.assign({},e)):(e=this.videoRenderMode,this.logger.log("[Play] setVideoRender() existing videoRenderMode: "+JSON.stringify(e))),this.videoContainerDom?(this.videoContainerDom.style.width=e.width+"px",this.videoContainerDom.style.height=e.height+"px"):this.logger.warn("[Play] 未找到videoContainerDom"),!e.cut)return this.videoDom.style.height="100%",void(this.videoDom.style.width="100%");this.videoDom.videoWidth/this.videoDom.videoHeight>e.width/e.height?(this.videoDom.style.width="auto",this.videoDom.style.height="100%"):(this.videoDom.style.width="100%",this.videoDom.style.height="auto")}setScreenRender(e){if(!this.screenDom)return;if(e?(this.logger.log("[Play] setScreenRender() options: ",JSON.stringify(e,null," ")),this.screenRenderMode=Object.assign({},e)):(e=this.screenRenderMode,this.logger.log("[Play] setScreenRender() existing screenRenderMode: "+JSON.stringify(e))),this.screenRenderMode=e,this.screenContainerDom?(this.screenContainerDom.style.width=e.width+"px",this.screenContainerDom.style.height=e.height+"px"):this.logger.warn("[Play] 未找到screenContainerDom"),!e.cut)return this.screenDom.style.height="100%",void(this.screenDom.style.width="100%");this.screenDom.videoWidth/this.screenDom.videoHeight>e.width/e.height?(this.screenDom.style.width="auto",this.screenDom.style.height="100%"):(this.screenDom.style.width="100%",this.screenDom.style.height="auto")}async setAudioOutput(e){var t,i,r,s;this.audioSinkId=e,(null===(t=this.audioDom)||void 0===t?void 0:t.srcObject)&&(null===(i=this.audioDom)||void 0===i?void 0:i.srcObject).getAudioTracks().length&&(await this.audioDom.setSinkId(e),this.logger.log("[Play] setAudioOutput() 设置通话音频输出设备成功")),(null===(r=this.audioSlaveDom)||void 0===r?void 0:r.srcObject)&&(null===(s=this.audioSlaveDom)||void 0===s?void 0:s.srcObject).getAudioTracks().length&&(await this.audioSlaveDom.setSinkId(e),this.logger.log("[Play] setAudioOutput() 设置通话音频辅流输出设备成功"))}async takeSnapshot(e,t){let i=!e.mediaType&&this.videoDom||"video"===e.mediaType,r=!e.mediaType&&this.screenDom||"screen"===e.mediaType,s=new u.RTCCanvas("canvas"),a=s._canvas,o=s._ctx;if(!o){let e="takeSnapshot: context of canvas is not found",t="takeSnapshot: 未找到 canvas 中的 context",i="The latest version of the Chrome browser is recommended",r="建议使用最新版的 Chrome 浏览器",s=l.IS_ZH?t:e,a=l.IS_ZH?r:i;throw new c.default({code:d.default.NOT_FOUND_ERROR,message:s,advice:a})}if(!a){let e="takeSnapshot: canvas is not found",t="takeSnapshot: 未找到 canvas",i="The latest version of the Chrome browser is recommended",r="建议使用最新版的 Chrome 浏览器",s=l.IS_ZH?t:e,a=l.IS_ZH?r:i;throw new c.default({code:d.default.NOT_FOUND_ERROR,message:s,advice:a})}if(i){const i=e.name||(t||this.stream.getId())+"-"+this.index++;if(o.fillStyle="#ffffff",!this.videoDom){let e="takeSnapshot: videoDom is not found",t="takeSnapshot: 未找到 videoDom",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=l.IS_ZH?t:e,a=l.IS_ZH?r:i;throw new c.default({code:d.default.NOT_FOUND_ERROR,message:s,advice:a})}o.fillRect(0,0,this.videoDom.videoWidth,this.videoDom.videoHeight),s.setSize(this.videoDom.videoWidth,this.videoDom.videoHeight),o.drawImage(this.videoDom,0,0,this.videoDom.videoWidth,this.videoDom.videoHeight,0,0,this.videoDom.videoWidth,this.videoDom.videoHeight);const n=await new Promise((e,t)=>{a.toBlob(t=>{this.logger.log("takeSnapshot, 获取到截图的blob: ",t);let r=URL.createObjectURL(t);this.logger.log("截图的url: ",r);let s=document.createElement("a");document.body.appendChild(s),s.style.display="none",s.href=r,s.download=i+".png",s.click(),window.URL.revokeObjectURL(r),e(i+".png")})});if(!r)return s.destroy(),n}if(r){const i=e.name||(t||this.stream.getId())+"-"+this.index++;if(o.fillStyle="#ffffff",!this.screenDom){let e="takeSnapshot: screenDom is not found",t="takeSnapshot: 未找到 screenDom",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=l.IS_ZH?t:e,a=l.IS_ZH?r:i;throw new c.default({code:d.default.NOT_FOUND_ERROR,message:s,advice:a})}o.fillRect(0,0,this.screenDom.videoWidth,this.screenDom.videoHeight),s.setSize(this.screenDom.videoWidth,this.screenDom.videoHeight),o.drawImage(this.screenDom,0,0,this.screenDom.videoWidth,this.screenDom.videoHeight,0,0,this.screenDom.videoWidth,this.screenDom.videoHeight);const r=await new Promise((e,t)=>{a.toBlob(t=>{this.logger.log("takeSnapshot, 获取到截图的blob: ",t);let r=URL.createObjectURL(t);this.logger.log("截图的url: ",r);let s=document.createElement("a");document.body.appendChild(s),s.style.display="none",s.href=r,s.download=i+".png",s.click(),window.URL.revokeObjectURL(r),e(i+".png")})});return s.destroy(),r}}takeSnapshotBase64(e){let t=!e.mediaType&&this.videoDom||"video"===e.mediaType,i=!e.mediaType&&this.screenDom||"screen"===e.mediaType,r=new u.RTCCanvas("canvas"),s=r._canvas,a=r._ctx;if(!a){let e="takeSnapshotBase64: context of canvas is not found",t="takeSnapshotBase64: 未找到 canvas 中的 context",i="The latest version of the Chrome browser is recommended",r="建议使用最新版的 Chrome 浏览器",s=l.IS_ZH?t:e,a=l.IS_ZH?r:i;throw new c.default({code:d.default.NOT_FOUND_ERROR,message:s,advice:a})}if(!s){let e="takeSnapshotBase64: canvas is not found",t="takeSnapshotBase64: 未找到 canvas",i="The latest version of the Chrome browser is recommended",r="建议使用最新版的 Chrome 浏览器",s=l.IS_ZH?t:e,a=l.IS_ZH?r:i;throw new c.default({code:d.default.NOT_FOUND_ERROR,message:s,advice:a})}if(t){if(a.fillStyle="#ffffff",!this.videoDom){let e="takeSnapshotBase64: videoDom is not found",t="takeSnapshotBase64: 未找到 videoDom",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=l.IS_ZH?t:e,a=l.IS_ZH?r:i;throw new c.default({code:d.default.NOT_FOUND_ERROR,message:s,advice:a})}a.fillRect(0,0,this.videoDom.videoWidth,this.videoDom.videoHeight),r.setSize(this.videoDom.videoWidth,this.videoDom.videoHeight),a.drawImage(this.videoDom,0,0,this.videoDom.videoWidth,this.videoDom.videoHeight,0,0,this.videoDom.videoWidth,this.videoDom.videoHeight);const e=this.getBase64Image(s);if(!i)return r.destroy(),e}if(i){if(a.fillStyle="#ffffff",!this.screenDom){let e="takeSnapshotBase64: screenDom is not found",t="takeSnapshotBase64: 未找到 screenDom",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=l.IS_ZH?t:e,a=l.IS_ZH?r:i;throw new c.default({code:d.default.NOT_FOUND_ERROR,message:s,advice:a})}a.fillRect(0,0,this.screenDom.videoWidth,this.screenDom.videoHeight),r.setSize(this.screenDom.videoWidth,this.screenDom.videoHeight),a.drawImage(this.screenDom,0,0,this.screenDom.videoWidth,this.screenDom.videoHeight,0,0,this.screenDom.videoWidth,this.screenDom.videoHeight);const e=this.getBase64Image(s);return r.destroy(),e}}getBase64Image(e){return e.toDataURL("image/",1)}enableMask(){this.mask.enabled=!0,this.videoDom&&(this.videoDom.style.filter="blur(20px)")}disableMask(){this.mask.enabled=!1,this.videoDom&&(this.videoDom.style.filter=""),this.screenDom&&(this.screenDom.style.filter="")}destroy(){this.stopPlayAudioStream(),this.stopPlayVideoStream(),this.stopPlayScreenStream(),this._reset()}}t.Play=v},function(e,t,i){var r;!function(s){var a,o,n,d=(a=/d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZWN]|'[^']*'|'[^']*'/g,o=/\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,n=/[^-+\dA-Z]/g,function(e,t,i,r){if(1!==arguments.length||"string"!==h(e)||/\d/.test(e)||(t=e,e=void 0),(e=e||new Date)instanceof Date||(e=new Date(e)),isNaN(e))throw TypeError("Invalid date");var s=(t=String(d.masks[t]||t||d.masks.default)).slice(0,4);"UTC:"!==s&&"GMT:"!==s||(t=t.slice(4),i=!0,"GMT:"===s&&(r=!0));var p=i?"getUTC":"get",m=e[p+"Date"](),f=e[p+"Day"](),g=e[p+"Month"](),v=e[p+"FullYear"](),_=e[p+"Hours"](),S=e[p+"Minutes"](),y=e[p+"Seconds"](),R=e[p+"Milliseconds"](),b=i?0:e.getTimezoneOffset(),T=l(e),w=u(e),I={d:m,dd:c(m),ddd:d.i18n.dayNames[f],dddd:d.i18n.dayNames[f+7],m:g+1,mm:c(g+1),mmm:d.i18n.monthNames[g],mmmm:d.i18n.monthNames[g+12],yy:String(v).slice(2),yyyy:v,h:_%12||12,hh:c(_%12||12),H:_,HH:c(_),M:S,MM:c(S),s:y,ss:c(y),l:c(R,3),L:c(Math.round(R/10)),t:_<12?"a":"p",tt:_<12?"am":"pm",T:_<12?"A":"P",TT:_<12?"AM":"PM",Z:r?"GMT":i?"UTC":(String(e).match(o)||[""]).pop().replace(n,""),o:(b>0?"-":"+")+c(100*Math.floor(Math.abs(b)/60)+Math.abs(b)%60,4),S:["th","st","nd","rd"][m%10>3?0:(m%100-m%10!=10)*m%10],W:T,N:w};return t.replace(a,(function(e){return e in I?I[e]:e.slice(1,e.length-1)}))});function c(e,t){for(e=String(e),t=t||2;e.length<t;)e="0"+e;return e}function l(e){var t=new Date(e.getFullYear(),e.getMonth(),e.getDate());t.setDate(t.getDate()-(t.getDay()+6)%7+3);var i=new Date(t.getFullYear(),0,4);i.setDate(i.getDate()-(i.getDay()+6)%7+3);var r=t.getTimezoneOffset()-i.getTimezoneOffset();t.setHours(t.getHours()-r);var s=(t-i)/6048e5;return 1+Math.floor(s)}function u(e){var t=e.getDay();return 0===t&&(t=7),t}function h(e){return null===e?"null":void 0===e?"undefined":"object"!=typeof e?typeof e:Array.isArray(e)?"array":{}.toString.call(e).slice(8,-1).toLowerCase()}d.masks={default:"ddd mmm dd yyyy HH:MM:ss",shortDate:"m/d/yy",mediumDate:"mmm d, yyyy",longDate:"mmmm d, yyyy",fullDate:"dddd, mmmm d, yyyy",shortTime:"h:MM TT",mediumTime:"h:MM:ss TT",longTime:"h:MM:ss TT Z",isoDate:"yyyy-mm-dd",isoTime:"HH:MM:ss",isoDateTime:"yyyy-mm-dd'T'HH:MM:sso",isoUtcDateTime:"UTC:yyyy-mm-dd'T'HH:MM:ss'Z'",expiresHeaderFormat:"ddd, dd mmm yyyy HH:MM:ss Z"},d.i18n={dayNames:["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],monthNames:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec","January","February","March","April","May","June","July","August","September","October","November","December"]},void 0===(r=function(){return d}.call(t,i,t,e))||(e.exports=r)}()},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.measureText=t.numberToRGBA=void 0,t.numberToRGBA=function(e){if(0===e)return"rgba(0,0,0,0)";let t,i,r,s;return r=e%256,i=(e=Math.floor(e/256))%256,t=(e=Math.floor(e/256))%256,s=(e=Math.floor(e/256))>0?(e%256/256).toFixed(2):1,`rgba(${t}, ${i}, ${r}, ${s})`},t.measureText=function(e,t,i){if(!e)return{width:0,height:0};let r=document.createElement("div"),s=document.createElement("span");s.innerText=e,s.style.fontSize=t,s.style.fontFamily=i,r.style.opacity="0",r.style.position="absolute",r.style.height=t,document.body.appendChild(r),r.appendChild(s);const a=r.clientHeight,o=s.offsetWidth;return r.remove(),{width:o,height:a}}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.PlatformType=t.PlatformTypeMap=void 0,t.PlatformTypeMap={"-1":"unknown",1:"aos",2:"ios",4:"pc",8:"winphone",9:"mac",16:"web"},function(e){e[e.unknown=-1]="unknown",e[e.aos=1]="aos",e[e.ios=2]="ios",e[e.pc=4]="pc",e[e.winphone=8]="winphone",e[e.mac=9]="mac",e[e.web=16]="web"}(t.PlatformType||(t.PlatformType={}))},function(e,t,i){var r=a(i(59)),s=a(i(60));function a(e){return e&&e.__esModule?e:{default:e}}var o=i(166).EventEmitter,n=i(143);e.exports=class extends o{constructor(e){super(),this.setMaxListeners(1/0),this._logger=e||new n("EnhancedEventEmitter")}safeEmit(e){try{for(var t=arguments.length,i=Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];this.emit.apply(this,[e].concat(i))}catch(t){this._logger.error("safeEmit() | event listener threw an error [event:%s]:%o",e,t)}}safeEmitAsPromise(e){for(var t=this,i=arguments.length,a=Array(i>1?i-1:0),o=1;o<i;o++)a[o-1]=arguments[o];return(0,s.default)(r.default.mark((function i(){return r.default.wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return i.abrupt("return",new Promise((function(i,r){t.safeEmit.apply(t,[e].concat(a,[i,r]))})));case 1:case"end":return i.stop()}}),i,t)})))()}}},function(e,t,i){var r,s=i(101),a=(r=s)&&r.__esModule?r:{default:r};var o=i(143),n=i(288).generateRandomNumber,d=i(142),c=new o("Message");e.exports=class{static parse(e){var t=void 0,i={};try{t=d.parse(e)}catch(e){return void c.error("parse() | invalid JSONbig: %s",e)}if("object"===(void 0===t?"undefined":(0,a.default)(t))&&!Array.isArray(t)){if(t.request){if(i.request=!0,"string"!=typeof t.method)return void c.error("parse() | missing/invalid method field");if("number"!=typeof t.id)return void c.error("parse() | missing/invalid id field");i.id=t.id,i.method=t.method,i.data=t.data||{}}else if(t.response){if(i.response=!0,"number"!=typeof t.id)return void c.error("parse() | missing/invalid id field");i.id=t.id,t.ok?(i.ok=!0,i.data=t.data||{}):(i.ok=!1,i.errorCode=t.errorCode,i.errorReason=t.errorReason)}else{if(!t.notification)return void c.error("parse() | missing request/response field");if(i.notification=!0,"string"!=typeof t.method)return void c.error("parse() | missing/invalid method field");i.id=t.id,i.method=t.method,i.data=t.data||{}}return i}c.error("parse() | not an object")}static createRequest(e,t){return{request:!0,id:n(),method:e,data:t||{}}}static createSuccessResponse(e,t){return{response:!0,id:e.id,ok:!0,data:t||{}}}static createErrorResponse(e,t,i){return{response:!0,id:e.id,ok:!1,errorCode:t,errorReason:i}}static createNotification(e,t){return{notification:!0,method:e,data:t||{}}}}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.AdvBeautyFilter=t.resSet=void 0;const r=i(158),s=i(128),a=i(129),o=i(114),n=i(303),d=i(304),c=i(305),l=i(306),u=i(130),h=i(307),p=i(131);t.resSet={faceMask:"https://yx-web-nosdn.netease.im/common/6947be5d3e5604368401950ca0cf094d/facemask-01.png",eyeTeethMask:"https://yx-web-nosdn.netease.im/common/655421269305cac5c1e48d62f0fac8de/eye-teeth-mask-02.png",teethWhiten:"https://yx-web-nosdn.netease.im/common/ca8a6b0be3427ead9b19bcf9ae1245a8/teath.png"};const m={genTopFace(e){const t=h.Vector2.getVec(e,49),i=h.Vector2.getVec(e,43);let r=h.Vector2.sub(i,t),s=1.5*r.length;r=h.Vector2.normalize(r);const a=h.Vector2.sub(h.Vector2.getVec(e,0),i);let o=a.length;const n=h.Vector2.sub(h.Vector2.getVec(e,32),i);let d=n.length;const c=Math.max(o,d);let l=o/c,u=d/c;h.Vector2.setPoint(e,116,h.Vector2.add(i,h.Vector2.scale(r,s)));let p=h.Vector2.angle(a,r),m=h.Matrix3x3.rotate(p/-6,0,0),f=r;[110,109,108,107,106].forEach((t,r)=>{f=m.multiplyVector(f);const a=(r+1)/7,n=1*(1-a)+l*a;h.Vector2.setPoint(e,t,h.Vector2.add(i,h.Vector2.scale(f,s*n*(1-a)+o*a)))}),p=h.Vector2.angle(n,r),m=h.Matrix3x3.rotate(p/6,0,0),f=r,[115,114,113,112,111].forEach((t,r)=>{f=m.multiplyVector(f);const a=(r+1)/7,o=1*(1-a)+u*a;h.Vector2.setPoint(e,t,h.Vector2.add(i,h.Vector2.scale(f,s*o*(1-a)+d*a)))})},genFaceOutline(e){const t=[0,2,4,6,8,10,12,14,16,18,20,22,24,26,28,30,32,106,107,108,109,110,111,112,113,114,115,116],i=h.Vector2.getVec(e,43);for(let r=0;r<t.length;r++){const s=t[r],a=h.Vector2.getVec(e,s),o=h.Vector2.add(i,h.Vector2.scale(h.Vector2.sub(a,i),1.3)),n=2*(117+r);e[n]=o.value[0]>>0,e[n+1]=o.value[1]>>0}}},f=new Set;let g=null,v=null,_=null;class S extends p.Filter{constructor(e,t,i,s,a,n,d,c,l,u,h,p){super(e,t,i,null),this.isShowWire=!1,this.advData=null,this.wirePosBuffer=null,this.targetPosBuffer=null,this.zIndexBuffer=null,this.indicesBuffer=null,this.faceMaskUVBuffer=null,this.planePosBuffer=null,this.planeUVBuffer=null,this.advEyeTeethPosBuffer=null,this.advEyeTeethIndicesBuffer=null,this.advEyeTeethZindexBuffer=null,this.advEyeTeethUVBuffer=null,this.defParams={enlargeEye:0,roundedEye:0,openCanthus:0,eyeDistance:.5,eyeAngle:.5,shrinkNose:0,lengthenNose:.5,shrinkMouth:.5,widenMouth:.5,mouthCorners:.5,adjustPhiltrum:.5,shrinkUnderjaw:0,shrinkCheekbone:0,lengthenJaw:.5,narrowedFace:0,shrinkFace:0,vShapedFace:0,minifyFace:0,shortenFace:0,whitenTeeth:0,brightenEye:0,fadeHeadWrinkle:0,fadeEyeRim:0,fadeNoseLine:0},f.add(this),this.faceMaskMap=o.createTexture(this.renderer.gl,g),this.eyeTeethMaskMap=o.createTexture(this.renderer.gl,v),this.whiteTeethLutMap=o.createTexture(this.renderer.gl,_,{flipY:!1}),this.params=Object.assign({},this.defParams),m.genTopFace(this.posBuffer.typedArray),m.genFaceOutline(this.posBuffer.typedArray),this.targetPosBuffer=r.createAttributeBuffer(this.renderer.gl,"tPosition",this.posBuffer.typedArray.slice(0),2),this.zIndexBuffer=s,this.indicesBuffer=a,this.faceMaskUVBuffer=n,this.planePosBuffer=d,this.planeUVBuffer=c,this.advEyeTeethPosBuffer=l,this.advEyeTeethIndicesBuffer=u,this.advEyeTeethZindexBuffer=h,this.advEyeTeethUVBuffer=p,this.setWirePosBuffer(),this.initProgramBuffer()}setWirePosBuffer(){if(!this.isShowWire)return;const e=new Set,t=[],i=this.indicesBuffer.typedArray,s=this.posBuffer.typedArray,a=(i,r)=>{if(!e.has(i+"-"+r)&&!e.has(r+"-"+i)){e.add(i+"-"+r);const a=2*i,o=2*r;t.push(s[a],s[a+1],s[o],s[o+1])}};for(let e=0;e<(i.length-2)/3;e++){const t=3*e,r=i[t],s=i[t+1],o=i[t+2];a(r,s),a(s,o),a(o,r)}this.wirePosBuffer?this.programs.wire.updateAttribute("position",e=>{e.set(t,0)}):this.wirePosBuffer=r.createAttributeBuffer(this.renderer.gl,"position",new Int16Array(t),2)}initProgramBuffer(){const e=this.renderer.gl,t=this.renderer.getSize(),i={width:t.width>>2,height:t.height>>2};let r=null;if(this.isShowWire){const i=new a.Program(e,()=>{var t;e.drawArrays(e.LINES,0,(null===(t=this.wirePosBuffer)||void 0===t?void 0:t.count)||0)});i.setShader(c.advBeautyWireShader.vShader,"VERTEX"),i.setShader(c.advBeautyWireShader.fShader,"FRAGMENT"),i.setAttributeBuffer(this.wirePosBuffer),r=s.createFrameBuffer(e,t.width,t.height),i.setUniform("size",[t.width,t.height]),this.programs.wire=i,this.framebuffers.wire=r}const o=new a.Program(e,()=>{e.drawElements(e.TRIANGLES,this.indicesBuffer.count,e.UNSIGNED_SHORT,0)});o.setShader(d.advBeautyShader.vShader,"VERTEX"),o.setShader(d.advBeautyShader.fShader,"FRAGMENT"),o.setAttributeBuffer(this.posBuffer),o.setAttributeBuffer(this.targetPosBuffer),o.setAttributeBuffer(this.zIndexBuffer);const h=s.createFrameBuffer(e,t.width,t.height);o.setUniform("size",[t.width,t.height]),this.isShowWire&&o.setUniform("wireMap",r.targetTexture),o.setUniform("showWire",this.isShowWire?1:0),o.setUniform("map",this.map),o.setUniform("teethLut",this.whiteTeethLutMap),o.setUniform("teethIntensity",0),o.setUniform("eyeIntensity",0),o.setIndices(this.indicesBuffer),this.programs.morph=o,this.framebuffers.morph=h;const p=new a.Program(e,()=>{e.drawElements(e.TRIANGLES,this.indicesBuffer.count,e.UNSIGNED_SHORT,0)});p.setShader(l.advFaceMaskShader.vShader,"VERTEX"),p.setShader(u.baseTextureShader.fShader,"FRAGMENT"),p.setAttributeBuffer(this.targetPosBuffer),p.setAttributeBuffer(this.zIndexBuffer),p.setAttributeBuffer(this.faceMaskUVBuffer);const m=s.createFrameBuffer(e,i.width,i.height);p.setUniform("size",[t.width,t.height]),p.setUniform("map",this.faceMaskMap),p.setIndices(this.indicesBuffer),this.programs.faceMask=p,this.framebuffers.faceMask=m;const f=new a.Program(e,()=>{e.drawElements(e.TRIANGLES,this.advEyeTeethIndicesBuffer.count,e.UNSIGNED_SHORT,0)});f.setShader(l.advFaceMaskShader.vShader,"VERTEX"),f.setShader(u.baseTextureShader.fShader,"FRAGMENT"),f.setAttributeBuffer(this.advEyeTeethPosBuffer),f.setAttributeBuffer(this.advEyeTeethZindexBuffer),f.setAttributeBuffer(this.advEyeTeethUVBuffer);const g=s.createFrameBuffer(e,i.width,i.height);f.setUniform("size",[t.width,t.height]),f.setUniform("map",this.eyeTeethMaskMap),f.setIndices(this.advEyeTeethIndicesBuffer),this.programs.eyeTeeth=f,this.framebuffers.eyeTeeth=g,o.setUniform("eyeTeethMaskMap",g.targetTexture);for(let r=0;r<2;r++){const o=new a.Program(e);o.setShader(u.baseTextureShader.vShader,"VERTEX"),o.setShader(n.advBeautyEyeShader.fShader,"FRAGMENT"),o.setAttributeBuffer(this.planePosBuffer),o.setAttributeBuffer(this.planeUVBuffer);const d=s.createFrameBuffer(e,t.width,t.height);o.setUniform("map",0===r?h.targetTexture:this.framebuffers.lEye.targetTexture),o.setUniform("eyeCenter",[0,0]),o.setUniform("rdIntensity",0),o.setUniform("lgIntensity",0),o.setUniform("intensRatio",0),o.setUniform("range",0),o.setUniform("rdDir",[0,0]);const c=["lEye","rEye"][r];this.programs[c]=o,this.framebuffers[c]=d;const p=new a.Program(e);p.setShader(u.baseTextureShader.vShader,"VERTEX"),p.setShader(l.advFaceMaskShader.fShader,"FRAGMENT"),p.setAttributeBuffer(this.planePosBuffer),p.setAttributeBuffer(this.planeUVBuffer);const f=s.createFrameBuffer(e,i.width,i.height);p.setUniform("map",null),p.setUniform("maskMap",m.targetTexture),p.setUniform("index",r),this.programs["faceMaskMerge"+r]=p,this.framebuffers["faceMaskMerge"+r]=f}}get output(){return this.advData?this.framebuffers.rEye.targetTexture:super.output}get faceMask(){if(this.advData){const e=this.advData.length/212>>0;return this.framebuffers["faceMaskMerge"+(e-1)%2].targetTexture}return null}updateSize(){const e=this.renderer.getSize(),t={width:e.width>>2,height:e.height>>2};["wire","morph","lEye","rEye","faceMask","faceMaskMerge0","faceMaskMerge1","eyeTeeth"].forEach(i=>{var r;-1===["faceMaskMerge0","faceMaskMerge1","lEye","rEye"].indexOf(i)&&(null===(r=this.programs[i])||void 0===r||r.setUniform("size",[e.width,e.height]));const s=this.framebuffers[i];if(s){const r=-1===["faceMask","faceMaskMerge0","faceMaskMerge1","eyeTeeth"].indexOf(i)?e:t;s.targetTexture.opts.width=r.width,s.targetTexture.opts.height=r.height,s.targetTexture.refresh()}})}setAdvData(e){this.advData=e.length?e:null}setAdvEffect(e,t){if(e in this.params&&"number"==typeof t)this.params[e]=Math.min(1,Math.max(0,t)),"whitenTeeth"===e&&0===this.params[e]?this.programs.morph.setUniform("teethIntensity",0):"brightenEye"===e?this.programs.morph.setUniform("eyeIntensity",t):"roundedEye"===e?(this.programs.lEye.setUniform("rdIntensity",t),this.programs.rEye.setUniform("rdIntensity",t)):"enlargeEye"===e&&(this.programs.lEye.setUniform("lgIntensity",t),this.programs.rEye.setUniform("lgIntensity",t));else for(const e in this.defParams)this.setAdvEffect(e,this.defParams[e])}presetAdvEffect(e){for(const t in this.defParams)t in e?this.setAdvEffect(t,e[t]):this.setAdvEffect(t,this.defParams[t])}get featureParas(){return this.advData?{forehead:this.params.fadeHeadWrinkle,eyeRim:this.params.fadeEyeRim,noseLine:this.params.fadeNoseLine}:{forehead:0,eyeRim:0,noseLine:0}}posToUV(e,t,i){return new h.Vector2(e.x/t,1-e.y/i)}render(){const e=this.advData;if(e){const t=this.renderer,i=t.gl,r=t.getSize(),s={width:r.width>>2,height:r.height>>2},a=e.length/212>>0;for(let o=0;o<a;o++){const a=e.slice(212*o,212*(o+1)),n=o%2,d=this.programs.morph,c=this.programs["faceMaskMerge"+n];d.setUniform("map",0===o?this.map:this.framebuffers.rEye.targetTexture),d.updateAttribute("position",e=>{e.set(a,0),m.genTopFace(e),m.genFaceOutline(e)});let l=null;if(d.updateAttribute("tPosition",e=>{var t;const i=e;i.set(this.posBuffer.typedArray,0),h.preHandle(i);for(const e in h.handlers){const r=this.params[e];if(r!==this.defParams[e]){const s=null===(t=h.handlers[e])||void 0===t?void 0:t.call(h.handlers,i,r);"whitenTeeth"===e?d.setUniform("teethIntensity",s):"roundedEye"!==e&&"enlargeEye"!==e||(l=Object.assign(Object.assign({},s),{posData:i}))}}}),this.setWirePosBuffer(),this.isShowWire&&(this.framebuffers.wire.bind(),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT),this.renderer.render(this.programs.wire)),t.setViewport(0,0,s.width,s.height),this.framebuffers.faceMask.bind(),this.renderer.render(this.programs.faceMask),c.setUniform("index",o),c.setUniform("map",this.framebuffers["faceMaskMerge"+(0===n?1:0)].targetTexture),this.framebuffers["faceMaskMerge"+n].bind(),this.renderer.render(c),this.programs.eyeTeeth.updateAttribute("tPosition",e=>{const t=e,i=this.targetPosBuffer.typedArray;[52,53,72,54,55,56,73,57,61,60,75,59,58,63,76,62,96,97,98,99,100,101,102,103].forEach((e,r)=>{let s=2*r,a=2*e;t[s]=i[a],t[s+1]=i[a+1]})}),this.framebuffers.eyeTeeth.bind(),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT),this.renderer.render(this.programs.eyeTeeth),t.setViewport(0,0,r.width,r.height),this.framebuffers.morph.bind(),this.renderer.render(d),l){const e=this.posToUV(l.lEyeCenter,r.width,r.height),t=this.posToUV(l.rEyeCenter,r.width,r.height),i=this.posToUV(h.Vector2.getVec(l.posData,52),r.width,r.height),s=this.posToUV(h.Vector2.getVec(l.posData,55),r.width,r.height);let a=h.Vector2.getVec(l.posData,72),o=h.Vector2.getVec(l.posData,73);const n=this.posToUV(h.Vector2.getVec(l.posData,58),r.width,r.height),d=this.posToUV(h.Vector2.getVec(l.posData,61),r.width,r.height);let c=h.Vector2.getVec(l.posData,75),u=h.Vector2.getVec(l.posData,76);const p=Math.min(1,Math.max(0,(h.Vector2.disPow2(a,o)-4)/4)),m=Math.min(1,Math.max(0,(h.Vector2.disPow2(c,u)-4)/4));a=this.posToUV(a,r.width,r.height),o=this.posToUV(o,r.width,r.height),c=this.posToUV(c,r.width,r.height),u=this.posToUV(u,r.width,r.height),this.programs.lEye.setUniform("eyeCenter",e.value),this.programs.lEye.setUniform("range",Math.max(h.Vector2.dis(e,i),h.Vector2.dis(e,s))),this.programs.lEye.setUniform("rdDir",h.Vector2.normalize(h.Vector2.sub(a,o)).value),this.programs.lEye.setUniform("intensRatio",p),this.programs.rEye.setUniform("eyeCenter",t.value),this.programs.rEye.setUniform("range",Math.max(h.Vector2.dis(t,n),h.Vector2.dis(t,d))),this.programs.rEye.setUniform("rdDir",h.Vector2.normalize(h.Vector2.sub(c,u)).value),this.programs.rEye.setUniform("intensRatio",m)}this.framebuffers.lEye.bind(),this.renderer.render(this.programs.lEye),this.framebuffers.rEye.bind(),this.renderer.render(this.programs.rEye)}}}static configStaticRes(e,i){const r=[];let s=1;const a=()=>{s-=1,s<=0&&(i?i.emit("advBeautyResComplete",r):f.forEach(e=>{try{e.emit("advBeautyResComplete",r)}catch(e){}}))};e.faceMask&&!g&&(s+=1,t.resSet.faceMask=e.faceMask,o.retryLoadImage(e.faceMask,3,e=>{g=e,f.forEach(t=>{try{t.faceMaskMap.source=e,t.faceMaskMap.refresh()}catch(e){}}),a()},()=>{r.push(e.faceMask),a()})),e.eyeTeethMask&&!v&&(s+=1,t.resSet.eyeTeethMask=e.eyeTeethMask,o.retryLoadImage(t.resSet.eyeTeethMask,3,e=>{v=e,f.forEach(t=>{try{t.eyeTeethMaskMap.source=e,t.eyeTeethMaskMap.refresh()}catch(e){}}),a()},()=>{r.push(e.eyeTeethMask),a()})),e.teethWhiten&&!_&&(s+=1,t.resSet.teethWhiten=e.teethWhiten,o.retryLoadImage(t.resSet.teethWhiten,3,e=>{_=e,f.forEach(t=>{try{t.whiteTeethLutMap.source=e,t.whiteTeethLutMap.refresh()}catch(e){}}),a()},()=>{r.push(e.teethWhiten),a()})),a()}destroy(){var e,t,i;super.destroy(),null===(e=this.renderer.gl)||void 0===e||e.deleteTexture(this.faceMaskMap.glTexture),null===(t=this.renderer.gl)||void 0===t||t.deleteTexture(this.eyeTeethMaskMap.glTexture),null===(i=this.renderer.gl)||void 0===i||i.deleteTexture(this.whiteTeethLutMap.glTexture),f.delete(this)}remove(){f.delete(this)}}t.AdvBeautyFilter=S},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.lutShader=void 0,t.lutShader={fShader:"\n    #ifdef GL_FRAGMENT_PRECISION_HIGH\n        precision highp float;\n    #else\n        precision mediump float;\n    #endif\n\n    uniform sampler2D map;\n    uniform sampler2D lut;\n\n    // lut强度\n    uniform float intensity;\n\n    varying vec2 vuv;\n\n    void main() {\n        vec3 color = texture2D(map, vuv).rgb;\n\n        if(intensity > 0.0){\n            float blue = color.b * 63.0;\n\n            vec2 q1;\n            float fb = floor(blue);\n            q1.y = floor(fb * 0.125);\n            q1.x = fb - (q1.y * 8.0);\n\n            vec2 q2;\n            float cb = ceil(blue);\n            q2.y = floor(cb * 0.125);\n            q2.x = cb - (q2.y * 8.0);\n\n            vec2 t = 0.123 * color.rg + vec2(0.000976563);\n            vec2 t1 = q1 * 0.125 + t;\n            vec3 p1 = texture2D(lut, t1).rgb;\n\n            vec2 t2 = q2 * 0.125 + t;\n            vec3 p2 = texture2D(lut, t2).rgb;\n\n            vec3 filter = mix(p1, p2, fract(blue));\n            color = mix(color, filter, intensity);\n        }\n        gl_FragColor = vec4(color, 1.0);\n    }"}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.audioPlugins=t.videoPlugins=void 0;t.videoPlugins=["VirtualBackground","AdvancedBeauty"],t.audioPlugins=["AIDenoise"],t.default=["VirtualBackground","AdvancedBeauty","AIDenoise"]},,,,function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.NERTC=void 0;const n=i(205),d=i(295),c=i(65),l=i(324),u=i(325),h=i(326),p=i(137),m=i(164),f=i(115),g=i(5),v=i(195),_=i(161),S=o(i(11)),y=o(i(12)),R=o(i(117)),b=i(69),T=i(68),w=a(i(2));let I,E=window;t.NERTC={Logger:{DEBUG:0,INFO:1,WARNING:2,ERROR:3,NONE:4,setLogLevel(e){I&&I.apiFrequencyControl({name:"setLogLevel",code:0,param:{clientUid:I.adapterRef.channelInfo.uid||"",level:e}}),R.default.setLogLevel(e)},enableLogUpload(){I&&I.apiFrequencyControl({name:"enableLogUpload",code:0,param:{clientUid:I.adapterRef.channelInfo.uid||""}}),R.default.enableLogUpload()},disableLogUpload(){I&&I.apiFrequencyControl({name:"disableLogUpload",code:0,param:{clientUid:I.adapterRef.channelInfo.uid||""}}),R.default.disableLogUpload()}},createClient(e){b.checkExists({tag:"createClient:ClientOptions",value:e}),b.checkExists({tag:"createClient:ClientOptions.appkey",value:e.appkey});const i=new n.Client(Object.assign(e,{apiList:[],ref:t.NERTC}));return g.getParameters().clients.push(i),I||(I=i),i},createStream(e){if(b.checkExists({tag:"createStream:options",value:e}),e.screenAudio&&!e.screen){let e="createStream: screenAudio 要与 screen 一起开启",t="createStream: screenAudio should be open together with screen",i=w.IS_ZH?e:t;throw new y.default({code:S.default.INVALID_OPERATION_ERROR,message:i})}if(!e.client&&I&&I.adapterRef.logger.warn("createStream: 未传入client参数。使用默认Client。"),I||e.client){const t=new d.LocalStream(Object.assign(e,{isRemote:!1,client:e.client||I}));return g.getParameters().localStreams.push(t),t}return l.clientNotYetUninitialized},Device:f.Device,getDevices:(e=!1)=>f.Device.getDevices({audioinput:!0,audiooutput:!0,videoinput:!0,requestPerm:e}),getCameras:(e=!1)=>f.Device.getCameras(e),getMicrophones:(e=!1)=>f.Device.getMicrophones(e),getSpeakers:(e=!1)=>f.Device.getSpeakers(e),checkSystemRequirements:_.checkSystemRequirements,getSupportedCodec:async()=>await T.getSupportedCodecs(),getHandler:()=>m.detectDevice(),getParameters:g.getParameters,destroy(e){let t=e||I;t&&t.destroy(),e||(I=null)},PlatformTypeMap:v.PlatformTypeMap,CHAT_VIDEO_FRAME_RATE_NORMAL:p.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_NORMAL,CHAT_VIDEO_FRAME_RATE_5:p.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_5,CHAT_VIDEO_FRAME_RATE_10:p.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_10,CHAT_VIDEO_FRAME_RATE_15:p.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_15,CHAT_VIDEO_FRAME_RATE_20:p.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_20,CHAT_VIDEO_FRAME_RATE_25:p.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_25,CHAT_VIDEO_FRAME_RATE_30:p.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_30,VIDEO_QUALITY_180p:p.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_180p,VIDEO_QUALITY_480p:p.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_480p,VIDEO_QUALITY_720p:p.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_720p,VIDEO_QUALITY_1080p:p.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_1080p,RECORD_VIDEO_QUALITY_360p:p.NERTC_RECORD_VIDEO_QUALITY.RECORD_VIDEO_QUALITY_360p,RECORD_VIDEO_QUALITY_480p:p.NERTC_RECORD_VIDEO_QUALITY.RECORD_VIDEO_QUALITY_480p,RECORD_VIDEO_QUALITY_720p:p.NERTC_RECORD_VIDEO_QUALITY.RECORD_VIDEO_QUALITY_720p,RECORD_VIDEO_FRAME_RATE_15:p.NERTC_RECORD_VIDEO_FRAME_RATE.RECORD_VIDEO_FRAME_RATE_15,RECORD_VIDEO_FRAME_RATE_30:p.NERTC_RECORD_VIDEO_FRAME_RATE.RECORD_VIDEO_FRAME_RATE_30,LIVE_STREAM_AUDIO_CODEC_PROFILE:u.LIVE_STREAM_AUDIO_CODEC_PROFILE,LIVE_STREAM_AUDIO_SAMPLE_RATE:u.LIVE_STREAM_AUDIO_SAMPLE_RATE,VIDEO_FRAME_RATE:p.VIDEO_FRAME_RATE,VIDEO_QUALITY:p.NERTC_VIDEO_QUALITY,NETWORK_STATUS:h.NETWORK_STATUS,STREAM_TYPE:p.STREAM_TYPE,VERSION:c.SDK_VERSION,BUILD:c.BUILD,ENV:c.ENV},e.exports=E.WebRTC2=t.NERTC},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Client=void 0;const n=i(65),d=i(137),c=i(115),l=i(147),u=i(211),h=i(5),p=i(149),m=i(62),f=o(i(11)),g=o(i(12)),v=i(212),_=i(69),S=a(i(2)),y=i(213),R=i(294);class b extends y.Base{constructor(e){super(e),this.destroyed=!1,this.onJoinFinish=null,this.spatialManager=null,this.apiFrequencyControl({name:"createClient",code:0,param:{clientUid:"",debug:e.debug}}),this.operationQueue=new v.OperationQueue(this.logger),this.handlePageUnload=e=>{"join"!==this.adapterRef.channelStatus&&"connectioning"!==this.adapterRef.channelStatus||(this.logger.warn(`收到 ${null==e?void 0:e.type} 事件，当前状态：${this.adapterRef.channelStatus}，即将离开房间`),this.leave())},this.handleOnOnlineOffline=e=>{var t,i,r,s,a;"online"===(null==e?void 0:e.type)?"CONNECTING"===this.adapterRef.connectState.curState?(this.logger.warn("侦测到网络恢复，恢复重连过程"),this.resumeReconnection()):this.logger.warn("侦测到网络恢复"):"offline"===(null==e?void 0:e.type)&&("CONNECTED"===this.adapterRef.connectState.curState?(this.logger.warn("侦测到网络断开，主动断开连接"),this.pauseReconnection(),null===(i=null===(t=this.adapterRef._mediasoup)||void 0===t?void 0:t._sendTransport)||void 0===i||i.close(),null===(s=null===(r=this.adapterRef._mediasoup)||void 0===r?void 0:r._recvTransport)||void 0===s||s.close(),this.adapterRef.channelStatus="connectioning",null===(a=this.adapterRef._signalling)||void 0===a||a._reconnection()):this.logger.warn("侦测到网络断开"))},h.getParameters().leaveOnUnload&&(window.addEventListener("pagehide",this.handlePageUnload),window.addEventListener("beforeunload",this.handlePageUnload)),h.getParameters().trustOnOnline&&(window.addEventListener("online",this.handleOnOnlineOffline),window.addEventListener("offline",this.handleOnOnlineOffline)),this._roleInfo={userRole:0,audienceList:{}},this._init(e),this.logger.info(`NERTC ${n.SDK_VERSION} ${n.BUILD}: 客户端创建成功。`),this.on("@connection-state-change",e=>{var t,i,r;"CONNECTED"===e.prevState&&(null===(t=this.recordManager.record)||void 0===t?void 0:t._status.isRecording)&&"started"===(null===(i=this.recordManager.record)||void 0===i?void 0:i._status.state)&&(this.logger.log("自动停止客户端录制功能"),this.recordManager.record.download()),"CONNECTED"===e.curState&&"CONNECTING"===e.prevState&&(e.reconnect&&this.adapterRef.lbsManager.startUpdate("reconnect"),(null===(r=this.adapterRef.datareportCache)||void 0===r?void 0:r.length)&&(this.logger.log(`上报进频道前事件：${this.adapterRef.datareportCache.length}条: ${this.adapterRef.datareportCache.map(e=>e.func).join()}`),this.adapterRef.datareportCache.forEach(e=>{const t=e.datareport[e.func];t&&(t.cid=t.cid||this.adapterRef.channelInfo.cid,t.uid=t.uid||this.adapterRef.channelInfo.uid),e.datareport.send()}),this.adapterRef.datareportCache=[]))})}_init(e){const{appkey:t="",token:i}=e;if(!t){this.logger.error("Client: init error: 请传入appkey");let e="Client_init: appkey is not found",t="Client_init: appkey 参数缺失",i="Please input appkey",r="请输入 appkey",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new g.default({code:f.default.INVALID_PARAMETER_ERROR,message:s,advice:a})}this._params.appkey=t,this.adapterRef.lbsManager.loadBuiltinConfig("oninit"),this._params.token=i,this._roleInfo={userRole:0,audienceList:{}},c.Device.deviceInited||c.Device.startDeviceChangeDetection(),c.Device.on("recording-device-changed",e=>{this.destroyed||this.safeEmit("recording-device-changed",e)}),c.Device.on("camera-changed",e=>{this.destroyed||this.safeEmit("camera-changed",e)}),c.Device.on("playout-device-changed",e=>{this.destroyed||this.safeEmit("playout-device-changed",e)});const r=()=>{this.onJoinFinish?(this.onJoinFinish(),this.onJoinFinish=null):this.logger.debug("孤立的join完成回调")};this.addListener("@pairing-join-success",r),this.addListener("@pairing-join-error",r),"never"!==h.getParameters().enableAlerter&&c.alerter.watchClient(this.adapterRef.instance)}getUid(){return this.adapterRef.channelInfo&&this.adapterRef.channelInfo.uid}getParameter(e="getChannelInfo"){if(this.apiFrequencyControl({name:"getParameter",code:0,param:{type:e}}),"getChannelInfo"===e){const e=`appkey=${this._params.appkey}&osType=4&mode=2&netType=0&version=${n.SDK_VERSION+".0"}&webrtc=1&nrtcg2=1&t1=${Date.now()}`,t={"Content-Type":"application/x-www-form-urlencoded"};return JSON.stringify({postData:e,header:t})}}getChannelInfo(){return this.apiFrequencyControl({name:"getChannelInfo",code:0,param:{clientUid:this.adapterRef.channelInfo.uid||""}}),this.adapterRef.channelInfo||{}}startProxyServer(e){let t=null;if(this.adapterRef.logger.log("startProxyServer, type: ",e),"join"!==this.adapterRef.channelStatus&&"connectioning"!==this.adapterRef.channelStatus||(this.adapterRef.logger.error("startProxyServer: 请在加入房间前调用"),t="INVALID_OPERATION"),this.apiFrequencyControl({name:"startProxyServer",code:t?-1:0,param:{clientUid:this.adapterRef.channelInfo.uid||"",reason:t}}),t){let e="startProxyServer: API call sequence error",t="startProxyServer: 接口调用顺序异常",i="Please call startProxyServer() before join()",r="请在加入房间前调用",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new g.default({code:f.default.API_CALL_SEQUENCE_ERROR,message:s,advice:a})}this.adapterRef.proxyServer.enable=!0,e&&(this.adapterRef.proxyServer.type=e)}stopProxyServer(){this.adapterRef.logger.log("stopProxyServer"),this.adapterRef.proxyServer&&(this.adapterRef.proxyServer.enable=!1,this.adapterRef.proxyServer.wsProxyArray=null),this.apiFrequencyControl({name:"stopProxyServer",code:0,param:{clientUid:this.adapterRef.channelInfo.uid||"",reason:""}})}setLocalMediaPriority(e){this.logger.log("setLocalMediaPriority, options: ",JSON.stringify(e));let t=null;"join"!==this.adapterRef.channelStatus&&"connectioning"!==this.adapterRef.channelStatus||(this.logger.error("setLocalMediaPriority: 请在加入房间前调用"),t="setLocalMediaPriority: 请在加入房间前调用");const{priority:i=100,preemtiveMode:r=!1}=e;if(("number"!=typeof i||isNaN(i))&&(t="setLocalMediaPriority: priority is not Number"),this.apiFrequencyControl({name:"setLocalMediaPriority",code:0,param:{clientUid:this.adapterRef.channelInfo.uid||"",priority:i,preemtiveMode:r,reason:""}}),t){let e="setLocalMediaPriority: parameter(priority) is not Number",t="setLocalMediaPriority: priority 参数不是 Number",i="Please input the correct parameter type",r="请输入正确的参数类型",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new g.default({code:f.default.INVALID_PARAMETER_ERROR,message:s,advice:a})}this.adapterRef.userPriority=e}async join(e){this.logger.log("join() 加入频道, options: ",JSON.stringify(e,null," "));try{if(!e.channelName||""===e.channelName){this.logger.log("join: 请填写房间名称");let e="join: parameter(channelName) is not found",t="join: 没有找到房间名称",i="Please input the parameter(channelName)",r="请填写房间名称",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new g.default({code:f.default.INVALID_PARAMETER_ERROR,message:s,advice:a})}if(e.joinChannelRecordConfig&&(_.checkValidBoolean({tag:"joinOptions.joinChannelRecordConfig.recordAudio should be boolean",value:e.joinChannelRecordConfig.recordAudio}),_.checkValidBoolean({tag:"joinOptions.joinChannelRecordConfig.recordVideo should be boolean",value:e.joinChannelRecordConfig.recordVideo})),"string"==typeof e.uid)this.logger.log("uid 是 string 类型"),this.adapterRef.channelInfo.uidType="string";else{if("number"!=typeof e.uid){this.logger.error("uid参数格式非法");let e="join: The type of parameter(uid) is not invalid",t="join: uid 参数类型非法",i="Please input the correct parameter type",r="请输入正确的参数类型",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;return Promise.reject(new g.default({code:f.default.INVALID_PARAMETER_ERROR,message:s,advice:a}))}if(this.logger.log("uid 是 number 类型"),this.adapterRef.channelInfo.uidType="number",e.uid>Number.MAX_SAFE_INTEGER){this.logger.log("uid 参数越界");let e="join: parameter(uid) out of bounds",t="join: uid 参数越界",i="The maximum range of the Number type is 2^53 - 1, please input the correct parameter",r="Number 类型的 uid 最大值是 2^53 - 1， 请输入正确的参数",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new g.default({code:f.default.INVALID_PARAMETER_ERROR,message:s,advice:a})}}if(this.onJoinFinish=await this.operationQueue.enqueue({caller:this,method:"join",options:e}),this.safeEmit("@pairing-join-start"),"join"===this.adapterRef.channelStatus||"connectioning"===this.adapterRef.channelStatus){this.safeEmit("@pairing-join-error");let e="join: repeatedly join",t="join: 重复登录",i="Please check the login logic to ensure that you have successfully logged out of the room before logging in to the room again",r="请检查登录逻辑，确保再次登录房间前已成功登出房间",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;return Promise.reject(new g.default({code:f.default.REPEAT_JOIN_ERROR,message:s,advice:a}))}this.adapterRef.connectState.curState="CONNECTING",this.adapterRef.connectState.prevState="DISCONNECTED",this.adapterRef.instance.safeEmit("connection-state-change",this.adapterRef.connectState),e.spatial&&this.initSpatialManager(e.spatial),e.token&&(this._params.token=e.token),e.customData&&(this.adapterRef.channelInfo.customData=e.customData),this._params.JoinChannelRequestParam4WebRTC2={startJoinTime:Date.now(),appkey:this._params.appkey,userRole:this._roleInfo.userRole,channelName:e.channelName,wssArr:e.wssArr,uid:e.uid,permKey:e.permKey||"",token:this._params.token,joinChannelLiveConfig:e.joinChannelLiveConfig||{liveEnable:!1},joinChannelRecordConfig:e.joinChannelRecordConfig||{recordAudio:!1,recordVideo:!1,recordType:0,isHostSpeaker:!1},getChanneInfoResponse:e.getChanneInfoResponse},e.neRtcServerAddresses&&(this._params.neRtcServerAddresses={channelServer:e.neRtcServerAddresses.channelServer||"",statisticsServer:e.neRtcServerAddresses.statisticsServer||"",statisticsWebSocketServer:e.neRtcServerAddresses.statisticsWebSocketServer||"",roomServer:e.neRtcServerAddresses.roomServer||"",webSocketProxyServer:e.neRtcServerAddresses.webSocketProxyServer||"",mediaProxyServer:e.neRtcServerAddresses.mediaProxyServer||""});const t=this.adapterRef.lbsManager.loadLocalConfig("onjoin");if(t.config){const e=t.config.ts+1e3*t.config.config.ttl-Date.now();e<1e3*t.config.config.preloadTimeSec&&(this.logger.log(`LBS在 ${Math.floor(e/1e3)} 秒后过期。preloadTimeSec: ${t.config.config.preloadTimeSec}。发起异步刷新请求`),this.adapterRef.lbsManager.startUpdate("renew"))}else this.adapterRef.lbsManager.startUpdate(t.reason);if(this.setStartSessionTime(),this.initMode(),!this.adapterRef.mediaCapability.supportedCodecRecv||!this.adapterRef.mediaCapability.supportedCodecSend)try{await this.adapterRef.mediaCapability.detect()}catch(e){this.logger.error("Failed to detect mediaCapability",e.name,e.message)}if(!this.adapterRef._meetings){this.safeEmit("@pairing-join-error");let e="join:  meeting error",t="join: 会控异常",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new g.default({code:f.default.MEETING_ERROR,message:s,advice:a})}const i=await this.adapterRef._meetings.joinChannel(this._params.JoinChannelRequestParam4WebRTC2);return this.safeEmit("@pairing-join-success"),this.apiFrequencyControl({name:"join",code:0,param:Object.assign({},e)}),i}catch(t){throw this.safeEmit("@pairing-join-error"),this.apiFrequencyControl({name:"join",code:-1,param:Object.assign(Object.assign({},e),{reason:t&&t.message})}),t}}async leave(){const e=await this.operationQueue.enqueue({caller:this,method:"leave",options:null});this.logger.log("leave() 离开频道"),"join"!==this.adapterRef.channelStatus&&"connectioning"!==this.adapterRef.channelStatus&&this.logger.log("房间状态: ",this.adapterRef.channelStatus),this.adapterRef.connectState.prevState=this.adapterRef.connectState.curState,this.adapterRef.connectState.curState="DISCONNECTING",this.adapterRef.connectState.reconnect=!1,this.adapterRef.instance.safeEmit("connection-state-change",this.adapterRef.connectState),this.setEndSessionTime(),this.adapterRef._meetings?this.adapterRef._meetings.leaveChannel().then(e):e(),this.apiFrequencyControl({name:"leave",code:0,param:{clientUid:this.getUid()}})}async leaveRts(){this.logger.log("离开频道"),"join"!==this.adapterRef.channelStatus&&"connectioning"!==this.adapterRef.channelStatus&&this.logger.log(" 状态: ",this.adapterRef.channelStatus),this.adapterRef.connectState.prevState=this.adapterRef.connectState.curState,this.adapterRef.connectState.curState="DISCONNECTING",this.adapterRef.connectState.reconnect=!1,this.adapterRef.instance.safeEmit("connection-state-change",this.adapterRef.connectState),this.setEndSessionTime(),this.adapterRef._meetings&&this.adapterRef._meetings.leaveChannel()}enableCustomTransform(e){var t;let i,r,s,a,o,n,d,c="";if("DISCONNECTED"!==this.adapterRef.connectState.curState?(c="enableCustomTransform必须在加入频道前调用",i="enableCustomTransform: invalid operation",r="enableCustomTransform: 必须在加入频道前调用",s="please call before addTasks",a="必须在加入频道前调用",o=S.IS_ZH?r:i,n=S.IS_ZH?a:s,d=f.default.API_CALL_SEQUENCE_ERROR):"function"!=typeof window.TransformStream?(c="浏览器不支持自定义加解密: 未找到TransformStream",i="enableCustomTransform: TransformStream is not found because enableCustomTransform is not support in your browser",r="enableCustomTransform: 浏览器不支持自定义加密, TransformStream 未找到",s="The latest version of the Chrome browser is recommended",a="建议使用最新版的 Chrome 浏览器",o=S.IS_ZH?r:i,n=S.IS_ZH?a:s,d=f.default.NOT_SUPPORT_ERROR):"function"!=typeof(null===(t=window.RTCRtpReceiver)||void 0===t?void 0:t.prototype.createEncodedStreams)?(c="enableCustomTransform: 浏览器不支持自定义加解密，未找到createEncodedStreams",i="enableCustomTransform: createEncodedStreams is not found because enableCustomTransform is not support in your browser",r="enableCustomTransform: 浏览器不支持自定义加密, createEncodedStreams 未找到",s="The latest version of the Chrome browser is recommended",a="建议使用最新版的 Chrome 浏览器",o=S.IS_ZH?r:i,n=S.IS_ZH?a:s,d=f.default.NOT_SUPPORT_ERROR):"none"!==this.adapterRef.encryption.encryptionMode&&(c="enableCustomTransform: 自定义加密功能与国密加密功能不兼容",i="enableCustomTransform: Custom encryption and national encryption are not compatible",r="enableCustomTransform: 自定义加密功能与国密加密功能不兼容",s="Cannot use custom encryption and national encryption at the same time",a="不能同时使用自定义加密功能与国密加密功能",o=S.IS_ZH?r:i,n=S.IS_ZH?a:s,d=f.default.SET_ENCRYPTION_MODE_ERROR),c)throw this.logger.error(c),new g.default({code:d,message:o,advice:n});!1===e?(this.adapterRef.encryption.encodedInsertableStreams=!1,this.logger.log("已关闭自定义加解密")):(this.adapterRef.encryption.encodedInsertableStreams=!0,this.logger.log("已开启自定义加解密")),this.apiFrequencyControl({name:"enableCustomTransform",code:0,param:JSON.stringify({enable:e})})}async publish(e){_.checkExists({tag:"client.publish:stream",value:e}),await this.doPublish(e)}async doPublish(e){const t=await this.operationQueue.enqueue({caller:this,method:"publish",options:e});let i="";const r=()=>{var r,s;t();const a={reason:i,pubStatus:e.pubStatus};(e.mediaHelper.video.cameraTrack||e.mediaHelper.video.videoSource)&&(a.webcamProducerCodec=null===(r=this.adapterRef._mediasoup)||void 0===r?void 0:r._webcamProducerCodec),(e.mediaHelper.screen.screenVideoTrack||e.mediaHelper.screen.screenVideoSource)&&(a.screenProducerCodec=null===(s=this.adapterRef._mediasoup)||void 0===s?void 0:s._screenProducerCodec),this.apiFrequencyControl({name:"publish",code:i?-1:0,param:JSON.stringify(a)}),this.apiFrequencyControl({name:"_trackSettings",code:0,param:JSON.stringify(e.mediaHelper.getTrackSettings())})};if(e&&(e.audio||e.video||e.screen||e.screenAudio)?1===this._roleInfo.userRole?(this.logger.error("publish：观众禁止Publish，请先使用setClientRole设为主播"),i="INVALID_OPERATION"):"CONNECTING"===this.adapterRef.connectState.curState?(this.logger.error("publish: 当前正在连接，将在连接成功后发布媒体流"),i="PUBLISH_ON_CONNECTING",this.bindLocalStream(e)):"CONNECTED"!==this.adapterRef.connectState.curState&&(this.logger.error("publish: 当前不在频道中，可能是没有加入频道或者是网络波动导致暂时断开连接"),i="INVALID_OPERATION"):e&&h.getParameters().allowEmptyMedia?this.logger.log("publish: 当前模式允许发布没有媒体流的localStream"):(this.logger.error("publish: 传入的 stream 格式非法，没有媒体数据"),i="INVALID_LOCAL_STREAM"),i){if("INVALID_OPERATION"===i){r();let e="doPublish: invalid operation",t="doPublish: 操作异常",i="please make sure the client role is anchor",s="请确认当前的 role 是主播",a=S.IS_ZH?t:e,o=S.IS_ZH?s:i;return Promise.reject(new g.default({code:f.default.INVALID_OPERATION_ERROR,message:a,advice:o}))}if("INVALID_LOCAL_STREAM"===i){r();let e="doPublish: The stream format is illegal",t="doPublish: 传入的 stream 格式非法，没有媒体数据",i="Please input the correct stream",s="请输入正确的 stream 参数",a=S.IS_ZH?t:e,o=S.IS_ZH?s:i;return Promise.reject(new g.default({code:f.default.LOCALSTREAM_ERROR,message:a,advice:o}))}r()}else try{if(!this.adapterRef._mediasoup){r();let e="doPublish:  media server error",t="doPublish: 媒体服务异常",i="Please contact CommsEase technical support",s="请联系云信技术支持",a=S.IS_ZH?t:e,o=S.IS_ZH?s:i;throw new g.default({code:f.default.MEDIA_SERVER_ERROR,message:a,advice:o})}this.bindLocalStream(e),await this.adapterRef._mediasoup.createProduce(e,"all"),r()}catch(e){throw this.logger.error("API调用失败：Client:publish",e.name,e.message,e.stack,...arguments),i=e.message,r(),e}}async unpublish(e){_.checkExists({tag:"client.unpublish:stream",value:e});const t=await this.operationQueue.enqueue({caller:this,method:"unpublish",options:null});let i="";"CONNECTING"===this.adapterRef.connectState.curState?(this.logger.error("unpublish: 当前正在连接，连接成功后将不再发送媒体流"),i="UNPUBLISH_ON_CONNECTING",this.adapterRef.localStream=null):"CONNECTED"!==this.adapterRef.connectState.curState&&(this.logger.error("unpublish: 当前不在频道中，可能是没有加入频道或者是网络波动导致暂时断开连接"),i="INVALID_OPERATION");JSON.stringify({pubStatus:e&&e.pubStatus,reason:i},null," ");if(i){if(this.apiFrequencyControl({name:"unpublish",code:-1,param:{clientUid:this.getUid(),pubStatus:e&&e.pubStatus,reason:i}}),"INVALID_OPERATION"===i){t();let e="unpublish: invalid operation",i="unpublish: 操作异常",r="This may caused by a temporary network failure connection",s="可能是临时网络异常引起的",a=S.IS_ZH?i:e,o=S.IS_ZH?s:r;return Promise.reject(new g.default({code:f.default.INVALID_OPERATION_ERROR,message:a,advice:o}))}t()}else{this.logger.log("开始取消发布本地流");try{if(!this.adapterRef._mediasoup){let e="unpublish: media server error",t="unpublish: 媒体服务异常",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new g.default({code:f.default.MEDIA_SERVER_ERROR,message:s,advice:a})}await this.adapterRef._mediasoup.destroyProduce("audio"),await this.adapterRef._mediasoup.destroyProduce("audioSlave"),await this.adapterRef._mediasoup.destroyProduce("video"),await this.adapterRef._mediasoup.destroyProduce("screen"),this.adapterRef.localStream=null,this.apiFrequencyControl({name:"unpublish",code:0,param:JSON.stringify({pubStatus:e&&e.pubStatus},null," ")}),t()}catch(i){throw this.logger.error("API调用失败：Client:unpublish",i,...arguments),t(),this.apiFrequencyControl({name:"unpublish",code:-1,param:JSON.stringify({reason:i.message,pubStatus:e&&e.pubStatus},null," ")}),i}}}getSubStatus(e,t){let i={status:"unsubscribed",subscribable:!1};if("all"===t){const t=[this.getSubStatus(e,"audio"),this.getSubStatus(e,"audioSlave"),this.getSubStatus(e,"video"),this.getSubStatus(e,"screen")];t.find(e=>"unsubscribing"===e.status)?i.status="unsubscribing":t.find(e=>"subscribing"===e.status)&&(i.status="subscribing"),t.find(e=>"subscribed"===e.status)&&(i.status="subscribed"),"subscribed"!==i.status&&"unsubscribed"!==i.status||t.find(e=>e.subscribable)&&(i.subscribable=!0)}else"start"===e.pubStatus[t].stopconsumerStatus?i.status="unsubscribing":"start"===e.pubStatus[t].consumerStatus?i.status="subscribing":e.pubStatus[t].consumerId?i.status="subscribed":"unsubscribed"===i.status&&e.pubStatus[t].producerId&&e.subConf[t]&&(i.subscribable=!0);return i}async subscribe(e){if(!this.spatialManager)return _.checkExists({tag:"client.subscribe:stream",value:e}),this.logger.log(`[Subscribe] [订阅远端: ${e.stringStreamID}]`),this.doSubscribe(e);this.logger.warn("[Subscribe] 已开启空间音频，跳过用户订阅步骤")}async doSubscribe(e){var t,i,r,s;const a=e.getId();if(!this.adapterRef._mediasoup){let e="doSubscribe:  media server error 1",t="doSubscribe: 媒体服务异常 1",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new g.default({code:f.default.MEDIA_SERVER_ERROR,message:s,advice:a})}try{if(e.subConf.audio)!1===(null===(t=this.adapterRef.permKeyInfo)||void 0===t?void 0:t.subAudioRight)?(this.logger.error("permKey权限控制你没有权限订阅audio"),this.adapterRef.instance.emit("error","no-subscribe-audio-permission")):e.pubStatus.audio.audio&&!e.pubStatus.audio.consumerId&&(this.logger.log(`[Subscribe] 开始订阅 ${e.getId()} 音频流`),e.pubStatus.audio.consumerStatus="start",await this.adapterRef._mediasoup.createConsumer(a,"audio","audio",e.pubStatus.audio.producerId),e.pubStatus.audio.consumerStatus="end",this.logger.log(`[Subscribe] 订阅 ${e.getId()} 音频流完成`));else if(e.pubStatus.audio.consumerId&&"start"!==e.pubStatus.audio.stopconsumerStatus){if(this.logger.log("开始取消订阅音频流"),e.pubStatus.audio.stopconsumerStatus="start",!this.adapterRef._mediasoup){let e="doSubscribe:  media server error 2",t="doSubscribe: 媒体服务异常 2",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new g.default({code:f.default.MEDIA_SERVER_ERROR,message:s,advice:a})}await this.adapterRef._mediasoup.destroyConsumer(e.pubStatus.audio.consumerId,e,"audio"),this.adapterRef.instance.removeSsrc(e.getId(),"audio"),e.pubStatus.audio.consumerId="",e.stop("audio"),e.pubStatus.audio.stopconsumerStatus="end",e.subStatus.audio=!1;const t=e.getId();if(t){delete this.adapterRef.remoteAudioStats[t];const e=this.adapterRef._statsReport&&this.adapterRef._statsReport.formativeStatsReport&&this.adapterRef._statsReport.formativeStatsReport.firstData.recvFirstData[t];e&&(e.recvFirstAudioFrame=!1,e.recvFirstAudioPackage=!1)}this.logger.log("取消订阅音频流完成")}if(e.subConf.audioSlave)!1===(null===(i=this.adapterRef.permKeyInfo)||void 0===i?void 0:i.subAudioRight)?(this.logger.error("permKey权限控制你没有权限订阅audio slave"),this.adapterRef.instance.emit("error","no-subscribe-audio-slave-permission")):e.pubStatus.audioSlave.audioSlave&&!e.pubStatus.audioSlave.consumerId&&(this.logger.log(`[Subscribe] 开始订阅 ${e.getId()} 音频辅流`),e.pubStatus.audioSlave.consumerStatus="start",await this.adapterRef._mediasoup.createConsumer(a,"audio","audioSlave",e.pubStatus.audioSlave.producerId),e.pubStatus.audioSlave.consumerStatus="end",this.logger.log(`[Subscribe] 订阅 ${e.getId()} 音频辅流完成`));else if(e.pubStatus.audioSlave.consumerId&&"start"!==e.pubStatus.audioSlave.stopconsumerStatus){if(this.logger.log("开始取消订阅音频流"),e.pubStatus.audioSlave.stopconsumerStatus="start",!this.adapterRef._mediasoup){let e="doSubscribe:  media server error 3",t="doSubscribe: 媒体服务异常 3",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new g.default({code:f.default.MEDIA_SERVER_ERROR,message:s,advice:a})}await this.adapterRef._mediasoup.destroyConsumer(e.pubStatus.audioSlave.consumerId,e,"audioSlave"),this.adapterRef.instance.removeSsrc(e.getId(),"audioSlave"),e.pubStatus.audioSlave.consumerId="",e.stop("audioSlave"),e.pubStatus.audioSlave.stopconsumerStatus="end",e.subStatus.audioSlave=!1;const t=e.getId();t&&delete this.adapterRef.remoteAudioSlaveStats[t],this.logger.log("取消订阅音频流完成")}if(e.subConf.video)if(!1===(null===(r=this.adapterRef.permKeyInfo)||void 0===r?void 0:r.subVideoRight))this.logger.error("permKey权限控制你没有权限订阅video"),this.adapterRef.instance.emit("error","no-subscribe-video-permission");else if(e.pubStatus.video.video&&!e.pubStatus.video.consumerId){let t;this.logger.log(`[Subscribe] 开始订阅 ${e.getId()} 视频流`),t=e.subConf.highOrLow.video===d.STREAM_TYPE.LOW?0:1,await this.adapterRef._mediasoup.createConsumer(a,"video","video",e.pubStatus.video.producerId,t),this.logger.log(`[Subscribe] 订阅 ${e.getId()} 视频流完成`)}else this.logger.log("stream.pubStatus.video: ",JSON.stringify(e.pubStatus.video));else if(e.pubStatus.video.consumerId&&"start"!==e.pubStatus.video.stopconsumerStatus){if(this.logger.log("开始取消订阅视频流"),e.pubStatus.video.stopconsumerStatus="start",!this.adapterRef._mediasoup){let e="doSubscribe:  media server error 4",t="doSubscribe: 媒体服务异常 4",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new g.default({code:f.default.MEDIA_SERVER_ERROR,message:s,advice:a})}await this.adapterRef._mediasoup.destroyConsumer(e.pubStatus.video.consumerId,e,"video"),this.adapterRef.instance.removeSsrc(e.getId(),"video"),e.pubStatus.video.consumerId="",e.stop("video"),e.pubStatus.video.stopconsumerStatus="end",e.subStatus.video=!1;const t=e.getId();if(t){delete this.adapterRef.remoteVideoStats[t];const e=this.adapterRef._statsReport&&this.adapterRef._statsReport.formativeStatsReport&&this.adapterRef._statsReport.formativeStatsReport.firstData.recvFirstData[t];e&&(e.recvFirstVideoFrame=!1,e.recvFirstVideoPackage=!1,e.videoTotalPlayDuration=0)}this.logger.log("取消订阅视频流完成")}if(e.subConf.screen){if(!1===(null===(s=this.adapterRef.permKeyInfo)||void 0===s?void 0:s.subVideoRight))this.logger.error("permKey权限控制你没有权利订阅screen"),this.adapterRef.instance.emit("error","no-subscribe-screen-permission");else if(e.pubStatus.screen.screen&&!e.pubStatus.screen.consumerId){let t;this.logger.log(`[Subscribe] 开始订阅 ${e.getId()} 辅流`),t=e.subConf.highOrLow.screen===d.STREAM_TYPE.LOW?0:1,await this.adapterRef._mediasoup.createConsumer(a,"video","screenShare",e.pubStatus.screen.producerId,t),this.logger.log(`[Subscribe] 订阅 ${e.getId()} 辅流完成`)}}else if(e.pubStatus.screen.consumerId&&"start"!==e.pubStatus.screen.stopconsumerStatus){if(this.logger.log("开始取消订阅辅流"),e.pubStatus.screen.stopconsumerStatus="start",!this.adapterRef._mediasoup){let e="doSubscribe:  media server error 5",t="doSubscribe: 媒体服务异常 5",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new g.default({code:f.default.MEDIA_SERVER_ERROR,message:s,advice:a})}await this.adapterRef._mediasoup.destroyConsumer(e.pubStatus.screen.consumerId,e,"screen"),this.adapterRef.instance.removeSsrc(e.getId(),"screen"),e.pubStatus.screen.consumerId="",e.stop("screen"),e.pubStatus.screen.stopconsumerStatus="end",e.subStatus.screen=!1;const t=e.getId();if(t){delete this.adapterRef.remoteScreenStats[t];const e=this.adapterRef._statsReport&&this.adapterRef._statsReport.formativeStatsReport&&this.adapterRef._statsReport.formativeStatsReport.firstData.recvFirstData[t];e&&(e.recvFirstScreenFrame=!1,e.recvFirstScreenPackage=!1,e.screenTotalPlayDuration=0)}this.logger.log("取消订阅辅助流完成")}this.apiFrequencyControl({name:"subscribe",code:0,param:JSON.stringify({reason:"",subStatus:e.subStatus,subConf:e.subConf,pubStatus:e.pubStatus},null," ")})}catch(t){if("resetConsumeRequestStatus"===t)return void this.logger.warn("API调用被打断：Client:subscribe",t);this.logger.error("API调用失败：Client:subscribe",t,t.name,t.message,...arguments),this.apiFrequencyControl({name:"subscribe",code:-1,param:JSON.stringify({reason:t.message,subStatus:e.subStatus,subConf:e.subConf,pubStatus:e.pubStatus},null," ")})}}async unsubscribe(e,t){return _.checkExists({tag:"client.unsubscribe:stream",value:e}),this.doUnsubscribe(e,t)}async doUnsubscribe(e,t){this.logger.log(`unsubscribe() [取消订阅远端音视频流: ${e.stringStreamID}, mediaType: ${t||"all"}]`);try{if((void 0===t||"audio"===t)&&e.pubStatus.audio.consumerId&&"start"!==e.pubStatus.audio.stopconsumerStatus){if(this.logger.log("开始取消订阅音频流"),e.pubStatus.audio.stopconsumerStatus="start",!this.adapterRef._mediasoup){let e="doUnsubscribe:  media server error 1",t="doUnsubscribe: 媒体服务异常 1",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new g.default({code:f.default.MEDIA_SERVER_ERROR,message:s,advice:a})}await this.adapterRef._mediasoup.destroyConsumer(e.pubStatus.audio.consumerId,e,"audio"),this.adapterRef.instance.removeSsrc(e.getId(),"audio"),e.mediaHelper.updateStream("audio",null),e.pubStatus.audio.consumerId="",e.stop("audio"),e.pubStatus.audio.stopconsumerStatus="end",e.subStatus.audio=!1;const t=e.getId();if(t){delete this.adapterRef.remoteAudioStats[t];const e=this.adapterRef._statsReport&&this.adapterRef._statsReport.formativeStatsReport&&this.adapterRef._statsReport.formativeStatsReport.firstData.recvFirstData[t];e&&(e.recvFirstAudioFrame=!1,e.recvFirstAudioPackage=!1)}this.logger.log("取消订阅音频流完成")}if((void 0===t||"audioSlave"===t)&&e.pubStatus.audioSlave.consumerId&&"start"!==e.pubStatus.audioSlave.stopconsumerStatus){if(this.logger.log("开始取消订阅音频流"),e.pubStatus.audioSlave.stopconsumerStatus="start",!this.adapterRef._mediasoup){let e="doUnsubscribe:  media server error 2",t="doUnsubscribe: 媒体服务异常 2",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new g.default({code:f.default.MEDIA_SERVER_ERROR,message:s,advice:a})}await this.adapterRef._mediasoup.destroyConsumer(e.pubStatus.audioSlave.consumerId,e,"audioSlave"),this.adapterRef.instance.removeSsrc(e.getId(),"audioSlave"),e.mediaHelper.updateStream("audioSlave",null),e.pubStatus.audioSlave.consumerId="",e.stop("audioSlave"),e.pubStatus.audioSlave.stopconsumerStatus="end",e.subStatus.audioSlave=!1;const t=e.getId();t&&delete this.adapterRef.remoteAudioSlaveStats[t],this.logger.log("取消订阅音频流完成")}if((void 0===t||"video"===t)&&e.pubStatus.video.consumerId&&"start"!==e.pubStatus.video.stopconsumerStatus){if(this.logger.log("开始取消订阅视频流"),e.pubStatus.video.stopconsumerStatus="start",!this.adapterRef._mediasoup){let e="doUnsubscribe:  media server error 3",t="doUnsubscribe: 媒体服务异常 3",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new g.default({code:f.default.MEDIA_SERVER_ERROR,message:s,advice:a})}await this.adapterRef._mediasoup.destroyConsumer(e.pubStatus.video.consumerId,e,"video"),this.adapterRef.instance.removeSsrc(e.getId(),"video"),e.mediaHelper.updateStream("video",null),e.pubStatus.video.consumerId="",e.stop("video"),e.pubStatus.video.stopconsumerStatus="end",e.subStatus.video=!1;const t=e.getId();if(t){delete this.adapterRef.remoteVideoStats[t];const e=this.adapterRef._statsReport&&this.adapterRef._statsReport.formativeStatsReport&&this.adapterRef._statsReport.formativeStatsReport.firstData.recvFirstData[t];e&&(e.recvFirstVideoFrame=!1,e.recvFirstVideoPackage=!1,e.videoTotalPlayDuration=0)}this.logger.log("取消订阅视频流完成")}if((void 0===t||"screen"===t)&&e.pubStatus.screen.consumerId&&"start"!==e.pubStatus.screen.stopconsumerStatus){if(this.logger.log("开始取消订阅辅流"),e.pubStatus.screen.stopconsumerStatus="start",!this.adapterRef._mediasoup){let e="doUnsubscribe:  media server error 4",t="doUnsubscribe: 媒体服务异常 4",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new g.default({code:f.default.MEDIA_SERVER_ERROR,message:s,advice:a})}await this.adapterRef._mediasoup.destroyConsumer(e.pubStatus.screen.consumerId,e,"screen"),this.adapterRef.instance.removeSsrc(e.getId(),"screen"),e.mediaHelper.updateStream("screen",null),e.pubStatus.screen.consumerId="",e.stop("screen"),e.pubStatus.screen.stopconsumerStatus="end",e.subStatus.screen=!1;const t=e.getId();if(t){delete this.adapterRef.remoteScreenStats[t];const e=this.adapterRef._statsReport&&this.adapterRef._statsReport.formativeStatsReport&&this.adapterRef._statsReport.formativeStatsReport.firstData.recvFirstData[t];e&&(e.recvFirstScreenFrame=!1,e.recvFirstScreenPackage=!1,e.screenTotalPlayDuration=0)}this.logger.log("取消订阅辅助流完成")}this.apiFrequencyControl({name:"unsubscribe",code:0,param:JSON.stringify({clientUid:this.getUid(),streamId:e.stringStreamID,reason:"",subStatus:e.subStatus,subConf:e.subConf},null," ")})}catch(t){this.logger.error("API调用失败：Client:unsubscribe",t.name,t.message,t,...arguments),this.apiFrequencyControl({name:"unsubscribe",code:-1,param:JSON.stringify({clientUid:this.getUid(),streamId:e.stringStreamID,reason:t.message,subStatus:e.subStatus,subConf:e.subConf},null," ")})}}async setRemoteVideoStreamType(e,t){this.logger.log(`uid ${e.getId()} 订阅成员的${t?"小":"大"}流`,t);try{if(!this.adapterRef._mediasoup){let e="setRemoteVideoStreamType:  media server error",t="setRemoteVideoStreamType: 媒体服务异常",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new g.default({code:f.default.MEDIA_SERVER_ERROR,message:s,advice:a})}await this.adapterRef._mediasoup.setConsumerPreferredLayer(e,t?0:1,"video"),e.subConf.highOrLow.video=t,this.apiFrequencyControl({name:"setRemoteVideoStreamType",param:JSON.stringify({clientUid:this.getUid(),streamId:e.stringStreamID,highOrLow:t},null," ")})}catch(i){this.logger.error("API调用失败：Client:setRemoteVideoStreamType",i.name,i.message,i,...arguments),this.apiFrequencyControl({name:"setRemoteVideoStreamType",code:-1,param:JSON.stringify({clientUid:this.getUid(),streamId:e.stringStreamID,reason:i.message,highOrLow:t},null," ")})}}async setRemoteStreamType(e,t,i){this.logger.log(`setRemoteStreamType: 订阅${e.getId()}成员的${t?"小":"大"}流`,i,t);try{if(!this.adapterRef._mediasoup){let e="setRemoteStreamType:  media server error",t="setRemoteStreamType: 媒体服务异常",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new g.default({code:f.default.MEDIA_SERVER_ERROR,message:s,advice:a})}await this.adapterRef._mediasoup.setConsumerPreferredLayer(e,t?0:1,i),e.subConf.highOrLow[i]=t,this.apiFrequencyControl({name:"setRemoteStreamType",code:0,param:{highOrLow:t,mediaType:i,clientUid:this.getUid(),streamID:e.stringStreamID}})}catch(r){this.logger.error("API调用失败：Client:setRemoteStreamType",r,...arguments),this.apiFrequencyControl({name:"setRemoteVideoStreamType",code:-1,param:JSON.stringify({reason:r.message,highOrLow:t,mediaType:i,streamID:e.stringStreamID},null," ")})}}enableAudioVolumeIndicator(){this.logger.log("开启音量提醒")}enableDualStream(e={video:!0,screen:!1}){this.adapterRef.channelInfo.videoLow=e.video,this.adapterRef.channelInfo.screenLow=e.screen,this.logger.log("开启双流模式"),this.apiFrequencyControl({name:"enableDualStream",code:0,param:{clientUid:this.adapterRef.channelInfo.uid||"",video:e.video,screen:e.screen,reason:""}})}disableDualStream(e={video:!1,screen:!1}){this.logger.log("关闭双流模式"),this.adapterRef.channelInfo.videoLow=!1,this.adapterRef.channelInfo.screenLow=!1,this.apiFrequencyControl({name:"disableDualStream",code:0,param:{clientUid:this.adapterRef.channelInfo.uid||"",video:e.video,screen:e.screen,reason:""}})}async setClientRole(e){let t,i;if("host"===e||"broadcaster"===e?t=0:"audience"===e?t=1:(this.logger.error("setClientRole: 无法识别的角色："+e),i="INVALID_OPERATION",t=-1),!i){const r=this.adapterRef.channelInfo&&this.adapterRef.channelInfo.uid||"";if(t===this._roleInfo.userRole)this.logger.warn(`setClientRole: 用户${r}的角色已经是${e}了`);else switch(this.adapterRef.connectState.curState){case"CONNECTED":if(1===t&&this.adapterRef.localStream&&this.isPublished(this.adapterRef.localStream)&&(this.logger.info(`setClientRole：主播 ${r}将设为观众，自动Unpublish中`),await this.unpublish(this.adapterRef.localStream)),!this.adapterRef._mediasoup){let e="setClientRole:  media server error",t="setClientRole: 媒体服务异常",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new g.default({code:f.default.MEDIA_SERVER_ERROR,message:s,advice:a})}await this.adapterRef._mediasoup.updateUserRole(t),this._roleInfo.userRole!==t&&(this._roleInfo.userRole=t,this.logger.info(`setClientRole：本地用户${r} 设置角色为 ${e}`),this.safeEmit("client-role-changed",{role:e}));break;case"DISCONNECTED":this._roleInfo.userRole!==t&&(this._roleInfo.userRole=t,this.logger.info(`setClientRole：本地用户${r}设置角色为 ${e}`),this.safeEmit("client-role-changed",{role:e}));break;default:this.logger.error(`setClientRole: 本地用户${r}当前不在频道中，可能是网络波动导致暂时断开连接`),i="USER_NOT_IN_CHANNEL"}}if(this.apiFrequencyControl({name:"setClientRole",code:i?-1:0,param:{role:e,reason:i}}),i){if("INVALID_OPERATION"===i){let e="setClientRole: invalid operation",t="setClientRole: 操作异常",i="please make sure the role is valid",r="请确认 role 是合法的",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;return Promise.reject(new g.default({code:f.default.INVALID_OPERATION_ERROR,message:s,advice:a}))}if("USER_NOT_IN_CHANNEL"===i){let e="setClientRole: the current user id not in the channel",t="setClientRole: 当前用户不在频道中",i="This may caused by a temporary network failure connection",r="可能是临时网络异常引起的",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;return Promise.reject(new g.default({code:f.default.USER_NOT_IN_CHANNEL_ERROR,message:s,advice:a}))}}}bindLocalStream(e){this.adapterRef.localStream=e,e.client=this,e.logger.parent=this.logger;const t=this.getUid();t&&e.streamID!==t&&(this.logger.warn("localStream更换streamID",e.streamID,"=>",t),e.streamID=t,e.stringStreamID=t.toString())}getConnectionState(){return this.apiFrequencyControl({name:"getConnectionState",code:0,param:JSON.stringify({},null," ")}),this.adapterRef.connectState.curState}getSystemStats(){if(!navigator.getBattery){let e="getSystemStats: navigator.getBattery is not support in your browser",t="getSystemStats: 当前浏览器不支持 navigator.getBattery",i="The latest version of the Chrome browser is recommended",r="建议使用最新版的 Chrome 浏览器",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;return Promise.reject(new g.default({code:f.default.NOT_SUPPORT_ERROR,url:"https://developer.mozilla.org/en-US/docs/Web/API/Navigator/getBattery",message:s,advice:a}))}return new Promise((e,t)=>{navigator.getBattery().then((function(t){e(100*t.level)}))})}getSessionStats(){return new Promise((e,t)=>{this.adapterRef.sessionStats.Duration=(Date.now()-this.adapterRef.state.startSessionTime)/1e3,this.adapterRef.sessionStats.UserCount=Object.keys(this.adapterRef.memberMap).length+1,e(this.adapterRef.sessionStats)})}getTransportStats(){return new Promise((e,t)=>{e(this.adapterRef.transportStats)})}getLocalAudioStats(){return new Promise((e,t)=>{e(this.adapterRef.localAudioStats)})}getLocalAudioSlaveStats(){return new Promise((e,t)=>{e(this.adapterRef.localAudioSlaveStats)})}getLocalVideoStats(e){let t=[];return e&&"video"!==e||(t=t.concat(this.adapterRef.localVideoStats)),e&&"screen"!==e||(t=t.concat(this.adapterRef.localScreenStats)),Promise.resolve(t)}getRemoteAudioStats(){return new Promise((e,t)=>{e(this.adapterRef.remoteAudioStats)})}getRemoteAudioSlaveStats(){return new Promise((e,t)=>{e(this.adapterRef.remoteAudioSlaveStats)})}getRemoteVideoStats(e){let t={};return e&&"screen"!==e||(t=Object.assign(t,this.adapterRef.remoteScreenStats)),e&&"video"!==e||(t=Object.assign(t,this.adapterRef.remoteVideoStats)),Promise.resolve(t)}setChannelProfile(e){let t=null;if(this.logger.log("setChannelProfile, options: ",JSON.stringify(e,null," ")),"DISCONNECTED"!==this.adapterRef.connectState.curState)this.logger.warn("setChannelProfile: 请在加入房间前调用"),t="setChannelProfile: please invoke this function before join()";else{const t=e.mode||"rtc";this.adapterRef.localStream&&("live"===t?this.adapterRef.localStream.audioProfile="music_standard":"rtc"===t&&(this.adapterRef.localStream.audioProfile="speech_low_quality")),this._params.mode=t}if(this.apiFrequencyControl({name:"setChannelProfile",code:t?-1:0,param:{mode:e.mode,reason:t}}),t){let e="setChannelProfile: invalid operation",t="setChannelProfile: 操作异常",i="please invoke this function before join()",r="请在进房前调用",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new g.default({code:f.default.INVALID_OPERATION_ERROR,message:s,advice:a})}}async updatePermKey(e){var t;try{this.logger.log("updatePermKey() permKey: "+e),this.adapterRef.channelInfo.permKey=e,await(null===(t=this.adapterRef._signalling)||void 0===t?void 0:t.updatePermKey(e)),this.adapterRef.instance.apiFrequencyControl({name:"updatePermKey",code:0,param:{permKey:e}})}catch(t){throw this.adapterRef.instance.apiFrequencyControl({name:"updatePermKey",code:t.code,param:{permKey:e,reason:t.message}}),t}}async addTasks(e){var t;this.logger.log("addTasks() 增加互动直播推流任务, options: ",JSON.stringify(e));let i,r,s,a,o,n,d=null;if(1===this._roleInfo.userRole&&(this.logger.error("addTasks: 观众不允许进行直播推流操作"),i="addTasks: audience is not allowed to addTasks",r="addTasks: 观众不允许进行直播推流操作",s="please make sure role is correct",a="请输入正确的 role 类型",o=S.IS_ZH?r:i,n=S.IS_ZH?a:s,d="addTasks: 观众不允许进行直播推流操作"),this.adapterRef._meetings||(this.logger.error("addTasks: 加入房间后进行直播推流操作"),i="addTasks: addTasks is not allowed before join()",r="addTasks: 加入房间后进行直播推流操作",s="please join first",a="请先加入房间",o=S.IS_ZH?r:i,n=S.IS_ZH?a:s,d="addTasks: 加入房间后进行直播推流操作"),d)throw this.adapterRef.instance.apiFrequencyControl({name:"addTasks",code:-1,param:{clientUid:this.getUid(),reason:d}}),new g.default({code:f.default.TASK_ERROR,message:o,advice:n});try{await(null===(t=this.adapterRef._meetings)||void 0===t?void 0:t.addTasks(e)),this.adapterRef.instance.apiFrequencyControl({name:"onAddTasks",code:0,param:{lbsAddrs:this.adapterRef.lbsManager.getReportField("call"),clientUid:this.getUid()}})}catch(e){throw this.adapterRef.instance.apiFrequencyControl({name:"onAddTasks",code:-1,param:{clientUid:this.getUid(),lbsAddrs:this.adapterRef.lbsManager.getReportField("call"),reason:e.message}}),e}}async deleteTasks(e){var t;this.logger.log("deleteTasks() 删除互动直播推流任务, options: ",e);let i,r,s,a,o,n,d=null;if(1===this._roleInfo.userRole&&(this.logger.error("addTasks: 观众不允许进行直播推流操作"),d="deleteTasks: 观众不允许进行直播推流操作",i="deleteTasks: audience is not allowed to deleteTasks",r="deleteTasks: 观众不允许进行直播推流操作",s="please make sure role is correct",a="请输入正确的 role 类型",o=S.IS_ZH?r:i,n=S.IS_ZH?a:s),this.adapterRef._meetings||(this.logger.error("deleteTasks: 加入房间后进行直播推流操作"),d="deleteTasks: 加入房间后进行直播推流操作",i="deleteTasks: deleteTasks is not allowed before join()",r="deleteTasks: 加入房间后进行直播推流操作",s="please join first",a="请先加入房间",o=S.IS_ZH?r:i,n=S.IS_ZH?a:s),d)throw this.logger.error(d),this.adapterRef.instance.apiFrequencyControl({name:"deleteTasks",code:-1,param:{clientUid:this.getUid(),reason:d}}),new g.default({code:f.default.TASK_ERROR,message:o,advice:n});try{await(null===(t=this.adapterRef._meetings)||void 0===t?void 0:t.deleteTasks(e)),this.adapterRef.instance.apiFrequencyControl({name:"onDeleteTasks",code:0,param:{lbsAddrs:this.adapterRef.lbsManager.getReportField("call"),clientUid:this.getUid()}})}catch(e){throw this.adapterRef.instance.apiFrequencyControl({name:"onDeleteTasks",code:-1,param:{clientUid:this.getUid(),lbsAddrs:this.adapterRef.lbsManager.getReportField("call"),reason:e.message}}),e}}async updateTasks(e){var t;this.logger.log("updateTasks() 更新互动直播推流任务, options: ",e);let i,r,s,a,o,n,d=null;if(1===this._roleInfo.userRole&&(d="updateTasks: 观众不允许进行直播推流操作",this.logger.error("updateTasks: 观众不允许进行直播推流操作"),i="updateTasks: audience is not allowed to updateTasks",r="updateTasks: 观众不允许进行直播推流操作",s="please make sure role is correct",a="请输入正确的 role 类型",o=S.IS_ZH?r:i,n=S.IS_ZH?a:s),this.adapterRef._meetings||(d="updateTasks: 加入房间后进行直播推流操作",this.logger.error("updateTasks: 加入房间后进行直播推流操作"),i="updateTasks: updateTasks is not allowed before join()",r="updateTasks: 加入房间后进行直播推流操作",s="please join first",a="请先加入房间",o=S.IS_ZH?r:i,n=S.IS_ZH?a:s),d)throw this.logger.error(d),this.adapterRef.instance.apiFrequencyControl({name:"updateTasks",code:-1,param:{clientUid:this.getUid(),reason:d}}),new g.default({code:f.default.TASK_ERROR,message:o,advice:n});try{await(null===(t=this.adapterRef._meetings)||void 0===t?void 0:t.updateTasks(e)),this.adapterRef.instance.apiFrequencyControl({name:"onUpdateTasks",code:0,param:{clientUid:this.getUid(),lbsAddrs:this.adapterRef.lbsManager.getReportField("call")}})}catch(e){throw this.adapterRef.instance.apiFrequencyControl({name:"onUpdateTasks",code:-1,param:{clientUid:this.getUid(),lbsAddrs:this.adapterRef.lbsManager.getReportField("call"),reason:e.message}}),e}}setEncryptionMode(e){if(_.checkValidInteger({tag:"Valid encryptionModes are: "+Object.keys(l.EncryptionModes).join(","),value:l.encryptionModeToInt(e)}),this.adapterRef.encryption.encodedInsertableStreams){const e="自定义加密功能与国密加密功能不兼容";this.logger.error(e);let t="enableCustomTransform: Custom encryption and national encryption are not compatible",i="enableCustomTransform: 自定义加密功能与国密加密功能不兼容",r="Cannot use custom encryption and national encryption at the same time",s="不能同时使用自定义加密功能与国密加密功能",a=S.IS_ZH?i:t,o=S.IS_ZH?s:r;throw new g.default({code:f.default.SET_ENCRYPTION_MODE_ERROR,message:a,advice:o})}this.logger.log("设置加密模式：",e),this.adapterRef.encryption.setEncryptionMode(e);const t={enable:"none"!==e,mode:l.encryptionModeToInt(e)};this.apiFrequencyControl({name:"setEncryptionMode",code:0,param:JSON.stringify(t,null," ")})}setEncryptionSecret(e){switch(this.adapterRef.encryption.encryptionMode){case"none":let t="Client.setEncryptionSecret: invalid operation",i="Client.setEncryptionSecret: 操作异常",r="please set encryptionMode first",s="请先设置加密模式",a=S.IS_ZH?i:t,o=S.IS_ZH?s:r;throw new g.default({code:f.default.INVALID_OPERATION_ERROR,message:a,advice:o});case"sm4-128-ecb":_.checkValidString({tag:"client.setEncryptionSecret:encryptionSecret",value:e,min:1,max:128})}this.logger.log("设置加密密钥"),this.adapterRef.encryption.setEncryptionSecret(e),this.apiFrequencyControl({name:"setEncryptionSecret",code:0,param:JSON.stringify({encryptionSecret:e},null," ")})}async pauseReconnection(){this.logger.log("pauseReconnection：下一次重连行为会被暂停，直到调用resumeReconnection()方法");const e=await new Promise(e=>{this.adapterRef._signalling&&this.adapterRef._signalling.reconnectionControl.pausers.push(e)});return this.logger.log("pauseReconnection：重连已被暂停："+JSON.stringify(e)),e}async resumeReconnection(){if(this.adapterRef._signalling){this.adapterRef._signalling.reconnectionControl.blocker?(this.logger.log("resumeReconnection：即将恢复重连过程"),this.adapterRef._signalling.reconnectionControl.blocker(),this.adapterRef._signalling.reconnectionControl.pausers.forEach(e=>e({reason:"reconnection-resume"})),this.adapterRef._signalling.reconnectionControl.pausers=[]):this.adapterRef._signalling.reconnectionControl.pausers.length?(this.logger.log("resumeReconnection：取消之前的 pauseReconnection 操作。"),this.adapterRef._signalling.reconnectionControl.pausers.forEach(e=>e({reason:"cancelled"})),this.adapterRef._signalling.reconnectionControl.pausers=[]):this.logger.warn("resumeReconnection：未发现pauseReconnection操作");const e=await new Promise(e=>{var t;null===(t=this.adapterRef._signalling)||void 0===t||t.reconnectionControl.resumers.push(e)});return this.logger.log("resumeReconnection：恢复重连成功"+JSON.stringify(e)),e}}refreshRemoteEvents(){for(let e in this.adapterRef.remoteStreamMap){const t=this.adapterRef.remoteStreamMap[e];this.logger.warn("refreshRemoteEvents peer-online",e),this.safeEmit("peer-online",{uid:e});["audio","video","screen","audioSlave"].forEach(i=>{t.pubStatus[i].producerId&&(this.logger.warn("refreshRemoteEvents stream-added",e,i),this.safeEmit("stream-added",{stream:t,mediaType:i}),t.muteStatus[i].send&&(this.logger.warn("refreshRemoteEvents mute-"+i,e,i),this.safeEmit("mute-"+i,{uid:t.getId()})))})}}initSpatialManager(e){if(!this.spatialManager){const t=m.getAudioContext();if(!t)return void this.logger.error("当前环境不支持WebAudio");this.spatialManager=new R.SpatialManager({client:this,options:e,context:t})}this.spatialManager.init(),this.spatialManager.play()}syncUserList(){return this.adapterRef.memberMap}updateRecordingAudioStream(){if(!this.recordManager||!this.recordManager.formatMedia||!this.recordManager.formatMedia.destination)return;this.logger.log("updateRecordingAudioStream() [更新录制的音频]");const e=[];if(this.adapterRef.remoteStreamMap)for(var t in this.adapterRef.remoteStreamMap){const i=this.adapterRef.remoteStreamMap[t];e.push(i.mediaHelper.audio.audioStream)}this.adapterRef.localStream&&e.push(this.adapterRef.localStream.mediaHelper.audio.audioStream),this.recordManager.formatMedia.updateStream(e)}async startMediaRecording(e){const{recorder:t,recordConfig:i}=e;this.recordManager.record||(this.recordManager.record=new p.Record({logger:this.logger,client:this.adapterRef.instance}),this.recordManager.record.on("media-recording-stopped",e=>{this.safeEmit("@media-recording-stopped")})),this.recordManager.formatMedia||(this.recordManager.formatMedia=new u.FormatMedia({adapterRef:this.adapterRef}));const r=[];if(this.adapterRef.localStream&&r.push(this.adapterRef.localStream.mediaHelper.audio.audioStream),"all"===t&&this.adapterRef.remoteStreamMap)for(var s in this.adapterRef.remoteStreamMap){const e=this.adapterRef.remoteStreamMap[s];r.push(e.mediaHelper.audio.audioStream)}const a=await this.recordManager.formatMedia.formatAudio(r),o=await this.recordManager.formatMedia.formatVideo(t,i),n=[];if(n.push(a,o),0!==n.length)return this.recordManager.record.start({uid:"",type:(null==i?void 0:i.recordType)||"video",recordName:null==i?void 0:i.recordName,reset:!0,stream:n});this.logger.log("没有没发现要录制的媒体流")}stopMediaRecording(e){if(!this.recordManager.record){let e="Client.stopMediaRecording: recording is not start",t="Client.stopMediaRecording: 录制未开始",i="Please start recording first",r="请先开启录制",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new g.default({code:f.default.RECORDING_NOT_START_ERROR,message:s,advice:a})}return this.recordManager.record.stop({})}cleanMediaRecording(){if(!this.recordManager.record){let e="Client.cleanMediaRecording: recording is not start",t="Client.cleanMediaRecording: 录制未开始",i="Please start recording first",r="请先开启录制",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new g.default({code:f.default.RECORDING_NOT_START_ERROR,message:s,advice:a})}return this.recordManager.record.clean()}downloadMediaRecording(){if(!this.recordManager.record){let e="Client.downloadMediaRecording: recording is not start",t="Client.downloadMediaRecording: 录制未开始",i="Please start recording first",r="请先开启录制",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new g.default({code:f.default.RECORDING_NOT_START_ERROR,message:s,advice:a})}return this.recordManager.record.download()}async destroy(){const e=await this.operationQueue.enqueue({caller:this,method:"destroy",options:null});this.logger&&this.logger.warn("清除 Client 实例中"),this._reset(),this.destroyed=!0,this.logger&&this.logger.warn("已清除 Client 实例"),e()}}t.Client=b},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.ENV=t.LBS_BUILD_CONFIG=t.Config=void 0,t.Config={lbsUrl:"https://wecan-lbs.netease.im/api/v1/web_domains",checkSumUrl:"https://nrtc.netease.im/demo/getChecksum.action",createChannelUrl:"https://nrtc.netease.im/nrtc/createChannel.action",getChannelInfoUrl:"https://nrtc.netease.im/nrtc/getChannelInfos.action",roomsTaskUrl:"https://roomserver.netease.im/v2/sdk/rooms/",getCloudProxyInfoUrl:"https://ap-prd-jd.netease.im/v1/g2/getCloudProxyInfo"},t.LBS_BUILD_CONFIG={lbs:["wecan-lbs.netease.im","wecan-lbs.yunxinvcloud.com"],nrtc:["nrtc.netease.im","wecan-gw.yunxinvcloud.com"],call:["roomserver.netease.im","wecan-sdk.yunxinvcloud.com"],tracking:["statistic.live.126.net","apm.yunxinhi.com"]},t.ENV="production"},function(e,t,i){var r,s;!function(a,o){void 0===(s="function"==typeof(r=function(){var e=function(){},t="undefined"!=typeof window&&void 0!==window.navigator&&/Trident\/|MSIE /.test(window.navigator.userAgent),i=["trace","debug","info","warn","error"];function r(e,t){var i=e[t];if("function"==typeof i.bind)return i.bind(e);try{return Function.prototype.bind.call(i,e)}catch(t){return function(){return Function.prototype.apply.apply(i,[e,arguments])}}}function s(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function a(i){return"debug"===i&&(i="log"),"undefined"!=typeof console&&("trace"===i&&t?s:void 0!==console[i]?r(console,i):void 0!==console.log?r(console,"log"):e)}function o(t,r){for(var s=0;s<i.length;s++){var a=i[s];this[a]=s<t?e:this.methodFactory(a,t,r)}this.log=this.debug}function n(e,t,i){return function(){"undefined"!=typeof console&&(o.call(this,t,i),this[e].apply(this,arguments))}}function d(e,t,i){return a(e)||n.apply(this,arguments)}function c(e,t,r){var s,a=this,n="loglevel";function c(){var e;if("undefined"!=typeof window&&n){try{e=window.localStorage[n]}catch(e){}if(void 0===e)try{var t=window.document.cookie,i=t.indexOf(encodeURIComponent(n)+"=");-1!==i&&(e=/^([^;]+)/.exec(t.slice(i))[1])}catch(e){}return void 0===a.levels[e]&&(e=void 0),e}}"string"==typeof e?n+=":"+e:"symbol"==typeof e&&(n=void 0),a.name=e,a.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},a.methodFactory=r||d,a.getLevel=function(){return s},a.setLevel=function(t,r){if("string"==typeof t&&void 0!==a.levels[t.toUpperCase()]&&(t=a.levels[t.toUpperCase()]),!("number"==typeof t&&t>=0&&t<=a.levels.SILENT))throw"log.setLevel() called with invalid level: "+t;if(s=t,!1!==r&&function(e){var t=(i[e]||"silent").toUpperCase();if("undefined"!=typeof window&&n){try{return void(window.localStorage[n]=t)}catch(e){}try{window.document.cookie=encodeURIComponent(n)+"="+t+";"}catch(e){}}}(t),o.call(a,t,e),"undefined"==typeof console&&t<a.levels.SILENT)return"No console available for logging"},a.setDefaultLevel=function(e){c()||a.setLevel(e,!1)},a.enableAll=function(e){a.setLevel(a.levels.TRACE,e)},a.disableAll=function(e){a.setLevel(a.levels.SILENT,e)};var l=c();null==l&&(l=null==t?"WARN":t),a.setLevel(l,!1)}var l=new c,u={};l.getLogger=function(e){if("symbol"!=typeof e&&"string"!=typeof e||""===e)throw new TypeError("You must supply a name when creating a logger.");var t=u[e];return t||(t=u[e]=new c(e,l.getLevel(),l.methodFactory)),t};var h="undefined"!=typeof window?window.log:void 0;return l.noConflict=function(){return"undefined"!=typeof window&&window.log===l&&(window.log=h),l},l.getLoggers=function(){return u},l.default=l,l})?r.call(t,i,t,e):r)||(e.exports=s)}()},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.logHelper=void 0;t.logHelper=class{constructor(e){if(e.maxLogsLines&&"number"==typeof e.maxLogsLines&&!isNaN(e.maxLogsLines)?this.maxLogsLines=e.maxLogsLines:this.maxLogsLines=5e3,e.logFilename&&(e.logFilename=e.logFilename+".txt"),this.useTimestamps=e.useTimestamps||!1,this.useLocalStorage=e.useLocalStorage||!1,this.autoTrim=!0,this.maxLines=e.maxLogsLines||5e3,this.tailNumLines=100,this.logFilename=e.logFilename||"nimWebRtcLog.txt",this.maxDepth=5,this.depth=0,this.parentSizes=[0],this.currentResult="",this.startTime=new Date,this.output="",this.useLocalStorage){var t=window.localStorage.getItem("nimWebRtcLog");if(t){var i=JSON.parse(t);this.output=i.log;var r=new Date(i.startTime),s=new Date(i.lastLog);this.output+="\n---- Session end: "+i.lastLog+" ----\n",this.output+=this.formatSessionDuration(r.getTime(),s.getTime()),this.output+="\n\n"}}this.output+="---- Session started: "+this.startTime+" ----\n\n"}getLog(){var e=new Date;if(this.useLocalStorage){var t=window.localStorage.getItem("nimWebRtcLog");if(t){var i=JSON.parse(t);this.startTime=new Date(i.startTime),this.output=i.log,e=new Date(i.lastLog)}}return this.output+"\n---- Log retrieved: "+e+" ----\n"+this.formatSessionDuration(this.startTime.getTime(),e.getTime())}tail(e){e=e||this.tailNumLines;return this.trimLog(this.getLog(),e)}search(e){for(var t=this.output.split("\n"),i=new RegExp(e),r=[],s=0;s<t.length;s++){var a="["+s+"] ";t[s].match(i)&&r.push(a+t[s])}var o=r.join("\n");return 0==o.length&&(o='Nothing found for "'+e+'".'),o}getSlice(e,t){return this.output.split("\n").slice(e,e+t).join("\n")}downloadLog(){var e=this.getLog(),t=new Blob([e],{type:"data:text/plain;charset=utf-8"}),i=document.createElement("a");i.href=window.URL.createObjectURL(t),i.target="_blank",i.download=this.logFilename,document.body.appendChild(i),i.click(),document.body.removeChild(i),window.URL.revokeObjectURL(i.href)}clear(){var e=new Date;if(this.output="---- Log cleared: "+e+" ----\n",this.useLocalStorage){var t={startTime:this.startTime,log:this.output,lastLog:e},i=JSON.stringify(t);window.localStorage.setItem("nimWebRtcLog",i)}}log(e){var t=this.determineType(e);if(null!=t){var i=this.formatType(t,e);if(this.useTimestamps){var r=new Date;this.output+=this.formatTimestamp(r)}if(this.output+=i+"\n",this.autoTrim&&(this.output=this.trimLog(this.output,this.maxLines)),this.useLocalStorage){var s=new Date,a={startTime:this.startTime,log:this.output,lastLog:s},o=JSON.stringify(a);window.localStorage.setItem("nimWebRtcLog",o)}}this.depth=0,this.parentSizes=[0],this.currentResult=""}determineType(e){if(null!=e){var t,i=typeof e;if("object"==i)t=null==e.length?"function"==typeof e.getTime?"Date":"function"==typeof e.test?"RegExp":"Object":"Array";else t=i;return t}return"null"}formatType(e,t){if(this.maxDepth&&this.depth>=this.maxDepth)return"... (max-depth reached)";switch(e){case"Object":this.currentResult+="{\n",this.depth++,this.parentSizes.push(this.objectSize(t));var i=0;for(var r in t){this.currentResult+=this.indentsForDepth(this.depth),this.currentResult+=r+": ";var s=this.determineType(t[r]);(a=this.formatType(s,t[r]))?("function"!==s&&(this.currentResult+=a),i!=this.parentSizes[this.depth]-1&&(this.currentResult+=","),this.currentResult+="\n"):(i!=this.parentSizes[this.depth]-1&&(this.currentResult+=","),this.currentResult+="\n"),i++}if(this.depth--,this.parentSizes.pop(),this.currentResult+=this.indentsForDepth(this.depth),this.currentResult+="}",0==this.depth)return this.currentResult;break;case"Array":this.currentResult+="[",this.depth++,this.parentSizes.push(t.length);for(i=0;i<t.length;i++){var a;"Object"!=(s=this.determineType(t[i]))&&"Array"!=s||(this.currentResult+="\n"+this.indentsForDepth(this.depth)),(a=this.formatType(s,t[i]))?(this.currentResult+=a,i!=this.parentSizes[this.depth]-1&&(this.currentResult+=", "),"Array"==s&&(this.currentResult+="\n")):(i!=this.parentSizes[this.depth]-1&&(this.currentResult+=", "),("Object"!=s||i==this.parentSizes[this.depth]-1)&&(this.currentResult+="\n"))}if(this.depth--,this.parentSizes.pop(),this.currentResult+="]",0==this.depth)return this.currentResult;break;case"function":var o=(t+="").split("\n");for(i=0;i<o.length;i++)o[i].match(/\}/)&&this.depth--,this.currentResult+=this.indentsForDepth(this.depth),o[i].match(/\{/)&&this.depth++,this.currentResult+=o[i]+"\n";return this.currentResult;case"RegExp":return"/"+t.source+"/";case"Date":case"string":return this.depth>0||0==t.length?'"'+t+'"':t;case"boolean":return t?"true":"false";case"number":return t+""}}indentsForDepth(e){for(var t="",i=0;i<e;i++)t+="\t";return t}trimLog(e,t){var i=e.split("\n");return i.length>t&&(i=i.slice(i.length-t)),i.join("\n")}lines(){return this.output.split("\n").length}formatSessionDuration(e,t){var i=t-e,r=Math.floor(i/1e3/60/60),s=("0"+r).slice(-2);i-=1e3*r*60*60;var a=Math.floor(i/1e3/60),o=("0"+a).slice(-2);i-=1e3*a*60;var n=Math.floor(i/1e3);return i-=1e3*n,"---- Session duration: "+s+":"+o+":"+("0"+n).slice(-2)+" ----"}formatTimestamp(e){var t=e.getFullYear(),i=e.getDate();return"["+t+"-"+("0"+(e.getMonth()+1)).slice(-2)+"-"+i+" "+Number(e.getHours())+":"+("0"+e.getMinutes()).slice(-2)+":"+("0"+e.getSeconds()).slice(-2)+"]: "}objectSize(e){var t,i=0;for(t in e)e.hasOwnProperty&&e.hasOwnProperty(t)&&i++;return i}}},function(e,t){var i,r;i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",r={rotl:function(e,t){return e<<t|e>>>32-t},rotr:function(e,t){return e<<32-t|e>>>t},endian:function(e){if(e.constructor==Number)return 16711935&r.rotl(e,8)|4278255360&r.rotl(e,24);for(var t=0;t<e.length;t++)e[t]=r.endian(e[t]);return e},randomBytes:function(e){for(var t=[];e>0;e--)t.push(Math.floor(256*Math.random()));return t},bytesToWords:function(e){for(var t=[],i=0,r=0;i<e.length;i++,r+=8)t[r>>>5]|=e[i]<<24-r%32;return t},wordsToBytes:function(e){for(var t=[],i=0;i<32*e.length;i+=8)t.push(e[i>>>5]>>>24-i%32&255);return t},bytesToHex:function(e){for(var t=[],i=0;i<e.length;i++)t.push((e[i]>>>4).toString(16)),t.push((15&e[i]).toString(16));return t.join("")},hexToBytes:function(e){for(var t=[],i=0;i<e.length;i+=2)t.push(parseInt(e.substr(i,2),16));return t},bytesToBase64:function(e){for(var t=[],r=0;r<e.length;r+=3)for(var s=e[r]<<16|e[r+1]<<8|e[r+2],a=0;a<4;a++)8*r+6*a<=8*e.length?t.push(i.charAt(s>>>6*(3-a)&63)):t.push("=");return t.join("")},base64ToBytes:function(e){e=e.replace(/[^A-Z0-9+\/]/gi,"");for(var t=[],r=0,s=0;r<e.length;s=++r%4)0!=s&&t.push((i.indexOf(e.charAt(r-1))&Math.pow(2,-2*s+8)-1)<<2*s|i.indexOf(e.charAt(r))>>>6-2*s);return t}},e.exports=r},function(e,t){function i(e){return!!e.constructor&&"function"==typeof e.constructor.isBuffer&&e.constructor.isBuffer(e)}
/*!
 * Determine if an object is a Buffer
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */
e.exports=function(e){return null!=e&&(i(e)||function(e){return"function"==typeof e.readFloatLE&&"function"==typeof e.slice&&i(e.slice(0,0))}(e)||!!e._isBuffer)}},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.FormatMedia=void 0;const n=i(13),d=o(i(11)),c=o(i(12)),l=a(i(2)),u=i(139);class h extends n.EventEmitter{constructor(e){super(),this.adapterRef=e.adapterRef,this.logger=e.adapterRef.logger,this.audioContext=null,this.destination=null,this.audioStreams=[],this.canvas=null,this.canvasContext=null,this.canvasTimer=null}async formatAudio(e){this.logger.log("formatAudio() [混音: ]",e);try{return this.audioContext||(this.audioContext=new window.AudioContext),this.destination=this.audioContext.createMediaStreamDestination(),await this.initAudioIn(e),this.destination.stream}catch(e){this.logger.error("媒体设备获取失败: ",e.name,e.message);let t="formatAudio: get media device error: "+e.name,i="formatAudio: 媒体设备获取失败: "+e.name,r="Please contact CommsEase technical support",s="请联系云信技术支持",a=l.IS_ZH?i:t,o=l.IS_ZH?s:r;return Promise.reject(new c.default({code:d.default.FORMAT_AUDIO_ERROR,message:a,advice:o}))}}initAudioIn(e){if(this.audioContext&&this.destination){for(var t=0;t<e.length;t++){const i=e[t].getAudioTracks()[0];if("live"!==(null==i?void 0:i.readyState))continue;const r=this.audioContext.createMediaStreamSource(e[t]);r.connect(this.destination),this.audioStreams.push(r)}this.logger.log(`initAudioIn() [初始化音频 state: ${this.audioContext.state}]`),"running"!==this.audioContext.state&&this.audioContext.resume().then(()=>{this.audioContext&&this.logger.log(`initAudioIn(): [audioContext 状态变更成功 state: ${this.audioContext.state}]`)}).catch(e=>{this.logger.warn(`initAudioIn(): [audioContext 状态变更发生错误, errorName: ${e.name}, erroMessage: ${e.message}]`),this.audioContext&&this.audioContext.resume()})}else this.logger.error("initAudioIn:参数不够")}async updateStream(e){this.logger.log("updateStream() [更新混频的音频数据: ]",e),this.audioStreams.forEach(e=>{e.disconnect(0)}),this.audioStreams.length=0,this.initAudioIn(e)}stopFormatAudio(){this.logger.log("stopFormatAudio() [结束混音]"),this.audioStreams.forEach(e=>{e.disconnect(0)}),this.audioContext&&this.audioContext.close(),this.audioContext=null,this.destination=null}async formatVideo(e,t){this.logger.log("formatVideo() 混频 recorder: ",e,"recordConfig: ",t);let i=640,r=360;const s=(null==t?void 0:t.recordVideoFrame)||15;switch(null==t?void 0:t.recordVideoQuality){case 360:i=640,r=360;break;case 480:i=640,r=480;break;case 720:i=1280,r=720}this.canvas||(this.canvas=document.createElement("canvas"),this.canvasContext=u.get2DContext(this.canvas)),this.canvas.width=i,this.canvas.height=r,this.canvasTimer&&(clearInterval(this.canvasTimer),this.canvasTimer=null);const a=Math.floor(i/2),o=Math.floor(r/2),n=Math.floor(i/3),d=Math.floor(r/3);return this.canvasContext&&(this.canvasContext.fillStyle="black",this.canvasContext.fillRect(0,0,i,r)),this.canvasTimer&&clearInterval(this.canvasTimer),this.canvasTimer=setInterval(()=>{var s,c,l,u,h,p,m,f;this.canvasContext&&(this.canvasContext.fillStyle="black",this.canvasContext.fillRect(0,0,i,r));let g=[];if("video"===(null==t?void 0:t.recordType)&&(this.adapterRef.localStream&&(null===(s=this.adapterRef.localStream.Play)||void 0===s?void 0:s.videoDom)?g.push(null===(c=this.adapterRef.localStream.Play)||void 0===c?void 0:c.videoDom):g.push(document.createElement("video")),this.adapterRef.localStream&&(null===(l=this.adapterRef.localStream.Play)||void 0===l?void 0:l.screenDom)&&g.push(null===(u=this.adapterRef.localStream.Play)||void 0===u?void 0:u.screenDom),"all"===e&&this.adapterRef.remoteStreamMap))for(var v in this.adapterRef.remoteStreamMap){const e=this.adapterRef.remoteStreamMap[v];(null===(h=e.Play)||void 0===h?void 0:h.videoDom)&&g.push(null===(p=e.Play)||void 0===p?void 0:p.videoDom),(null===(m=e.Play)||void 0===m?void 0:m.screenDom)&&g.push(null===(f=e.Play)||void 0===f?void 0:f.screenDom)}switch(g.length>9&&(g=g.filter(e=>4===e.readyState)),g.length){case 0:break;case 1:this.drawSingleVideo(g[0],0,0,i,r);break;case 2:this.drawSingleVideo(g[0],0,0,a,r),this.drawSingleVideo(g[1],a,0,a,r);break;case 3:case 4:this.drawSingleVideo(g[0],0,0,a,o),this.drawSingleVideo(g[1],a,0,a,o),this.drawSingleVideo(g[2],0,o,a,o),this.drawSingleVideo(g[3],a,o,a,o);break;default:this.drawSingleVideo(g[0],0,0,n,d),this.drawSingleVideo(g[1],n,0,n,d),this.drawSingleVideo(g[2],2*n,0,n,d),this.drawSingleVideo(g[3],0,d,n,d),this.drawSingleVideo(g[4],n,d,n,d),this.drawSingleVideo(g[5],2*n,d,n,d),this.drawSingleVideo(g[6],0,2*d,n,d),this.drawSingleVideo(g[7],n,2*d,n,d),this.drawSingleVideo(g[8],2*n,2*d,n,d)}},Math.floor(1e3/s)),this.canvas.captureStream()}drawSingleVideo(e,t,i,r,s){var a;if(!e)return;const o=Math.min(r/e.videoWidth,s/e.videoHeight);let n=e.videoWidth*o,d=e.videoHeight*o,c=t+(r-n)/2,l=i+(s-d)/2;null===(a=this.canvasContext)||void 0===a||a.drawImage(e,c,l,n,d)}async stopFormatVideo(){this.logger.log("stopFormatAudio() [结束混频]"),this.canvasTimer&&(clearInterval(this.canvasTimer),this.canvasTimer=null),this.canvasContext=this.canvas=null}destroy(){this.logger.log("destroy()"),this.stopFormatAudio(),this.stopFormatVideo()}}t.FormatMedia=h},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.OperationQueue=void 0;t.OperationQueue=class{constructor(e){this.cnt=0,this.current=null,this.history=null,this.queue=[],this.logger=e.getChild(()=>{let e="oper";return this.current?e+=` ${this.current.args.method}#${this.current.id}`:this.history&&(e+=` ${this.history.args.method}#${this.history.id} FINISHED`),this.queue.forEach(t=>{e+=`|${t.args.method}#${t.id}`}),e}),setInterval(()=>{if(this.current&&Date.now()-this.current.enqueueTs>5e3){if(this.queue.length){const e=this.queue[0];this.logger.error(`当前操作已执行了${Date.now()-this.current.enqueueTs}ms，放开锁限制：${this.current.args.method}#${this.current.id}。即将进行下一个操作：${e.args.method}#${e.id}`)}else this.logger.log(`当前操作已执行了${Date.now()-this.current.enqueueTs}ms，放开锁限制：${this.current.args.method}#${this.current.id}`);this.current.status="timeout",this.history=this.current,this.current=null,this.fire("timer")}},5e3)}enqueue(e){return new Promise((t,i)=>{this.queue.push({id:++this.cnt,enqueueTs:Date.now(),args:e,resolve:t,reject:i,status:"pending"}),this.current?this.logger.log(`操作等位中，目前有其他操作。前面还有${this.queue.length}位：${e.method}#${this.cnt}。`):this.fire("instant")})}fire(e){if(!this.current){const t=this.queue.shift();t&&(this.history=this.current,this.current=t,this.current.status="live","instant"===e?this.logger.log("开始执行操作："+t.args.method):this.logger.log(`开始执行队列中的操作：${t.args.method}#${t.id}，等待时间：${Date.now()-t.enqueueTs}ms。参数：`,t.args.options),t.startTs=Date.now(),t.resolve(()=>{this.current===t?(this.current.status="finished",this.history=this.current,this.current=null,this.logger.log(`执行操作结束：${t.args.method}。花费 ${t.startTs?Date.now()-t.startTs:null}ms`),this.fire("functionEnd")):"timeout"===t.status?this.logger.log(`执行操作结束：${t.args.method}。花费 ${t.startTs?Date.now()-t.startTs:null}ms。该操作超时，但未阻塞执行队列。`):this.logger.error(`操作收到多次返回：${t.args.method}#${t.id}。花费 ${t.startTs?Date.now()-t.startTs:null}ms`)}))}}}},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Base=void 0;const n=i(147),d=i(214),c=i(216),l=i(243),u=i(5),h=i(174),p=i(244),m=i(267),f=o(i(11)),g=o(i(12)),v=a(i(117)),_=i(68),S=i(116),y=i(148),R=i(293),b=i(66),T=a(i(2));let w=0;class I extends b.RTCEventEmitter{constructor(e){super(),this.transportRebuildCnt=0,this.timeLast=Date.now(),this._params={appkey:"",mode:"rtc"},this.clientId=w++,this.adapterRef={datareportCache:[],channelInfo:{customData:"",sessionConfig:{}},apiEvent:{},apiEvents:{},requestId:{},instance:this,deviceId:""},!0===e.debug?v.default.setLogLevel(v.loglevels.DEBUG):!1===e.debug&&u.getParameters().logLevel<=v.loglevels.WARNING&&v.default.setLogLevel(v.loglevels.WARNING),this.logger=new S.Logger({tagGen:()=>{let e="client"+(this.clientId||"");const t=this.getUid();return t&&(e+="#"+t),"CONNECTED"!==this.adapterRef.connectState.curState&&(e+=" "+this.adapterRef.connectState.curState),this.destroyed&&(e+=" DESTROYED"),e}}),this.adapterRef.logger=this.logger,this.recordManager={record:null,formatMedia:null},this._reset(),this.adapterRef.encryption=new n.Encryption(this.adapterRef),e.debug&&(u.getParameters().debugG2=!0),this.adapterRef.testConf={},this.sdkRef=e.ref}_reset(){this.sdkRef=null,this.adapterRef={datareportCache:[],audioAsl:{enabled:"unknown",aslActiveNum:-1},channelInfo:{customData:"",sessionConfig:{}},userPriority:{priority:100,preemtiveMode:!1},proxyServer:{enable:!1,type:3},apiEvent:{},apiEvents:{},requestId:{},instance:this,logger:this.logger,_enableRts:!1},this.adapterRef.mediaCapability=new d.MediaCapability(this.adapterRef),this.adapterRef.encryption=new n.Encryption(this.adapterRef),this._resetState(),this.adapterRef.lbsManager=new R.LBSManager(this),this._destroyModule()}_getSupportedCodecs(){return _.getSupportedCodecs(...arguments)}initMode(){this.adapterRef._meetings||(this.adapterRef._meetings=new l.Meeting({sdkRef:this.sdkRef,adapterRef:this.adapterRef})),this.adapterRef._signalling||(this.adapterRef._signalling=new m.Signalling({adapterRef:this.adapterRef,logger:this.logger})),this.adapterRef._mediasoup||(this.adapterRef._mediasoup=new c.Mediasoup({adapterRef:this.adapterRef,logger:this.logger})),this.adapterRef._statsReport||(this.adapterRef._statsReport=new p.StatsReport({sdkRef:this.sdkRef,adapterRef:this.adapterRef}),this.adapterRef._statsReport.start(),this.adapterRef._statsReport.startHeartbeat())}_destroyModule(){this.adapterRef._meetings&&(this.adapterRef._meetings.destroy(),this.adapterRef._meetings=null),this.adapterRef._signalling&&(this.adapterRef._signalling.destroy(),this.adapterRef._signalling=null),this.adapterRef._rtsTransport&&(this.adapterRef._rtsTransport.destroy(),this.adapterRef._rtsTransport=null),this.adapterRef._mediasoup&&(this.adapterRef._mediasoup.destroy(),this.adapterRef._mediasoup=null),this.adapterRef._statsReport&&(this.adapterRef._statsReport.destroy(),this.adapterRef._statsReport=null),this.recordManager.formatMedia&&(this.recordManager.formatMedia.destroy(),this.recordManager.formatMedia=null),this.recordManager.record&&(this.recordManager.record.destroy(),this.recordManager.record=null)}_resetState(){this._params.neRtcServerAddresses={},this.adapterRef.channelStatus="init",this.adapterRef.connectState={prevState:"DISCONNECTED",curState:"DISCONNECTED",reconnect:!1},this.adapterRef.networkQuality={},this.adapterRef.localStream=null,this.adapterRef.memberMap={},this.adapterRef.remoteStreamMap={},this.adapterRef.netStatusList=[],this.adapterRef.netStatusTimer&&(clearInterval(this.adapterRef.netStatusTimer),this.adapterRef.netStatusTimer=null),this.adapterRef.uid2SscrList={},this.adapterRef.state={lastDeviceStatus:{audio:{type:null,device:null},video:{type:null,device:null}},audioDeviceHasOpened:!1,videoDeviceHasOpened:!1,chromeScreenShareOpened:!1,startSessionTime:0,endSessionTime:0,startPubVideoTime:0,startPubScreenTime:0},Object.assign(this.adapterRef,{transportStats:{NetworkType:"unknown",OutgoingAvailableBandwidth:0,txRtt:0,rxRtt:0},sessionStats:{Duration:0,RecvBitrate:0,RecvBytes:0,SendBitrate:0,SendBytes:0,UserCount:0},localAudioStats:[],localAudioSlaveStats:[],localVideoStats:[],localScreenStats:[],remoteAudioStats:{},remoteAudioSlaveStats:{},remoteVideoStats:{},remoteScreenStats:{}})}setSessionConfig(e={}){this.adapterRef.channelInfo||(this.adapterRef.channelInfo={}),this.adapterRef.channelInfo.sessionConfig||(this.adapterRef.channelInfo.sessionConfig={}),this.adapterRef.channelInfo.sessionConfig=Object.assign(this.adapterRef.channelInfo.sessionConfig,e)}resetChannel(){this.adapterRef.networkQuality={},this.adapterRef.netStatusList=[];for(let e in this.adapterRef.remoteStreamMap){const t=this.adapterRef.remoteStreamMap[e];t.active&&(t.active=!1,t.stop(),t.clearRemotePubStatus(),this.adapterRef.instance.safeEmit("peer-leave",{uid:e}))}this.adapterRef.memberMap={},this.adapterRef.uid2SscrList={},this.adapterRef._mediasoup&&this.adapterRef._mediasoup.destroy()}async startSession(e=0){0===e?this.logger.log("开始音视频会话"):this.logger.log(`开始音视频会话：第${e}次`);let{wssArr:t,cid:i}=this.adapterRef.channelInfo;if(!t||0===t.length){this.logger.error("没有找到服务器地址: "+JSON.stringify(this.adapterRef.channelInfo)),this.adapterRef.channelStatus="leave";let e="startSession: server address is not found: "+JSON.stringify(this.adapterRef.channelInfo),t="startSession: 没有找到服务器地址: "+JSON.stringify(this.adapterRef.channelInfo),i="Please contact CommsEase technical support",r="请联系云信技术支持",s=T.IS_ZH?t:e,a=T.IS_ZH?r:i;throw new g.default({code:f.default.UNKNOWN,message:s,advice:a})}if(!i){this.logger.error("服务器没有分配cid"),this.adapterRef.channelStatus="leave";let e="startSession: no cid assigned by server",t="startSession: 服务器没有分配cid",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=T.IS_ZH?t:e,a=T.IS_ZH?r:i;throw new g.default({code:f.default.UNKNOWN,message:s,advice:a})}if(this.logger.log(`开始连接服务器: ${this.adapterRef.channelInfo.wssArrIndex}, url: ${t[this.adapterRef.channelInfo.wssArrIndex]}`),this.adapterRef.channelInfo.wssArrIndex>=t.length){this.logger.error("所有的服务器地址都连接失败"),this.adapterRef.channelInfo.wssArrIndex=0,this.adapterRef.channelStatus="leave";let e="startSession: All server addresses failed to connect",t="startSession: 所有的服务器地址都连接失败",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=T.IS_ZH?t:e,a=T.IS_ZH?r:i;throw new g.default({code:f.default.NETWORK_ERROR,message:s,advice:a})}t[this.adapterRef.channelInfo.wssArrIndex];if(!this.adapterRef._signalling){let e="startSession: signalling server error",t="startSession: 信令服务器异常",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=T.IS_ZH?t:e,a=T.IS_ZH?r:i;throw new g.default({code:f.default.SIGNALLING_SERVER_ERROR,message:s,advice:a})}try{await this.adapterRef._signalling.init(!1,!1)}catch(e){throw this.adapterRef.channelStatus="leave",e}const r=t[this.adapterRef.channelInfo.wssArrIndex];if(t.splice(this.adapterRef.channelInfo.wssArrIndex,1),t.unshift(r),this.adapterRef.channelInfo.wssArrIndex=0,!this.adapterRef._statsReport){let e="startSession: no format stats",t="startSession: 没有 format 数据",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=T.IS_ZH?t:e,a=T.IS_ZH?r:i;throw new g.default({code:f.default.NO_STATS_ERROR,message:s,advice:a})}this.adapterRef._statsReport.statsStart()}stopSession(){this.logger.log("开始清除音视频会话"),this._destroyModule();const e=u.getParameters().localStreams.filter(e=>e.client===this&&!e.destroyed);e.length&&(u.getParameters().keepLocalstreamOnLeave?this.logger.log("当前模式下离开频道不会销毁localStream"):(this.logger.log(`即将销毁${e.length}个localStream`),e.forEach(e=>{e.destroy()}))),Object.values(this.adapterRef.remoteStreamMap).forEach(e=>{e.destroy()}),this.adapterRef.remoteStreamMap={},this.adapterRef.memberMap={},this.adapterRef.uid2SscrList={},this._resetState()}async clearMember(e){var t;this.logger.log(e+"离开房间");const i=this.adapterRef.remoteStreamMap[e];if(null==i?void 0:i.active){const r=["audio","video","screen","audioSlave"];for(let e of r)i.pubStatus[e].producerId&&this.adapterRef.instance.safeEmit("stream-removed",{stream:i,mediaType:e,reason:"onPeerLeave"});delete this.adapterRef.remoteStreamMap[e],delete this.adapterRef.memberMap[e],delete this.adapterRef.remoteAudioStats[e],delete this.adapterRef.remoteAudioSlaveStats[e],delete this.adapterRef.remoteVideoStats[e],delete this.adapterRef.remoteScreenStats[e];for(let e of r)i.pubStatus[e].consumerId&&await(null===(t=this.adapterRef._mediasoup)||void 0===t?void 0:t.destroyConsumer(i.pubStatus[e].consumerId,i,e));i.active=!1,i.destroy();const s=this.adapterRef._statsReport&&this.adapterRef._statsReport.formativeStatsReport&&this.adapterRef._statsReport.formativeStatsReport.firstData.recvFirstData;s&&s[e]&&delete s[e]}this.adapterRef.netStatusList=this.adapterRef.netStatusList.filter((t,i,r)=>t.uid!==e),this.logger.log(e+" 离开房间 通知用户"),this.adapterRef._enableRts?this.adapterRef.instance.emit("rts-peer-leave",{uid:e}):this.adapterRef.instance.safeEmit("peer-leave",{uid:e})}setStartSessionTime(){this.adapterRef.state.startSessionTime=Date.now(),this.adapterRef.deviceId=y(this.adapterRef.channelInfo.cid+":"+this.adapterRef.channelInfo.uid+":"+this.adapterRef.state.startSessionTime)}setEndSessionTime(){if(!this.adapterRef.state.startSessionTime)return void this.logger.log("AbstractAdapter: setEndSessionTime: startSessionTime为空");this.adapterRef.state.endSessionTime=Date.now();const e=this.adapterRef.state.endSessionTime-this.adapterRef.state.startSessionTime;this.adapterRef.instance.safeEmit("@sessionDuration",e),this.adapterRef.state.startSessionTime=0,this.adapterRef.state.endSessionTime=0}async reBuildRecvTransport(){if(this.transportRebuildCnt++,this.transportRebuildCnt>=u.getParameters().maxTransportRebuildCnt)return void this.logger.error("reBuildRecvTransport 达到最大重连次数："+this.transportRebuildCnt);if(this.logger.warn("下行通道异常，重新建立 #"+this.transportRebuildCnt),!this.adapterRef._mediasoup){let e="reBuildRecvTransport:  media server error",t="reBuildRecvTransport: 媒体服务异常",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=T.IS_ZH?t:e,a=T.IS_ZH?r:i;throw new g.default({code:f.default.MEDIA_SERVER_ERROR,message:s,advice:a})}this.adapterRef.instance.safeEmit("@pairing-reBuildRecvTransport-start"),this.adapterRef._mediasoup._recvTransport&&(this.adapterRef._mediasoup._recvTransport.close(),this.adapterRef._mediasoup.getIceStatus("recv"),this.adapterRef._mediasoup._recvTransport=null),this.adapterRef._mediasoup.init(),this.logger.log("下行通道异常, remoteStreamMap",Object.keys(this.adapterRef.remoteStreamMap)),this.logger.log("this._eventQueue: ",this.adapterRef._mediasoup._eventQueue);let e=!1;for(const t in this.adapterRef.remoteStreamMap){const i=this.adapterRef.remoteStreamMap[t];if(i){i.pubStatus.audio.consumerStatus="init",i.pubStatus.video.consumerStatus="init",i.pubStatus.screen.consumerStatus="init",i.pubStatus.audio.consumerId="",i.pubStatus.video.consumerId="",i.pubStatus.screen.consumerId="",this.logger.log("重连逻辑订阅 start：",i.stringStreamID);try{await this.doSubscribe(i)}catch(t){this.logger.error("重连逻辑订阅 error: ",t,t.name,t.message),e=!0,this.adapterRef.instance.safeEmit("@pairing-reBuildRecvTransport-error");break}this.logger.log("重连逻辑订阅 over: ",i.stringStreamID)}}e||this.adapterRef.instance.safeEmit("@pairing-reBuildRecvTransport-success")}async rtsRequestKeyFrame(e){this.logger.log("请求关键帧: ",e.pubStatus.video.consumerId),this.adapterRef._signalling&&await this.adapterRef._signalling.rtsRequestKeyFrame(e.pubStatus.video.consumerId)}apiFrequencyControl(e){const{name:t,code:i,param:r}=e;if(!t)return;this.adapterRef.apiEvent[t]||(this.adapterRef.apiEvent[t]=[],this.adapterRef.apiEvents[t]=[],this.adapterRef.requestId[t]=0);let s=this.adapterRef.channelInfo.clientNtpTime-this.adapterRef.channelInfo.T4;s>0||(s=0);let a=Date.now()+s;if(a<=this.timeLast&&(a=this.timeLast+1),this.timeLast=a,this.adapterRef.apiEvent[t].length<10)this.adapterRef.apiEvent[t].push({cid:this.adapterRef.channelInfo&&this.adapterRef.channelInfo.cid,uid:this.adapterRef.channelInfo&&this.adapterRef.channelInfo.uid,code:i,name:t,time:a,param:r,request_id:this.adapterRef.requestId[t]++});else{if(!this.adapterRef.apiEvent||!this.adapterRef.apiEvent[t]||!this.adapterRef.apiEvent[t].length){let e="apiFrequencyControl: no apiEvent named "+t,i=`apiFrequencyControl: 未找到 name 为 ${t} 的 apiEvent`,r="Please contact CommsEase technical support",s="请联系云信技术支持",a=T.IS_ZH?i:e,o=T.IS_ZH?s:r;throw new g.default({code:f.default.EVENT_UPLOAD_ERROR,message:a,advice:o})}if(!this.adapterRef.apiEvent[t][0].time){let e="apiFrequencyControl: invalid time",t="apiFrequencyControl: 无效的 time",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=T.IS_ZH?t:e,a=T.IS_ZH?r:i;throw new g.default({code:f.default.EVENT_UPLOAD_ERROR,message:s,advice:a})}Date.now()-this.adapterRef.apiEvent[t][0].time<1e4?this.adapterRef.requestId[t]++:(this.adapterRef.apiEvents[t]=this.adapterRef.apiEvents[t].concat(this.adapterRef.apiEvent[t]),this.adapterRef.apiEvent[t]=[])}}apiEventReport(e,t){if(!e)return;let i=new h.DataReport({adapterRef:this.adapterRef,sdkRef:this.sdkRef});i[e](Object.assign({uid:""+this.adapterRef.channelInfo.uid,cid:""+this.adapterRef.channelInfo.cid,time:Date.now()},t)),this.adapterRef.channelInfo.cid&&this.adapterRef.channelInfo.uid?i.send():(this.adapterRef.datareportCache.push({func:e,datareport:i}),this.adapterRef.datareportCache.length>20&&this.adapterRef.datareportCache.shift())}getUidAndKindBySsrc(e){var t,i;const r=["audio","video","screen","audioSlave"],s=["high","low"];for(let a of r)for(let r of s)if((null===(i=null===(t=this.adapterRef._mediasoup)||void 0===t?void 0:t.senderEncodingParameter[a][r])||void 0===i?void 0:i.ssrc)===e)return{uid:0,kind:a,streamType:r};for(let t in this.adapterRef.uid2SscrList){if(this.adapterRef.uid2SscrList[t].audio.ssrc==e)return{uid:t,kind:"audio",streamType:"high"};if(this.adapterRef.uid2SscrList[t].audioSlave.ssrc==e)return{uid:t,kind:"audioSlave",streamType:"high"};if(this.adapterRef.uid2SscrList[t].video&&this.adapterRef.uid2SscrList[t].video.ssrc==e)return{uid:t,kind:"video",streamType:"high"};if(this.adapterRef.uid2SscrList[t].screen&&this.adapterRef.uid2SscrList[t].screen.ssrc==e)return{uid:t,kind:"screen",streamType:"high"}}return{uid:0,kind:"",streamType:"high"}}getSsrcByUidAndKind(e,t){return this.adapterRef.uid2SscrList[e]&&this.adapterRef.uid2SscrList[e][t]}addSsrc(e,t,i){this.adapterRef.uid2SscrList[e]||(this.adapterRef.uid2SscrList[e]={audio:{ssrc:0},audioSlave:{ssrc:0},video:{ssrc:0},screen:{ssrc:0}}),this.adapterRef.uid2SscrList[e][t]?this.adapterRef.uid2SscrList[e][t].ssrc=i:this.adapterRef.uid2SscrList[e][t]={ssrc:i}}removeSsrc(e,t){this.adapterRef.uid2SscrList[e]&&(t?this.adapterRef.uid2SscrList[e][t]&&(this.adapterRef.uid2SscrList[e][t].ssrc=0):delete this.adapterRef.uid2SscrList[e])}isPublished(e){return e&&this.adapterRef.localStream===e&&(e.audio&&e.pubStatus.audio.audio||e.video&&e.pubStatus.video.video||e.screen&&e.pubStatus.screen.screen)}getPeer(e){return this.adapterRef._mediasoup?"send"==e?this.adapterRef._mediasoup._sendTransport&&this.adapterRef._mediasoup._sendTransport.handler._pc:"recv"==e?this.adapterRef._mediasoup._recvTransport&&this.adapterRef._mediasoup._recvTransport.handler._pc:null:null}destroy(){this.logger.log("base: destroy!"),this._reset()}}t.Base=I},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.MediaCapability=void 0;const r=i(215),s=i(68),a=i(5);t.MediaCapability=class{constructor(e){this.logger=e.logger.getChild(()=>{let t="codec"+this.room.videoCodecType.join(",");return this.supportedCodecSend&&2===this.supportedCodecSend.length&&this.supportedCodecRecv&&2===this.supportedCodecRecv.length||(t+=`/${this.supportedCodecSend}/${this.supportedCodecRecv}`),e.mediaCapability!==this&&(t+=" DETACHED"),t}),this.supportedCodecRecv=null,this.supportedCodecSend=null,this.preferredCodecSend={video:["H264","VP8"],screen:["H264","VP8"]},this.room={videoCodecType:[]}}async detect(){const e=Date.now();let t=await s.getSupportedCodecs("recv")||{video:[],audio:["OPUS"]},i=await s.getSupportedCodecs("send")||{video:[],audio:["OPUS"]};if(a.getParameters().h264Wait){if(-1===t.video.indexOf("H264"))for(this.logger.warn(`当前浏览器不支持H264解码。这可能会触发频道内编码协商。最多等待 ${a.getParameters().h264Wait} 毫秒以避免编码器尚未加载。`);Date.now()-e<a.getParameters().h264Wait;){if(t=await s.getSupportedCodecs("recv")||{video:[],audio:["OPUS"]},-1!==t.video.indexOf("H264")){this.logger.log(`H264解码器加载完成！用时 ${Date.now()-e} 毫秒`);break}await new Promise(e=>{setTimeout(e,100)})}-1===t.video.indexOf("H264")&&this.logger.warn("H264解码器加载失败！")}this.supportedCodecRecv=t.video,this.supportedCodecSend=i.video,this.logger.log("detect supportedCodecRecv",JSON.stringify(this.supportedCodecRecv),"supportedCodecSend",JSON.stringify(this.supportedCodecSend),"Preferred codec:",JSON.stringify(this.preferredCodecSend))}getCodecCapability(){if(this.supportedCodecRecv&&this.supportedCodecSend){const e=[];for(let t of s.VideoCodecList)this.supportedCodecRecv.indexOf(t)>-1&&this.supportedCodecSend.indexOf(t)>-1&&e.push(t);return e}return this.logger.error("getCodecCapability: call detect first"),[]}stringify(){let e={256:[]};for(let t of this.getCodecCapability())r.VideoCodecStr2Int[t]>-1?e[256].push(r.VideoCodecStr2Int[t]):this.logger.error("MediaCapability:Unknown VideoCodecStr2Int",t);0===e[256].length&&this.logger.warn("MediaCapability:No Local Suitable codec available");return JSON.stringify(e)}getCodecSend(e,t){let i={codecName:null},r={codecName:null};for(let s=0;s<this.preferredCodecSend[e].length;s++){const a=this.preferredCodecSend[e][s];if(t.codecs||!t.codecs.length)for(let e=0;e<t.codecs.length;e++){const s=t.codecs[e];s.mimeType&&s.mimeType.toLowerCase().indexOf(a.toLowerCase())>-1&&(this.room.videoCodecType.indexOf(a)>-1?i.codecName||(i={codecParam:s,codecName:a}):r.codecName||(r={codecParam:s,codecName:a}))}}return i.codecName?(this.logger.log("MediaCapability：发送的Codec为:",i.codecName,JSON.stringify(i.codecParam)),i):(this.logger.warn("MediaCapability：未找到合适的发送Codec。发送的Codec使用:",r.codecName,r.codecParam),r)}parseRoom(e){if(!e.mediaCapabilitySet)return;const t=JSON.parse(e.mediaCapabilitySet);if(t[256]){const i=this.room.videoCodecType;this.room.videoCodecType=[];for(const i of t[256]){let t=r.VideoCodecInt2Str[i];t?this.room.videoCodecType.push(t):this.logger.error("Unknown Video Codec Type",i,e)}i.length?this.logger.log("Room videoCodecType发生变更。new:",this.room.videoCodecType,"old:",i):this.logger.log("Room videoCodecType:",JSON.stringify(this.room.videoCodecType))}}}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.VideoCodecStr2Int=t.VideoCodecInt2Str=t.SignalChannelMode=void 0,function(e){e[e.CHANNEL_MODE_P2P=1]="CHANNEL_MODE_P2P",e[e.CHANNEL_MODE_MEETING=2]="CHANNEL_MODE_MEETING",e[e.CHANNEL_MODE_1V1=3]="CHANNEL_MODE_1V1"}(t.SignalChannelMode||(t.SignalChannelMode={}));t.VideoCodecStr2Int={H264:0,H265:1,VP8:2,NEVC:3};t.VideoCodecInt2Str={0:"H264",1:"H265",2:"VP8",3:"NEVC"}},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Mediasoup=void 0;const n=o(i(70)),d=i(13),c=o(i(11)),l=o(i(12)),u=a(i(2)),h=i(217),p=a(i(164)),m=i(5),f=i(233),g=i(2);class v extends d.EventEmitter{constructor(e){super(),this._consumers={},this._timeout=6e4,this._edgeRtpCapabilities=null,this._mediasoupDevice=null,this._sendTransportIceParameters=null,this._recvTransportIceParameters=null,this._audioSlaveProducer=null,this._audioSlaveProducerId=null,this._micProducer=null,this._micProducerId=null,this._webcamProducer=null,this._webcamProducerId=null,this._screenProducer=null,this._screenProducerId=null,this._webcamProducerCodec=null,this._screenProducerCodec=null,this._sendTransport=null,this._recvTransport=null,this._sendTransportTimeoutTimer=null,this._recvTransportTimeoutTimer=null,this._eventQueue=[],this._protoo=null,this.senderEncodingParameter={ssrcList:[],audio:{high:null,low:null},audioSlave:{high:null,low:null},video:{high:null,low:null},screen:{high:null,low:null}},this.unsupportedProducers={},this.iceStatusHistory={send:{promises:[],status:{ts:0,info:""}},recv:{promises:[],status:{ts:0,info:""}}},this.adapterRef=e.adapterRef,this.logger=e.logger,this.loggerSend=e.logger.getChild(()=>{var e;let t="MediaSend";if(this._sendTransport)if(null===(e=this._sendTransport._handler)||void 0===e?void 0:e._pc){const e=this._sendTransport._handler._pc;e.connectionState&&"connected"!==e.connectionState&&(t+=" "+e.connectionState),"stable"!==e.signalingState&&(t+=" "+e.signalingState)}else t+=" NOTRANSPORT";else t+=" UNINIT";return this.adapterRef._mediasoup!==this&&(t+=" DETACHED"),t}),this.loggerRecv=e.logger.getChild(()=>{var e;let t="MediaRecv";if(this._recvTransport)if(null===(e=this._recvTransport._handler)||void 0===e?void 0:e._pc){const e=this._recvTransport._handler._pc;e.connectionState&&"connected"!==e.connectionState&&(t+=" "+e.connectionState),"stable"!==e.signalingState&&(t+=" "+e.signalingState)}else t+=" NOTRANSPORT";else t+=" UNINIT";return this.adapterRef._mediasoup!==this&&(t+=" DETACHED"),t}),this._reset()}get consumers(){return this._consumers}_reset(){this._edgeRtpCapabilities=null,this._mediasoupDevice=null,this._sendTransportIceParameters=null,this._recvTransportIceParameters=null,this._micProducer=null,this._audioSlaveProducer=null,this._micProducerId=null,this._webcamProducer=null,this._webcamProducerId=null,this._screenProducer=null,this._screenProducerId=null,this._consumers={},this._sendTransportTimeoutTimer&&clearTimeout(this._sendTransportTimeoutTimer),this._sendTransportTimeoutTimer=null,this._recvTransportTimeoutTimer&&clearTimeout(this._recvTransportTimeoutTimer),this._recvTransportTimeoutTimer=null,this._sendTransport&&(this._sendTransport.close(),this.getIceStatus("send")),this._sendTransport=null,this._recvTransport&&(this._recvTransport.close(),this.getIceStatus("recv")),this._recvTransport=null,this.resetConsumeRequestStatus()}async init(){if(this.logger.log("init() 初始化 devices、transport"),this.adapterRef._enableRts)return;this._mediasoupDevice||(this._mediasoupDevice=new p.Device,this._mediasoupDevice&&await this._mediasoupDevice.load({routerRtpCapabilities:this._edgeRtpCapabilities}));let e=[],t="all";if(this.adapterRef.channelInfo.relaytoken&&this.adapterRef.channelInfo.relayaddrs&&(this.adapterRef.channelInfo.relayaddrs.forEach(t=>{e.push({urls:"turn:"+t+"?transport=udp",credential:this.adapterRef.proxyServer.credential||this.adapterRef.channelInfo.uid+"/"+this.adapterRef.channelInfo.cid,username:this.adapterRef.channelInfo.relaytoken},{urls:"turn:"+t+"?transport=tcp",credential:this.adapterRef.proxyServer.credential||this.adapterRef.channelInfo.uid+"/"+this.adapterRef.channelInfo.cid,username:this.adapterRef.channelInfo.relaytoken})}),u.IS_FIREFOX||(t="relay")),this.adapterRef.testConf.turnAddr&&(e.length=0,e.push({urls:this.adapterRef.testConf.turnAddr,credential:this.adapterRef.channelInfo.uid+"/"+this.adapterRef.channelInfo.cid,username:this.adapterRef.testConf.relaytoken||"123456"}),t="relay"),this.adapterRef.testConf.iceServers&&(e=this.adapterRef.testConf.iceServers,t=this.adapterRef.testConf.iceTransportPolicy||"relay"),e.length&&this.logger.log("iceTransportPolicy ",t," iceServers ",JSON.stringify(e)),!this._sendTransport&&this._mediasoupDevice&&(this._sendTransport=this._mediasoupDevice.createSendTransport({id:this.adapterRef.channelInfo.uid,iceParameters:void 0,iceCandidates:void 0,dtlsParameters:void 0,sctpParameters:void 0,iceServers:e,appData:{cid:this.adapterRef.channelInfo.cid,uid:this.adapterRef.channelInfo.uid,encodedInsertableStreams:this.adapterRef.encryption.encodedInsertableStreams}}),this.senderEncodingParameter={ssrcList:[],audioSlave:{high:null,low:null},audio:{high:null,low:null},video:{high:null,low:null},screen:{high:null,low:null}},this._sendTransport.on("connectionstatechange",this._sendTransportConnectionstatechange.bind(this,this._sendTransport)),this._sendTransport.handler._pc.addEventListener("iceconnectionstatechange",()=>{this.getIceStatus("send")})),!this._recvTransport){const i=this._mediasoupDevice.createRecvTransport({id:this.adapterRef.channelInfo.uid,iceParameters:void 0,iceCandidates:void 0,dtlsParameters:void 0,sctpParameters:void 0,iceServers:e,iceTransportPolicy:t,appData:{cid:this.adapterRef.channelInfo.cid,uid:this.adapterRef.channelInfo.uid,encodedInsertableStreams:this.adapterRef.encryption.encodedInsertableStreams}});this._recvTransport=i,i.on("connectionstatechange",this._recvTransportConnectionstatechange.bind(this,i)),i.handler._pc.addEventListener("iceconnectionstatechange",()=>{this.getIceStatus("recv")})}let i=setInterval(()=>{const e=Date.now();e-this.iceStatusHistory.send.status.ts>1500&&this.getIceStatus("send"),e-this.iceStatusHistory.recv.status.ts>1500&&this.getIceStatus("recv"),this._mediasoupDevice||clearInterval(i)},1e3);this.emit("transportReady")}async _sendTransportConnectionstatechange(e,t){if(this._sendTransport===e)if(this.loggerSend.log(`send connection #${e._handler._pc.pcid} state  changed to ${t}`),this.emit("upstream-state-change",{connectionState:t}),"failed"===t)try{this._sendTransport&&(this._sendTransportTimeoutTimer||(this._sendTransportTimeoutTimer=setTimeout(()=>{this._reconnectTransportConnectTimeout()},this._timeout))),this._sendTransportConnectTimeout()}catch(e){this.loggerSend.error("reconnectSendTransportConnect() | failed:",e.name,e.message)}else"connected"===t&&this._sendTransportTimeoutTimer&&(clearTimeout(this._sendTransportTimeoutTimer),this._sendTransportTimeoutTimer=null);else this.loggerSend.error("_sendTransportConnectionstatechange：出现了_sendTransport绑定不一致的状况。")}async _recvTransportConnectionstatechange(e,t){if(this._recvTransport===e)if(this.loggerRecv.log(`recv connection ${e._handler._pc.pcid} state changed to ${t}`),this.emit("downstream-state-change",{connectionState:t}),"failed"===t){try{this._recvTransport&&(this._recvTransportTimeoutTimer||(this._recvTransportTimeoutTimer=setTimeout(()=>{this._reconnectTransportConnectTimeout()},this._timeout)))}catch(e){this.loggerRecv.error("reconnectRecvTransportConnect() | failed:",e.name,e.message)}this._recvTransportConnectTimeout()}else"connected"===t&&this._recvTransportTimeoutTimer&&(clearTimeout(this._recvTransportTimeoutTimer),this._recvTransportTimeoutTimer=null);else this.loggerRecv.error("_recvTransportConnectionstatechange：出现了_recvTransport绑定不一致的状况。")}async _sendTransportConnectTimeout(){this.loggerSend.warn("媒体上行传输通道连接失败"),this.adapterRef._signalling&&("CONNECTED"===this.adapterRef.connectState.curState?(this.loggerSend.log("媒体上行传输通道连接失败，尝试整体重连"),this.adapterRef.channelStatus="connectioning",this.adapterRef._signalling.reconnectionControl.next=this.adapterRef._signalling.reconnectionControl.copynext,this.adapterRef.instance.apiEventReport("setDisconnect",{reason:"send peer ice failed"}),this.adapterRef._signalling._reconnection()):(this.loggerRecv.warn("媒体上行传输通道建立失败，此时sdk正在重连，不用特殊处理"),this.adapterRef.instance.apiEventReport("setStreamException",{name:"pushStreamException",value:"send transport connection failed"})))}async _recvTransportConnectTimeout(){this.loggerRecv.warn("媒体下行传输通道建立失败"),this.adapterRef._signalling&&("CONNECTED"===this.adapterRef.connectState.curState?(this.loggerRecv.error("媒体下行传输通道连接失败，尝试整体重连"),this.adapterRef.channelStatus="connectioning",this.adapterRef._signalling.reconnectionControl.next=this.adapterRef._signalling.reconnectionControl.copynext,this.adapterRef.instance.apiEventReport("setDisconnect",{reason:"recv peer ice failed"}),this.adapterRef._signalling._reconnection()):(this.loggerRecv.warn("媒体下行传输通道建立失败，此时sdk正在重连，不用特殊处理"),this.adapterRef.instance.apiEventReport("setStreamException",{name:"pullStreamException",value:"receive transport connection failed"})))}async _reconnectTransportConnectTimeout(){this.loggerRecv.error("媒体传输通道一直重连失败，主动退出房间"),this.adapterRef.instance.safeEmit("error","MEDIA_TRANSPORT_DISCONNECT"),this.adapterRef.instance.leave()}async createProduce(e,t){var i,r,s,a,o,n;if(e.logger.log("发布音视频: ",e.getId(),t),!this._sendTransport){let e="createProduce: send transport is not found 1",t="createProduce: 发送端 transport 未找到 1",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=u.IS_ZH?t:e,a=u.IS_ZH?r:i;throw new l.default({code:c.default.NOT_FOUND_ERROR,message:s,advice:a})}if(0===this._sendTransport.listenerCount("produce")&&this._sendTransport.on("produce",async({kind:e,rtpParameters:t,appData:i,localDtlsParameters:r,offer:s},a,o)=>{if(this.loggerSend.log(`produce 反馈 [kind= ${e}, appData= ${JSON.stringify(i)}]`),!this._sendTransport){let e="createProduce: send transport is not found 2",t="createProduce: 发送端 transport 未找到 2",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=u.IS_ZH?t:e,a=u.IS_ZH?r:i;throw new l.default({code:c.default.NOT_FOUND_ERROR,message:s,advice:a})}const n="screenShare"==i.mediaType?"screen":i.mediaType;let d=!1;("video"===n&&this.adapterRef.channelInfo.videoLow||"screen"===n&&this.adapterRef.channelInfo.screenLow)&&(d=!0);const h=s.sdp.match(/a=ice-ufrag:([0-9a-zA-Z#=+-_\/\\\\]+)/);h||(this.adapterRef.logger.error(s.sdp),this.adapterRef.logger.error("找不到 iceUfragRegLocal"));try{let o=Object.assign({requestId:""+Math.ceil(1e9*Math.random()),kind:e,rtpParameters:t,iceUfrag:h[1],externData:{producerInfo:{mediaType:"audioSlave"===i.mediaType?"subAudio":i.mediaType,subStream:"screenShare"===i.mediaType||"audioSlave"===i.mediaType,simulcastEnable:d,spatialLayerCount:d?2:1,mute:!1}},appData:{enableTcpCandidate:!0}},i),p=this.senderEncodingParameter[n].high,f=this.senderEncodingParameter[n].low,g=s.sdp.indexOf(i.deviceId),v=s.sdp.indexOf(i.deviceIdLow);if(!p){if(t.encodings&&(p=t.encodings[0],p&&this.senderEncodingParameter.ssrcList.indexOf(p.ssrc)>-1&&(p=null),t.encodings[1]&&(f=t.encodings[1],f&&this.senderEncodingParameter.ssrcList.indexOf(f.ssrc)>-1&&(p=null))),!p&&i.deviceId&&g>-1){const e=s.sdp.substring(g).match(/a=ssrc-group:FID (\d+) (\d+)/);if(e&&(p={ssrc:parseInt(e[1]),rtx:{ssrc:parseInt(e[2])}}),p&&this.senderEncodingParameter.ssrcList.indexOf(p.ssrc)>-1&&(p=null),!f&&i.deviceIdLow&&v>-1){const e=s.sdp.substring(v).match(/a=ssrc-group:FID (\d+) (\d+)/);e&&(f={ssrc:parseInt(e[1]),rtx:{ssrc:parseInt(e[2])}}),f&&this.senderEncodingParameter.ssrcList.indexOf(f.ssrc)>-1&&(f=null)}}p||(this.loggerSend.log("使用sdp中第一个ssrc"),p={ssrc:parseInt(s.sdp.match(/a=ssrc:(\d+)/)[1]),dtx:!1}),this.senderEncodingParameter[n].high=p,this.senderEncodingParameter.ssrcList.push(p.ssrc),f?(this.senderEncodingParameter[n].low=f,this.senderEncodingParameter.ssrcList.push(f.ssrc)):this.senderEncodingParameter[n].low=null}t.encodings=[this.senderEncodingParameter[n].high],this.senderEncodingParameter[n].low&&t.encodings.unshift(this.senderEncodingParameter[n].low),"video"!==i.mediaType&&"screenShare"!==i.mediaType||(o.mediaProfile=[],f&&o.mediaProfile.push({ssrc:f.ssrc,res:"160*160",fps:"1",spatialLayer:0,maxBitrate:100}),o.mediaProfile.push({ssrc:p.ssrc,res:"640*480",fps:"15",spatialLayer:o.mediaProfile.length,maxBitrate:1e3}));for(let e=o.rtpParameters.codecs.length-1;e>=0;e--)"audio/red"===o.rtpParameters.codecs[e].mimeType&&o.rtpParameters.codecs.splice(e,1);if(void 0===r?o.transportId=this._sendTransport.id:o.dtlsParameters=r,!this.adapterRef._signalling||!this.adapterRef._signalling._protoo){let e="createProduce: _protoo is not found",t="createProduce: _protoo 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=u.IS_ZH?t:e,a=u.IS_ZH?r:i;throw new l.default({code:c.default.NOT_FOUND_ERROR,message:s,advice:a})}const{code:_,transportId:S,iceParameters:y,iceCandidates:R,turnParameters:b,dtlsParameters:T,producerId:w,errMsg:I}=await this.adapterRef._signalling._protoo.request("Produce",o);if(void 0!==S&&(this._sendTransport._id=S),this.loggerSend.log(`produce请求反馈结果, code: ${_}, kind: ${e}, producerId: ${w},  errMsg: ${I}`),b){let e=[];e.push({urls:"turn:"+b.ip+":"+b.port+"?transport=udp",credential:b.password,username:b.username},{urls:"turn:"+b.ip+":"+b.port+"?transport=tcp",credential:b.password,username:b.username}),await this._sendTransport.updateIceServers({iceServers:e})}let E={codecParam:null,codecName:null};if("audio"===i.mediaType?this._micProducerId=w:"audioSlave"===i.mediaType?this._audioSlaveProducerId=w:"video"===i.mediaType?(this._webcamProducerId=w,E=this.adapterRef.mediaCapability.getCodecSend("video",this._sendTransport.handler._sendingRtpParametersByKind.video),this._webcamProducerCodec=E.codecName):"screenShare"===i.mediaType&&(this._screenProducerId=w,E=this.adapterRef.mediaCapability.getCodecSend("screen",this._sendTransport.handler._sendingRtpParametersByKind.video),this._screenProducerCodec=E.codecName),y&&(this._sendTransportIceParameters=y),!this.adapterRef.localStream){let e="createProduce: localStream is not found",t="createProduce: 未找到 localStream",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=u.IS_ZH?t:e,a=u.IS_ZH?r:i;throw new l.default({code:c.default.LOCALSTREAM_NOT_FOUND_ERROR,message:s,advice:a})}let A=[];"audio"===i.mediaType||"audioSlave"===i.mediaType?A.push(Object.assign({},m.getParameters().codecOptions.audio)):"video"===i.mediaType?(t.encodings.length>=2&&A.push(Object.assign({},m.getParameters().codecOptions.video.low)),A.push(Object.assign({},m.getParameters().codecOptions.video.high))):"screenShare"===i.mediaType&&(t.encodings.length>=2&&A.push(Object.assign({},m.getParameters().codecOptions.screen.low)),A.push(Object.assign({},m.getParameters().codecOptions.screen.high))),this.logger.log(`codecOptions for producer ${i.mediaType}: ${JSON.stringify(A)}`);let C=R;this.adapterRef.channelInfo.iceProtocol&&R&&(this.logger.warn("Produce iceProtocol: ",this.adapterRef.channelInfo.iceProtocol),C=R.filter(e=>e.protocol==this.adapterRef.channelInfo.iceProtocol)),await this._sendTransport.fillRemoteRecvSdp({kind:e,appData:i,iceParameters:y,iceCandidates:C,dtlsParameters:T,sctpParameters:void 0,sendingRtpParameters:t,codecOptions:A,offer:s,codec:E.codecParam,audioProfile:this.adapterRef.localStream.audioProfile}),"video"!==n&&"screen"!==n||(this.adapterRef.localStream.applyEncoderConfig(n,"high"),t.encodings.length>=2&&this.adapterRef.localStream.applyEncoderConfig(n,"low")),a({id:w})}catch(e){o(e)}}),"audio"===t||"all"===t){if(this._micProducer)this.loggerSend.log("音频已经publish，跳过");else{const t=e.mediaHelper.audio.audioStream.getAudioTracks()[0];t&&(!1===(null===(i=this.adapterRef.permKeyInfo)||void 0===i?void 0:i.pubAudioRight)?(this.loggerSend.error("permKey权限控制你没有权利发布audio"),this.adapterRef.instance.safeEmit("error","no-publish-audio-permission")):(this.loggerSend.log("发布音频流 audioTrack: ",t.id,t.label),e.pubStatus.audio.audio=!0,this._micProducer=await this._sendTransport.produce({track:t,trackLow:null,codecOptions:{opusStereo:!0,opusDtx:!0},appData:{deviceId:t.id,deviceIdLow:null,mediaType:"audio"}}),this.watchProducerState(this._micProducer,"_micProducer"),this.adapterRef.encryption.encodedInsertableStreams&&this._micProducer._rtpSender&&this.enableSendTransform(this._micProducer._rtpSender,"audio","high")))}}if("audioSlave"===t||"all"===t)if(this._audioSlaveProducer)this.loggerSend.log("音频辅流已经publish，忽略");else{const t=e.mediaHelper.screenAudio.screenAudioStream.getAudioTracks()[0];t&&(!1===(null===(r=this.adapterRef.permKeyInfo)||void 0===r?void 0:r.pubAudioRight)?(this.loggerSend.error("permKey权限控制你没有权利发布audio slave"),this.adapterRef.instance.safeEmit("error","no-publish-audio-slave-permission")):(this.loggerSend.log("发布音频辅流 audioSlaveTrack: ",t.id,t.label),e.pubStatus.audioSlave.audio=!0,this._audioSlaveProducer=await this._sendTransport.produce({track:t,trackLow:null,codecOptions:{opusStereo:!0,opusDtx:!0},appData:{deviceId:t.id,deviceIdLow:null,mediaType:"audioSlave"}}),this.watchProducerState(this._audioSlaveProducer,"_audioSlaveProducer")))}if("video"===t||"all"===t){if(this._webcamProducer)this.loggerSend.log("视频已经publish，跳过");else if(e.mediaHelper.video.videoStream.getVideoTracks().length)if(!1===(null===(s=this.adapterRef.permKeyInfo)||void 0===s?void 0:s.pubVideoRight))this.loggerSend.error("permKey权限控制你没有权利发布video"),this.adapterRef.instance.safeEmit("error","no-publish-video-permission");else{let t=null;this.adapterRef.channelInfo.videoLow?(e.mediaHelper.video.low||(e.mediaHelper.video.low=new f.VideoTrackLow({logger:this.logger,mediaType:"video"})),t=e.mediaHelper.video.low.track):(e.mediaHelper.video.low&&e.mediaHelper.video.low.bindSender(null,null),this.senderEncodingParameter.video.low=null);const i=e.mediaHelper.video.videoStream.getVideoTracks()[0];this.loggerSend.log("发布视频 videoTrack: ",i.id,i.label),e.pubStatus.video.video=!0;const r=this.adapterRef.mediaCapability.getCodecSend("video",this._sendTransport.handler._sendingRtpParametersByKind.video);this._webcamProducer=await this._sendTransport.produce({track:i,trackLow:t,codec:r.codecParam,codecOptions:{videoGoogleStartBitrate:1e3},appData:{deviceId:i.id,deviceIdLow:(null==t?void 0:t.id)||null,mediaType:"video"}}),this._webcamProducer._rtpSender&&e.mediaHelper.video.low&&(e.mediaHelper.video.low.bindSender(this._webcamProducer._rtpSender,this._webcamProducer._rtpSenderLow||null),g.IS_SAFARI&&g.SAFARI_MAJOR_VERSION&&g.SAFARI_MAJOR_VERSION<14&&(null===(o=null===(a=e._play)||void 0===a?void 0:a.videoDom)||void 0===o?void 0:o.srcObject)&&(this.logger.log("尝试重置本地视图的SrcObject"),e._play.videoDom.srcObject=e._play.videoDom.srcObject)),this.watchProducerState(this._webcamProducer,"_webcamProducer"),this.adapterRef.encryption.encodedInsertableStreams&&(this._webcamProducer._rtpSender&&this.enableSendTransform(this._webcamProducer._rtpSender,"video","high"),this._webcamProducer._rtpSenderLow&&this.enableSendTransform(this._webcamProducer._rtpSenderLow,"video","low")),this.adapterRef.state.startPubVideoTime||(this.adapterRef.state.startPubVideoTime=Date.now())}}if("screen"===t||"all"===t){if(this._screenProducer)this.loggerSend.log("屏幕共享已经publish，跳过");else if(e.mediaHelper.screen.screenVideoStream.getVideoTracks().length)if(!1===(null===(n=this.adapterRef.permKeyInfo)||void 0===n?void 0:n.pubVideoRight))this.loggerSend.error("permKey权限控制你没有权利发布screen"),this.adapterRef.instance.safeEmit("error","no-publish-screen-permission");else{let t=null;this.adapterRef.channelInfo.screenLow?(e.mediaHelper.screen.low||(e.mediaHelper.screen.low=new f.VideoTrackLow({logger:e.logger,mediaType:"screen"})),t=e.mediaHelper.screen.low.track):(e.mediaHelper.screen.low&&e.mediaHelper.screen.low.bindSender(null,null),this.senderEncodingParameter.screen.low=null);const i=e.mediaHelper.screen.screenVideoStream.getVideoTracks()[0];this.loggerSend.log("发布屏幕共享 screenTrack: ",i.id,i.label),e.pubStatus.screen.screen=!0;const r=this.adapterRef.mediaCapability.getCodecSend("screen",this._sendTransport.handler._sendingRtpParametersByKind.video);this._screenProducer=await this._sendTransport.produce({track:i,trackLow:t,codec:r.codecParam,codecOptions:{videoGoogleStartBitrate:1e3},appData:{deviceId:i.id,deviceIdLow:(null==t?void 0:t.id)||null,mediaType:"screenShare"}}),this._screenProducer._rtpSender&&e.mediaHelper.screen.low&&e.mediaHelper.screen.low.bindSender(this._screenProducer._rtpSender,this._screenProducer._rtpSenderLow||null),this.watchProducerState(this._screenProducer,"_screenProducer"),this.adapterRef.encryption.encodedInsertableStreams&&(this._screenProducer._rtpSender&&this.enableSendTransform(this._screenProducer._rtpSender,"screen","high"),this._screenProducer._rtpSenderLow&&this.enableSendTransform(this._screenProducer._rtpSenderLow,"screen","low")),this.adapterRef.state.startPubScreenTime||(this.adapterRef.state.startPubScreenTime=Date.now())}}}enableSendTransform(e,t,i){var r;const s=null===(r=this._sendTransport)||void 0===r?void 0:r.send.find(t=>t.sender===e);if(s)if(s.encodedStreams)this.loggerRecv.log(`发送端自定义加密，复用之前的通道。 ${s.mediaType} ${s.streamType}`);else{const t=e.createEncodedStreams(),i=new TransformStream({transform:this.adapterRef.encryption.handleUpstreamTransform.bind(this.adapterRef.encryption,s)});t.readable.pipeThrough(i).pipeTo(t.writable),s.encodedStreams=t,s.transformStream=i,this.loggerRecv.log(`发送端自定义加密，成功启动。 ${s.mediaType} ${s.streamType}`)}else this.loggerRecv.error("未找到匹配的Sender",t,i)}enableRecvTransform(e,t,i){var r;const s=null===(r=this._recvTransport)||void 0===r?void 0:r.recv.find(t=>t.receiver===e);if(s)if(s.encodedStreams)this.loggerRecv.log(`接收端自定义解密，复用之前的通道。uid:${s.uid}, mediaType: ${s.mediaType}`);else{const t=e.createEncodedStreams(),i=new TransformStream({transform:this.adapterRef.encryption.handleDownstreamTransform.bind(this.adapterRef.encryption,s)});t.readable.pipeThrough(i).pipeTo(t.writable),s.encodedStreams=t,s.transformStream=i,this.loggerRecv.log(`接收端自定义解密，成功启动。uid:${s.uid}, mediaType: ${s.mediaType}`)}else this.loggerRecv.error("未找到匹配的Receiver",t,i)}watchProducerState(e,t){var i;if(null===(i=e.rtpSender)||void 0===i?void 0:i.transport){const i=e.rtpSender.transport;switch(i.state){case"failed":this.logger.error(`Producer state ${t} ${i.state}`);break;case"connected":case"new":case"connecting":default:this.logger.log(`Producer state ${t} ${i.state}`),e.rtpSender.transport.addEventListener("statechange",()=>{switch(i.state){case"failed":this.logger.error(`Producer state changed: ${t} ${i.state}`);break;case"connected":case"new":case"connecting":this.logger.log(`Producer state changed: ${t} ${i.state}`)}})}}else this.logger.log("Producer state: transport is null")}async destroyProduce(e){var t;let i=null,r=null;if("audio"===e){if(i=this._micProducer,r=this._micProducerId,this._micProducer=this._micProducerId=null,!this.adapterRef.localStream){let e="destroyProduce.audio: localStream is not found",t="destroyProduce.audio: 未找到 localStream",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=u.IS_ZH?t:e,a=u.IS_ZH?r:i;throw new l.default({code:c.default.LOCALSTREAM_NOT_FOUND_ERROR,message:s,advice:a})}this.adapterRef.localStream.pubStatus.audio.audio=!1}else if("audioSlave"===e){if(i=this._audioSlaveProducer,r=this._audioSlaveProducerId,this._audioSlaveProducer=this._audioSlaveProducerId=null,!this.adapterRef.localStream){let e="destroyProduce.audioSlave: localStream is not found",t="destroyProduce.audioSlave: 未找到 localStream",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=u.IS_ZH?t:e,a=u.IS_ZH?r:i;throw new l.default({code:c.default.LOCALSTREAM_NOT_FOUND_ERROR,message:s,advice:a})}this.adapterRef.localStream.pubStatus.audioSlave.audio=!1}else if("video"===e){if(i=this._webcamProducer,r=this._webcamProducerId,this._webcamProducer=this._webcamProducerId=null,!this.adapterRef.localStream){let e="destroyProduce.video: localStream is not found",t="destroyProduce.video: 未找到 localStream",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=u.IS_ZH?t:e,a=u.IS_ZH?r:i;throw new l.default({code:c.default.LOCALSTREAM_NOT_FOUND_ERROR,message:s,advice:a})}this.adapterRef.localStream.pubStatus.video.video=!1}else if("screen"===e){if(i=this._screenProducer,r=this._screenProducerId,this._screenProducer=this._screenProducerId=null,!this.adapterRef.localStream){let e="destroyProduce.screen: localStream is not found",t="destroyProduce.screen: 未找到 localStream",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=u.IS_ZH?t:e,a=u.IS_ZH?r:i;throw new l.default({code:c.default.LOCALSTREAM_NOT_FOUND_ERROR,message:s,advice:a})}this.adapterRef.localStream.pubStatus.screen.screen=!1}try{if(this.loggerSend.log(`停止发布 destroyProduce ${e} producerId=`,r),!i)return;i.close(),(null===(t=this.adapterRef._signalling)||void 0===t?void 0:t._protoo)?this.adapterRef._signalling._protoo.request("CloseProducer",{requestId:""+Math.ceil(1e9*Math.random()),producerId:r}).catch(e=>{this.logger.error("destroyProduce Failed:",e.name,e.stack,e)}):this.logger.warn("destroyProduce：当前信令中断，不发信令包",e,r)}catch(e){this.loggerSend.error("_destroyProducer() | failed:",e.name,e.message)}}async createConsumer(e,t,i,r,s=0){this.adapterRef.instance.safeEmit("@pairing-createConsumer-start");let a=!1;if(this._eventQueue.forEach(t=>{if(t.id===r)return this.loggerRecv.log(`[subscribe] 已经在订阅任务队列中，忽略该次请求, uid: ${e}, mediaType: ${i}, producerId: ${r}`),void(a=!0)}),!a)return new Promise((a,o)=>{this._eventQueue.push({uid:e,kind:t,id:r,mediaType:i,preferredSpatialLayer:s,resolve:a,reject:o}),this._eventQueue.length>1||(this.adapterRef._enableRts?this._createConsumerRts(this._eventQueue[0]):this._createConsumer(this._eventQueue[0]))})}async setConsumerPreferredLayer(e,t,i){if(!this.adapterRef._signalling||!this.adapterRef._signalling._protoo){let e="setConsumerPreferredLayer: _protoo is not found",t="setConsumerPreferredLayer: _protoo 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=u.IS_ZH?t:e,a=u.IS_ZH?r:i;throw new l.default({code:c.default.NOT_FOUND_ERROR,message:s,advice:a})}this.loggerSend.log("setConsumerPreferredLayer() [切换大小流]layer：",t,1===t?"大流":"小流",i);return await this.adapterRef._signalling._protoo.request("SetConsumerPreferredLayer",{requestId:""+Math.ceil(1e9*Math.random()),uid:e.streamID,producerId:e.pubStatus[i].producerId,consumerId:e.pubStatus[i].consumerId,spatialLayer:t})}async resetConsumeRequestStatus(){const e=this._eventQueue;this._eventQueue=[];for(let t=0;t<e.length;t++){const i=e[t];this.loggerRecv.log(`resetConsumeRequestStatus：uid ${i.uid}, uid ${i.uid}, kind ${i.kind}, id ${i.id}`),i.reject("resetConsumeRequestStatus")}}removeUselessConsumeRequest(e){const{producerId:t,uid:i}=e;if(t||i)for(let e=1;e<this._eventQueue.length;e++){const r=this._eventQueue[e];r.id!==t&&r.uid!==i||(this.loggerRecv.log(`removeUselessConsumeRequest：uid ${r.uid}, uid ${r.uid}, kind ${r.kind}, id ${r.id}`),this._eventQueue.splice(e,1),e++)}}checkConsumerList(e){return this._eventQueue.shift(),e.resolve(null),this.loggerRecv.log("查看事件队列, _eventQueue: ",this._eventQueue.length),this._eventQueue.forEach(e=>{this.loggerRecv.log(`consumerList, uid: ${e.uid}, kind: ${e.kind}, mediaType: ${e.mediaType}, id: ${e.id}`)}),this._eventQueue.length>0&&(this.adapterRef._enableRts?this._createConsumerRts(this._eventQueue[0]):this._createConsumer(this._eventQueue[0])),"checkConsumerList"}async _createConsumer(e){const{uid:t,kind:i,mediaType:r,id:s,preferredSpatialLayer:a=0}=e,o="screenShare"===r?"screen":r;if("audio"===o?this.loggerRecv.log(`[Subscribe] 开始订阅 ${t} 的 ${o} 媒体: ${s}`):this.loggerRecv.log(`[Subscribe] 开始订阅 ${t} 的 ${o} 媒体: ${s} preferredSpatialLayer: ${a} 大小流: `,1===a?"大流":"小流"),!s)return this.adapterRef.instance.safeEmit("@pairing-createConsumer-error"),this.checkConsumerList(e);if(this.unsupportedProducers[s])return this.loggerRecv.warn("[Subscribe] createConsumer: 跳过不支持的Producer",s,JSON.stringify(this.unsupportedProducers[s])),this.checkConsumerList(e);const d=this.adapterRef.remoteStreamMap[t];if(!d||!d.pubStatus[o][o]||!d.pubStatus[o].producerId)return this.adapterRef.instance.safeEmit("@pairing-createConsumer-skip"),this.checkConsumerList(e);if(d.pubStatus[o].consumerId){this.loggerRecv.log("[Subscribe] 已经订阅过");let t=!0;if(d.Play&&(t=await d.Play.isPlayStreamError(o)),t)return this.loggerRecv.log("[Subscribe] 当前播放正常，直接返回"),this.adapterRef.instance.safeEmit("@pairing-createConsumer-skip"),this.checkConsumerList(e);if("start"!==d.pubStatus[o].stopconsumerStatus){this.loggerRecv.log("[Subscribe] 先停止之前的订阅");try{if(d.pubStatus[o].stopconsumerStatus="start",!this.adapterRef._mediasoup){let e="_createConsumer:  media server error",t="_createConsumer: 媒体服务异常",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=u.IS_ZH?t:e,a=u.IS_ZH?r:i;throw new l.default({code:c.default.MEDIA_SERVER_ERROR,message:s,advice:a})}await this.destroyConsumer(d.pubStatus.audio.consumerId,null,null),this.adapterRef.instance.removeSsrc(d.getId(),o),d.pubStatus[o].consumerId="",d.stop(o),d.pubStatus[o].stopconsumerStatus="end"}catch(e){this.loggerRecv.error("[Subscribe] 停止之前的订阅出现错误: ",e.name,e.message)}}}let p=null;if("audio"!==o&&"audioSlave"!==o||(p={opusStereo:1}),this._mediasoupDevice&&this._mediasoupDevice.loaded||(this.loggerRecv.warn("[Subscribe] createConsumer：Waiting for Transport Ready"),await h.waitForEvent(this,"transportReady",3e3)),!this._recvTransport){this.adapterRef.instance.safeEmit("@pairing-createConsumer-error"),e.resolve(null);let t="_createConsumer: receive transport is not found",i="_createConsumer: 接收端 transport 未找到",r="Please contact CommsEase technical support",s="请联系云信技术支持",a=u.IS_ZH?i:t,o=u.IS_ZH?s:r;throw new l.default({code:c.default.NOT_FOUND_ERROR,message:a,advice:o})}this.loggerRecv.log(`[Subscribe] prepareLocalSdp [kind: ${i}, mediaTypeShort: ${o}, uid: ${t}]`),this._recvTransport.id===this.adapterRef.channelInfo.uid&&(this.loggerRecv.log("[Subscribe] transporth还没有协商，需要dtls消息"),this._recvTransport._handler._transportReady=!1);const f=await this._recvTransport.prepareLocalSdp(i,this._edgeRtpCapabilities,t);this.adapterRef&&"DISCONNECTING"!=this.adapterRef.connectState.curState&&"DISCONNECTED"!=this.adapterRef.connectState.curState||this.checkConsumerList(e),this.loggerRecv.log("[Subscribe] 获取本地sdp，mid =",f.mid);let{rtpCapabilities:g,offer:v,iceUfragReg:_}=f,S=f.mid;const y=f.dtlsParameters;S="number"==typeof S&&S<0?void 0:""+S;const R=v.sdp.match(/a=ice-ufrag:([0-9a-zA-Z=#+-_\/\\\\]+)/);if(!R){let e="_createConsumer: iceUfragRegRemote is null",t="_createConsumer: iceUfragRegRemote 为空",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=u.IS_ZH?t:e,a=u.IS_ZH?r:i;throw new l.default({code:c.default.SDP_ERROR,message:s,advice:a})}let b=t;"string"===this.adapterRef.channelInfo.uidType&&(b=new n.default(b));let T={requestId:""+Math.ceil(1e9*Math.random()),kind:i,rtpCapabilities:g,uid:b,producerId:s,preferredSpatialLayer:a,mid:S,pause:!1,iceUfrag:R[1],audioAslFlag:"yes"===this.adapterRef.audioAsl.enabled&&m.getParameters().audioAslFlag,appData:{enableTcpCandidate:!0}};if(this.adapterRef.instance.apiEventReport("setFunction",{name:"set_video_sub",oper:"1",value:JSON.stringify(a)}),void 0===y?T.transportId=this._recvTransport.id:T.dtlsParameters=y,this.loggerRecv.log(`[Subscribe] 发送consume请求, uid: ${t}, kind: ${i}, mediaTypeShort: ${o}, producerId: ${T.producerId}, transportId: ${T.transportId}, requestId: ${T.requestId}`),!this.adapterRef._signalling||!this.adapterRef._signalling._protoo){e.resolve(null);let t="_createConsumer: _protoo is not found",i="_createConsumer: _protoo 未找到",r="Please contact CommsEase technical support",s="请联系云信技术支持",a=u.IS_ZH?i:t,o=u.IS_ZH?s:r;throw new l.default({code:c.default.NOT_FOUND_ERROR,message:a,advice:o})}this._recvTransport.handler._pc;const w=this.adapterRef._signalling._protoo;let I=null;try{I=await this.adapterRef._signalling._protoo.request("Consume",T)}catch(e){"request timeout"===e.message&&this.adapterRef._signalling._protoo===w?(this.logger.error(`[Subscribe] Consume消息Timeout，尝试信令重连：${e.name}/${e.message}。当前的连接状态：${this.adapterRef.connectState.curState}。原始请求：`,JSON.stringify(T)),this.adapterRef.channelStatus="connectioning",this.adapterRef.instance.apiEventReport("setDisconnect",{reason:"consumeRequestTimeout"}),this.adapterRef._signalling._reconnection()):this.logger.error(`[Subscribe] Consume消息错误：${e.name}/${e.message}。当前的连接状态：${this.adapterRef.connectState.curState}。原始请求：`,JSON.stringify(T));let t="_createConsumer: "+e.message,i="_createConsumer: Consume 消息错误:"+e.message,r="Please contact CommsEase technical support",s="请联系云信技术支持",a=u.IS_ZH?i:t,o=u.IS_ZH?s:r;throw new l.default({code:c.default.UNKNOWN_TYPE_ERROR,message:a,advice:o})}let{transportId:E,iceParameters:A,iceCandidates:C,dtlsParameters:P,probeSSrc:k,rtpParameters:O,turnParameters:x,producerId:D,consumerId:M,code:N,errMsg:L}=I;if(this.loggerRecv.log(`[Subscribe] consume反馈结果 code: ${N} uid: ${t}, mid: ${O&&O.mid}, kind: ${i}, producerId: ${D}, consumerId: ${M}, transportId: ${E}, requestId: ${I.requestId}, errMsg: ${L}`),x){let e=[];e.push({urls:"turn:"+x.ip+":"+x.port+"?transport=udp",credential:x.password,username:x.username},{urls:"turn:"+x.ip+":"+x.port+"?transport=tcp",credential:x.password,username:x.username}),await this._recvTransport.updateIceServers({iceServers:e})}if(!this._recvTransport)return this.loggerRecv.error("[Subscribe] transport undefined，直接返回"),this.checkConsumerList(e);try{const r=I.uid;O&&O.encodings&&O.encodings.length&&O.encodings[0].ssrc&&this.adapterRef.instance.addSsrc(t,o,O.encodings[0].ssrc),void 0!==E&&(this._recvTransport._id=E),void 0!==k&&(this._probeSSrc=k),A&&(this._recvTransportIceParameters=A),O&&null!=O.mid&&(O.mid=O.mid+"");let a=C;this.adapterRef.channelInfo.iceProtocol&&C&&(this.logger.warn("Consume iceProtocol: ",this.adapterRef.channelInfo.iceProtocol),a=C.filter(e=>e.protocol==this.adapterRef.channelInfo.iceProtocol));const n=await this._recvTransport.consume({id:M||D||s,producerId:D||s,kind:i,mediaType:o,uid:t||r,rtpParameters:O,codecOptions:p,appData:{peerId:r,remoteUid:t,mid:S},offer:v,iceParameters:A,iceCandidates:a,dtlsParameters:P,sctpParameters:void 0,probeSSrc:this._probeSSrc});if(this.adapterRef.encryption.encodedInsertableStreams&&n.rtpReceiver&&this.enableRecvTransform(n.rtpReceiver,t,o),this._consumers[n.id]=n,n.on("transportclose",()=>{this._consumers&&delete this._consumers[n.id]}),this.loggerRecv.log("[Subscribe] 订阅consume完成 peerId =",r),d&&d.pubStatus[o].producerId){if(d.subStatus[o]=!0,d.pubStatus[o][o]=!0,d.pubStatus[o].consumerId=M,d.pubStatus[o].producerId=D,d.getMuteStatus(o).muted){this.loggerRecv.log(`[Subscribe] 远端流处于mute状态：uid ${d.getId()}, ${o}, ${JSON.stringify(d.getMuteStatus(o))}`);const e=d.getMuteStatus(o);e.send&&this.loggerRecv.log(`[Subscribe] 远端流把自己mute了：uid ${d.getId()}, ${o}, ${JSON.stringify(e)}`),e.recv&&(this.loggerRecv.log(`[Subscribe] 本端把远端流mute了：uid ${d.getId()}, ${o}, ${JSON.stringify(e)}`),n.track.enabled=!1)}else n.track.enabled=!0;if(!d.mediaHelper){let e="_createConsumer: media helper is unavailable",t="_createConsumer: media helper 不可用",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=u.IS_ZH?t:e,a=u.IS_ZH?r:i;throw new l.default({code:c.default.UNAVAILABLE_ERROR,message:s,advice:a})}d.mediaHelper.updateStream(o,n.track),this.adapterRef.instance.safeEmit("@pairing-createConsumer-success"),this.adapterRef.instance.safeEmit("stream-subscribed",{stream:d,mediaType:o})}else this.adapterRef.instance.safeEmit("@pairing-createConsumer-error"),this.loggerRecv.log("[Subscribe] 该次consume状态错误： ",JSON.stringify(d.pubStatus,null,""));return this.checkConsumerList(e)}catch(r){return this.adapterRef&&this.loggerRecv.error(`订阅 ${t} 的 ${i} 媒体失败, error.name: ${r.name}, error.message: ${r.message}`),"peer closed"===r.name?(this.loggerRecv.log("[Subscribe] 订阅 ${uid} 的 ${kind} 媒体失败，信令通道已经销毁，忽略改成请求"),this.checkConsumerList(e)):(this.loggerRecv.error(`[Subscribe] 订阅 ${t} 的 ${i} 媒体失败，做容错处理: 重新建立下行连接`),this.resetConsumeRequestStatus(),this._recvTransport&&await this.closeTransport(this._recvTransport),this.adapterRef.instance.reBuildRecvTransport(),this.checkConsumerList(e))}}async _createConsumerRts(e){const{uid:t,kind:i,id:r,mediaType:s,preferredSpatialLayer:a=0}=e,o="screenShare"===s?"screen":s;if(this.loggerRecv.log(`开始订阅 ${t} 的 ${o} 媒体: ${r} 大小流: ${a}`),!this.adapterRef._rtsTransport){let e="_createConsumerRts: _rtsTransport is not found",t="_createConsumerRts: _rtsTransport 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=u.IS_ZH?t:e,a=u.IS_ZH?r:i;throw new l.default({code:c.default.NOT_FOUND_ERROR,message:s,advice:a})}if(!(this.adapterRef._signalling&&this.adapterRef._signalling._protoo&&this.adapterRef._signalling._protoo.request)){let e="_createConsumerRts: _protoo is not found 1",t="_createConsumerRts: _protoo 未找到 1",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=u.IS_ZH?t:e,a=u.IS_ZH?r:i;throw new l.default({code:c.default.NOT_FOUND_ERROR,message:s,advice:a})}if("audio"!==o&&"video"!==o&&"screen"!==o){let e="_createConsumerRts: mediaType type is unknown",t="_createConsumerRts: mediaType 参数类型非法",i="please make sure the parameter(mediaType) is correct",r="请输入正确的参数类型",s=u.IS_ZH?t:e,a=u.IS_ZH?r:i;throw new l.default({code:c.default.UNKNOWN_TYPE_ERROR,message:s,advice:a})}if(!r)return this.adapterRef.instance.safeEmit("@pairing-createConsumer-error"),this.checkConsumerList(e);let n=this.adapterRef.remoteStreamMap[t];if(!n||!n.pubStatus[o][o]||!n.pubStatus[o].producerId)return this.adapterRef.instance.safeEmit("@pairing-createConsumer-error"),this.checkConsumerList(e);if(n.pubStatus[o].consumerId)return this.loggerRecv.log("已经订阅过，返回"),this.adapterRef.instance.safeEmit("@pairing-createConsumer-skip"),this.checkConsumerList(e);const d={requestId:""+Math.ceil(1e9*Math.random()),transportId:this.adapterRef._rtsTransport.transportId,uid:t,producerId:r,preferredSpatialLayer:a,pause:!1,rtsCapabilities:{codecs:[{kind:o,codec:"video"==o||"screen"==o?"h264":"opus",payloadType:"video"==o||"screen"==o?2:1}]}};if(this.adapterRef.instance.apiEventReport("setFunction",{name:"set_video_sub",oper:"1",value:JSON.stringify(a)}),this.loggerRecv.log("发送consume请求 =",JSON.stringify(d)),!this.adapterRef._signalling||!this.adapterRef._signalling._protoo){e.resolve(null);let t="_createConsumerRts: _protoo is not found 2",i="_createConsumerRts: _protoo 未找到 2",r="Please contact CommsEase technical support",s="请联系云信技术支持",a=u.IS_ZH?i:t,o=u.IS_ZH?s:r;throw new l.default({code:c.default.NOT_FOUND_ERROR,message:a,advice:o})}const h=await this.adapterRef._signalling._protoo.request("WsConsume",d);this.loggerRecv.log("consume反馈结果 =",JSON.stringify(h));let{transportId:p,rtpParameters:m,producerId:f,consumerId:g,code:v,errMsg:_}=h;try{const r=h.uid;return 200===v&&this.adapterRef.remoteStreamMap[t]?(this._consumers[g]={producerId:f,close:function(){return Promise.resolve()}},this.loggerRecv.log("订阅consume完成 peerId =",r),n=this.adapterRef.remoteStreamMap[t],n&&n.pubStatus[o].producerId?(n.subStatus[o]=!0,n.pubStatus[o][o]=!0,n.pubStatus[o].consumerId=g,n.pubStatus[o].producerId=f,this.adapterRef.instance.safeEmit("@pairing-createConsumer-success")):(this.loggerRecv.log("该次consume状态错误： ",JSON.stringify(n.pubStatus,null,"")),this.adapterRef.instance.safeEmit("@pairing-createConsumer-error")),this.checkConsumerList(e)):(this.loggerRecv.error(`订阅 ${t} 的 ${i} 媒体失败, errcode: ${v}, reason: ${_} ，做容错处理: 重新建立下行连接`),this._eventQueue.length=0,void(this._recvTransport=null))}catch(e){return this.adapterRef&&this.loggerRecv.error('"newConsumer" request failed:',e.name,e.message,e),this.loggerRecv.error(`订阅 ${t} 的 ${o} 媒体失败，做容错处理: 重新建立下行连接`),this.adapterRef.instance.reBuildRecvTransport()}}async destroyConsumer(e,t,i){var r,s;if(e)try{const a=this._consumers[e];if(!a)return void this.loggerRecv.log("跳过停止订阅 destroyConsumer consumerId=",e,null==t?void 0:t.streamID);this.loggerRecv.log("停止订阅 destroyConsumer consumerId=",e,null==t?void 0:t.streamID),delete this._consumers[e];try{await(null===(s=null===(r=this.adapterRef._signalling)||void 0===r?void 0:r._protoo)||void 0===s?void 0:s.request("CloseConsumer",{requestId:""+Math.ceil(1e9*Math.random()),consumerId:e,producerId:a.producerId})),await a.close(),t&&i&&this.adapterRef.instance.safeEmit("@stream-unsubscribed",{stream:t,mediaType:i})}catch(e){this.logger.error("CloseConsumer失败",e.name,e.message,e)}}catch(e){this.loggerRecv.error("destroyConsumer() | failed:",e.name,e.message,e.stack)}}async closeTransport(e){if(e&&e.id)try{if(this.logger.log(`closeTransport() [停止通道 transportId= ${e.id}]`),!this.adapterRef._signalling||!this.adapterRef._signalling._protoo){let e="closeTransport: _protoo is not found",t="closeTransport: _protoo 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=u.IS_ZH?t:e,a=u.IS_ZH?r:i;throw new l.default({code:c.default.NOT_FOUND_ERROR,message:s,advice:a})}const t=await this.adapterRef._signalling._protoo.request("CloseTransport",{requestId:""+Math.ceil(1e9*Math.random()),transportId:e.id});this.logger.log(`closeTransport() [停止通道反馈结果 result=${JSON.stringify(t,null," ")}]`),e.close()}catch(e){this.logger.error("closeTransport() | failed:",e.name,e.message,e)}}async muteAudio(){if(this.loggerSend.log("mute音频"),!this._micProducer){let e="muteAudio: _micProducer is not found",t="muteAudio: _micProducer 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=u.IS_ZH?t:e,a=u.IS_ZH?r:i;throw new l.default({code:c.default.NOT_FOUND_ERROR,message:s,advice:a})}this._micProducer.pause();try{if(!this.adapterRef._signalling||!this.adapterRef._signalling._protoo){let e="muteAudio: _protoo is not found",t="muteAudio: _protoo 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=u.IS_ZH?t:e,a=u.IS_ZH?r:i;throw new l.default({code:c.default.NOT_FOUND_ERROR,message:s,advice:a})}let e=this.adapterRef.channelInfo.uid;"string"===this.adapterRef.channelInfo.uidType&&(e=new n.default(e)),await this.adapterRef._signalling._protoo.request("SendUserData",{externData:{type:"Mute",cid:this.adapterRef.channelInfo.cid,uid:e,data:{producerId:this._micProducer.id,mute:!0}}})}catch(e){this.loggerSend.error("muteMic() | failed:",e.name,e.message,e)}}async unmuteAudio(){if(this.loggerSend.log("resume音频"),!this._micProducer){let e="unmuteAudio: _micProducer is not found",t="unmuteAudio: _micProducer 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=u.IS_ZH?t:e,a=u.IS_ZH?r:i;throw new l.default({code:c.default.NOT_FOUND_ERROR,message:s,advice:a})}this._micProducer.resume();try{if(!this.adapterRef._signalling||!this.adapterRef._signalling._protoo){let e="unmuteAudio: _protoo is not found",t="unmuteAudio: _protoo 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=u.IS_ZH?t:e,a=u.IS_ZH?r:i;throw new l.default({code:c.default.NOT_FOUND_ERROR,message:s,advice:a})}let e=this.adapterRef.channelInfo.uid;"string"===this.adapterRef.channelInfo.uidType&&(e=new n.default(e)),await this.adapterRef._signalling._protoo.request("SendUserData",{externData:{type:"Mute",cid:this.adapterRef.channelInfo.cid,uid:e,data:{producerId:this._micProducer.id,mute:!1}}})}catch(e){return this.loggerSend.error("muteMic() | failed: ",e.name,e.message,e),Promise.reject(e)}}async muteAudioSlave(){if(this.loggerSend.log("mute音频辅流"),!this._audioSlaveProducer){let e="muteAudioSlave: _audioSlaveProducer is not found",t="muteAudioSlave: _audioSlaveProducer 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=u.IS_ZH?t:e,a=u.IS_ZH?r:i;throw new l.default({code:c.default.NOT_FOUND_ERROR,message:s,advice:a})}this._audioSlaveProducer.pause();try{if(!this.adapterRef._signalling||!this.adapterRef._signalling._protoo){let e="muteAudioSlave: _protoo is not found",t="muteAudioSlave: _protoo 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=u.IS_ZH?t:e,a=u.IS_ZH?r:i;throw new l.default({code:c.default.NOT_FOUND_ERROR,message:s,advice:a})}let e=this.adapterRef.channelInfo.uid;"string"===this.adapterRef.channelInfo.uidType&&(e=new n.default(e)),await this.adapterRef._signalling._protoo.request("SendUserData",{externData:{type:"Mute",cid:this.adapterRef.channelInfo.cid,uid:e,data:{producerId:this._audioSlaveProducer.id,mute:!0}}})}catch(e){this.loggerSend.error("muteMic() | failed:",e.name,e.message,e)}}async unmuteAudioSlave(){if(this.loggerSend.log("resume音频辅流"),!this._audioSlaveProducer){let e="unmuteAudioSlave: _audioSlaveProducer is not found",t="unmuteAudioSlave: _audioSlaveProducer 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=u.IS_ZH?t:e,a=u.IS_ZH?r:i;throw new l.default({code:c.default.NOT_FOUND_ERROR,message:s,advice:a})}this._audioSlaveProducer.resume();try{if(!this.adapterRef._signalling||!this.adapterRef._signalling._protoo){let e="unmuteAudioSlave: _protoo is not found",t="unmuteAudioSlave: _protoo 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=u.IS_ZH?t:e,a=u.IS_ZH?r:i;throw new l.default({code:c.default.NOT_FOUND_ERROR,message:s,advice:a})}let e=this.adapterRef.channelInfo.uid;"string"===this.adapterRef.channelInfo.uidType&&(e=new n.default(e)),await this.adapterRef._signalling._protoo.request("SendUserData",{externData:{type:"Mute",cid:this.adapterRef.channelInfo.cid,uid:e,data:{producerId:this._audioSlaveProducer.id,mute:!1}}})}catch(e){return this.loggerSend.error("muteMic() | failed: ",e.name,e.message,e),Promise.reject(e)}}async muteVideo(){if(this.loggerSend.log("mute视频"),!this._webcamProducer){let e="muteVideo: _webcamProducer is not found",t="muteVideo: _webcamProducer 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=u.IS_ZH?t:e,a=u.IS_ZH?r:i;throw new l.default({code:c.default.NOT_FOUND_ERROR,message:s,advice:a})}this._webcamProducer.pause();try{if(!this.adapterRef._signalling||!this.adapterRef._signalling._protoo){let e="muteVideo: _protoo is not found",t="muteVideo: _protoo 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=u.IS_ZH?t:e,a=u.IS_ZH?r:i;throw new l.default({code:c.default.NOT_FOUND_ERROR,message:s,advice:a})}let e=this.adapterRef.channelInfo.uid;"string"===this.adapterRef.channelInfo.uidType&&(e=new n.default(e)),await this.adapterRef._signalling._protoo.request("SendUserData",{externData:{type:"Mute",cid:this.adapterRef.channelInfo.cid,uid:e,data:{producerId:this._webcamProducer.id,mute:!0}}})}catch(e){this.loggerSend.error("muteMic() | failed:",e.name,e.message,e)}}async unmuteVideo(){if(this.loggerSend.log("resume视频"),!this._webcamProducer){let e="unmuteVideo: _webcamProducer is not found",t="unmuteVideo: _webcamProducer 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=u.IS_ZH?t:e,a=u.IS_ZH?r:i;throw new l.default({code:c.default.NOT_FOUND_ERROR,message:s,advice:a})}this._webcamProducer.resume();try{if(!this.adapterRef._signalling||!this.adapterRef._signalling._protoo){let e="unmuteVideo: _protoo is not found",t="unmuteVideo: _protoo 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=u.IS_ZH?t:e,a=u.IS_ZH?r:i;throw new l.default({code:c.default.NOT_FOUND_ERROR,message:s,advice:a})}let e=this.adapterRef.channelInfo.uid;"string"===this.adapterRef.channelInfo.uidType&&(e=new n.default(e)),await this.adapterRef._signalling._protoo.request("SendUserData",{externData:{type:"Mute",cid:this.adapterRef.channelInfo.cid,uid:e,data:{producerId:this._webcamProducer.id,mute:!1}}})}catch(e){this.loggerSend.error("muteMic() | failed:",e.name,e.message,e)}}async muteScreen(){if(this.loggerSend.log("mute视频"),!this._screenProducer){let e="muteScreen: _screenProducer is not found",t="muteScreen: _screenProducer 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=u.IS_ZH?t:e,a=u.IS_ZH?r:i;throw new l.default({code:c.default.NOT_FOUND_ERROR,message:s,advice:a})}this._screenProducer.pause();try{if(!this.adapterRef._signalling||!this.adapterRef._signalling._protoo){let e="muteScreen: _protoo is not found",t="muteScreen: _protoo 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=u.IS_ZH?t:e,a=u.IS_ZH?r:i;throw new l.default({code:c.default.NOT_FOUND_ERROR,message:s,advice:a})}let e=this.adapterRef.channelInfo.uid;"string"===this.adapterRef.channelInfo.uidType&&(e=new n.default(e)),await this.adapterRef._signalling._protoo.request("SendUserData",{externData:{type:"Mute",cid:this.adapterRef.channelInfo.cid,uid:e,data:{producerId:this._screenProducer.id,mute:!0}}})}catch(e){this.loggerSend.error("muteScreen() | failed: ",e.name,e.message,e)}}async unmuteScreen(){if(this.loggerSend.log("resume视频"),!this._screenProducer){let e="unmuteScreen: _screenProducer is not found",t="unmuteScreen: _screenProducer 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=u.IS_ZH?t:e,a=u.IS_ZH?r:i;throw new l.default({code:c.default.NOT_FOUND_ERROR,message:s,advice:a})}this._screenProducer.resume();try{if(!this.adapterRef._signalling||!this.adapterRef._signalling._protoo){let e="unmuteScreen: _protoo is not found",t="unmuteScreen: _protoo 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=u.IS_ZH?t:e,a=u.IS_ZH?r:i;throw new l.default({code:c.default.NOT_FOUND_ERROR,message:s,advice:a})}let e=this.adapterRef.channelInfo.uid;"string"===this.adapterRef.channelInfo.uidType&&(e=new n.default(e)),await this.adapterRef._signalling._protoo.request("SendUserData",{externData:{type:"Mute",cid:this.adapterRef.channelInfo.cid,uid:e,data:{producerId:this._screenProducer.id,mute:!1}}})}catch(e){this.loggerSend.error("muteMic() | failed:",e.name,e.message,e)}}async updateUserRole(e){this.loggerSend.log("updateUserRole:更新用户角色为"+e);try{if(!this.adapterRef._signalling||!this.adapterRef._signalling._protoo){let e="updateUserRole: _protoo is not found",t="updateUserRole: _protoo 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=u.IS_ZH?t:e,a=u.IS_ZH?r:i;throw new l.default({code:c.default.NOT_FOUND_ERROR,message:s,advice:a})}let t=this.adapterRef.channelInfo.uid;"string"===this.adapterRef.channelInfo.uidType&&(t=new n.default(t)),await this.adapterRef._signalling._protoo.request("SendUserData",{externData:{type:"UserRole",cid:this.adapterRef.channelInfo.cid,uid:t,data:{userRole:e}}})}catch(e){throw this.loggerSend.error("updateUserRole failed:",e.name,e.message,e),e}}async getIceStatus(e="send"){var t,i,r,s;const a=Date.now(),o={ts:Date.now(),direction:e,iceConnectionState:"uninit",info:"",elapse:-1};let n;if(n="send"===e?null===(i=null===(t=this._sendTransport)||void 0===t?void 0:t._handler)||void 0===i?void 0:i._pc:null===(s=null===(r=this._recvTransport)||void 0===r?void 0:r._handler)||void 0===s?void 0:s._pc,n){if(o.info+="#"+n.pcid,o.iceConnectionState=n.iceConnectionState,o.info+="|iceConnectoinState "+n.iceConnectionState,n.iceStartedAt&&(o.elapse=a-n.iceStartedAt),this.iceStatusHistory[e].promises[0]&&(this.iceStatusHistory[e].promises[0](null),this.iceStatusHistory[e].promises=[]),"checking"===n.iceConnectionState){if(n.iceStartedAt||(n.iceStartedAt=a),await new Promise(t=>{this.iceStatusHistory[e].promises=[t],setTimeout(t,3e3)}),"checking"!==n.iceConnectionState)return o;o.elapse=Date.now()-n.iceStartedAt}"connected"!==n.iceConnectionState&&"completed"!==n.iceConnectionState||(n.iceConnectedAt||(n.iceConnectedAt=a),await new Promise(t=>{this.iceStatusHistory[e].promises=[t],setTimeout(t,100)}));let t=null;try{t=await n.getStats(null)}catch(e){}const i=[],r=[];t&&t.forEach((e,t)=>{i.push(e),"transport"===e.type&&r.push(e)}),r.length||(o.info+="|no transport stats"),r.forEach(e=>{const t=i.find(t=>t.id===e.selectedCandidatePairId);if(t){const e=i.find(e=>e.id===t.localCandidateId);e?(o.info+=`|local:${e.protocol} `,o.info+=`${e.address||"NOADDRESS"}:${e.port||"NOPORT"} ${e.candidateType} ${e.networkType||""}`,o.networkType=e.networkType,o.protocol=e.protocol,o.relayProtocol=e.relayProtocol,o.ip=e.ip,o.address=e.address):o.info+="|无法找到localCandidate "+t.localCandidateId;const r=i.find(e=>e.id===t.remoteCandidateId);r?(o.info+=`|remote:${r.protocol} `,o.info+=`${r.address||"NOADDRESS"}:${r.port||"NOPORT"} ${r.candidateType}`):o.info+="|无法找到remoteCandidate "+t.remoteCandidateId}else o.info+="无法找到candidatePair "+e.selectedCandidatePairId})}else o.info="no_pc_"+e;if(this.iceStatusHistory[e].status.info!==o.info&&"new"!==o.iceConnectionState&&this._mediasoupDevice){const t={new:1,checking:2,connected:3,completed:4,failed:-1,disconnected:-2,closed:-3}[o.iceConnectionState||0]||0;t>0?this.adapterRef.logger.log("iceConnectionStateChanged",e,o.info):this.adapterRef.logger.warn("iceConnectionStateChanged",e,o.info),this.adapterRef.instance.apiFrequencyControl({name:"_iceStateChange_"+e,code:t,param:JSON.stringify(o)}),this.adapterRef.instance.safeEmit("@ice-change",o)}return this.iceStatusHistory[e].status=o,o}getReceivers(e={}){const t=[];for(let i in this.adapterRef.remoteStreamMap){const r=this.adapterRef.remoteStreamMap[i];if(e.uid&&e.uid.toString()!==i)continue;["audio","video","screen","audioSlave"].forEach(s=>{if(e.mediaType&&e.mediaType!==s)return;if(!r.active||!r.pubStatus[s].consumerId)return;const a=this._consumers[r.pubStatus[s].consumerId];a&&t.push({uid:i,mediaType:s,remoteStream:r,consumer:a})})}return t}destroy(){this.logger.log("清除 meidasoup"),this._reset()}}t.Mediasoup=v},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.waitForEvent=void 0,t.waitForEvent=async function(e,t,i){return new Promise((r,s)=>{let a;const o=e=>{a&&clearTimeout(a),r(e)};i&&(a=setTimeout(()=>{e.removeListener(t,o),s(`timed out after ${i}ms:${t}`)},i)),e.once(t,o)})}},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Chrome74=void 0;const n=a(i(123)),d=o(i(11)),c=o(i(12)),l=i(68),u=i(5),h=i(56),p=a(i(124)),m=a(i(71)),f=i(140),g=a(i(150)),v=i(151),_=a(i(152)),S=a(i(2)),y="Chrome_",R={OS:1024,MIS:1024};let b=0;class T extends f.HandlerInterface{constructor(){super(),this._sendingRemoteRtpParametersByKind={},this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._transportReady=!1,this._appData={}}static createFactory(){return()=>new T}get name(){return"Chrome74"}close(){if(h.Logger.debug(y,"close()"),this._pc)try{this._pc.onconnectionstatechange=null,this._pc.close()}catch(e){}}async getNativeRtpCapabilities(){h.Logger.debug(y,"getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"});try{e.addTransceiver("audio"),e.addTransceiver("video");const t=await e.createOffer();t.sdp=t.sdp.replace(/a=rtcp-fb:111 transport-cc/g,"a=rtcp-fb:111 transport-cc\r\na=rtcp-fb:111 nack");try{e.close()}catch(e){}const i=n.parse(t.sdp);return g.extractRtpCapabilities({sdpObject:i})}catch(t){try{e.close()}catch(e){}throw t}}async getNativeSctpCapabilities(){return h.Logger.debug(y,"getNativeSctpCapabilities()"),{numStreams:R}}run({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s,iceServers:a,iceTransportPolicy:o,additionalSettings:n,proprietaryConstraints:d,extendedRtpCapabilities:c,appData:l}){h.Logger.debug(y,"run()"),this._appData=l,this._direction=e,this._sendingRtpParametersByKind={audio:p.getSendingRtpParameters("audio",c),video:p.getSendingRtpParameters("video",c)},this._sendingRemoteRtpParametersByKind={audio:p.getSendingRemoteRtpParameters("audio",c),video:p.getSendingRemoteRtpParameters("video",c)},h.Logger.debug(y,"iceServers: ",a);const u={iceServers:a||[],iceTransportPolicy:o||"all",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"};l.encodedInsertableStreams&&(u.encodedInsertableStreams=!0),this._pc=new RTCPeerConnection(u,d),this._pc.pcid=b++,this._pc.onconnectionstatechange=()=>{switch(this._pc.connectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed")}},this._pc.onicecandidate=e=>{},this._pc.onicecandidateerror=e=>{h.Logger.warn("onicecandidateerror: ",e)}}async updateIceServers(e){h.Logger.debug(y,"updateIceServers(): ");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(h.Logger.debug(y,"restartIce()"),this._remoteSdp.updateIceParameters(e),this._transportReady)if(this._direction){const e=await this._pc.createOffer({iceRestart:!0});let t=n.parse(e.sdp);t.media.forEach(e=>{"audio"===e.type&&"send"===this._direction&&e.ext&&e.rtcpFb&&(e.ext=e.ext.filter(e=>-1==e.uri.indexOf("transport-wide-cc")&&-1==e.uri.indexOf("abs-send-time")),e.rtcpFb=e.rtcpFb.map(e=>(e.type=e.type.replace(/transport-cc/g,"nack"),e)))}),e.sdp=n.write(t),h.Logger.debug(y,"restartIce() | calling pc.setLocalDescription()"),await this._pc.setLocalDescription(e);const i={type:"answer",sdp:this._remoteSdp.getSdp()};h.Logger.debug(y,"restartIce() | calling pc.setRemoteDescription() [answer]"),await this._pc.setRemoteDescription(i)}else{const e={type:"offer",sdp:this._remoteSdp.getSdp()};h.Logger.debug(y,"restartIce() | calling pc.setRemoteDescription()"),await this._pc.setRemoteDescription(e);const t=await this._pc.createAnswer();h.Logger.debug(y,"restartIce() | calling pc.setLocalDescription()"),await this._pc.setLocalDescription(t)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,trackLow:t,encodings:i,codecOptions:r,codec:s,appData:a}){this._assertSendDirection(),h.Logger.debug(y,`send() [kind: ${e.kind}, track.id: ${e.id}, appData: ${JSON.stringify(a)}]`),i&&i.length>1&&i.forEach((e,t)=>{e.rid="r"+t});const o=m.clone(this._sendingRtpParametersByKind[e.kind],{});o.codecs=l.reduceCodecs(o.codecs,s);let u={},p={};const f=new MediaStream;"audio"===a.mediaType&&this._pc.audioSender?(h.Logger.debug(y,"audioSender 更新 track: ",this._pc.audioSender.track,"=>",e),this._pc.audioSender.replaceTrack(e)):"audioSlave"===a.mediaType&&this._pc.audioSlaveSender?(h.Logger.debug(y,"audioSlaveSender 更新 track: ",this._pc.audioSlaveSender.track,"=>",e),this._pc.audioSlaveSender.replaceTrack(e)):"video"===a.mediaType&&this._pc.videoSender?(h.Logger.debug(y,"videoSender 更新 track: ",this._pc.videoSender.track,"=>",e),this._pc.videoSender.replaceTrack(e),this._pc.videoSenderLow&&this._pc.videoSenderLow.track!==t&&(h.Logger.debug(y,"videoSenderLow 更新 track: ",this._pc.videoSenderLow),this._pc.videoSenderLow.replaceTrack(t))):"screenShare"===a.mediaType&&this._pc.screenSender?(h.Logger.debug(y,"screenSender 更新 track: ",this._pc.screenSender.track,"=>",e),this._pc.screenSender.replaceTrack(e),this._pc.screenSenderLow&&this._pc.screenSenderLow.track!==t&&(h.Logger.debug(y,"screenSenderLow 更新 track: ",this._pc.screenSenderLow),this._pc.screenSenderLow.replaceTrack(t))):(f.addTrack(e),u=this._pc.addTransceiver(e,{direction:"sendonly",streams:[f],sendEncodings:i}),t&&(p=this._pc.addTransceiver(t,{direction:"sendonly",streams:[this._sendStream],sendEncodings:i})),"audio"!==a.mediaType||this._pc.audioSender?"audioSlave"!==a.mediaType||this._pc.audioSlaveSender?"video"!==a.mediaType||this._pc.videoSender?"screenShare"!==a.mediaType||this._pc.screenSender||(this._pc.screenSender=u.sender,this._pc.screenSenderLow=p.sender):(this._pc.videoSender=u.sender,this._pc.videoSenderLow=p.sender):this._pc.audioSlaveSender=u.sender:this._pc.audioSender=u.sender),h.Logger.debug(y,`send() | [transceivers: ${this._pc.getTransceivers().length}]`);let v,R,b=await this._pc.createOffer(),T=n.parse(b.sdp),w=void 0;const I=T.media.filter(i=>{const r=this._mapMidTransceiver.get(""+i.mid);return i.type===e.kind&&(!(r&&r.sender&&r.sender.track)||(r.sender.track.id===e.id?(v=i,!1):!t||r.sender.track.id!==t.id||(R=i,!1)))});if(v||(v=I.pop()),t&&!R&&(R=I.pop()),!v){let t="Chrome.send: offerMediaObject with track id not found: "+e.id,i="Chrome.setRtpEncodingParameters: offerMediaObject 未找到: "+e.id,r="Please contact CommsEase technical support",s="请联系云信技术支持",a=S.IS_ZH?i:t,o=S.IS_ZH?s:r;throw new c.default({code:d.default.SDP_ERROR,message:a,advice:o})}this._transportReady||(w=await this._setupTransport({localDtlsRole:"server",localSdpObject:T}));let E=v.mid;if("number"==typeof E&&(E=""+E),!E){let e="Chrome.send: localId is not found",t="Chrome.send: localId 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new c.default({code:d.default.SDP_ERROR,message:s,advice:a})}let A=null;if(R&&(A=""+R.mid),o.mid=E,o.rtcp.cname=g.getCname({offerMediaObject:v}),i)if(1===i.length){let e=_.getRtpEncodings({offerMediaObject:v});Object.assign(e[0],i[0]),o.encodings=e}else o.encodings=i;else o.encodings=[],R&&(o.encodings=o.encodings.concat(_.getRtpEncodings({offerMediaObject:R}))),o.encodings=o.encodings.concat(_.getRtpEncodings({offerMediaObject:v}));return o.encodings.length>1&&("video/vp8"===o.codecs[0].mimeType.toLowerCase()||"video/h264"===o.codecs[0].mimeType.toLowerCase())&&T.media.forEach(e=>{"audio"===e.type&&e.ext&&e.rtcpFb&&(e.ext=e.ext.filter(e=>-1==e.uri.indexOf("transport-wide-cc")&&-1==e.uri.indexOf("abs-send-time")),e.rtcpFb=e.rtcpFb.map(e=>(e.type=e.type.replace(/transport-cc/g,"nack"),e)))}),b.sdp=n.write(T),this._mapMidTransceiver.set(E,u),A&&this._mapMidTransceiver.set(A,p),{localId:E,localIdLow:A,rtpParameters:o,rtpSender:u.sender,rtpSenderLow:p.sender||null,dtlsParameters:w,offer:b}}async fillRemoteRecvSdp({kind:e,iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s,sendingRtpParameters:a,codecOptions:o,offer:d,audioProfile:c,codec:p}){h.Logger.debug(y,"fillRemoteRecvSdp() | calling pc.setLocalDescription()"),await this._pc.setLocalDescription(d),this._remoteSdp||(this._remoteSdp=new v.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s}),this._remoteSdp.updateDtlsRole("client"));const f=m.clone(this._sendingRemoteRtpParametersByKind[e]);f.codecs=l.reduceCodecs(f.codecs,p);let g=n.parse(this._pc.localDescription.sdp);const _=this._remoteSdp.getNextMediaSectionIdx();let S=g.media[_.idx],R=null;a.encodings&&a.encodings.length>1&&(R=g.media[_.idx+1]),this._remoteSdp.send({offerMediaObjectArr:[S,R],reuseMid:_.reuseMid,offerRtpParameters:a,answerRtpParameters:f,codecOptions:o,extmapAllowMixed:!0});const b={type:"answer",sdp:this._remoteSdp.getSdp()};if(h.Logger.debug(y,"audioProfile设置为: ",c),c){let e=null;switch(c){case"speech_low_quality":e="maxplaybackrate=16000;sprop-maxcapturerate=16000;maxaveragebitrate=32000";break;case"speech_standard":e="maxplaybackrate=32000;sprop-maxcapturerate=32000;maxaveragebitrate=36000";break;case"music_standard":e="maxplaybackrate=48000;sprop-maxcapturerate=48000;";break;case"standard_stereo":e="stereo=1;sprop-stereo=1;maxplaybackrate=48000;sprop-maxcapturerate=48000;maxaveragebitrate=56000";break;case"high_quality":e="maxplaybackrate=48000;sprop-maxcapturerate=48000;maxaveragebitrate=128000";break;case"high_quality_stereo":e="stereo=1;sprop-stereo=1;maxplaybackrate=48000;sprop-maxcapturerate=48000;maxaveragebitrate=192000"}b.sdp.indexOf("a=fmtp:111")&&(b.sdp=b.sdp.replace(/a=fmtp:111 ([0-9=;a-zA-Z]*)/,"a=fmtp:111 minptime=10;useinbandfec=1;"+e)),b.sdp=b.sdp.replace(/a=rtcp-fb:111 transport-cc/g,"a=maxptime:60")}h.Logger.debug(y,"fillRemoteRecvSdp() | calling pc.setRemoteDescription()"),u.getParameters().enableUdpCandidate||(b.sdp=b.sdp.replace(/\r\na=candidate:udpcandidate[^\r]+/g,"")),u.getParameters().enableTcpCandidate||(b.sdp=b.sdp.replace(/\r\na=candidate:tcpcandidate[^\r]+/g,"")),await this._pc.setRemoteDescription(b)}async stopSending(e,t){this._assertSendDirection(),h.Logger.debug(y,`stopSending() [kind: ${t}, localId: ${e}]`);const i=this._mapMidTransceiver.get(e);if(!i){let e="Chrome.stopSending: associated RTCRtpTransceiver is not found",t="Chrome.stopSending: RTCRtpTransceiver 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new c.default({code:d.default.SDP_ERROR,message:s,advice:a})}"audio"===t?this._pc.audioSender.replaceTrack(null):"audioSlave"===t?this._pc.audioSlaveSender.replaceTrack(null):"video"===t?(this._pc.videoSender.replaceTrack(null),this._pc.videoSenderLow&&this._pc.videoSenderLow.replaceTrack(null)):"screenShare"===t?(this._pc.screenSender.replaceTrack(null),this._pc.screenSenderLow&&this._pc.screenSenderLow.replaceTrack(null)):i.sender.replaceTrack(null);const r=await this._pc.createOffer();let s=n.parse(r.sdp);s.media.forEach(e=>{"audio"===e.type&&e.ext&&e.rtcpFb&&(e.ext=e.ext.filter(e=>-1==e.uri.indexOf("transport-wide-cc")&&-1==e.uri.indexOf("abs-send-time")),e.rtcpFb=e.rtcpFb.map(e=>(e.type=e.type.replace(/transport-cc/g,"nack"),e)))}),r.sdp=n.write(s),h.Logger.debug(y,"stopSending() | calling pc.setLocalDescription()");try{await this._pc.setLocalDescription(r)}catch(e){h.Logger.debug(y,"setLocalDescription error: ",e.message)}const a={type:"answer",sdp:this._remoteSdp.getSdp()};h.Logger.debug(y,"stopSending() | calling pc.setRemoteDescription()"),await this._pc.setRemoteDescription(a)}async replaceTrack(e,t){this._assertSendDirection(),t?h.Logger.debug(y,"replaceTrack() [localId:%s, track.id:%s]",e,t.id):h.Logger.debug(y,"replaceTrack() [localId:%s, no track]",e);const i=this._mapMidTransceiver.get(e);if(!i){let e="Chrome.replaceTrack: associated RTCRtpTransceiver is not found",t="Chrome.replaceTrack: RTCRtpTransceiver 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new c.default({code:d.default.SDP_ERROR,message:s,advice:a})}await i.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this._assertSendDirection(),h.Logger.debug(y,"setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const i=this._mapMidTransceiver.get(e);if(!i){let e="Chrome.setMaxSpatialLayer: associated RTCRtpTransceiver is not found",t="Chrome.setMaxSpatialLayer: RTCRtpTransceiver 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new c.default({code:d.default.SDP_ERROR,message:s,advice:a})}const r=i.sender.getParameters();r.encodings.forEach((e,i)=>{e.active=i<=t}),await i.sender.setParameters(r)}async setRtpEncodingParameters(e,t){this._assertSendDirection(),h.Logger.debug(y,"setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const i=this._mapMidTransceiver.get(e);if(!i){let e="Chrome.setRtpEncodingParameters: associated RTCRtpTransceiver is not found",t="Chrome.setRtpEncodingParameters: RTCRtpTransceiver 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new c.default({code:d.default.SDP_ERROR,message:s,advice:a})}const r=i.sender.getParameters();r.encodings.forEach((e,i)=>{r.encodings[i]=Object.assign(Object.assign({},e),t)}),await i.sender.setParameters(r)}async getSenderStats(e){this._assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t){let e="Chrome.getSenderStats: associated RTCRtpTransceiver is not found",t="Chrome.getSenderStats: RTCRtpTransceiver 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new c.default({code:d.default.SDP_ERROR,message:s,advice:a})}return t.sender.getStats()}async recoverTransceiver(e,t,i){h.Logger.debug(y,"recoverTransceiver() [kind:%s, remoteUid:%s, mid: %s]",i,e,t);const r=this._mapMidTransceiver.get(t);r?r.isUseless=!0:h.Logger.debug(y,"recoverTransceiver() transceiver undefined")}async prepareLocalSdp(e,t){h.Logger.debug(y,`[Subscribe] prepareLocalSdp() [kind: ${e}, remoteUid: ${t}]`);let i=-1;for(const t of this._mapMidTransceiver.keys()){const r=this._mapMidTransceiver.get(t);if(!r)continue;const s=r.receiver&&r.receiver.track&&r.receiver.track.kind||e;if(r.isUseless&&s===e){i=t-0,r.isUseless=!1;break}}let r=this._pc.localDescription,s=null;-1===i&&(h.Logger.debug(y,"[Subscribe] prepareLocalSdp() 添加一个M行"),s=this._pc.addTransceiver(e,{direction:"recvonly"}),r=await this._pc.createOffer(),r.sdp=r.sdp.replace(/a=rtcp-fb:111 transport-cc/g,"a=rtcp-fb:111 transport-cc\r\na=rtcp-fb:111 nack"),r.sdp.indexOf("a=fmtp:111")&&(r.sdp=r.sdp.replace(/a=fmtp:111 ([0-9=;a-zA-Z-]*)/,"a=fmtp:111 minptime=10;stereo=1;sprop-stereo=1;useinbandfec=1")));const a=n.parse(r.sdp);let o=void 0;this._transportReady||(o=await this._setupTransport({localDtlsRole:"server",localSdpObject:a}));const d=g.extractRtpCapabilities({sdpObject:a});return-1===i&&(i=a.media.length-1,this._mapMidTransceiver.set(""+i,s)),{dtlsParameters:o,rtpCapabilities:d,offer:r,mid:i,iceUfragReg:""}}async receive({iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:r,trackId:s,kind:a,rtpParameters:o,offer:n,probeSSrc:l=-1,remoteUid:p,extendedRtpCapabilities:m,appData:f}){this._assertRecvDirection(),h.Logger.debug(y,`[Subscribe] receive() [trackId: ${s}, kind: ${a}, remoteUid: ${p}]`),this._remoteSdp||(this._remoteSdp=new v.RemoteSdp({iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:r}),this._remoteSdp.updateDtlsRole("client"));let g=o&&o.mid||f.mid;if(h.Logger.debug(y,"[Subscribe] receive() mid: "+g),o.mid)this._remoteSdp.receive({mid:g,kind:a,offerRtpParameters:o,streamId:o.rtcp.cname,trackId:s});else{h.Logger.debug(y,"[Subscribe] receive() 容错流程");const e=[];m.codecs.forEach(t=>{if(t.kind===a){const i=Object.assign({},t);i.parameters=i.parameters||i.localParameters,i.payloadType=i.payloadType||i.localPayloadType,e.push(i)}});const t={mid:g,kind:a,offerRtpParameters:{codecs:e,encodings:[{ssrc:0}],headerExtensions:[],rtcp:{},mid:g},streamId:a,trackId:s,reuseMediaSection:void 0};this._remoteSdp.receive(t),this._remoteSdp.disableMediaSection(""+g)}n.sdp=n.sdp.replace(/a=rtcp-fb:111 transport-cc/g,"a=rtcp-fb:111 transport-cc\r\na=rtcp-fb:111 nack"),n.sdp.indexOf("a=fmtp:111")&&(n.sdp=n.sdp.replace(/a=fmtp:111 ([0-9=;a-zA-Z]*)/,"a=fmtp:111 minptime=10;stereo=1;sprop-stereo=1;useinbandfec=1"));const _={type:"answer",sdp:this._remoteSdp.getSdp()};_.sdp.indexOf("a=fmtp:111")&&(_.sdp=_.sdp.replace(/a=fmtp:111 ([0-9=;a-zA-Z]*)/,"a=fmtp:111 minptime=10;stereo=1;sprop-stereo=1;useinbandfec=1")),u.getParameters().enableUdpCandidate||(_.sdp=_.sdp.replace(/\r\na=candidate:udpcandidate[^\r]+/g,"")),u.getParameters().enableTcpCandidate||(_.sdp=_.sdp.replace(/\r\na=candidate:tcpcandidate[^\r]+/g,"")),h.Logger.debug(y,"[Subscribe] receive() | calling pc.setLocalDescription()"),await this._pc.setLocalDescription(n),h.Logger.debug(y,"[Subscribe] receive() | calling pc.setRemoteDescription()"),await this._pc.setRemoteDescription(_);const R=this._pc.getTransceivers().find(e=>e.mid===g);if(!R){let e="Chrome.receive: new RTCRtpTransceiver is not found",t="Chrome.receive: RTCRtpTransceiver 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new c.default({code:d.default.SDP_ERROR,message:s,advice:a})}return this._mapMidTransceiver.set(g,R),{localId:g,track:R.receiver.track,rtpReceiver:R.receiver}}async stopReceiving(e){this._assertRecvDirection(),h.Logger.debug(y,"stopReceiving() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t||!t.mid){let e="Chrome.stopReceiving: associated RTCRtpTransceiver is not found",t="Chrome.stopReceiving: RTCRtpTransceiver 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new c.default({code:d.default.SDP_ERROR,message:s,advice:a})}t.receiver&&t.receiver.track&&t.receiver.track&&"audio"===t.receiver.track.kind||(t.isUseless=!0),this._remoteSdp.disableMediaSection(t.mid);const i=this._pc.localDescription;h.Logger.debug(y,"stopReceiving() | calling pc.setLocalDescription()"),await this._pc.setLocalDescription(i);const r={type:"answer",sdp:this._remoteSdp.getSdp()};h.Logger.debug(y,"stopReceiving() | calling pc.setRemoteDescription()"),await this._pc.setRemoteDescription(r)}async getReceiverStats(e){this._assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t){let e="Chrome.getReceiverStats: associated RTCRtpTransceiver is not found",t="Chrome.getReceiverStats: RTCRtpTransceiver 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new c.default({code:d.default.SDP_ERROR,message:s,advice:a})}return t.receiver.getStats()}async _setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=n.parse(this._pc.localDescription.sdp));const i=g.extractDtlsParameters({sdpObject:t});return i.role=e,this._transportReady=!0,i}_assertSendDirection(){if("send"!==this._direction){let e="_assertSendDirection: invalid operation",t="_assertSendDirection: 操作异常",i="method can just be called for handlers with send direction",r="只能在 send 方向中调用",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new c.default({code:d.default.INVALID_OPERATION_ERROR,message:s,advice:a})}}_assertRecvDirection(){if("recv"!==this._direction){let e="_assertRecvDirection: invalid operation",t="_assertRecvDirection: 操作异常",i="method can just be called for handlers with recv direction",r="只能在 recv 方向中调用",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new c.default({code:d.default.INVALID_OPERATION_ERROR,message:s,advice:a})}}}t.Chrome74=T},function(e,t,i){var r=function(e){return String(Number(e))===e?Number(e):e},s=function(e,t,i){var s=e.name&&e.names;e.push&&!t[e.push]?t[e.push]=[]:s&&!t[e.name]&&(t[e.name]={});var a=e.push?{}:s?t[e.name]:t;!function(e,t,i,s){if(s&&!i)t[s]=r(e[1]);else for(var a=0;a<i.length;a+=1)null!=e[a+1]&&(t[i[a]]=r(e[a+1]))}(i.match(e.reg),a,e.names,e.name),e.push&&t[e.push].push(a)},a=i(167),o=RegExp.prototype.test.bind(/^([a-z])=(.*)/);t.parse=function(e){var t={},i=[],r=t;return e.split(/(\r\n|\r|\n)/).filter(o).forEach((function(e){var t=e[0],o=e.slice(2);"m"===t&&(i.push({rtp:[],fmtp:[]}),r=i[i.length-1]);for(var n=0;n<(a[t]||[]).length;n+=1){var d=a[t][n];if(d.reg.test(o))return s(d,r,o)}})),t.media=i,t};var n=function(e,t){var i=t.split(/=(.+)/,2);return 2===i.length?e[i[0]]=r(i[1]):1===i.length&&t.length>1&&(e[i[0]]=void 0),e};t.parseParams=function(e){return e.split(/;\s?/).reduce(n,{})},t.parseFmtpConfig=t.parseParams,t.parsePayloads=function(e){return e.toString().split(" ").map(Number)},t.parseRemoteCandidates=function(e){for(var t=[],i=e.split(" ").map(r),s=0;s<i.length;s+=3)t.push({component:i[s],ip:i[s+1],port:i[s+2]});return t},t.parseImageAttributes=function(e){return e.split(" ").map((function(e){return e.substring(1,e.length-1).split(",").reduce(n,{})}))},t.parseSimulcastStreamList=function(e){return e.split(";").map((function(e){return e.split(",").map((function(e){var t,i=!1;return"~"!==e[0]?t=r(e):(t=r(e.substring(1,e.length)),i=!0),{scid:t,paused:i}}))}))}},function(e,t,i){var r=i(167),s=/%[sdv%]/g,a=function(e){var t=1,i=arguments,r=i.length;return e.replace(s,(function(e){if(t>=r)return e;var s=i[t];switch(t+=1,e){case"%%":return"%";case"%s":return String(s);case"%d":return Number(s);case"%v":return""}}))},o=function(e,t,i){var r=[e+"="+(t.format instanceof Function?t.format(t.push?i:i[t.name]):t.format)];if(t.names)for(var s=0;s<t.names.length;s+=1){var o=t.names[s];t.name?r.push(i[t.name][o]):r.push(i[t.names[s]])}else r.push(i[t.name]);return a.apply(null,r)},n=["v","o","s","i","u","e","p","c","b","t","r","z","a"],d=["i","c","b","a"];e.exports=function(e,t){t=t||{},null==e.version&&(e.version=0),null==e.name&&(e.name=" "),e.media.forEach((function(e){null==e.payloads&&(e.payloads="")}));var i=t.outerOrder||n,s=t.innerOrder||d,a=[];return i.forEach((function(t){r[t].forEach((function(i){i.name in e&&null!=e[i.name]?a.push(o(t,i,e)):i.push in e&&null!=e[i.push]&&e[i.push].forEach((function(e){a.push(o(t,i,e))}))}))})),e.media.forEach((function(e){a.push(o("m",r.m[0],e)),s.forEach((function(t){r[t].forEach((function(i){i.name in e&&null!=e[i.name]?a.push(o(t,i,e)):i.push in e&&null!=e[i.push]&&e[i.push].forEach((function(e){a.push(o(t,i,e))}))}))}))})),a.join("\r\n")+"\r\n"}},function(e,t,i){const r=i(168)("h264-profile-level-id");r.log=console.info.bind(console);t.ProfileConstrainedBaseline=1,t.ProfileBaseline=2,t.ProfileMain=3,t.ProfileConstrainedHigh=4,t.ProfileHigh=5;t.Level1_b=0,t.Level1=10,t.Level1_1=11,t.Level1_2=12,t.Level1_3=13,t.Level2=20,t.Level2_1=21,t.Level2_2=22,t.Level3=30,t.Level3_1=31,t.Level3_2=32,t.Level4=40,t.Level4_1=41,t.Level4_2=42,t.Level5=50,t.Level5_1=51,t.Level5_2=52;class s{constructor(e,t){this.profile=e,this.level=t}}t.ProfileLevelId=s;const a=new s(1,31);class o{constructor(e){this._mask=~c("x",e),this._maskedValue=c("1",e)}isMatch(e){return this._maskedValue===(e&this._mask)}}class n{constructor(e,t,i){this.profile_idc=e,this.profile_iop=t,this.profile=i}}const d=[new n(66,new o("x1xx0000"),1),new n(77,new o("1xxx0000"),1),new n(88,new o("11xx0000"),1),new n(66,new o("x0xx0000"),2),new n(88,new o("10xx0000"),2),new n(77,new o("0x0x0000"),3),new n(100,new o("00000000"),5),new n(100,new o("00001100"),4)];function c(e,t){return(t[0]===e)<<7|(t[1]===e)<<6|(t[2]===e)<<5|(t[3]===e)<<4|(t[4]===e)<<3|(t[5]===e)<<2|(t[6]===e)<<1|(t[7]===e)<<0}function l(e={}){const t=e["level-asymmetry-allowed"];return 1===t||"1"===t}t.parseProfileLevelId=function(e){if("string"!=typeof e||6!==e.length)return null;const t=parseInt(e,16);if(0===t)return null;const i=255&t,a=t>>8&255,o=t>>16&255;let n;switch(i){case 11:n=0!=(16&a)?0:11;break;case 10:case 12:case 13:case 20:case 21:case 22:case 30:case 31:case 32:case 40:case 41:case 42:case 50:case 51:case 52:n=i;break;default:return r("parseProfileLevelId() | unrecognized level_idc:%s",i),null}for(const e of d)if(o===e.profile_idc&&e.profile_iop.isMatch(a))return new s(e.profile,n);return r("parseProfileLevelId() | unrecognized profile_idc/profile_iop combination"),null},t.profileLevelIdToString=function(e){if(0==e.level)switch(e.profile){case 1:return"42f00b";case 2:return"42100b";case 3:return"4d100b";default:return r("profileLevelIdToString() | Level 1_b not is allowed for profile:%s",e.profile),null}let t;switch(e.profile){case 1:t="42e0";break;case 2:t="4200";break;case 3:t="4d00";break;case 4:t="640c";break;case 5:t="6400";break;default:return r("profileLevelIdToString() | unrecognized profile:%s",e.profile),null}let i=e.level.toString(16);return 1===i.length&&(i="0"+i),`${t}${i}`},t.parseSdpProfileLevelId=function(e={}){const i=e["profile-level-id"];return i?t.parseProfileLevelId(i):a},t.isSameProfile=function(e={},i={}){const r=t.parseSdpProfileLevelId(e),s=t.parseSdpProfileLevelId(i);return Boolean(r&&s&&r.profile===s.profile)},t.generateProfileLevelIdForAnswer=function(e={},i={}){if(!e["profile-level-id"]&&!i["profile-level-id"])return r("generateProfileLevelIdForAnswer() | no profile-level-id in local and remote params"),null;const a=t.parseSdpProfileLevelId(e),o=t.parseSdpProfileLevelId(i);if(!a)throw new TypeError("invalid local_profile_level_id");if(!o)throw new TypeError("invalid remote_profile_level_id");if(a.profile!==o.profile)throw new TypeError("H264 Profile mismatch");const n=l(e)&&l(i),d=a.level,c=o.level,u=function(e,t){return 0===e?10!==t&&0!==t:0===t?10!==e:e<t}(h=d,p=c)?h:p;var h,p;const m=n?d:u;return r("generateProfileLevelIdForAnswer() | result: [profile:%s, level:%s]",a.profile,m),t.profileLevelIdToString(new s(a.profile,m))}},function(e,t,i){e.exports=function(e){function t(e){let i,s,a,o=null;function n(...e){if(!n.enabled)return;const r=n,s=Number(new Date),a=s-(i||s);r.diff=a,r.prev=i,r.curr=s,i=s,e[0]=t.coerce(e[0]),"string"!=typeof e[0]&&e.unshift("%O");let o=0;e[0]=e[0].replace(/%([a-zA-Z%])/g,(i,s)=>{if("%%"===i)return"%";o++;const a=t.formatters[s];if("function"==typeof a){const t=e[o];i=a.call(r,t),e.splice(o,1),o--}return i}),t.formatArgs.call(r,e);(r.log||t.log).apply(r,e)}return n.namespace=e,n.useColors=t.useColors(),n.color=t.selectColor(e),n.extend=r,n.destroy=t.destroy,Object.defineProperty(n,"enabled",{enumerable:!0,configurable:!1,get:()=>null!==o?o:(s!==t.namespaces&&(s=t.namespaces,a=t.enabled(e)),a),set:e=>{o=e}}),"function"==typeof t.init&&t.init(n),n}function r(e,i){const r=t(this.namespace+(void 0===i?":":i)+e);return r.log=this.log,r}function s(e){return e.toString().substring(2,e.toString().length-2).replace(/\.\*\?$/,"*")}return t.debug=t,t.default=t,t.coerce=function(e){if(e instanceof Error)return e.stack||e.message;return e},t.disable=function(){const e=[...t.names.map(s),...t.skips.map(s).map(e=>"-"+e)].join(",");return t.enable(""),e},t.enable=function(e){let i;t.save(e),t.namespaces=e,t.names=[],t.skips=[];const r=("string"==typeof e?e:"").split(/[\s,]+/),s=r.length;for(i=0;i<s;i++)r[i]&&("-"===(e=r[i].replace(/\*/g,".*?"))[0]?t.skips.push(new RegExp("^"+e.slice(1)+"$")):t.names.push(new RegExp("^"+e+"$")))},t.enabled=function(e){if("*"===e[e.length-1])return!0;let i,r;for(i=0,r=t.skips.length;i<r;i++)if(t.skips[i].test(e))return!1;for(i=0,r=t.names.length;i<r;i++)if(t.names[i].test(e))return!0;return!1},t.humanize=i(223),t.destroy=function(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")},Object.keys(e).forEach(i=>{t[i]=e[i]}),t.names=[],t.skips=[],t.formatters={},t.selectColor=function(e){let i=0;for(let t=0;t<e.length;t++)i=(i<<5)-i+e.charCodeAt(t),i|=0;return t.colors[Math.abs(i)%t.colors.length]},t.enable(t.load()),t}},function(e,t){var i=1e3,r=6e4,s=60*r,a=24*s;function o(e,t,i,r){var s=t>=1.5*i;return Math.round(e/i)+" "+r+(s?"s":"")}e.exports=function(e,t){t=t||{};var n=typeof e;if("string"===n&&e.length>0)return function(e){if((e=String(e)).length>100)return;var t=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(e);if(!t)return;var o=parseFloat(t[1]);switch((t[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return 315576e5*o;case"weeks":case"week":case"w":return 6048e5*o;case"days":case"day":case"d":return o*a;case"hours":case"hour":case"hrs":case"hr":case"h":return o*s;case"minutes":case"minute":case"mins":case"min":case"m":return o*r;case"seconds":case"second":case"secs":case"sec":case"s":return o*i;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return o;default:return}}(e);if("number"===n&&isFinite(e))return t.long?function(e){var t=Math.abs(e);if(t>=a)return o(e,t,a,"day");if(t>=s)return o(e,t,s,"hour");if(t>=r)return o(e,t,r,"minute");if(t>=i)return o(e,t,i,"second");return e+" ms"}(e):function(e){var t=Math.abs(e);if(t>=a)return Math.round(e/a)+"d";if(t>=s)return Math.round(e/s)+"h";if(t>=r)return Math.round(e/r)+"m";if(t>=i)return Math.round(e/i)+"s";return e+"ms"}(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))}},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.OfferMediaSection=t.AnswerMediaSection=t.MediaSection=void 0;const o=a(i(71));class n{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:i,planB:r=!1}){if(this._mediaObject={},this._planB=r,e&&this.setIceParameters(e),t){this._mediaObject.candidates=[];for(const e of t){const t={component:1};t.foundation=e.foundation,t.ip=e.ip,t.port=e.port,t.priority=e.priority,t.transport=e.protocol,t.type=e.type,e.tcpType&&(t.tcptype=e.tcpType),this._mediaObject.candidates.push(t)}this._mediaObject.endOfCandidates="end-of-candidates",this._mediaObject.iceOptions="renomination"}i&&this.setDtlsRole(i.role)}get mid(){return String(this._mediaObject.mid)}get type(){return String(this._mediaObject.type)}get closed(){return 0===this._mediaObject.port}set mid(e){this._mediaObject.mid=e}getObject(){return this._mediaObject}setIceParameters(e){this._mediaObject.iceUfrag=e.usernameFragment,this._mediaObject.icePwd=e.password}disable(){delete this._mediaObject.ext,delete this._mediaObject.ssrcs,delete this._mediaObject.ssrcGroups,delete this._mediaObject.simulcast,delete this._mediaObject.simulcast_03,delete this._mediaObject.rids}close(){this._mediaObject.direction="inactive",this._mediaObject.port=0,delete this._mediaObject.ext,delete this._mediaObject.ssrcs,delete this._mediaObject.ssrcGroups,delete this._mediaObject.simulcast,delete this._mediaObject.simulcast_03,delete this._mediaObject.rids,delete this._mediaObject.extmapAllowMixed}}t.MediaSection=n;t.AnswerMediaSection=class extends n{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:r,plainRtpParameters:s,planB:a=!1,offerMediaObject:n,offerRtpParameters:c,answerRtpParameters:l,codecOptions:u,extmapAllowMixed:h=!1}){switch(super({iceParameters:e,iceCandidates:t,dtlsParameters:i,planB:a}),this._mediaObject.mid=String(n.mid),this._mediaObject.type=n.type,this._mediaObject.protocol=n.protocol,s?(this._mediaObject.connection={ip:s.ip,version:s.ipVersion},this._mediaObject.port=s.port):(this._mediaObject.connection={ip:"127.0.0.1",version:4},this._mediaObject.port=7),n.type){case"audio":case"video":this._mediaObject.direction="recvonly",this._mediaObject.rtp=[],this._mediaObject.rtcpFb=[],this._mediaObject.fmtp=[];for(const e of l.codecs){const t={payload:e.payloadType,codec:d(e),rate:e.clockRate};e.channels>1&&(t.encoding=e.channels),this._mediaObject.rtp.push(t);const i=o.clone(e.parameters,{});if(u){const{opusStereo:t,opusFec:r,opusDtx:s,opusMaxPlaybackRate:a,opusPtime:o,videoGoogleStartBitrate:n,videoGoogleMaxBitrate:d,videoGoogleMinBitrate:l}=u,h=c.codecs.find(t=>t.payloadType===e.payloadType);switch(e.mimeType.toLowerCase()){case"audio/opus":void 0!==t&&(h.parameters["sprop-stereo"]=t?1:0,i.stereo=t?1:0),void 0!==r&&(h.parameters.useinbandfec=r?1:0,i.useinbandfec=r?1:0),void 0!==s&&(h.parameters.usedtx=s?1:0,i.usedtx=s?1:0),void 0!==a&&(i.maxplaybackrate=a),void 0!==o&&(h.parameters.ptime=o,i.ptime=o);break;case"video/vp8":case"video/vp9":case"video/h264":case"video/h265":void 0!==n&&(i["x-google-start-bitrate"]=n),void 0!==d&&(i["x-google-max-bitrate"]=d),void 0!==l&&(i["x-google-min-bitrate"]=l)}}const r={payload:e.payloadType,config:""};for(const e of Object.keys(i))r.config&&(r.config+=";"),r.config+=`${e}=${i[e]}`;r.config&&this._mediaObject.fmtp.push(r);for(const t of e.rtcpFeedback)this._mediaObject.rtcpFb.push({payload:e.payloadType,type:t.type,subtype:t.parameter})}this._mediaObject.payloads=l.codecs.map(e=>e.payloadType).join(" "),this._mediaObject.ext=[];for(const e of l.headerExtensions){(n.ext||[]).some(t=>t.uri===e.uri)&&this._mediaObject.ext.push({uri:e.uri,value:e.id})}if(h&&"extmap-allow-mixed"===n.extmapAllowMixed&&(this._mediaObject.extmapAllowMixed="extmap-allow-mixed"),n.simulcast){this._mediaObject.simulcast={dir1:"recv",list1:n.simulcast.list1},this._mediaObject.rids=[];for(const e of n.rids||[])"send"===e.direction&&this._mediaObject.rids.push({id:e.id,direction:"recv"})}else if(n.simulcast_03){this._mediaObject.simulcast_03={value:n.simulcast_03.value.replace(/send/g,"recv")},this._mediaObject.rids=[];for(const e of n.rids||[])"send"===e.direction&&this._mediaObject.rids.push({id:e.id,direction:"recv"})}this._mediaObject.rtcpMux="rtcp-mux",this._mediaObject.rtcpRsize="rtcp-rsize",this._planB&&"video"===this._mediaObject.type&&(this._mediaObject.xGoogleFlag="conference");break;case"application":"number"==typeof n.sctpPort?(this._mediaObject.payloads="webrtc-datachannel",this._mediaObject.sctpPort=r.port,this._mediaObject.maxMessageSize=r.maxMessageSize):n.sctpmap&&(this._mediaObject.payloads=r.port,this._mediaObject.sctpmap={app:"webrtc-datachannel",sctpmapNumber:r.port,maxMessageSize:r.maxMessageSize})}}setDtlsRole(e){switch(e){case"client":this._mediaObject.setup="active";break;case"server":this._mediaObject.setup="passive";break;case"auto":this._mediaObject.setup="actpass"}}};function d(e){const t=new RegExp("^(audio|video)/(.+)","i").exec(e.mimeType);if(!t)throw new TypeError("invalid codec.mimeType");return t[2]}t.OfferMediaSection=class extends n{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:r,plainRtpParameters:s,planB:a=!1,mid:o,kind:n,offerRtpParameters:c,streamId:l,trackId:u,oldDataChannelSpec:h=!1}){switch(super({iceParameters:e,iceCandidates:t,dtlsParameters:i,planB:a}),this._mediaObject.mid=String(o),this._mediaObject.type=n,s?(this._mediaObject.connection={ip:s.ip,version:s.ipVersion},this._mediaObject.protocol="RTP/AVP",this._mediaObject.port=s.port):(this._mediaObject.connection={ip:"127.0.0.1",version:4},this._mediaObject.protocol=r?"UDP/DTLS/SCTP":"UDP/TLS/RTP/SAVPF",this._mediaObject.port=7),n){case"audio":case"video":{this._mediaObject.direction="sendonly",this._mediaObject.rtp=[],this._mediaObject.rtcpFb=[],this._mediaObject.fmtp=[],this._planB||(this._mediaObject.msid=`${l||"-"} ${u}`);for(const e of c.codecs){const t={payload:e.payloadType||e.localPayloadType||125,codec:d(e),rate:e.clockRate};e.channels>1&&(t.encoding=e.channels),this._mediaObject.rtp.push(t);const i={payload:e.payloadType||e.localPayloadType||125,config:""},r=e.parameters||e.localParameters||{};for(const e of Object.keys(r))i.config&&(i.config+=";"),i.config+=`${e}=${r[e]}`;i.config&&this._mediaObject.fmtp.push(i);for(const t of e.rtcpFeedback)this._mediaObject.rtcpFb.push({payload:e.payloadType,type:t.type,subtype:t.parameter})}this._mediaObject.payloads=c.codecs.map(e=>e.payloadType||e.localPayloadType||125).join(" "),this._mediaObject.ext=[];for(const e of c.headerExtensions)this._mediaObject.ext.push({uri:e.uri,value:e.id});this._mediaObject.rtcpMux="rtcp-mux",this._mediaObject.rtcpRsize="rtcp-rsize";const e=c.encodings[0],t=e.ssrc,i=e.rtx&&e.rtx.ssrc?e.rtx.ssrc:void 0;this._mediaObject.ssrcs=[],this._mediaObject.ssrcGroups=[],c.rtcp.cname&&this._mediaObject.ssrcs.push({id:t,attribute:"cname",value:c.rtcp.cname}),this._planB&&this._mediaObject.ssrcs.push({id:t,attribute:"msid",value:`${l||"-"} ${u}`}),i&&(c.rtcp.cname&&this._mediaObject.ssrcs.push({id:i,attribute:"cname",value:c.rtcp.cname}),this._planB&&this._mediaObject.ssrcs.push({id:i,attribute:"msid",value:`${l||"-"} ${u}`}),this._mediaObject.ssrcGroups.push({semantics:"FID",ssrcs:`${t} ${i}`}));break}case"application":h?(this._mediaObject.payloads=r.port,this._mediaObject.sctpmap={app:"webrtc-datachannel",sctpmapNumber:r.port,maxMessageSize:r.maxMessageSize}):(this._mediaObject.payloads="webrtc-datachannel",this._mediaObject.sctpPort=r.port,this._mediaObject.maxMessageSize=r.maxMessageSize)}}setDtlsRole(e){switch(e){case"client":this._mediaObject.setup="active";break;case"server":this._mediaObject.setup="passive";break;case"auto":this._mediaObject.setup="actpass"}}planBReceive({offerRtpParameters:e,streamId:t,trackId:i}){const r=e.encodings[0],s=r.ssrc,a=r.rtx&&r.rtx.ssrc?r.rtx.ssrc:void 0;e.rtcp.cname&&this._mediaObject.ssrcs.push({id:s,attribute:"cname",value:e.rtcp.cname}),this._mediaObject.ssrcs.push({id:s,attribute:"msid",value:`${t||"-"} ${i}`}),a&&(e.rtcp.cname&&this._mediaObject.ssrcs.push({id:a,attribute:"cname",value:e.rtcp.cname}),this._mediaObject.ssrcs.push({id:a,attribute:"msid",value:`${t||"-"} ${i}`}),this._mediaObject.ssrcGroups.push({semantics:"FID",ssrcs:`${s} ${a}`}))}planBStopReceiving({offerRtpParameters:e}){const t=e.encodings[0],i=t.ssrc,r=t.rtx&&t.rtx.ssrc?t.rtx.ssrc:void 0;this._mediaObject.ssrcs=this._mediaObject.ssrcs.filter(e=>e.id!==i&&e.id!==r),r&&(this._mediaObject.ssrcGroups=this._mediaObject.ssrcGroups.filter(e=>e.ssrcs!==`${i} ${r}`))}}},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Firefox60=void 0;const n=a(i(123)),d=o(i(11)),c=o(i(12)),l=i(68),u=i(5),h=i(56),p=a(i(124)),m=a(i(71)),f=i(140),g=a(i(150)),v=i(151),_=a(i(152)),S=a(i(2)),y="Firefox_",R={OS:1024,MIS:1024};let b=0;class T extends f.HandlerInterface{constructor(){super(),this._sendingRemoteRtpParametersByKind={},this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._transportReady=!1,this._appData={},this.signalingState="stable"}static createFactory(){return()=>new T}get name(){return"Firefox60"}close(){if(h.Logger.debug(y,"close()"),this._pc)try{this._pc.onconnectionstatechange=null,this._pc.close()}catch(e){}}async getNativeRtpCapabilities(){h.Logger.debug(y,"getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"});try{e.addTransceiver("audio"),e.addTransceiver("video");const t=await e.createOffer();t.sdp=t.sdp.replace(/a=rtcp-fb:111 transport-cc/g,"a=rtcp-fb:111 transport-cc\r\na=rtcp-fb:111 nack");try{e.close()}catch(e){}const i=n.parse(t.sdp);return g.extractRtpCapabilities({sdpObject:i})}catch(t){try{e.close()}catch(e){}throw t}}async getNativeSctpCapabilities(){return h.Logger.debug(y,"getNativeSctpCapabilities()"),{numStreams:R}}run({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s,iceServers:a,iceTransportPolicy:o,additionalSettings:n,proprietaryConstraints:d,extendedRtpCapabilities:c,appData:l}){h.Logger.debug(y,"run()",l),this._appData=l,this._direction=e,this._sendingRtpParametersByKind={audio:p.getSendingRtpParameters("audio",c),video:p.getSendingRtpParameters("video",c)},this._sendingRemoteRtpParametersByKind={audio:p.getSendingRemoteRtpParameters("audio",c),video:p.getSendingRemoteRtpParameters("video",c)},h.Logger.debug(y,"iceServers: %o",a);const u={iceServers:a||[],iceTransportPolicy:o||"all",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"};l.encodedInsertableStreams&&(u.encodedInsertableStreams=!0),this._pc=new RTCPeerConnection(u,d),this._pc.pcid=b++,this._pc.onconnectionstatechange=()=>{switch(this._pc.connectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed")}},this._pc.onicecandidate=e=>{},this._pc.onicecandidateerror=e=>{h.Logger.debug("onicecandidateerror: ",e)}}async updateIceServers(e){h.Logger.debug(y,"updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(h.Logger.debug(y,"restartIce()"),this._remoteSdp.updateIceParameters(e),this._transportReady)if(this._direction){const e=await this._pc.createOffer({iceRestart:!0});e.sdp.indexOf(`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#`)<0&&(e.sdp=e.sdp.replace(/a=ice-ufrag:([0-9a-zA-Z=+-_\/\\\\]+)/g,`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#${this._direction}`));let t=n.parse(e.sdp);t.media.forEach(e=>{"audio"===e.type&&"send"===this._direction&&e.ext&&e.rtcpFb&&(e.ext=e.ext.filter(e=>-1==e.uri.indexOf("transport-wide-cc")&&-1==e.uri.indexOf("abs-send-time")),e.rtcpFb=e.rtcpFb.map(e=>(e.type=e.type.replace(/transport-cc/g,"nack"),e)))}),e.sdp=n.write(t),h.Logger.debug(y,"restartIce() | calling pc.setLocalDescription()"),this.signalingState="have-local-offer",await this._pc.setLocalDescription(e);const i={type:"answer",sdp:this._remoteSdp.getSdp()};h.Logger.debug(y,"restartIce() | calling pc.setRemoteDescription()"),this.signalingState="stable",await this._pc.setRemoteDescription(i)}else{const e={type:"offer",sdp:this._remoteSdp.getSdp()};h.Logger.debug(y,"restartIce() | calling pc.setRemoteDescription()"),this.signalingState="stable",await this._pc.setRemoteDescription(e);const t=await this._pc.createAnswer();h.Logger.debug(y,"restartIce() | calling pc.setLocalDescription() [answer:%o]",t),this.signalingState="have-local-offer",await this._pc.setLocalDescription(t)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,trackLow:t,encodings:i,codecOptions:r,codec:s,appData:a}){this._assertSendDirection(),h.Logger.debug(y,`[Produce] send() [kind: ${e.kind}, track.id: ${e.id}, appData: ${JSON.stringify(a)}]`),i&&i.length>1&&(i.forEach((e,t)=>{e.rid="r"+t}),i.reverse());const o=m.clone(this._sendingRtpParametersByKind[e.kind],{});o.codecs=l.reduceCodecs(o.codecs,s);let u={},p={};const f=new MediaStream;"audio"===a.mediaType&&this._pc.audioSender?(h.Logger.debug(y,"[Produce] audioSender更新track: ",this._pc.audioSender),this._pc.audioSender.replaceTrack(e)):"video"===a.mediaType&&this._pc.videoSender?(h.Logger.debug(y,"[Produce] videoSender更新track: ",this._pc.videoSender),this._pc.videoSender.replaceTrack(e),this._pc.videoSenderLow&&this._pc.videoSenderLow.track!==t&&(h.Logger.debug(y,"[Produce] videoSenderLow更新track: ",this._pc.videoSenderLow),this._pc.videoSenderLow.replaceTrack(t))):"screenShare"===a.mediaType&&this._pc.screenSender?(h.Logger.debug(y,"[Produce] screenSender更新track: ",this._pc.screenSender),this._pc.screenSender.replaceTrack(e),this._pc.screenSenderLow&&this._pc.screenSenderLow.track!==t&&(h.Logger.debug(y,"[Produce] screenSenderLow更新track: ",this._pc.screenSenderLow),this._pc.screenSenderLow.replaceTrack(t))):(f.addTrack(e),u=this._pc.addTransceiver(e,{direction:"sendonly",streams:[f],sendEncodings:i}),t&&(p=this._pc.addTransceiver(t,{direction:"sendonly",streams:[this._sendStream],sendEncodings:i})),"audio"!==a.mediaType||this._pc.audioSender?"video"!==a.mediaType||this._pc.videoSender?"screenShare"!==a.mediaType||this._pc.screenSender||(this._pc.screenSender=u.sender,this._pc.screenSenderLow=p.sender):(this._pc.videoSender=u.sender,this._pc.videoSenderLow=p.sender):this._pc.audioSender=u.sender),h.Logger.debug(y,"[Produce] send() | [transceivers:%d]",this._pc.getTransceivers().length);let v=await this._pc.createOffer();v.sdp.indexOf(`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#`)<0&&(v.sdp=v.sdp.replace(/a=ice-ufrag:([0-9a-zA-Z=+-_\/\\\\]+)/g,`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#send`));let R,b,T=n.parse(v.sdp),w=void 0;const I=T.media.filter(i=>{const r=this._mapMidTransceiver.get(""+i.mid);return i.type===e.kind&&(!(r&&r.sender&&r.sender.track)||(r.sender.track.id===e.id?(R=i,!1):!t||r.sender.track.id!==t.id||(b=i,!1)))});if(R||(R=I.pop()),t&&!b&&(b=I.pop()),!R){let t="Firefox.send: offerMediaObject with track id not found: "+e.id,i="Firefox.send: 有 track id 的 offerMediaObject 未找到: "+e.id,r="Please contact CommsEase technical support",s="请联系云信技术支持",a=S.IS_ZH?i:t,o=S.IS_ZH?s:r;throw new c.default({code:d.default.SDP_ERROR,message:a,advice:o})}this._transportReady||(w=await this._setupTransport({localDtlsRole:"server",localSdpObject:T}));let E=R.mid;if("number"==typeof E&&(E=""+E),!E){let e="Firefox.send: localId is not found",t="Firefox.send: localId 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new c.default({code:d.default.SDP_ERROR,message:s,advice:a})}let A=null;if(b&&(A=""+b.mid),o.mid=E,o.rtcp.cname=g.getCname({offerMediaObject:R}),i)if(1===i.length){let e=_.getRtpEncodings({offerMediaObject:R});Object.assign(e[0],i[0]),o.encodings=e}else o.encodings=i.reverse();else o.encodings=[],b&&(o.encodings=o.encodings.concat(_.getRtpEncodings({offerMediaObject:b}))),o.encodings=o.encodings.concat(_.getRtpEncodings({offerMediaObject:R}));return o.encodings.length>1&&("video/vp8"===o.codecs[0].mimeType.toLowerCase()||o.codecs[0].mimeType.toLowerCase()),T.media.forEach(e=>{"audio"===e.type&&e.ext&&e.rtcpFb&&(e.ext=e.ext.filter(e=>-1==e.uri.indexOf("transport-wide-cc")&&-1==e.uri.indexOf("abs-send-time")),e.rtcpFb=e.rtcpFb.map(e=>(e.type=e.type.replace(/transport-cc/g,"nack"),e)))}),v.sdp=n.write(T),this._mapMidTransceiver.set(E,u),A&&this._mapMidTransceiver.set(A,p),{localId:E,localIdLow:A,rtpParameters:o,rtpSender:u.sender,rtpSenderLow:p.sender||null,dtlsParameters:w,offer:v}}async fillRemoteRecvSdp({kind:e,iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s,sendingRtpParameters:a,codecOptions:o,offer:d,audioProfile:c,codec:u}){h.Logger.debug(y,"fillRemoteRecvSdp() | calling pc.setLocalDescription()"),await this._pc.setLocalDescription(d),this._remoteSdp||(this._remoteSdp=new v.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s}),this._remoteSdp.updateDtlsRole("client"));const p=m.clone(this._sendingRemoteRtpParametersByKind[e]);p.codecs=l.reduceCodecs(p.codecs,u);let f=n.parse(this._pc.localDescription.sdp);const g=this._remoteSdp.getNextMediaSectionIdx();let _=f.media[g.idx],S=null;a.encodings&&a.encodings.length>1&&(S=f.media[g.idx+1]),this._remoteSdp.send({offerMediaObjectArr:[_,S],reuseMid:g.reuseMid,offerRtpParameters:a,answerRtpParameters:p,codecOptions:o,extmapAllowMixed:!0});const R={type:"answer",sdp:this._remoteSdp.getSdp()};if(h.Logger.debug(y,"audioProfile设置为: ",c),c){let e=null;switch(c){case"speech_low_quality":e="maxplaybackrate=16000;sprop-maxcapturerate=16000;maxaveragebitrate=32000";break;case"speech_standard":e="maxplaybackrate=32000;sprop-maxcapturerate=32000;maxaveragebitrate=36000";break;case"music_standard":e="maxplaybackrate=48000;sprop-maxcapturerate=48000;";break;case"standard_stereo":e="stereo=1;sprop-stereo=1;maxplaybackrate=48000;sprop-maxcapturerate=48000;maxaveragebitrate=56000";break;case"high_quality":e="maxplaybackrate=48000;sprop-maxcapturerate=48000;maxaveragebitrate=128000";break;case"high_quality_stereo":e="stereo=1;sprop-stereo=1;maxplaybackrate=48000;sprop-maxcapturerate=48000;maxaveragebitrate=192000"}R.sdp.indexOf("a=fmtp:111")&&(R.sdp=R.sdp.replace(/a=fmtp:111 ([0-9=;a-zA-Z]*)/,"a=fmtp:111 minptime=10;useinbandfec=1;"+e)),R.sdp=R.sdp.replace(/a=rtcp-fb:111 transport-cc/g,"a=maxptime:60")}h.Logger.debug(y,"fillRemoteRecvSdp() | calling pc.setRemoteDescription()"),await this._pc.setRemoteDescription(R)}async stopSending(e,t){this._assertSendDirection(),h.Logger.debug(y,"stopSending() [localId:%s]",e);const i=this._mapMidTransceiver.get(e);if(!i){let e="Firefox.stopSending: associated RTCRtpTransceiver is not found",t="Firefox.stopSending: RTCRtpTransceiver 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new c.default({code:d.default.SDP_ERROR,message:s,advice:a})}"audio"===t?this._pc.audioSender.replaceTrack(null):"video"===t?(this._pc.videoSender.replaceTrack(null),this._pc.videoSenderLow&&this._pc.videoSenderLow.replaceTrack(null)):"screenShare"===t?(this._pc.screenSender.replaceTrack(null),this._pc.screenSenderLow&&this._pc.screenSenderLow.replaceTrack(null)):(i.sender.replaceTrack(null),this._pc.removeTrack(i.sender),this._remoteSdp.disableMediaSection(i.mid));const r=await this._pc.createOffer();r.sdp.indexOf(`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#`)<0&&(r.sdp=r.sdp.replace(/a=ice-ufrag:([0-9a-zA-Z=+-\/\\\\]+)/g,`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#send`));let s=n.parse(r.sdp);s.media.forEach(e=>{"audio"===e.type&&e.ext&&e.rtcpFb&&(e.ext=e.ext.filter(e=>-1==e.uri.indexOf("transport-wide-cc")&&-1==e.uri.indexOf("abs-send-time")),e.rtcpFb=e.rtcpFb.map(e=>(e.type=e.type.replace(/transport-cc/g,"nack"),e)))}),r.sdp=n.write(s),h.Logger.debug(y,"stopSending() | calling pc.setLocalDescription()");try{await this._pc.setLocalDescription(r)}catch(e){h.Logger.debug(y,"setLocalDescription error = %o",e)}const a={type:"answer",sdp:this._remoteSdp.getSdp()};h.Logger.debug(y,"stopSending() | calling pc.setRemoteDescription()"),await this._pc.setRemoteDescription(a),this._mapMidTransceiver.delete(e)}async replaceTrack(e,t){this._assertSendDirection(),t?h.Logger.debug(y,"replaceTrack() [localId:%s, track.id:%s]",e,t.id):h.Logger.debug(y,"replaceTrack() [localId:%s, no track]",e);const i=this._mapMidTransceiver.get(e);if(!i){let e="Firefox.replaceTrack: associated RTCRtpTransceiver is not found",t="Firefox.replaceTrack: RTCRtpTransceiver 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new c.default({code:d.default.SDP_ERROR,message:s,advice:a})}await i.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this._assertSendDirection(),h.Logger.debug(y,"setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const i=this._mapMidTransceiver.get(e);if(!i){let e="Firefox.setMaxSpatialLayer: associated RTCRtpTransceiver is not found",t="Firefox.setMaxSpatialLayer: RTCRtpTransceiver 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new c.default({code:d.default.SDP_ERROR,message:s,advice:a})}const r=i.sender.getParameters();t=r.encodings.length-1-t,r.encodings.forEach((e,i)=>{e.active=i>=t}),await i.sender.setParameters(r)}async setRtpEncodingParameters(e,t){this._assertSendDirection(),h.Logger.debug(y,"setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const i=this._mapMidTransceiver.get(e);if(!i){let e="Firefox.setRtpEncodingParameters: associated RTCRtpTransceiver is not found",t="Firefox.setRtpEncodingParameters: RTCRtpTransceiver 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new c.default({code:d.default.SDP_ERROR,message:s,advice:a})}const r=i.sender.getParameters();r.encodings.forEach((e,i)=>{r.encodings[i]=Object.assign(Object.assign({},e),t)}),await i.sender.setParameters(r)}async getSenderStats(e){this._assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t){let e="Firefox.getSenderStats: associated RTCRtpTransceiver is not found",t="Firefox.getSenderStats: RTCRtpTransceiver 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new c.default({code:d.default.SDP_ERROR,message:s,advice:a})}return t.sender.getStats()}async recoverTransceiver(e,t,i){h.Logger.debug(y,"recoverTransceiver() [kind:%s, remoteUid:%s, mid: %s]",i,e,t);const r=this._mapMidTransceiver.get(t);r?r.isUseless=!0:h.Logger.debug(y,"recoverTransceiver() transceiver undefined")}async prepareLocalSdp(e,t){h.Logger.debug(y,`[Subscribe] prepareLocalSdp() [kind: ${e}, remoteUid: ${t}]`);let i=-1;for(const t of this._mapMidTransceiver.keys()){const r=this._mapMidTransceiver.get(t);if(!r)continue;const s=r.receiver&&r.receiver.track&&r.receiver.track.kind||e;if(r.isUseless&&s===e){i=t-0,r.isUseless=!1;break}}let r=this._pc.localDescription,s=null;-1===i&&(h.Logger.debug(y,"[Subscribe] prepareLocalSdp() 添加一个M行"),s=this._pc.addTransceiver(e,{direction:"recvonly"}),r=await this._pc.createOffer(),r.sdp.indexOf(`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#`)<0&&(r.sdp=r.sdp.replace(/a=ice-ufrag:([0-9a-zA-Z=+-_\/\\\\]+)/g,`a=ice-ufrag:${this._appData.cid}#${this._appData.uid}#recv`),r.sdp=r.sdp.replace(/a=rtcp-fb:111 transport-cc/g,"a=rtcp-fb:111 transport-cc\r\na=rtcp-fb:111 nack")));const a=n.parse(r.sdp);let o=void 0;this._transportReady||(o=await this._setupTransport({localDtlsRole:"server",localSdpObject:a}));const d=g.extractRtpCapabilities({sdpObject:a});return-1===i&&(i=a.media.length-1,this._mapMidTransceiver.set(""+i,s)),{dtlsParameters:o,rtpCapabilities:d,offer:r,mid:i,iceUfragReg:""}}async receive({iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:r,trackId:s,kind:a,rtpParameters:o,offer:n,probeSSrc:l=-1,remoteUid:p,extendedRtpCapabilities:m,appData:f}){this._assertRecvDirection(),h.Logger.debug(y,`[Subscribe] receive() [trackId: ${s}, kind: ${a}, remoteUid: ${p}]`),this._remoteSdp||(this._remoteSdp=new v.RemoteSdp({iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:r}),this._remoteSdp.updateDtlsRole("client"));let g=o&&o.mid||f.mid;if(h.Logger.debug(y,"[Subscribe] receive() mid: "+g),o.mid)this._remoteSdp.receive({mid:g,kind:a,offerRtpParameters:o,streamId:o.rtcp.cname,trackId:s});else{h.Logger.debug(y,"[Subscribe] receive() 容错流程");const e=[];m.codecs.forEach(t=>{if(t.kind===a){const i=Object.assign({},t);i.parameters=i.parameters||i.localParameters,i.payloadType=i.payloadType||i.localPayloadType,e.push(i)}});const t={mid:g,kind:a,offerRtpParameters:{codecs:e,encodings:[{ssrc:0}],headerExtensions:[],rtcp:{},mid:g},streamId:a,trackId:s,reuseMediaSection:void 0};this._remoteSdp.receive(t),this._remoteSdp.disableMediaSection(""+g)}const _={type:"answer",sdp:this._remoteSdp.getSdp()};_.sdp.indexOf("a=fmtp:111")&&(_.sdp=_.sdp.replace(/a=fmtp:111 ([0-9=;a-zA-Z]*)/,"a=fmtp:111 minptime=10;stereo=1;sprop-stereo=1;useinbandfec=1")),u.getParameters().enableUdpCandidate||(_.sdp=_.sdp.replace(/\r\na=candidate:udpcandidate[^\r]+/g,"")),u.getParameters().enableTcpCandidate||(_.sdp=_.sdp.replace(/\r\na=candidate:tcpcandidate[^\r]+/g,"")),h.Logger.debug(y,"[Subscribe] receive() | calling pc.setLocalDescription()"),this.signalingState="have-local-offer",await this._pc.setLocalDescription(n),h.Logger.debug(y,"[Subscribe] receive() | calling pc.setRemoteDescription()"),this.signalingState="stable",await this._pc.setRemoteDescription(_);const R=this._pc.getTransceivers().find(e=>e.mid===g);if(!R){let e="Firefox.receive: associated RTCRtpTransceiver is not found",t="Firefox.receive: RTCRtpTransceiver 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new c.default({code:d.default.SDP_ERROR,message:s,advice:a})}return R.isUseless=!o.mid,this._mapMidTransceiver.set(g,R),{localId:g,track:R.receiver.track,rtpReceiver:R.receiver}}async stopReceiving(e){this._assertRecvDirection(),h.Logger.debug(y,"stopReceiving() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t||!t.mid){let e="Firefox.stopReceiving: associated RTCRtpTransceiver is not found",t="Firefox.stopReceiving: RTCRtpTransceiver 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new c.default({code:d.default.SDP_ERROR,message:s,advice:a})}t.receiver&&t.receiver.track&&t.receiver.track&&"audio"===t.receiver.track.kind||(t.isUseless=!0),this._remoteSdp.disableMediaSection(t.mid)}async getReceiverStats(e){this._assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t){let e="Firefox.getReceiverStats: associated RTCRtpTransceiver is not found",t="Firefox.getReceiverStats: RTCRtpTransceiver 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new c.default({code:d.default.SDP_ERROR,message:s,advice:a})}return t.receiver.getStats()}async _setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=n.parse(this._pc.localDescription.sdp));const i=g.extractDtlsParameters({sdpObject:t});return i.role=e,this._transportReady=!0,i}_assertSendDirection(){if("send"!==this._direction){let e="_assertSendDirection: invalid operation",t="_assertSendDirection: 操作异常",i="method can just be called for handlers with send direction",r="只能在 send 方向中调用",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new c.default({code:d.default.INVALID_OPERATION_ERROR,message:s,advice:a})}}_assertRecvDirection(){if("recv"!==this._direction){let e="_assertRecvDirection: invalid operation",t="_assertRecvDirection: 操作异常",i="method can just be called for handlers with recv direction",r="只能在 recv 方向中调用",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new c.default({code:d.default.INVALID_OPERATION_ERROR,message:s,advice:a})}}}t.Firefox60=T},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Safari12=void 0;const n=a(i(123)),d=o(i(11)),c=o(i(12)),l=i(68),u=i(227),h=i(5),p=i(56),m=a(i(124)),f=a(i(71)),g=i(140),v=a(i(150)),_=i(151),S=a(i(152)),y=a(i(2)),R="Safari_",b={OS:1024,MIS:1024};let T=0;class w extends g.HandlerInterface{constructor(){super(),this._sendingRemoteRtpParametersByKind={},this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._transportReady=!1,this._appData={}}static createFactory(){return()=>new w}get name(){return"Safari12"}close(){if(p.Logger.debug(R,"close()"),this._pc)try{this._pc.close()}catch(e){}}async getNativeRtpCapabilities(){p.Logger.debug(R,"getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"});try{e.addTransceiver("audio"),e.addTransceiver("video");const t=await e.createOffer();t.sdp=t.sdp.replace(/a=rtcp-fb:111 transport-cc/g,"a=rtcp-fb:111 transport-cc\r\na=rtcp-fb:111 nack");try{e.close()}catch(e){}const i=n.parse(t.sdp);return v.extractRtpCapabilities({sdpObject:i})}catch(t){try{e.close()}catch(e){}throw t}}async getNativeSctpCapabilities(){return p.Logger.debug(R,"getNativeSctpCapabilities()"),{numStreams:b}}run({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s,iceServers:a,iceTransportPolicy:o,additionalSettings:n,proprietaryConstraints:d,extendedRtpCapabilities:c,appData:l}){p.Logger.debug(R,"run()"),this._direction=e,this._appData=l,this._sendingRtpParametersByKind={audio:m.getSendingRtpParameters("audio",c),video:m.getSendingRtpParameters("video",c)},this._sendingRemoteRtpParametersByKind={audio:m.getSendingRemoteRtpParameters("audio",c),video:m.getSendingRemoteRtpParameters("video",c)},this._pc=new RTCPeerConnection(Object.assign({iceServers:a||[],iceTransportPolicy:o||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"},n),d),this._pc.pcid=T++,this._pc.onconnectionstatechange=()=>{switch(this._pc.connectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed")}}}async updateIceServers(e){p.Logger.debug(R,"updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(p.Logger.debug(R,"restartIce()"),this._remoteSdp.updateIceParameters(e),this._transportReady)if(this._direction){const e=await this._pc.createOffer({iceRestart:!0});let t=n.parse(e.sdp);t.media.forEach(e=>{"audio"===e.type&&"send"===this._direction&&e.ext&&e.rtcpFb&&(e.ext=e.ext.filter(e=>-1==e.uri.indexOf("transport-wide-cc")&&-1==e.uri.indexOf("abs-send-time")),e.rtcpFb=e.rtcpFb.map(e=>(e.type=e.type.replace(/transport-cc/g,"nack"),e)))}),e.sdp=n.write(t),p.Logger.debug(R,"restartIce() | calling pc.setLocalDescription() [offer:%o]",e),await this._pc.setLocalDescription(e);const i={type:"answer",sdp:this._remoteSdp.getSdp()};p.Logger.debug(R,"restartIce() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}else{const e={type:"offer",sdp:this._remoteSdp.getSdp()};p.Logger.debug(R,"restartIce() | calling pc.setRemoteDescription() [offer:%o]",e),await this._pc.setRemoteDescription(e);const t=await this._pc.createAnswer();p.Logger.debug(R,"restartIce() | calling pc.setLocalDescription() [answer:%o]",t),await this._pc.setLocalDescription(t)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,trackLow:t,encodings:i,codecOptions:r,codec:s,appData:a}){this._assertSendDirection(),p.Logger.debug(R,`send() [kind: ${e.kind}, track.id: ${e.id}, appData: ${JSON.stringify(a)}]`);const o=f.clone(this._sendingRtpParametersByKind[e.kind],{});o.codecs=l.reduceCodecs(o.codecs,s);let u={},h={};const m=new MediaStream;"audio"===a.mediaType&&this._pc.audioSender?(p.Logger.warn(R,"audioSender更新track: ",this._pc.audioSender.track,"=>",e),this._pc.audioSender.replaceTrack(e)):"video"===a.mediaType&&this._pc.videoSender?(p.Logger.warn(R,"videoSender更新track: ",this._pc.videoSender.track,"=>",e),this._pc.videoSender.replaceTrack(e),this._pc.videoSenderLow&&this._pc.videoSenderLow.track!==t&&(p.Logger.debug(R,"videoSenderLow更新track: ",this._pc.videoSenderLow),this._pc.videoSenderLow.replaceTrack(t))):"screenShare"===a.mediaType&&this._pc.screenSender?(p.Logger.warn(R,"screenSender更新track: ",this._pc.screenSender.track,"=>",e),this._pc.screenSender.replaceTrack(e),this._pc.screenSenderLow&&this._pc.screenSenderLow.track!==t&&(p.Logger.debug(R,"screenSenderLow更新track: ",this._pc.screenSenderLow),this._pc.screenSenderLow.replaceTrack(t))):(m.addTrack(e),u=this._pc.addTransceiver(e,{direction:"sendonly",streams:[m],sendEncodings:i}),t&&(h=this._pc.addTransceiver(t,{direction:"sendonly",streams:[this._sendStream],sendEncodings:i})),"audio"!==a.mediaType||this._pc.audioSender?"video"!==a.mediaType||this._pc.videoSender?"screenShare"!==a.mediaType||this._pc.screenSender||(this._pc.screenSender=u.sender,this._pc.screenSenderLow=h.sender):(this._pc.videoSender=u.sender,this._pc.videoSenderLow=h.sender):this._pc.audioSender=u.sender),"audio"!==a.mediaType||this._pc.audioSender?"video"!==a.mediaType||this._pc.videoSender?"screenShare"!==a.mediaType||this._pc.screenSender||(this._pc.screenSender=u.sender):this._pc.videoSender=u.sender:this._pc.audioSender=u.sender,p.Logger.debug(R,"send() | [transceivers:%d]",this._pc.getTransceivers().length);let g,_,b=await this._pc.createOffer(),T=n.parse(b.sdp),w=void 0;const I=T.media.filter(i=>{const r=this._mapMidTransceiver.get(""+i.mid);return i.type===e.kind&&(!(r&&r.sender&&r.sender.track)||(r.sender.track.id===e.id?(g=i,!1):!t||r.sender.track.id!==t.id||(_=i,!1)))});if(g||(g=I.pop()),t&&!_&&(_=I.pop()),!g){let t="Safari.send: offerMediaObject with track id not found: "+e.id,i="Safari.send: 有 track id 的 offerMediaObject 未找到: "+e.id,r="Please contact CommsEase technical support",s="请联系云信技术支持",a=y.IS_ZH?i:t,o=y.IS_ZH?s:r;throw new c.default({code:d.default.SDP_ERROR,message:a,advice:o})}this._transportReady||(w=await this._setupTransport({localDtlsRole:"server",localSdpObject:T}));let E=g.mid;if("number"==typeof E&&(E=""+E),!E){let e="Safari.send: localId is not found",t="Safari.send: localId 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=y.IS_ZH?t:e,a=y.IS_ZH?r:i;throw new c.default({code:d.default.SDP_ERROR,message:s,advice:a})}let A=null;if(_&&(A=""+_.mid),o.mid=E,p.Logger.debug(R,"要检查M行: ",g),o.rtcp.cname=v.getCname({offerMediaObject:g}),i)if(1===i.length){let e=S.getRtpEncodings({offerMediaObject:g});Object.assign(e[0],i[0]),o.encodings=e}else o.encodings=i;else o.encodings=[],_&&(o.encodings=o.encodings.concat(S.getRtpEncodings({offerMediaObject:_}))),o.encodings=o.encodings.concat(S.getRtpEncodings({offerMediaObject:g}));return o.encodings.length>1&&("video/vp8"===o.codecs[0].mimeType.toLowerCase()||"video/h264"===o.codecs[0].mimeType.toLowerCase())&&T.media.forEach(e=>{"audio"===e.type&&e.ext&&e.rtcpFb&&(e.ext=e.ext.filter(e=>-1==e.uri.indexOf("transport-wide-cc")&&-1==e.uri.indexOf("abs-send-time")),e.rtcpFb=e.rtcpFb.map(e=>(e.type=e.type.replace(/transport-cc/g,"nack"),e)))}),b.sdp=n.write(T),this._mapMidTransceiver.set(E,u),A&&this._mapMidTransceiver.set(A,h),{localId:E,localIdLow:A,rtpParameters:o,rtpSender:u.sender,rtpSenderLow:h.sender||null,dtlsParameters:w,offer:b}}async fillRemoteRecvSdp({kind:e,iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s,sendingRtpParameters:a,codecOptions:o,offer:d,audioProfile:c,codec:h}){let m=n.parse(d.sdp);m.media.forEach(e=>{"audio"===e.type&&e.ext&&e.rtcpFb&&(e.ext=e.ext.filter(e=>-1==e.uri.indexOf("transport-wide-cc")&&-1==e.uri.indexOf("abs-send-time")),e.rtcpFb=e.rtcpFb.map(e=>(e.type=e.type.replace(/transport-cc/g,"nack"),e)))}),d.sdp=n.write(m),p.Logger.debug(R,"fillRemoteRecvSdp() | calling pc.setLocalDescription()"),await this._pc.setLocalDescription(d),this._remoteSdp||(this._remoteSdp=new _.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:r,sctpParameters:s}),this._remoteSdp.updateDtlsRole("client"));const g=f.clone(this._sendingRemoteRtpParametersByKind[e]);g.codecs=l.reduceCodecs(g.codecs,h);let v=n.parse(this._pc.localDescription.sdp);const S=this._remoteSdp.getNextMediaSectionIdx();let y=v.media[S.idx],b=null;a.encodings&&a.encodings.length>1&&(b=v.media[S.idx+1]),this._remoteSdp.send({offerMediaObjectArr:[y,b],reuseMid:S.reuseMid,offerRtpParameters:a,answerRtpParameters:g,codecOptions:o,extmapAllowMixed:!0});const T={type:"answer",sdp:this._remoteSdp.getSdp()};if(p.Logger.debug(R,"audioProfile设置为: ",c),c){let e=null;switch(c){case"speech_low_quality":e="maxplaybackrate=16000;sprop-maxcapturerate=16000;maxaveragebitrate=32000";break;case"speech_standard":e="maxplaybackrate=32000;sprop-maxcapturerate=32000;maxaveragebitrate=36000";break;case"music_standard":e="maxplaybackrate=48000;sprop-maxcapturerate=48000;";break;case"standard_stereo":e="stereo=1;sprop-stereo=1;maxplaybackrate=48000;sprop-maxcapturerate=48000;maxaveragebitrate=56000";break;case"high_quality":e="maxplaybackrate=48000;sprop-maxcapturerate=48000;maxaveragebitrate=128000";break;case"high_quality_stereo":e="stereo=1;sprop-stereo=1;maxplaybackrate=48000;sprop-maxcapturerate=48000;maxaveragebitrate=192000"}T.sdp.indexOf("a=fmtp:111")&&(T.sdp=T.sdp.replace(/a=fmtp:111 ([0-9=;a-zA-Z]*)/,"a=fmtp:111 minptime=10;useinbandfec=1;"+e)),T.sdp=T.sdp.replace(/a=rtcp-fb:111 transport-cc/g,"a=maxptime:60")}u.canShimVideoOrientation(d,T)&&u.shimVideoOrientation(d,T),p.Logger.debug(R,"fillRemoteRecvSdp() | calling pc.setRemoteDescription() [answer:%o]",T.sdp),await this._pc.setRemoteDescription(T)}async stopSending(e,t){this._assertSendDirection(),p.Logger.debug(R,"stopSending() [localId:%s]",e);const i=this._mapMidTransceiver.get(e);if(!i){let e="Safari.stopSending: associated RTCRtpTransceiver is not found",t="Safari.stopSending: RTCRtpTransceiver 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=y.IS_ZH?t:e,a=y.IS_ZH?r:i;throw new c.default({code:d.default.SDP_ERROR,message:s,advice:a})}"audio"===t?(this._pc.audioSender.replaceTrack(null),p.Logger.debug(R,"删除发送的audio track: ",this._pc.audioSender)):"video"===t?(this._pc.videoSenderLow&&this._pc.videoSenderLow.replaceTrack(null),this._pc.videoSender.replaceTrack(null),p.Logger.debug(R,"删除发送的video track: ",this._pc.videoSender)):"screenShare"===t?(this._pc.screenSender.replaceTrack(null),this._pc.screenSenderLow&&this._pc.screenSenderLow.replaceTrack(null),p.Logger.debug(R,"删除发送的screen track: ",this._pc.screenSender)):i.sender.replaceTrack(null);const r=await this._pc.createOffer();let s=n.parse(r.sdp);s.media.forEach(e=>{"audio"===e.type&&e.ext&&e.rtcpFb&&(e.ext=e.ext.filter(e=>-1==e.uri.indexOf("transport-wide-cc")&&-1==e.uri.indexOf("abs-send-time")),e.rtcpFb=e.rtcpFb.map(e=>(e.type=e.type.replace(/transport-cc/g,"nack"),e)))}),r.sdp=n.write(s),p.Logger.debug(R,"stopSending() | calling pc.setLocalDescription() [offer:%o]",r.sdp),await this._pc.setLocalDescription(r);const a={type:"answer",sdp:this._remoteSdp.getSdp()};p.Logger.debug(R,"stopSending() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async replaceTrack(e,t){this._assertSendDirection(),t?p.Logger.debug(R,"replaceTrack() [localId:%s, track.id:%s]",e,t.id):p.Logger.debug(R,"replaceTrack() [localId:%s, no track]",e);const i=this._mapMidTransceiver.get(e);if(!i){let e="Safari.replaceTrack: associated RTCRtpTransceiver is not found",t="Safari.replaceTrack: RTCRtpTransceiver 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=y.IS_ZH?t:e,a=y.IS_ZH?r:i;throw new c.default({code:d.default.SDP_ERROR,message:s,advice:a})}await i.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this._assertSendDirection(),p.Logger.debug(R,"setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const i=this._mapMidTransceiver.get(e);if(!i){let e="Safari.setMaxSpatialLayer: associated RTCRtpTransceiver is not found",t="Safari.setMaxSpatialLayer: RTCRtpTransceiver 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=y.IS_ZH?t:e,a=y.IS_ZH?r:i;throw new c.default({code:d.default.SDP_ERROR,message:s,advice:a})}const r=i.sender.getParameters();r.encodings.forEach((e,i)=>{e.active=i<=t}),await i.sender.setParameters(r)}async setRtpEncodingParameters(e,t){this._assertSendDirection(),p.Logger.debug(R,"setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const i=this._mapMidTransceiver.get(e);if(!i){let e="Safari.setRtpEncodingParameters: associated RTCRtpTransceiver is not found",t="Safari.setRtpEncodingParameters: RTCRtpTransceiver 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=y.IS_ZH?t:e,a=y.IS_ZH?r:i;throw new c.default({code:d.default.SDP_ERROR,message:s,advice:a})}const r=i.sender.getParameters();r.encodings.forEach((e,i)=>{r.encodings[i]=Object.assign(Object.assign({},e),t)}),await i.sender.setParameters(r)}async getSenderStats(e){this._assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t){let e="Safari.getSenderStats: associated RTCRtpTransceiver is not found",t="Safari.getSenderStats: RTCRtpTransceiver 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=y.IS_ZH?t:e,a=y.IS_ZH?r:i;throw new c.default({code:d.default.SDP_ERROR,message:s,advice:a})}return t.sender.getStats()}async recoverTransceiver(e,t,i){p.Logger.debug(R,"recoverTransceiver() [kind:%s, remoteUid:%s, mid: %s]",i,e,t);const r=this._mapMidTransceiver.get(t);r?r.isUseless=!0:p.Logger.debug(R,"recoverTransceiver() transceiver undefined")}async prepareLocalSdp(e,t){p.Logger.debug(R,`[Subscribe] prepareLocalSdp() [kind: ${e}, remoteUid: ${t}]`);let i=-1;for(const t of this._mapMidTransceiver.keys()){const r=this._mapMidTransceiver.get(t);if(!r)continue;const s=r.receiver&&r.receiver.track&&r.receiver.track.kind||e;if(r.isUseless&&s===e){i=t-0,r.isUseless=!1;break}}let r=null,s=null;-1===i?(p.Logger.debug(R,"[Subscribe] prepareLocalSdp() 添加一个M行"),s=this._pc.addTransceiver(e,{direction:"recvonly"}),r=await this._pc.createOffer(),r.sdp=r.sdp.replace(/a=rtcp-fb:111 transport-cc/g,"a=rtcp-fb:111 transport-cc\r\na=rtcp-fb:111 nack")):this._pc.localDescription&&(r={type:this._pc.localDescription.type,sdp:this._pc.localDescription.sdp});const a=n.parse(r.sdp);let o=void 0;this._transportReady||(o=await this._setupTransport({localDtlsRole:"server",localSdpObject:a}));const d=v.extractRtpCapabilities({sdpObject:a});return-1===i&&(i=a.media.length-1,this._mapMidTransceiver.set(""+i,s)),{dtlsParameters:o,rtpCapabilities:d,offer:r,mid:i,iceUfragReg:""}}async receive({iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:r,trackId:s,kind:a,rtpParameters:o,offer:n,probeSSrc:l=-1,remoteUid:u,extendedRtpCapabilities:m,appData:f}){this._assertRecvDirection(),p.Logger.debug(R,`[Subscribe] receive() [trackId: ${s}, kind: ${a}, remoteUid: ${u}]`),this._remoteSdp||(this._remoteSdp=new _.RemoteSdp({iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:r}),this._remoteSdp.updateDtlsRole("client"));let g=o&&o.mid||f.mid;if(p.Logger.debug(R,"receive() mid: "+g),o.mid)this._remoteSdp.receive({mid:g,kind:a,offerRtpParameters:o,streamId:o.rtcp.cname,trackId:s});else{p.Logger.debug(R,"[Subscribe] receive() 容错流程");const e=[];m.codecs.forEach(t=>{if(t.kind===a){const i=Object.assign({},t);i.parameters=i.parameters||i.localParameters,i.payloadType=i.payloadType||i.localPayloadType,e.push(i)}});const t={mid:g,kind:a,offerRtpParameters:{codecs:e,encodings:[{ssrc:0}],headerExtensions:[],rtcp:{},mid:g},streamId:a,trackId:s,reuseMediaSection:void 0};this._remoteSdp.receive(t),this._remoteSdp.disableMediaSection(""+g)}let v={type:"answer",sdp:this._remoteSdp.getSdp()};v.sdp.indexOf("a=fmtp:111")&&(v.sdp=v.sdp.replace(/a=fmtp:111 ([0-9=;a-zA-Z]*)/,"a=fmtp:111 minptime=10;stereo=1;sprop-stereo=1;useinbandfec=1")),h.getParameters().enableUdpCandidate||(v.sdp=v.sdp.replace(/\r\na=candidate:udpcandidate[^\r]+/g,"")),h.getParameters().enableTcpCandidate||(v.sdp=v.sdp.replace(/\r\na=candidate:tcpcandidate[^\r]+/g,"")),p.Logger.debug(R,"[Subscribe] receive() | calling pc.setLocalDescription()"),await this._pc.setLocalDescription(n),p.Logger.debug(R,"[Subscribe] receive() | calling pc.setRemoteDescription()"),await this._pc.setRemoteDescription(v);const S=this._pc.getTransceivers().find(e=>e.mid===g);if(!S){let e="Safari.receive: associated RTCRtpTransceiver is not found",t="Safari.receive: RTCRtpTransceiver 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=y.IS_ZH?t:e,a=y.IS_ZH?r:i;throw new c.default({code:d.default.SDP_ERROR,message:s,advice:a})}return this._mapMidTransceiver.set(g,S),{localId:g,track:S.receiver.track,rtpReceiver:S.receiver}}async stopReceiving(e){this._assertRecvDirection(),p.Logger.debug(R,"stopReceiving() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t||!t.mid){let e="Safari.stopReceiving: associated RTCRtpTransceiver is not found",t="Safari.stopReceiving: RTCRtpTransceiver 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=y.IS_ZH?t:e,a=y.IS_ZH?r:i;throw new c.default({code:d.default.SDP_ERROR,message:s,advice:a})}p.Logger.debug(R,"transceiver: ",t),t.receiver&&t.receiver.track&&t.receiver.track&&"audio"===t.receiver.track.kind||(t.isUseless=!0),this._remoteSdp.disableMediaSection(t.mid);const i=this._pc.localDescription;p.Logger.debug(R,"stopReceiving() | calling pc.setLocalDescription()"),await this._pc.setLocalDescription(i);const r={type:"answer",sdp:this._remoteSdp.getSdp()};p.Logger.debug(R,"stopReceiving() | calling pc.setRemoteDescription() [answer:%o]",r.sdp),await this._pc.setRemoteDescription(r)}async getReceiverStats(e){this._assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t){let e="Safari.getReceiverStats: associated RTCRtpTransceiver is not found",t="Safari.getReceiverStats: RTCRtpTransceiver 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=y.IS_ZH?t:e,a=y.IS_ZH?r:i;throw new c.default({code:d.default.SDP_ERROR,message:s,advice:a})}return t.receiver.getStats()}async _setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=n.parse(this._pc.localDescription.sdp));const i=v.extractDtlsParameters({sdpObject:t});return i.role=e,this._transportReady=!0,i}_assertSendDirection(){if("send"!==this._direction){let e="_assertSendDirection: invalid operation",t="_assertSendDirection: 操作异常",i="method can just be called for handlers with send direction",r="只能在 send 方向中调用",s=y.IS_ZH?t:e,a=y.IS_ZH?r:i;throw new c.default({code:d.default.INVALID_OPERATION_ERROR,message:s,advice:a})}}_assertRecvDirection(){if("recv"!==this._direction){let e="_assertRecvDirection: invalid operation",t="_assertRecvDirection: 操作异常",i="method can just be called for handlers with recv direction",r="只能在 recv 方向中调用",s=y.IS_ZH?t:e,a=y.IS_ZH?r:i;throw new c.default({code:d.default.INVALID_OPERATION_ERROR,message:s,advice:a})}}}t.Safari12=w},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.shimVideoOrientation=t.canShimVideoOrientation=void 0;const o=i(5),n=a(i(2)),d=i(67),c="a=extmap:4 ";t.canShimVideoOrientation=function(e,t){if("never"===o.getParameters().shimVideoOrientation)return!1;if("ios151"===o.getParameters().shimVideoOrientation){if(!n.IS_IOS)return!1;if(n.IS_SAFARI){if(parseFloat(d.getBrowserInfo().browserVersion)<15.1)return!1}else{if(!n.IS_WECHAT)return!1;if(!navigator.userAgent.match(/OS 15_[1-9]/))return!1}}if(-1===t.sdp.indexOf("H264")||-1===t.sdp.indexOf("m=video"))return!1;const i=e.sdp.match(/\r\n(.*3gpp\:video-orientation.*)\r\n/);return!!(i&&e.sdp.indexOf(c)>-1&&-1===t.sdp.indexOf(i[1]))},t.shimVideoOrientation=function(e,t){if(-1===t.sdp.indexOf("H264")||-1===t.sdp.indexOf("m=video"))return;const i=e.sdp.match(/\r\n(.*3gpp\:video-orientation.*)\r\n/);if(i&&e.sdp.indexOf(c)>-1&&-1===t.sdp.indexOf(i[1])){const e=i[1];console.log(`shimVideoOrientation for ${d.getBrowserInfo().browserName} ${d.getBrowserInfo().browserVersion} ${e}`),t.sdp=t.sdp.split(c).join(e+"\r\n"+c)}else console.error("Failed to shimVideoOrientation",i,e.sdp.indexOf(c),i&&t.sdp.indexOf(i[1]))}},function(e,t,i){var r=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))((function(s,a){function o(e){try{d(r.next(e))}catch(e){a(e)}}function n(e){try{d(r.throw(e))}catch(e){a(e)}}function d(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,n)}d((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});t.AwaitQueue=class{constructor({ClosedErrorClass:e=Error,StoppedErrorClass:t=Error}={ClosedErrorClass:Error,StoppedErrorClass:Error}){this.closed=!1,this.pendingTasks=[],this.ClosedErrorClass=Error,this.StoppedErrorClass=Error,this.ClosedErrorClass=e,this.StoppedErrorClass=t}get size(){return this.pendingTasks.length}close(){if(!this.closed){this.closed=!0;for(const e of this.pendingTasks)e.stopped=!0,e.reject(new this.ClosedErrorClass("AwaitQueue closed"));this.pendingTasks.length=0}}push(e,t){return r(this,void 0,void 0,(function*(){if(this.closed)throw new this.ClosedErrorClass("AwaitQueue closed");if("function"!=typeof e)throw new TypeError("given task is not a function");if(!e.name&&t)try{Object.defineProperty(e,"name",{value:t})}catch(e){}return new Promise((i,r)=>{const s={task:e,name:t,resolve:i,reject:r,stopped:!1,enqueuedAt:new Date,executedAt:void 0};this.pendingTasks.push(s),1===this.pendingTasks.length&&this.next()})}))}stop(){if(!this.closed){for(const e of this.pendingTasks)e.stopped=!0,e.reject(new this.StoppedErrorClass("AwaitQueue stopped"));this.pendingTasks.length=0}}dump(){const e=new Date;return this.pendingTasks.map(t=>({task:t.task,name:t.name,enqueuedTime:t.executedAt?t.executedAt.getTime()-t.enqueuedAt.getTime():e.getTime()-t.enqueuedAt.getTime(),executingTime:t.executedAt?e.getTime()-t.executedAt.getTime():0}))}next(){return r(this,void 0,void 0,(function*(){const e=this.pendingTasks[0];e&&(yield this.executeTask(e),this.pendingTasks.shift(),this.next())}))}executeTask(e){return r(this,void 0,void 0,(function*(){if(!e.stopped){e.executedAt=new Date;try{const t=yield e.task();if(e.stopped)return;e.resolve(t)}catch(t){if(e.stopped)return;e.reject(t)}}}))}}},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__exportStar||function(e,t){for(var i in e)"default"===i||Object.prototype.hasOwnProperty.call(t,i)||r(t,e,i)};Object.defineProperty(t,"__esModule",{value:!0}),s(i(170),t),s(i(165),t),s(i(122),t),s(i(140),t),s(i(171),t),s(i(230),t),s(i(231),t),s(i(169),t)},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0})},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0})},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.parse=void 0;const r=new RegExp("^[LS]([1-9]\\d{0,1})T([1-9]\\d{0,1})");t.parse=function(e){const t=r.exec(e||"");return t?{spatialLayers:Number(t[1]),temporalLayers:Number(t[2])}:{spatialLayers:1,temporalLayers:1}}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.VideoTrackLow=void 0;const r=i(234),s=i(172),a=i(118),o=i(5),n=i(139),d=i(242),c=i(2);t.VideoTrackLow=class{constructor(e){var t;this.width=0,this.height=0,this.canvas=document.createElement("canvas"),this.context=n.get2DContext(this.canvas),this.timer=null,this.lastDrawAt=0,this.lastState="clear",this.high={sender:null,track:null,stream:new MediaStream,videoDom:r.getAutoplayVideo(),width:0,height:0},this.sender=null,this.emptyTrackInfo={track:null,count:0,visible:"unknown"},this.mediaType=e.mediaType,"video"===this.mediaType?(this.WIDTH_MAX=o.getParameters().videoLowMaxWidth,this.HEIGHT_MAX=o.getParameters().videoLowMaxHeight,this.FRAME_RATE=o.getParameters().videoLowFramerate):(this.WIDTH_MAX=o.getParameters().screenLowMaxWidth,this.HEIGHT_MAX=o.getParameters().screenLowMaxHeight,this.FRAME_RATE=o.getParameters().screenLowFramerate),this.stream=this.canvas.captureStream?this.canvas.captureStream(this.FRAME_RATE):null,this.track=(null===(t=this.stream)||void 0===t?void 0:t.getTracks()[0])||null,a.watchTrack(this.track),this.logger=e.logger.getChild(()=>{let e=`low_${this.mediaType} ${this.width}x${this.height}`;return this.high.sender?this.high.sender.track?"live"!==this.high.sender.track.readyState?e+=" HIGH_STATE_"+this.high.sender.track.readyState:(this.high.sender&&this.high.sender.track!==this.high.track&&(e+=" MISMATCH"),this.high.sender.track.enabled||(e+=" muted"),e+=` 【${this.high.sender.track.label}】`):e+=" NO_HIGH_TRACK":e+=" NO_HIGH_SENDER",this.track?"live"!==this.track.readyState&&(e+=" LOW_STATE_"+this.track.readyState):e+=" NO_LOW_TRACK",e}),this.track?this.context?this.timer=s.getRTCTimer().setInterval(()=>{this.drawOneFrame()},1e3/this.FRAME_RATE):(this.logger.error("CanvasContext无法顺利启动"),this.stream=null,this.track=null):this.logger.error("当前浏览器不支持CanvasTrack")}_correctSize(){if(this.high.sender&&this._bindTrack(this.high.sender.track),this.high.width!==this.high.videoDom.videoWidth||this.high.height!==this.high.videoDom.videoHeight){const e=this.high.videoDom.videoWidth/this.high.videoDom.videoHeight;let t=this.width,i=this.height;const r=e>1?this.WIDTH_MAX:this.HEIGHT_MAX,s=e>1?this.HEIGHT_MAX:this.WIDTH_MAX;e>r/s?(i=Math.floor(this.high.videoDom.videoHeight/this.high.videoDom.videoWidth*r),i>0?t=r:(t=0,i=0)):(i=s,t=Math.floor(this.high.videoDom.videoWidth/this.high.videoDom.videoHeight*s),t>0?i=s:(t=0,i=0)),this.logger.log(`High resize ${this.high.width}x${this.high.height}=>${this.high.videoDom.videoWidth}x${this.high.videoDom.videoHeight}, low: ${this.width}x${this.height}=>${t}x${i}`),this.high.width=this.high.videoDom.videoWidth,this.high.height=this.high.videoDom.videoHeight,this.width=t,this.height=i,this.canvas.width=this.width,this.canvas.height=this.height}}destroy(){var e;this.timer&&(s.getRTCTimer().clearInterval(this.timer),this.timer=null),null===(e=this.track)||void 0===e||e.stop(),this.stream=null}drawOneFrame(){var e,t,i,r;if(this.context)if(this._correctSize(),!0===(null===(e=this.high.track)||void 0===e?void 0:e.enabled)&&!1===(null===(t=this.track)||void 0===t?void 0:t.enabled)&&(this.logger.log("恢复小流mute状态"),this.track.enabled=!0),this.track){if("live"!==this.track.readyState)this.logger.error("小流 Track 已停止");else if(!1===(null===(i=this.high.track)||void 0===i?void 0:i.enabled)){if("frame"===this.lastState||"clear"===this.lastState){this.logger.log("track处在mute状态");let e="black";this.logger.log(`小流状态变更 ${this.lastState} => ${e}`),this.lastState=e,this.context.fillRect(0,0,this.width,this.height)}}else if(this.high.videoDom.paused){if("frame"===this.lastState||"clear"===this.lastState){let e="paused";this.logger.log(`小流状态变更 ${this.lastState} => ${e}`),this.lastState=e,this.high.videoDom.play().catch(e=>{})}("all"===o.getParameters().videoLowCheckCanvasBlank||c.IS_IOS&&"ios"===o.getParameters().videoLowCheckCanvasBlank)&&this._checkCanvasBlank()}else if("live"===(null===(r=this.high.track)||void 0===r?void 0:r.readyState)){if("frame"!==this.lastState){let e="frame";this.logger.log(`小流状态变更 ${this.lastState} => ${e}`),this.lastState=e}this.context.drawImage(this.high.videoDom,0,0,this.width,this.height),this.lastDrawAt=Date.now(),("all"===o.getParameters().videoLowCheckCanvasBlank||c.IS_IOS&&"ios"===o.getParameters().videoLowCheckCanvasBlank)&&this._checkCanvasBlank()}else if("frame"===this.lastState){let e="clear";this.logger.log(`小流状态变更 ${this.lastState} => ${e}`),this.lastState=e,this.context.clearRect(0,0,this.width,this.height)}}else this.logger.error("无法获取小流 Track")}_checkCanvasBlank(){var e,t;if((null===(e=this.high.sender)||void 0===e?void 0:e.track)&&(null===(t=this.sender)||void 0===t?void 0:t.track)&&(this.high.sender.track!==this.emptyTrackInfo.track&&(this.emptyTrackInfo={track:this.high.sender.track,count:0,visible:"unknown"}),"unknown"===this.emptyTrackInfo.visible)){if(this.high.videoDom.paused||4!==this.high.videoDom.readyState)this.emptyTrackInfo.count++;else{d.isCanvasBlank(this.canvas)?this.emptyTrackInfo.count++:(this.emptyTrackInfo.visible="yes",this.logger.log("_checkCanvasBlank: 小流画面可见",this.emptyTrackInfo.count),this.sender.track!==this.track&&(this.logger.warn("小流切换至低分辨率模式"),this.sender.replaceTrack(this.track)))}this.emptyTrackInfo.count>30&&(this.emptyTrackInfo.visible="no",this.sender.track!==this.high.sender.track?(this.logger.warn("_checkCanvasBlank: 小流两秒内无画面，小流切换至相同分辨率模式"),this.sender.replaceTrack(this.high.sender.track)):this.logger.warn("_checkCanvasBlank: 小流两秒内无画面，继续使用相同分辨率模式"))}}_bindTrack(e){var t;this.high.track!==e&&(this.high.track&&this.high.stream.removeTrack(this.high.track),e&&this.high.stream.addTrack(e),this.high.track=e,this.high.videoDom.srcObject=this.high.stream,this.high.videoDom.play().catch(e=>{}),(null===(t=this.sender)||void 0===t?void 0:t.track)&&("no"===this.emptyTrackInfo.visible?(this.logger.warn("小流正在使用相同分辨率模式"),this.sender.replaceTrack(e)):this.sender.track!==this.track&&(this.logger.warn("小流正在使用低分辨率模式"),this.sender.replaceTrack(this.track))))}bindSender(e,t){this.high.sender=e,this.sender=t,e?this._bindTrack(e.track):this._bindTrack(null)}}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.getAutoplayVideo=void 0;let r=0;t.getAutoplayVideo=function(){const e=document.createElement("video");return e.style.position="absolute",e.setAttribute("x-webkit-airplay","x-webkit-airplay"),e.setAttribute("playsinline","playsinline"),e.setAttribute("webkit-playsinline","webkit-playsinline"),e.preload="auto",e.className="nertc-video-id-"+r++,e.autoplay=!0,e.muted=!0,e}},function(e,t,i){e.exports="setInterval(() => {\n  self.postMessage('RTCTimer')\n}, 8)\n"},function(e,t,i){e.exports="const SMOOTHING_FACTOR = 0.8\nconst MINIMUM_VALUE = 0.00001\nregisterProcessor(\n  'vumeter',\n  class extends AudioWorkletProcessor {\n    constructor() {\n      super()\n      this._leftVolume = 0\n      this._rightVolume = 0\n      this._updateIntervalInMS = 25\n      this._nextUpdateFrame = this._updateIntervalInMS\n      this.port.onmessage = (event) => {\n        if (event.data.updateIntervalInMS) this._updateIntervalInMS = event.data.updateIntervalInMS\n      }\n    }\n\n    get intervalInFrames() {\n      return (this._updateIntervalInMS / 1000) * sampleRate\n    }\n\n    process(inputs, outputs, parameters) {\n      const input = inputs[0]\n\n      // Note that the input will be down-mixed to mono; however, if no inputs are\n      // connected then zero channels will be passed in.\n      if (input.length > 0) {\n        const samplesLeft = input[0]\n        const samplesRight = input[1]\n\n        let sum = 0\n        let rms = 0\n        // Calculated the squared-sum.\n        if (samplesLeft && samplesLeft.length) {\n          for (let i = 0; i < samplesLeft.length; ++i) {\n            sum += samplesLeft[i] * samplesLeft[i]\n          }\n          // Calculate the RMS level and update the volume.\n          rms = Math.sqrt(sum / samplesLeft.length)\n          this._leftVolume = Math.max(rms, this._leftVolume * SMOOTHING_FACTOR)\n        }\n        if (samplesRight) {\n          sum = 0\n          rms = 0\n          // Calculated the squared-sum.\n          for (let j = 0; j < samplesRight.length; ++j) sum += samplesRight[j] * samplesRight[j]\n\n          // Calculate the RMS level and update the volume.\n          rms = Math.sqrt(sum / samplesRight.length)\n          this._rightVolume = Math.max(rms, this._rightVolume * SMOOTHING_FACTOR)\n        }\n\n        // Update and sync the volume property with the main thread.\n        this._nextUpdateFrame -= samplesLeft.length\n        if (this._nextUpdateFrame < 0) {\n          this._nextUpdateFrame += this.intervalInFrames\n          let volume = Math.max(this._leftVolume, this._rightVolume)\n          if (!(volume > -1)) {\n            if (this._leftVolume > -1) {\n              volume = this._leftVolume\n            } else if (this._rightVolume > -1) {\n              volume = this._rightVolume\n            }\n          }\n          if (samplesRight) {\n            this.port.postMessage({\n              left: this._leftVolume,\n              right: this._rightVolume,\n              volume: volume\n            })\n          } else {\n            this.port.postMessage({\n              volume: volume\n            })\n          }\n        }\n      }\n\n      return true\n    }\n  }\n)\n"},function(e,t,i){e.exports=";(function () {\n  const intervalIds = {}\n  const timeoutIds = {}\n\n  // 监听message 开始执行定时器或者销毁\n  self.onmessage = function onMsgFunc(e) {\n    switch (e.data.command) {\n      case 'interval:start': // 开启定时器\n        const intervalId = setInterval(function () {\n          postMessage({\n            message: 'interval:tick',\n            id: e.data.id\n          })\n        }, e.data.interval)\n\n        postMessage({\n          message: 'interval:started',\n          id: e.data.id\n        })\n\n        intervalIds[e.data.id] = intervalId\n        break\n      case 'interval:clear': // 销毁\n        clearInterval(intervalIds[e.data.id])\n\n        postMessage({\n          message: 'interval:cleared',\n          id: e.data.id\n        })\n\n        delete intervalIds[e.data.id]\n        break\n\n      case 'timeout:start': // 开启定时器\n        const timeoutId = this.setTimeout(function () {\n          postMessage({\n            message: 'timeout:tick',\n            id: e.data.id\n          })\n        }, e.data.timeout)\n\n        postMessage({\n          message: 'timeout:started',\n          id: e.data.id\n        })\n\n        timeoutIds[e.data.id] = timeoutId\n        break\n      case 'timeout:clear': // 销毁\n        clearTimeout(timeoutIds[e.data.id])\n\n        postMessage({\n          message: 'timeout:cleared',\n          id: e.data.id\n        })\n\n        delete timeoutIds[e.data.id]\n        break\n    }\n  }\n})()\n"},function(e,t,i){e.exports="/**\n * 模拟一个AI Worklet\n * 其实是个Delay\n */\nregisterProcessor(\n  'audioAIProcessor',\n  class extends AudioWorkletProcessor {\n    constructor() {\n      super()\n      // 尚未接入AI，以延迟1秒为例\n      this.inputSamplesHistory = []\n      this.delayMs = 3000\n    }\n\n    process(inputs, outputs, parameters) {\n      const now = Date.now()\n      const input = inputs[0].map((channel) => {\n        return channel.slice(0)\n      })\n      const output = outputs[0]\n      this.inputSamplesHistory.push({\n        input,\n        ms: now\n      })\n      const firstItem = this.inputSamplesHistory[0]\n      if (firstItem) {\n        if (now - firstItem.ms > this.delayMs) {\n          this.inputSamplesHistory.shift()\n          output.forEach((channel, index) => {\n            for (let i = 0; i < channel.length; i++) {\n              if (firstItem.input[index] && firstItem.input[index][i]) {\n                channel[i] = firstItem.input[index][i]\n              }\n            }\n          })\n        }\n      }\n      return true\n    }\n  }\n)\n"},function(e,t,i){e.exports="/* eslint-disable */\nregisterProcessor(\n  'audioWorkletAgentProcessor',\n  class extends AudioWorkletProcessor {\n    // Float32Array[][][]\n    constructor() {\n      super()\n      this.inputDataSeq = []\n      this.bufferDrop = 0\n      this.bufferDropSum = 0\n      this.bufferDropTime = 0\n      this.port.onmessage = (event) => {\n        if (event.data.type === 'outputData') {\n          this.inputDataSeq.push(event.data.data)\n          this.bufferDrop++\n        }\n      }\n    }\n\n    process(inputs, outputs, parameters) {\n      this.port.postMessage({\n        type: 'rawinputs',\n        inputs\n      })\n\n      const inputData = this.inputDataSeq.shift()\n      if (inputData && outputs[0] && !this.bufferDropSum) {\n        if (outputs[0][1]) {\n          outputs[0][1].set(inputData[0])\n        }\n        outputs[0][0].set(inputData[0])\n      }\n      if (this.bufferDrop > 200) {\n        this.bufferDropSum += this.bufferDrop\n        this.bufferDropTime = currentTime\n      }\n      this.bufferDrop = 0\n      if (this.bufferDropTime && currentTime - this.bufferDropTime > 0.3) {\n        this.inputDataSeq = []\n        this.port.postMessage({\n          type: 'bufferDrop',\n          cnt: this.bufferDropSum\n        })\n        this.bufferDropTime = 0\n        this.bufferDropSum = 0\n      }\n      return true\n    }\n  }\n)\n"},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.shimCanvas=t.canShimCanvas=void 0;const o=i(5),n=i(138),d=a(i(2));t.canShimCanvas=function(){let e=!1;if("never"===o.getParameters().shimCanvas)e=!1;else if("always"===o.getParameters().shimCanvas)e=!0;else if("ios151"===o.getParameters().shimCanvas)return!!(d.IS_IOS&&navigator.userAgent.indexOf(" OS 15_1")>-1);return e},t.shimCanvas=function(e){let t=new n.RTCCanvas("canvas");const i=document.createElement("video");let r=t._canvas,s=e.getSettings().frameRate||15,a=t._ctx;const o=new MediaStream([e]);if(i.srcObject=o,i.setAttribute("playsinline","playsinline"),i.setAttribute("muted","muted"),i.setAttribute("autoplay","autoplay"),i.className="nertc-ios-shim",i.style.display="none",i.onresize=()=>{i.videoWidth&&i.videoHeight&&t.setSize(i.videoWidth,i.videoHeight)},a){const o=r.captureStream(s).getVideoTracks()[0];Object.defineProperty(o,"enabled",{get:()=>e.enabled,set(t){console.warn("Delegate cameraTrack enabled",t),e.enabled=t}});const n=setInterval(()=>{i.paused?i.play():"ended"===o.readyState?("live"===e.readyState&&(console.warn("canvasTrack已停止，回收videoTrack中"),e.stop()),clearInterval(n),document.body.removeChild(i)):a.drawImage(i,0,0)},1e3/s);return document.body.appendChild(i),t.destroy(),o}throw new Error("Ctx not supported")}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.syncTrackState=void 0;const r=new(i(116).Logger)({tagGen:()=>"syncTrackState"}),s=[];setInterval(()=>{for(let e=s.length-1;e>=0;e--){const t=s[e];if("ended"===t.srcTrack.readyState)return"live"===t.destTrack.readyState&&(r.log(`同步MediaStreamTrack关闭状态。【${t.srcTrack.label}】=>【${t.destTrack.label}】`),t.destTrack.stop()),void s.splice(e,1);if("bidirectional"===t.direction&&"ended"===t.destTrack.readyState)return"live"===t.srcTrack.readyState&&(r.warn(`同步MediaStreamTrack关闭状态。【${t.destTrack.label}】=>【${t.srcTrack.label}】`),t.srcTrack.stop()),void s.splice(e,1);t.srcTrack.enabled!==t.enabled&&(t.enabled=t.srcTrack.enabled,t.srcTrack.enabled!==t.destTrack.enabled&&(r.warn(`同步MediaStreamTrack enabled:【${t.srcTrack.label}】`,t.enabled),t.destTrack.enabled=t.srcTrack.enabled)),"bidirectional"===t.direction&&t.destTrack.enabled!==t.enabled&&(t.enabled=t.destTrack.enabled,t.destTrack.enabled!==t.srcTrack.enabled&&(r.warn(`同步MediaStreamTrack enabled:【${t.srcTrack.label}】`,t.enabled),t.srcTrack.enabled=t.destTrack.enabled))}},1e3);t.syncTrackState=function(e,t,i){s.push({srcTrack:e,destTrack:t,direction:i,enabled:e.enabled})}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.isCanvasBlank=void 0;let r=null;t.isCanvasBlank=function(e){r||(r=document.createElement("canvas")),r.width=e.width,r.height=e.height;let t=e.toDataURL()===r.toDataURL();return t&&console.error("result",t,e),t}},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Meeting=void 0;const n=i(13),d=i(65),c=i(148),l=o(i(70)),u=o(i(11)),h=o(i(12)),p=a(i(2));class m extends n.EventEmitter{constructor(e){super(),this.info={turn:!0,relay:!1,forward:!1,secure:!0},this._reset(),this.adapterRef=e.adapterRef,this.sdkRef=e.sdkRef,this.logger=e.adapterRef.logger.getChild(()=>{var t,i,r;let s="meeting";return this.info.secure||(s+=" INSECURE"),this.info.forward&&(s+=" FORWARD"),this.info.turn||(s+=" NOTURN"),(null===(r=null===(i=null===(t=e.adapterRef.instance)||void 0===t?void 0:t._params)||void 0===i?void 0:i.neRtcServerAddresses)||void 0===r?void 0:r.channelServer)&&(s+=" PRIVATE"),e.adapterRef._meetings!==this&&(s+=" DETACHED"),s})}_reset(){}async getCloudProxyInfo(e){const{appkey:t,channelName:i,uid:r,token:s=""}=e;this.adapterRef.logger.log("getCloudProxyInfoUrl: ",d.getCloudProxyInfoUrl);let a=d.getCloudProxyInfoUrl;this.adapterRef.instance._params.neRtcServerAddresses.cloudProxyServer&&(a=this.adapterRef.instance._params.neRtcServerAddresses.cloudProxyServer,this.adapterRef.logger.log("私有化配置的 cloudProxyServer: ",a));let o=r;"string"===this.adapterRef.channelInfo.uidType&&(o=new l.default(o));let n=Date.parse(new Date)/1e3;try{const e=await this.adapterRef.lbsManager.ajax({url:a,type:"POST",data:{uid:o,appkey:t,channelName:i,secureType:s?"1":"2",osType:"4",version:d.SDK_VERSION+".0"||!1,curtime:""+n,checksum:c(t+"."+r+"."+n),proxy:"1",needIPV6:"0"}});if(this.adapterRef.logger.log("获取到云代理服务相关信息:",JSON.stringify(e)),this.adapterRef.instance.apiFrequencyControl({name:"setCloudProxyInfo",code:200===e.code?0:-1,param:{channelName:i,uid:r,appkey:t,token:s,reason:e.code}}),200===e.code){this.adapterRef.channelStatus="join";const{wsProxyArray:t,mediaProxyArray:i,mediaProxyToken:r,cname:s,curTime:a,uid:o}=e;this.adapterRef.instance._params.neRtcServerAddresses.webSocketProxyServer?(this.adapterRef.logger.warn("获取到云代理私有化 webSocketProxyServer:",this.adapterRef.instance._params.neRtcServerAddresses.webSocketProxyServer),this.adapterRef.proxyServer.wsProxyArray=[this.adapterRef.instance._params.neRtcServerAddresses.webSocketProxyServer]):this.adapterRef.proxyServer.wsProxyArray=t,this.adapterRef.instance._params.neRtcServerAddresses.mediaProxyServer?(this.adapterRef.logger.warn("获取到云代理私有化 mediaProxyServer:",this.adapterRef.instance._params.neRtcServerAddresses.mediaProxyServer),this.adapterRef.proxyServer.mediaProxyArray=[this.adapterRef.instance._params.neRtcServerAddresses.mediaProxyServer],this.adapterRef.proxyServer.mediaProxyToken="netease",this.adapterRef.proxyServer.credential="netease"):(this.adapterRef.proxyServer.mediaProxyArray=i,this.adapterRef.proxyServer.mediaProxyToken=r,this.adapterRef.proxyServer.credential=o+"/"+a)}else this.adapterRef.logger.log("获取到云代理服务相关信息, 回退")}catch(t){this.adapterRef.logger.log("获取到云代理服务相关信息发生错误:",t.name,t.message,t),this.adapterRef.channelStatus="leave",this.adapterRef.connectState.prevState=this.adapterRef.connectState.curState,this.adapterRef.connectState.curState="DISCONNECTED",this.adapterRef.connectState.reconnect=!1,this.adapterRef.instance.safeEmit("connection-state-change",this.adapterRef.connectState),this.adapterRef.instance.apiFrequencyControl({name:"startProxyServer",code:-1,param:Object.assign(Object.assign({},e),{reason:t.message})});let i="getCloudProxyInfo: proxy error: "+t.message,r="getCloudProxyInfo: proxy 异常: "+t.message,s="Please contact CommsEase technical support",a="请联系云信技术支持",o=p.IS_ZH?r:i,n=p.IS_ZH?a:s;throw new h.default({code:u.default.PROXY_ERROR,message:o,advice:n})}}async joinChannel(e){try{this.adapterRef.proxyServer.enable&&await this.getCloudProxyInfo(e)}catch(e){throw e}const{appkey:t,channelName:i,uid:r,wssArr:s=null,sessionMode:a="meeting",joinChannelRecordConfig:o,joinChannelLiveConfig:n,token:m="",permKey:f="",getChanneInfoResponse:g}=e;let v=Date.now(),_=+new Date,S=d.getChannelInfoUrl;this.adapterRef.instance._params.neRtcServerAddresses.channelServer&&(S=this.adapterRef.instance._params.neRtcServerAddresses.channelServer,this.logger.log("私有化配置的 getChannelInfoUrl: ",S));let y=r;"string"===this.adapterRef.channelInfo.uidType&&(y=new l.default(y)),Object.assign(this.adapterRef.channelInfo,{uid:r,sessionMode:a,appkey:t});try{let l=g;l||(l=await this.adapterRef.lbsManager.ajax({url:S,type:"POST",contentType:"application/x-www-form-urlencoded",header:{"X-Forwarded-For":this.adapterRef.testConf.ForwardedAddr||""},data:{uid:y,appkey:t,permKeySecret:f,channelName:i,secureType:m?"1":"2",osType:"4",mode:2,netType:"0",version:d.SDK_VERSION+".0"||!1,curtime:_,checksum:m||c(t+"."+r+"."+_),webrtc:1,nrtcg2:1,t1:v}}));let R=!("0"==r||"0"!=r&&!r);if(this.info.secure=!!m,this.info.forward=!!this.adapterRef.testConf.ForwardedAddr,"string"==typeof l?(this.logger.warn("join 返回值类型为string，应为object。尝试进行强制类型转换。",l),l=JSON.parse(l)):this.logger.log("join 获取到房间信息:",JSON.stringify(l,null," ")),200===l.code){this.adapterRef.channelStatus="join";const{ips:d,time:c}=l;d&&d.uid||this.logger.warn("join 加入频道时服务端未返回uid");const u=l.config&&l.config.quality_level_limit||16;this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.startWssTime=Date.now();let h=d.webrtcarray&&d.webrtcarray.length&&d.webrtcarray[0];if(h&&this.adapterRef.proxyServer.wsProxyArray){const e=d.turnaddrs&&d.turnaddrs.length&&d.turnaddrs[0][0];let t=e.split(":").length>1?e.split(":")[1]:"",i=h.split("/").length>1?h.split("/")[1]:"";this.adapterRef.instance._params.neRtcServerAddresses.webSocketProxyServer&&(t=i.split(":")[1]),i&&t?this.adapterRef.proxyServer.wsProxyArray=this.adapterRef.proxyServer.wsProxyArray.map(e=>e+"/"+i.split(":")[0]+":"+t):this.adapterRef.logger.log(`join 云代理无法获取到代理信息, serverurl: ${i}, port: ${t}`)}Object.assign(this.adapterRef.channelInfo,{cid:+l.cid,permKey:f,token:l.token,turnToken:d.token,channelName:i,wssArr:s||this.adapterRef.proxyServer.enable&&this.adapterRef.proxyServer.wsProxyArray||d.webrtcarray||[],relayaddrs:this.adapterRef.proxyServer.mediaProxyArray||d.relayaddrs||null,relaytoken:this.adapterRef.proxyServer.mediaProxyToken||d.relaytoken||null,wssArrIndex:0,maxVideoQuality:u,netDetect:!1},{uid:R?r:d.uid,sessionMode:a,appkey:t}),e.uid=e.uid?e.uid:this.adapterRef.channelInfo.uid,this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.token=l.token,this.adapterRef.channelInfo.T4=Date.now();let p=this.adapterRef.channelInfo.T4-c.t1-(c.t3-c.t2);return this.adapterRef.channelInfo.clientNtpTime=c.t3+Math.round(p/2),this.adapterRef.instance.setSessionConfig(Object.assign({maxVideoQuality:u},n,o)),this.info.relay=d.relayaddrs&&d.relayaddrs.length>0,this.info.turn=d.turnaddrs&&d.turnaddrs.length>0,this.adapterRef.instance.startSession()}{const e=l.desc&&""!==l.desc?"join: "+l.desc:"join: 服务器不允许加入房间, code "+l.code;this.logger.warn(e),this.adapterRef.channelStatus="leave",this.adapterRef.connectState.prevState=this.adapterRef.connectState.curState,this.adapterRef.connectState.curState="DISCONNECTED",this.adapterRef.connectState.reconnect=!1,this.adapterRef.instance.safeEmit("connection-state-change",this.adapterRef.connectState),this.adapterRef.instance.apiEventReport("setLogin",{a_record:o.recordAudio,v_record:o.recordVideo,record_type:o.recordType,host_speaker:o.isHostSpeaker,result:l.code,serverIp:l.ips&&l.ips.turnaddrs&&l.ips.turnaddrs.length&&l.ips.turnaddrs[0]});let t=l.desc&&""!==l.desc?"joinChannel: "+l.desc:"joinChannel: server error, code "+l.code,i=l.desc&&""!==l.desc?"joinChannel: "+l.desc:"joinChannel: 服务器不允许加入房间, code "+l.code,r="Please contact CommsEase technical support",s="请联系云信技术支持",a=p.IS_ZH?i:t,n=p.IS_ZH?s:r;return Promise.reject(new h.default({code:l.code||u.default.MEDIA_SERVER_ERROR,message:a,advice:n}))}}catch(e){this.logger.log("joing 获取到房间信息错误:",e.name,e.message),this.adapterRef.channelStatus="leave",this.adapterRef.connectState.prevState=this.adapterRef.connectState.curState,this.adapterRef.connectState.curState="DISCONNECTED",this.adapterRef.connectState.reconnect=!1,this.adapterRef.instance.safeEmit("connection-state-change",this.adapterRef.connectState),this.adapterRef.instance.apiEventReport("setLogin",{a_record:o.recordAudio,v_record:o.recordVideo,record_type:o.recordType,host_speaker:o.isHostSpeaker,result:"join() 语法错误: "+e.message,serverIp:""});let t="joinChannel: network error "+e.message,i="joinChannel: 网络异常 "+e.message,r="Please contact CommsEase technical support",s="请联系云信技术支持",a=p.IS_ZH?i:t,n=p.IS_ZH?s:r;throw new h.default({code:u.default.NETWORK_ERROR,message:a,advice:n})}}leaveChannel(){if(this.adapterRef.instance.apiEventReport("setLogout",{reason:this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.logoutReason||0}),!this.adapterRef._signalling){let e="leaveChannel: signalling server error",t="leaveChannel: 信令服务器异常",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=p.IS_ZH?t:e,a=p.IS_ZH?r:i;throw new h.default({code:u.default.SIGNALLING_SERVER_ERROR,message:s,advice:a})}return this.adapterRef._signalling.doSendLogout().then(()=>(this.adapterRef.channelStatus="leave",this.adapterRef.connectState.prevState=this.adapterRef.connectState.curState,this.adapterRef.connectState.curState="DISCONNECTED",this.adapterRef.connectState.reconnect=!1,this.adapterRef.instance.safeEmit("connection-state-change",this.adapterRef.connectState),this.adapterRef.instance.stopSession()))}async addTasks(e){const{rtmpTasks:t=[]}=e;let i,r,s,a,o,n,c=null;if(this.adapterRef.channelInfo.cid?t&&Array.isArray(t)&&t.length||(c="addTasks: 参数格式错误，rtmpTasks为空，或者该数组长度为空",i="addTasks: invalid operation",r="addTasks: 操作异常",s="parameters is invalid",a="参数格式错误, rtmpTasks为空, 或者该数组长度为空",o=p.IS_ZH?r:i,n=p.IS_ZH?a:s):(c="addTasks: 请在加入房间后进行直播推流操作",i="addTasks: invalid operation",r="addTasks: 操作异常",s="please join room before addTasks",a="请在加入房间后进行直播推流操作",o=p.IS_ZH?r:i,n=p.IS_ZH?a:s),c)throw this.logger.error(c),new h.default({code:u.default.INVALID_OPERATION_ERROR,message:o,advice:n});let m=d.roomsTaskUrl;this.adapterRef.instance._params.neRtcServerAddresses.roomServer&&(m=this.adapterRef.instance._params.neRtcServerAddresses.roomServer,"/"!==m.substr(-1)&&(m+="/"),this.logger.log("私有化配置的 roomsTaskUrl: ",m)),m=`${m}${this.adapterRef.channelInfo.cid}/tasks`;let f=this.adapterRef.channelInfo.uid;"string"===this.adapterRef.channelInfo.uidType&&(f=new l.default(f));for(let e=0;e<t.length;e++){t[e].hostUid=f,t[e].version=1,this.logger.log("rtmpTask: ",JSON.stringify(t[e]));const i=t[e].layout;i.users.forEach(e=>{"string"==typeof e.uid&&(e.uid=new l.default(e.uid))});try{const r=await this.adapterRef.lbsManager.ajax({url:m,type:"POST",contentType:"application/json;charset=utf-8",header:{Token:this.adapterRef.channelInfo.turnToken},data:{version:1,taskId:t[e].taskId,streamUrl:t[e].streamUrl,record:t[e].record,hostUid:t[e].hostUid,layout:i,config:t[e].config,extraInfo:t[e].extraInfo}});if(200!==r.code){this.logger.error("添加推流任务失败: ",r);let e="addTasks: add task failed: "+r.code,t="addTasks: 添加推流任务失败: "+r.code,i="Please contact CommsEase technical support",s="请联系云信技术支持",a=p.IS_ZH?t:e,o=p.IS_ZH?s:i;return Promise.reject(new h.default({code:u.default.ADD_TASK_FAILED_ERROR,message:a,advice:o}))}this.logger.log("添加推流任务完成")}catch(e){this.logger.error("addTasks: ",e.name,e.message);let t=`addTasks: add task error: ${e.name} ${e.message}`,i=`addTasks: 添加推流任务异常: ${e.name} ${e.message}`,r="Please contact CommsEase technical support",s="请联系云信技术支持",a=p.IS_ZH?i:t,o=p.IS_ZH?s:r;return Promise.reject(new h.default({code:u.default.ADD_TASK_FAILED_ERROR,message:a,advice:o}))}}}async deleteTasks(e){const{taskIds:t=[]}=e;if(!this.adapterRef.channelInfo.cid){this.adapterRef.instance.apiFrequencyControl({name:"deleteTasks",code:-1,param:JSON.stringify({error:"请先加入房间",version:1,taskId:t.length?t[0]:""},null," ")}),this.logger.error("请先加入房间");let e="deleteTasks: invalid operation",i="deleteTasks: 操作异常",r="please join room first",s="请先加入房间",a=p.IS_ZH?i:e,o=p.IS_ZH?s:r;return Promise.reject(new h.default({code:u.default.INVALID_OPERATION_ERROR,message:a,advice:o}))}if(!t||!Array.isArray(t)||!t.length){this.logger.error("删除推流任务失败: 参数格式错误，taskIds为空，或者该数组长度为空");let e="deleteTasks: invalid parameters",t="deleteTasks: 参数异常",i="Please make sure the parameters correct",r="请确认参数填写正确",s=p.IS_ZH?t:e,a=p.IS_ZH?r:i;return Promise.reject(new h.default({code:u.default.INVALID_PARAMETER_ERROR,message:s,advice:a}))}let i=d.roomsTaskUrl;this.logger.log("roomsTaskUrl: ",d.roomsTaskUrl),this.adapterRef.instance._params.neRtcServerAddresses.roomServer&&(i=this.adapterRef.instance._params.neRtcServerAddresses.roomServer,"/"!==i.substr(-1)&&(i+="/"),this.logger.log("私有化配置的 roomsTaskUrl: ",i)),i=`${i}${this.adapterRef.channelInfo.cid}/tasks/delete`;for(let e=0;e<t.length;e++){this.logger.log("deleteTasks: ",t[e]);try{const r=await this.adapterRef.lbsManager.ajax({url:i,type:"POST",contentType:"application/json;charset=utf-8",header:{Token:this.adapterRef.channelInfo.turnToken},data:{taskId:t[e]}});if(200===r.code)return this.logger.log("删除推流任务完成"),this.adapterRef.instance.apiFrequencyControl({name:"deleteTasks",code:0,param:JSON.stringify({taskId:t[e]},null," ")}),Promise.resolve();{this.logger.log("删除推流任务请求失败:",JSON.stringify(r)),this.adapterRef.instance.apiFrequencyControl({name:"deleteTasks",code:r.code,param:JSON.stringify({taskId:t[e]},null," ")});let i="deleteTasks: delete task failed: "+r.code,s="deleteTasks: 删除推流任务失败: "+r.code,a="Please contact CommsEase technical support",o="请联系云信技术支持",n=p.IS_ZH?s:i,d=p.IS_ZH?o:a;return Promise.reject(new h.default({code:u.default.DELETE_TASK_FAILED_ERROR,message:n,advice:d}))}}catch(i){this.logger.error("deleteTasks发生错误: ",i.name,i.message,i),this.adapterRef.instance.apiFrequencyControl({name:"deleteTasks",code:-1,param:JSON.stringify({error:"code error",taskId:t[e]},null," ")});let r=`deleteTasks: delete task failed: ${i.name}  ${i.message}`,s=`deleteTasks: 删除推流任务失败:  ${i.name}  ${i.message}`,a="Please contact CommsEase technical support",o="请联系云信技术支持",n=p.IS_ZH?s:r,d=p.IS_ZH?o:a;return Promise.reject(new h.default({code:u.default.DELETE_TASK_FAILED_ERROR,message:n,advice:d}))}}}async updateTasks(e){const{rtmpTasks:t=[]}=e;if(!this.adapterRef.channelInfo.cid){this.adapterRef.instance.apiFrequencyControl({name:"updateTasks",code:-1,param:JSON.stringify({error:"请先加入房间",version:1,taskId:t.length?t[0].taskId:""},null," ")}),this.logger.error("请先加入房间");let e="updateTasks: invalid operation",i="updateTasks: 操作异常",r="please join room first",s="请先加入房间",a=p.IS_ZH?i:e,o=p.IS_ZH?s:r;return Promise.reject(new h.default({code:u.default.INVALID_OPERATION_ERROR,message:a,advice:o}))}if(!t||!Array.isArray(t)||!t.length){this.logger.error("更新推流任务失败: 参数格式错误，rtmpTasks为空，或者该数组长度为空");let e="updateTasks: invalid parameters",t="updateTasks: 参数异常",i="Please make sure the parameters correct",r="请确认参数填写正确",s=p.IS_ZH?t:e,a=p.IS_ZH?r:i;return Promise.reject(new h.default({code:u.default.INVALID_PARAMETER_ERROR,message:s,advice:a}))}let i=d.roomsTaskUrl;this.logger.log("roomsTaskUrl: ",d.roomsTaskUrl),this.adapterRef.instance._params.neRtcServerAddresses.roomServer&&(i=this.adapterRef.instance._params.neRtcServerAddresses.roomServer,"/"!==i.substr(-1)&&(i+="/"),this.logger.log("私有化配置的 roomsTaskUrl: ",i)),i=`${i}${this.adapterRef.channelInfo.cid}/task/update`;let r=this.adapterRef.channelInfo.uid;"string"===this.adapterRef.channelInfo.uidType&&(r=new l.default(r));for(let e=0;e<t.length;e++){const s=t[e].layout;s.users.forEach(e=>{"string"==typeof e.uid&&(e.uid=new l.default(e.uid))});try{const a=await this.adapterRef.lbsManager.ajax({url:i,type:"POST",contentType:"application/json;charset=utf-8",header:{Token:this.adapterRef.channelInfo.turnToken},data:{version:1,taskId:t[e].taskId,streamUrl:t[e].streamUrl,record:t[e].record,hostUid:r,layout:s,config:t[e].config}});if(200===a.code)return this.logger.log("更新推流任务完成"),this.adapterRef.instance.apiFrequencyControl({name:"updateTasks",code:0,param:JSON.stringify({version:1,taskId:t[e].taskId,streamUrl:t[e].streamUrl,record:t[e].record,hostUid:parseInt(t[e].hostUid),layout:t[e].layout,config:t[e].config},null," ")}),Promise.resolve();{this.logger.log("更新推流任务失败：",JSON.stringify(a)),this.adapterRef.instance.apiFrequencyControl({name:"updateTasks",code:a.code,param:JSON.stringify({version:1,taskId:t[e].taskId,streamUrl:t[e].streamUrl,record:t[e].record,hostUid:parseInt(t[e].hostUid),layout:t[e].layout,config:t[e].config},null," ")});let i="updateTasks: update task failed",r="updateTasks: 删除推流任务失败",s="Please contact CommsEase technical support",o="请联系云信技术支持",n=p.IS_ZH?r:i,d=p.IS_ZH?o:s;return Promise.reject(new h.default({code:u.default.UPDATE_TASKS_FAILED_ERROR,message:n,advice:d}))}}catch(i){this.logger.error("updateTasks 发生错误: ",i.name,i.message,i),this.adapterRef.instance.apiFrequencyControl({name:"updateTasks",code:-1,param:JSON.stringify({error:"code error",version:1,taskId:t[e].taskId,streamUrl:t[e].streamUrl,record:t[e].record,hostUid:parseInt(t[e].hostUid),layout:t[e].layout,config:t[e].config},null," ")});let r=`updateTasks: update task failed ${i.name} ${i.message}`,s=`updateTasks: 删除推流任务失败 ${i.name} ${i.message}`,a="Please contact CommsEase technical support",o="请联系云信技术支持",n=p.IS_ZH?s:r,d=p.IS_ZH?o:a;return Promise.reject(new h.default({code:u.default.UPDATE_TASKS_FAILED_ERROR,message:n,advice:d}))}}}destroy(){this.logger.log("清除 meeting"),this._reset()}}t.Meeting=m},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.StatsReport=void 0;const n=i(13),d=i(65),c=o(i(245)),l=o(i(246)),u=a(i(2)),h=i(61),p=o(i(247)),m=i(263),f=i(264),g=i(265),v=(new Date).getTime();class _ extends n.EventEmitter{constructor(e){super(),this._reset(),this.heartbeat_=-1,this.wsTransport_=null,this.sdkRef=e.sdkRef,this.adapterRef=e.adapterRef,this.prevStats_={},this.appKey=this.adapterRef.instance._params.appkey||this.adapterRef.channelInfo&&this.adapterRef.channelInfo.appKey||"",this.isStartGetStats=!1,this.stats=new f.GetStats({adapterRef:this.adapterRef,interval:1e3}),this.stats.on("stats",(e,t)=>{this.formativeStatsReport&&this.formativeStatsReport.update(e,t)}),this.formativeStatsReport=new m.FormativeStatsReport({adapterRef:this.adapterRef,sdkRef:this.sdkRef,appkey:this.appKey})}_reset(){this.stats&&this.stats.destroy(),this.stats=null,this.formativeStatsReport&&this.formativeStatsReport.destroy(),this.formativeStatsReport=null,this.stopHeartbeat()}stop(){this.stats&&this.stats.stop(),this.formativeStatsReport&&this.formativeStatsReport.stop()}statsStart(){this.formativeStatsReport&&(this.isStartGetStats=!0,this.formativeStatsReport.start())}start(){let e=h.generateUUID(),t=g(`0${v}${d.SDK_VERSION}webwebrtc${e}40f5a1a1871e46089e1e5139a779dd77`),i=`${this.adapterRef.instance._params.neRtcServerAddresses.statisticsWebSocketServer||"wss://statistic.live.126.net/lps-websocket/websocket/collect"}?deviceId=${e}&isTest=0&sdkVer=${d.SDK_VERSION}&sdktype=webrtc&timestamp=${v}&platform=web&checkSum=${t}`,r=window;this.wsTransport_=r.wsTransport=new p.default({url:i,adapterRef:this.adapterRef}),this.wsTransport_.init()}startHeartbeat(){if(-1===this.heartbeat_){const e=2e3;this.adapterRef.logger.log("startHeartbeat..."),this.heartbeat_=l.default.setInterval(this.doHeartbeat.bind(this),e)}}stopHeartbeat(){-1!==this.heartbeat_&&(l.default.clearInterval(this.heartbeat_),this.heartbeat_=-1)}async doHeartbeat(){var e;try{if(this.isStartGetStats){let t=await(null===(e=this.stats)||void 0===e?void 0:e.getAllStats()),i=this.calculateReport(t);u.IS_ELECTRON||this.wsTransport_.sendPB(i)}}catch(e){this.adapterRef.logger.log("doHeartbeat: ",e)}}calculateReport(e){if(u.IS_CHROME||u.IS_EDG){let n=e.local.audio_ssrc?e.local.audio_ssrc:[],d=e.local.video_ssrc?e.local.video_ssrc:[],l=e.local.screen_ssrc?e.local.screen_ssrc:[],u=e.remote.audio_ssrc?e.remote.audio_ssrc:[],h=e.remote.video_ssrc?e.remote.video_ssrc:[],p=e.remote.screen_ssrc?e.remote.screen_ssrc:[];if(!c.default(this.prevStats_))var t=this.prevStats_.local.audio_ssrc?this.prevStats_.local.audio_ssrc:[],i=this.prevStats_.local.video_ssrc?this.prevStats_.local.video_ssrc:[],r=this.prevStats_.local.screen_ssrc?this.prevStats_.local.screen_ssrc:[],s=this.prevStats_.remote.audio_ssrc?this.prevStats_.remote.audio_ssrc:[],a=this.prevStats_.remote.video_ssrc?this.prevStats_.remote.video_ssrc:[],o=this.prevStats_.remote.screen_ssrc?this.prevStats_.remote.screen_ssrc:[];if(c.default(this.prevStats_)||n.length!==t.length||d.length!==i.length||l.length!==r.length||u.length!==s.length||h.length!==a.length||p.length!==o.length){this.prevStats_=e,Object.keys(this.prevStats_.local).length&&(this.prevStats_.local.audio_ssrc&&(this.prevStats_.local.audio_ssrc[0].bytesSentPerSecond=Math.abs(this.prevStats_.local.audio_ssrc[0].bytesSent)),this.prevStats_.local.audio_ssrc&&(this.prevStats_.local.audio_ssrc[0].packetsLostPerSecond=Math.abs(this.prevStats_.local.audio_ssrc[0].packetsLost)),this.prevStats_.local.video_ssrc&&(this.prevStats_.local.video_ssrc[0].bytesSentPerSecond=Math.abs(this.prevStats_.local.video_ssrc[0].bytesSent)),this.prevStats_.local.video_ssrc&&(this.prevStats_.local.video_ssrc[0].packetsLostPerSecond=Math.abs(this.prevStats_.local.video_ssrc[0].packetsLost)),this.prevStats_.local.video_ssrc&&(this.prevStats_.local.video_ssrc[0].framesEncodedPerSecond=this.prevStats_.local.video_ssrc[0].framesEncoded),this.prevStats_.local.screen_ssrc&&(this.prevStats_.local.screen_ssrc[0].bytesSentPerSecond=Math.abs(this.prevStats_.local.screen_ssrc[0].bytesSent)),this.prevStats_.local.screen_ssrc&&(this.prevStats_.local.screen_ssrc[0].packetsLostPerSecond=Math.abs(this.prevStats_.local.screen_ssrc[0].packetsLost)),this.prevStats_.local.screen_ssrc&&(this.prevStats_.local.screen_ssrc[0].framesEncodedPerSecond=this.prevStats_.local.screen_ssrc[0].framesEncoded));for(let e in this.prevStats_.remote)if(e.indexOf("ssrc")>-1)for(let t=0;t<this.prevStats_.remote[e].length;t++)this.prevStats_.remote[e][t].bytesReceivedPerSecond=Math.abs(this.prevStats_.remote[e][t].bytesReceived),this.prevStats_.remote[e][t].packetsLostPerSecond=this.prevStats_.remote[e][t].packetsLost,"video"===this.prevStats_.remote[e][t].mediaType&&(this.prevStats_.remote[e][t].framesDecodedPerSecond=Math.round(this.prevStats_.remote[e][t].framesDecoded))}else{let t=e.local,i=this.prevStats_.local,r=e.remote,s=this.prevStats_.remote;Object.keys(t).length&&(t.audio_ssrc&&(t.audio_ssrc[0].bytesSent-0>0&&t.audio_ssrc[0].bytesSent-0-i.audio_ssrc[0].bytesSent>0?t.audio_ssrc[0].bytesSentPerSecond=Math.abs((t.audio_ssrc[0].bytesSent-0-i.audio_ssrc[0].bytesSent)/2):t.audio_ssrc[0].bytesSentPerSecond=0,t.audio_ssrc[0].packetsLost-0>0&&t.audio_ssrc[0].packetsLost-0-i.audio_ssrc[0].packetsLost>0?t.audio_ssrc[0].packetsLostPerSecond=Math.abs((t.audio_ssrc[0].packetsLost-0-i.audio_ssrc[0].packetsLost)/2):t.audio_ssrc[0].packetsLostPerSecond=0),t.video_ssrc&&(t.video_ssrc[0].bytesSent-0>0&&t.video_ssrc[0].bytesSent-0-i.video_ssrc[0].bytesSent>0?t.video_ssrc[0].bytesSentPerSecond=Math.abs((t.video_ssrc[0].bytesSent-0-i.video_ssrc[0].bytesSent)/2):t.video_ssrc[0].bytesSentPerSecond=0,t.video_ssrc[0].framesEncoded-0>0&&t.video_ssrc[0].framesEncoded-0-i.video_ssrc[0].framesEncoded>0?t.video_ssrc[0].framesEncodedPerSecond=(t.video_ssrc[0].framesEncoded-0-i.video_ssrc[0].framesEncoded)/2:t.video_ssrc[0].framesEncodedPerSecond=0,t.video_ssrc[0].packetsLost-0>0&&t.video_ssrc[0].packetsLost-0-i.video_ssrc[0].packetsLost>0?t.video_ssrc[0].packetsLostPerSecond=Math.abs((t.video_ssrc[0].packetsLost-0-i.video_ssrc[0].packetsLost)/2):t.video_ssrc[0].packetsLostPerSecond=0),t.screen_ssrc&&(t.screen_ssrc[0].bytesSent-0>0&&t.screen_ssrc[0].bytesSent-0-i.screen_ssrc[0].bytesSent>0?t.screen_ssrc[0].bytesSentPerSecond=Math.abs((t.screen_ssrc[0].bytesSent-0-i.screen_ssrc[0].bytesSent)/2):t.screen_ssrc[0].bytesSentPerSecond=0,t.screen_ssrc[0].framesEncoded-0>0&&t.screen_ssrc[0].framesEncoded-0-i.screen_ssrc[0].framesEncoded>0?t.screen_ssrc[0].framesEncodedPerSecond=(t.screen_ssrc[0].framesEncoded-0-i.screen_ssrc[0].framesEncoded)/2:t.screen_ssrc[0].framesEncodedPerSecond=0,t.screen_ssrc[0].packetsLost-0>0&&t.screen_ssrc[0].packetsLost-0-i.screen_ssrc[0].packetsLost>0?t.screen_ssrc[0].packetsLostPerSecond=Math.abs((t.screen_ssrc[0].packetsLost-0-i.screen_ssrc[0].packetsLost)/2):t.screen_ssrc[0].packetsLostPerSecond=0));for(let e in r)if(e.indexOf("ssrc")>-1)for(let t=0;t<r[e].length;t++)r[e][t].bytesReceived-0>0&&r[e][t].bytesReceived-0-s[e][t].bytesReceived>0?r[e][t].bytesReceivedPerSecond=Math.abs((r[e][t].bytesReceived-0-s[e][t].bytesReceived)/2):r[e][t].bytesReceivedPerSecond=0,r[e][t].packetsLost-0>0&&r[e][t].packetsLost-0-s[e][t].packetsLost>0?r[e][t].packetsLostPerSecond=(r[e][t].packetsLost-0-s[e][t].packetsLost)/2:r[e][t].packetsLostPerSecond=0,"video"===this.prevStats_.remote[e][t].mediaType&&(r[e][t].framesDecoded-0>0&&Math.round((r[e][t].framesDecoded-0-s[e][t].framesDecoded)/2)>0?r[e][t].framesDecodedPerSecond=Math.round((r[e][t].framesDecoded-0-s[e][t].framesDecoded)/2):r[e][t].framesDecodedPerSecond=0)}}else if(u.IS_ANY_SAFARI){let t=e.local.audio_outbound_rtp?e.local.audio_outbound_rtp:[],i=e.local.video_outbound_rtp?e.local.video_outbound_rtp:[],r=e.local.video_track?e.local.video_track:[],s=e.remote.audio_inbound_rtp?e.remote.audio_inbound_rtp:[],a=e.remote.video_inbound_rtp?e.remote.video_inbound_rtp:[],o=e.remote.video_track?e.remote.video_track:[];if(!c.default(this.prevStats_))var n=this.prevStats_.local.audio_outbound_rtp?this.prevStats_.local.audio_outbound_rtp:[],d=this.prevStats_.local.video_outbound_rtp?this.prevStats_.local.video_outbound_rtp:[],l=this.prevStats_.local.video_track?this.prevStats_.local.video_track:[],h=this.prevStats_.remote.audio_inbound_rtp?this.prevStats_.remote.audio_inbound_rtp:[],p=this.prevStats_.remote.video_inbound_rtp?this.prevStats_.remote.video_inbound_rtp:[],m=this.prevStats_.remote.video_track?this.prevStats_.remote.video_track:[];if(c.default(this.prevStats_)||t.length!==n.length||i.length!==d.length||r.length!==l.length||s.length!==h.length||a.length!==p.length||o.length!==m.length){this.prevStats_=e,Object.keys(this.prevStats_.local).length&&(this.prevStats_.local.audio_outbound_rtp&&(this.prevStats_.local.audio_outbound_rtp[0].bytesSentPerSecond=this.prevStats_.local.audio_outbound_rtp[0].bytesSent),this.prevStats_.local.video_outbound_rtp&&(this.prevStats_.local.video_outbound_rtp[0].bytesSentPerSecond=this.prevStats_.local.video_outbound_rtp[0].bytesSent),this.prevStats_.local.video_outbound_rtp&&(this.prevStats_.local.video_outbound_rtp[0].framesEncodedPerSecond=this.prevStats_.local.video_outbound_rtp[0].framesEncoded),this.prevStats_.local.video_track&&(this.prevStats_.local.video_track[0].framesSentPerSecond=this.prevStats_.local.video_track[0].framesSent));for(let e in this.prevStats_.remote)if(e.indexOf("inbound_rtp")>-1)for(let t=0;t<this.prevStats_.remote[e].length;t++)this.prevStats_.remote[e][t].bytesReceivedPerSecond=Math.abs(this.prevStats_.remote[e][t].bytesReceived),this.prevStats_.remote[e][t].packetsLostPerSecond=this.prevStats_.remote[e][t].packetsLost,"video"===this.prevStats_.remote[e][t].mediaType&&(this.prevStats_.remote[e][t].framesDecodedPerSecond=Math.round(this.prevStats_.remote[e][t].framesDecoded))}else{let t=e.local,i=this.prevStats_.local,r=e.remote,s=this.prevStats_.remote;Object.keys(t).length&&(t.audio_outbound_rtp&&(t.audio_outbound_rtp[0].bytesSent-0>0&&t.audio_outbound_rtp[0].bytesSent-0-i.audio_outbound_rtp[0].bytesSent>0?t.audio_outbound_rtp[0].bytesSentPerSecond=(t.audio_outbound_rtp[0].bytesSent-0-i.audio_outbound_rtp[0].bytesSent)/2:t.audio_outbound_rtp[0].bytesSentPerSecond=0),t.video_outbound_rtp&&(t.video_outbound_rtp[0].bytesSent-0>0&&t.video_outbound_rtp[0].bytesSent-0-i.video_outbound_rtp[0].bytesSent>0?t.video_outbound_rtp[0].bytesSentPerSecond=(t.video_outbound_rtp[0].bytesSent-0-i.video_outbound_rtp[0].bytesSent)/2:t.video_outbound_rtp[0].bytesSentPerSecond=0,t.video_outbound_rtp[0].framesEncoded-0>0&&t.video_outbound_rtp[0].framesEncoded-0-i.video_outbound_rtp[0].framesEncoded>0?t.video_outbound_rtp[0].framesEncodedPerSecond=(t.video_outbound_rtp[0].framesEncoded-0-i.video_outbound_rtp[0].framesEncoded)/2:t.video_outbound_rtp[0].framesEncodedPerSecond=0),t.video_track&&(t.video_track[0].framesSent-0>0&&Math.round(t.video_track[0].framesSent-0-i.video_track[0].framesSent)>0?t.video_track[0].framesSentPerSecond=Math.round((t.video_track[0].framesSent-0-i.video_track[0].framesSent)/2):t.video_track[0].framesSentPerSecond=0));for(let e in r)if(e.indexOf("inbound_rtp")>-1)for(let t=0;t<r[e].length;t++)r[e][t].bytesReceived-0>0&&r[e][t].bytesReceived-0-s[e][t].bytesReceived>0?r[e][t].bytesReceivedPerSecond=(r[e][t].bytesReceived-0-s[e][t].bytesReceived)/2:r[e][t].bytesReceivedPerSecond=0,r[e][t].packetsLost-0>0&&r[e][t].packetsLost-0-s[e][t].packetsLost>0&&(r[e][t].packetsLostPerSecond=(r[e][t].packetsLost-0-s[e][t].packetsLost)/2),"video"===this.prevStats_.remote[e][t].mediaType&&r[e][t].framesDecoded-0>0&&Math.round(r[e][t].framesDecoded-0-s[e][t].framesDecoded)>0&&(r[e][t].framesDecodedPerSecond=Math.round((r[e][t].framesDecoded-0-s[e][t].framesDecoded)/2))}}else if(u.IS_FIREFOX){let n=e.local.audio_outbound_rtp?e.local.audio_outbound_rtp:[],d=e.local.video_outbound_rtp?e.local.video_outbound_rtp:[],l=e.local.screen_outbound_rtp?e.local.screen_outbound_rtp:[],u=e.remote.audio_inbound_rtp?e.remote.audio_inbound_rtp:[],h=e.remote.video_inbound_rtp?e.remote.video_inbound_rtp:[],p=e.remote.screen_inbound_rtp?e.remote.screen_inbound_rtp:[];if(!c.default(this.prevStats_))t=this.prevStats_.local.audio_outbound_rtp?this.prevStats_.local.audio_outbound_rtp:[],i=this.prevStats_.local.video_outbound_rtp?this.prevStats_.local.video_outbound_rtp:[],r=this.prevStats_.local.screen_outbound_rtp?this.prevStats_.local.screen_outbound_rtp:[],s=this.prevStats_.remote.audio_inbound_rtp?this.prevStats_.remote.audio_inbound_rtp:[],a=this.prevStats_.remote.video_inbound_rtp?this.prevStats_.remote.video_inbound_rtp:[],o=this.prevStats_.remote.screen_inbound_rtp?this.prevStats_.remote.screen_inbound_rtp:[];if(c.default(this.prevStats_)||n.length!==t.length||d.length!==i.length||l.length!==r.length||u.length!==s.length||h.length!==a.length||p.length!==o.length){this.prevStats_=e,Object.keys(this.prevStats_.local).length&&(this.prevStats_.local.audio_outbound_rtp&&(this.prevStats_.local.audio_outbound_rtp[0].bytesSentPerSecond=this.prevStats_.local.audio_outbound_rtp[0].bytesSent),this.prevStats_.local.audio_outbound_rtp&&(this.prevStats_.local.audio_outbound_rtp[0].packetsSentPerSecond=this.prevStats_.local.audio_outbound_rtp[0].packetsSent),this.prevStats_.local.video_outbound_rtp&&(this.prevStats_.local.video_outbound_rtp[0].bytesSentPerSecond=this.prevStats_.local.video_outbound_rtp[0].bytesSent),this.prevStats_.local.video_outbound_rtp&&(this.prevStats_.local.video_outbound_rtp[0].framesEncodedPerSecond=this.prevStats_.local.video_outbound_rtp[0].framesEncoded),this.prevStats_.local.video_outbound_rtp&&(this.prevStats_.local.video_outbound_rtp[0].packetsSentPerSecond=this.prevStats_.local.video_outbound_rtp[0].packetsSent),this.prevStats_.local.screen_outbound_rtp&&(this.prevStats_.local.screen_outbound_rtp[0].bytesSentPerSecond=this.prevStats_.local.screen_outbound_rtp[0].bytesSent),this.prevStats_.local.screen_outbound_rtp&&(this.prevStats_.local.screen_outbound_rtp[0].framesEncodedPerSecond=this.prevStats_.local.screen_outbound_rtp[0].framesEncoded),this.prevStats_.local.screen_outbound_rtp&&(this.prevStats_.local.screen_outbound_rtp[0].packetsSentPerSecond=this.prevStats_.local.screen_outbound_rtp[0].packetsSent));for(let e in this.prevStats_.remote)if(e.indexOf("_inbound_rtp")>-1)for(let t=0;t<this.prevStats_.remote[e].length;t++)this.prevStats_.remote[e][t].bytesReceivedPerSecond=this.prevStats_.remote[e][t].bytesReceived,this.prevStats_.remote[e][t].packetsLostPerSecond=this.prevStats_.remote[e][t].packetsLost,this.prevStats_.remote[e][t].packetsReceivedPerSecond=this.prevStats_.remote[e][t].packetsReceived,this.prevStats_.remote[e][t].recvPacketLoss=this.prevStats_.remote[e][t].packetsLost/this.prevStats_.remote[e][t].packetsReceived,"video"!==this.prevStats_.remote[e][t].mediaType&&"screen"!==this.prevStats_.remote[e][t].mediaType||(this.prevStats_.remote[e][t].framesDecodedPerSecond=Math.round(this.prevStats_.remote[e][t].framesDecoded))}else{let t=e.local,i=this.prevStats_.local,r=e.remote,s=this.prevStats_.remote;Object.keys(t).length&&(t.audio_outbound_rtp&&(t.audio_outbound_rtp[0].bytesSent-0>0&&t.audio_outbound_rtp[0].bytesSent-0-i.audio_outbound_rtp[0].bytesSent>0?t.audio_outbound_rtp[0].bytesSentPerSecond=(t.audio_outbound_rtp[0].bytesSent-0-i.audio_outbound_rtp[0].bytesSent)/2:t.audio_outbound_rtp[0].bytesSentPerSecond=0,t.audio_outbound_rtp[0].packetsSent-0>0&&t.audio_outbound_rtp[0].packetsSent-0-i.audio_outbound_rtp[0].packetsSent>0?t.audio_outbound_rtp[0].packetsSentPerSecond=(t.audio_outbound_rtp[0].packetsSent-0-i.audio_outbound_rtp[0].packetsSent)/2:t.audio_outbound_rtp[0].packetsSentPerSecond=0),t.video_outbound_rtp&&(t.video_outbound_rtp[0].bytesSent-0>0&&t.video_outbound_rtp[0].bytesSent-0-i.video_outbound_rtp[0].bytesSent>0?t.video_outbound_rtp[0].bytesSentPerSecond=(t.video_outbound_rtp[0].bytesSent-0-i.video_outbound_rtp[0].bytesSent)/2:t.video_outbound_rtp[0].bytesSentPerSecond=0,t.video_outbound_rtp[0].framesEncoded-0>0&&t.video_outbound_rtp[0].framesEncoded-0-i.video_outbound_rtp[0].framesEncoded>0?t.video_outbound_rtp[0].framesEncodedPerSecond=(t.video_outbound_rtp[0].framesEncoded-0-i.video_outbound_rtp[0].framesEncoded)/2:t.video_outbound_rtp[0].framesEncodedPerSecond=0,t.video_outbound_rtp[0].packetsSent-0>0&&t.video_outbound_rtp[0].packetsSent-0-i.video_outbound_rtp[0].packetsSent>0?t.video_outbound_rtp[0].packetsSentPerSecond=(t.video_outbound_rtp[0].packetsSent-0-i.video_outbound_rtp[0].packetsSent)/2:t.video_outbound_rtp[0].packetsSentPerSecond=0),t.screen_outbound_rtp&&(t.screen_outbound_rtp[0].bytesSent-0>0&&t.screen_outbound_rtp[0].bytesSent-0-i.screen_outbound_rtp[0].bytesSent>0?t.screen_outbound_rtp[0].bytesSentPerSecond=(t.screen_outbound_rtp[0].bytesSent-0-i.screen_outbound_rtp[0].bytesSent)/2:t.screen_outbound_rtp[0].bytesSentPerSecond=0,t.screen_outbound_rtp[0].framesEncoded-0>0&&t.screen_outbound_rtp[0].framesEncoded-0-i.screen_outbound_rtp[0].framesEncoded>0?t.screen_outbound_rtp[0].framesEncodedPerSecond=(t.screen_outbound_rtp[0].framesEncoded-0-i.screen_outbound_rtp[0].framesEncoded)/2:t.screen_outbound_rtp[0].framesEncodedPerSecond=0,t.screen_outbound_rtp[0].packetsSent-0>0&&t.screen_outbound_rtp[0].packetsSent-0-i.screen_outbound_rtp[0].packetsSent>0?t.screen_outbound_rtp[0].packetsSentPerSecond=(t.screen_outbound_rtp[0].packetsSent-0-i.screen_outbound_rtp[0].packetsSent)/2:t.screen_outbound_rtp[0].packetsSentPerSecond=0));for(let e in r)if(e.indexOf("_inbound_rtp")>-1)for(let t=0;t<r[e].length;t++)r[e][t].bytesReceived-0>0&&r[e][t].bytesReceived-0-s[e][t].bytesReceived>0?r[e][t].bytesReceivedPerSecond=(r[e][t].bytesReceived-0-s[e][t].bytesReceived)/2:r[e][t].bytesReceivedPerSecond=0,r[e][t].packetsLost-0>0&&r[e][t].packetsLost-0-s[e][t].packetsLost>0?r[e][t].packetsLostPerSecond=(r[e][t].packetsLost-0-s[e][t].packetsLost)/2:r[e][t].packetsLostPerSecond=0,r[e][t].packetsReceived-0>0&&r[e][t].packetsReceived-0-s[e][t].packetsReceived>0?r[e][t].packetsReceivedPerSecond=(r[e][t].packetsReceived-0-s[e][t].packetsReceived)/2:r[e][t].packetsReceivedPerSecond=0,r[e][t].packetsLost/r[e][t].packetsReceived-0>0&&r[e][t].packetsLost/r[e][t].packetsReceived-0-s[e][t].packetsLost/s[e][t].packetsReceived>0?r[e][t].recvPacketLoss=(r[e][t].packetsLost/r[e][t].packetsReceived-0-s[e][t].packetsLost/s[e][t].packetsReceived)/2:r[e][t].recvPacketLoss=0,"video"!==this.prevStats_.remote[e][t].mediaType&&"screen"!==this.prevStats_.remote[e][t].mediaType||(r[e][t].framesDecoded-0>0&&Math.round(r[e][t].framesDecoded-0-s[e][t].framesDecoded)>0?r[e][t].framesDecodedPerSecond=Math.round((r[e][t].framesDecoded-0-s[e][t].framesDecoded)/2):r[e][t].framesDecodedPerSecond=0)}}return this.prevStats_=e,this.prevStats_}destroy(){this.stop(),this._reset(),this.wsTransport_&&this.wsTransport_.close()}}t.StatsReport=_},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0});var r=Object.prototype.hasOwnProperty;Object.prototype.toString;t.default=function(e){if(null==e)return!0;if("boolean"==typeof e)return!1;if("number"==typeof e)return 0===e;if("string"==typeof e)return 0===e.length;if("function"==typeof e)return 0===e.length;if(Array.isArray(e))return 0===e.length;if(e instanceof Error)return""===e.message;if(function(e){if(!e||"object"!=typeof e||"[object Object]"!=Object.prototype.toString.call(e))return!1;var t=Object.getPrototypeOf(e);if(null===t)return!0;var i=Object.prototype.hasOwnProperty.call(t,"constructor")&&t.constructor;return"function"==typeof i&&i instanceof i&&Function.prototype.toString.call(i)===Function.prototype.toString.call(Object)}(e))switch(Object.prototype.toString.call(e)){case"[object File]":case"[object Map]":case"[object Set]":return 0===e.size;case"[object Object]":for(var t in e)if(r.call(e,t))return!1;return!0}return!1}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0});const r=i(61);const s=new class{constructor(){this.intervalMap_=new Map}setInterval(e,t,i=!0){const s=r.generateUUID();let a=Date.now(),o=a;this.intervalMap_.set(s,{rafId:null,timeoutId:null,onVisibilityChange:null});const n=()=>{if(i&&document.hidden){e();const i=setTimeout(n,t);this.setTimeoutId(s,i),a=Date.now(),o=a}else{o=Date.now(),o-a>=t&&(a=o,e());const i=requestAnimationFrame(n);this.setRafId(s,i)}},d=requestAnimationFrame(n);if(this.setRafId(s,d),i){const e=()=>{if(document.hidden){const e=Date.now()-a;if(e>=t)n();else{const i=setTimeout(n,t-e);this.setTimeoutId(s,i)}}};document.addEventListener("visibilitychange",e),this.setOnVisibilityChange(s,e)}return s}clearInterval(e){if(this.intervalMap_.has(e)){const{rafId:t,timeoutId:i,onVisibilityChange:r}=this.intervalMap_.get(e);cancelAnimationFrame(t),clearTimeout(i),document.removeEventListener("visibilitychange",r),this.intervalMap_.delete(e)}}setTimeoutId(e,t){if(this.intervalMap_.has(e)){const i=this.intervalMap_.get(e);i.timeoutId&&clearTimeout(i.timeoutId),i.timeoutId=t}}setRafId(e,t){if(this.intervalMap_.has(e)){const i=this.intervalMap_.get(e);i.rafId&&cancelAnimationFrame(i.rafId),i.rafId=t}}setOnVisibilityChange(e,t){if(this.intervalMap_.has(e)){this.intervalMap_.get(e).onVisibilityChange=t}}};t.default=s},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0});const o=i(13),n=a(i(175)),d=i(61),c=i(262);let l=new Uint8Array(1);l[0]=10;const u=l;t.default=class{constructor(e){this.lastLogTime=0,this.cachedLogs=[],this.textEncoder=new TextEncoder,this.url_=e.url,this.socket_=null,this.isConnected_=!1,this.isConnecting_=!1,this.pingPongTimeoutId_=-1,this.pingTimeoutId_=-1,this.reconnectionTimer_=-1,this.reconnectionCount_=0,this.emitter_=new o.EventEmitter,this.adapterRef=e.adapterRef,this.logger=this.adapterRef.logger.getChild(()=>"wsTransport")}init(){this.logger.log("connect to url: "+this.url_),this.socket_=new WebSocket(this.url_),this.bindSocket(this.socket_)}bindSocket(e){e.onopen=this.onopen.bind(this),e.onclose=this.onclose.bind(this),e.onerror=this.onerror.bind(this),e.onmessage=this.onmessage.bind(this)}unbindSocket(e){e.onopen=()=>{},e.onclose=()=>{},e.onerror=()=>{},e.onmessage=()=>{}}onopen(e){if(this.isConnected_)return;this.isConnected_=!0,this.isConnecting_=!1;const t=e.target.url;this.logger.log(`websocket[${t}] is connected`),this.urlSetting&&(this.logger.debug(`markFinish success seqId:${this.urlSetting.seqId} source:${this.urlSetting.item.source}  url:${t}`),delete this.urlSetting),this.startPingPong()}onclose(e){const t=e.target.url,i=e.target===this.socket_;this.logger.log(`websocket[${t} InUse: ${i}] is closed with code: ${e.code}`),this.socket_&&e.target===this.socket_&&(this.isConnected_=!1,e.wasClean&&1e3===e.code?this.close():(this.logger.warn(`onclose code:${e.code} reason:${e.reason}`),this.socket_.onclose=()=>{},this.socket_.close(4001),this.socket_=null,this.reconnect()))}onerror(e){const t=e.target.url;this.logger.warn(`websocket[${t}] error observed`),this.urlSetting&&(this.logger.debug(`markFinish fail seqId:${this.urlSetting.seqId} source:${this.urlSetting.item.source}  url:${t}`),delete this.urlSetting),this.isConnected_?e.target===this.socket_&&(this.isConnected_=!1,this.socket_=null,this.reconnect()):this.reconnect(),this.isConnecting_=!1,this.isConnected_=!1}onmessage(e){if(this.isConnected_&&e&&e.data){11===JSON.parse(e.data).action&&this.emit(11,e),this.clearReconnectionTimer()}}isConnected(){return this.isConnected_}sendPB(e){var t;if(this.isConnected_){const i=this.createPBMessage(e);1===(null===(t=this.socket_)||void 0===t?void 0:t.readyState)&&this.socket_.send(i)}}sendPing(e){var t;this.isConnected_&&1===(null===(t=this.socket_)||void 0===t?void 0:t.readyState)&&this.socket_.send(e)}sendLog(e){var t,i;const r=Math.max(this.lastLogTime+1,Date.now());this.lastLogTime=r;try{this.cachedLogs.length&&this.cachedLogs[this.cachedLogs.length-1].data[0].replace("[NERTC","[缓存][NERTC")}catch(e){}if(this.cachedLogs.push({time:r,data:e}),this.cachedLogs.length>50&&this.cachedLogs.shift(),this.isConnected_&&1===(null===(t=this.socket_)||void 0===t?void 0:t.readyState)&&(null===(i=this.adapterRef.channelInfo)||void 0===i?void 0:i.cid)){const e=this.cachedLogs;this.cachedLogs=[];for(let t of e){const e=Object.assign({uid:this.adapterRef.channelInfo.uid,cid:this.adapterRef.channelInfo.cid},t);try{const t=this.textEncoder.encode(JSON.stringify(e));let i=[5,1,1,1,2,0,0,0],r=Uint8Array.from(i.concat(Array.from(t)));this.socket_.send(r)}catch(e){}}}}createPBMessage(e){let t=n.Root.fromJSON(c).lookupType("WebrtcStats"),i=t.create(e),r=t.encode(i).finish();return Uint8Array.from([4,1,1,1,1,0,0,0].concat(Array.from(r)))}async startPingPong(){try{if(-1!==this.pingPongTimeoutId_)return;await this.ping(),this.pingPongTimeoutId_=setTimeout(()=>{this.pingPongTimeoutId_=-1,this.startPingPong()},1e4)}catch(e){this.logger.log("ping-pong failed, start reconnection"),this.clearSocket(),this.reconnect()}}stopPingPong(){this.logger.log("stop ping pong"),clearTimeout(this.pingTimeoutId_),clearTimeout(this.pingPongTimeoutId_),this.pingTimeoutId_=-1,this.pingPongTimeoutId_=-1}ping(){return new Promise((e,t)=>{if(-1!==this.pingTimeoutId_)return e();this.sendPing(u),this.once(11,()=>{clearTimeout(this.pingTimeoutId_),this.pingTimeoutId_=-1,e()}),this.pingTimeoutId_=setTimeout(()=>{this.pingTimeoutId_=-1,t()},1e4)})}reconnect(){var e,t,i;if(this.isConnecting_||-1!==this.reconnectionTimer_)return void this.logger.log("websocket is reconnecting");if(this.isConnecting_=!0,this.reconnectionCount_++,null===(i=null===(t=null===(e=this.adapterRef.instance)||void 0===e?void 0:e._params)||void 0===t?void 0:t.neRtcServerAddresses)||void 0===i?void 0:i.channelServer)return void this.logger.log("WebSocket不启用备用线路：当前为私有化配置");{const e=this.adapterRef.lbsManager.getURLSettings(this.url_),t=e[this.reconnectionCount_%e.length];t.url!==this.url_&&(this.logger.warn(`${t.seqId} WebSocket切换备用线路 ${this.url_} => ${t.url}`),this.url_=t.url,this.urlSetting=t)}this.socket_=new WebSocket(this.url_),this.bindSocket(this.socket_);const r=d.getReconnectionTimeout(this.reconnectionCount_);this.reconnectionTimer_=setTimeout(()=>{this.isConnecting_=!1,this.clearReconnectionTimer(),this.socket_&&this.unbindSocket(this.socket_),this.socket_=null,this.reconnect()},r)}clearReconnectionTimer(){-1!==this.reconnectionTimer_&&(clearTimeout(this.reconnectionTimer_),this.reconnectionTimer_=-1)}once(e,t,i){this.emitter_.once(e,t,i)}emit(e,t,i){this.emitter_.emit(e,t,i)}clearSocket(){this.socket_&&this.unbindSocket(this.socket_),this.isConnected_=!1,this.isConnecting_=!1,this.socket_=null}close(){var e;this.logger.log("close websocket"),this.clearReconnectionTimer(),this.stopPingPong(),null===(e=this.socket_)||void 0===e||e.close(),this.clearSocket()}}},function(e,t,i){var r=e.exports=i(249);r.build="light",r.load=function(e,t,i){return"function"==typeof t?(i=t,t=new r.Root):t||(t=new r.Root),t.load(e,i)},r.loadSync=function(e,t){return t||(t=new r.Root),t.loadSync(e)},r.encoder=i(180),r.decoder=i(185),r.verifier=i(186),r.converter=i(187),r.ReflectionObject=i(119),r.Namespace=i(126),r.Root=i(189),r.Enum=i(58),r.Type=i(181),r.Field=i(120),r.OneOf=i(141),r.MapField=i(182),r.Service=i(183),r.Method=i(184),r.Message=i(155),r.wrappers=i(188),r.types=i(127),r.util=i(25),r.ReflectionObject._configure(r.Root),r.Namespace._configure(r.Type,r.Service,r.Enum),r.Root._configure(r.Type),r.Field._configure(r.Type)},function(e,t,i){var r=t;function s(){r.util._configure(),r.Writer._configure(r.BufferWriter),r.Reader._configure(r.BufferReader)}r.build="minimal",r.Writer=i(153),r.BufferWriter=i(256),r.Reader=i(154),r.BufferReader=i(257),r.util=i(57),r.rpc=i(178),r.roots=i(179),r.configure=s,s()},function(e,t,i){var r=t;r.length=function(e){var t=e.length;if(!t)return 0;for(var i=0;--t%4>1&&"="===e.charAt(t);)++i;return Math.ceil(3*e.length)/4-i};for(var s=new Array(64),a=new Array(123),o=0;o<64;)a[s[o]=o<26?o+65:o<52?o+71:o<62?o-4:o-59|43]=o++;r.encode=function(e,t,i){for(var r,a=null,o=[],n=0,d=0;t<i;){var c=e[t++];switch(d){case 0:o[n++]=s[c>>2],r=(3&c)<<4,d=1;break;case 1:o[n++]=s[r|c>>4],r=(15&c)<<2,d=2;break;case 2:o[n++]=s[r|c>>6],o[n++]=s[63&c],d=0}n>8191&&((a||(a=[])).push(String.fromCharCode.apply(String,o)),n=0)}return d&&(o[n++]=s[r],o[n++]=61,1===d&&(o[n++]=61)),a?(n&&a.push(String.fromCharCode.apply(String,o.slice(0,n))),a.join("")):String.fromCharCode.apply(String,o.slice(0,n))};r.decode=function(e,t,i){for(var r,s=i,o=0,n=0;n<e.length;){var d=e.charCodeAt(n++);if(61===d&&o>1)break;if(void 0===(d=a[d]))throw Error("invalid encoding");switch(o){case 0:r=d,o=1;break;case 1:t[i++]=r<<2|(48&d)>>4,r=d,o=2;break;case 2:t[i++]=(15&r)<<4|(60&d)>>2,r=d,o=3;break;case 3:t[i++]=(3&r)<<6|d,o=0}}if(1===o)throw Error("invalid encoding");return i-s},r.test=function(e){return/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/.test(e)}},function(e,t,i){function r(){this._listeners={}}e.exports=r,r.prototype.on=function(e,t,i){return(this._listeners[e]||(this._listeners[e]=[])).push({fn:t,ctx:i||this}),this},r.prototype.off=function(e,t){if(void 0===e)this._listeners={};else if(void 0===t)this._listeners[e]=[];else for(var i=this._listeners[e],r=0;r<i.length;)i[r].fn===t?i.splice(r,1):++r;return this},r.prototype.emit=function(e){var t=this._listeners[e];if(t){for(var i=[],r=1;r<arguments.length;)i.push(arguments[r++]);for(r=0;r<t.length;)t[r].fn.apply(t[r++].ctx,i)}return this}},function(e,t,i){function r(e){return"undefined"!=typeof Float32Array?function(){var t=new Float32Array([-0]),i=new Uint8Array(t.buffer),r=128===i[3];function s(e,r,s){t[0]=e,r[s]=i[0],r[s+1]=i[1],r[s+2]=i[2],r[s+3]=i[3]}function a(e,r,s){t[0]=e,r[s]=i[3],r[s+1]=i[2],r[s+2]=i[1],r[s+3]=i[0]}function o(e,r){return i[0]=e[r],i[1]=e[r+1],i[2]=e[r+2],i[3]=e[r+3],t[0]}function n(e,r){return i[3]=e[r],i[2]=e[r+1],i[1]=e[r+2],i[0]=e[r+3],t[0]}e.writeFloatLE=r?s:a,e.writeFloatBE=r?a:s,e.readFloatLE=r?o:n,e.readFloatBE=r?n:o}():function(){function t(e,t,i,r){var s=t<0?1:0;if(s&&(t=-t),0===t)e(1/t>0?0:2147483648,i,r);else if(isNaN(t))e(2143289344,i,r);else if(t>34028234663852886e22)e((s<<31|2139095040)>>>0,i,r);else if(t<11754943508222875e-54)e((s<<31|Math.round(t/1401298464324817e-60))>>>0,i,r);else{var a=Math.floor(Math.log(t)/Math.LN2);e((s<<31|a+127<<23|8388607&Math.round(t*Math.pow(2,-a)*8388608))>>>0,i,r)}}function i(e,t,i){var r=e(t,i),s=2*(r>>31)+1,a=r>>>23&255,o=8388607&r;return 255===a?o?NaN:s*(1/0):0===a?1401298464324817e-60*s*o:s*Math.pow(2,a-150)*(o+8388608)}e.writeFloatLE=t.bind(null,s),e.writeFloatBE=t.bind(null,a),e.readFloatLE=i.bind(null,o),e.readFloatBE=i.bind(null,n)}(),"undefined"!=typeof Float64Array?function(){var t=new Float64Array([-0]),i=new Uint8Array(t.buffer),r=128===i[7];function s(e,r,s){t[0]=e,r[s]=i[0],r[s+1]=i[1],r[s+2]=i[2],r[s+3]=i[3],r[s+4]=i[4],r[s+5]=i[5],r[s+6]=i[6],r[s+7]=i[7]}function a(e,r,s){t[0]=e,r[s]=i[7],r[s+1]=i[6],r[s+2]=i[5],r[s+3]=i[4],r[s+4]=i[3],r[s+5]=i[2],r[s+6]=i[1],r[s+7]=i[0]}function o(e,r){return i[0]=e[r],i[1]=e[r+1],i[2]=e[r+2],i[3]=e[r+3],i[4]=e[r+4],i[5]=e[r+5],i[6]=e[r+6],i[7]=e[r+7],t[0]}function n(e,r){return i[7]=e[r],i[6]=e[r+1],i[5]=e[r+2],i[4]=e[r+3],i[3]=e[r+4],i[2]=e[r+5],i[1]=e[r+6],i[0]=e[r+7],t[0]}e.writeDoubleLE=r?s:a,e.writeDoubleBE=r?a:s,e.readDoubleLE=r?o:n,e.readDoubleBE=r?n:o}():function(){function t(e,t,i,r,s,a){var o=r<0?1:0;if(o&&(r=-r),0===r)e(0,s,a+t),e(1/r>0?0:2147483648,s,a+i);else if(isNaN(r))e(0,s,a+t),e(2146959360,s,a+i);else if(r>17976931348623157e292)e(0,s,a+t),e((o<<31|2146435072)>>>0,s,a+i);else{var n;if(r<22250738585072014e-324)e((n=r/5e-324)>>>0,s,a+t),e((o<<31|n/4294967296)>>>0,s,a+i);else{var d=Math.floor(Math.log(r)/Math.LN2);1024===d&&(d=1023),e(4503599627370496*(n=r*Math.pow(2,-d))>>>0,s,a+t),e((o<<31|d+1023<<20|1048576*n&1048575)>>>0,s,a+i)}}}function i(e,t,i,r,s){var a=e(r,s+t),o=e(r,s+i),n=2*(o>>31)+1,d=o>>>20&2047,c=4294967296*(1048575&o)+a;return 2047===d?c?NaN:n*(1/0):0===d?5e-324*n*c:n*Math.pow(2,d-1075)*(c+4503599627370496)}e.writeDoubleLE=t.bind(null,s,0,4),e.writeDoubleBE=t.bind(null,a,4,0),e.readDoubleLE=i.bind(null,o,0,4),e.readDoubleBE=i.bind(null,n,4,0)}(),e}function s(e,t,i){t[i]=255&e,t[i+1]=e>>>8&255,t[i+2]=e>>>16&255,t[i+3]=e>>>24}function a(e,t,i){t[i]=e>>>24,t[i+1]=e>>>16&255,t[i+2]=e>>>8&255,t[i+3]=255&e}function o(e,t){return(e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24)>>>0}function n(e,t){return(e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3])>>>0}e.exports=r(r)},function(e,t,i){var r=t;r.length=function(e){for(var t=0,i=0,r=0;r<e.length;++r)(i=e.charCodeAt(r))<128?t+=1:i<2048?t+=2:55296==(64512&i)&&56320==(64512&e.charCodeAt(r+1))?(++r,t+=4):t+=3;return t},r.read=function(e,t,i){if(i-t<1)return"";for(var r,s=null,a=[],o=0;t<i;)(r=e[t++])<128?a[o++]=r:r>191&&r<224?a[o++]=(31&r)<<6|63&e[t++]:r>239&&r<365?(r=((7&r)<<18|(63&e[t++])<<12|(63&e[t++])<<6|63&e[t++])-65536,a[o++]=55296+(r>>10),a[o++]=56320+(1023&r)):a[o++]=(15&r)<<12|(63&e[t++])<<6|63&e[t++],o>8191&&((s||(s=[])).push(String.fromCharCode.apply(String,a)),o=0);return s?(o&&s.push(String.fromCharCode.apply(String,a.slice(0,o))),s.join("")):String.fromCharCode.apply(String,a.slice(0,o))},r.write=function(e,t,i){for(var r,s,a=i,o=0;o<e.length;++o)(r=e.charCodeAt(o))<128?t[i++]=r:r<2048?(t[i++]=r>>6|192,t[i++]=63&r|128):55296==(64512&r)&&56320==(64512&(s=e.charCodeAt(o+1)))?(r=65536+((1023&r)<<10)+(1023&s),++o,t[i++]=r>>18|240,t[i++]=r>>12&63|128,t[i++]=r>>6&63|128,t[i++]=63&r|128):(t[i++]=r>>12|224,t[i++]=r>>6&63|128,t[i++]=63&r|128);return i-a}},function(e,t,i){e.exports=function(e,t,i){var r=i||8192,s=r>>>1,a=null,o=r;return function(i){if(i<1||i>s)return e(i);o+i>r&&(a=e(r),o=0);var n=t.call(a,o,o+=i);return 7&o&&(o=1+(7|o)),n}}},function(e,t,i){e.exports=s;var r=i(57);function s(e,t){this.lo=e>>>0,this.hi=t>>>0}var a=s.zero=new s(0,0);a.toNumber=function(){return 0},a.zzEncode=a.zzDecode=function(){return this},a.length=function(){return 1};var o=s.zeroHash="\0\0\0\0\0\0\0\0";s.fromNumber=function(e){if(0===e)return a;var t=e<0;t&&(e=-e);var i=e>>>0,r=(e-i)/4294967296>>>0;return t&&(r=~r>>>0,i=~i>>>0,++i>4294967295&&(i=0,++r>4294967295&&(r=0))),new s(i,r)},s.from=function(e){if("number"==typeof e)return s.fromNumber(e);if(r.isString(e)){if(!r.Long)return s.fromNumber(parseInt(e,10));e=r.Long.fromString(e)}return e.low||e.high?new s(e.low>>>0,e.high>>>0):a},s.prototype.toNumber=function(e){if(!e&&this.hi>>>31){var t=1+~this.lo>>>0,i=~this.hi>>>0;return t||(i=i+1>>>0),-(t+4294967296*i)}return this.lo+4294967296*this.hi},s.prototype.toLong=function(e){return r.Long?new r.Long(0|this.lo,0|this.hi,Boolean(e)):{low:0|this.lo,high:0|this.hi,unsigned:Boolean(e)}};var n=String.prototype.charCodeAt;s.fromHash=function(e){return e===o?a:new s((n.call(e,0)|n.call(e,1)<<8|n.call(e,2)<<16|n.call(e,3)<<24)>>>0,(n.call(e,4)|n.call(e,5)<<8|n.call(e,6)<<16|n.call(e,7)<<24)>>>0)},s.prototype.toHash=function(){return String.fromCharCode(255&this.lo,this.lo>>>8&255,this.lo>>>16&255,this.lo>>>24,255&this.hi,this.hi>>>8&255,this.hi>>>16&255,this.hi>>>24)},s.prototype.zzEncode=function(){var e=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^e)>>>0,this.lo=(this.lo<<1^e)>>>0,this},s.prototype.zzDecode=function(){var e=-(1&this.lo);return this.lo=((this.lo>>>1|this.hi<<31)^e)>>>0,this.hi=(this.hi>>>1^e)>>>0,this},s.prototype.length=function(){var e=this.lo,t=(this.lo>>>28|this.hi<<4)>>>0,i=this.hi>>>24;return 0===i?0===t?e<16384?e<128?1:2:e<2097152?3:4:t<16384?t<128?5:6:t<2097152?7:8:i<128?9:10}},function(e,t,i){e.exports=a;var r=i(153);(a.prototype=Object.create(r.prototype)).constructor=a;var s=i(57);function a(){r.call(this)}function o(e,t,i){e.length<40?s.utf8.write(e,t,i):t.utf8Write?t.utf8Write(e,i):t.write(e,i)}a._configure=function(){a.alloc=s._Buffer_allocUnsafe,a.writeBytesBuffer=s.Buffer&&s.Buffer.prototype instanceof Uint8Array&&"set"===s.Buffer.prototype.set.name?function(e,t,i){t.set(e,i)}:function(e,t,i){if(e.copy)e.copy(t,i,0,e.length);else for(var r=0;r<e.length;)t[i++]=e[r++]}},a.prototype.bytes=function(e){s.isString(e)&&(e=s._Buffer_from(e,"base64"));var t=e.length>>>0;return this.uint32(t),t&&this._push(a.writeBytesBuffer,t,e),this},a.prototype.string=function(e){var t=s.Buffer.byteLength(e);return this.uint32(t),t&&this._push(o,t,e),this},a._configure()},function(e,t,i){e.exports=a;var r=i(154);(a.prototype=Object.create(r.prototype)).constructor=a;var s=i(57);function a(e){r.call(this,e)}a._configure=function(){s.Buffer&&(a.prototype._slice=s.Buffer.prototype.slice)},a.prototype.string=function(){var e=this.uint32();return this.buf.utf8Slice?this.buf.utf8Slice(this.pos,this.pos=Math.min(this.pos+e,this.len)):this.buf.toString("utf-8",this.pos,this.pos=Math.min(this.pos+e,this.len))},a._configure()},function(e,t,i){e.exports=s;var r=i(57);function s(e,t,i){if("function"!=typeof e)throw TypeError("rpcImpl must be a function");r.EventEmitter.call(this),this.rpcImpl=e,this.requestDelimited=Boolean(t),this.responseDelimited=Boolean(i)}(s.prototype=Object.create(r.EventEmitter.prototype)).constructor=s,s.prototype.rpcCall=function e(t,i,s,a,o){if(!a)throw TypeError("request must be specified");var n=this;if(!o)return r.asPromise(e,n,t,i,s,a);if(n.rpcImpl)try{return n.rpcImpl(t,i[n.requestDelimited?"encodeDelimited":"encode"](a).finish(),(function(e,i){if(e)return n.emit("error",e,t),o(e);if(null!==i){if(!(i instanceof s))try{i=s[n.responseDelimited?"decodeDelimited":"decode"](i)}catch(e){return n.emit("error",e,t),o(e)}return n.emit("data",i,t),o(null,i)}n.end(!0)}))}catch(e){return n.emit("error",e,t),void setTimeout((function(){o(e)}),0)}else setTimeout((function(){o(Error("already ended"))}),0)},s.prototype.end=function(e){return this.rpcImpl&&(e||this.rpcImpl(null,null,null),this.rpcImpl=null,this.emit("end").off()),this}},function(e,t,i){function r(e,t){"string"==typeof e&&(t=e,e=void 0);var i=[];function s(e){if("string"!=typeof e){var t=a();if(r.verbose&&console.log("codegen: "+t),t="return "+t,e){for(var o=Object.keys(e),n=new Array(o.length+1),d=new Array(o.length),c=0;c<o.length;)n[c]=o[c],d[c]=e[o[c++]];return n[c]=t,Function.apply(null,n).apply(null,d)}return Function(t)()}for(var l=new Array(arguments.length-1),u=0;u<l.length;)l[u]=arguments[++u];if(u=0,e=e.replace(/%([%dfijs])/g,(function(e,t){var i=l[u++];switch(t){case"d":case"f":return String(Number(i));case"i":return String(Math.floor(i));case"j":return JSON.stringify(i);case"s":return String(i)}return"%"})),u!==l.length)throw Error("parameter count mismatch");return i.push(e),s}function a(r){return"function "+(r||t||"")+"("+(e&&e.join(",")||"")+"){\n  "+i.join("\n  ")+"\n}"}return s.toString=a,s}e.exports=r,r.verbose=!1},function(e,t,i){e.exports=a;var r=i(176),s=i(177)("fs");function a(e,t,i){return"function"==typeof t?(i=t,t={}):t||(t={}),i?!t.xhr&&s&&s.readFile?s.readFile(e,(function(r,s){return r&&"undefined"!=typeof XMLHttpRequest?a.xhr(e,t,i):r?i(r):i(null,t.binary?s:s.toString("utf8"))})):a.xhr(e,t,i):r(a,this,e,t)}a.xhr=function(e,t,i){var r=new XMLHttpRequest;r.onreadystatechange=function(){if(4===r.readyState){if(0!==r.status&&200!==r.status)return i(Error("status "+r.status));if(t.binary){var e=r.response;if(!e){e=[];for(var s=0;s<r.responseText.length;++s)e.push(255&r.responseText.charCodeAt(s))}return i(null,"undefined"!=typeof Uint8Array?new Uint8Array(e):e)}return i(null,r.responseText)}},t.binary&&("overrideMimeType"in r&&r.overrideMimeType("text/plain; charset=x-user-defined"),r.responseType="arraybuffer"),r.open("GET",e),r.send()}},function(e,t,i){var r=t,s=r.isAbsolute=function(e){return/^(?:\/|\w+:)/.test(e)},a=r.normalize=function(e){var t=(e=e.replace(/\\/g,"/").replace(/\/{2,}/g,"/")).split("/"),i=s(e),r="";i&&(r=t.shift()+"/");for(var a=0;a<t.length;)".."===t[a]?a>0&&".."!==t[a-1]?t.splice(--a,2):i?t.splice(a,1):++a:"."===t[a]?t.splice(a,1):++a;return r+t.join("/")};r.resolve=function(e,t,i){return i||(t=a(t)),s(t)?t:(i||(e=a(e)),(e=e.replace(/(?:\/|^)[^/]+$/,"")).length?a(e+"/"+t):t)}},function(e,t,i){var r=i(175),s=(r.roots.default||(r.roots.default=new r.Root)).addJSON({WebrtcStats:{fields:{local:{type:"local_obj",id:1},remote:{type:"remote_obj",id:2},timestamp:{type:"int64",id:3},appkey:{type:"string",id:4},cid:{type:"int64",id:5},uid:{type:"int64",id:6},browser:{type:"string",id:7},platform:{type:"string",id:8}},nested:{local_obj:{fields:{video_bwe:{rule:"repeated",type:"video_bwe_obj",id:1},audio_ssrc:{rule:"repeated",type:"audio_ssrc_obj",id:2},video_ssrc:{rule:"repeated",type:"video_ssrc_obj",id:3},video_track:{rule:"repeated",type:"video_track_obj",id:4},audio_outbound_rtp:{rule:"repeated",type:"audio_outbound_rtp_obj",id:5},video_outbound_rtp:{rule:"repeated",type:"video_outbound_rtp_obj",id:6},screen_ssrc:{rule:"repeated",type:"screen_ssrc_obj",id:7},screen_outbound_rtp:{rule:"repeated",type:"screen_outbound_rtp_obj",id:8}},nested:{video_bwe_obj:{fields:{googActualEncBitrate:{type:"string",id:1},googAvailableSendBandwidth:{type:"string",id:2},googRetransmitBitrate:{type:"string",id:3},googAvailableReceiveBandwidth:{type:"string",id:4},googTargetEncBitrate:{type:"string",id:5},googBucketDelay:{type:"string",id:6},googTransmitBitrate:{type:"string",id:7},id:{type:"string",id:8},type:{type:"string",id:9},timestamp:{type:"string",id:10}}},audio_ssrc_obj:{fields:{audioInputLevel:{type:"string",id:1},packetsLost:{type:"string",id:2},googRtt:{type:"string",id:3},totalSamplesDuration:{type:"string",id:4},googEchoCancellationReturnLossEnhancement:{type:"string",id:5},googTrackId:{type:"string",id:6},totalAudioEnergy:{type:"string",id:7},transportId:{type:"string",id:8},mediaType:{type:"string",id:9},googEchoCancellationReturnLoss:{type:"string",id:10},googCodecName:{type:"string",id:11},ssrc:{type:"string",id:12},googJitterReceived:{type:"string",id:13},googTypingNoiseState:{type:"string",id:14},packetsSent:{type:"string",id:15},bytesSent:{type:"string",id:16},id:{type:"string",id:17},type:{type:"string",id:18},timestamp:{type:"string",id:19},localuid:{type:"int64",id:20},remoteuid:{type:"int64",id:21},bitsSentPerSecond:{type:"int64",id:22},packetsSentPerSecond:{type:"int64",id:23},sendPacketLoss:{type:"int64",id:24},bytesSentPerSecond:{type:"int64",id:25},alr:{type:"int64",id:26},packetsLostPerSecond:{type:"double",id:27}}},video_ssrc_obj:{fields:{googContentType:{type:"string",id:1},googFrameWidthInput:{type:"string",id:2},googFrameWidthSent:{type:"string",id:3},packetsLost:{type:"string",id:4},googRtt:{type:"string",id:5},googHasEnteredLowResolution:{type:"string",id:6},googEncodeUsagePercent:{type:"string",id:7},googCpuLimitedResolution:{type:"string",id:8},googNacksReceived:{type:"string",id:9},googBandwidthLimitedResolution:{type:"string",id:10},googFrameHeightInput:{type:"string",id:11},googAvgEncodeMs:{type:"string",id:12},googTrackId:{type:"string",id:13},googFrameRateInput:{type:"string",id:14},framesEncoded:{type:"string",id:15},codecImplementationName:{type:"string",id:16},transportId:{type:"string",id:17},mediaType:{type:"string",id:18},googFrameHeightSent:{type:"string",id:19},googFrameRateSent:{type:"string",id:20},googCodecName:{type:"string",id:21},hugeFramesSent:{type:"string",id:22},qpSum:{type:"string",id:23},googPlisReceived:{type:"string",id:24},googAdaptationChanges:{type:"string",id:25},ssrc:{type:"string",id:26},googFirsReceived:{type:"string",id:27},packetsSent:{type:"string",id:28},bytesSent:{type:"string",id:29},id:{type:"string",id:30},type:{type:"string",id:31},timestamp:{type:"string",id:32},localuid:{type:"int64",id:33},remoteuid:{type:"int64",id:34},bitsSentPerSecond:{type:"int64",id:35},packetsSentPerSecond:{type:"int64",id:36},sendPacketLoss:{type:"int64",id:37},freezeTime:{type:"int64",id:38},totalFreezeTime:{type:"int64",id:39},bytesSentPerSecond:{type:"int64",id:40},framesEncodedPerSecond:{type:"int64",id:41},googActualEncBitrate:{type:"string",id:42},googAvailableSendBandwidth:{type:"string",id:43},googRetransmitBitrate:{type:"string",id:44},googAvailableReceiveBandwidth:{type:"string",id:45},googTargetEncBitrate:{type:"string",id:46},googBucketDelay:{type:"string",id:47},googTransmitBitrate:{type:"string",id:48},vlr:{type:"int64",id:49},packetsLostPerSecond:{type:"double",id:50}}},screen_ssrc_obj:{fields:{googContentType:{type:"string",id:1},googFrameWidthInput:{type:"string",id:2},googFrameWidthSent:{type:"string",id:3},packetsLost:{type:"string",id:4},googRtt:{type:"string",id:5},googHasEnteredLowResolution:{type:"string",id:6},googEncodeUsagePercent:{type:"string",id:7},googCpuLimitedResolution:{type:"string",id:8},googNacksReceived:{type:"string",id:9},googBandwidthLimitedResolution:{type:"string",id:10},googFrameHeightInput:{type:"string",id:11},googAvgEncodeMs:{type:"string",id:12},googTrackId:{type:"string",id:13},googFrameRateInput:{type:"string",id:14},framesEncoded:{type:"string",id:15},codecImplementationName:{type:"string",id:16},transportId:{type:"string",id:17},mediaType:{type:"string",id:18},googFrameHeightSent:{type:"string",id:19},googFrameRateSent:{type:"string",id:20},googCodecName:{type:"string",id:21},hugeFramesSent:{type:"string",id:22},qpSum:{type:"string",id:23},googPlisReceived:{type:"string",id:24},googAdaptationChanges:{type:"string",id:25},ssrc:{type:"string",id:26},googFirsReceived:{type:"string",id:27},packetsSent:{type:"string",id:28},bytesSent:{type:"string",id:29},id:{type:"string",id:30},type:{type:"string",id:31},timestamp:{type:"string",id:32},localuid:{type:"int64",id:33},remoteuid:{type:"int64",id:34},bitsSentPerSecond:{type:"int64",id:35},packetsSentPerSecond:{type:"int64",id:36},sendPacketLoss:{type:"int64",id:37},freezeTime:{type:"int64",id:38},totalFreezeTime:{type:"int64",id:39},bytesSentPerSecond:{type:"int64",id:40},framesEncodedPerSecond:{type:"int64",id:41},googActualEncBitrate:{type:"string",id:42},googAvailableSendBandwidth:{type:"string",id:43},googRetransmitBitrate:{type:"string",id:44},googAvailableReceiveBandwidth:{type:"string",id:45},googTargetEncBitrate:{type:"string",id:46},googBucketDelay:{type:"string",id:47},googTransmitBitrate:{type:"string",id:48},vlr:{type:"int64",id:49},packetsLostPerSecond:{type:"double",id:50}}},video_track_obj:{fields:{id:{type:"string",id:1},timestamp:{type:"int64",id:2},type:{type:"string",id:3},detached:{type:"bool",id:4},ended:{type:"bool",id:5},frameHeight:{type:"int64",id:6},frameWidth:{type:"int64",id:7},framesSent:{type:"int64",id:8},remoteSource:{type:"bool",id:9},trackIdentifier:{type:"string",id:10},ssrc:{type:"int64",id:11},frameRateSent:{type:"int64",id:12},mediaType:{type:"string",id:13},framesSentPerSecond:{type:"int64",id:14},uid:{type:"string",id:15}}},audio_outbound_rtp_obj:{fields:{id:{type:"string",id:1},timestamp:{type:"int64",id:2},type:{type:"string",id:3},codecId:{type:"string",id:4},kind:{type:"string",id:5},mediaType:{type:"string",id:6},ssrc:{type:"int64",id:7},transportId:{type:"string",id:8},bytesSent:{type:"int64",id:9},packetsSent:{type:"int64",id:10},headerBytesSent:{type:"int64",id:11},mediaSourceId:{type:"string",id:12},remoteId:{type:"string",id:13},retransmittedBytesSent:{type:"int64",id:14},retransmittedPacketsSent:{type:"int64",id:15},trackId:{type:"string",id:16},bitsSentPerSecond:{type:"int64",id:17},packetsSentPerSecond:{type:"int64",id:18},bytesSentPerSecond:{type:"int64",id:19},nackCount:{type:"int64",id:20},isRemote:{type:"bool",id:21},qpSum:{type:"int64",id:22},uid:{type:"string",id:23}}},video_outbound_rtp_obj:{fields:{id:{type:"string",id:1},timestamp:{type:"int64",id:2},type:{type:"string",id:3},codecId:{type:"string",id:4},kind:{type:"string",id:5},mediaType:{type:"string",id:6},ssrc:{type:"int64",id:7},transportId:{type:"string",id:8},bytesSent:{type:"int64",id:9},packetsSent:{type:"int64",id:10},firCount:{type:"int64",id:11},frameHeight:{type:"int64",id:12},frameWidth:{type:"int64",id:13},framesEncoded:{type:"int64",id:14},framesPerSecond:{type:"int64",id:15},framesSent:{type:"int64",id:16},headerBytesSent:{type:"int64",id:17},hugeFramesSent:{type:"int64",id:18},keyFramesEncoded:{type:"int64",id:19},mediaSourceId:{type:"string",id:20},nackCount:{type:"int64",id:21},pliCount:{type:"int64",id:22},qpSum:{type:"int64",id:23},qualityLimitationResolutionChanges:{type:"int64",id:24},remoteId:{type:"string",id:25},retransmittedBytesSent:{type:"int64",id:26},retransmittedPacketsSent:{type:"int64",id:27},totalEncodeTime:{type:"double",id:28},totalEncodedBytesTarget:{type:"int64",id:29},totalPacketSendDelay:{type:"double",id:30},trackId:{type:"string",id:31},bitsSentPerSecond:{type:"int64",id:32},packetsSentPerSecond:{type:"int64",id:33},frameRateSent:{type:"int64",id:34},bytesSentPerSecond:{type:"int64",id:35},framesEncodedPerSecond:{type:"int64",id:36},bitrateMean:{type:"int64",id:37},bitrateStdDev:{type:"int64",id:38},droppedFrames:{type:"int64",id:39},framerateMean:{type:"int64",id:40},framerateStdDev:{type:"int64",id:41},isRemote:{type:"bool",id:42},uid:{type:"string",id:43}}},screen_outbound_rtp_obj:{fields:{id:{type:"string",id:1},timestamp:{type:"int64",id:2},type:{type:"string",id:3},kind:{type:"string",id:4},mediaType:{type:"string",id:5},ssrc:{type:"int64",id:6},bytesSent:{type:"int64",id:7},packetsSent:{type:"int64",id:8},bitrateMean:{type:"double",id:9},bitrateStdDev:{type:"double",id:10},droppedFrames:{type:"int64",id:11},firCount:{type:"int64",id:12},framerateMean:{type:"int64",id:13},framerateStdDev:{type:"int64",id:14},framesEncoded:{type:"int64",id:15},nackCount:{type:"int64",id:16},pliCount:{type:"int64",id:17},bytesSentPerSecond:{type:"int64",id:18},framesEncodedPerSecond:{type:"int64",id:19},packetsSentPerSecond:{type:"int64",id:20},remoteId:{type:"string",id:21}}}}},remote_obj:{fields:{video_ssrc:{rule:"repeated",type:"video_ssrc_obj",id:1},audio_ssrc:{rule:"repeated",type:"audio_ssrc_obj",id:2},audio_inbound_rtp:{rule:"repeated",type:"audio_inbound_rtp_obj",id:3},video_inbound_rtp:{rule:"repeated",type:"video_inbound_rtp_obj",id:4},audio_track:{rule:"repeated",type:"audio_track_obj",id:5},video_track:{rule:"repeated",type:"video_track_obj",id:6},screen_ssrc:{rule:"repeated",type:"screen_ssrc_obj",id:7},screen_inbound_rtp:{rule:"repeated",type:"screen_inbound_rtp_obj",id:8}},nested:{video_ssrc_obj:{fields:{googContentType:{type:"string",id:1},googCaptureStartNtpTimeMs:{type:"string",id:2},googTargetDelayMs:{type:"string",id:3},packetsLost:{type:"string",id:4},googDecodeMs:{type:"string",id:5},googFrameHeightReceived:{type:"string",id:6},googFrameRateOutput:{type:"string",id:7},packetsReceived:{type:"string",id:8},ssrc:{type:"string",id:9},googRenderDelayMs:{type:"string",id:10},googMaxDecodeMs:{type:"string",id:11},googTrackId:{type:"string",id:12},googFrameWidthReceived:{type:"string",id:13},codecImplementationName:{type:"string",id:14},transportId:{type:"string",id:15},mediaType:{type:"string",id:16},googInterframeDelayMax:{type:"string",id:17},googCodecName:{type:"string",id:18},googFrameRateReceived:{type:"string",id:19},framesDecoded:{type:"string",id:20},googNacksSent:{type:"string",id:21},googFirsSent:{type:"string",id:22},bytesReceived:{type:"string",id:23},googFirstFrameReceivedToDecodedMs:{type:"string",id:24},googCurrentDelayMs:{type:"string",id:25},googMinPlayoutDelayMs:{type:"string",id:26},googFrameRateDecoded:{type:"string",id:27},googJitterBufferMs:{type:"string",id:28},googPlisSent:{type:"string",id:29},id:{type:"string",id:30},type:{type:"string",id:31},timestamp:{type:"string",id:32},localuid:{type:"int64",id:33},remoteuid:{type:"string",id:34},bitsReceivedPerSecond:{type:"int64",id:35},packetsReceivedPerSecond:{type:"int64",id:36},recvPacketLoss:{type:"int64",id:37},freezeTime:{type:"int64",id:38},totalFreezeTime:{type:"int64",id:39},bytesReceivedPerSecond:{type:"int64",id:40},framesDecodedPerSecond:{type:"int64",id:41},packetsLostRate:{type:"double",id:42},packetsLostPerSecond:{type:"double",id:43}}},audio_ssrc_obj:{fields:{googDecodingCTN:{type:"string",id:1},packetsLost:{type:"string",id:2},googSecondaryDecodedRate:{type:"string",id:3},googDecodingPLC:{type:"string",id:4},packetsReceived:{type:"string",id:5},googJitterReceived:{type:"string",id:6},googDecodingCNG:{type:"string",id:7},ssrc:{type:"string",id:8},googPreferredJitterBufferMs:{type:"string",id:9},googSpeechExpandRate:{type:"string",id:10},totalSamplesDuration:{type:"string",id:11},totalAudioEnergy:{type:"string",id:12},transportId:{type:"string",id:13},mediaType:{type:"string",id:14},googDecodingPLCCNG:{type:"string",id:15},googCodecName:{type:"string",id:16},googSecondaryDiscardedRate:{type:"string",id:17},googDecodingNormal:{type:"string",id:18},googTrackId:{type:"string",id:19},audioOutputLevel:{type:"string",id:20},googAccelerateRate:{type:"string",id:21},bytesReceived:{type:"string",id:22},googCurrentDelayMs:{type:"string",id:23},googDecodingCTSG:{type:"string",id:24},googExpandRate:{type:"string",id:25},googPreemptiveExpandRate:{type:"string",id:26},googJitterBufferMs:{type:"string",id:27},googDecodingMuted:{type:"string",id:28},id:{type:"string",id:29},type:{type:"string",id:30},timestamp:{type:"string",id:31},localuid:{type:"int64",id:32},remoteuid:{type:"string",id:33},bitsReceivedPerSecond:{type:"int64",id:34},packetsReceivedPerSecond:{type:"int64",id:35},recvPacketLoss:{type:"int64",id:36},freezeTime:{type:"int64",id:37},totalFreezeTime:{type:"int64",id:38},bytesReceivedPerSecond:{type:"int64",id:39},packetsLostRate:{type:"double",id:40},packetsLostPerSecond:{type:"double",id:41},alr:{type:"double",id:42}}},audio_inbound_rtp_obj:{fields:{id:{type:"string",id:1},timestamp:{type:"int64",id:2},type:{type:"string",id:3},codecId:{type:"string",id:4},kind:{type:"string",id:5},mediaType:{type:"string",id:6},ssrc:{type:"int64",id:7},transportId:{type:"string",id:8},jitter:{type:"double",id:9},packetsLost:{type:"int64",id:10},packetsReceived:{type:"int64",id:11},audioLevel:{type:"int64",id:12},bytesReceived:{type:"int64",id:13},concealedSamples:{type:"int64",id:14},concealmentEvents:{type:"int64",id:15},estimatedPlayoutTimestamp:{type:"int64",id:16},fecPacketsDiscarded:{type:"int64",id:17},fecPacketsReceived:{type:"int64",id:18},headerBytesReceived:{type:"int64",id:19},insertedSamplesForDeceleration:{type:"int64",id:20},jitterBufferDelay:{type:"double",id:21},jitterBufferEmittedCount:{type:"int64",id:22},lastPacketReceivedTimestamp:{type:"double",id:23},removedSamplesForAcceleration:{type:"int64",id:24},silentConcealedSamples:{type:"int64",id:25},totalAudioEnergy:{type:"double",id:26},totalSamplesDuration:{type:"double",id:27},totalSamplesReceived:{type:"int64",id:28},trackId:{type:"string",id:29},bitsReceivedPerSecond:{type:"int64",id:30},packetsReceivedPerSecond:{type:"int64",id:31},uid:{type:"string",id:32},bytesReceivedPerSecond:{type:"int64",id:33},packetsLostRate:{type:"double",id:34},recvPacketLoss:{type:"int64",id:35},remoteuid:{type:"string",id:36},isRemote:{type:"bool",id:37},packetsLostPerSecond:{type:"int64",id:38},qpSum:{type:"int64",id:39}}},video_inbound_rtp_obj:{fields:{id:{type:"string",id:1},timestamp:{type:"int64",id:2},type:{type:"string",id:3},codecId:{type:"string",id:4},kind:{type:"string",id:5},mediaType:{type:"string",id:6},ssrc:{type:"int64",id:7},transportId:{type:"string",id:8},packetsLost:{type:"int64",id:9},packetsReceived:{type:"int64",id:10},bytesReceived:{type:"int64",id:11},estimatedPlayoutTimestamp:{type:"int64",id:12},firCount:{type:"int64",id:13},frameHeight:{type:"int64",id:14},frameWidth:{type:"int64",id:15},framesDecoded:{type:"int64",id:16},framesPerSecond:{type:"int64",id:17},framesReceived:{type:"int64",id:18},headerBytesReceived:{type:"int64",id:19},keyFramesDecoded:{type:"int64",id:20},lastPacketReceivedTimestamp:{type:"int64",id:21},nackCount:{type:"int64",id:22},pliCount:{type:"int64",id:23},totalDecodeTime:{type:"double",id:24},totalInterFrameDelay:{type:"double",id:25},totalSquaredInterFrameDelay:{type:"double",id:26},trackId:{type:"string",id:27},bitsReceivedPerSecond:{type:"int64",id:28},packetsReceivedPerSecond:{type:"int64",id:29},uid:{type:"string",id:30},bytesReceivedPerSecond:{type:"int64",id:31},packetsLostRate:{type:"double",id:32},framesDecodedPerSecond:{type:"double",id:33},recvPacketLoss:{type:"int64",id:34},remoteuid:{type:"string",id:35},isRemote:{type:"bool",id:36},qpSum:{type:"int64",id:37},packetsLostPerSecond:{type:"double",id:38}}},screen_inbound_rtp_obj:{fields:{id:{type:"string",id:1},timestamp:{type:"int64",id:2},type:{type:"string",id:3},kind:{type:"string",id:4},mediaType:{type:"string",id:5},ssrc:{type:"int64",id:6},discardedPackets:{type:"int64",id:7},jitter:{type:"double",id:8},packetsLost:{type:"int64",id:9},packetsReceived:{type:"int64",id:10},bitrateMean:{type:"double",id:11},bitrateStdDev:{type:"double",id:12},bytesReceived:{type:"int64",id:13},firCount:{type:"int64",id:14},framerateMean:{type:"double",id:15},framerateStdDev:{type:"double",id:16},framesDecoded:{type:"int64",id:17},nackCount:{type:"int64",id:18},pliCount:{type:"int64",id:19},remoteId:{type:"string",id:20},targetUid:{type:"string",id:21},bytesReceivedPerSecond:{type:"int64",id:22},packetsLostPerSecond:{type:"int64",id:23},framesDecodedPerSecond:{type:"int64",id:24},recvPacketLoss:{type:"int64",id:25},packetsReceivedPerSecond:{type:"int64",id:26},remoteuid:{type:"string",id:27},packetsLostRate:{type:"double",id:28}}},audio_track_obj:{fields:{id:{type:"string",id:1},timestamp:{type:"int64",id:2},type:{type:"string",id:3},audioLevel:{type:"double",id:4},detached:{type:"bool",id:5},ended:{type:"bool",id:6},jitterBufferFlushes:{type:"int64",id:7},remoteSource:{type:"bool",id:8},trackIdentifier:{type:"string",id:9},mediaType:{type:"string",id:10},ssrc:{type:"int64",id:11},uid:{type:"string",id:12}}},video_track_obj:{fields:{id:{type:"string",id:1},timestamp:{type:"int64",id:2},type:{type:"string",id:3},detached:{type:"bool",id:4},ended:{type:"bool",id:5},frameHeight:{type:"int64",id:6},frameWidth:{type:"int64",id:7},framesDecoded:{type:"int64",id:8},framesDropped:{type:"int64",id:9},framesReceived:{type:"int64",id:10},freezeCount:{type:"int64",id:11},pauseCount:{type:"int64",id:12},remoteSource:{type:"bool",id:13},sumOfSquaredFramesDuration:{type:"double",id:14},totalFramesDuration:{type:"double",id:15},totalFreezesDuration:{type:"double",id:16},totalPausesDuration:{type:"int64",id:17},trackIdentifier:{type:"string",id:18},ssrc:{type:"int64",id:19},mediaType:{type:"string",id:20},uid:{type:"string",id:21}}},screen_ssrc_obj:{fields:{googContentType:{type:"string",id:1},googCaptureStartNtpTimeMs:{type:"string",id:2},googTargetDelayMs:{type:"string",id:3},packetsLost:{type:"string",id:4},googDecodeMs:{type:"string",id:5},googFrameHeightReceived:{type:"string",id:6},googFrameRateOutput:{type:"string",id:7},packetsReceived:{type:"string",id:8},ssrc:{type:"string",id:9},googRenderDelayMs:{type:"string",id:10},googMaxDecodeMs:{type:"string",id:11},googTrackId:{type:"string",id:12},googFrameWidthReceived:{type:"string",id:13},codecImplementationName:{type:"string",id:14},transportId:{type:"string",id:15},mediaType:{type:"string",id:16},googInterframeDelayMax:{type:"string",id:17},googCodecName:{type:"string",id:18},googFrameRateReceived:{type:"string",id:19},framesDecoded:{type:"string",id:20},googNacksSent:{type:"string",id:21},googFirsSent:{type:"string",id:22},bytesReceived:{type:"string",id:23},googFirstFrameReceivedToDecodedMs:{type:"string",id:24},googCurrentDelayMs:{type:"string",id:25},googMinPlayoutDelayMs:{type:"string",id:26},googFrameRateDecoded:{type:"string",id:27},googJitterBufferMs:{type:"string",id:28},googPlisSent:{type:"string",id:29},id:{type:"string",id:30},type:{type:"string",id:31},timestamp:{type:"string",id:32},localuid:{type:"int64",id:33},remoteuid:{type:"string",id:34},bitsReceivedPerSecond:{type:"int64",id:35},packetsReceivedPerSecond:{type:"int64",id:36},recvPacketLoss:{type:"int64",id:37},freezeTime:{type:"int64",id:38},totalFreezeTime:{type:"int64",id:39},bytesReceivedPerSecond:{type:"int64",id:40},framesDecodedPerSecond:{type:"int64",id:41},packetsLostRate:{type:"double",id:42},packetsLostPerSecond:{type:"double",id:43},vlr:{type:"int64",id:44}}}}}}}});e.exports=s},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.FormativeStatsReport=void 0;const n=o(i(11)),d=o(i(12)),c=a(i(2)),l=i(67),u=i(174);t.FormativeStatsReport=class{constructor(e){this._reset(),this.adapterRef=e.adapterRef,this.webrtcStats=[],this.publicIP="",this._audioLevel=[],this.infos={interval:0},this.infos2={},this.paramSecond={upAudioCache:{},upAudioSlaveCache:{},upVideoCache:{},upScreenCache:{},downAudioCache:{},downAudioSlaveCache:{},downVideoCache:{},downScreenCache:{}},this.firstData={recvFirstData:{},sendFirstAudioPackage:!1,sendFirstVideoPackage:!1,sendFirstScreenPackage:!1},this.network="",this.LocalAudioEnable=!1,this.localVideoEnable=!1,this.localScreenEnable=!1,this.init(this.adapterRef.channelInfo.appkey),this.resetStatus()}_reset(){this._audioLevel=[],this.infos={interval:0}}init(e){return this.infos={ver:2,device:-1,isp:-1,platform:h.convertPlatform(l.getOSInfo().osName)+"-"+l.getOSInfo().osVersion+"- webrtc",browser:l.getBrowserInfo().browserName+"-"+l.getBrowserInfo().browserVersion,sdk_ver:"3.6.0",appkey:e,interval:60,samples:30,time:Date.now(),qos_algorithm:-1,fec_algorithm:-1,qos_scene:-1,qos_strategy:-1},this.infos}resetStatus(){this.infos=Object.assign(this.infos,{uid:null,cid:null,push_url:null,turn_ip:null,proxy_ip:null,meeting:!1,live:!1}),this.firstData={recvFirstData:{},sendFirstAudioPackage:!1,sendFirstVideoPackage:!1,sendFirstScreenPackage:!1},this._audioLevel&&(this._audioLevel.length=0),this.clearInfoData()}initInfoData(e){let t={uid:e,cid:this.adapterRef.channelInfo.cid||0,push_url:"",turn_ip:this.adapterRef&&this.adapterRef.channelInfo.wssArr&&this.adapterRef.channelInfo.wssArr[0]||"",proxy_ip:this.adapterRef&&this.adapterRef.channelInfo.wssArr&&this.adapterRef.channelInfo.wssArr[0]||"",meeting:!0,live:this.adapterRef.channelInfo&&this.adapterRef.channelInfo.sessionConfig.liveEnable||!1,p2p:!1,isp:-1,net:-1,connect_state:200,signalling_time:(this.adapterRef.channelInfo&&this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.startWssTime||0)-(this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.startJoinTime||0),connect_time:(this.adapterRef.channelInfo&&this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.joinedSuccessedTime||0)-(this.adapterRef.channelInfo&&this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.startWssTime||0)};this.infos=Object.assign(this.infos,t)}clearInfoData(){this.infos2={rx2:[],tx2:[{v_fps:[],v_res:[],v_plis:[],v_rtt:[],v_simulcast:[],v_bw_kbps:[],v_tar_kbps:[],v_rel_kbps:[],v_tx_kbps:[],v_retx_kbps:[],v_delay:[],s_fps:[],s_res:[],s_plis:[],s_rtt:[],s_simulcast:[],s_bw_kbps:[],s_tar_kbps:[],s_rel_kbps:[],s_tx_kbps:[],s_retx_kbps:[],s_delay:[],a_cap_volume:[],a_rtt:[]}],sys:{cpu_total:[],cpu_idle:[],mem_total:[],mem_workingSet:[],mem_load:[]}}}start(){this.infos.appkey=this.adapterRef.channelInfo.appkey,this.infos.cid=this.adapterRef.channelInfo.cid,this.infos.uid=this.adapterRef.channelInfo.uid,this.clearSecond(),this.initInfoData(this.infos.uid)}stop(){this.send(),this.resetStatus()}clearSecond(){this.paramSecond={upAudioCache:{},upAudioSlaveCache:{},upVideoCache:{},upScreenCache:{},downAudioCache:{},downAudioSlaveCache:{},downVideoCache:{},downScreenCache:{}}}getPacketLossRate(e,t,i=!1){if(!e||!t)return 0;let r=parseInt(e.packetsLost)||0,s=parseInt(t.packetsLost)||0;if(s<=r)return 0;let a=i?e.packetsSent:e.packetsReceived,o=i?t.packetsSent:t.packetsReceived,n=parseInt(a||"")||0,d=parseInt(o||"")||0;return d<=n?0:i?parseFloat(((s-r)/(d-n)*100).toFixed(1)):parseFloat(((s-r)/(s-r+(d-n))*100).toFixed(1))}update(e,t){e=Object.assign({},e.local,e.remote);let i=[],r=[],s=[],a=[],o=[],n=[],d=[],l=[];2==this.webrtcStats.length&&this.webrtcStats.shift(),this.webrtcStats.push(e);let u={send:{uid:0,audio:{prevLost:0,nextLost:0,prevPacket:0,nextPacket:0,rtt:0,jitter:0},audioSlave:{prevLost:0,nextLost:0,prevPacket:0,nextPacket:0,rtt:0,jitter:0},video:{prevLost:0,nextLost:0,prevPacket:0,nextPacket:0,rtt:0,jitter:0},screen:{prevLost:0,nextLost:0,prevPacket:0,nextPacket:0,rtt:0,jitter:0}},recv:{uid:0,audio:{prevLost:0,nextLost:0,prevPacket:0,nextPacket:0,rtt:0,jitter:0},audioSlave:{prevLost:0,nextLost:0,prevPacket:0,nextPacket:0,rtt:0,jitter:0},video:{prevLost:0,nextLost:0,prevPacket:0,nextPacket:0,rtt:0,jitter:0},screen:{prevLost:0,nextLost:0,prevPacket:0,nextPacket:0,rtt:0,jitter:0}}},p=0,m=0;this._audioLevel&&(this._audioLevel.length=0);for(let t in e){let h;if(h=c.IS_ANY_SAFARI?t.split("_")[5]||"":t.split("_")[3]||"","0"===h&&(h=t.split("_")[1]||""),-1!==t.indexOf("_send_")&&-1!==t.indexOf("_audioSlave"))this.paramSecond.upAudioSlaveCache[h]&&(u.send.audioSlave.prevLost=this.paramSecond.upAudioSlaveCache[h].packetsLost,u.send.audioSlave.prevPacket=this.paramSecond.upAudioSlaveCache[h].packetsSent,e[t].alr=this.getPacketLossRate(this.paramSecond.upAudioSlaveCache[h],e[t],!0),this.dispatchExceptionEventSendAudio(this.paramSecond.upAudioSlaveCache[h],e[t],h)),m+=parseInt(e[t].bytesSent),this.paramSecond.upAudioSlaveCache[h]=e[t],u.send.uid=this.adapterRef.channelInfo.uid,u.send.audioSlave.nextLost=e[t].packetsLost,u.send.audioSlave.nextPacket=e[t].packetsSent,u.send.audioSlave.rtt=u.recv.audioSlave.rtt=e[t].googRtt,u.send.audioSlave.jitter=u.recv.audioSlave.jitter=e[t].googJitterReceived||0,r.push(e[t]);else if(-1!==t.indexOf("_send_")&&-1!==t.indexOf("_audio"))!this.firstData.sendFirstAudioPackage&&e[t].packetsSent>0&&(this.firstData.sendFirstAudioPackage=!0,this.adapterRef.instance.apiEventReport("setSendFirstPackage",{media_type:0})),this.paramSecond.upAudioCache[h]&&(u.send.audio.prevLost=this.paramSecond.upAudioCache[h].packetsLost,u.send.audio.prevPacket=this.paramSecond.upAudioCache[h].packetsSent,e[t].alr=this.getPacketLossRate(this.paramSecond.upAudioCache[h],e[t],!0),this.dispatchExceptionEventSendAudio(this.paramSecond.upAudioCache[h],e[t],h)),m+=parseInt(e[t].bytesSent),this.paramSecond.upAudioCache[h]=e[t],u.send.uid=this.adapterRef.channelInfo.uid,u.send.audio.nextLost=e[t].packetsLost,u.send.audio.nextPacket=e[t].packetsSent,u.send.audio.rtt=u.recv.audio.rtt=e[t].googRtt,u.send.audio.jitter=u.recv.audio.jitter=e[t].googJitterReceived||0,i.push(e[t]);else if(-1!==t.indexOf("_send_")&&-1!==t.indexOf("_video")){!this.firstData.sendFirstVideoPackage&&e[t].packetsSent>0&&(this.firstData.sendFirstVideoPackage=!0,this.adapterRef.instance.apiEventReport("setSendFirstPackage",{media_type:1})),this.paramSecond.upVideoCache[h]&&(u.send.video.prevLost=this.paramSecond.upVideoCache[h].packetsLost,u.send.video.prevPacket=this.paramSecond.upVideoCache[h].packetsSent,e[t].vlr=this.getPacketLossRate(this.paramSecond.upVideoCache[h],e[t],!0),this.dispatchExceptionEventSendVideo(this.paramSecond.upVideoCache[h],e[t],h));let i=this.getLocalVideoFreezeStats(e[t],h);e[t].freezeTime=i.freezeTime,e[t].totalFreezeTime=i.totalFreezeTime,e[t]=Object.assign({},e.bweforvideo,e[t]),m+=parseInt(e[t].bytesSent),this.paramSecond.upVideoCache[h]=e[t],u.send.uid=this.adapterRef.channelInfo.uid,u.send.video.nextLost=e[t].packetsLost,u.send.video.nextPacket=e[t].packetsSent,u.send.video.rtt=u.recv.video.rtt=e[t].googRtt,u.send.video.jitter=u.recv.video.jitter=e[t].googJitterReceived||0,s.push(e[t])}else if(-1!==t.indexOf("_send_")&&-1!==t.indexOf("_screen")){!this.firstData.sendFirstScreenPackage&&e[t].packetsSent>0&&(this.firstData.sendFirstScreenPackage=!0,this.adapterRef.instance.apiEventReport("setSendFirstPackage",{media_type:2})),this.paramSecond.upScreenCache[h]&&(u.send.screen.prevLost=this.paramSecond.upScreenCache[h].packetsLost,u.send.screen.prevPacket=this.paramSecond.upScreenCache[h].packetsSent,e[t].vlr=this.getPacketLossRate(this.paramSecond.upScreenCache[h],e[t],!0));let i=this.getLocalScreenFreezeStats(e[t],h);e[t].freezeTime=i.freezeTime,e[t].totalFreezeTime=i.totalFreezeTime,Object.assign(e[t],e.bweforvideo),m+=parseInt(e[t].bytesSent),this.paramSecond.upScreenCache[h]=e[t],u.send.uid=this.adapterRef.channelInfo.uid,u.send.screen.nextLost=e[t].packetsLost,u.send.screen.nextPacket=e[t].packetsSent,u.send.screen.rtt=u.recv.screen.rtt=e[t].googRtt,u.send.screen.jitter=u.recv.screen.jitter=e[t].googJitterReceived||0,a.push(e[t])}else if(-1!==t.indexOf("_recv_")&&-1!==t.indexOf("_audioSlave")){this.paramSecond.downAudioSlaveCache[h]&&(u.recv.audio.prevLost=this.paramSecond.downAudioSlaveCache[h].packetsLost,u.recv.audio.prevPacket=this.paramSecond.downAudioSlaveCache[h].packetsReceived,e[t].alr=this.getPacketLossRate(this.paramSecond.downAudioSlaveCache[h],e[t]));let i=this.getRemoteAudioFreezeStats(this.paramSecond.downAudioSlaveCache[h],e[t],h);e[t].freezeTime=i.freezeTime,e[t].totalFreezeTime=i.totalFreezeTime,p+=parseInt(e[t].bytesReceived),this.paramSecond.downAudioSlaveCache[h]=e[t],u.recv.uid=+h,u.recv.audioSlave.nextLost=e[t].packetsLost,u.recv.audioSlave.nextPacket=e[t].packetsReceived,n.push(e[t]);let r=0;e[t].audioOutputLevel>=0?r=e[t].audioOutputLevel:e[t].audioLevel>=0&&(r=Math.floor(32768*e[t].audioLevel));const s=this.adapterRef.remoteStreamMap[h];let a=!0;s&&(s.muteStatus.audioSlave.send||s.muteStatus.audioSlave.recv)&&(a=!1),s&&s.Play&&s.Play.audioSlaveDom&&s.Play.audioSlaveDom.srcObject&&!s.Play.audioSlaveDom.muted||(a=!1),this._audioLevel.push({uid:h,level:a&&+r||0,type:"audioSlave"})}else if(-1!==t.indexOf("_recv_")&&-1!==t.indexOf("_audio")){this.firstData.recvFirstData[h]||(this.firstData.recvFirstData[h]={recvFirstAudioFrame:!1,recvFirstVideoFrame:!1,recvFirstScreenFrame:!1,recvFirstAudioPackage:!1,recvFirstVideoPackage:!1,recvFirstScreenPackage:!1,videoTotalPlayDuration:0,screenTotalPlayDuration:0}),!this.firstData.recvFirstData[h].recvFirstAudioFrame&&parseInt(e[t].googDecodingNormal)>0&&(this.firstData.recvFirstData[h].recvFirstAudioFrame=!0,this.adapterRef.instance.apiEventReport("setRecvFirstFrame",{media_type:0,pull_uid:h})),!this.firstData.recvFirstData[h].recvFirstAudioPackage&&parseInt(e[t].packetsReceived)>0&&(this.firstData.recvFirstData[h].recvFirstAudioPackage=!0,this.adapterRef.instance.apiEventReport("setRecvFirstPackage",{media_type:0,pull_uid:h})),this.paramSecond.downAudioCache[h]&&(u.recv.audio.prevLost=this.paramSecond.downAudioCache[h].packetsLost,u.recv.audio.prevPacket=this.paramSecond.downAudioCache[h].packetsReceived,e[t].alr=this.getPacketLossRate(this.paramSecond.downAudioCache[h],e[t]));let i=this.getRemoteAudioFreezeStats(this.paramSecond.downAudioCache[h],e[t],h);if(e[t].freezeTime=i.freezeTime,e[t].totalFreezeTime=i.totalFreezeTime,p+=parseInt(e[t].bytesReceived),"yes"===this.adapterRef.audioAsl.enabled&&this.adapterRef._mediasoup){this.adapterRef._mediasoup.getReceivers({}).filter(e=>"audio"===e.mediaType||"audioSlave"===e.mediaType).length>this.adapterRef.audioAsl.aslActiveNum||this.dispatchExceptionEventRecvAudio(this.paramSecond.downAudioCache[h],e[t],h)}else this.dispatchExceptionEventRecvAudio(this.paramSecond.downAudioCache[h],e[t],h);this.paramSecond.downAudioCache[h]=e[t],u.recv.uid=+h,u.recv.audio.nextLost=e[t].packetsLost,u.recv.audio.nextPacket=e[t].packetsReceived,o.push(e[t]);let r=0;e[t].audioOutputLevel>=0?r=e[t].audioOutputLevel:e[t].audioLevel>=0&&(r=Math.floor(32768*e[t].audioLevel));const s=this.adapterRef.remoteStreamMap[h];let a=!0;s&&(s.muteStatus.audio.send||s.muteStatus.audio.recv)&&(a=!1),s&&s.Play&&s.Play.audioDom&&s.Play.audioDom.srcObject&&!s.Play.audioDom.muted||(a=!1),this._audioLevel.push({uid:h,level:a&&+r||0,type:"audio"})}else if(-1!==t.indexOf("_recv_")&&-1!==t.indexOf("_video")){this.firstData.recvFirstData[h]||(this.firstData.recvFirstData[h]={recvFirstAudioFrame:!1,recvFirstVideoFrame:!1,recvFirstScreenFrame:!1,recvFirstAudioPackage:!1,recvFirstVideoPackage:!1,recvFirstScreenPackage:!1,videoTotalPlayDuration:0,screenTotalPlayDuration:0}),!this.firstData.recvFirstData[h].recvFirstVideoFrame&&e[t].framesDecoded>0?(this.firstData.recvFirstData[h].recvFirstVideoFrame=!0,this.adapterRef.instance.apiEventReport("setRecvFirstFrame",{media_type:1,pull_uid:h})):e[t].framesDecoded>0&&this.firstData.recvFirstData[h].videoTotalPlayDuration++,!this.firstData.recvFirstData[h].recvFirstVideoPackage&&e[t].packetsReceived>0&&(this.firstData.recvFirstData[h].recvFirstVideoPackage=!0,this.adapterRef.instance.apiEventReport("setRecvFirstPackage",{media_type:1,pull_uid:h})),this.paramSecond.downVideoCache[h]&&(u.recv.video.prevLost=this.paramSecond.downVideoCache[h].packetsLost,u.recv.video.prevPacket=this.paramSecond.downVideoCache[h].packetsReceived,e[t].vlr=this.getPacketLossRate(this.paramSecond.downVideoCache[h],e[t]));let i=this.getRemoteVideoFreezeStats(this.paramSecond.downVideoCache[h],e[t],h);e[t].freezeTime=i.freezeTime,e[t].totalFreezeTime=i.totalFreezeTime,this.dispatchExceptionEventRecvVideo(this.paramSecond.downVideoCache[h],e[t],h),p+=parseInt(e[t].bytesReceived),this.paramSecond.downVideoCache[h]=e[t],u.recv.uid=+h,u.recv.video.nextLost=e[t].packetsLost,u.recv.video.nextPacket=e[t].packetsReceived,d.push(e[t])}else if(-1!==t.indexOf("_recv_")&&-1!==t.indexOf("_screen")){this.firstData.recvFirstData[h]||(this.firstData.recvFirstData[h]={recvFirstAudioFrame:!1,recvFirstVideoFrame:!1,recvFirstScreenFrame:!1,recvFirstAudioPackage:!1,recvFirstVideoPackage:!1,recvFirstScreenPackage:!1,videoTotalPlayDuration:0,screenTotalPlayDuration:0}),!this.firstData.recvFirstData[h].recvFirstScreenFrame&&e[t].framesDecoded>0?(this.firstData.recvFirstData[h].recvFirstScreenFrame=!0,this.adapterRef.instance.apiEventReport("setRecvFirstFrame",{media_type:2,pull_uid:h})):e[t].framesDecoded>0&&this.firstData.recvFirstData[h].screenTotalPlayDuration++,!this.firstData.recvFirstData[h].recvFirstScreenPackage&&e[t].packetsReceived>0&&(this.firstData.recvFirstData[h].recvFirstScreenPackage=!0,this.adapterRef.instance.apiEventReport("setRecvFirstPackage",{media_type:2,pull_uid:h})),this.paramSecond.downScreenCache[h]&&(u.recv.screen.prevLost=this.paramSecond.downScreenCache[h].packetsLost,u.recv.screen.prevPacket=this.paramSecond.downScreenCache[h].packetsReceived,e[t].vlr=this.getPacketLossRate(this.paramSecond.downScreenCache[h],e[t]));let i=this.getRemoteScreenFreezeStats(this.paramSecond.downScreenCache[h],e[t],h);e[t].freezeTime=i.freezeTime,e[t].totalFreezeTime=i.totalFreezeTime,this.dispatchExceptionEventRecvScreen(this.paramSecond.downScreenCache[h],e[t],h),p+=parseInt(e[t].bytesReceived),this.paramSecond.downScreenCache[h]=e[t],u.recv.uid=+h,u.recv.screen.nextLost=e[t].packetsLost,u.recv.screen.nextPacket=e[t].packetsReceived,l.push(e[t])}else if(-1!==t.indexOf("Conn-")){this.publicIP=e[t]&&e[t].googLocalAddress.match(/([0-9\.]+)/)[1];let i="0"==e[t].googRtt?"1":e[t].googRtt;this.adapterRef.transportStats.txRtt=i,this.adapterRef.transportStats.rxRtt=i}else if(-1!==t.indexOf("local-candidate"))e[t].networkType&&(this.adapterRef.transportStats.NetworkType=e[t].networkType);else if(-1!==t.indexOf("candidate-pair")&&-1!==t.indexOf("send")){t.split("_")[1]==this.adapterRef.channelInfo.uid&&(this.adapterRef.transportStats.OutgoingAvailableBandwidth=e[t].availableOutgoingBitrate/1e3)}else this.network=e[t]&&e[t].network}if(this.adapterRef.sessionStats.RecvBytes=p,this.adapterRef.sessionStats.SendBytes=m,1!==t&&(this._audioLevel.sort(h.compare("level")),this._audioLevel.length>0&&this._audioLevel[0].level>0&&this.adapterRef.instance.safeEmit("active-speaker",this._audioLevel[0]),t%2==0)){this.adapterRef.instance.safeEmit("volume-indicator",this._audioLevel),this.updateTxMediaInfo(i,r,s,a),this.updateRxMediaInfo(o,n,d,l),(this.infos2.tx2&&this.infos2.tx2[0].v_res.length)===this.infos.interval/2&&this.send()}}updateOnce(){this.initInfoData(),this.send()}updateRxMediaInfo(e,t,i,r){let s={uid:[],a_p_volume:[],a_d_nor:[],a_d_plc:[],a_d_plccng:[],a_stuck:[],a_bps:[],a_p_lost_r:[],a_delay:[],a_acc_r:[]},a={v_res:[],v_fps:[],v_plis:[],v_stuck:[],v_bw_kbps:[],v_bps:[],v_p_lost_r:[],v_dec_ms:[],v_delay:[]},o={v_res:[],v_fps:[],v_plis:[],v_stuck:[],v_bw_kbps:[],v_bps:[],v_p_lost_r:[],v_dec_ms:[],v_delay:[]},n=0;t.map(e=>{let t="0";e.id&&(t=e.id.split("_")[3]),this.adapterRef.remoteAudioSlaveStats[t]&&(this.adapterRef.remoteAudioSlaveStats[t]={TotalFreezeTime:0});const i=this.adapterRef.remoteStreamMap[t];this.adapterRef.remoteAudioSlaveStats[t]={CodecType:"Opus",End2EndDelay:(parseInt(e.googCurrentDelayMs)||0)+(parseInt(e.googJitterBufferMs)||0),MuteState:i&&(i.muteStatus.audio.send||i.muteStatus.audio.recv),PacketLossRate:e.alr||0,RecvBitrate:e.bitsReceivedPerSecond||0,RecvLevel:parseInt(e.audioOutputLevel)||+e.audioLevel||0,TotalFreezeTime:e.totalFreezeTime||0,TotalPlayDuration:parseInt(e.totalSamplesDuration)||0,TransportDelay:parseInt(e.googCurrentDelayMs)||0}}),e.map(e=>{let t="0";e.id&&(t=e.id.split("_")[3]),this.adapterRef.remoteAudioStats[t]&&(this.adapterRef.remoteAudioStats[t]={TotalFreezeTime:0});const i=this.adapterRef.remoteStreamMap[t];this.adapterRef.remoteAudioStats[t]={CodecType:"Opus",End2EndDelay:(parseInt(e.googCurrentDelayMs)||0)+(parseInt(e.googJitterBufferMs)||0),MuteState:i&&(i.muteStatus.audio.send||i.muteStatus.audio.recv),PacketLossRate:e.alr||0,RecvBitrate:e.bitsReceivedPerSecond||0,RecvLevel:parseInt(e.audioOutputLevel)||+e.audioLevel||0,TotalFreezeTime:e.totalFreezeTime||0,TotalPlayDuration:parseInt(e.totalSamplesDuration)||0,TransportDelay:parseInt(e.googCurrentDelayMs)||0},n+=e.bitsReceivedPerSecond,s.uid.push(t),s.a_p_volume.push(+(e.audioOutputLevel||e.audioLevel)||0),s.a_d_nor.push(parseInt(e.googDecodingNormal)||0),s.a_d_plc.push(parseInt(e.googDecodingPLC)||0),s.a_d_plccng.push(parseInt(e.googDecodingPLCCNG)||0),s.a_stuck.push(e.freezeTime||0),s.a_bps.push(e.bitsReceivedPerSecond||0),s.a_p_lost_r.push(e.alr||0),s.a_delay.push(parseInt(e.googJitterBufferMs)||0),s.a_acc_r.push(0)}),i.map(e=>{let t="0";e.id&&(t=e.id.split("_")[3]);const i=this.adapterRef.remoteStreamMap[t];this.adapterRef.remoteVideoStats[t]&&(this.adapterRef.remoteVideoStats[t]={TotalFreezeTime:0});const r=i&&i.Play&&i.Play.videoDom;this.adapterRef.remoteVideoStats[t]={LayerType:1,CodecName:e.googCodecName,End2EndDelay:(parseInt(e.googCurrentDelayMs)||0)+(parseInt(e.googJitterBufferMs)||0)+(parseInt(e.googRenderDelayMs)||0),MuteState:i&&(i.muteStatus.video.send||i.muteStatus.video.recv),PacketLossRate:e.vlr||0,RecvBitrate:e.bitsReceivedPerSecond||0,RecvResolutionHeight:parseInt(e.googFrameHeightReceived)||0,RecvResolutionWidth:parseInt(e.googFrameWidthReceived)||0,RenderFrameRate:parseInt(e.googFrameRateOutput)||0,RenderResolutionHeight:r?r.videoHeight:0,RenderResolutionWidth:r?r.videoWidth:0,TotalFreezeTime:e.totalFreezeTime||0,TotalPlayDuration:this.firstData.recvFirstData[t]&&this.firstData.recvFirstData[t].videoTotalPlayDuration||(r&&r.played&&r.played.length?r.played.end(0):0),TransportDelay:parseInt(e.googCurrentDelayMs)||0},n+=e.bitsReceivedPerSecond,a.v_res.push((e.googFrameWidthReceived||0)+"x"+(e.googFrameHeightReceived||0)),a.v_fps.push(parseInt(e.googFrameRateOutput)),a.v_plis.push(parseInt(e.googPlisSent)),a.v_stuck.push(e.freezeTime||0),a.v_bw_kbps.push(0),a.v_bps.push(e.bitsReceivedPerSecond||0),a.v_p_lost_r.push(e.vlr||0),a.v_dec_ms.push(parseInt(e.googDecodeMs)||0),a.v_delay.push(parseInt(e.googJitterBufferMs))}),r.map(e=>{let t=0;e.id&&(t=+e.id.split("_")[3]);const i=this.adapterRef.remoteStreamMap[t];this.adapterRef.remoteScreenStats[t]&&(this.adapterRef.remoteScreenStats[t]={TotalFreezeTime:0});const r=i&&i.Play&&i.Play.screenDom;this.adapterRef.remoteScreenStats[t]={LayerType:2,CodecName:e.googCodecName,End2EndDelay:(parseInt(e.googCurrentDelayMs)||0)+(parseInt(e.googJitterBufferMs)||0)+(parseInt(e.googRenderDelayMs)||0),MuteState:i&&(i.muteStatus.screen.send||i.muteStatus.screen.recv),PacketLossRate:e.vlr||0,RecvBitrate:e.bitsReceivedPerSecond||0,RecvResolutionHeight:parseInt(e.googFrameHeightReceived)||0,RecvResolutionWidth:parseInt(e.googFrameWidthReceived)||0,RenderFrameRate:parseInt(e.googFrameRateOutput)||0,RenderResolutionHeight:r?r.videoHeight:0,RenderResolutionWidth:r?r.videoWidth:0,TotalFreezeTime:e.totalFreezeTime||0,TotalPlayDuration:this.firstData.recvFirstData[t]&&this.firstData.recvFirstData[t].screenTotalPlayDuration||(r&&r.played&&r.played.length?r.played.end(0):0),TransportDelay:parseInt(e.googCurrentDelayMs)||0},n+=e.bitsReceivedPerSecond,o.v_res.push((e.googFrameWidthReceived||0)+"x"+(e.googFrameHeightReceived||0)),o.v_fps.push(parseInt(e.googFrameRateOutput)),o.v_plis.push(parseInt(e.googPlisSent)),o.v_stuck.push(e.freezeTime||0),o.v_bw_kbps.push(0),o.v_bps.push(e.bitsReceivedPerSecond||0),o.v_p_lost_r.push(e.vlr||0),o.v_dec_ms.push(parseInt(e.googDecodeMs)||0),o.v_delay.push(parseInt(e.googJitterBufferMs))}),this.adapterRef.sessionStats.RecvBitrate=n,this.infos2.rx2.push({uid:s.uid,a_p_volume:s.a_p_volume,a_d_nor:s.a_d_nor,a_d_plc:s.a_d_plc,a_d_plccng:s.a_d_plccng,a_stuck:s.a_stuck,a_bps:s.a_bps,a_p_lost_r:s.a_p_lost_r,a_delay:s.a_delay,a_acc_r:s.a_acc_r,v_res:a.v_res,v_fps:a.v_fps,v_plis:a.v_plis,v_stuck:a.v_stuck,v_bw_kbps:a.v_bw_kbps,v_bps:a.v_bps,v_p_lost_r:a.v_p_lost_r,v_dec_ms:a.v_dec_ms,v_delay:a.v_delay,s_res:o.v_res,s_fps:o.v_fps,s_plis:o.v_plis,s_stuck:o.v_stuck,s_bw_kbps:o.v_bw_kbps,s_bps:o.v_bps,s_p_lost_r:o.v_p_lost_r,s_dec_ms:o.v_dec_ms,s_delay:o.v_delay})}getLocalMediaStats(e,t,i,r){let s={a_lost:e[0]&&e[0].alr||0,v_lost:i[0]&&i[0].vlr||0,s_lost:r[0]&&r[0].vlr||0,rtt:parseInt(i[0]&&i[0].googRtt)||0,rtt_mdev:-1,set_v_fps:parseInt(this.adapterRef.channelInfo.sessionConfig.frameRate)||0,v_cap_fps:parseInt(i[0]&&i[0].googFrameRateInput)||0,s_cap_fps:parseInt(r[0]&&r[0].googFrameRateInput)||0,qos_v_fps:parseInt(i[0]&&i[0].googFrameRateInput)||0,qos_s_fps:parseInt(r[0]&&r[0].googFrameRateInput)||0,v_fps:parseInt(i[0]&&i[0].googFrameRateSent)||0,s_fps:parseInt(r[0]&&r[0].googFrameRateSent)||0,set_v_quality:this.adapterRef.channelInfo.sessionConfig.videoQuality,real_v_res:(i[0]&&i[0].googFrameWidthSent||0)+"x"+(i[0]&&i[0].googFrameHeightSent||0),real_s_res:(r[0]&&r[0].googFrameWidthSent||0)+"x"+(r[0]&&r[0].googFrameHeightSent||0),real_v_kbps:parseFloat(i[0]&&i[0].googActualEncBitrate)||0,real_s_kbps:parseFloat(r[0]&&r[0].googActualEncBitrate)||0,real_v_kbps_n:parseFloat(i[0]&&i[0].googTransmitBitrate)||0,real_s_kbps_n:parseFloat(r[0]&&r[0].googTransmitBitrate)||0,real_a_kbps:-1,real_a_kbps_n:e[0]?e[0].bitsSentPerSecond:0,set_v_kbps:-1,qos_v_kbps:-1,a_volume:parseInt(e[0]&&e[0].audioInputLevel)||0,a_cap_volume:this.adapterRef.localStream&&Math.round(32768*this.adapterRef.localStream.getAudioLevel())||0,a_codec:e[0]&&e[0].googCodecName||"opus",a_stream_ended:this.LocalAudioEnable||!1,a_ssrc:e[0]&&e[0].ssrc||"",v_codec:i[0]&&i[0].googCodecName||"h264",s_codec:r[0]&&r[0].googCodecName||"h264",v_stream_ended:this.localVideoEnable||!1,s_stream_ended:this.localScreenEnable||!1,v_ssrc:i[0]&&i[0].ssrc||"",s_ssrc:r[0]&&r[0].ssrc||""},a=48;if(this.adapterRef.localStream&&"speech_low_quality"==this.adapterRef.localStream.audioProfile?a=16:this.adapterRef.localStream&&"speech_standard"==this.adapterRef.localStream.audioProfile&&(a=32),this.adapterRef.sessionStats.SendBitrate=s.real_v_kbps_n+s.real_a_kbps_n,!this.adapterRef.localStream){let e="getLocalMediaStats: localStream is not found",t="getLocalMediaStats: 未找到 localStream",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=c.IS_ZH?t:e,a=c.IS_ZH?r:i;throw new d.default({code:n.default.LOCALSTREAM_NOT_FOUND_ERROR,message:s,advice:a})}return this.adapterRef.localAudioStats[0]={CodecType:"Opus",MuteState:this.adapterRef.localStream.muteStatus.audio.send,RecordingLevel:s.a_volume,SamplingRate:a,SendBitrate:s.real_a_kbps_n,SendLevel:s.a_volume},this.adapterRef.localAudioSlaveStats[0]={CodecType:"Opus",MuteState:this.adapterRef.localStream.muteStatus.audioSlave.send,RecordingLevel:parseInt(t[0]&&t[0].audioInputLevel)||0,SamplingRate:a,SendBitrate:t[0]?t[0].bitsSentPerSecond:0,SendLevel:parseInt(t[0]&&t[0].audioInputLevel)||0},this.adapterRef.localVideoStats[0]={LayerType:1,CodecName:i[0]&&i[0].googCodecName,CaptureFrameRate:s.v_cap_fps,CaptureResolutionHeight:parseInt(i[0]&&i[0].googFrameHeightInput)||0,CaptureResolutionWidth:parseInt(i[0]&&i[0].googFrameWidthInput)||0,EncodeDelay:parseInt(i[0]&&i[0].googAvgEncodeMs)||0,MuteState:this.adapterRef.localStream.muteStatus.video.send,SendBitrate:s.real_v_kbps_n,SendFrameRate:s.v_fps,SendResolutionHeight:parseInt(i[0]&&i[0].googFrameHeightSent)||0,SendResolutionWidth:parseInt(i[0]&&i[0].googFrameWidthSent)||0,TargetSendBitrate:parseInt(i[0]&&i[0].googTargetEncBitrate)||0,TotalDuration:this.adapterRef.state.startPubVideoTime?(Date.now()-this.adapterRef.state.startPubVideoTime)/1e3:0,TotalFreezeTime:i[0]?i[0].totalFreezeTime:0},this.adapterRef.localScreenStats[0]={LayerType:2,CodecName:r[0]&&r[0].googCodecName,CaptureFrameRate:s.s_cap_fps,CaptureResolutionHeight:parseInt(r[0]&&r[0].googFrameHeightInput)||0,CaptureResolutionWidth:parseInt(r[0]&&r[0].googFrameWidthInput)||0,EncodeDelay:parseInt(r[0]&&r[0].googAvgEncodeMs)||0,MuteState:this.adapterRef.localStream.muteStatus.screen.send,SendBitrate:s.real_s_kbps_n,SendFrameRate:s.s_fps,SendResolutionHeight:parseInt(r[0]&&r[0].googFrameHeightSent)||0,SendResolutionWidth:parseInt(r[0]&&r[0].googFrameWidthSent)||0,TargetSendBitrate:parseInt(r[0]&&r[0].googTargetEncBitrate)||0,TotalDuration:this.adapterRef.state.startPubScreenTime?(Date.now()-this.adapterRef.state.startPubScreenTime)/1e3:0,TotalFreezeTime:r[0]?r[0].totalFreezeTime:0},this.infos2.tx2[0].v_res.push(s.real_v_res),this.infos2.tx2[0].v_fps.push(s.v_fps),this.infos2.tx2[0].v_plis.push(i[0]&&i[0].googPlisReceived),this.infos2.tx2[0].v_rtt.push(s.rtt),this.infos2.tx2[0].v_simulcast.push(0),this.infos2.tx2[0].v_bw_kbps.push(i[0]&&i[0].googAvailableSendBandwidth),this.infos2.tx2[0].v_tar_kbps.push(i[0]&&i[0].googTargetEncBitrate),this.infos2.tx2[0].v_rel_kbps.push(i[0]&&i[0].googActualEncBitrate),this.infos2.tx2[0].v_tx_kbps.push(i[0]&&i[0].googTransmitBitrate),this.infos2.tx2[0].v_retx_kbps.push(i[0]&&i[0].googRetransmitBitrate),this.infos2.tx2[0].v_delay.push(0),this.infos2.tx2[0].s_res.push(s.real_s_res),this.infos2.tx2[0].s_fps.push(s.s_fps),this.infos2.tx2[0].s_plis.push(r[0]&&r[0].googPlisReceived),this.infos2.tx2[0].s_rtt.push(s.rtt),this.infos2.tx2[0].s_simulcast.push(0),this.infos2.tx2[0].s_bw_kbps.push(r[0]&&r[0].googAvailableSendBandwidth),this.infos2.tx2[0].s_tar_kbps.push(r[0]&&r[0].googTargetEncBitrate),this.infos2.tx2[0].s_rel_kbps.push(r[0]&&r[0].googActualEncBitrate),this.infos2.tx2[0].s_tx_kbps.push(r[0]&&r[0].googTransmitBitrate),this.infos2.tx2[0].s_retx_kbps.push(r[0]&&r[0].googRetransmitBitrate),this.infos2.tx2[0].s_delay.push(0),this.infos2.tx2[0].a_cap_volume.push(s.a_cap_volume),this.infos2.tx2[0].a_rtt.push(e[0]&&e[0].googRtt),s}updateTxMediaInfo(e,t,i,r){if(!this.adapterRef.localStream)return;this.getLocalMediaStats(e,t,i,r);let s=((navigator.connection||{}).type||"unknown").toString().toLowerCase();this.infos.net=h.convertNetwork(this.network||s)}dispatchExceptionEventSendAudio(e,t,i){var r,s;if(!e||!t)return;const a=null===(r=this.adapterRef.localStream)||void 0===r?void 0:r.muteStatus.audio.send,o=null===(s=this.adapterRef.localStream)||void 0===s?void 0:s.pubStatus.audio.audio;if(!0===a||!1===o)return;0===parseInt(t.audioInputLevel)&&this.adapterRef.instance.safeEmit("exception",{msg:"AUDIO_INPUT_LEVEL_TOO_LOW",code:2001,uid:i}),0===parseInt(t.bytesSent)-parseInt(e.bytesSent)&&this.adapterRef.instance.safeEmit("exception",{msg:"SEND_AUDIO_BITRATE_TOO_LOW",code:2003,uid:i})}dispatchExceptionEventSendVideo(e,t,i){var r,s;if(!e||!t)return;const a=null===(r=this.adapterRef.localStream)||void 0===r?void 0:r.muteStatus.video.send,o=null===(s=this.adapterRef.localStream)||void 0===s?void 0:s.pubStatus.video.video;if(!0===a||!1===o)return;parseInt(t.googFrameRateInput)>5&&parseInt(t.googFrameRateSent)<=1&&this.adapterRef.instance.safeEmit("exception",{msg:"FRAMERATE_SENT_TOO_LOW",code:1002,uid:i}),0===parseInt(t.bytesSent)-parseInt(e.bytesSent)&&this.adapterRef.instance.safeEmit("exception",{msg:"FRAMERATE_VIDEO_BITRATE_TOO_LOW",code:1003,uid:i})}dispatchExceptionEventRecvAudio(e,t,i){if(!e||!t)return;const r=this.adapterRef.remoteStreamMap[i],s=r&&(r.muteStatus.audio.send||r.muteStatus.audio.recv);if(r&&s)return;if(!r||!r.Play||!r.Play.audioDom||!r.Play.audioDom.srcObject||r.Play.audioDom.muted)return;let a=parseInt(t.bytesReceived)-parseInt(e.bytesReceived),o=parseInt(t.googDecodingNormal)-parseInt(e.googDecodingNormal);if(a>0&&0===o&&this.adapterRef.instance.safeEmit("exception",{msg:"RECV_AUDIO_DECODE_FAILED",code:2005,uid:i}),a>0&&o>0&&0==+(t.audioOutputLevel||t.audioLevel)){const e=r&&r.Play&&r.Play.audioDom&&r.Play.audioDom.volume;e&&e>0&&this.adapterRef.instance.safeEmit("exception",{msg:"AUDIO_OUTPUT_LEVEL_TOO_LOW",code:2002,uid:i})}}dispatchExceptionEventRecvVideo(e,t,i){if(!e||!t)return;const r=this.adapterRef.remoteStreamMap[i],s=r&&(r.muteStatus.video.send||r.muteStatus.video.recv);if(r&&s)return;parseInt(t.bytesReceived)-parseInt(e.bytesReceived)>0&&0===parseInt(t.googFrameRateDecoded)&&this.adapterRef.instance.safeEmit("exception",{msg:"RECV_VIDEO_DECODE_FAILED",code:1005,uid:i})}dispatchExceptionEventRecvScreen(e,t,i){if(!e||!t)return;const r=this.adapterRef.remoteStreamMap[i],s=r&&(r.muteStatus.screen.send||r.muteStatus.screen.recv);if(r&&s)return;parseInt(t.bytesReceived)-parseInt(e.bytesReceived)>0&&0===parseInt(t.googFrameRateDecoded)&&this.adapterRef.instance.safeEmit("exception",{msg:"RECV_SCREEN_DECODE_FAILED",code:1005,uid:i})}getRemoteAudioFreezeStats(e,t,i){if(!e||!t)return{totalFreezeTime:0,freezeTime:0};let r=parseInt(e.googDecodingPLC)+parseInt(e.googDecodingCNG)+parseInt(e.googDecodingPLCCNG),s=parseInt(e.googDecodingCTN),a=parseInt(t.googDecodingPLC)+parseInt(t.googDecodingCNG)+parseInt(t.googDecodingPLCCNG),o=parseInt(t.googDecodingCTN);if(o<=r)return{totalFreezeTime:0,freezeTime:0};let n=(a-r)/(o-s);return{totalFreezeTime:parseInt(1e3*n),freezeTime:10*n>1?parseInt(10*n):n>0?1:0}}getLocalVideoFreezeStats(e,t){let i=0;if(!e)return{totalFreezeTime:i,freezeTime:0};let r=parseInt(e.googFrameRateInput),s=parseInt(e.googFrameRateSent);if(r<=0||s<=0)return{totalFreezeTime:2e3,freezeTime:6};let a=Math.abs(r-s-2);i=parseInt(2e3*(a/r));let o=0;i<300?(i=0,o=0):o=i>1500?6:parseInt(i/300);return{totalFreezeTime:i,freezeTime:o}}getLocalScreenFreezeStats(e,t){let i=0;if(!e)return{totalFreezeTime:i,freezeTime:0};let r=parseInt(e.googFrameRateInput),s=parseInt(e.googFrameRateSent);if(r<=0||s<=0)return{totalFreezeTime:2e3,freezeTime:6};let a=Math.abs(r-s-2);i=parseInt(2e3*(a/r));let o=0;i<300?(i=0,o=0):o=i>1500?6:parseInt(i/300);return{totalFreezeTime:i,freezeTime:o}}getRemoteVideoFreezeStats(e,t,i){let r=0;if(!t||0==t.framesDecoded)return{totalFreezeTime:r,freezeTime:0};if(t&&"0"==t.googFrameRateDecoded&&t.framesDecoded)return{totalFreezeTime:2e3,freezeTime:6};let s=parseInt(t.googFrameRateReceived)||0,a=parseInt(t.googFrameRateDecoded);if(s<=0||a<=0)return{totalFreezeTime:2e3,freezeTime:6};let o=Math.abs(a-s-2);if(s>15)return{totalFreezeTime:0,freezeTime:0};o=Math.abs(15-s),r=parseInt(2e3*(o/15)),r>2e3&&(r=2e3);let n=0;r<300?(r=0,n=0):n=r>1500?6:parseInt(r/300);return{totalFreezeTime:r,freezeTime:n}}getRemoteScreenFreezeStats(e,t,i){let r=0;if(!t)return{totalFreezeTime:r,freezeTime:0};let s=parseInt(t.googFrameRateReceived),a=parseInt(t.googFrameRateDecoded);if(s<=0||a<=0)return{totalFreezeTime:2e3,freezeTime:6};let o=Math.abs(a-s-2);r=parseInt(2e3*(o/a))||0;let n=0;r<300?(r=0,n=0):n=r>1500?6:parseInt(r/300);return{totalFreezeTime:r,freezeTime:n}}send(){if(!this.infos.uid||!this.infos.cid)return;let e=new u.DataReport({adapterRef:this.adapterRef});e.setHeartbeat({name:"setHeartbeat",uid:""+this.adapterRef.channelInfo.uid,cid:""+this.adapterRef.channelInfo.cid}),e.send(),this.clearInfoData()}destroy(){this.resetStatus(),this._reset()}};let h={convertNetwork:e=>({wlan:"wifi",lan:"ethernet"}[e]||"unknown"),convertPlatform(e){let t;return t=/Windows/i.test(e)?"Win":e,t=/OS X/i.test(t)?"Mac":t,t},compare:e=>function(t,i){var r=t[e],s=i[e];return 0===s||s?0===r||r?s-r:1:-1}}},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.GetStats=void 0;const o=i(13),n=a(i(2)),d=i(67);class c extends o.EventEmitter{constructor(e){super(),this.adapterRef=e.adapterRef,this.interval=e.interval||1e3,this.times=0,this.browser="chrome",this.KeyTransform={K:{googAvailableSendBandwidth:1,googTargetEncBitrate:1,googActualEncBitrate:1,googRetransmitBitrate:1,googTransmitBitrate:1},T:{}},this._reset()}_reset(){this.times=0,this.browser="chrome",n.IS_CHROME_ONLY&&n.CHROME_MAJOR_VERSION&&n.CHROME_MAJOR_VERSION>=72||n.IS_ANDROID?this.browser="chrome":n.IS_ANY_SAFARI&&n.SAFARI_MAJOR_VERSION&&n.SAFARI_MAJOR_VERSION>=12||n.IS_ANY_SAFARI&&n.IS_WECHAT?this.browser="safari":n.IS_FIREFOX&&n.FIREFOX_MAJOR_VERSION&&n.FIREFOX_MAJOR_VERSION>=60&&(this.browser="firefox"),this.KeyTransform={K:{googAvailableSendBandwidth:1,googTargetEncBitrate:1,googActualEncBitrate:1,googRetransmitBitrate:1,googTransmitBitrate:1},T:{}}}async getAllStats(){let e=this.adapterRef&&this.adapterRef._mediasoup&&this.adapterRef._mediasoup._sendTransport&&this.adapterRef._mediasoup._sendTransport._handler._pc,t=this.adapterRef&&this.adapterRef._mediasoup&&this.adapterRef._mediasoup._recvTransport&&this.adapterRef._mediasoup._recvTransport._handler._pc;if(!e&&!t)return;let i={local:e?await this.getLocalStats(e):null,remote:t?await this.getRemoteStats(t):null};return this.times=(this.times||0)+1,this.emit("stats",i,this.times),this.reviseData(i,this.browser)}reviseData(e,t){var i,r,s;let a=new Map,o=new Map;if("chrome"===t){let t=new Map([["candidate-pair",[]],["local-candidate",[]],["media-source",[]],["outbound-rtp",[]],["remote-candidate",[]],["remote-inbound-rtp",[]],["ssrc",[]],["VideoBwe",[]],["track",[]],["transport",[]]]),i=new Map([["candidate-pair",[]],["inbound-rtp",[]],["local-candidate",[]],["remote-candidate",[]],["ssrc",[]],["track",[]],["transport",[]]]),r=e.local,s=e.remote;for(let e in r)if(t.has(r[e].type))if(e.indexOf("ssrc")>-1){let t;e.indexOf("audio")>0||e.indexOf("video")>0?t=r[e].mediaType+"_ssrc":e.indexOf("screen")>0&&(t="screen_ssrc",r[e].mediaType="screen"),a.has(t)||a.set(t,[]),a.get(t).push(r[e])}else a.set(r[e].type,[]),a.get(r[e].type).push(r[e]);let n=Object.create(null);for(let[e,t]of a)n[e]=t;e.local=n;for(let e in s)if(i.has(s[e].type))if("ssrc"===s[e].type){let t;e.indexOf("audio")>0||e.indexOf("video")>0?t=`${s[e].mediaType}_${s[e].type}`:e.indexOf("screen")>0&&(t="screen_"+s[e].type,s[e].mediaType="screen"),o.has(t)||o.set(t,[]),o.get(t).push(s[e])}else{let t=s[e].type;o.has(t)||o.set(t,[]),o.get(t).push(s[e])}let d=Object.create(null);for(let[e,t]of o)d[e]=t;e.remote=d}else if("safari"===t){let t=e.local,i=e.remote,r=new Map([["outbound-rtp",[]],["track",[]]]);for(let e in t)if(r.has(t[e].type)){let i=`${t[e].mediaType}_${t[e].type}`;a.has(i)||a.set(i,[]),a.get(i).push(t[e])}let s=Object.create(null);for(let[e,t]of a)s[e]=t;e.local=s;let n=new Map([["inbound-rtp",[]],["track",[]]]);for(let e in i)if(n.has(i[e].type)){let t=`${i[e].mediaType}_${i[e].type}`;o.has(t)||o.set(t,[]),o.get(t).push(i[e])}let d=Object.create(null);for(let[e,t]of o)d[e]=t;e.remote=d}else if("firefox"===t){let t=e.local,i=e.remote,r=new Map([["candidate-pair",[]],["local-candidate",[]],["outbound-rtp",[]],["remote-candidate",[]]]);for(let e in t)if(r.has(t[e].type)){let i;i=e.indexOf("-outbound-rtp")>-1?`${t[e].mediaType}_${t[e].type}`:""+t[e].type,a.has(i)||a.set(i,[]),a.get(i).push(t[e])}let s=Object.create(null);for(let[e,t]of a)s[e]=t;e.local=s;let n=new Map([["candidate-pair",[]],["inbound-rtp",[]],["local-candidate",[]],["remote-candidate",[]]]);for(let e in i)if(n.has(i[e].type)){let t;t=e.indexOf("-inbound-rtp")>-1?`${i[e].mediaType}_${i[e].type}`:""+i[e].type,o.has(t)||o.set(t,[]),o.get(t).push(i[e])}let d=Object.create(null);for(let[e,t]of o)d[e]=t;e.remote=d}let c={"candidate-pair":"candidate_pair","local-candidate":"local_candidate","media-source":"media_source","outbound-rtp":"outbound_rtp","remote-candidate":"remote_candidate","remote-inbound-rtp":"remote_inbound_rtp",VideoBwe:"video_bwe","inbound-rtp":"inbound_rtp","audio_outbound-rtp":"audio_outbound_rtp","video_outbound-rtp":"video_outbound_rtp","audio_inbound-rtp":"audio_inbound_rtp","video_inbound-rtp":"video_inbound_rtp","screen_outbound-rtp":"screen_outbound_rtp","screen_inbound-rtp":"screen_inbound_rtp"};for(let t in e.local){let i=c[t];i&&(e.local[i]=e.local[t],delete e.local[t])}for(let t in e.remote){let i=c[t];i&&(e.remote[i]=e.remote[t],delete e.remote[t])}return e.timestamp=(new Date).getTime(),e.appkey=null===(i=this.adapterRef)||void 0===i?void 0:i.channelInfo.appkey,e.cid=null===(r=this.adapterRef)||void 0===r?void 0:r.channelInfo.cid,e.uid=null===(s=this.adapterRef)||void 0===s?void 0:s.channelInfo.uid,n.IS_EDG?e.browser="Edge-"+d.getBrowserInfo().browserVersion:n.IS_ANY_SAFARI?e.browser="Safari-iOS-"+d.getBrowserInfo().browserName+"-"+d.getBrowserInfo().browserVersion:n.IS_ANDROID?e.browser="Chrome-Android-"+d.getBrowserInfo().browserName+"-"+d.getBrowserInfo().browserVersion:e.browser=d.getBrowserInfo().browserName+"-"+d.getBrowserInfo().browserVersion,e.platform=d.getOSInfo().osName,e}async getLocalStats(e){return!e||/(failed|closed|new)/gi.test(e.iceConnectionState)?{}:await this[this.browser](e,"send")}async getRemoteStats(e){return!e||/(failed|closed|new)/gi.test(e.iceConnectionState)?{}:await this[this.browser](e,"recv")}async chrome(e,t){const i=await(()=>new Promise((i,r)=>{e.getStats(r=>{let s={};r.result().forEach((function(e){const t={};e.names().forEach((function(i){t[i]=e.stat(i)})),t.id=e.id,t.type=e.type,t.timestamp=e.timestamp,s[t.id]=t})),e.lastStats=e.lastStats||{},s=this.formatChromeNonStandardStats(e,s,t),i(s)})}))(),r=await(async()=>{if(!e.getTransceivers)return{};let i={};const r=e.getTransceivers();for(let e=0;e<r.length;e++){let s=null;const a=r[e];"sendonly"===a.direction?a.sender&&a.sender.getStats&&(s=await a.sender.getStats(),s=this.formatChromeStandardizedStats(s,t,0),Object.assign(i,s)):"recvonly"===a.direction&&a.receiver&&a.receiver.getStats&&(s=await a.receiver.getStats(),s=this.formatChromeStandardizedStats(s,t,0),Object.assign(i,s))}return i})();return Object.assign(i,r)}formatChromeNonStandardStats(e,t,i){const r={};return Object.values(t).forEach(t=>{if("recv"===i&&!/^ssrc_/i.test(t.id))return r;if("send"===i&&!/^(bweforvideo|Conn-0-1-0|ssrc_)/i.test(t.id))return r;"bweforvideo"===t.id&&(t=this.formatData(t));const s=("send"===i?/ssrc_(\d+)_send/i:/ssrc_(\d+)_recv/i).exec(t.id),a=t.id;if(r[a]=t,!s||!s[1])return r;const o=s[1];if(!this.adapterRef)return;const n=this.adapterRef.instance.getUidAndKindBySsrc(parseInt(o));let d,c=n.uid;if(d=n.kind?n.kind:"screen"===t.googContentType?"screen":t.mediaType,!c&&"recv"===i)return r;t.id=this.stringifyItemId("ssrc",i,"recv"===i?""+c:"0",d,n.streamType),t.localuid=this.adapterRef.channelInfo.uid,t.remoteuid=c,-1==(t=this.computeData(e,t)).googInterframeDelayMax&&(t.googInterframeDelayMax=0),r[t.id]=t,delete r[a]}),r}stringifyItemId(e,t,i,r,s){var a,o,n;let d;return d="send"===t?"high"===s?`${e}_${null===(a=this.adapterRef)||void 0===a?void 0:a.channelInfo.uid}_send_0_${r}`:`${e}_${null===(o=this.adapterRef)||void 0===o?void 0:o.channelInfo.uid}_send_0_${r}_${s}`:`${e}_${null===(n=this.adapterRef)||void 0===n?void 0:n.channelInfo.uid}_${t}_${i}_${r}`,d}parseItemId(e){const t=e.match(/([a-zA-Z\-])+_\d+_send_0_([a-zA-Z]+)/),i=e.match(/([a-zA-Z\-])+_\d+_send_0_([a-zA-Z]+)_([a-zA-Z]+)/),r=e.match(/([a-zA-Z\-])+_\d+_recv_(\d+)_([a-zA-Z]+)/);let s;return s=t?{type:t[1],direction:"send",remoteUid:"0",mediaType:t[2],streamType:"high"}:i?{type:i[1],direction:"send",remoteUid:"0",mediaType:i[2],streamType:i[3]}:r?{type:r[1],direction:"recv",remoteUid:r[2],mediaType:r[3]}:null,s}formatChromeStandardizedStats(e,t,i){let r={};if(e.forEach(e=>{"inbound-rtp"==e.type&&this.adapterRef&&this.adapterRef.instance&&(i=this.adapterRef.instance.getUidAndKindBySsrc(e.ssrc).uid)}),i||!(t.indexOf("recv")>-1))return e.forEach(e=>{"local-candidate"!=e.type&&"remote-candidate"!=e.type&&"track"!=e.type&&"outbound-rtp"!=e.type&&"remote-inbound-rtp"!=e.type&&"candidate-pair"!=e.type&&"media-source"!=e.type&&"inbound-rtp"!=e.type&&"transport"!=e.type||(r[`${e.type}_${this.adapterRef&&this.adapterRef.channelInfo.uid}_${t}_${i}`]=e)}),r}async safari(e,t){const i=await(async()=>{const i=await e.getStats();e.lastStats=e.lastStats||{};return this.formatSafariNonStandardStats(e,i,t)})(),r=await(async()=>{if(!e.getTransceivers)return{};let i={};const r=e.getTransceivers();for(let e=0;e<r.length;e++){let s=null;const a=r[e];"sendonly"===a.direction?a.sender&&a.sender.getStats&&(s=await a.sender.getStats(),s&&(s=this.formatSafariStandardizedStats(s,t)||{},Object.assign(i,s))):"recvonly"===a.direction&&a.receiver&&a.receiver.getStats&&(s=await a.receiver.getStats(),s&&(s=this.formatSafariStandardizedStats(s,t)||{},Object.assign(i,s)))}return i})();return Object.assign(i,r)}formatSafariNonStandardStats(e,t,i){let r={},s=new Map;return t.forEach(e=>{if("outbound-rtp"==e.type||"inbound-rtp"==e.type){const t=this.adapterRef?this.adapterRef.instance.getUidAndKindBySsrc(e.ssrc).uid:0;return s.set(e.trackId,{uid:t.toString(),ssrc:e.ssrc}),void(e.remoteuid=t.toString())}}),t.forEach(t=>{"track"==t.type?(t.ssrc=s.get(t.id.toString()).ssrc,t.remoteuid=t.uid=s.get(t.id.toString()).uid,t.framesSent||t.framesReceived?(t=this.computeData(e,t),r[`_video_${t.type}_${this.adapterRef&&this.adapterRef.channelInfo.uid}_${i}_${t.uid}`]=t,t.mediaType="video"):(r[`_audio_${t.type}_${this.adapterRef&&this.adapterRef.channelInfo.uid}_${i}_${t.uid}`]=t,t.mediaType="audio")):"outbound-rtp"!=t.type&&"inbound-rtp"!=t.type||(t=this.computeData(e,t),r[`${t.mediaType}_${t.type}_${this.adapterRef&&this.adapterRef.channelInfo.uid}_${i}_${t.uid}`]=t)}),r}formatSafariStandardizedStats(e,t){let i,r={};return e.forEach(e=>{"inbound-rtp"==e.type&&(i=this.adapterRef?this.adapterRef.instance.getUidAndKindBySsrc(e.ssrc).uid:i)}),e.forEach(e=>{"local-candidate"!=e.type&&"remote-candidate"!=e.type&&"track"!=e.type&&"outbound-rtp"!=e.type&&"remote-inbound-rtp"!=e.type&&"candidate-pair"!=e.type&&"media-source"!=e.type&&"inbound-rtp"!=e.type&&"transport"!=e.type||(r[`${e.type}_${this.adapterRef&&this.adapterRef.channelInfo.uid}_${t}_${i}`]=e)}),r}async firefox(e,t){const i=await(async()=>{let t=await e.getStats(),i={};return t.forEach(e=>{i[e.type]=e}),i})(),r=await(async()=>{if(!e.getTransceivers)return{};let i={};const r=e.getTransceivers();for(let e=0;e<r.length;e++){let s=null;const a=r[e];"sendonly"===a.direction?a.sender&&a.sender.getStats&&(s=await a.sender.getStats(),s=this.formatFirefoxStandardizedStats(s,t,0,a.mid),Object.assign(i,s)):"recvonly"===a.direction&&a.receiver&&a.receiver.getStats&&(s=await a.receiver.getStats(),s=this.formatFirefoxStandardizedStats(s,t,0),Object.assign(i,s))}return i})();return Object.assign(i,r)}formatFirefoxStandardizedStats(e,t,i,r){let s={};return e.forEach(e=>{if("inbound-rtp"==e.type&&this.adapterRef&&this.adapterRef.instance){const t=this.adapterRef.instance.getUidAndKindBySsrc(e.ssrc);e.remoteuid=t.uid,i=t.uid,"video"===e.kind&&(e.mediaType=t.kind?t.kind:"screen")}}),e.forEach(e=>{"outbound-rtp"==e.type&&"2"==r&&(e.mediaType="screen")}),e.forEach(e=>{"local-candidate"==e.type||"remote-candidate"==e.type||"remote-inbound-rtp"==e.type||"candidate-pair"==e.type?s[`${e.type}_${this.adapterRef&&this.adapterRef.channelInfo.uid}_${t}_${i}`]=e:"outbound-rtp"!=e.type&&"inbound-rtp"!=e.type||(s[`${e.mediaType}-${e.type}_${this.adapterRef&&this.adapterRef.channelInfo.uid}_${t}_${i}`]=e)}),s}formatData(e){return Object.keys(e).map(t=>{this.KeyTransform.K[t]&&(e[t]=(e[t]/1024).toFixed(2)),this.KeyTransform.T[t]&&(e[t]=(e[t]/1024/1024).toFixed(2))}),e}computeData(e,t){const i={pc:e,ssrcKey:t.ssrc,currentItem:t};return t.bytesSent&&(t.bitsSentPerSecond=this.getLastStats(Object.assign({},i,{firstKey:"bytesSent"}))),t.packetsSent&&(t.packetsSentPerSecond=this.getLastStats(Object.assign({},i,{firstKey:"packetsSent"}))),t.bytesReceived&&(t.bitsReceivedPerSecond=this.getLastStats(Object.assign({},i,{firstKey:"bytesReceived"}))),t.packetsReceived&&(t.packetsReceivedPerSecond=this.getLastStats(Object.assign({},i,{firstKey:"packetsReceived"}))),t.packetsSent&&t.packetsLost&&(t.sendPacketLoss=this.getLastStats(Object.assign({},i,{firstKey:"packetsSent",secondKey:"packetsLost"}))),t.packetsReceived&&t.packetsLost&&(t.recvPacketLoss=this.getLastStats(Object.assign({},i,{firstKey:"packetsReceived",secondKey:"packetsLost"}))),t.framesSent&&(t.frameRateSent=this.getLastStats(Object.assign({},i,{firstKey:"framesSent"}))),t}getLastStats(e={}){const{pc:t,ssrcKey:i,firstKey:r,secondKey:s=null,currentItem:a}=e;let o=0,n=0;if(t.lastStats[i]&&t.lastStats[i][r]){if(!(a[r]-t.lastStats[i][r]>0))return o;o=(a[r]-t.lastStats[i][r])/2,s&&(n=(a[s]-t.lastStats[i][s])/2)}else t.lastStats[i]||(t.lastStats[i]={}),o=a[r],s&&(n=a[s]);return o=/bytes/gi.test(r)?Math.round(8*o/1e3):s?r.indexOf("send")>-1?Math.floor(n/o*1e4)/100:n/(n+n)*1e4/100:o,t.lastStats[i][r]=a[r],s&&(t.lastStats[i][s]=a[s]),o}stop(){this._reset()}destroy(){this._reset()}}t.GetStats=c},function(module,exports,__webpack_require__){(function(process,global){var __WEBPACK_AMD_DEFINE_RESULT__;
/*
 * [js-sha1]{@link https://github.com/emn178/js-sha1}
 *
 * @version 0.6.0
 * @author Chen, Yi-Cyuan [emn178@gmail.com]
 * @copyright Chen, Yi-Cyuan 2014-2017
 * @license MIT
 */!function(){var root="object"==typeof window?window:{},NODE_JS=!root.JS_SHA1_NO_NODE_JS&&"object"==typeof process&&process.versions&&process.versions.node;NODE_JS&&(root=global);var COMMON_JS=!root.JS_SHA1_NO_COMMON_JS&&"object"==typeof module&&module.exports,AMD=__webpack_require__(266),HEX_CHARS="0123456789abcdef".split(""),EXTRA=[-2147483648,8388608,32768,128],SHIFT=[24,16,8,0],OUTPUT_TYPES=["hex","array","digest","arrayBuffer"],blocks=[],createOutputMethod=function(e){return function(t){return new Sha1(!0).update(t)[e]()}},createMethod=function(){var e=createOutputMethod("hex");NODE_JS&&(e=nodeWrap(e)),e.create=function(){return new Sha1},e.update=function(t){return e.create().update(t)};for(var t=0;t<OUTPUT_TYPES.length;++t){var i=OUTPUT_TYPES[t];e[i]=createOutputMethod(i)}return e},nodeWrap=function(method){var crypto=eval("require('crypto')"),Buffer=eval("require('buffer').Buffer"),nodeMethod=function(e){if("string"==typeof e)return crypto.createHash("sha1").update(e,"utf8").digest("hex");if(e.constructor===ArrayBuffer)e=new Uint8Array(e);else if(void 0===e.length)return method(e);return crypto.createHash("sha1").update(new Buffer(e)).digest("hex")};return nodeMethod};function Sha1(e){e?(blocks[0]=blocks[16]=blocks[1]=blocks[2]=blocks[3]=blocks[4]=blocks[5]=blocks[6]=blocks[7]=blocks[8]=blocks[9]=blocks[10]=blocks[11]=blocks[12]=blocks[13]=blocks[14]=blocks[15]=0,this.blocks=blocks):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.h0=1732584193,this.h1=4023233417,this.h2=2562383102,this.h3=271733878,this.h4=3285377520,this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}Sha1.prototype.update=function(e){if(!this.finalized){var t="string"!=typeof e;t&&e.constructor===root.ArrayBuffer&&(e=new Uint8Array(e));for(var i,r,s=0,a=e.length||0,o=this.blocks;s<a;){if(this.hashed&&(this.hashed=!1,o[0]=this.block,o[16]=o[1]=o[2]=o[3]=o[4]=o[5]=o[6]=o[7]=o[8]=o[9]=o[10]=o[11]=o[12]=o[13]=o[14]=o[15]=0),t)for(r=this.start;s<a&&r<64;++s)o[r>>2]|=e[s]<<SHIFT[3&r++];else for(r=this.start;s<a&&r<64;++s)(i=e.charCodeAt(s))<128?o[r>>2]|=i<<SHIFT[3&r++]:i<2048?(o[r>>2]|=(192|i>>6)<<SHIFT[3&r++],o[r>>2]|=(128|63&i)<<SHIFT[3&r++]):i<55296||i>=57344?(o[r>>2]|=(224|i>>12)<<SHIFT[3&r++],o[r>>2]|=(128|i>>6&63)<<SHIFT[3&r++],o[r>>2]|=(128|63&i)<<SHIFT[3&r++]):(i=65536+((1023&i)<<10|1023&e.charCodeAt(++s)),o[r>>2]|=(240|i>>18)<<SHIFT[3&r++],o[r>>2]|=(128|i>>12&63)<<SHIFT[3&r++],o[r>>2]|=(128|i>>6&63)<<SHIFT[3&r++],o[r>>2]|=(128|63&i)<<SHIFT[3&r++]);this.lastByteIndex=r,this.bytes+=r-this.start,r>=64?(this.block=o[16],this.start=r-64,this.hash(),this.hashed=!0):this.start=r}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}},Sha1.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var e=this.blocks,t=this.lastByteIndex;e[16]=this.block,e[t>>2]|=EXTRA[3&t],this.block=e[16],t>=56&&(this.hashed||this.hash(),e[0]=this.block,e[16]=e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=e[7]=e[8]=e[9]=e[10]=e[11]=e[12]=e[13]=e[14]=e[15]=0),e[14]=this.hBytes<<3|this.bytes>>>29,e[15]=this.bytes<<3,this.hash()}},Sha1.prototype.hash=function(){var e,t,i=this.h0,r=this.h1,s=this.h2,a=this.h3,o=this.h4,n=this.blocks;for(e=16;e<80;++e)t=n[e-3]^n[e-8]^n[e-14]^n[e-16],n[e]=t<<1|t>>>31;for(e=0;e<20;e+=5)i=(t=(r=(t=(s=(t=(a=(t=(o=(t=i<<5|i>>>27)+(r&s|~r&a)+o+1518500249+n[e]<<0)<<5|o>>>27)+(i&(r=r<<30|r>>>2)|~i&s)+a+1518500249+n[e+1]<<0)<<5|a>>>27)+(o&(i=i<<30|i>>>2)|~o&r)+s+1518500249+n[e+2]<<0)<<5|s>>>27)+(a&(o=o<<30|o>>>2)|~a&i)+r+1518500249+n[e+3]<<0)<<5|r>>>27)+(s&(a=a<<30|a>>>2)|~s&o)+i+1518500249+n[e+4]<<0,s=s<<30|s>>>2;for(;e<40;e+=5)i=(t=(r=(t=(s=(t=(a=(t=(o=(t=i<<5|i>>>27)+(r^s^a)+o+1859775393+n[e]<<0)<<5|o>>>27)+(i^(r=r<<30|r>>>2)^s)+a+1859775393+n[e+1]<<0)<<5|a>>>27)+(o^(i=i<<30|i>>>2)^r)+s+1859775393+n[e+2]<<0)<<5|s>>>27)+(a^(o=o<<30|o>>>2)^i)+r+1859775393+n[e+3]<<0)<<5|r>>>27)+(s^(a=a<<30|a>>>2)^o)+i+1859775393+n[e+4]<<0,s=s<<30|s>>>2;for(;e<60;e+=5)i=(t=(r=(t=(s=(t=(a=(t=(o=(t=i<<5|i>>>27)+(r&s|r&a|s&a)+o-1894007588+n[e]<<0)<<5|o>>>27)+(i&(r=r<<30|r>>>2)|i&s|r&s)+a-1894007588+n[e+1]<<0)<<5|a>>>27)+(o&(i=i<<30|i>>>2)|o&r|i&r)+s-1894007588+n[e+2]<<0)<<5|s>>>27)+(a&(o=o<<30|o>>>2)|a&i|o&i)+r-1894007588+n[e+3]<<0)<<5|r>>>27)+(s&(a=a<<30|a>>>2)|s&o|a&o)+i-1894007588+n[e+4]<<0,s=s<<30|s>>>2;for(;e<80;e+=5)i=(t=(r=(t=(s=(t=(a=(t=(o=(t=i<<5|i>>>27)+(r^s^a)+o-899497514+n[e]<<0)<<5|o>>>27)+(i^(r=r<<30|r>>>2)^s)+a-899497514+n[e+1]<<0)<<5|a>>>27)+(o^(i=i<<30|i>>>2)^r)+s-899497514+n[e+2]<<0)<<5|s>>>27)+(a^(o=o<<30|o>>>2)^i)+r-899497514+n[e+3]<<0)<<5|r>>>27)+(s^(a=a<<30|a>>>2)^o)+i-899497514+n[e+4]<<0,s=s<<30|s>>>2;this.h0=this.h0+i<<0,this.h1=this.h1+r<<0,this.h2=this.h2+s<<0,this.h3=this.h3+a<<0,this.h4=this.h4+o<<0},Sha1.prototype.hex=function(){this.finalize();var e=this.h0,t=this.h1,i=this.h2,r=this.h3,s=this.h4;return HEX_CHARS[e>>28&15]+HEX_CHARS[e>>24&15]+HEX_CHARS[e>>20&15]+HEX_CHARS[e>>16&15]+HEX_CHARS[e>>12&15]+HEX_CHARS[e>>8&15]+HEX_CHARS[e>>4&15]+HEX_CHARS[15&e]+HEX_CHARS[t>>28&15]+HEX_CHARS[t>>24&15]+HEX_CHARS[t>>20&15]+HEX_CHARS[t>>16&15]+HEX_CHARS[t>>12&15]+HEX_CHARS[t>>8&15]+HEX_CHARS[t>>4&15]+HEX_CHARS[15&t]+HEX_CHARS[i>>28&15]+HEX_CHARS[i>>24&15]+HEX_CHARS[i>>20&15]+HEX_CHARS[i>>16&15]+HEX_CHARS[i>>12&15]+HEX_CHARS[i>>8&15]+HEX_CHARS[i>>4&15]+HEX_CHARS[15&i]+HEX_CHARS[r>>28&15]+HEX_CHARS[r>>24&15]+HEX_CHARS[r>>20&15]+HEX_CHARS[r>>16&15]+HEX_CHARS[r>>12&15]+HEX_CHARS[r>>8&15]+HEX_CHARS[r>>4&15]+HEX_CHARS[15&r]+HEX_CHARS[s>>28&15]+HEX_CHARS[s>>24&15]+HEX_CHARS[s>>20&15]+HEX_CHARS[s>>16&15]+HEX_CHARS[s>>12&15]+HEX_CHARS[s>>8&15]+HEX_CHARS[s>>4&15]+HEX_CHARS[15&s]},Sha1.prototype.toString=Sha1.prototype.hex,Sha1.prototype.digest=function(){this.finalize();var e=this.h0,t=this.h1,i=this.h2,r=this.h3,s=this.h4;return[e>>24&255,e>>16&255,e>>8&255,255&e,t>>24&255,t>>16&255,t>>8&255,255&t,i>>24&255,i>>16&255,i>>8&255,255&i,r>>24&255,r>>16&255,r>>8&255,255&r,s>>24&255,s>>16&255,s>>8&255,255&s]},Sha1.prototype.array=Sha1.prototype.digest,Sha1.prototype.arrayBuffer=function(){this.finalize();var e=new ArrayBuffer(20),t=new DataView(e);return t.setUint32(0,this.h0),t.setUint32(4,this.h1),t.setUint32(8,this.h2),t.setUint32(12,this.h3),t.setUint32(16,this.h4),e};var exports=createMethod();COMMON_JS?module.exports=exports:(root.sha1=exports,AMD&&(__WEBPACK_AMD_DEFINE_RESULT__=function(){return exports}.call(exports,__webpack_require__,exports,module),void 0===__WEBPACK_AMD_DEFINE_RESULT__||(module.exports=__WEBPACK_AMD_DEFINE_RESULT__)))}()}).call(this,__webpack_require__(63),__webpack_require__(64))},function(e,t){(function(t){e.exports=t}).call(this,{})},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Signalling=void 0;const n=o(i(70)),d=i(13),c=i(268),l=i(65),u=i(283),h=o(i(11)),p=o(i(12)),m=i(118),f=i(67),g=i(147),v=i(5),_=i(285),S=a(i(2)),y=i(286);class R extends d.EventEmitter{constructor(e){super(),this._reconnectionTimer=null,this._protoo=null,this._url=null,this._resolve=null,this._reject=null,this.consumers={},this.keepAliveTimer=null,this._reconnectionTimeout=3e4,this.reconnectionControl={current:null,next:null,copynext:null,blocker:null,pausers:[],resumers:[]},this.autoMask={timer:null,data:[]},this.logger=e.logger.getChild(()=>{var t;let i="signal";return this._protoo?(this._protoo.id&&(i+="#"+this._protoo.id+"_"+(null===(t=this._protoo._transport)||void 0===t?void 0:t.wsid)),this._protoo.connected||(i+="!connected")):i+=" PROTOO_UNINIT",e.adapterRef._signalling!==this&&(i+=" DETACHED"),i}),this._reset(),this.adapterRef=e.adapterRef,this.browserDevice=f.getOSInfo().osName+"-"+f.getBrowserInfo().browserName+"-"+f.getBrowserInfo().browserVersion}async _reset(){this._reconnectionTimer&&clearTimeout(this._reconnectionTimer),this._reconnectionTimer=null,this._destroyProtoo(),this.reconnectionControl.current=null,this.reconnectionControl.next=null,this.reconnectionControl.copynext=null,this._reconnectionTimeout=3e4,this._resolve=null,this._reject=null}init(e,t){return this._reconnectionTimer?Promise.resolve():new Promise((i,r)=>{e||(this._resolve=i),e||(this._reject=r);this.reconnectionControl.current;const s=this.reconnectionControl.next||{timeout:t?v.getParameters().reconnectionFirstTimeout:0,url:this.adapterRef.channelInfo.wssArr[0],serverIndex:0,times:t?1:0,isJoinRetry:e,isReconnection:t};this.adapterRef.channelInfo.wssArrIndex=s.serverIndex,e?t?this.adapterRef.logger.error(`Signalling 开始尝试第 ${s.serverIndex+1}/${this.adapterRef.channelInfo.wssArr.length} 台服务器的第 ${s.times}/${v.getParameters().reconnectionMaxRetry} 次重连，退避时间：${s.timeout}毫秒，服务器地址：${s.url}`):this.adapterRef.logger.error(`Join: 正在尝试第 ${s.serverIndex+1}/${this.adapterRef.channelInfo.wssArr.length} 台服务器的第 ${s.times}/${v.getParameters().joinMaxRetry} 次重连，退避时间：${s.timeout}毫秒，服务器地址：${s.url}`):this.adapterRef.logger.log(`Join: 正在尝试第 ${s.serverIndex+1} / ${this.adapterRef.channelInfo.wssArr.length} 个服务器的第 ${s.times} / ${v.getParameters().joinMaxRetry} 次连接`),this.reconnectionControl.current=s,this.reconnectionControl.next=null,this._init(s.url);let a=Object.assign({},s);s.times?a.serverIndex++:(a.times=1,a.serverIndex=1),a.serverIndex>=this.adapterRef.channelInfo.wssArr.length&&(a.times++,a.serverIndex=0),e?a.timeout=v.getParameters().joinFirstTimeout+2e3*(a.times-1):t&&(a.timeout=v.getParameters().reconnectionFirstTimeout+2e3*(a.times-1)),a.timeout=2e3*a.times,a.isJoinRetry=e,a.isReconnection=t,a.url=this.adapterRef.channelInfo.wssArr[a.serverIndex],this.reconnectionControl.next=this.reconnectionControl.copynext=a,this._reconnectionTimer&&clearTimeout(this._reconnectionTimer),this._reconnectionTimer=setTimeout(()=>{this._reconnectionTimer&&clearTimeout(this._reconnectionTimer),this._reconnectionTimer=null,this._destroyProtoo(),t?(this.adapterRef.instance.safeEmit("@pairing-websocket-reconnection-error"),this._reconnection()):this._connection()},a.timeout)})}async _connection(){this._destroyProtoo();const e=this.reconnectionControl.current,t=this.reconnectionControl.next;t?!e||t.times<=v.getParameters().joinMaxRetry?this.init(!0,!1):(this.adapterRef.logger.error("所有的服务器地址都连接失败, 主动离开房间"),this.adapterRef.instance.apiEventReport("setStreamException",{name:"socketError",value:"signalling server connection failed(timeout)"}),this.adapterRef.channelInfo.wssArrIndex=0,this.adapterRef.instance.leave(),this.adapterRef.instance.safeEmit("error","SOCKET_ERROR"),this._reject&&this._reject("timeout")):this.adapterRef.logger.error("Join结束")}async _reconnection(){if(!this._reconnectionTimer){this.adapterRef.connectState.prevState=this.adapterRef.connectState.curState,this.adapterRef.connectState.curState="CONNECTING",this.adapterRef.connectState.reconnect=!0,this.adapterRef.connectState.prevState!==this.adapterRef.connectState.curState&&this.adapterRef.instance.safeEmit("connection-state-change",this.adapterRef.connectState),this.adapterRef.instance.safeEmit("@pairing-websocket-reconnection-start"),this._destroyProtoo(),"CONNECTED"===this.adapterRef.connectState.prevState&&(this.adapterRef.netStatusList.forEach(e=>{e.uplinkNetworkQuality=0,e.downlinkNetworkQuality=0}),this.adapterRef.instance.safeEmit("network-quality",this.adapterRef.netStatusList)),this.reconnectionControl.pausers.length&&(this.logger.log("重连过程暂停"),this.reconnectionControl.pausers.forEach(e=>e({reason:"reconnection-start"})),this.reconnectionControl.pausers=[],await new Promise(e=>{this.reconnectionControl.blocker=e}));for(let e in this.adapterRef.remoteStreamMap){const t=this.adapterRef.remoteStreamMap[e];t._play&&(this.logger.warn("Destroy Remote Player",e),t._play.destroy())}this.reconnectionControl.next&&this.reconnectionControl.next.times>v.getParameters().reconnectionMaxRetry?(this.adapterRef.instance.safeEmit("@pairing-websocket-reconnection-skip"),this.adapterRef.logger.error("所有的服务器地址都连接失败, 主动离开房间"),this.adapterRef.instance.apiEventReport("setStreamException",{name:"socketError",value:"signalling server reconnection failed(timeout)"}),this.adapterRef.channelInfo.wssArrIndex=0,this.adapterRef.instance.leave(),this.adapterRef.instance.safeEmit("error","SOCKET_ERROR")):this.init(!0,!0)}}_init(e){-1===e.indexOf("?")&&(e+="?"),this.logger.log("Signalling: init url=",e),this.adapterRef.channelInfo._protooUrl=e,this._url=`${-1===e.indexOf("://")?"wss://":""}${e}&cid=${this.adapterRef.channelInfo.cid}&uid=${this.adapterRef.channelInfo.uid}&deviceid=${this.adapterRef.deviceId}`,this.logger.log("连接的url: ",this._url);const t=new y.WebSocketTransport(this._url,{retry:{retries:0,factor:2,minTimeout:1e3,maxTimeout:2e3,forever:!1,maxRetryTime:2e3}});this._protoo=new y.Peer(t),this._bindEvent()}_bindEvent(){if(!this._protoo){let e="_bindEvent: _protoo is not found",t="_bindEvent: _protoo 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new p.default({code:h.default.SIGNALLING_ERROR,message:s,advice:a})}this._protoo.on("open",this.join.bind(this)),this._protoo.on("failed",this._handleFailed.bind(this)),this._protoo.on("notification",this._handleMessage.bind(this)),this._protoo.on("close",this._handleClose.bind(this)),this._protoo.on("disconnected",this._handleDisconnected.bind(this,this._protoo))}_destroyProtoo(){var e;if(this._protoo){this.logger.debug(`信令通道#${this._protoo.id}_${null===(e=this._protoo._transport)||void 0===e?void 0:e.wsid} 被主动关闭。`),this._protoo.removeAllListeners();try{this._protoo&&this._protoo.close()}catch(e){}this._protoo=null}}async _handleMessage(e){var t,i;switch(e.method){case"OnPeerJoin":{const{requestId:t,externData:i}=e.data;this.logger.log("收到OnPeerJoin成员加入消息 uid =",i.uid);let r=i.uid;"string"===this.adapterRef.channelInfo.uidType&&(r=new n.default(r),r=r.toString());let s=this.adapterRef.remoteStreamMap[r];s||(s=new c.RemoteStream({uid:r,audio:!1,audioSlave:!1,video:!1,screen:!1,client:this.adapterRef.instance,platformType:i.platformType}),this.adapterRef.remoteStreamMap[r]=s,this.adapterRef.memberMap[r]=r),this.adapterRef.instance._roleInfo.audienceList[r]=!1,this.adapterRef.instance.safeEmit("peer-online",{uid:r}),i.customData&&this.adapterRef.instance.safeEmit("custom-data",{uid:r,customData:i.customData});break}case"OnPeerLeave":{const{requestId:t,externData:i}=e.data;this.logger.log("OnPeerLeave externData =",i),i.userList&&i.userList.forEach(e=>{var t;let i=e.uid;"string"===this.adapterRef.channelInfo.uidType&&(i=new n.default(i),i=i.toString()),null===(t=this.adapterRef._mediasoup)||void 0===t||t.removeUselessConsumeRequest({uid:i}),this.adapterRef.instance.clearMember(i),this.adapterRef.instance.removeSsrc(i),delete this.adapterRef.instance._roleInfo.audienceList[i]});break}case"OnNewProducer":{const{requestId:r,externData:s}=e.data;this.logger.log("收到OnNewProducer发布消息 externData =",JSON.stringify(s.producerInfo));let a,{uid:o,producerId:d,mediaType:l,mute:u,simulcastEnable:h}=s.producerInfo;switch("string"===this.adapterRef.channelInfo.uidType&&(o=new n.default(o),o=o.toString()),l){case"video":a="video";break;case"screenShare":a="screen";break;case"audio":a="audio";break;case"subAudio":a="audioSlave";break;default:return void this.logger.warn(`OnNewProducer 不支持的媒体类型:${l}, uid ${o}`)}let p=this.adapterRef.remoteStreamMap[o];p||(p=new c.RemoteStream({uid:o,audio:"audio"===a,audioSlave:"audioSlave"===a,video:"video"===a,screen:"screen"===a,client:this.adapterRef.instance,platformType:s.platformType}),this.adapterRef.remoteStreamMap[o]=p,this.adapterRef.memberMap[o]=o),p.pubStatus[a].consumerId?null===(t=this.adapterRef._mediasoup)||void 0===t||t.destroyConsumer(p.pubStatus[a].consumerId,p,a):null===(i=this.adapterRef._mediasoup)||void 0===i||i.removeUselessConsumeRequest({producerId:p.pubStatus[a].producerId,uid:o}),p[a]=!0,p.pubStatus[a][a]=!0,p.pubStatus[a].producerId=d,p.pubStatus[a].mute=u,p.pubStatus[a].simulcastEnable=h,p.pubStatus[a].consumerId="",this.adapterRef._enableRts&&this.adapterRef._rtsTransport?this.adapterRef.instance.emit("rts-stream-added",{stream:p,kind:l}):this.adapterRef.instance.safeEmit("stream-added",{stream:p,mediaType:a}),u&&("audioSlave"===a?this.adapterRef.instance.safeEmit("mute-audio-slave",{uid:p.getId()}):this.adapterRef.instance.safeEmit("mute-"+a,{uid:p.getId()}));break}case"OnProducerClose":{const{requestId:t,code:i,errMsg:r,externData:s}=e.data;let{uid:a,producerId:o,mediaType:d,cid:c}=s;"string"===this.adapterRef.channelInfo.uidType&&(a=new n.default(a),a=a.toString());let l,u=this.adapterRef.remoteStreamMap[a];if(!u)return void this.logger.warn(`收到OnProducerClose消息，但是当前没有该Producer： code = ${i}, errMsg = ${r}, uid = ${a}, mediaType = ${d}, producerId: ${o}`);switch(this.logger.log(`收到OnProducerClose消息 code = ${i}, errMsg = ${r}, uid = ${a}, mediaType = ${d}, producerId: ${o}`),d){case"video":l="video";break;case"screenShare":l="screen";break;case"audio":l="audio";break;case"subAudio":l="audioSlave";break;default:return void this.logger.warn(`OnProducerClose 不支持的媒体类型 ${d} ${a}`)}if(u.pubStatus[l].producerId!==o)return void this.logger.log("该 producerId 已经无效，不处理");if(!this.adapterRef._mediasoup){let e="OnProducerClose:  media server error",t="OnProducerClose: 媒体服务异常",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new p.default({code:h.default.MEDIA_SERVER_ERROR,message:s,advice:a})}this.adapterRef._mediasoup.removeUselessConsumeRequest({producerId:o,uid:a}),u.pubStatus[l].consumerId&&(this.adapterRef._mediasoup.destroyConsumer(u.pubStatus[l].consumerId,u,l),u.pubStatus[l].consumerId=""),this.adapterRef.instance.removeSsrc(a,l),u.subStatus[l]=!1,u.pubStatus[l][l]=!1,u[l]=!1,u.pubStatus[l].consumerId="",u.pubStatus[l].producerId="";const f=this.adapterRef._statsReport&&this.adapterRef._statsReport.formativeStatsReport&&this.adapterRef._statsReport.formativeStatsReport.firstData.recvFirstData[a];"audio"===l?(u.mediaHelper.audio.micTrack=null,m.emptyStreamWith(u.mediaHelper.audio.audioStream,null),delete this.adapterRef.remoteAudioStats[a],f&&(f.recvFirstAudioFrame=!1,f.recvFirstAudioPackage=!1)):"audioSlave"===l?(u.mediaHelper.screenAudio.screenAudioTrack=null,m.emptyStreamWith(u.mediaHelper.screenAudio.screenAudioStream,null),delete this.adapterRef.remoteAudioSlaveStats[a]):"video"===l?(u.mediaHelper.video.cameraTrack=null,m.emptyStreamWith(u.mediaHelper.video.videoStream,null),delete this.adapterRef.remoteVideoStats[a],f&&(f.recvFirstVideoFrame=!1,f.recvFirstVideoPackage=!1,f.videoTotalPlayDuration=0)):"screen"===l&&(u.mediaHelper.screen.screenVideoTrack=null,m.emptyStreamWith(u.mediaHelper.screen.screenVideoStream,null),delete this.adapterRef.remoteScreenStats[a],f&&(f.recvFirstScreenFrame=!1,f.recvFirstScreenPackage=!1,f.screenTotalPlayDuration=0)),this.adapterRef._enableRts?this.adapterRef.instance.emit("rts-stream-removed",{stream:u}):this.adapterRef.instance.safeEmit("stream-removed",{stream:u,mediaType:l});break}case"OnConsumerClose":{const{requestId:t,code:i,errMsg:r,consumerId:s,producerId:a}=e.data;this.logger.log(`chence OnConsumerClose code = ${i} errMsg = ${r} producerId = ${a}`);const o=this.consumers[s];if(!o)break;o.close();break}case"consumerPaused":{const{consumerId:t}=e.data;if(!this.consumers[t])break;break}case"consumerResumed":case"consumerScore":break;case"OnTransportClose":{const{requestId:t,code:i,errMsg:r,transportId:s}=e.data;if(this.logger.warn(`chence OnTransportClose: code = ${i}, errMsg = ${r}, transportId = ${s}`),!this.adapterRef._mediasoup){let e="OnTransportClose:  media server error",t="OnTransportClose: 媒体服务异常",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new p.default({code:h.default.MEDIA_SERVER_ERROR,message:s,advice:a})}this.adapterRef._mediasoup._sendTransport&&(this.adapterRef._mediasoup._micProducer||this.adapterRef._mediasoup._webcamProducer)?(this.logger.warn("服务器媒体进程crash，上行媒体和下行媒体同时重连"),this.adapterRef.channelStatus="connectioning",this.adapterRef.instance.apiEventReport("setDisconnect",{reason:"OnTransportClose"}),this._reconnection()):this.logger.warn("服务器发送了错误信息");break}case"OnSignalRestart":{const{requestId:t,code:i,errMsg:r}=e.data;if(this.logger.warn(`chence OnSignalRestart code = ${i} errMsg = ${r}`),this.logger.warn("服务器信令进程crash，重连"),this.adapterRef.instance.apiEventReport("setDisconnect",{reason:"OnSignalRestart"}),!this._protoo){let e="OnSignalRestart: _protoo is not found",t="OnSignalRestart: _protoo 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new p.default({code:h.default.SIGNALLING_ERROR,message:s,advice:a})}this._protoo.connected&&"CONNECTED"===this.adapterRef.connectState.curState||this._reconnection();break}case"OnPermKeyTimeout":this.adapterRef.instance.safeEmit("permkey-will-expire");break;case"OnPeerClose":this.logger.warn("相同UID在其他地方登录，您被提出房间"),this.adapterRef.instance.safeEmit("uid-duplicate"),this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.logoutReason=3e4,this.adapterRef.instance.leave();break;case"OnKickOff":{let{msg:t,reason:i}=e.data.externData;this._handleKickedNotify(i);break}case"OnUserData":{let{type:t,data:i}=e.data.externData;if("StreamStatus"===t)this._handleStreamStatusNotify(i);else if("NetStatus"===t)this._handleNetStatusNotify(i);else if("Mute"===t)this.logger.log("mute变更: ",JSON.stringify(i,null,"")),this._handleMuteNotify(i);else if("UserRole"===t)this.logger.log("UserRole变更: ",JSON.stringify(i,null,"")),this._handleUserRoleNotify(e.data.externData);else if("RtmpTaskStatus"===t)this.logger.log("RtmpTaskStatus变更: ",JSON.stringify(i,null,"")),this.adapterRef.instance.safeEmit("rtmp-state",i);else if("AutoMaskUid"===t){const e=i;this.logger.log("收到打码通知：",e.maskUid,"时长",e.duration,"秒"),e.maskUid&&e.duration&&(e.targetEndMs=Date.now()+1e3*e.duration,this.autoMask.data.push(e),this.updateMaskStatus())}else if("MediaCapability"===t){if(this.logger.warn("MediaCapability房间能力变更: ",JSON.stringify(i,null,"")),this.adapterRef.mediaCapability.parseRoom(i),this.adapterRef.instance.safeEmit("@mediaCapabilityChange"),this.adapterRef._mediasoup&&this.adapterRef.mediaCapability.room.videoCodecType&&this.adapterRef.localStream){const e=this.adapterRef.mediaCapability.getCodecSend("video",this.adapterRef._mediasoup._sendTransport.handler._sendingRtpParametersByKind.video),t=this.adapterRef.mediaCapability.getCodecSend("screen",this.adapterRef._mediasoup._sendTransport.handler._sendingRtpParametersByKind.video),i=this.adapterRef._mediasoup._webcamProducerCodec&&this.adapterRef._mediasoup._webcamProducerCodec!==e.codecName;i&&this.logger.warn("将视频的Codec切走：",this.adapterRef._mediasoup._webcamProducerCodec,"=>",e.codecName);const r=this.adapterRef._mediasoup._screenProducerCodec&&this.adapterRef._mediasoup._screenProducerCodec!==e.codecName;r&&this.logger.error("将辅流的Codec切走：",this.adapterRef._mediasoup._screenProducerCodec,"=>",t.codecName),i||r?this._protoo&&this._protoo._transport&&this._protoo._transport._ws&&this._protoo._transport._ws.close():this.logger.log("Codec保持不动。video:",this.adapterRef._mediasoup._webcamProducerCodec,", screen:",this.adapterRef._mediasoup._screenProducerCodec)}}else if("Ability"===t)this._handleAbility(e.data.externData.data);else if("ChangeRight"===t){let e,t,r=i.uid;if(1===i.audioRight){this.adapterRef.isAudioBanned=!0,e=i.audioDuration;let t="audio",s=!0,a="ChangeRight: audio is banned by server",o="ChangeRight: audio 被服务器禁言",n=S.IS_ZH?o:a;const d=new p.default({code:h.default.BANNED_BY_SERVER,message:n});this.adapterRef.instance.safeEmit("audioVideoBanned",{rtcError:d,uid:r,mediaType:t,state:s,duration:e})}else if(2===i.audioRight){this.adapterRef.isAudioBanned=!1,e=i.audioDuration;let t="audio",s=!1,a="ChangeRight: audio is unbanned by server",o="ChangeRight: audio 服务器解开禁言",n=S.IS_ZH?o:a;const d=new p.default({code:h.default.BANNED_BY_SERVER,message:n});this.adapterRef.instance.safeEmit("audioVideoBanned",{rtcError:d,uid:r,mediaType:t,state:s,duration:e})}if(1===i.videoRight){this.adapterRef.isVideoBanned=!0,t=i.videoDuration;let e="video",s=!0,a="ChangeRight: video is banned by server",o="ChangeRight: video 被服务器禁言",n=S.IS_ZH?o:a;const d=new p.default({code:h.default.BANNED_BY_SERVER,message:n});this.adapterRef.instance.safeEmit("audioVideoBanned",{rtcError:d,uid:r,mediaType:e,state:s,duration:t})}else if(2===i.videoRight){this.adapterRef.isVideoBanned=!1,t=i.videoDuration;let e="video",s=!1,a="ChangeRight: video is unbanned by server",o="ChangeRight: video 服务器解开禁言",n=S.IS_ZH?o:a;const d=new p.default({code:h.default.BANNED_BY_SERVER,message:n});this.adapterRef.instance.safeEmit("audioVideoBanned",{rtcError:d,uid:r,mediaType:e,state:s,duration:t})}if(this.adapterRef.isAudioBanned&&this.adapterRef.isVideoBanned&&this.adapterRef.instance.apiEventReport("setAudioVideoBanned",{name:"set_mediaRightChange",oper:"1",isAudioBanned:!0,isVideoBanned:!0}),!this.adapterRef.isAudioBanned&&this.adapterRef.isVideoBanned&&this.adapterRef.instance.apiEventReport("setAudioVideoBanned",{name:"set_mediaRightChange",oper:"1",isAudioBanned:!1,isVideoBanned:!0}),this.adapterRef.isAudioBanned&&!this.adapterRef.isVideoBanned&&this.adapterRef.instance.apiEventReport("setAudioVideoBanned",{name:"set_mediaRightChange",oper:"1",isAudioBanned:!0,isVideoBanned:!1}),this.adapterRef.isAudioBanned||this.adapterRef.isVideoBanned||this.adapterRef.instance.apiEventReport("setAudioVideoBanned",{name:"set_mediaRightChange",oper:"1",isAudioBanned:!1,isVideoBanned:!1}),this.adapterRef.isAudioBanned){if(!this.adapterRef.localStream)return;let e=this.adapterRef.localStream.audio,t=this.adapterRef.localStream.screenAudio;e&&this.adapterRef.localStream.close({type:"audio"}),t&&this.adapterRef.localStream.close({type:"screenAudio"}),this.adapterRef.localStream.stopAllEffects();let i=this.adapterRef.localStream.mediaHelper.audio;i.webAudio&&i.webAudio.context&&i.webAudio.mixAudioConf&&i.webAudio.mixAudioConf.audioSource&&this.adapterRef.localStream.stopAudioMixing()}if(!this.adapterRef.localStream)return;if(this.adapterRef.isVideoBanned){let e=this.adapterRef.localStream.video,t=this.adapterRef.localStream.screen;e&&this.adapterRef.localStream.close({type:"video"}),t&&this.adapterRef.localStream.close({type:"screen"})}}else this.logger.error(`收到OnUserData通知消息 type = ${t}, data: `,i)}}}_handleFailed(){this.logger.log("Signalling:_handleFailed")}_handleClose(){}_handleDisconnected(e){var t,i,r,s;this.logger.log("Signalling:_handleDisconnected"),!this._reconnectionTimer||"connectioning"!==this.adapterRef.channelStatus&&"join"!==this.adapterRef.channelStatus?(this.logger.warn(`信令通道#${e.id}_${null===(s=e._transport)||void 0===s?void 0:s.wsid} 收到关闭信号，即将开始重连过程。`),this.adapterRef.channelStatus="connectioning",this._reconnection()):e.closed?this.logger.warn(`信令通道#${e.id}_${null===(t=e._transport)||void 0===t?void 0:t.wsid} 在建立过程中被关闭。当前正在重连中，等待下次重连过程。`):this.logger.warn(`信令通道#${e.id}_${null===(i=e._transport)||void 0===i?void 0:i.wsid} 在建立过程中被关闭。信令通道会自动重试。连接地址：${null===(r=e._transport)||void 0===r?void 0:r._url}`),this.adapterRef.instance.apiEventReport("setDisconnect",{reason:"2"})}async join(){let e;e=!!this.adapterRef.encryption.encryptionSecret&&"none"!==this.adapterRef.encryption.encryptionMode;const t={method:"Join",permKeySecret:this.adapterRef.channelInfo.permKey,requestId:""+Math.ceil(1e9*Math.random()),supportStdRed:!0,supportTurn:!this.adapterRef.proxyServer.enable,externData:{userName:""+this.adapterRef.channelInfo.uid,token:this.adapterRef.channelInfo.token,cname:""+this.adapterRef.channelInfo.channelName,subType:"select",role:"part",version:"2.0",sessionMode:"meeting",engineVersion:l.ENGINE_VERSION,userRole:this.adapterRef.instance._roleInfo.userRole,userType:3,platformType:16,rtmp:{support:this.adapterRef.channelInfo.sessionConfig.liveEnable},record:{host:this.adapterRef.channelInfo.sessionConfig.isHostSpeaker,supportVideo:this.adapterRef.channelInfo.sessionConfig.recordVideo,supportAuido:this.adapterRef.channelInfo.sessionConfig.recordAudio,recordType:this.adapterRef.channelInfo.sessionConfig.recordType-0},mediaCapabilitySet:this.adapterRef.mediaCapability.stringify(),browser:{name:f.getBrowserInfo().browserName,version:""+f.getBrowserInfo().browserVersion},customData:this.adapterRef.channelInfo.customData||"",gmEnable:e,gmMode:g.encryptionModeToInt(this.adapterRef.encryption.encryptionMode),gmKey:this.adapterRef.encryption.encryptionSecret,customEncryption:!v.getParameters().forceCustomEncryptionOff&&this.adapterRef.encryption.encodedInsertableStreams,userPriority:this.adapterRef.userPriority}};if(this.logger.log("Signalling: socket连接成功，开始发送Join请求"),!this._protoo){let e="join: _protoo is not found",t="join: _protoo 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new p.default({code:h.default.SIGNALLING_ERROR,message:s,advice:a})}this._protoo.clear();try{let e=null,i=this._protoo;try{e=await this._protoo.request("Join",t)}catch(e){if(i!==this._protoo)return void this.logger.warn(`过期的信令通道消息：【${e.name}】`,e.message);throw e}if(this.logger.log("Signalling:Join请求收到response"),200!=e.code){let t="Unknown Error";return e.externData?t=e.externData.errMsg:e.errMsg&&(t=e.errMsg),this.logger.error(`Signalling: 加入房间失败, code = ${e.code}, reason = ${t}`),this.adapterRef.instance.safeEmit("@pairing-websocket-reconnection-error"),void this._joinFailed(e.code,t)}let r=this.adapterRef.channelInfo.uid;if(e.PermKey&&(this.adapterRef.permKeyInfo=e.PermKey),1===e.externData.audioRight){this.adapterRef.isAudioBanned=!0;let e="audio",t=!0,i="Join: audio is banned by server",s="Join: audio 被服务器禁言",a=S.IS_ZH?s:i;const o=new p.default({code:h.default.BANNED_BY_SERVER,message:a});this.adapterRef.instance.safeEmit("audioVideoBanned",{rtcError:o,uid:r,mediaType:e,state:t})}else this.adapterRef.isAudioBanned=!1;if(1===e.externData.videoRight){this.adapterRef.isVideoBanned=!0;let e="video",t=!0,i="Join: video is banned by server",s="Join: video 被服务器禁言",a=S.IS_ZH?s:i;const o=new p.default({code:h.default.BANNED_BY_SERVER,message:a});this.adapterRef.instance.safeEmit("audioVideoBanned",{rtcError:o,uid:r,mediaType:e,state:t})}else this.adapterRef.isVideoBanned=!1;if(this.adapterRef.instance.apiEventReport("setAudioVideoBanned",{name:"set_mediaRightChange",oper:"1",isAudioBanned:!!this.adapterRef.isAudioBanned,isVideoBanned:!!this.adapterRef.isVideoBanned}),this.adapterRef.isAudioBanned&&this.adapterRef.isVideoBanned&&this.logger.warn("服务器禁止发送音频流"),this._reconnectionTimer&&(clearTimeout(this._reconnectionTimer),this._reconnectionTimer=null),this.reconnectionControl.next=null,this.logger.log("Signalling: 加入房间成功"),this.adapterRef.connectState.prevState=this.adapterRef.connectState.curState,this.adapterRef.connectState.curState="CONNECTED",this.adapterRef.audioAsl.enabled=e.supportWebAsl?"yes":"no",this.adapterRef.audioAsl.aslActiveNum=e.aslActiveNum,e.supportWebAsl?e.aslActiveNum?this.logger.log("aslActiveNum数量： "+e.aslActiveNum):this.logger.warn("服务端支持ASL但没有返回ASL数量"):this.logger.log("服务端未开启ASL"),this.adapterRef.instance.safeEmit("aslStatus",{enabled:!!e.supportWebAsl,aslActiveNum:e.aslActiveNum}),"connectioning"===this.adapterRef.channelStatus){if(this.adapterRef.connectState.reconnect=!0,this.logger.log("Signalling: 重连成功, 清除之前的媒体的通道"),this.adapterRef.channelStatus="join",this.adapterRef.instance.apiEventReport("setRelogin",{a_record:this.adapterRef.channelInfo.sessionConfig.recordAudio,v_record:this.adapterRef.channelInfo.sessionConfig.recordVideo,record_type:this.adapterRef.channelInfo.sessionConfig.recordType,host_speaker:this.adapterRef.channelInfo.sessionConfig.isHostSpeaker,permKey:this.adapterRef.channelInfo.permKey,result:0,reason:1,server_ip:this.adapterRef.channelInfo._protooUrl}),this.adapterRef.instance.resetChannel(),!this.adapterRef._mediasoup){let e="signalling_join:  media server error 1",t="signalling_join: 媒体服务异常 1",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new p.default({code:h.default.MEDIA_SERVER_ERROR,message:s,advice:a})}this.adapterRef._mediasoup._edgeRtpCapabilities=e.edgeRtpCapabilities,this.adapterRef.mediaCapability.parseRoom(e.externData.roomCapability),this.adapterRef.instance.safeEmit("@mediaCapabilityChange"),await this.adapterRef._mediasoup.init(),this.adapterRef.localStream?this.adapterRef.localStream.audio||this.adapterRef.localStream.video||this.adapterRef.localStream.screen||this.adapterRef.localStream.screenAudio||v.getParameters().allowEmptyMedia||this.adapterRef.localStream.audioSlave?(this.logger.log(`重连成功，重新publish本端流: audio ${this.adapterRef.localStream.hasAudio()}, video ${this.adapterRef.localStream.hasVideo()}, screen ${this.adapterRef.localStream.hasScreen()}`),this.adapterRef.instance.doPublish(this.adapterRef.localStream)):this.logger.log("重连成功，当前没有媒体流，无需发布"):this.logger.log("重连成功，当前在未发布状态，无需发布")}else{this.adapterRef.connectState.reconnect=!1;const t=this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2,i=Date.now();if(this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.joinedSuccessedTime=i,this.adapterRef.instance.apiEventReport("setLogin",{a_record:this.adapterRef.channelInfo.sessionConfig.recordAudio,v_record:this.adapterRef.channelInfo.sessionConfig.recordVideo,record_type:this.adapterRef.channelInfo.sessionConfig.recordType,host_speaker:this.adapterRef.channelInfo.sessionConfig.isHostSpeaker,permKey:this.adapterRef.channelInfo.permKey,result:0,server_ip:this.adapterRef.channelInfo._protooUrl,signal_time_elapsed:t.startWssTime-t.startJoinTime,time_elapsed:i-t.startJoinTime,model:this.browserDevice}),!this.adapterRef._mediasoup){let e="signalling_join:  media server error 2",t="signalling_join: 媒体服务异常 2",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new p.default({code:h.default.MEDIA_SERVER_ERROR,message:s,advice:a})}this.adapterRef._mediasoup._edgeRtpCapabilities=e.edgeRtpCapabilities,this.adapterRef.mediaCapability.parseRoom(e.externData.roomCapability),this.adapterRef.instance.safeEmit("@mediaCapabilityChange"),await this.adapterRef._mediasoup.init()}if(this.adapterRef.instance.safeEmit("connection-state-change",this.adapterRef.connectState),this.adapterRef._enableRts&&(await this.createRTSTransport(),this.adapterRef.instance.emit("connected")),this.logger.log("Signalling: 查看房间其他人的发布信息: "+JSON.stringify(e.externData.userList)),void 0!==e.externData&&e.externData.userList&&e.externData.userList.length){let t=this;for(const i of e.externData.userList){let e=i.uid;"string"===this.adapterRef.channelInfo.uidType&&(e=new n.default(e),e=e.toString());let r=this.adapterRef.remoteStreamMap[e];if(r?(r.active=!0,this.adapterRef.memberMap[e]=""+e,this.adapterRef.instance.safeEmit("peer-online",{uid:e})):(r=new c.RemoteStream({uid:e,audio:!1,audioSlave:!1,video:!1,screen:!1,client:this.adapterRef.instance,platformType:i.platformType}),this.adapterRef.remoteStreamMap[e]=r,this.adapterRef.memberMap[e]=""+e,this.adapterRef.instance.safeEmit("peer-online",{uid:e})),i.customData&&this.adapterRef.instance.safeEmit("custom-data",{uid:e,customData:i.customData}),i.producerInfoList)for(const s of i.producerInfoList){const{mediaType:i,producerId:a,mute:o,simulcastEnable:n}=s;let d;switch(i){case"video":d="video";break;case"screenShare":d="screen";break;case"audio":d="audio";break;case"subAudio":d="audioSlave";break;default:this.logger.warn(`join: 不支持的媒体类型 ${i} ${e}`);continue}r[d]=!0,r.pubStatus[d][d]=!0,r.pubStatus[d].producerId=a,r.pubStatus[d].mute=o,r.muteStatus[d].send=o,r.pubStatus[d].simulcastEnable=n,setTimeout(()=>{t.logger.log(`Signalling: 通知 ${r.getId()} 发布信息: ${JSON.stringify(r.pubStatus,null,"")}`),t.adapterRef._enableRts&&t.adapterRef._rtsTransport?t.adapterRef.instance.emit("rts-stream-added",{stream:r,kind:d}):(r.pubStatus.audio.audio||r.pubStatus.video.video||r.pubStatus.screen.screen)&&t.adapterRef.instance.safeEmit("stream-added",{stream:r,mediaType:d}),o&&("audioSlave"===d?t.adapterRef.instance.safeEmit("mute-audio-slave",{uid:r.getId()}):t.adapterRef.instance.safeEmit("mute-"+d,{uid:r.getId()}))},0)}}for(let e in this.adapterRef.remoteStreamMap){this.adapterRef.remoteStreamMap[e].active||(this.logger.warn("重连期间远端流停止发布："+e),delete this.adapterRef.remoteStreamMap[e])}}this._resolve?(this.logger.log("加入房间成功, 反馈通知"),this._resolve(e),this._resolve=null,this._reject=null):(this.adapterRef.instance.safeEmit("@pairing-websocket-reconnection-success"),this.reconnectionControl.resumers.length&&(this.reconnectionControl.resumers.forEach(e=>e({reason:"reconnection-success"})),this.reconnectionControl.resumers=[])),this.doSendKeepAliveTask()}catch(e){this.logger.error("Signalling: 登录失败, "+e.name+": "+e.message),this._joinFailed(-1,"LOGIN_ERROR")}}_joinFailed(e,t){this.adapterRef.connectState.prevState=this.adapterRef.connectState.curState,this.adapterRef.connectState.curState="DISCONNECTED",this.adapterRef.connectState.reconnect=!1,this.adapterRef.channelStatus="init",this.adapterRef.instance.safeEmit("connection-state-change",this.adapterRef.connectState),4009===e&&this.adapterRef.instance.safeEmit("crypt-error",{cryptType:this.adapterRef.encryption.encryptionMode});const i=Date.now(),r=this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2;if(this.adapterRef.instance.apiEventReport("setLogin",{a_record:this.adapterRef.channelInfo.sessionConfig.recordAudio,v_record:this.adapterRef.channelInfo.sessionConfig.recordVideo,record_type:this.adapterRef.channelInfo.sessionConfig.recordType,host_speaker:this.adapterRef.channelInfo.sessionConfig.isHostSpeaker,permKey:this.adapterRef.channelInfo.permKey,result:e,server_ip:this.adapterRef.channelInfo._protooUrl,signal_time_elapsed:r.startWssTime-r.startJoinTime,time_elapsed:i-r.startJoinTime,model:this.browserDevice}),this._reject)this.logger.error("加入房间失败, 反馈通知"),this._reject(new p.default({code:e||h.default.JOIN_FAILED,message:t||"join failed"})),this._resolve=null,this._reject=null,this.keepAliveTimer&&(clearInterval(this.keepAliveTimer),this.keepAliveTimer=null),this.adapterRef.channelStatus="leave",this.adapterRef.instance.stopSession();else{switch(t){case"room not found":this.logger.error("网络重连时，加入房间失败，主动离开。重连失败原因：",t,"，这通常是因为房间内其他人都已离开，房间关闭引起的");break;default:this.logger.error("网络重连时，加入房间失败，主动离开。重连失败原因：",t)}this.adapterRef.instance.safeEmit("error","RELOGIN_ERROR"),this.adapterRef.instance.leave()}}doSendKeepAliveTask(){this.keepAliveTimer&&(clearInterval(this.keepAliveTimer),this.keepAliveTimer=null),this.keepAliveTimer=setInterval(()=>{this.doSendKeepAlive()},6e3)}async doSendKeepAlive(){var e,t;if(!(null===(e=this._protoo)||void 0===e?void 0:e.connected))return;this._protoo.id,null===(t=this._protoo._transport)||void 0===t||t.wsid;try{await this._protoo.request("Heartbeat")}catch(e){this.logger.error("信令包保活失败, reanson: "+e.message)}}async createRTSTransport(){if(this.logger.log("createRTSTransport()"),!this._protoo){let e="createRTSTransport: _protoo is not found",t="createRTSTransport: _protoo 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new p.default({code:h.default.SIGNALLING_ERROR,message:s,advice:a})}if(!this._url){let e="createRTSTransport: _url is not found",t="createRTSTransport: _url 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new p.default({code:h.default.SIGNALLING_ERROR,message:s,advice:a})}try{const e=await this._protoo.request("CreateWsTrasnport");this.logger.warn("CreateWsTrasnport response: ",JSON.stringify(e,null,""));const{code:t,errMsg:i,transportId:r,wsPort:s="6666"}=e;200==t?(this.adapterRef._rtsTransport&&(this.logger.log("CreateWsTrasnport: 需要更新"),this.adapterRef._rtsTransport.destroy()),this.logger.log("CreateWsTrasnport: 开始创建"),this.adapterRef._rtsTransport=new _.RTSTransport({url:this._url.replace(/:\d+/,":"+s)+"&transportId="+r,transportId:r,port:s,adapterRef:this.adapterRef})):this.logger.error(`createWsTrasnport failed, code: ${t}, reason: ${i}`)}catch(e){throw this.logger.error("createRTSTransport failed:",e.name,e.message),e}}async rtsRequestKeyFrame(e){if(this.logger.log("rtsRequestKeyFrame(): ",e),!this._protoo){let e="rtsRequestKeyFrame: _protoo is not found",t="rtsRequestKeyFrame: _protoo 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new p.default({code:h.default.SIGNALLING_ERROR,message:s,advice:a})}if(!e){let e="rtsRequestKeyFrame: consumerId is not found",t="rtsRequestKeyFrame: consumerId 未找到",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new p.default({code:h.default.SIGNALLING_ERROR,message:s,advice:a})}try{const t=await this._protoo.request("RequestKeyFrame",{consumerId:e});this.logger.warn("rtsRequestKeyFrame response: ",t);let{code:i,errMsg:r}=t;200==i?this.logger.log("RTS 关键帧请求完成"):this.logger.error(`RTS 关键帧请求失败, code: ${i}, reason: ${r}`)}catch(e){throw this.logger.error("rtsRequestKeyFrame failed:",e),e}}async updatePermKey(e){if(this.logger.log("PermKeyUpdate"),!this._protoo||!this._protoo.connected)return;const t=await this._protoo.request("PermKeyUpdate",{requestId:""+Math.ceil(1e9*Math.random()),permKeySecret:e});if(200!==t.code)throw new p.default({code:t.code||h.default.UNKNOWN,message:t.errMsg||"failed to update permKey"});this.adapterRef.permKeyInfo=t.PermKey}updateMaskStatus(){var e,t,i;let r=Date.now();for(let i=this.autoMask.data.length-1;i>=0;i--){let s=this.autoMask.data[i];if(r>=s.targetEndMs){if(this.adapterRef.channelInfo.uid===s.maskUid&&this.adapterRef.localStream)this.logger.log("updateMaskStatus 本地用户去除打码",s.maskUid),null===(e=this.adapterRef.localStream._play)||void 0===e||e.disableMask();else{const e=this.adapterRef.remoteStreamMap[s.maskUid];e&&(null===(t=e._play)||void 0===t?void 0:t.mask.enabled)&&(this.logger.log("updateMaskStatus 远端用户去除打码",s.maskUid),e._play.disableMask())}this.autoMask.data.splice(i,1)}}let s=Number.MAX_SAFE_INTEGER;for(let e=0;e<this.autoMask.data.length;e++){let t=this.autoMask.data[e];s=Math.min(s,t.targetEndMs);if(this.adapterRef.channelInfo.uid==t.maskUid&&this.adapterRef.localStream)this.logger.log("updateMaskStatus 本地用户增加打码",t.maskUid),null===(i=this.adapterRef.localStream._play)||void 0===i||i.enableMask();else{const e=this.adapterRef.remoteStreamMap[t.maskUid];e?e._play&&!e._play.mask.enabled&&(this.logger.log("updateMaskStatus 远端用户增加打码",t.maskUid,"打码时长",t.duration,"秒"),e._play.enableMask()):this.logger.log("updateMaskStatus 远端用户不在频道中",t.maskUid,"打码时长",t.duration,"秒")}}this.autoMask.timer&&clearTimeout(this.autoMask.timer),this.autoMask.timer=setTimeout(()=>{this.updateMaskStatus()},s-r)}async doSendLogout(){if(this.logger.log("doSendLogout begin"),this.keepAliveTimer&&(clearInterval(this.keepAliveTimer),this.keepAliveTimer=null),!this._protoo||!this._protoo.connected)return;let e={requestId:""+Math.ceil(1e9*Math.random()),externData:{reason:0}};this._protoo.notify("Leave",e),this.logger.log("doSendLogout success")}_handleStreamStatusNotify(e){}_handleNetStatusNotify(e){const t=e.netStatusList;let i=u.parseBase64(t).toString(),r=[],s=i.substr(2,2)+i.substr(0,2);s=parseInt(s,16),i=i.substr(4);for(let e=0;e<s;e++){let e=i.substr(0,16);e=a(e);const t=i.substr(16,2),s=i.substr(18,2);let n=0,d=null;if("00"!=i.substr(20,2)){const e=i.substr(22,2);n=parseInt(e,16),d=i.substr(24,n),n++}const c={uid:"string"===this.adapterRef.channelInfo.uidType?o(e):parseInt(e,16),downlinkNetworkQuality:parseInt(t,16),uplinkNetworkQuality:parseInt(s,16),receiveTs:Date.now()};r.push(c),i=i.substr(22+n)}function a(e){let t=[];for(var i=e.length;i>=1;i-=2)t.push(e[i-2],e[i-1]);return t.join("")}function o(e){const t=e.length;let i,r=new Array(t),s=new n.default(0);for(let s=0;s<t;s++)i=e.charCodeAt(s),48<=i&&i<58?i-=48:i=(223&i)-65+10,r[s]=i;for(let e=0;e<r.length;e++){const t=r[e];s=c(d(s,16),t)}return s.toString()}function d(e,t){if(0==e.toNumber())return e;const i=e.multipliedBy(t);return n.default("7e+500").times(t),e.multipliedBy("-a",16),i}function c(e,t){return t=e.plus(t),n.default(.7).plus(e).plus(t),e.plus("0.1",8),t}let l=!0,h=[];r=r.filter(e=>0!=e.uid),this.adapterRef.netStatusList.map(e=>{l=!0,r.map(t=>{e.uid!=t.uid&&0!=t.uid||(l=!1)}),l&&h.push(e)});let p=h.concat(r);p=p.filter(e=>this.adapterRef.memberMap[e.uid]||e.uid==this.adapterRef.channelInfo.uid),this.adapterRef.netStatusList=p,this.adapterRef.instance.safeEmit("network-quality",this.adapterRef.netStatusList)}_handleMuteNotify(e){const t=e.producerId,i=e.mute;Object.values(this.adapterRef.remoteStreamMap).forEach(e=>{["audio","video","screen","audioSlave"].forEach(r=>{e.pubStatus[r].producerId===t&&(e.muteStatus[r].send=i,i?"audioSlave"===r?this.adapterRef.instance.safeEmit("mute-audio-slave",{uid:e.getId()}):this.adapterRef.instance.safeEmit("mute-"+r,{uid:e.getId()}):"audioSlave"===r?this.adapterRef.instance.safeEmit("unmute-audio-slave",{uid:e.getId()}):this.adapterRef.instance.safeEmit("unmute-"+r,{uid:e.getId()}))})})}_handleUserRoleNotify(e){let t=e.uid;"string"===this.adapterRef.channelInfo.uidType&&(t=new n.default(t),t=t.toString());const i=e.data&&e.data.userRole;if(this.logger.warn(`用户${t}角色变为${i?"观众":"主播"}`),t&&1===i&&(this.adapterRef.instance.clearMember(t),this.adapterRef.instance.removeSsrc(t),this.adapterRef.instance._roleInfo.audienceList[t]=!0),t&&0===i){this.adapterRef.instance.safeEmit("peer-online",{uid:t});let i=this.adapterRef.remoteStreamMap[t];i||(i=new c.RemoteStream({uid:t,audio:!1,audioSlave:!1,video:!1,screen:!1,client:this.adapterRef.instance,platformType:e.platformType}),this.adapterRef.remoteStreamMap[t]=i,this.adapterRef.memberMap[t]=t),this.adapterRef.instance._roleInfo.audienceList[t]=!1}}_handleAbility(e){this.adapterRef.instance.safeEmit("warning",{code:e.code,msg:e.msg})}_handleKickedNotify(e,t=this.adapterRef.channelInfo.uid){"string"===this.adapterRef.channelInfo.uidType&&(t=(t=new n.default(t)).toString()),1==e?(this.logger.warn("房间被关闭"),this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.logoutReason=30207,this.adapterRef.instance.leave(),this.adapterRef.instance.safeEmit("channel-closed",{})):2==e?(this.logger.warn(t+"被提出房间"),t.toString()==this.adapterRef.channelInfo.uid.toString()&&(this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.logoutReason=30206,this.adapterRef.instance.leave()),this.adapterRef.instance.safeEmit("client-banned",{uid:t})):5==e&&(this.logger.warn(t+" permKey 超时被提出房间"),t.toString()==this.adapterRef.channelInfo.uid.toString()&&(this.adapterRef.instance._params.JoinChannelRequestParam4WebRTC2.logoutReason=30206,this.adapterRef.instance.leave()),this.adapterRef.instance.safeEmit("permkey-timeout",{uid:t}))}destroy(){this.logger.log("清除 Signalling"),this._destroyProtoo(),this._reset()}}t.Signalling=R},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.RemoteStream=void 0;const n=o(i(70)),d=i(137),c=i(144),l=i(190),u=i(5),h=i(192),p=i(149),m=i(195),f=o(i(11)),g=o(i(12)),v=i(69),_=i(66),S=a(i(2)),y=i(62);let R=0;class b extends _.RTCEventEmitter{constructor(e){if(super(),this.audioLevelHelper=null,this.platformType=m.PlatformType.unknown,this.isRemote=!0,this.pubStatus={audio:{audio:!1,producerId:"",consumerId:"",consumerStatus:"init",stopconsumerStatus:"init",mute:!1,simulcastEnable:!1},audioSlave:{audioSlave:!1,producerId:"",consumerId:"",consumerStatus:"init",stopconsumerStatus:"init",mute:!1,simulcastEnable:!1},video:{video:!1,producerId:"",consumerId:"",consumerStatus:"init",stopconsumerStatus:"init",mute:!1,simulcastEnable:!1},screen:{screen:!1,producerId:"",consumerId:"",consumerStatus:"init",stopconsumerStatus:"init",mute:!1,simulcastEnable:!1}},this.subStatus={audio:!1,audioSlave:!1,video:!1,screen:!1},this.muteStatus={audio:{send:!1,recv:!1},audioSlave:{send:!1,recv:!1},video:{send:!1,recv:!1},screen:{send:!1,recv:!1}},this.active=!0,this.destroyed=!1,this.spatialPosition={x:0,y:0},this.remoteStreamId=R++,this.streamID=e.uid,this.stringStreamID=this.streamID.toString(),this.platformType=e.platformType,this.logger=e.client.adapterRef.logger.getChild(()=>{let t="remote#"+this.stringStreamID;return m.PlatformTypeMap[this.platformType]&&(t+=" "+m.PlatformTypeMap[this.platformType]),t+=this.remoteStreamId,this.pubStatus.audio.consumerId?t+="M":this.pubStatus.audio.producerId&&(t+="m"),this.pubStatus.video.consumerId?t+="C":this.pubStatus.video.producerId&&(t+="c"),this.pubStatus.screen.consumerId?t+="S":this.pubStatus.screen.producerId&&(t+="s"),e.client.adapterRef.remoteStreamMap[this.streamID]!==this&&(t+=" DETACHED"),t}),"string"==typeof e.uid||n.default.isBigNumber(e.uid))e.client.adapterRef.channelInfo.uidType="string";else{if("number"!=typeof e.uid){this.logger.error("uid参数格式非法");let e="remoteStream: The type of parameter(uid) is not invalid",t="remoteStream: uid 参数类型非法",i="Please input the correct parameter type",r="请输入正确的参数类型",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new g.default({code:f.default.INVALID_PARAMETER_ERROR,message:s,advice:a})}if(e.client.adapterRef.channelInfo.uidType="number",e.uid>Number.MAX_SAFE_INTEGER){let e="remoteStream: parameter(uid) out of bounds",t="remoteStream: uid 参数越界",i="The maximum range of the Number type is 2^53 - 1, please input the correct parameter",r="Number 类型的 uid 最大值是 2^53 - 1， 请输入正确的参数",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new g.default({code:f.default.INVALID_PARAMETER_ERROR,message:s,advice:a})}}this.videoView=null,this.screenView=null,this.renderMode={remote:{video:{},screen:{}}},this.consumerId=null,this.producerId=null,this.audioPlay_=!1,this.audioSlavePlay_=!1,this.videoPlay_=!1,this.screenPlay_=!1,this.subConf={audio:!0,audioSlave:!0,video:!0,screen:!0,highOrLow:{video:d.STREAM_TYPE.HIGH,screen:d.STREAM_TYPE.HIGH}},this.renderMode={remote:{video:{},screen:{}}},this._reset(),this.streamID=e.uid,this.stringStreamID=this.streamID.toString(),this.audio=e.audio,this.audioSlave=e.audioSlave||!1,this.video=e.video||!1,this.screen=e.screen||!1,this.client=e.client,this.mediaHelper=new l.MediaHelper({stream:this}),this._play=new h.Play({stream:this}),this._record=new p.Record({logger:this.logger,client:this.client}),"never"!==u.getParameters().enableAlerter&&c.alerter.watchRemoteStream(this),this.client.apiFrequencyControl({name:"createRemoteStream",code:0,param:{streamID:this.stringStreamID,clientUid:this.client.adapterRef.channelInfo.uid||""}})}_reset(){this.audio=!1,this.audioSlave=!1,this.video=!1,this.screen=!1,this.videoView=null,this.screenView=null,this.renderMode={remote:{video:{},screen:{}}},this.consumerId=null,this.producerId=null,this.pubStatus={audio:{audio:!1,producerId:"",consumerId:"",consumerStatus:"init",stopconsumerStatus:"init",mute:!1,simulcastEnable:!1},audioSlave:{audioSlave:!1,producerId:"",consumerId:"",consumerStatus:"init",stopconsumerStatus:"init",mute:!1,simulcastEnable:!1},video:{video:!1,producerId:"",consumerId:"",consumerStatus:"init",stopconsumerStatus:"init",mute:!1,simulcastEnable:!1},screen:{screen:!1,producerId:"",consumerId:"",consumerStatus:"init",stopconsumerStatus:"init",mute:!1,simulcastEnable:!1}},this.subConf={audio:!0,audioSlave:!0,video:!0,screen:!0,highOrLow:{video:d.STREAM_TYPE.HIGH,screen:d.STREAM_TYPE.HIGH}},this.subStatus={audio:!1,audioSlave:!1,video:!1,screen:!1},this.muteStatus={audio:{send:!1,recv:!1},audioSlave:{send:!1,recv:!1},video:{send:!1,recv:!1},screen:{send:!1,recv:!1}},this.renderMode={remote:{video:{},screen:{}}},this.mediaHelper&&this.mediaHelper.destroy(),this._play&&this._play.destroy(),this._play=null,this._record&&this._record.destroy(),this._record=null}get Play(){return this._play}get Record(){return this._record}getId(){return"string"===this.client.adapterRef.channelInfo.uidType?this.stringStreamID:this.streamID}async getStats(){let e=this.client.adapterRef&&this.client.adapterRef._mediasoup&&this.client.adapterRef._mediasoup._recvTransport&&this.client.adapterRef._mediasoup._recvTransport._handler._pc;if(this.logger.log("获取音视频连接数据, uid: "+this.stringStreamID),e){const t={accessDelay:"0",audioReceiveBytes:"0",audioReceivePackets:"0",audioReceivePacketsLost:"0",endToEndDelay:"0",videoReceiveBytes:"0",videoReceiveDecodeFrameRate:"0",videoReceiveFrameRate:"0",videoReceivePackets:"0",videoReceivePacketsLost:"0",videoReceiveResolutionHeight:"0",videoReceiveResolutionWidth:"0"};try{(await e.getStats()).forEach(e=>{"inbound-rtp"===e.type?"video"===e.mediaType?(t.videoReceiveBytes=e.bytesReceived.toString(),t.videoReceivePackets=e.packetsReceived.toString(),t.videoReceivePacketsLost=e.packetsLost.toString(),t.videoReceiveFrameRate=e.framesPerSecond.toString(),t.videoReceiveDecodeFrameRate=e.framesPerSecond.toString()):"audio"===e.mediaType&&(t.audioReceiveBytes=e.bytesReceived.toString(),t.audioReceivePackets=e.packetsReceived.toString(),t.audioReceivePacketsLost=e.packetsLost.toString()):"candidate-pair"===e.type?("number"==typeof e.currentRoundTripTime&&(t.accessDelay=(1e3*e.currentRoundTripTime).toString()),"number"==typeof e.totalRoundTripTime&&(t.endToEndDelay=Math.round(100*e.totalRoundTripTime).toString())):"track"===e.type&&void 0!==e.frameWidth&&(t.videoReceiveResolutionWidth=e.frameWidth.toString(),t.videoReceiveResolutionHeight=e.frameHeight.toString())})}catch(e){this.logger.error("failed to get remoteStats",e.name,e.message)}return t}}setSubscribeConfig(e){if(this.logger.log(`[Subscribe] 设置 ${this.stringStreamID} 订阅规则：${JSON.stringify(e)}`),"number"==typeof e.highOrLow&&(this.subConf.highOrLow.video=e.highOrLow,this.subConf.highOrLow.screen=e.highOrLow),"boolean"==typeof e.audio&&(this.subConf.audio=e.audio),"boolean"==typeof e.audioSlave&&(this.subConf.audioSlave=e.audioSlave),"boolean"==typeof e.video?this.subConf.video=e.video:"high"===e.video?(this.subConf.video=!0,this.subConf.highOrLow.video=d.STREAM_TYPE.HIGH):"low"===e.video&&(this.subConf.video=!0,this.subConf.highOrLow.video=d.STREAM_TYPE.LOW),"boolean"==typeof e.screen?this.subConf.screen=e.screen:"high"===e.screen?(this.subConf.screen=!0,this.subConf.highOrLow.screen=d.STREAM_TYPE.HIGH):"low"===e.screen&&(this.subConf.screen=!0,this.subConf.highOrLow.screen=d.STREAM_TYPE.LOW),this.pubStatus.audio.audio&&this.subConf.audio?(this.subConf.audio=!0,this.audio=!0):this.subConf.audio=!1,this.pubStatus.audioSlave.audioSlave&&this.subConf.audioSlave?(this.subConf.audioSlave=!0,this.audioSlave=!0):this.subConf.audioSlave=!1,this.pubStatus.video.video&&this.subConf.video?(this.subConf.video=!0,this.video=!0):this.subConf.video=!1,this.pubStatus.screen.screen&&this.subConf.screen?(this.subConf.screen=!0,this.screen=!0):this.subConf.screen=!1,this.logger.log(`[Subscribe] 设置 ${this.stringStreamID} 订阅规则结果：${JSON.stringify(this.subConf)}`),this.client.apiFrequencyControl({name:"setSubscribeConfig",code:0,param:{streamID:this.stringStreamID,conf:Object.assign({},this.subConf)}}),this.pubStatus.screen.screen){const e={uid:"string"===this.client.adapterRef.channelInfo.uidType?this.stringStreamID:this.streamID,subscribe:this.subConf.screen};this.client.apiFrequencyControl({name:"subscribeRemoteSubStreamVideo",code:0,param:JSON.stringify(e,null," ")})}}getAudioStream(){return this.client.apiFrequencyControl({name:"setExternalAudioRender",code:0,param:JSON.stringify({},null," ")}),this.mediaHelper.audio.audioStream}getAudioTrack(){return this.mediaHelper.audio.audioStream.getAudioTracks()[0]||null}getVideoTrack(){return this.mediaHelper.video.videoStream.getVideoTracks()[0]||null}async play(e,t={}){if(v.isExistOptions({tag:"Stream.playOptions.audio",value:t.audio}).result||(t.audio=!0),v.isExistOptions({tag:"Stream.playOptions.audioSlave",value:t.audioSlave}).result||(t.audioSlave=!0),v.isExistOptions({tag:"Stream.playOptions.video",value:t.video}).result||(t.video=!0),v.isExistOptions({tag:"Stream.playOptions.screen",value:t.screen}).result||(t.screen=!0),this.logger.log(`[play] play() uid ${this.stringStreamID} 播放, Stream.pla::`,JSON.stringify(t)),t.audio&&this._play&&this.mediaHelper.audio.audioStream.getTracks().length)if(this.client.spatialManager)this.logger.log("[play] 启用了空间音频，跳过本地音频播放。");else{this.logger.log(`[play] uid ${this.stringStreamID} 开始播放远端音频`);try{await this._play.playAudioStream(this.mediaHelper.audio.audioStream,t.muted),this.audioPlay_=!0}catch(e){this.audioPlay_=!1,this.client.emit("notAllowedError",e),this.client.emit("NotAllowedError",e),this.safeEmit("notAllowedError",e)}}if(t.audioSlave&&this._play&&this.mediaHelper.screenAudio.screenAudioStream.getTracks().length)if(this.client.spatialManager)this.logger.log("[play] 启用了空间音频，跳过本地音频辅流播放。");else{this.logger.log(`[play] uid ${this.stringStreamID} 开始播放远端音频辅流`);try{await this._play.playAudioSlaveStream(this.mediaHelper.screenAudio.screenAudioStream,t.muted),this.audioSlavePlay_=!0}catch(e){this.audioSlavePlay_=!1,this.client.emit("notAllowedError",e),this.client.emit("NotAllowedError",e),this.safeEmit("notAllowedError",e)}}let i;if(i="string"==typeof e?document.getElementById(e):e||null,i){if(t.video&&(this.videoView=i,this._play&&this.mediaHelper.video.videoStream.getVideoTracks().length)){this.logger.log(`[play] uid ${this.stringStreamID} 开始启动视频播放 主流 远端`);try{let e="remote";await this._play.playVideoStream(this.mediaHelper.video.renderStream,i,e),"width"in this.renderMode.remote.video&&this._play.setVideoRender(this.renderMode.remote.video),this.videoPlay_=!0}catch(e){this.videoPlay_=!1,this.client.emit("notAllowedError",e),this.client.emit("NotAllowedError",e),this.safeEmit("notAllowedError",e)}}if(t.screen&&(this.screenView=i,this._play&&this.mediaHelper&&this.mediaHelper.screen.screenVideoStream.getVideoTracks().length)){this.logger.log(`[play] uid ${this.stringStreamID} 开始启动视频播放 辅流 远端`);try{await this._play.playScreenStream(this.mediaHelper.screen.renderStream,i),"width"in this.renderMode.remote.screen&&this._play.setScreenRender(this.renderMode.remote.screen),this.screenPlay_=!1}catch(e){this.screenPlay_=!1,this.client.emit("notAllowedError",e),this.client.emit("NotAllowedError",e),this.safeEmit("notAllowedError",e)}}}this.client.apiFrequencyControl({name:"play",code:0,param:JSON.stringify({streamID:this.stringStreamID,playOptions:t,isRemote:!0},null," ")})}async resume(){y.tryResumeAudioContext()&&this.logger.log("正在尝试恢复AudioContext自动播放受限"),this._play&&(await this._play.resume(),this._play.audioDom&&!this._play.audioDom.paused&&(this.audioPlay_=!0),this._play.audioSlaveDom&&!this._play.audioSlaveDom.paused&&(this.audioSlavePlay_=!0),this._play.videoDom&&!this._play.videoDom.paused&&(this.videoPlay_=!0),this._play.screenDom&&!this._play.screenDom.paused&&(this.screenPlay_=!0)),this.client.apiFrequencyControl({name:"resume",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!0},null," ")})}setRemoteRenderMode(e,t){e&&e.width-0&&e.height-0||(this.logger.warn("setRemoteRenderMode 参数错误"),this.client.apiFrequencyControl({name:"setRemoteRenderMode",code:-1,param:Object.assign({streamID:this.stringStreamID,mediaType:t},e)})),this.client&&this._play&&(this.logger.log(`uid ${this.stringStreamID} 设置远端视频播放窗口大小: `,t||"video+screen",JSON.stringify(e)),t&&"video"!==t||(this._play&&this._play.setVideoRender(e),this.renderMode.remote.video=e),t&&"screen"!==t||(this.renderMode.remote.screen=e,this._play&&this._play.setScreenRender(e)),this.client.apiFrequencyControl({name:"setRemoteRenderMode",code:0,param:Object.assign(Object.assign({},e),{mediaType:t,streamID:this.stringStreamID})}))}stop(e){this.logger.log(`uid ${this.stringStreamID} Stream.stop: 停止播放 ${e||"音视频流"}`),this._play&&("audio"===e?(this._play.stopPlayAudioStream(),this.audioPlay_=!1):"audioSlave"===e?(this._play.stopPlayAudioSlaveStream(),this.audioSlavePlay_=!1):"video"===e?(this._play.stopPlayVideoStream(),this.videoPlay_=!1):"screen"===e?(this._play.stopPlayScreenStream(),this.screenPlay_=!1):(this._play.audioDom&&(this._play.stopPlayAudioStream(),this.audioPlay_=!1),this._play.audioSlaveDom&&(this._play.stopPlayAudioSlaveStream(),this.audioSlavePlay_=!1),this._play.videoDom&&(this._play.stopPlayVideoStream(),this.videoPlay_=!1),this._play.screenDom&&(this._play.stopPlayScreenStream(),this.screenPlay_=!1)),this.client.apiFrequencyControl({name:"stop",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!0,audio:this.audio,video:this.video,screen:this.screen,type:e},null," ")}))}async isPlaying(e){let t=!1;if(this._play)if("audio"===e)t=await this._play.isPlayAudioStream();else if("audioSlave"===e)t=await this._play.isPlayAudioSlaveStream();else if("video"===e)t=await this._play.isPlayVideoStream();else{if("screen"!==e){this.logger.warn("isPlaying: unknown type");let e="remoteStream.isPlaying: The type of parameter(uid) is unknown",t="remoteStream.isPlaying: uid 参数类型非法",i="please make sure the parameter(type) is correct",r="请输入正确的参数类型",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;return Promise.reject(new g.default({code:f.default.UNKNOWN_TYPE_ERROR,message:s,advice:a}))}t=await this._play.isPlayScreenStream()}else;return this.client.apiFrequencyControl({name:"isPlaying",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!0,type:e},null," ")}),this.logger.log(`检查${this.stringStreamID}的${e}播放状态: ${t}`),t}async unmuteAudio(){this.logger.log("启用音频轨道: ",this.stringStreamID);try{if(!this._play){let e="remoteStream.unmuteAudio: Play is not start",t="remoteStream.unmuteAudio: 播放未开始",i="Please start playing first",r="请先开启播放",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new g.default({code:f.default.PLAY_NOT_START_ERROR,message:s,advice:a})}this.muteStatus.audio.recv=!1,this.mediaHelper.audio.audioStream.getAudioTracks().length&&(this.mediaHelper.audio.audioStream.getAudioTracks()[0].enabled=!0),this._play.playAudioStream(this.mediaHelper.audio.audioStream,!1),this.client.apiFrequencyControl({name:"unmuteAudio",code:0,param:JSON.stringify({streamID:this.stringStreamID},null," ")})}catch(e){this.logger.error("API调用失败：Stream:unmuteAudio",e.name,e.message,e),this.client.apiFrequencyControl({name:"unmuteAudio",code:-1,param:JSON.stringify({streamID:this.stringStreamID,reason:e},null," ")})}}async muteAudio(){this.logger.log("禁用音频轨道: ",this.stringStreamID);try{if(!this._play){let e="remoteStream.muteAudio: Play is not start",t="remoteStream.muteAudio: 播放未开始",i="Please start playing first",r="请先开启播放",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new g.default({code:f.default.PLAY_NOT_START_ERROR,message:s,advice:a})}this.muteStatus.audio.recv=!0,this.mediaHelper.audio.audioStream.getAudioTracks().length&&(this.mediaHelper.audio.audioStream.getAudioTracks()[0].enabled=!1),this._play.stopPlayAudioStream(),this.client.apiFrequencyControl({name:"muteAudio",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!0},null," ")})}catch(e){this.logger.error("API调用失败：Stream:muteAudio",e.name,e.message,e),this.client.apiFrequencyControl({name:"muteAudio",code:-1,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!0,reason:e.message},null," ")})}}async unmuteAudioSlave(){this.logger.log("启用音频辅流轨道: ",this.stringStreamID);try{if(!this._play){let e="remoteStream.unmuteAudioSlave: Play is not start",t="remoteStream.unmuteAudioSlave: 播放未开始",i="Please start playing first",r="请先开启播放",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new g.default({code:f.default.PLAY_NOT_START_ERROR,message:s,advice:a})}this.muteStatus.audioSlave.recv=!1,this.mediaHelper.screenAudio.screenAudioStream.getAudioTracks().length&&(this.mediaHelper.screenAudio.screenAudioStream.getAudioTracks()[0].enabled=!0),this._play.playAudioSlaveStream(this.mediaHelper.screenAudio.screenAudioStream,!1),this.client.apiFrequencyControl({name:"unmuteAudioSlave",code:0,param:JSON.stringify({streamID:this.stringStreamID},null," ")})}catch(e){this.logger.error("API调用失败：Stream:unmuteAudioSlave",e.name,e.message,e),this.client.apiFrequencyControl({name:"unmuteAudioSlave",code:-1,param:JSON.stringify({streamID:this.stringStreamID,reason:e},null," ")})}}async muteAudioSlave(){this.logger.log("禁用音频辅流轨道: ",this.stringStreamID);try{if(!this._play){let e="remoteStream.muteAudioSlave: Play is not start",t="remoteStream.muteAudioSlave: 播放未开始",i="Please start playing first",r="请先开启播放",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new g.default({code:f.default.PLAY_NOT_START_ERROR,message:s,advice:a})}this.muteStatus.audioSlave.recv=!0,this.mediaHelper.screenAudio.screenAudioStream.getAudioTracks().length&&(this.mediaHelper.screenAudio.screenAudioStream.getAudioTracks()[0].enabled=!1),this._play.stopPlayAudioSlaveStream(),this.client.apiFrequencyControl({name:"muteAudioSlave",code:0,param:JSON.stringify({streamID:this.stringStreamID},null," ")})}catch(e){this.logger.error("API调用失败：Stream:muteAudioSlave",e.name,e.message,e),this.client.apiFrequencyControl({name:"muteAudioSlave",code:-1,param:JSON.stringify({streamID:this.stringStreamID,reason:e},null," ")})}}hasAudio(){return this.mediaHelper.audio.audioStream.getAudioTracks().length>0}hasAudioSlave(){return this.mediaHelper.screenAudio.screenAudioStream.getAudioTracks().length>0}getAudioLevel(e="audio"){const t=this.mediaHelper.getOrCreateAudioPipeline(e);if(t){if(!t.audioLevelNode){const t=y.getAudioContext();if(t&&t.audioWorklet&&t.audioWorklet.addModule||(this.logger.error("getAudioLevel is not supported in this browser"),this.client.safeEmit("error","AUDIOLEVEL_NOT_SUPPORTED")),"suspended"===(null==t?void 0:t.state)){let e="remoteStream.getAudioLevel: AudioContext is Suspended",t="playVideoStream: 浏览器自动播放受限: AudioContext is Suspended",i="Please refer to the suggested link for processing --\x3e ",r="请参考提示的链接进行处理 --\x3e ",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;const o=new g.default({code:f.default.AUTO_PLAY_NOT_ALLOWED,url:"https://doc.yunxin.163.com/docs/jcyOTA0ODM/jM3NDE0NTI?platformId=50082",message:s,advice:a});return this.client.safeEmit("notAllowedError",o),this.safeEmit("notAllowedError",o),0}this.client.apiFrequencyControl({name:"getAudioLevel",code:0,param:{mediaType:e,streamID:this.stringStreamID}})}const i=t.getAudioLevel();return i?i.volume:(this.logger.log("正在加载音频模块"),0)}return this.logger.error("当前环境不支持AudioContext"),0}setAudioVolume(e=100){let t=null;if(Number.isInteger(e)?e<0?e=0:e>100?e=255:e*=2.55:(this.logger.log("volume 为 0 - 100 的整数"),t="INVALID_ARGUMENTS"),this.logger.log(`调节${this.stringStreamID}的音量大小: ${e}`),this.audio){if(!this._play){let e="remoteStream.setAudioVolume: Play is not start",t="remoteStream.setAudioVolume: 播放未开始",i="Please start playing first",r="请先开启播放",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new g.default({code:f.default.PLAY_NOT_START_ERROR,message:s,advice:a})}this._play.setPlayVolume(e)}else this.logger.log("没有音频流，请检查是否有订阅过音频"),t="INVALID_OPERATION";if(t)return this.client.apiFrequencyControl({name:"setAudioVolume",code:-1,param:{streamID:this.stringStreamID,volume:e,isRemote:!0,reason:t}}),t;this.client.apiFrequencyControl({name:"setAudioVolume",code:0,param:{streamID:this.stringStreamID,volume:e,isRemote:!0}})}setAudioSlaveVolume(e=100){let t=null;if(Number.isInteger(e)?e<0?e=0:e>100?e=255:e*=2.55:(this.logger.log("volume 为 0 - 100 的整数"),t="INVALID_ARGUMENTS"),this.logger.log(`调节${this.stringStreamID}的音频辅流音量大小: ${e}`),this.audioSlave){if(!this._play){let e="remoteStream.setAudioSlaveVolume: Play is not start",t="remoteStream.setAudioSlaveVolume: 播放未开始",i="Please start playing first",r="请先开启播放",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new g.default({code:f.default.PLAY_NOT_START_ERROR,message:s,advice:a})}this._play.setPlayAudioSlaveVolume(e)}else this.logger.log("没有音频辅流，请检查是否有订阅过音频辅流"),t="INVALID_OPERATION";if(t)return this.client.apiFrequencyControl({name:"setAudioSlaveVolume",code:-1,param:JSON.stringify({volume:e,reason:t},null," ")}),t;this.client.apiFrequencyControl({name:"setAudioSlaveVolume",code:0,param:JSON.stringify({volume:e},null," ")})}async setAudioOutput(e,t){if(this._play){try{await this._play.setAudioOutput(e)}catch(e){throw t&&setTimeout(()=>{t(e)},0),this.logger.error("设置输出设备失败",e.name,e.message),e}t&&setTimeout(t,0)}this.client.apiFrequencyControl({name:"setAudioOutput",code:0,param:JSON.stringify({streamID:this.stringStreamID,deviceId:e,isRemote:!0},null," ")})}async unmuteVideo(){this.logger.log(`启用 ${this.stringStreamID} 的视频轨道`);try{if(!this._play){let e="remoteStream.unmuteVideo: Play is not start",t="remoteStream.unmuteVideo: 播放未开始",i="Please start playing first",r="请先开启播放",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new g.default({code:f.default.PLAY_NOT_START_ERROR,message:s,advice:a})}if(!this.videoView){let e="remoteStream.unmuteVideo: videoView is unavailable",t="remoteStream.unmuteVideo: videoView 不可用",i="please make sure videoView available",r="请确保 videoView 可用",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new g.default({code:f.default.UNAVAILABLE_ERROR,message:s,advice:a})}this.muteStatus.video.recv=!1,this.mediaHelper&&this.mediaHelper.video.cameraTrack&&(this.mediaHelper.video.cameraTrack.enabled=!0),this.client.apiFrequencyControl({name:"unmuteVideo",code:0,param:JSON.stringify({isRemote:!0,streamID:this.stringStreamID},null," ")})}catch(e){this.logger.error("API调用失败：Stream:unmuteVideo",e.name,e.message,e),this.client.apiFrequencyControl({name:"unmuteVideo",code:-1,param:JSON.stringify({isRemote:!0,streamID:this.stringStreamID,reason:e.message},null," ")})}}async muteVideo(){this.logger.log(`禁用 ${this.stringStreamID} 的视频轨道`);try{if(!this._play){let e="remoteStream.muteVideo: Play is not start",t="remoteStream.muteVideo: 播放未开始",i="Please start playing first",r="请先开启播放",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new g.default({code:f.default.PLAY_NOT_START_ERROR,message:s,advice:a})}this.muteStatus.video.recv=!0,this.mediaHelper&&this.mediaHelper.video.cameraTrack&&(this.mediaHelper.video.cameraTrack.enabled=!1),this.client.apiFrequencyControl({name:"muteVideo",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!0},null," ")})}catch(e){this.logger.error("API调用失败：Stream:muteVideo",e.name,e.message,e),this.client.apiFrequencyControl({name:"muteVideo",code:-1,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!0,reason:e.message},null," ")})}}async unmuteScreen(){this.logger.log(`启用 ${this.stringStreamID} 的视频轨道`);try{if(!this._play){let e="remoteStream.unmuteScreen: Play is not start",t="remoteStream.unmuteScreen: 播放未开始",i="Please start playing first",r="请先开启播放",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new g.default({code:f.default.PLAY_NOT_START_ERROR,message:s,advice:a})}if(!this.screenView){let e="remoteStream.unmuteScreen: screenView is unavailable",t="remoteStream.unmuteScreen: screenView 不可用",i="please make sure screenView available",r="请确保 screenView 可用",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new g.default({code:f.default.UNAVAILABLE_ERROR,message:s,advice:a})}this.muteStatus.screen.recv=!1,this.mediaHelper&&this.mediaHelper.screen.screenVideoTrack&&(this.mediaHelper.screen.screenVideoTrack.enabled=!0),this.client.apiFrequencyControl({name:"unmuteScreen",code:0,param:JSON.stringify({isRemote:!0,streamID:this.stringStreamID},null," ")})}catch(e){this.logger.error("API调用失败：Stream:unmuteScreen",e.name,e.message,e),this.client.apiFrequencyControl({name:"unmuteScreen",code:-1,param:JSON.stringify({isRemote:!0,streamID:this.stringStreamID,reason:e.message},null," ")})}}async muteScreen(){this.logger.log(`禁用 ${this.stringStreamID} 的视频轨道`);try{if(!this._play){let e="remoteStream.muteScreen: Play is not start",t="remoteStream.muteScreen: 播放未开始",i="Please start playing first",r="请先开启播放",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new g.default({code:f.default.PLAY_NOT_START_ERROR,message:s,advice:a})}this.mediaHelper&&this.mediaHelper.screen.screenVideoTrack&&(this.mediaHelper.screen.screenVideoTrack.enabled=!1),this.muteStatus.screen.recv=!0,this.client.apiFrequencyControl({name:"muteScreen",code:0,param:JSON.stringify({isRemote:!0,streamID:this.stringStreamID},null," ")})}catch(e){this.logger.error("API调用失败：Stream:muteScreen",e,...arguments),this.client.apiFrequencyControl({name:"muteScreen",code:-1,param:JSON.stringify({isRemote:!0,streamID:this.stringStreamID,reason:e.message},null," ")})}}hasVideo(){this.logger.log("获取视频 flag"),this.mediaHelper.video.videoStream.getVideoTracks().length}hasScreen(){this.mediaHelper.screen.screenVideoStream.getVideoTracks().length}async takeSnapshot(e){if(!this.video&&!this.screen)return this.logger.log("没有视频流，请检查是否有 订阅 过视频"),this.client.apiFrequencyControl({name:"takeSnapshot",code:-1,param:JSON.stringify(Object.assign(Object.assign({streamID:this.stringStreamID,isRemote:!1},e),{reason:"没有视频流，请检查是否有 订阅 过视频"}),null," ")}),"INVALID_OPERATION";{let t="remoteStream.takeSnapshot: Play is not start",i="remoteStream.takeSnapshot: 播放未开始",r="Please start playing first",s="请先开启播放",a=S.IS_ZH?i:t,o=S.IS_ZH?s:r;if(!this._play)throw new g.default({code:f.default.PLAY_NOT_START_ERROR,message:a,advice:o});await this._play.takeSnapshot(e,this.streamID),this.client.apiFrequencyControl({name:"takeSnapshot",code:0,param:Object.assign(Object.assign({},e),{streamID:this.stringStreamID,isRemote:!0})})}}takeSnapshotBase64(e){if(this.video||this.screen){if(!this._play){let e="remoteStream.takeSnapshotBase64: Play is not start",t="remoteStream.takeSnapshotBase64: 播放未开始",i="Please start playing first",r="请先开启播放",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new g.default({code:f.default.PLAY_NOT_START_ERROR,message:s,advice:a})}let t=this._play.takeSnapshotBase64(e);return this.client.apiFrequencyControl({name:"takeSnapshotBase64",code:0,param:Object.assign({streamID:this.stringStreamID,isRemote:!1},e)}),t}return this.logger.log("没有视频流，请检查是否有 发布 过视频"),this.client.apiFrequencyControl({name:"takeSnapshotBase64",code:-1,param:JSON.stringify(Object.assign(Object.assign({streamID:this.stringStreamID,isRemote:!1},e),{reason:"没有视频流，请检查是否有 发布 过视频"}),null," ")}),"INVALID_OPERATION"}async startMediaRecording(e){const t=[];if(!this.mediaHelper){let e="remoteStream.startMediaRecording: media helper is unavailable",t="remoteStream.startMediaRecording: media helper 不可用",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new g.default({code:f.default.UNAVAILABLE_ERROR,message:s,advice:a})}switch(e.type){case"screen":t.push(this.mediaHelper.screen.screenVideoStream),t.push(this.mediaHelper.audio.audioStream);break;case"camera":case"video":t.push(this.mediaHelper.video.videoStream),t.push(this.mediaHelper.audio.audioStream);break;case"audio":t.push(this.mediaHelper.audio.audioStream)}if(0!==t.length){if(!this._record||!this.streamID||!t){let e="remoteStream_startMediaRecording: invalid parameter when start recording",t="remoteStream_startMediaRecording: 开始录制时参数异常",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new g.default({code:f.default.RECORDING_ERROR,message:s,advice:a})}return this._record&&this._record.start({uid:"string"===this.client.adapterRef.channelInfo.uidType?this.stringStreamID:this.streamID,type:e.type,reset:e.reset,stream:t})}this.logger.log("没有没发现要录制的媒体流")}stopMediaRecording(e){if(!this._record){let e="remoteStream.stopMediaRecording: recording is not start",t="remoteStream.stopMediaRecording: 录制未开始",i="Please start recording first",r="请先开启录制",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new g.default({code:f.default.RECORDING_NOT_START_ERROR,message:s,advice:a})}return this._record.stop({})}playMediaRecording(e){if(!this._record){let e="remoteStream.playMediaRecording: recording is not start",t="remoteStream.playMediaRecording: 录制未开始",i="Please start recording first",r="请先开启录制",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new g.default({code:f.default.RECORDING_NOT_START_ERROR,message:s,advice:a})}return this._record.play(e.view)}listMediaRecording(){let e=[];if(!this._record){let e="remoteStream.listMediaRecording: recording is not start",t="remoteStream.listMediaRecording: 录制未开始",i="Please start recording first",r="请先开启录制",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new g.default({code:f.default.RECORDING_NOT_START_ERROR,message:s,advice:a})}const t=this._record.getRecordStatus();return"init"!==t.status&&e.push(t),e}cleanMediaRecording(e){if(!this._record){let e="remoteStream.cleanMediaRecording: recording is not start",t="remoteStream.cleanMediaRecording: 录制未开始",i="Please start recording first",r="请先开启录制",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new g.default({code:f.default.RECORDING_NOT_START_ERROR,message:s,advice:a})}return this._record.clean()}downloadMediaRecording(e){if(!this._record){let e="remoteStream.downloadMediaRecording: recording is not start",t="remoteStream.downloadMediaRecording: 录制未开始",i="Please start recording first",r="请先开启录制",s=S.IS_ZH?t:e,a=S.IS_ZH?r:i;throw new g.default({code:f.default.RECORDING_NOT_START_ERROR,message:s,advice:a})}return this._record.download()}clearRemotePubStatus(){let e=["audio","audioSlave","video","screen"];for(let t of e)this[t]=!1,this.pubStatus[t][t]=!1,this.pubStatus[t].producerId="",this.pubStatus[t].consumerId="",this.pubStatus[t].consumerStatus="init",this.pubStatus[t].stopconsumerStatus="init"}setCanvasWatermarkConfigs(e){if(this._play){let t=null;if(e.mediaType&&"video"!==e.mediaType?"screen"===e.mediaType&&(t=this._play.watermark.screen.canvasControl):t=this._play.watermark.video.canvasControl,!t)return void this.logger.error("setCanvasWatermarkConfigs：播放器未初始化",e.mediaType);const i={TEXT:10,TIMESTAMP:1,IMAGE:4};if(e.textWatermarks&&e.textWatermarks.length>i.TEXT){this.logger.error(`目前的文字水印数量：${e.textWatermarks.length}。允许的数量：${i.TEXT}`);let t="remoteStream_setCanvasWatermarkConfigs: The number of text watermarks exceeds the limit",r="remoteStream_setCanvasWatermarkConfigs: 文字水印数量超限",s="The number of text watermarks can be set up to 10, please make sure not to exceed the limit",a="最多可以设置 10 个文字水印",o=S.IS_ZH?r:t,n=S.IS_ZH?a:s;throw new g.default({code:f.default.WATERMARKS_EXCEEDED_ERROR,message:o,advice:n})}if(e.imageWatermarks&&e.imageWatermarks.length>i.IMAGE){this.logger.error(`目前的图片水印数量：${e.imageWatermarks.length}。允许的数量：${i.IMAGE}`);let t="remoteStream_setCanvasWatermarkConfigs: The number of image watermarks exceeds the limit",r="remoteStream_setCanvasWatermarkConfigs: 文字水印数量超限",s="The number of image watermarks can be set up to 4, please make sure not to exceed the limit",a="最多可以设置 4 个文字水印",o=S.IS_ZH?r:t,n=S.IS_ZH?a:s;throw new g.default({code:f.default.WATERMARKS_EXCEEDED_ERROR,message:o,advice:n})}t.checkWatermarkParams(e),t.updateWatermarks(e);Object.assign({uid:this.stringStreamID},e);this.client.apiFrequencyControl({name:"setRemoteCanvasWatermarkConfigs",code:0,param:{isRemote:!1,streamID:this.stringStreamID,mediaType:e.mediaType}})}else this.logger.error("setCanvasWatermarkConfigs：播放器未初始化")}getMuteStatus(e){return"audio"===e?{send:this.muteStatus.audio.send,recv:this.muteStatus.audio.recv,muted:this.muteStatus.audio.send||this.muteStatus.audio.recv}:"video"===e?{send:this.muteStatus.video.send,recv:this.muteStatus.video.recv,muted:this.muteStatus.video.send||this.muteStatus.video.recv}:{send:this.muteStatus.screen.send,recv:this.muteStatus.screen.recv,muted:this.muteStatus.screen.send||this.muteStatus.screen.recv}}getAdapterRef(){return this.client.adapterRef.remoteStreamMap[this.streamID]===this?this.client.adapterRef:null}destroy(){this.client&&(this.client.apiFrequencyControl({name:"destroy",code:0,param:{streamID:this.stringStreamID,isRemote:!0}}),this.logger.log(`uid ${this.stringStreamID} 销毁 Stream 实例`),this.stop(),this._reset())}}t.RemoteStream=b},function(e,t,i){var r=i(70),s=e.exports;!function(){var e,t,i,a=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,o={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};function n(e){return a.lastIndex=0,a.test(e)?'"'+e.replace(a,(function(e){var t=o[e];return"string"==typeof t?t:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)}))+'"':'"'+e+'"'}"function"!=typeof s.stringify&&(s.stringify=function(s,a,o){var d;if(e="",t="","number"==typeof o)for(d=0;d<o;d+=1)t+=" ";else"string"==typeof o&&(t=o);if(i=a,a&&"function"!=typeof a&&("object"!=typeof a||"number"!=typeof a.length))throw new Error("JSON.stringify");return function s(a,o){var d,c,l,u,h,p=e,m=o[a],f=null!=m&&(m instanceof r||r.isBigNumber(m));switch(m&&"object"==typeof m&&"function"==typeof m.toJSON&&(m=m.toJSON(a)),"function"==typeof i&&(m=i.call(o,a,m)),typeof m){case"string":return f?m:n(m);case"number":return isFinite(m)?String(m):"null";case"boolean":case"null":case"bigint":return String(m);case"object":if(!m)return"null";if(e+=t,h=[],"[object Array]"===Object.prototype.toString.apply(m)){for(u=m.length,d=0;d<u;d+=1)h[d]=s(d,m)||"null";return l=0===h.length?"[]":e?"[\n"+e+h.join(",\n"+e)+"\n"+p+"]":"["+h.join(",")+"]",e=p,l}if(i&&"object"==typeof i)for(u=i.length,d=0;d<u;d+=1)"string"==typeof i[d]&&(l=s(c=i[d],m))&&h.push(n(c)+(e?": ":":")+l);else Object.keys(m).forEach((function(t){var i=s(t,m);i&&h.push(n(t)+(e?": ":":")+i)}));return l=0===h.length?"{}":e?"{\n"+e+h.join(",\n"+e)+"\n"+p+"}":"{"+h.join(",")+"}",e=p,l}}("",{"":s})})}()},function(e,t,i){var r=null;const s=/(?:_|\\u005[Ff])(?:_|\\u005[Ff])(?:p|\\u0070)(?:r|\\u0072)(?:o|\\u006[Ff])(?:t|\\u0074)(?:o|\\u006[Ff])(?:_|\\u005[Ff])(?:_|\\u005[Ff])/,a=/(?:c|\\u0063)(?:o|\\u006[Ff])(?:n|\\u006[Ee])(?:s|\\u0073)(?:t|\\u0074)(?:r|\\u0072)(?:u|\\u0075)(?:c|\\u0063)(?:t|\\u0074)(?:o|\\u006[Ff])(?:r|\\u0072)/;e.exports=function(e){var t={strict:!1,storeAsString:!1,alwaysParseAsBig:!1,useNativeBigInt:!1,protoAction:"error",constructorAction:"error"};if(null!=e){if(!0===e.strict&&(t.strict=!0),!0===e.storeAsString&&(t.storeAsString=!0),t.alwaysParseAsBig=!0===e.alwaysParseAsBig&&e.alwaysParseAsBig,t.useNativeBigInt=!0===e.useNativeBigInt&&e.useNativeBigInt,void 0!==e.constructorAction){if("error"!==e.constructorAction&&"ignore"!==e.constructorAction&&"preserve"!==e.constructorAction)throw new Error('Incorrect value for constructorAction option, must be "error", "ignore" or undefined but passed '+e.constructorAction);t.constructorAction=e.constructorAction}if(void 0!==e.protoAction){if("error"!==e.protoAction&&"ignore"!==e.protoAction&&"preserve"!==e.protoAction)throw new Error('Incorrect value for protoAction option, must be "error", "ignore" or undefined but passed '+e.protoAction);t.protoAction=e.protoAction}}var o,n,d,c,l={'"':'"',"\\":"\\","/":"/",b:"\b",f:"\f",n:"\n",r:"\r",t:"\t"},u=function(e){throw{name:"SyntaxError",message:e,at:o,text:d}},h=function(e){return e&&e!==n&&u("Expected '"+e+"' instead of '"+n+"'"),n=d.charAt(o),o+=1,n},p=function(){var e,s="";for("-"===n&&(s="-",h("-"));n>="0"&&n<="9";)s+=n,h();if("."===n)for(s+=".";h()&&n>="0"&&n<="9";)s+=n;if("e"===n||"E"===n)for(s+=n,h(),"-"!==n&&"+"!==n||(s+=n,h());n>="0"&&n<="9";)s+=n,h();if(e=+s,isFinite(e))return null==r&&(r=i(70)),s.length>15?t.storeAsString?s:t.useNativeBigInt?BigInt(s):new r(s):t.alwaysParseAsBig?t.useNativeBigInt?BigInt(e):new r(e):e;u("Bad number")},m=function(){var e,t,i,r="";if('"'===n)for(var s=o;h();){if('"'===n)return o-1>s&&(r+=d.substring(s,o-1)),h(),r;if("\\"===n){if(o-1>s&&(r+=d.substring(s,o-1)),h(),"u"===n){for(i=0,t=0;t<4&&(e=parseInt(h(),16),isFinite(e));t+=1)i=16*i+e;r+=String.fromCharCode(i)}else{if("string"!=typeof l[n])break;r+=l[n]}s=o}}u("Bad string")},f=function(){for(;n&&n<=" ";)h()};return c=function(){switch(f(),n){case"{":return function(){var e,i=Object.create(null);if("{"===n){if(h("{"),f(),"}"===n)return h("}"),i;for(;n;){if(e=m(),f(),h(":"),!0===t.strict&&Object.hasOwnProperty.call(i,e)&&u('Duplicate key "'+e+'"'),!0===s.test(e)?"error"===t.protoAction?u("Object contains forbidden prototype property"):"ignore"===t.protoAction?c():i[e]=c():!0===a.test(e)?"error"===t.constructorAction?u("Object contains forbidden constructor property"):"ignore"===t.constructorAction?c():i[e]=c():i[e]=c(),f(),"}"===n)return h("}"),i;h(","),f()}}u("Bad object")}();case"[":return function(){var e=[];if("["===n){if(h("["),f(),"]"===n)return h("]"),e;for(;n;){if(e.push(c()),f(),"]"===n)return h("]"),e;h(","),f()}}u("Bad array")}();case'"':return m();case"-":return p();default:return n>="0"&&n<="9"?p():function(){switch(n){case"t":return h("t"),h("r"),h("u"),h("e"),!0;case"f":return h("f"),h("a"),h("l"),h("s"),h("e"),!1;case"n":return h("n"),h("u"),h("l"),h("l"),null}u("Unexpected '"+n+"'")}()}},function(e,t){var i;return d=e+"",o=0,n=" ",i=c(),f(),n&&u("Syntax error"),"function"==typeof t?function e(i,r){var s,a=i[r];return a&&"object"==typeof a&&Object.keys(a).forEach((function(t){void 0!==(s=e(a,t))?a[t]=s:delete a[t]})),t.call(i,r,a)}({"":i},""):i}}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.pcCloneTrack=void 0,t.pcCloneTrack=function(e){const t=new RTCPeerConnection,i=new RTCPeerConnection;window.pcLocal=t,window.pcRemote=i,t.onicecandidate=e=>{e.candidate&&i.addIceCandidate(e.candidate)},t.onnegotiationneeded=async e=>{const r=await t.createOffer();await t.setLocalDescription(r),await i.setRemoteDescription(r);const s=await i.createAnswer();await i.setLocalDescription(s),await t.setRemoteDescription(s)};const r=t.addTransceiver("video",{direction:"recvonly"});return i.addTrack(e),e.addEventListener("neTrackEnded",()=>{i.close(),r.receiver.track.stop()}),r.receiver.track}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.preProcessingPureColor=t.preProcessingCopy=t.preProcessingSyncState=t.disablePreProcessing=t.canDisablePreProcessing=t.enablePreProcessing=void 0;const r=i(118),s=i(172),a=i(138);function o(e,t,i){i.videoTrack&&i.videoTrack.enabled!==i.canvasTrack.enabled&&(e.logger.log(`preProcessingCopy: 更改mute状态 ${t} ${i.canvasTrack.enabled} => ${i.videoTrack.enabled}`),i.canvasTrack.enabled=i.videoTrack.enabled)}function n(e,t,i){i.videoTrack&&i.videoTrack.enabled!==i.canvasTrack.enabled&&(e.logger.log(`preProcessingCopy: 更改mute状态 ${t} ${i.canvasTrack.enabled} => ${i.videoTrack.enabled}`),i.canvasTrack.enabled=i.videoTrack.enabled),i.canvasCtx.drawImage(i.videoElem,0,0)}t.enablePreProcessing=async function(e,t,i){var d;let c;if(i||(i=e[t].captureConfig.high.frameRate),c="video"===t?e.video.cameraTrack||e.video.videoSource:e.screen.screenVideoTrack||e.screen.screenVideoSource,!c)return void e.logger.warn("enablePreProcessing：当前没有视频输入 "+t);let l,u=e[t].preProcessing;if(!u){e.logger.log("enablePreProcessing:初始化 mediaType "+t);const i=document.createElement("video");let r=new a.RTCCanvas("canvas"),s=r._canvas,c=r._ctx;if(!c)throw new Error("无法创建canvasCtx 2d");const l=s.captureStream();i.onresize=()=>{r.setSize(i.videoWidth,i.videoHeight),i.play()};const h=l.getVideoTracks()[0];u={canvasTrack:h,canvasCtx:c,videoTrack:null,videoElem:i,canvasElem:s,handlers:[{name:"syncState",enabled:!0,func:o},{name:"copy",enabled:!0,func:n},{name:"mirror",enabled:!1,func:()=>{}},null===(d=e.stream._play)||void 0===d?void 0:d.watermark[t].encoderControl.handler],history:[],timer:null},e[t].preProcessing=u}if(!u)return;"video"===t?r.emptyStreamWith(e.video.videoStream,u.canvasTrack):r.emptyStreamWith(e.screen.screenVideoStream,u.canvasTrack),u.videoElem.srcObject=new MediaStream([c]),u.videoTrack=c,e.stream.isRemote||(l=e.stream.getSender(t,"high")),l&&(l.replaceTrack(u.canvasTrack),e.logger.log(`enablePreProcessing ${t} 成功替换上行`));const h=async()=>{if(u)if(u.videoElem.videoWidth&&u.videoElem.videoHeight&&(u.videoElem.videoWidth===u.canvasElem.width&&u.videoElem.videoHeight===u.canvasElem.height||(e.logger.warn(`前处理宽高变化 ${t} ${u.canvasElem.width}x${u.canvasElem.height} => ${u.videoElem.videoWidth}x${u.videoElem.videoHeight}`),u.canvasElem.width=u.videoElem.videoWidth,u.canvasElem.height=u.videoElem.videoHeight)),u.handlers.length){const i=Date.now(),r=[];for(let s of u.handlers)if(s&&s.enabled){const a=i;await s.func(e,t,u);const o=Date.now()-a;r.push({name:s.name,spent:o})}const s=Date.now();let a=0;for(;a<u.history.length&&s-u.history[a].endTs>5e3;a++);u.history.splice(0,a),u.history.push({startTs:i,endTs:s,handlerTs:r})}else n(e,t,u)};u.timer&&clearInterval(u.timer);const p=Math.floor(1e3/i);try{h()}catch(t){e.logger.error("drawFrame",t.name,t.message,t.stack)}u.timer=s.getRTCTimer().setInterval(h,p),e[t].preProcessingEnabled=!0,e.emit("preProcessChange",{mediaType:t,isOn:!0})},t.canDisablePreProcessing=function(e,t){const i=e[t].preProcessing;return!(!i||!i.timer)&&0===i.handlers.filter(e=>e&&e.enabled&&"syncState"!==e.name&&"copy"!==e.name).length},t.disablePreProcessing=async function(e,t="video",i=!1){e.logger.log("disablePreProcessing "+t);const a=e[t].preProcessing;if(!a)return void e.logger.warn(`disablePreProcessing ${t}:当前没有前处理配置`);let o,n;a.canvasCtx.clearRect(0,0,a.canvasElem.width,a.canvasElem.height),(null==a?void 0:a.timer)&&(s.getRTCTimer().clearInterval(a.timer),a.timer=null),"video"===t?(o=e.video.cameraTrack||e.video.videoSource,r.emptyStreamWith(e.video.videoStream,o)):(o=e.screen.screenVideoTrack||e.screen.screenVideoSource,r.emptyStreamWith(e.screen.screenVideoStream,o)),a.videoElem.srcObject&&(a.videoElem.srcObject=null),e.stream.isRemote||(n=e.stream.getSender(t,"high")),n&&("live"===(null==o?void 0:o.readyState)?(n.replaceTrack(o),e.logger.log(`disablePreProcessing ${t} 成功替换上行为【${o.label}】`)):(n.replaceTrack(null),e.logger.warn("disablePreProcessing 删除上行"))),i||(e[t].preProcessingEnabled=!1),e.emit("preProcessChange",{mediaType:t,isOn:!1})},t.preProcessingSyncState=o,t.preProcessingCopy=n,t.preProcessingPureColor=function(e,t,i){i.canvasCtx.fillStyle="green",i.canvasCtx.fillRect(0,0,i.canvasElem.width,i.canvasElem.height)}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.AudioPipeline=void 0;const r=i(274),s=i(72),a=i(275),o=i(276),n=i(191),d=i(278),c=i(279);let l=0;t.AudioPipeline=class{constructor(e){this.id=++l,this.inputs={local:{track:null,node:null,label:""},remote:{track:null,node:null,label:""}},this.audioLevelNode=null,this.stages=[],this.mixins={},this.output={track:null,stream:new MediaStream,destination:null,directOutput:!0},this.context=e.context,this.logger=e.logger.getChild(()=>{let e="AudioPipeline#"+this.id;this.inputs.local.track&&(e+=" LOCAL",this.inputs.local.track===this.output.track&&(e+=`[${this.inputs.local.label}]`)),this.inputs.remote.track&&(e+=" REMOTE",this.inputs.remote.track===this.output.track&&(e+=`[${this.inputs.remote.label}]`));let t="";for(let e in this.mixins)this.output.destination&&this.mixins[e].node.isConnectedTo(this.output.destination)&&(t+=" m"+e);t&&(e+=" "+t);for(let t in this.stages)this.stages[t].enabled&&(e+="/"+this.stages[t].type);return e}),this.stageInputVolume=new o.StageInputVolume(this.context),this.stageAIProcessing=new n.StageAIProcessing(this.context,this.logger),this.stageDelay=new d.StageDelay(this.context),this.stages=[this.stageInputVolume,this.stageAIProcessing,this.stageDelay],this.output.stream=e.outputStream,this.pluginList=[],this.logger.log("Audio Pipeline Init")}getMixin(e){return this.mixins[e]||(this.mixins[e]=new c.AudioMix(this)),this.mixins[e]}getEnabledStages(){return this.stages.filter(e=>e.enabled)}setInput(e,t,i){this.inputs[e].track=t,this.updateConnection()}getInputVolume(){return this.stageInputVolume.volume}setInputVolume(e){this.stageInputVolume.setVolume(e),this.stageInputVolume.isTransparent()?this.stageInputVolume.enabled&&(this.stageInputVolume.enabled=!1,this.updateConnection()):this.stageInputVolume.enabled||(this.stageInputVolume.enabled=!0,this.updateConnection())}setDelay(e){this.stageDelay.setDelay(e),this.stageDelay.isTransparent()?this.stageDelay.enabled&&(this.stageDelay.enabled=!1,this.updateConnection()):this.stageDelay.enabled||(this.stageDelay.enabled=!0,this.updateConnection())}getAudioLevel(){return this.audioLevelNode||(this.initAudioLevelNode(),this.updateConnection()),this.audioLevelNode?(this.audioLevelNode.audioNode&&!this.audioLevelNode.audioNode.port.onmessage&&(this.audioLevelNode.logger.warn("Rebinding Audio Worklet Node"),this.audioLevelNode.bindAudioWorkletNode(this.audioLevelNode.audioNode)),this.audioLevelNode.getAudioLevel()):0}initAudioLevelNode(){this.audioLevelNode?this.logger.log("initAudioLevelNode: audioLevelNode Already Inited"):(this.audioLevelNode=new r.AudioLevelNode({logger:this.logger,context:this.context}),this.updateConnection())}hasWorkingMixin(){for(let e in this.mixins)if("MIX_PLAYING"===this.mixins[e].mixAudioConf.state)return!0;return!1}updateConnection(){var e,t,i,r,o,n;const d=this.getInputsInfo();let c=null;switch(d.cnt){case 0:this.output.directOutput=!0,this.output.stream.getTracks().length&&(this.output.stream.getTracks().forEach(e=>{this.output.stream.removeTrack(e)}),this.logger.log("updateConnection:NoInput"),this.output.stream.dispatchEvent(new Event("neTrackUpdated")),this.output.track=null),this.audioLevelNode&&this.audioLevelNode.disconnectFromAll();break;case 1:if(this.getEnabledStages().length||this.hasWorkingMixin()){this.output.destination||(this.logger.log("updateConnection: Creating output destination"),this.output.destination=new s.NeAudioNode("destination",this.context.createMediaStreamDestination())),this.output.track=this.output.destination.audioNode.stream.getTracks()[0],this.output.stream.getTracks()[0]!==this.output.track&&(this.output.stream.getTracks().forEach(e=>{var t;this.logger.log(`updateConnection: Updating output track ${e.label} => ${null===(t=this.output.track)||void 0===t?void 0:t.label}`),this.output.stream.removeTrack(e)}),this.output.stream.addTrack(this.output.track),this.output.stream.dispatchEvent(new Event("neTrackUpdated")));let e=!1;for(let t in this.mixins){const i=this.mixins[t];"MIX_PLAYING"===i.mixAudioConf.state?(i.mixAudioConf.replace&&(e=!0),i.node.isConnectedTo(this.output.destination)||(this.logger.log(`connect ${t} to destination`),i.node.connect(this.output.destination))):i.node.isConnectedTo(this.output.destination)&&i.node.disconnect(this.output.destination)}if(this.stages){let t=this.output.destination;for(let s=this.stages.length-1;s>=0;s--){const a=this.stages[s];a.enabled&&a.node?(c||(c=a.node),e&&t===this.output.destination?a.node.isConnectedTo(t)&&a.node.disconnect(t):a.node.isConnectedTo(t)||(a.node.disconnectToAll(),a.node.connect(t)),t=a.node):a.enabled||(null===(i=a.node)||void 0===i||i.disconnectToAll(),null===(r=a.node)||void 0===r||r.disconnectFromAll())}d.singleInput&&(d.singleInput.track&&(d.singleInput.node=a.getMediaStreamSourceNode(this.context,d.singleInput.track,d.singleInput===this.inputs.remote)),e&&t===this.output.destination?(null===(o=d.singleInput.node)||void 0===o?void 0:o.isConnectedTo(t))&&(null===(n=d.singleInput.node)||void 0===n||n.disconnect(t)):d.singleInput.node&&!d.singleInput.node.isConnectedTo(t)&&(d.singleInput.node.disconnectToAll(),d.singleInput.node.connect(t)))}}else this.output.directOutput=!0,(null===(e=d.singleInput)||void 0===e?void 0:e.track)&&(this.output.track=d.singleInput.track,this.output.stream.getTracks()[0]!==this.output.track&&(this.output.stream.getTracks().forEach(e=>{this.output.stream.removeTrack(e)}),this.output.stream.addTrack(this.output.track),this.logger.log("updateConnection: DIRECT",this.output.track.label),this.output.stream.dispatchEvent(new Event("neTrackUpdated"))),this.audioLevelNode&&(d.singleInput.node=a.getMediaStreamSourceNode(this.context,d.singleInput.track,d.singleInput===this.inputs.remote),c=d.singleInput.node)),(null===(t=d.singleInput)||void 0===t?void 0:t.node)&&d.singleInput.node.disconnectToAll()}this.audioLevelNode&&c&&(c.isConnectedTo(this.audioLevelNode)||(this.audioLevelNode.disconnectFromAll(),c.connect(this.audioLevelNode)))}getInputsInfo(){let e=0,t=null;return this.inputs.local.track&&(e++,t=this.inputs.local),this.inputs.remote.track&&(e++,t=this.inputs.remote),{cnt:e,singleInput:1===e?t:null}}registerPlugin(e,t,i){"AIDenoise"===e&&(this.stageAIProcessing.registerAIDenoisePlugin(t,i),this.pluginList.push("AIDenoise"))}unregisterPlugin(e){const t=this.pluginList.indexOf(e);-1!==t&&(this.pluginList.splice(t,1),this.stageAIProcessing.unregisterAIDenoise())}hasPlugin(e){return-1!==this.pluginList.indexOf(e)}async enableAIdenoise(e=!0){this.logger.log("Enabling AI Denoise",e),this.stageAIProcessing.enabled=e,"UNINIT"===this.stageAIProcessing.state&&await this.stageAIProcessing.init(),this.updateConnection()}}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.AudioLevelNode=void 0;const r=i(125),s=i(72),a=i(62);let o="NOTREADY",n=null;class d extends s.NeAudioNodeNullable{constructor(e){super("AudioLevelNode",null),this.volume=0,this.volumeTs=Date.now(),this.left=null,this.right=null,this.channelState="balance",this.stateChangeCnt=0,this.context=e.context,this.logger=e.logger.getChild(()=>{let e="AudioLevelNode#"+this.id;return e+="READY"!==o?" "+o:" "+this.channelState,this.stateChangeCnt&&(e+=" change"+this.stateChangeCnt),e}),this.initAudioWorklet()}async initAudioWorklet(){if(this.logger.log("AudioLevelNode initAudioWorklet"),!this.context.audioWorklet)return void this.logger.error("该环境不支持音频处理");n?"LOADING"===o&&await n:(o="LOADING",this.logger.log("正在载入音量模块"),n=this.context.audioWorklet.addModule(r.getBlobUrl("volumeProcessor")),await n,o="READY",this.logger.log("载入音量模块成功"));const e=new AudioWorkletNode(this.context,"vumeter");this.bindAudioWorkletNode(e);const t=a.getAudioLevelDestination();t&&e.connect(t),this.connectedFrom.forEach(e=>{e.connect(this)}),this.connectedTo.forEach(e=>{this.connect(e)})}bindAudioWorkletNode(e){this.audioNode=e,e.port.onmessage=t=>{var i,r;if(this.audioNode!==e)return;const s=Date.now(),a=Math.floor(s);if(t.data.volume>-1){if(this.volume=t.data.volume,this.volumeTs=s,t.data.left>-1)this.left||(this.left={volume:0,history:[]}),this.left.history.length&&this.left.history[0].sec===a||this.left.history.unshift({sec:a,sum:0}),this.left.volume=t.data.left,this.left.history[0].sum+=t.data.left,this.left.history.length>2&&this.left.history.pop();else{const e=this.channelState;this.channelState="mono",e!==this.channelState&&(this.stateChangeCnt++,this.stateChangeCnt<20&&this.logger.log(`声道状态变更 ${e} => ${this.channelState}`),this.emit("channel-state-change",{state:this.channelState,prev:e}))}if(t.data.right>-1&&(this.right||(this.right={volume:0,history:[]}),this.right.history.length&&this.right.history[0].sec===a||this.right.history.unshift({sec:a,sum:0}),this.right.volume=t.data.right,this.right.history[0].sum+=t.data.right,this.right.history.length>2&&this.right.history.pop()),(null===(i=this.left)||void 0===i?void 0:i.history[1])&&(null===(r=this.right)||void 0===r?void 0:r.history[1]))if(this.left.history[1].sum>4*this.right.history[1].sum){const e=this.channelState;this.channelState="leftLoud",e!==this.channelState&&(this.stateChangeCnt++,this.stateChangeCnt<20&&this.logger.log(`声道状态变更 ${e} => ${this.channelState}`),this.emit("channel-state-change",{state:this.channelState,prev:e}))}else if(this.right.history[1].sum>4*this.left.history[1].sum){const e=this.channelState;this.channelState="rightLoud",e!==this.channelState&&(this.stateChangeCnt++,this.stateChangeCnt<20&&this.logger.log(`声道状态变更 ${e} => ${this.channelState}`),this.emit("channel-state-change",{state:this.channelState,prev:e}))}else{if(this.left.history[1].sum>this.right.history[1].sum&&"leftLoud"!==this.channelState){const e=this.channelState;this.channelState="balance",e!==this.channelState&&(this.stateChangeCnt++,this.stateChangeCnt<20&&this.logger.log(`声道状态变更 ${e} => ${this.channelState}`),this.emit("channel-state-change",{state:this.channelState,prev:e}))}if(this.right.history[1].sum>this.left.history[1].sum&&"rightLoud"!==this.channelState){const e=this.channelState;this.channelState="balance",e!==this.channelState&&(this.stateChangeCnt++,this.stateChangeCnt<20&&this.logger.log(`声道状态变更 ${e} => ${this.channelState}`),this.emit("channel-state-change",{state:this.channelState,prev:e}))}}}else this.logger.error("Unsupported message",t.data)}}getAudioLevel(){var e,t;return Date.now()-this.volumeTs>1e3?{volume:0}:{volume:this.volume,left:null===(e=this.left)||void 0===e?void 0:e.volume,right:null===(t=this.right)||void 0===t?void 0:t.volume}}}t.AudioLevelNode=d},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.getMediaStreamSourceNode=void 0;const r=i(72),s=[];t.getMediaStreamSourceNode=function(e,t,i){const a=s.find(i=>i.ctx===e&&i.track===t);if(a){if(i){if(!a.audioElem){const e=document.createElement("audio");e.muted=!0,e.volume=0,e.autoplay=!0,e.controls=!0,a.audioElem=e}a.audioElem.srcObject=a.stream,a.audioElem.play().catch(e=>{})}return a.node}{const a=new MediaStream([t]),o=e.createMediaStreamSource(a),n=new r.NeAudioNode("MediaStreamSource",o);let d=null;i&&(d=document.createElement("audio"),d.muted=!0,d.volume=0,d.autoplay=!0,d.controls=!0,d.srcObject=a,d.play().catch(e=>{}));const c={track:t,stream:a,source:o,ctx:e,node:n,audioElem:d};return s.push(c),n}}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.StageInputVolume=void 0;const r=i(157),s=i(72);class a extends r.StageBase{constructor(e){super(e),this.type="stageInputVolume",this.node=null,this.volume=1}async init(){"UNINIT"===this.state&&(this.node=new s.NeAudioNode("gain",this.context.createGain()),this.state="INITED")}isTransparent(){return Math.abs(this.volume-1)<.01}setVolume(e){"UNINIT"===this.state&&this.init(),this.node&&e<=this.node.audioNode.gain.maxValue&&e>=this.node.audioNode.gain.minValue&&(this.node.audioNode.gain.value=e,this.volume=e)}}t.StageInputVolume=a},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.AudioWorkletAgent=void 0;const r=i(13),s=i(125),a=i(72);let o="NOTREADY",n=null;class d extends r.EventEmitter{constructor(e){super(),this.outputCnt=0,this.inputCnt=0,this.node=new a.NeAudioNodeNullable("AudioWorkletAgent",null),this.logger=e.logger.getChild(()=>{let e="AudioWorkletAgent";return"READY"!==o&&(e+=" "+o),e});const t=e.context;this.support={context:t}}async init(){this.support.audioWorkletNode?this.logger.error("Already Inited"):this.support.context.audioWorklet?(n?"LOADING"===o&&await n:(o="LOADING",this.logger.log("正在载入 audioWorkletAgentProcessor 模块"),n=this.support.context.audioWorklet.addModule(s.getBlobUrl("audioWorkletAgentProcessor")),await n,o="READY",this.logger.log("载入 audioWorkletAgentProcessor 模块成功")),this.support.audioWorkletNode=new AudioWorkletNode(this.support.context,"audioWorkletAgentProcessor"),this.node.updateNode(this.support.audioWorkletNode),this.bindProcessorEvents()):this.logger.error("该环境不支持音频处理")}outputData(e){if(!this.support.audioWorkletNode)throw new Error("Destroyed");this.inputCnt++,this.support.audioWorkletNode.port.postMessage({type:"outputData",data:e})}bindProcessorEvents(){this.removeAllListeners("rawinputs"),this.support.audioWorkletNode.port.onmessage=e=>{this.emit("processor-message",e),"rawinputs"===e.data.type?this.handleTypeRawInputs(e):"bufferDrop"===e.data.type?this.logger.warn(`音频处理程序刚刚丢弃了${5*e.data.cnt}ms的处理数据`):console.error("Unknown message",e)}}handleTypeRawInputs(e){this.outputCnt++,this.emit("rawinputs",e.data)}}t.AudioWorkletAgent=d},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.StageDelay=void 0;const r=i(157),s=i(72);class a extends r.StageBase{constructor(e){super(e),this.type="stageDelay",this.node=null,this.delayTime=1}async init(){"UNINIT"===this.state&&(this.node=new s.NeAudioNode("delay",this.context.createDelay(10)),this.state="INITED",this.node.audioNode.delayTime.value=this.delayTime)}isTransparent(){return this.delayTime<.01}setDelay(e){"UNINIT"===this.state&&this.init(),this.node&&(this.delayTime=e,this.node.audioNode.delayTime.value=e)}}t.StageDelay=a},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.AudioMix=void 0;const r=i(72),s=i(66),a=i(156);class o extends s.RTCEventEmitter{constructor(e){super(),this.pipeline=e,this.context=e.context;const t=new r.NeAudioNode("AudioMixingGain",this.context.createGain());this.node=t,this.mixAudioConf={audioFilePath:"",state:"MIX_UNSTART",buffer:null,cachedBuffers:{},audioSource:null,gainFilter:t,replace:!1,loopback:!1,cycle:0,pauseTime:0,startTime:0,totalTime:0,volume:1,playStartTime:0,setPlayStartTime:0,auidoMixingEnd:null},this.logger=e.logger.getChild(()=>"AudioMix "+this.mixAudioConf.state)}async startAudioMixing(e){if((null==e?void 0:e.audioFilePath)?this.logger.log("即将开始伴音:",JSON.stringify(e,null," ")):this.logger.error("startAudioMixing:未指定伴音文件"),Object.assign(this.mixAudioConf,e),this.mixAudioConf.audioFilePath){if(this.mixAudioConf.cachedBuffers[this.mixAudioConf.audioFilePath])return this.mixAudioConf.buffer=this.mixAudioConf.cachedBuffers[this.mixAudioConf.audioFilePath],this.logger.log("即将从缓存播放伴音",this.mixAudioConf.audioFilePath),this.startMix();{this.logger.log("即将加载云端音乐",this.mixAudioConf.audioFilePath),this.mixAudioConf.state="MIX_STARTING";const e=await this.loadAudioBuffer(this.mixAudioConf.audioFilePath);if("MIX_STARTING"===this.mixAudioConf.state)return this.mixAudioConf.buffer=e,this.startMix();this.logger.warn("startAudioMixing: 播放行为被覆盖")}}}stopAudioMixing(e=!1){return this.mixAudioConf.audioSource?(this.logger.log("即将停止混音"),this.mixAudioConf.audioSource.audioNode.onended=null,this.mixAudioConf.audioSource.disconnect(this.mixAudioConf.gainFilter),this.mixAudioConf.audioSource.audioNode.stop(),this.mixAudioConf.audioSource=null):this.logger.warn("stopAudioMixing:当前没有在混音"),this.mixAudioConf.startTime=0,this.mixAudioConf.pauseTime=0,this.mixAudioConf.playStartTime=0,e&&this.resetMixConf(),this.mixAudioConf.state="MIX_STOPED",this.pipeline.updateConnection(),this.logger.log("混音已停止"),Promise.resolve()}pauseAudioMixing(){if(!this.mixAudioConf.audioSource)return void this.logger.error("pauseAudioMixing:参数不够");this.logger.log("暂停混音"),this.mixAudioConf.audioSource.audioNode.onended=null,this.mixAudioConf.audioSource.disconnect(this.mixAudioConf.gainFilter),this.mixAudioConf.audioSource.audioNode.stop(),this.mixAudioConf.audioSource.disconnectToAll(),this.mixAudioConf.audioSource=null,this.mixAudioConf.pauseTime=Date.now(),this.mixAudioConf.state="MIX_PAUSED";let e=(this.mixAudioConf.pauseTime-this.mixAudioConf.startTime)/1e3+this.mixAudioConf.playStartTime;return this.logger.log("已经播放的时间: ",e),e>this.mixAudioConf.totalTime&&(e%=this.mixAudioConf.totalTime),this.logger.log("暂停位置:",e),Promise.resolve()}resumeAudioMixing(){let e,t=(this.mixAudioConf.pauseTime-this.mixAudioConf.startTime)/1e3+this.mixAudioConf.playStartTime;return t>this.mixAudioConf.totalTime&&(this.logger.log("播放过的圈数 playedCycle: ",Math.floor(t/this.mixAudioConf.totalTime)),this.mixAudioConf.cycle=this.mixAudioConf.cycle-Math.floor(t/this.mixAudioConf.totalTime)),this.mixAudioConf.setPlayStartTime?(this.logger.log("暂停期间，用户设置混音播发时间: ",this.mixAudioConf.setPlayStartTime),e=this.mixAudioConf.setPlayStartTime,this.mixAudioConf.setPlayStartTime=0):(this.logger.log("恢复混音:",this.mixAudioConf),this.logger.log("已经播放的时间: ",t),t>this.mixAudioConf.totalTime&&(t%=this.mixAudioConf.totalTime),e=t),this.logger.log("回复重置的时间点：",e),this.mixAudioConf.playStartTime=e,this.startMix()}setAudioMixingVolume(e){if(e<=255&&e>=0){const t=e/255;this.logger.log(`setAudioMixingVolume ${this.mixAudioConf.gainFilter.audioNode.gain.value} => ${t}`),this.mixAudioConf.gainFilter.audioNode.gain.value=e/255,this.mixAudioConf.volume=this.mixAudioConf.gainFilter.audioNode.gain.value}else this.logger.error("setAudioMixingVolume: volume不在0~255范围内：",e)}getAudioMixingPlayedTime(){let e=Date.now();"MIX_PAUSED"==this.mixAudioConf.state&&this.mixAudioConf.pauseTime&&(this.logger.log("当前是暂停状态"),e=this.mixAudioConf.pauseTime);let t=(e-this.mixAudioConf.startTime)/1e3+this.mixAudioConf.playStartTime;return t>this.mixAudioConf.totalTime&&(t%=this.mixAudioConf.totalTime),{playedTime:t}}getAudioMixingTotalTime(){return{totalTime:this.mixAudioConf.totalTime}}startMix(){if(this.logger.log("startMix: ",this.mixAudioConf),this.mixAudioConf.buffer){if(this.mixAudioConf.audioSource&&this.mixAudioConf.audioSource.disconnectToAll(),this.mixAudioConf.audioSource=new r.NeAudioNode("AudioMixBufferSource",this.pipeline.context.createBufferSource()),this.mixAudioConf.audioSource.audioNode.buffer=this.mixAudioConf.buffer,this.mixAudioConf.audioSource.connect(this.mixAudioConf.gainFilter),this.mixAudioConf.audioSource.audioNode.onended=e=>{this.audioEnd(e)},this.mixAudioConf.totalTime=this.mixAudioConf.buffer.duration,(this.mixAudioConf.playStartTime<0||this.mixAudioConf.playStartTime>=this.mixAudioConf.totalTime)&&(this.mixAudioConf.playStartTime=0),this.logger.log("设置音量:",this.mixAudioConf.volume),this.mixAudioConf.gainFilter.audioNode.gain.value=this.mixAudioConf.volume,this.mixAudioConf.loopback&&this.mixAudioConf.cycle>1){this.mixAudioConf.audioSource.audioNode.loop=this.mixAudioConf.loopback;const e=this.mixAudioConf.cycle*this.mixAudioConf.totalTime-this.mixAudioConf.playStartTime;this.logger.log("循环播放: options.playStartTime: ",this.mixAudioConf.playStartTime),this.logger.log("循环播放: totalTime: ",e),this.mixAudioConf.audioSource.audioNode.start(0,this.mixAudioConf.playStartTime,e-1)}else this.mixAudioConf.loopback&&1==this.mixAudioConf.cycle?(this.mixAudioConf.audioSource.audioNode.loop=!1,this.mixAudioConf.audioSource.audioNode.start(0,this.mixAudioConf.playStartTime)):(this.logger.log("无限循环播放 loop: ",this.mixAudioConf.loopback),this.mixAudioConf.audioSource.audioNode.loop=this.mixAudioConf.loopback,this.mixAudioConf.audioSource.audioNode.start(0,this.mixAudioConf.playStartTime));return this.mixAudioConf.state="MIX_PLAYING",this.mixAudioConf.startTime=Date.now(),this.pipeline.updateConnection(),Promise.resolve()}this.logger.error("startMix: 缺少 mixAudioConf.buffer")}audioEnd(e){return"MIX_PLAYING"!==this.mixAudioConf.state?void this.logger.error("audioEnd:状态不对"):this.mixAudioConf.audioSource&&this.mixAudioConf.audioSource.audioNode.loop&&this.mixAudioConf.cycle<=0?void this.logger.log("无限循环时，伴音播放完成event: ",e):(this.logger.log("伴音播放完成: ",this.mixAudioConf),this.mixAudioConf.audioSource&&(this.mixAudioConf.audioSource.audioNode.onended=null),this.mixAudioConf.auidoMixingEnd&&(this.mixAudioConf.auidoMixingEnd(e),this.mixAudioConf.auidoMixingEnd=null),this.resetMixConf(),this.pipeline.updateConnection(),Promise.resolve())}async loadAudioBuffer(e){let t,i;this.mixAudioConf.cachedBuffers[e]?this.logger.warn(`loadAudioBuffer: 该文件已有缓存，长度：${this.mixAudioConf.cachedBuffers[e].duration} 秒。即将更新该文件地址：${e}`):this.logger.warn("loadAudioBuffer: 开始加载文件。地址："+e);try{t=await a.ajax({url:e,type:"GET",dataType:"arraybuffer"})}catch(e){throw this.logger.error("loadAudioBuffer 加载云端音乐失败: ",e),e}this.logger.log(`loadAudioBuffer 文件下载成功。大小：${Math.floor(t.byteLength/1024)} KB`);try{i=await this.pipeline.context.decodeAudioData(t)}catch(e){throw this.logger.log("loadAudioBuffer 解码失败:",e),e}return this.logger.log(`loadAudioBuffer 解码成功。长度：${i.duration} 秒。`),this.mixAudioConf.cachedBuffers[e]=i,i}resetMixConf(){this.mixAudioConf.audioSource&&(this.mixAudioConf.audioSource.disconnect(this.mixAudioConf.gainFilter),this.mixAudioConf.audioSource=null),this.mixAudioConf.audioFilePath="",this.mixAudioConf.buffer=null,this.mixAudioConf.state="MIX_UNSTART",this.mixAudioConf.replace=!1,this.mixAudioConf.cycle=0,this.mixAudioConf.pauseTime=0,this.mixAudioConf.startTime=0,this.mixAudioConf.totalTime=0,this.mixAudioConf.volume=1,this.mixAudioConf.playStartTime=0,this.mixAudioConf.setPlayStartTime=0,this.mixAudioConf.auidoMixingEnd=null,this.emit("audioFilePlaybackCompleted")}}t.AudioMix=o},function(e,t,i){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.createCanvasWatermarkControl=t.CanvasWatermarkControl=void 0;const s=r(i(193)),a=i(13),o=i(69),n=i(194);class d extends a.EventEmitter{constructor(e){super(),this.logger=e,this.settings={defaultStyle:{background:"rgba(128,128,128, 0.5)",overflow:"hidden","white-space":"break-spaces",position:"absolute",wordBreak:"break-all",color:"white",fontSize:"10pt"}},this.watermarks=[],this.div=null}checkWatermarkParams(e){e.textWatermarks&&e.textWatermarks.forEach(e=>{const t={tag:"Stream.setCanvasWatermarkConfigs:textWatermarks.fontSize",value:e.fontSize,min:1};o.isExistOptions(t).result&&o.checkValidInteger(t);const i={tag:"Stream.setCanvasWatermarkConfigs:textWatermarks.fontColor",value:e.fontColor,min:0};o.isExistOptions(i).result&&o.checkValidInteger(i);const r={tag:"Stream.setCanvasWatermarkConfigs:textWatermarks.wmWidth",value:e.wmWidth,min:0};o.isExistOptions(r).result&&o.checkValidInteger(r);const s={tag:"Stream.setCanvasWatermarkConfigs:textWatermarks.wmHeight",value:e.wmHeight,min:0};o.isExistOptions(s).result&&o.checkValidInteger(s);const a={tag:"Stream.setCanvasWatermarkConfigs:textWatermarks.offsetX",value:e.offsetX};o.isExistOptions(a).result&&o.checkValidInteger(a);const n={tag:"Stream.setCanvasWatermarkConfigs:textWatermarks.offsetY",value:e.offsetY};o.isExistOptions(n).result&&o.checkValidInteger(n)}),e.timestampWatermarks&&[e.timestampWatermarks].forEach(e=>{const t={tag:"Stream.setCanvasWatermarkConfigs:timestampWatermarks.fontSize",value:e.fontSize,min:1};o.isExistOptions(t).result&&o.checkValidInteger(t);const i={tag:"Stream.setCanvasWatermarkConfigs:timestampWatermarks.fontColor",value:e.fontColor,min:0};o.isExistOptions(i).result&&o.checkValidInteger(i);const r={tag:"Stream.setCanvasWatermarkConfigs:timestampWatermarks.wmWidth",value:e.wmWidth,min:0};o.isExistOptions(r).result&&o.checkValidInteger(r);const s={tag:"Stream.setCanvasWatermarkConfigs:timestampWatermarks.wmHeight",value:e.wmHeight,min:0};o.isExistOptions(s).result&&o.checkValidInteger(s);const a={tag:"Stream.setCanvasWatermarkConfigs:timestampWatermarks.offsetX",value:e.offsetX};o.isExistOptions(a).result&&o.checkValidInteger(a);const n={tag:"Stream.setCanvasWatermarkConfigs:timestampWatermarks.offsetY",value:e.offsetY};o.isExistOptions(n).result&&o.checkValidInteger(n)}),e.imageWatermarks&&e.imageWatermarks.forEach(e=>{const t={tag:"Stream.setCanvasWatermarkConfigs.imageWatermarks.wmWidth",value:e.wmWidth,min:0};o.isExistOptions(t).result&&o.checkValidInteger(t);const i={tag:"Stream.setCanvasWatermarkConfigs:imageWatermarks.wmHeight",value:e.wmHeight,min:0};o.isExistOptions(i).result&&o.checkValidInteger(i);const r={tag:"Stream.setCanvasWatermarkConfigs:imageWatermarks.offsetX",value:e.offsetX};o.isExistOptions(r).result&&o.checkValidInteger(r);const s={tag:"Stream.setCanvasWatermarkConfigs:imageWatermarks.offsetY",value:e.offsetY};o.isExistOptions(s).result&&o.checkValidInteger(s);const a={tag:"Stream.setCanvasWatermarkConfigs:imageWatermarks.imageUrls",value:e.imageUrls};o.checkExists(a);const n={tag:"Stream.setCanvasWatermarkConfigs:imageWatermarks.imageUrls.length",value:e.imageUrls.length,min:1};o.checkValidInteger(n);const d={tag:"Stream.setCanvasWatermarkConfigs:imageWatermarks.fps",value:e.fps,min:0};o.isExistOptions(d).result&&o.checkValidFloat(d)})}updateWatermarks(e){this.clear(),this.watermarks=[];const t={text:0,timestamp:0,image:0};e.imageWatermarks&&e.imageWatermarks.forEach(e=>{const t=Object.assign({},this.settings.defaultStyle,{background:"none"});let i;"number"==typeof e.offsetX?t.left=e.offsetX+"px":e.offsetX&&"string"==typeof e.offsetX&&(t.left=e.offsetX),"number"==typeof e.offsetY?t.top=e.offsetY+"px":e.offsetY&&"string"==typeof e.offsetY&&(t.top=e.offsetY),0!==e.wmWidth&&0!==e.wmHeight||(delete e.wmWidth,delete e.wmHeight),e.wmWidth&&("number"==typeof e.wmWidth?t.width=e.wmWidth+"px":"string"==typeof e.wmWidth&&(t.width=e.wmWidth)),e.wmHeight&&("number"==typeof e.wmHeight?t.height=e.wmHeight+"px":"string"==typeof e.wmHeight&&(t.height=e.wmHeight)),"number"==typeof e.wmHeight?t.height=e.wmHeight+"px":e.wmHeight&&"string"==typeof e.wmHeight&&(t.height=e.wmHeight),i=e.fps?{type:"image",content:"",imageUrls:e.imageUrls,loop:!(!1===e.loop),loopIndex:0,interval:1e3/(e.fps||1),elem:null,style:t}:{type:"image",content:"",imageUrls:[e.imageUrls[e.imageUrls.length-1]],loop:!1,loopIndex:0,interval:0,elem:null,style:t},this.watermarks.push(i)}),e.textWatermarks&&e.textWatermarks.forEach(e=>{let i=e.content||"";t.text++;const r=Object.assign({},this.settings.defaultStyle);"number"==typeof e.fontColor?r.color=n.numberToRGBA(e.fontColor):e.fontColor&&"string"==typeof e.fontColor&&(r.color=e.fontColor),"number"==typeof e.fontSize?r.fontSize=e.fontSize+"pt":e.fontSize&&"string"==typeof e.fontSize&&(r.fontSize=e.fontSize),"number"==typeof e.offsetX?r.left=e.offsetX+"px":e.offsetX&&"string"==typeof e.offsetX&&(r.left=e.offsetX),"number"==typeof e.offsetY?r.top=e.offsetY+"px":e.offsetY&&"string"==typeof e.offsetY&&(r.top=e.offsetY),!e.wmWidth&&!e.wmHeight||0===e.wmWidth||0===e.wmHeight?r.background="":"number"==typeof e.wmColor?r.background=n.numberToRGBA(e.wmColor):e.wmColor&&"string"==typeof e.wmColor&&(r.background=e.wmColor),e.wmWidth,"number"==typeof e.wmWidth?e.wmWidth>0&&(r.width=e.wmWidth+"px"):"string"==typeof e.wmWidth&&(r.width=e.wmWidth),e.wmHeight&&("number"==typeof e.wmHeight?(e.wmHeight>0&&(r.wmHeight=e.wmWidth+"px"),r.height=e.wmHeight+"px"):"string"==typeof e.wmHeight&&(r.height=e.wmHeight));const s={type:"text",content:i,loop:!1,elem:null,loopIndex:0,style:r};this.watermarks.push(s)}),e.timestampWatermarks&&[e.timestampWatermarks].forEach(e=>{t.timestamp++;const i=Object.assign({},this.settings.defaultStyle);"number"==typeof e.fontColor?i.color=n.numberToRGBA(e.fontColor):e.fontColor&&"string"==typeof e.fontColor&&(i.color=e.fontColor),"number"==typeof e.fontSize?i.fontSize=e.fontSize+"pt":e.fontSize&&"string"==typeof e.fontSize&&(i.fontSize=e.fontSize),"number"==typeof e.offsetX?i.left=e.offsetX+"px":e.offsetX&&"string"==typeof e.offsetX&&(i.left=e.offsetX),"number"==typeof e.offsetY?i.top=e.offsetY+"px":e.offsetY&&"string"==typeof e.offsetY&&(i.top=e.offsetY),!e.wmWidth&&!e.wmHeight||0===e.wmWidth||0===e.wmHeight?i.background="":"number"==typeof e.wmColor?i.background=n.numberToRGBA(e.wmColor):e.wmColor&&"string"==typeof e.wmColor&&(i.background=e.wmColor),e.wmWidth&&("number"==typeof e.wmWidth?i.width=e.wmWidth+"px":"string"==typeof e.wmWidth&&(i.width=e.wmWidth)),e.wmHeight&&("number"==typeof e.wmHeight?i.height=e.wmHeight+"px":"string"==typeof e.wmHeight&&(i.height=e.wmHeight));const r={type:"timestamp",content:"yyyy-mm-dd HH:MM:ss",loop:!1,loopIndex:0,elem:null,style:i};this.watermarks.push(r)}),this.div&&this.start(this.div)}start(e){this.clear(),this.div=e,this.watermarks.forEach(t=>{let i;switch(t.type){case"text":i=document.createElement("pre"),i.className="nim-watermark nim-watermark-text",i.innerText=t.content||"",Object.assign(i.style,t.style);break;case"timestamp":i=document.createElement("pre"),i.className="nim-watermark nim-watermark-timestamp",i.innerText="",Object.assign(i.style,t.style);break;case"image":!t.imageUrls&&t.content&&(t.imageUrls=[t.content]),i=document.createElement("div"),i.className="nim-watermark nim-watermark-image-container",t.imgElems=[],t.imageUrls&&t.imageUrls.length&&t.imageUrls.forEach((e,r)=>{const s=document.createElement("img");s.className="nim-watermark nim-watermark-image nim-watermark-image-"+r,s.src=e,s.style.width="100%",t.style.height&&(s.style.height="100%"),s.style.overflow="hidden",t.imgElems&&t.imgElems.push(s),i.appendChild(s),r>0&&(s.style.display="none")}),t.loopIndex=-1;const e=()=>{if(!t.interval&&t.imgElems&&t.loopIndex>=0)t.imgElems[t.loopIndex].style.display="";else{if(t.imgElems&&t.imgElems[t.loopIndex]&&(t.imgElems[t.loopIndex].style.display="none"),t.loopIndex++,t.imgElems&&t.loopIndex>=t.imgElems.length){if(!t.loop)return void(t.loopTimer&&clearInterval(t.loopTimer));t.loopIndex=0}t.imgElems&&(t.imgElems[t.loopIndex].style.display="")}};e(),t.interval&&(t.loopTimer=setInterval(e,t.interval)),Object.assign(i.style,t.style)}t.elem=i,e.appendChild(t.elem)})}clear(){this.div&&this.watermarks.forEach(e=>{e.elem&&(e.elem.remove(),e.elem=null),e.loopTimer&&clearTimeout(e.loopTimer)})}}t.CanvasWatermarkControl=d;const c=new class{constructor(){this.controls=[],this.timer=setInterval(()=>{this.updateTimestamps()},1e3)}updateTimestamps(){this.controls.forEach(e=>{e.watermarks.filter(e=>"timestamp"===e.type).forEach(e=>{e.elem&&(e.elem.innerText=s.default(new Date,e.content||"yyyy-mm-dd HH:MM:ss"))})})}};t.createCanvasWatermarkControl=function(e){const t=new d(e);return c.controls.push(t),t}},function(e,t,i){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.createEncoderWatermarkControl=t.EncoderWatermarkControl=void 0;const s=r(i(193)),a=i(13),o=i(69),n=i(5),d=i(194);class c extends a.EventEmitter{constructor(e){super(),this.logger=e,this.settings={defaultStyle:{left:0,top:0,textWidth:0,textHeight:0,fontSize:"15pt",fontFamily:n.getParameters().encoderWatermarkFontFamily,fillStyle:"white",textBaseline:"hanging",bgWidth:-1,bgHeight:-1,bgFillStyle:"rgba(136, 136, 136, 0.5)"}},this.watermarks=[],this.handler={name:"watermark",enabled:!1,func:this.handleFrame.bind(this)}}handleFrame(e,t,i){this.watermarks.forEach(e=>{if("text"===e.type||"timestamp"===e.type){let t="";t="timestamp"===e.type?s.default(new Date,e.content||"yyyy-mm-dd HH:MM:ss"):e.content||"",i.canvasCtx.font=`${e.style.fontSize} ${e.style.fontFamily}`,i.canvasCtx.textBaseline=e.style.textBaseline;e.content;-1===e.style.bgWidth&&-1===e.style.bgHeight&&(e.style.bgWidth=e.style.textWidth,e.style.bgHeight=e.style.textHeight),e.style.bgWidth&&e.style.bgHeight&&(i.canvasCtx.fillStyle=e.style.bgFillStyle,i.canvasCtx.fillRect(e.style.left,e.style.top,e.style.bgWidth,e.style.bgHeight)),i.canvasCtx.fillStyle=e.style.fillStyle,i.canvasCtx.fillText(t,e.style.left,e.style.top)}if("image"===e.type&&e.imgElems){let t=void 0;if(e.interval){if(e.startMs&&e.interval){const i=Date.now()-e.startMs,r=Math.floor(i/e.interval);for(let i=r;i<r+e.imgElems.length;i++){const r=e.imgElems[e.loop?i%e.imgElems.length:i];if(r&&r.complete&&r.naturalWidth&&r.naturalHeight){t=r;break}}}}else e.imgElems[0].complete&&e.imgElems[0].naturalWidth&&e.imgElems[0].naturalHeight&&(t=e.imgElems[0]);if(t){let r,s;e.style.bgWidth>0&&e.style.bgHeight>0?(r=e.style.bgWidth,s=e.style.bgHeight):(r=t.naturalWidth,s=t.naturalHeight),i.canvasCtx.drawImage(t,e.style.left,e.style.top,r,s)}}})}checkWatermarkParams(e){var t,i;const r={tag:"Stream.setEncoderWatermarkConfigs:watermarks.count",value:((null===(t=e.textWatermarks)||void 0===t?void 0:t.length)||0)+(e.timestampWatermarks?1:0)+((null===(i=e.imageWatermarks)||void 0===i?void 0:i.length)||0),max:n.getParameters().encoderWatermarkLimit};o.checkValidInteger(r),e.textWatermarks&&e.textWatermarks.forEach(e=>{const t={tag:"Stream.setEncoderWatermarkConfigs:textWatermarks.fontSize",value:e.fontSize,min:1,max:128};o.isExistOptions(t).result&&o.checkValidInteger(t);const i={tag:"Stream.setEncoderWatermarkConfigs:textWatermarks.fontColor",value:e.fontColor,min:0,max:4294967295};o.isExistOptions(i).result&&o.checkValidInteger(i);const r={tag:"Stream.setEncoderWatermarkConfigs:textWatermarks.wmWidth",value:e.wmWidth,min:0};o.isExistOptions(r).result&&o.checkValidInteger(r);const s={tag:"Stream.setEncoderWatermarkConfigs:textWatermarks.wmHeight",value:e.wmHeight,min:0};o.isExistOptions(s).result&&o.checkValidInteger(s);const a={tag:"Stream.setEncoderWatermarkConfigs:textWatermarks.offsetX",value:e.offsetX};o.isExistOptions(a).result&&o.checkValidInteger(a);const n={tag:"Stream.setEncoderWatermarkConfigs:textWatermarks.offsetY",value:e.offsetY};o.isExistOptions(n).result&&o.checkValidInteger(n)}),e.timestampWatermarks&&[e.timestampWatermarks].forEach(e=>{const t={tag:"Stream.setEncoderWatermarkConfigs:timestampWatermarks.fontSize",value:e.fontSize,min:1,max:128};o.isExistOptions(t).result&&o.checkValidInteger(t);const i={tag:"Stream.setEncoderWatermarkConfigs:timestampWatermarks.fontColor",value:e.fontColor,min:0,max:4294967295};o.isExistOptions(i).result&&o.checkValidInteger(i);const r={tag:"Stream.setEncoderWatermarkConfigs:timestampWatermarks.wmWidth",value:e.wmWidth,min:0};o.isExistOptions(r).result&&o.checkValidInteger(r);const s={tag:"Stream.setEncoderWatermarkConfigs:timestampWatermarks.wmHeight",value:e.wmHeight,min:0};o.isExistOptions(s).result&&o.checkValidInteger(s);const a={tag:"Stream.setEncoderWatermarkConfigs:timestampWatermarks.offsetX",value:e.offsetX};o.isExistOptions(a).result&&o.checkValidInteger(a);const n={tag:"Stream.setEncoderWatermarkConfigs:timestampWatermarks.offsetY",value:e.offsetY};o.isExistOptions(n).result&&o.checkValidInteger(n)}),e.imageWatermarks&&e.imageWatermarks.forEach(e=>{const t={tag:"Stream.setEncoderWatermarkConfigs.imageWatermarks.wmWidth",value:e.wmWidth,min:0};o.isExistOptions(t).result&&o.checkValidInteger(t);const i={tag:"Stream.setEncoderWatermarkConfigs:imageWatermarks.wmHeight",value:e.wmHeight,min:0};o.isExistOptions(i).result&&o.checkValidInteger(i);const r={tag:"Stream.setEncoderWatermarkConfigs:imageWatermarks.offsetX",value:e.offsetX};o.isExistOptions(r).result&&o.checkValidInteger(r);const s={tag:"Stream.setEncoderWatermarkConfigs:imageWatermarks.offsetY",value:e.offsetY};o.isExistOptions(s).result&&o.checkValidInteger(s);const a={tag:"Stream.setEncoderWatermarkConfigs:imageWatermarks.imageUrls",value:e.imageUrls};o.checkExists(a);const n={tag:"Stream.setEncoderWatermarkConfigs:imageWatermarks.imageUrls.length",value:e.imageUrls.length,min:1,max:10};o.checkValidInteger(n);const d={tag:"Stream.setEncoderWatermarkConfigs:imageWatermarks.fps",value:e.fps,min:0,max:30};o.isExistOptions(d).result&&o.checkValidFloat(d)})}updateWatermarks(e){this.watermarks=[];const t={text:0,timestamp:0,image:0};e.imageWatermarks&&e.imageWatermarks.forEach(e=>{const t=Object.assign({},this.settings.defaultStyle,{background:"none"});let i;if("number"==typeof e.offsetX?t.left=e.offsetX:e.offsetX,"number"==typeof e.offsetY?t.top=e.offsetY:e.offsetY,0!==e.wmWidth&&0!==e.wmHeight||(delete e.wmWidth,delete e.wmHeight),e.wmWidth&&"number"==typeof e.wmWidth&&(t.bgWidth=e.wmWidth),e.wmHeight&&"number"==typeof e.wmHeight&&(t.bgHeight=e.wmHeight),!1!==e.loop&&(e.loop=!0),i=e.fps?{type:"image",content:"",imageUrls:e.imageUrls,loop:!(!1===e.loop),loopIndex:0,interval:1e3/(e.fps||1),style:t}:{type:"image",content:"",imageUrls:[e.imageUrls[e.imageUrls.length-1]],loop:!1,loopIndex:0,interval:0,style:t},i.startMs=Date.now(),i.imgElems=[],i.imageUrls)for(let e=0;e<i.imageUrls.length;e++){const t=new Image;t.src=i.imageUrls[e],i.imgElems.push(t)}this.watermarks.push(i)}),e.textWatermarks&&e.textWatermarks.forEach(e=>{let i=e.content||"";t.text++;const r=Object.assign({},this.settings.defaultStyle);"number"==typeof e.fontColor?r.fillStyle=d.numberToRGBA(e.fontColor):e.fontColor&&"string"==typeof e.fontColor&&(r.fillStyle=e.fontColor),"number"==typeof e.fontSize?r.fontSize=e.fontSize+"pt":e.fontSize&&"string"==typeof e.fontSize&&(r.fontSize=e.fontSize);const s=d.measureText(e.content,r.fontSize,r.fontFamily);r.textWidth=s.width,r.textHeight=s.height,e.offsetX&&(r.left=e.offsetX),e.offsetY&&(r.top=e.offsetY),e.wmColor,e.wmWidth>=0&&(r.bgWidth=e.wmWidth),e.wmHeight>=0&&(r.bgHeight=e.wmHeight),"number"==typeof e.wmColor?r.bgFillStyle=d.numberToRGBA(e.wmColor):e.wmColor&&"string"==typeof e.wmColor&&(r.bgFillStyle=e.wmColor);const a={type:"text",content:i,loop:!1,loopIndex:0,style:r};this.watermarks.push(a)}),e.timestampWatermarks&&[e.timestampWatermarks].forEach(e=>{t.timestamp++;const i=Object.assign({},this.settings.defaultStyle);"number"==typeof e.fontColor?i.fillStyle=d.numberToRGBA(e.fontColor):e.fontColor&&"string"==typeof e.fontColor&&(i.fillStyle=e.fontColor),"number"==typeof e.fontSize?i.fontSize=e.fontSize+"pt":e.fontSize&&"string"==typeof e.fontSize&&(i.fontSize=e.fontSize);const r=d.measureText("yyyy-mm-dd HH:MM:ss",i.fontSize,i.fontFamily);i.textWidth=r.width,i.textHeight=r.height,e.offsetX&&(i.left=e.offsetX),e.offsetY&&(i.top=e.offsetY),e.wmWidth>=0&&(i.bgWidth=e.wmWidth),e.wmHeight>=0&&(i.bgHeight=e.wmHeight),"number"==typeof e.wmColor?i.bgFillStyle=d.numberToRGBA(e.wmColor):e.wmColor&&"string"===e.wmColor&&(i.bgFillStyle=e.wmColor);const s={type:"timestamp",content:"yyyy-mm-dd HH:MM:ss",loop:!1,loopIndex:0,style:i};this.watermarks.push(s)})}}t.EncoderWatermarkControl=c,t.createEncoderWatermarkControl=function(e){return new c(e)}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.playMedia=void 0,t.playMedia=function(e,t){return new Promise((i,r)=>{let s=setTimeout(()=>{s&&(s=null,i())},t);const a=e.play();a.then(()=>{s&&(clearTimeout(s),s=null,i())}),a.catch(e=>{s&&(clearTimeout(s),s=null,r(e))})})}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.parseBase64=void 0;const r=i(284);let s;t.parseBase64=function(e){var t=e.length,i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";if(!s){s=[];for(var a=0;a<i.length;a++)s[i.charCodeAt(a)]=a}var o=i.charAt(64);if(o){var n=e.indexOf(o);-1!==n&&(t=n)}return function(e,t,i){for(var s=[],a=0,o=0;o<t;o++)if(o%4){var n=i[e.charCodeAt(o-1)]<<o%4*2,d=i[e.charCodeAt(o)]>>>6-o%4*2,c=n|d;s[a>>>2]|=c<<24-a%4*8,a++}return new r.WordArray(s,a)}(e,t,s)}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.WordArray=t.Hex=void 0,t.Hex={stringify(e){for(var t=e.words,i=e.sigBytes,r=[],s=0;s<i;s++){var a=t[s>>>2]>>>24-s%4*8&255;r.push((a>>>4).toString(16)),r.push((15&a).toString(16))}return r.join("")}};t.WordArray=class{constructor(e,t){e=this.words=e||[],this.sigBytes=null!=t?t:4*e.length}toString(e){return(e||t.Hex).stringify(this)}concat(e){var t=this.words,i=e.words,r=this.sigBytes,s=e.sigBytes;if(this.clamp(),r%4)for(var a=0;a<s;a++){var o=i[a>>>2]>>>24-a%4*8&255;t[r+a>>>2]|=o<<24-(r+a)%4*8}else for(var n=0;n<s;n+=4)t[r+n>>>2]=i[n>>>2];return this.sigBytes+=s,this}clamp(){var e=this.words,t=this.sigBytes;e[t>>>2]&=4294967295<<32-t%4*8,e.length=Math.ceil(t/4)}}},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.RTSTransport=void 0;const n=i(13),d=o(i(11)),c=o(i(12)),l=a(i(2));class u extends n.EventEmitter{constructor(e){super(),this._reset(),this.adapterRef=e.adapterRef,this._url=e.url,this._port=e.port,this._transportId=e.transportId,this._ws=null,this.initSocket()}get transportId(){return this._transportId}_reset(){this._url="",this._port=0,this._ws=null}initSocket(){if(this.adapterRef.logger.log("RTSTransport建立连接, url: ",this._url),!this._url){let e="initSocket: url of RTSTransport is not found",t="initSocket: RTSTransport 的 url 未找到",i="Please input the correct url",r="请输入正确的 url",s=l.IS_ZH?t:e,a=l.IS_ZH?r:i;throw new c.default({code:d.default.SOCKET_INIT_ERROR,message:s,advice:a})}this._ws=new WebSocket(this._url,["protoo"]),this._ws.binaryType="arraybuffer";const e=this._ws;e.onopen=this._onOpen.bind(this),e.onmessage=this._onMessage.bind(this),e.onclose=this._onClose.bind(this),e.onerror=this._onError.bind(this)}_onOpen(e){this.adapterRef.logger.log("RTSTransport:_onOpen"),this.emit("open",e)}_onMessage(e){this.adapterRef.instance.emit("rts-stream-data",e)}_onClose(e){this.adapterRef.logger.log("RTSTransport:onClose <- ",e),this.emit("close",e)}_onError(e){this.adapterRef.logger.log("RTSTransport:onError <- ",e),this.emit("error",e)}send(e){this._ws&&this._ws.readyState===WebSocket.OPEN?this._ws.send(JSON.stringify(e)):this.adapterRef.logger.log("RTSTransport:send: 当前不能发送，等待ws连接成功之后发送")}_close(){this.adapterRef.logger.log("RTSTransport:close"),this._ws&&(this._ws.onclose=null,this._ws.onerror=null,this._ws.onopen=null,this._ws.onmessage=null,this._ws.close(),this._ws=null)}destroy(){this.adapterRef.logger.log("WSTransport:destroy"),this._close(),this._url=null}}t.RTSTransport=u},function(e,t,i){var r=i(287),s=i(289);t.Peer=r,t.WebSocketTransport=s},function(e,t,i){var r=a(i(59)),s=a(i(60));function a(e){return e&&e.__esModule?e:{default:e}}var o=i(143),n=i(196),d=i(197),c=i(5).getParameters,l=new o("Peer"),u=0;e.exports=class extends n{constructor(e){super(l),l.debug("constructor()"),this._closed=!1,this.id=u++,this._transport=e,this._connected=!1,this._data={createTs:Date.now()},this._sents=new Map,this._notificationId=0,this._handleTransport()}get closed(){return this._closed}get connected(){return this._connected}get data(){return this._data}set data(e){throw new Error("cannot override data object")}close(){if(!this._closed){l.debug("close()"),this._closed=!0,this._connected=!1,this._notificationId=0,this._transport.close(),this._transport=null;var e=!0,t=!1,i=void 0;try{for(var r,s=this._sents.values()[Symbol.iterator]();!(e=(r=s.next()).done);e=!0){r.value.close()}}catch(e){t=!0,i=e}finally{try{!e&&s.return&&s.return()}finally{if(t)throw i}}this._sents.clear()}}clear(){var e=!0,t=!1,i=void 0;try{for(var r,s=this._sents.values()[Symbol.iterator]();!(e=(r=s.next()).done);e=!0){r.value.close()}}catch(e){t=!0,i=e}finally{try{!e&&s.return&&s.return()}finally{if(t)throw i}}this._sents.clear()}request(e){var t=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;return(0,s.default)(r.default.mark((function s(){var a;return r.default.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return a=d.createRequest(e,i),"Heartbeat"!=e&&t._logger.debug("request() [method: "+e+", id: "+a.id+"]"),r.next=4,t._transport.send(a);case 4:return r.abrupt("return",new Promise((function(e,i){var r=c().protooMessageTimeout,s={id:a.id,method:a.method,startTs:Date.now(),resolve:function(i){t._sents.delete(a.id)&&(t._closed||(clearTimeout(s.timer),e(i)))},reject:function(e){t._sents.delete(a.id)&&(clearTimeout(s.timer),i(e))},timer:setTimeout((function(){t._sents.delete(a.id)&&i(new Error("request timeout"))}),r),close:function(){var e=new Error;e.name="peer closed",s.method&&(e.message="向edge的 "+s.method+" 请求被取消：连接 #"+t.id+" 已被关闭。连接建立时间："+(t._data.openTs-t._data.createTs)+"ms, 请求时间："+(Date.now()-s.startTs)+"ms"),i(e)}};t._sents.set(a.id,s)})));case 5:case"end":return r.stop()}}),s,t)})))()}notify(e){var t=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;return(0,s.default)(r.default.mark((function s(){var a;return r.default.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return a=d.createNotification(e,i),t._logger.debug("notify() [method:%s]",e),r.next=4,t._transport.send(a);case 4:case"end":return r.stop()}}),s,t)})))()}_handleTransport(){var e=this;if(this._transport.closed)return this._closed=!0,void setTimeout((function(){e._closed||(e._connected=!1,e.safeEmit("close"))}));this._transport.on("open",(function(){e._closed||(l.debug('emit "open"'),e._connected=!0,e._data.openTs=Date.now(),e.safeEmit("open"))})),this._transport.on("disconnected",(function(){e._closed||(l.debug('emit "disconnected"'),e._connected=!1,e.safeEmit("disconnected"))})),this._transport.on("failed",(function(t){e._closed||(l.debug('emit "failed" [currentAttempt:%s]',t),e._connected=!1,e.safeEmit("failed",t))})),this._transport.on("close",(function(){e._closed||(e._closed=!0,l.debug('emit "close"'),e._connected=!1,e.safeEmit("close"))})),this._transport.on("message",(function(t){t.request?e._handleRequest(t):t.response?e._handleResponse(t):t.notification&&e._handleNotification(t)}))}_handleRequest(e){var t=this;try{this.emit("request",e,(function(i){var r=d.createSuccessResponse(e,i);t._transport.send(r).catch((function(){}))}),(function(i,r){i instanceof Error?(i=500,r=String(i)):"number"==typeof i&&r instanceof Error&&(r=String(r));var s=d.createErrorResponse(e,i,r);t._transport.send(s).catch((function(){}))}))}catch(t){var i=d.createErrorResponse(e,500,String(t));this._transport.send(i).catch((function(){}))}}_handleResponse(e){var t=this._sents.get(e.id);if(t)if(e.ok)t.resolve(e.data);else{var i=new Error(e.errorReason);i.code=e.errorCode,t.reject(i)}else l.error("received response does not match any sent request",e.id,JSON.stringify(e))}_handleNotification(e){if(this._handleNotification>e.id)l.warn("忽略重复的通知消息: ",JSON.stringify(e,null," "));else{this._notificationId=e.id;var t=d.createSuccessResponse(e,{});this._transport.send(t).catch((function(){})),this.safeEmit("notification",e)}}}},function(e,t,i){t.generateRandomNumber=function(){return Math.round(1e7*Math.random())}},function(e,t,i){var r=a(i(59)),s=a(i(60));function a(e){return e&&e.__esModule?e:{default:e}}var o=i(290),n=i(143),d=i(196),c=i(197),l=i(142),u={retries:10,factor:2,minTimeout:1e3,maxTimeout:8e3},h=new n("WebSocketTransport"),p=0;e.exports=class extends d{constructor(e,t){super(h),h.debug("constructor() [url:%s, options:%o]",e,t),this._closed=!1,this._url=e,this._options=t||{},this._ws=null,this.wsid=0,this.skipReconnection=!1,this._runWebSocket()}get closed(){return this._closed}close(){if(!this._closed){h.debug("close()"),this._closed=!0,this.safeEmit("close");try{this._ws.onopen=null,this._ws.onclose=null,this._ws.onerror=null,this._ws.onmessage=null,this._ws.close()}catch(e){h.error("close() | error closing the WebSocket: %o",e)}}}send(e){var t=this;return(0,s.default)(r.default.mark((function i(){return r.default.wrap((function(i){for(;;)switch(i.prev=i.next){case 0:if(!t._closed){i.next=2;break}throw new Error("transport closed");case 2:i.prev=2,t._ws.send(l.stringify(e)),i.next=10;break;case 6:throw i.prev=6,i.t0=i.catch(2),h.warn("send() failed:",i.t0.name,i.t0.message),i.t0;case 10:case"end":return i.stop()}}),i,t,[[2,6]])})))()}_runWebSocket(){var e=this,t=o.operation(this._options.retry||u),i=!1;t.attempt((function(r){e._closed?t.stop():(h.debug("_runWebSocket() [currentAttempt:%s]",r),e._ws=new WebSocket(e._url,["protoo"]),p++,e.wsid=p,e._ws.onopen=function(){e._closed||(i=!0,e.safeEmit("open"))},e._ws.onclose=function(s){if(!e._closed)if(h.warn('WebSocket "close" event [wasClean:%s, code:%s, reason:"%s"]',s.wasClean,s.code,s.reason),i){if(t.stop(),e.safeEmit("disconnected"),e._closed||e.skipReconnection)return;e._runWebSocket()}else e.safeEmit("failed",r),e._closed||t.retry(!0)||(e._closed=!0,e.safeEmit("close"))},e._ws.onerror=function(){e._closed||h.error('WebSocket "error" event')},e._ws.onmessage=function(t){if(!e._closed){var i=c.parse(t.data);i&&(0!==e.listenerCount("message")?e.safeEmit("message",i):h.error('no listeners for WebSocket "message" event, ignoring received message'))}})}))}}},function(e,t,i){e.exports=i(291)},function(e,t,i){var r=i(292);t.operation=function(e){var i=t.timeouts(e);return new r(i,{forever:e&&e.forever,unref:e&&e.unref,maxRetryTime:e&&e.maxRetryTime})},t.timeouts=function(e){if(e instanceof Array)return[].concat(e);var t={retries:10,factor:2,minTimeout:1e3,maxTimeout:1/0,randomize:!1};for(var i in e)t[i]=e[i];if(t.minTimeout>t.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var r=[],s=0;s<t.retries;s++)r.push(this.createTimeout(s,t));return e&&e.forever&&!r.length&&r.push(this.createTimeout(s,t)),r.sort((function(e,t){return e-t})),r},t.createTimeout=function(e,t){var i=t.randomize?Math.random()+1:1,r=Math.round(i*t.minTimeout*Math.pow(t.factor,e));return r=Math.min(r,t.maxTimeout)},t.wrap=function(e,i,r){if(i instanceof Array&&(r=i,i=null),!r)for(var s in r=[],e)"function"==typeof e[s]&&r.push(s);for(var a=0;a<r.length;a++){var o=r[a],n=e[o];e[o]=function(r){var s=t.operation(i),a=Array.prototype.slice.call(arguments,1),o=a.pop();a.push((function(e){s.retry(e)||(e&&(arguments[0]=s.mainError()),o.apply(this,arguments))})),s.attempt((function(){r.apply(e,a)}))}.bind(e,n),e[o].options=i}}},function(e,t){function i(e,t){"boolean"==typeof t&&(t={forever:t}),this._originalTimeouts=JSON.parse(JSON.stringify(e)),this._timeouts=e,this._options=t||{},this._maxRetryTime=t&&t.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}e.exports=i,i.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts},i.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timeouts=[],this._cachedTimeouts=null},i.prototype.retry=function(e){if(this._timeout&&clearTimeout(this._timeout),!e)return!1;var t=(new Date).getTime();if(e&&t-this._operationStart>=this._maxRetryTime)return this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(e);var i=this._timeouts.shift();if(void 0===i){if(!this._cachedTimeouts)return!1;this._errors.splice(this._errors.length-1,this._errors.length),this._timeouts=this._cachedTimeouts.slice(0),i=this._timeouts.shift()}var r=this,s=setTimeout((function(){r._attempts++,r._operationTimeoutCb&&(r._timeout=setTimeout((function(){r._operationTimeoutCb(r._attempts)}),r._operationTimeout),r._options.unref&&r._timeout.unref()),r._fn(r._attempts)}),i);return this._options.unref&&s.unref(),!0},i.prototype.attempt=function(e,t){this._fn=e,t&&(t.timeout&&(this._operationTimeout=t.timeout),t.cb&&(this._operationTimeoutCb=t.cb));var i=this;this._operationTimeoutCb&&(this._timeout=setTimeout((function(){i._operationTimeoutCb()}),i._operationTimeout)),this._operationStart=(new Date).getTime(),this._fn(this._attempts)},i.prototype.try=function(e){console.log("Using RetryOperation.try() is deprecated"),this.attempt(e)},i.prototype.start=function(e){console.log("Using RetryOperation.start() is deprecated"),this.attempt(e)},i.prototype.start=i.prototype.try,i.prototype.errors=function(){return this._errors},i.prototype.attempts=function(){return this._attempts},i.prototype.mainError=function(){if(0===this._errors.length)return null;for(var e={},t=null,i=0,r=0;r<this._errors.length;r++){var s=this._errors[r],a=s.message,o=(e[a]||0)+1;e[a]=o,o>=i&&(t=s,i=o)}return t}},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.LBSManager=void 0;const n=i(65),d=i(156),c=o(i(11)),l=o(i(12)),u=i(61),h=i(5),p=a(i(2));var m,f=i(142);!function(e){e[e.UNKNOWN_ERROR=99999]="UNKNOWN_ERROR",e[e.TIMEOUT=70100]="TIMEOUT",e[e.JSON_ERROR=70101]="JSON_ERROR",e[e.FORMAT_ERROR=70102]="FORMAT_ERROR"}(m||(m={}));t.LBSManager=class{constructor(e){this.urlBackupMap={},this.requestCnt=0,this.localStorageKey="LBS_CONFIG",this.builtinConfig=n.LBS_BUILD_CONFIG,this.updateTimer=null,this.lastUpdateStartAt=0,this.lastUpdate=null,this.tagToMainDomain={},this.lbsState="uninit",this.lbsStateWillChangeTimer=null,this.client=e,this.logger=e.logger.getChild(()=>{let e="LBSManager "+this.lbsState;return this.client.adapterRef.lbsManager!==this&&(e+="DETACHED"),e}),window.addEventListener("online",()=>{"DISCONNECTED"!==this.client.adapterRef.connectState.curState&&this.client.adapterRef.lbsManager===this&&(this.logger.log("侦测到网络连接恢复，尝试更新LBS配置"),this.startUpdate("online"))})}async startUpdate(e){var t,i,r;if(!this.client._params.appkey)return void this.logger.error("无法更新域名配置：缺少appkey");if(null===(r=null===(i=null===(t=this.client)||void 0===t?void 0:t._params)||void 0===i?void 0:i.neRtcServerAddresses)||void 0===r?void 0:r.channelServer)return void this.logger.log("忽略更新LBS配置请求：当前为私有化配置");const s=Date.now(),a=s-this.lastUpdateStartAt;if(a<3e3)return void this.logger.log(`startUpdate 忽略更新请求 ${e}: 上次更新于 ${a} 毫秒前`);this.lastUpdateStartAt=s,this.logger.log("startUpdate: 开始更新LBS配置。原因："+e);let o=null;try{o=await this.ajax({url:`${n.lbsUrl}?reason=${e}&sdkVersion=${encodeURIComponent(n.SDK_VERSION)}&appKey=${encodeURIComponent(this.client._params.appkey)}&business=rtc&clientType=16`,type:"GET"})}catch(e){this.logger.error("LBS更新失败！",e)}if(this.getReportField("lbs").forEach(e=>{this.client.apiEventReport("setRequestLbs",e)}),o&&o.nrtc&&o.call&&o.tracking)return o.ttl&&(this.updateTimer&&clearTimeout(this.updateTimer),this.updateTimer=setTimeout(()=>{this.logger.log("LBS已到过期时间，正在回滚至内建设置"),this.loadBuiltinConfig("expire")},1e3*o.ttl)),this.lastUpdate={activeFrom:Date.now(),res:o},this.handleLbsStateWillChange(e),this.addUrlBackup(this.tagToMainDomain.nrtc,o.nrtc,"nrtc","lbs"),this.addUrlBackup(this.tagToMainDomain.call,o.call,"call","lbs"),this.addUrlBackup(this.tagToMainDomain.tracking,o.tracking,"tracking","lbs"),this.lbsState="remote",this.logger.log(`成功加载远端配置。过期时间：${o.ttl}秒后。preloadTimeSec:${o.preloadTimeSec}：`),this.client.safeEmit("@lbs-config-update",{reason:e}),this.saveConfig(o),o;this.logger.error("startUpdate更新失败：无效的 LBS 返回",o)}async loadBuiltinConfig(e){"uninit"!==this.lbsState&&this.handleLbsStateWillChange(e);for(let e in this.builtinConfig)this.builtinConfig[e].length&&(this.addUrlBackup(this.builtinConfig[e][0],this.builtinConfig[e],e,"builtin"),this.tagToMainDomain[e]=this.builtinConfig[e][0]);this.lbsState="builtin",this.client.safeEmit("@lbs-config-update",{reason:e}),"oninit"!==e&&this.logger.log(`成功加载内建配置 ${e}。`)}handleLbsStateWillChange(e){this.lbsStateWillChangeTimer&&clearTimeout(this.lbsStateWillChangeTimer);const t={lbsState:this.lbsState,settings:this.getSettings()};this.lbsStateWillChangeTimer=setTimeout(()=>{const i={lbsState:this.lbsState,settings:this.getSettings()};"DISCONNECTED"!==this.client.adapterRef.connectState.curState&&this.client.apiFrequencyControl({name:"_lbsStateChange",code:0,param:{reason:e,before:t,after:i}})},0)}getSettings(){const e=Object.keys(this.urlBackupMap),t={};return e.forEach(e=>{t[e]=this.urlBackupMap[e].map(e=>{const t=e.lastRequest?{status:e.lastRequest.status,rtt:e.lastRequest.rtt}:void 0;return{domain:e.domain,successCount:e.successCount,failCount:e.failCount,lastResult:t}})}),t}getReportField(e){const t=[];for(let i in this.urlBackupMap)for(let r=0;r<this.urlBackupMap[i].length;r++){const s=this.urlBackupMap[i][r];s.tag===e&&t.push(s)}let i=[],r=0;return t.forEach(t=>{if(t.lastRequest&&"inprogress"!==t.lastRequest.status){if(t.lastRequest.requestId>r&&(r=t.lastRequest.requestId,i=[]),t.lastRequest.requestId!==r)return;"lbs"===e?i.push({app_key:this.client._params.appkey,request_id:t.lastRequest.uuid,err_code:t.lastRequest.errCode,err_msg:t.lastRequest.errMsg,rtt:t.lastRequest.rtt,time:t.lastRequest.finishiedAt}):"nrtc"===e?i.push({domain:t.domain,type:1,code:"success"===t.lastRequest.status?0:1}):"call"===e?i.push({domain:t.domain,type:1,code:"success"===t.lastRequest.status?0:1,status:t.lastRequest.status,lbsFrom:this.lbsState,rtt:t.lastRequest.rtt}):i.push({domain:t.domain,requestId:t.lastRequest.uuid,addr:"",type:1,code:"success"===t.lastRequest.status?0:1,status:t.lastRequest.status,lbsFrom:this.lbsState,rtt:t.lastRequest.rtt})}}),i}saveConfig(e){if(!this.client._params.appkey)return void this.logger.error("saveConfig: 缺少appkey");const t={ts:Date.now(),appKey:this.client._params.appkey,sdkVersion:n.SDK_VERSION,sdkBuild:n.BUILD,config:e};try{localStorage.setItem(this.localStorageKey,JSON.stringify(t))}catch(e){this.logger.error("saveConfig：无法存储LBS设置",e.name,e.message)}}loadLocalConfig(e){var t,i;if(!this.client._params.appkey)return this.logger.error("loadLocalConfig: 缺少appkey"),{reason:"appkeyNotFound",config:null};if(null===(i=null===(t=this.client._params)||void 0===t?void 0:t.neRtcServerAddresses)||void 0===i?void 0:i.channelServer)return this.logger.log("忽略 loadLocalConfig 请求：当前为私有化配置"),{reason:"privilization",config:null};let r=null;try{const e=window.localStorage.getItem(this.localStorageKey);if(!e)return this.logger.log("本地未发现LBS配置"),{reason:"configNotFound",config:null};r=JSON.parse(e)}catch(e){this.logger.error("无法读取本地配置：",e.name,e.message)}if(!r)return{reason:"configError",config:null};const s=Date.now(),a=r.ts+1e3*r.config.ttl-s;return a<0?(this.logger.log(`LBS不使用本地配置：ttl已过期${Math.floor(-a/1e3)} 秒。`),{reason:"expire",config:null}):r.sdkVersion!==n.SDK_VERSION||r.sdkBuild!==n.BUILD?(this.logger.warn(`LBS不使用本地配置：版本不匹配。${r.sdkVersion}/${r.sdkBuild} ${n.SDK_VERSION}/${n.BUILD}。`),{reason:"version",config:null}):r.appKey!==this.client._params.appkey?(this.logger.warn(`LBS不使用本地配置：appKey不匹配。${r.appKey} ${this.client._params.appkey}。`),{reason:"appkey",config:null}):(this.lastUpdate={activeFrom:r.ts,res:r.config},this.handleLbsStateWillChange(e),this.addUrlBackup(this.tagToMainDomain.call,r.config.call,"call","localstorage"),this.addUrlBackup(this.tagToMainDomain.nrtc,r.config.nrtc,"nrtc","localstorage"),this.addUrlBackup(this.tagToMainDomain.tracking,r.config.tracking,"tracking","localstorage"),this.lbsState="local",this.logger.log(`成功加载本地配置。过期时间：${Math.floor(a/1e3)} 秒后。`),this.client.safeEmit("@lbs-config-update",{reason:e}),{reason:"success",config:r})}addUrlBackup(e,t,i,r){const s=this.urlBackupMap[e]||[];this.urlBackupMap[e]=[];const a=this.urlBackupMap[e],o=Date.now();t.forEach(t=>{let n=s.find(i=>i.domain===t&&i.mainDomain===e);n?(n.updatedAt=o,n.tag=i,n.source=r):n={id:a.length,domain:t,mainDomain:e,successCount:0,failCount:0,updatedAt:o,tag:i,source:r},a.push(n)})}getURLSettings(e){const t=/(\/\/)([^\/]+)(\/)/,i=e.match(t);let r="";r=i?i[2]:e,this.urlBackupMap[r]||this.addUrlBackup(r,[r],"extra","extra");const s=this.requestCnt++;return this.urlBackupMap[r].map((i,r)=>{const a=e.replace(t,`$1${i.domain}$3`);return{seqId:`${s}_${r}`,state:"uninit",requestId:s,url:a,item:i}})}markSuccess(e,t){var i;"inprogress"===(null==t?void 0:t.status)&&(t.finishiedAt=Date.now(),t.rtt=t.finishiedAt-t.startAt,t.status="success",this.logger.debug(`markFinish success seqId:${e.seqId} source:${e.item.source} rtt:${t.rtt}ms url:${e.url}`)),e.item.successCount++,e.state="success";const r=this.urlBackupMap[e.item.mainDomain];if(r&&"fail"===(null===(i=r[0].lastRequest)||void 0===i?void 0:i.status)){const t=r.findIndex(t=>t===e.item);t>-1&&(this.logger.warn(`主备域名互换。${r[0].domain} => ${e.item.domain}`),this.handleLbsStateWillChange("domainDown:"+r[0].domain),r.splice(t,1),r.unshift(e.item))}}markFail(e,t,i,r){"inprogress"===(null==t?void 0:t.status)&&(t.finishiedAt=Date.now(),t.rtt=t.finishiedAt-t.startAt,t.status="fail",t.errCode=i,t.errMsg=r,this.logger.debug(`markFinish fail seqId:${e.seqId} source:${e.item.source} rtt:${t.rtt}ms url:${e.url}`,i,r)),e.item.failCount++,e.state="fail",this.logger.error("markFail：",e.item.domain,i,r)}isAllRequestsFinished(e){for(let t in e){const i=e[t];if("uninit"===i.state||"sent"===i.state)return!1}return!0}ajax(e){if(h.getParameters().disableLBSService)return this.logger.log("disableLBSService:",e.url),d.ajax(e);const t=this.getURLSettings(e.url);let i=!1;return new Promise((r,s)=>{const a=(e,a,o)=>{var n,d,u,h,f,g,v;if(e.status>=400){if(this.markFail(o,a,e.status,"string"==typeof e.response?e.response:JSON.stringify(e.response)),t[1]&&t[1].fire&&t[1].timer)this.logger.warn(`主线路请求发生错误，启用备用线路 【主  ${o.url} 】【备 ${t[1].url} 】`,e.status),t[1].fire();else if(this.isAllRequestsFinished(t)){let e="LBS: request error",t="LBS: 请求错误",i="Please contact CommsEase technical support",r="请联系云信技术支持",a=p.IS_ZH?t:e,o=p.IS_ZH?r:i;return s(new l.default({code:c.default.LBS_REQUEST_ERROR,message:a,advice:o}))}}else if("json"!==e.responseType||e.response)if(500===(null===(n=e.response)||void 0===n?void 0:n.code)){if(this.markFail(o,a,m.UNKNOWN_ERROR,JSON.stringify(e.response)),t[1]&&t[1].fire&&t[1].timer)this.logger.warn(`主线路请求发生错误，启用备用线路 【主  ${o.url} 】【备 ${t[1].url} 】`,e.response),t[1].fire();else if(this.isAllRequestsFinished(t)){var _=e.response;r(_)}}else if("lbs"!==o.item.tag||(null===(u=null===(d=e.response)||void 0===d?void 0:d.call)||void 0===u?void 0:u.length)&&(null===(f=null===(h=e.response)||void 0===h?void 0:h.nrtc)||void 0===f?void 0:f.length)&&(null===(v=null===(g=e.response)||void 0===g?void 0:g.tracking)||void 0===v?void 0:v.length)){if(this.markSuccess(o,a),t.forEach(e=>{e.timer&&(clearTimeout(e.timer),e.timer=void 0),e.fire=void 0}),i)return void this.logger.log(`${o.url} 已忽略返回值：${e.status}`);i=!0;_=e.response;r(_)}else{if(this.markFail(o,a,m.FORMAT_ERROR,JSON.stringify(e.response)),!(t[1]&&t[1].fire&&t[1].timer))return r(e.response);this.logger.warn(`主线路请求发生错误，启用备用线路 【主  ${o.url} 】【备 ${t[1].url} 】`,"FORMAT_ERROR"),t[1].fire()}else if(this.markFail(o,a,m.JSON_ERROR,"JSON_ERROR"),t[1]&&t[1].fire&&t[1].timer)this.logger.warn(`主线路请求发生错误，启用备用线路 【主  ${o.url} 】【备 ${t[1].url} 】`,e),t[1].fire();else if(this.isAllRequestsFinished(t)){let e="LBS: json error",t="LBS: json 解析错误",i="Please contact CommsEase technical support",r="请联系云信技术支持",a=p.IS_ZH?t:e,o=p.IS_ZH?r:i;return s(new l.default({code:c.default.LBS_JSON_ERROR,message:a,advice:o}))}},o=(e,r,a,o)=>{this.markFail(a,r,m.UNKNOWN_ERROR,`${o.type||JSON.stringify(o)}:${a.url}`),t[1]&&t[1].fire&&t[1].timer?(this.logger.warn(`主线路请求发生错误，启用备用线路 【主  ${a.url} 】【备 ${t[1].url} 】`,o),t[1].fire()):this.isAllRequestsFinished(t)&&(i=!0,s(o))},n=(r,a,o,n)=>{this.markFail(o,a,m.TIMEOUT,"TIMEOUT"),t[1]&&t[1].fire&&t[1].timer?(this.logger.warn(`主线路请求超时，启用备用线路 【主 ${o.url}】【备 ${t[1].url}】`,n),t[1].fire()):this.isAllRequestsFinished(t)&&(i=!0,s({code:456,desc:"ERR_TIMED_OUT "+e.url}))};t.forEach((t,i)=>{t.fire=()=>{t.fire=void 0,t.timer&&(clearTimeout(t.timer),t.timer=void 0),t.state="sent";const i={status:"inprogress",startAt:Date.now(),requestId:t.requestId,seqId:t.seqId,uuid:"",finishiedAt:0,errCode:0,errMsg:"",rtt:-1};t.item.lastRequest=i,((t,i)=>{const r=new XMLHttpRequest;t.xhr=r,r.open(e.type||"GET",i.url,!0),r.responseType=e.dataType||"json";const s=e.contentType||"application/json;charset=UTF-8";if(r.setRequestHeader("Content-Type",s),e.header&&Object.keys(e.header).map(t=>{e.header&&e.header[t]&&r.setRequestHeader(t,e.header[t])}),"lbs"===i.item.tag){const e=u.generateUUID();i.item.lastRequest&&(i.item.lastRequest.uuid=e),r.setRequestHeader("X-Request-Id",e)}r.onload=a.bind(r,r,t,i),r.onerror=o.bind(r,r,t,i),r.ontimeout=n.bind(r,r,t,i),s.indexOf("x-www-form-urlencoded")>=0?e.data?r.send(d.getFormData(e.data)):r.send():e.data?r.send(f.stringify(e.data)):r.send()})(i,t)},i&&(t.timer=setTimeout(()=>{t.fire&&(this.logger.warn("主线路请求超时，发起备用线路请求："+t.url),t.fire())},h.getParameters().fireBackupDelay*i))}),t[0].fire&&t[0].fire()})}}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.SpatialManager=void 0;const r=i(115);t.SpatialManager=class{constructor(e){this.elem=document.createElement("audio"),this.fakeElem=document.createElement("audio"),this.data={},this.context=e.context,this.client=e.client,this.options=e.options,this.logger=e.client.adapterRef.logger.getChild(()=>"spatial");try{this.destination=new MediaStreamAudioDestinationNode(this.context)}catch(e){if("TypeError"!==e.name)throw e;this.destination=this.context.createMediaStreamDestination()}this.elem.setAttribute("playsinline","playsinline"),this.elem.setAttribute("autoplay","autoplay"),this.elem.className="nertc-panner-manager",this.elem.srcObject=this.destination.stream,this.fakeElem.muted=!0,this.fakeElem.volume=0,this.fakeElem.autoplay=!0,this.fakeElem.controls=!0}getUserData(e){const t=""+e;""+parseInt(t)!==t&&this.logger.warn("getUserData:异常的uid：",e);let i=this.data[t];return i||(i={position:{x:0,y:0}},this.data[t]=i),i}shouldSubscribe(e){const t=this.getUserData(e);return Math.abs(t.position.x)<=64&&Math.abs(t.position.y)<=64}async updatePosition(e,t){const i=this.getUserData(e),r=this.client.adapterRef.remoteStreamMap[e];if(r){const s=this.client.getSubStatus(r,"all");if(this.shouldSubscribe(e))if(s.subscribable)this.logger.log(`[remote#${e} status:${s.status}]界内，【即将订阅】: (${i.position.x}, ${i.position.y}) => (${t.x}, ${t.y})`),i.position.x=t.x,i.position.y=t.y,await this.client.doSubscribe(r),this.updatePosition(e,i.position);else{if(i.position.x===t.x&&i.position.y===t.y)return;this.logger.log(`[remote#${e} status:${s.status}]界内，即将更新remoteStream位置: (${i.position.x}, ${i.position.y}) => (${t.x}, ${t.y})`),i.position.x=t.x,i.position.y=t.y,i.audioNodes&&(i.audioNodes.pannerNode.positionX.value=t.x,i.audioNodes.pannerNode.positionY.value=t.y)}else if("subscribed"===s.status)this.logger.log(`[remote#${e} status:${s.status}]界外，【即将取消订阅】:  (${i.position.x}, ${i.position.y}) => (${t.x}, ${t.y})`),i.position.x=t.x,i.position.y=t.y,await this.client.doUnsubscribe(r),this.updatePosition(e,i.position);else{if(i.position.x===t.x&&i.position.y===t.y)return;this.logger.log(`[remote#${e} status:${s.status}]界外，即将更新remoteStream位置:  (${i.position.x}, ${i.position.y}) => (${t.x}, ${t.y})`),i.position.x=t.x,i.position.y=t.y,i.audioNodes&&(i.audioNodes.pannerNode.positionX.value=t.x,i.audioNodes.pannerNode.positionY.value=t.y)}}else this.logger.log(`updatePosition: 更新未到的stream: ${e} ( ${t.x}, ${t.y})`),i.position.x=t.x,i.position.y=t.y}init(){this.client.addListener("@stream-added",e=>{const t=this.getUserData(e.stream.getId());e.stream.setSubscribeConfig(this.options.subConfig),this.updatePosition(e.stream.getId(),t.position)}),this.client.addListener("@stream-unsubscribed",e=>{const t=this.getUserData(e.stream.getId());this.updatePosition(e.stream.getId(),t.position)}),this.client.addListener("@stream-subscribed",async e=>{this.logger.log("Subscribed to",e.stream.streamID,e.mediaType);const t=this.getUserData(e.stream.getId());"audio"===e.mediaType&&(t.audioNodes&&(t.audioNodes.pannerNode.disconnect(),t.audioNodes.source.disconnect(),t.audioNodes.gainNode.disconnect()),t.audioNodes={source:this.context.createMediaStreamSource(e.stream.mediaHelper.audio.audioStream),gainNode:this.context.createGain(),pannerNode:new PannerNode(this.context,{panningModel:"HRTF",distanceModel:"linear",rolloffFactor:1,coneInnerAngle:360,positionX:t.position.x,positionY:t.position.y,positionZ:0,maxDistance:100})},t.audioNodes.source.connect(t.audioNodes.gainNode),t.audioNodes.gainNode.connect(t.audioNodes.pannerNode),t.audioNodes.pannerNode.connect(this.destination),this.fakeElem.srcObject=e.stream.mediaHelper.audio.audioStream,this.fakeElem.play().catch(e=>{r.Device.onUserGestureNeeded&&(r.Device.onUserGestureNeeded(e),r.Device.once("user-gesture-fired",()=>{this.fakeElem.play()}))}),this.logger.log("Connected",e.stream.getId,e.stream.mediaHelper.audio.audioStream.getAudioTracks()[0])),this.updatePosition(e.stream.getId(),t.position)})}play(){this.elem.controls=!0,"suspended"===this.context.state&&r.Device.onUserGestureNeeded&&(r.Device.onUserGestureNeeded(new Error("恢复AudioContext")),r.Device.once("user-gesture-fired",()=>{this.context.resume()})),this.elem.play().catch(e=>{r.Device.onUserGestureNeeded&&(r.Device.onUserGestureNeeded(e),r.Device.once("user-gesture-fired",()=>{this.elem.play()}))})}}},function(module,exports,__webpack_require__){var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.LocalStream=void 0;const bignumber_js_1=__importDefault(__webpack_require__(70)),videoQuality_1=__webpack_require__(137),alerter_1=__webpack_require__(144),audioLevel_1=__webpack_require__(173),media_1=__webpack_require__(190),parameters_1=__webpack_require__(5),play_1=__webpack_require__(192),record_1=__webpack_require__(149),video_post_processing_1=__importDefault(__webpack_require__(296)),advanced_beauty_1=__importDefault(__webpack_require__(319)),basic_beauty_1=__importDefault(__webpack_require__(320)),virtual_background_1=__importDefault(__webpack_require__(321)),plugin_1=__webpack_require__(322),plugin_list_1=__webpack_require__(200),errorCode_1=__importDefault(__webpack_require__(11)),rtcError_1=__importDefault(__webpack_require__(12)),gum_1=__webpack_require__(118),param_1=__webpack_require__(69),applyResolution_1=__webpack_require__(323),env=__importStar(__webpack_require__(2)),RTCEventEmitter_1=__webpack_require__(66),rtcSupport_1=__webpack_require__(145),utils_1=__webpack_require__(61),webAudio_1=__webpack_require__(62),StageAIProcessing_1=__webpack_require__(191);let localStreamCnt=0;class LocalStream extends RTCEventEmitter_1.RTCEventEmitter{constructor(e){if(super(),this.safariVideoSizeChange=!1,this._advancedBeautyProcessor=null,this.videoPostProcessTags={isBeautyTrack:!1,isBodySegmentTrack:!1,isAdvBeautyTrack:!1},this.replaceTags={videoPost:!1,waterMark:!1,isMuted:!1},this.audioLevelHelper=null,this.audioLevelHelperSlave=null,this.videoProfile={frameRate:videoQuality_1.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_NORMAL,resolution:videoQuality_1.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_480p},this.screenProfile={frameRate:videoQuality_1.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_5,resolution:videoQuality_1.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_1080p},this.state="UNINIT",this.videoView=null,this.screenView=null,this.renderMode={local:{video:{},screen:{}}},this.inSwitchDevice={audio:!1,video:!1},this.pubStatus={audio:{audio:!1},audioSlave:{audio:!1},video:{video:!1},screen:{screen:!1}},this.muteStatus={audio:{send:!1},audioSlave:{send:!1},video:{send:!1},screen:{send:!1}},this.isRemote=!1,this.audioPlay_=!1,this.videoPlay_=!1,this.screenPlay_=!1,this.active=!0,this.destroyed=!1,this.canvasWatermarkOptions=null,this.encoderWatermarkOptions=null,this.basicBeautyStaticRes=e=>{this.logger.log("config basic beauty static resources."),this.WebGLSupportError(),basic_beauty_1.default.configStaticRes(e)},this.advBeautyStaticRes=e=>{this.logger.log("config advanced beauty static resources."),this.WebGLSupportError(),advanced_beauty_1.default.configStaticRes(e)},this.setAdvBeautyEffect=(...e)=>{this.logger.log("set advanced beauty parameters:"+JSON.stringify(e)),this.videoPostProcess.availableCode<1||(this.advancedBeauty.isEnable||this.logger.warn("advanced beauty is not opened."),this.advancedBeauty.setAdvEffect(...e))},this.presetAdvBeautyEffect=(...e)=>{this.logger.log("preset advanced beauty parameters:"+JSON.stringify(e)),this.videoPostProcess.availableCode<1||(this.advancedBeauty.isEnable||this.logger.warn("advanced beauty is not opened."),this.advancedBeauty.presetAdvEffect(...e))},this.localStreamId=localStreamCnt++,this.logger=e.client.adapterRef.logger.getChild(()=>{let e=this.localStreamId?"local"+this.localStreamId:"localStream";if(this.mediaHelper){let t="";this.mediaHelper.audio.micTrack&&(t+="m"),this.mediaHelper.video.cameraTrack&&(t+="c"),this.mediaHelper.screen.screenVideoTrack&&(t+="s"),this.mediaHelper.screenAudio.screenAudioTrack&&(t+="t"),t&&(e+=" "+t)}return"INITED"!==this.state&&(e+=" "+this.state),"INITED"===this.state&&this.client&&this.client.adapterRef.localStream!==this&&(e+=" DETACHED"),this.destroyed&&(e+=" DESTROYED"),e}),e.uid)if("string"==typeof e.uid||bignumber_js_1.default.isBigNumber(e.uid))this.logger.log("uid是string类型"),e.client.adapterRef.channelInfo.uidType="string";else{if("number"!=typeof e.uid){this.logger.error("uid参数格式非法");let e="localStream: The type of parameter(uid) is not invalid",t="localStream: uid 参数类型非法",i="Please input the correct parameter type",r="请输入正确的参数类型",s=env.IS_ZH?t:e,a=env.IS_ZH?r:i;throw new rtcError_1.default({code:errorCode_1.default.INVALID_PARAMETER_ERROR,message:s,advice:a})}if(this.logger.log("uid是number类型"),e.client.adapterRef.channelInfo.uidType="number",e.uid>Number.MAX_SAFE_INTEGER){let e="localStream: parameter(uid) out of bounds",t="localStream: uid 参数越界",i="The maximum range of the Number type is 2^53 - 1, please input the correct parameter",r="Number 类型的 uid 最大值是 2^53 - 1， 请输入正确的参数",s=env.IS_ZH?t:e,a=env.IS_ZH?r:i;throw new rtcError_1.default({code:errorCode_1.default.INVALID_PARAMETER_ERROR,message:s,advice:a})}}else e.uid="local_"+this.localStreamId;this._reset(),this.streamID=e.uid,this.stringStreamID=this.streamID.toString(),this.audio=e.audio,this.audioProcessing=e.audioProcessing||null,this.microphoneId=e.microphoneId||"",this.cameraId=e.cameraId||"",this.video=e.video||!1,this.screen=e.screen||!1,this.screenAudio=e.screenAudio||!1,this.audioSlave=this.screenAudio,this.sourceId=e.sourceId||"",this.facingMode=e.facingMode||"",this.client=e.client,this.audioSource=e.audioSource||null,this.videoSource=e.videoSource||null,this.screenAudioSource=e.screenAudioSource||null,this.screenVideoSource=e.screenVideoSource||null,this._segmentProcessor=null,this._cameraTrack=null,this._transformedTrack=null,this.mediaHelper=new media_1.MediaHelper({stream:this}),this._play=new play_1.Play({stream:this}),this._record=new record_1.Record({logger:this.logger,client:this.client}),this.client._params&&"live"===this.client._params.mode?this.audioProfile="music_standard":this.audioProfile="speech_low_quality","never"!==parameters_1.getParameters().enableAlerter&&alerter_1.alerter.watchLocalStream(this),this.logger.log("创建 本地 Stream: ",JSON.stringify({streamID:this.stringStreamID,audio:e.audio,video:e.video})),this.client.apiFrequencyControl({name:"createLocalStream",code:0,param:{streamID:this.stringStreamID,videoProfile:this.videoProfile,audio:this.audio,audioProfile:this.audioProfile,video:this.video,screen:this.screen,screenProfile:this.screenProfile}}),this.videoPostProcess=new video_post_processing_1.default(this.logger),this.basicBeauty=new basic_beauty_1.default(this.videoPostProcess),this.virtualBackground=new virtual_background_1.default(this.videoPostProcess),this.advancedBeauty=new advanced_beauty_1.default(this.videoPostProcess),env.IS_ANY_SAFARI&&this.videoPostProcess.on("safariVideoSizeChange",()=>{this.safariVideoSizeChange=!0,this.loseContext()}),this.videoPostProcess.on("contextLost",()=>{if(this.suspendVideoPostProcess(),!this.safariVideoSizeChange){this.emit("video-post-context-lost");const e=env.IS_ZH?"webgl 上下文丢失，相关功能将无法使用。\n正在监听恢复事件以尝试重新初始化 webgl 管线……\n丢失原因：https://developer.mozilla.org/en-US/docs/Web/API/WebGLRenderingContext/isContextLost#usage_notes。":"webgl context lost, related functions will not be available.\nwaiting for restored event and try to reinitialize webgl pipeline ……\n see why: https://developer.mozilla.org/en-US/docs/Web/API/WebGLRenderingContext/isContextLost#usage_notes.";throw new rtcError_1.default({code:errorCode_1.default.WEBGL_LOSE_CONTEXT_ERROR,message:e})}setTimeout(()=>{this.restoreContext()},0)}),this.videoPostProcess.on("contextRestored",e=>{if(this.resumeVideoPostProcess(),this.safariVideoSizeChange)this.safariVideoSizeChange=!1;else if(this.emit("video-post-context-restored",e),this.logger.log("webgl context restored, try to reinitialize webgl pipeline."),!e)throw new rtcError_1.default({code:errorCode_1.default.WEBGL_RESTORED_FAILD_ERROR,message:env.IS_ZH?"重新初始化 webgl 失败.":"webgl reinitialize failed.",advice:env.IS_ZH?"请重新刷新页面。":"please refresh the page."})}),this.videoPostProcess.on("beautyResComplete",e=>{if(this.emit("basic-beauty-res-complete",e),e.length){const t=env.IS_ZH?"基础美颜资源加载失败:"+JSON.stringify(e):"failed to load basic-beauty resources:"+JSON.stringify(e);throw new rtcError_1.default({code:errorCode_1.default.BASIC_BEAUTY_RES_ERROR,message:t,advice:env.IS_ZH?"请检查网络是否开启或资源地址是否正确。":"please check network or resource address."})}}),this.videoPostProcess.on("advBeautyResComplete",e=>{if(this.emit("adv-beauty-res-complete",e),e.length){const t=env.IS_ZH?"高级美颜资源加载失败:"+JSON.stringify(e):"failed to load basic-beauty resources:"+JSON.stringify(e);throw new rtcError_1.default({code:errorCode_1.default.ADV_BEAUTY_RES_ERROR,message:t,advice:env.IS_ZH?"请检查网络是否开启或资源地址是否正确。":"please check network or resource address."})}}),this.videoPostProcess.on("taskSwitch",e=>{if(this.replaceTags.videoPost=e,this.replaceCanvas(),e&&env.IS_ANY_SAFARI){const e=parseFloat(env.SAFARI_VERSION||"0");e<15.4&&this.logger.warn("It is detected that you are using safari and the version is lower than 15.4. For a better experience, it is recommended to use version 15.4 and above."),15.3===e&&this.logger.warn("In the current version of Safari, enabling video post-processing related functions will cause memory leaks (Safari kernel bug: capturing video streams from WebGL will cause memory leaks)."),15===e&&this.logger.warn("In the current version of Safari, enabling video post-processing related functions will cause the page to crash (Safari kernel bug: WebGL rendering WebCam will cause the page to crash).")}}),env.IS_ANY_SAFARI&&env.SAFARI_MAJOR_VERSION<15&&document.addEventListener("visibilitychange",()=>{"visible"===document.visibilityState&&this.replaceTags.videoPost&&this.logger.warn("In the current version of Safari, the page with the video post-processing function is restored from the background, the sending frame rate will slowly return to the normal frame rate from a lower value.")}),this.mediaHelper.on("preProcessChange",e=>{"video"===e.mediaType&&(this.replaceTags.waterMark=e.isOn,this.replaceCanvas())})}getAdapterRef(){return this.client.adapterRef.localStream===this?this.client.adapterRef:null}_reset(){this.streamID="",this.stringStreamID="",this.state="UNINIT",this.videoProfile={frameRate:videoQuality_1.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_NORMAL,resolution:videoQuality_1.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_480p},this.audioProfile="speech_low_quality",this.screenProfile={frameRate:videoQuality_1.VIDEO_FRAME_RATE.CHAT_VIDEO_FRAME_RATE_5,resolution:videoQuality_1.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_1080p},this.audio=!1,this.microphoneId="",this.video=!1,this.cameraId="",this.screen=!1,this.screenAudio=!1,this.audioSlave=!1,this.sourceId="",this.facingMode="",this.videoView=null,this.screenView=null,this.renderMode={local:{video:{},screen:{}}},this.inSwitchDevice={audio:!1,video:!1},this.pubStatus={audio:{audio:!1},audioSlave:{audio:!1},video:{video:!1},screen:{screen:!1}},this.muteStatus={audio:{send:!1},audioSlave:{send:!1},video:{send:!1},screen:{send:!1}},this.renderMode={local:{video:{},screen:{}}},this.mediaHelper&&this.mediaHelper.destroy(),this._play&&this._play.destroy(),this._play=null,this._record&&this._record.destroy(),this._record=null,this.audioLevelHelper&&this.audioLevelHelper.destroy(),this.audioLevelHelper=null,this.audioLevelHelperSlave&&this.audioLevelHelperSlave.destroy(),this.audioLevelHelperSlave=null}get segmentProcessor(){return this._segmentProcessor}get Play(){return this._play}get Record(){return this._record}getId(){return"string"===this.client.adapterRef.channelInfo.uidType?this.stringStreamID:this.streamID}async getStats(){var e,t,i;let r=null===(i=null===(t=null===(e=this.getAdapterRef())||void 0===e?void 0:e._mediasoup)||void 0===t?void 0:t._sendTransport)||void 0===i?void 0:i._handler._pc;if(this.logger.log("获取音视频连接数据, uid: "+this.stringStreamID),r){const e={accessDelay:"0",audioSendBytes:"0",audioSendPackets:"0",audioSendPacketsLost:"0",videoSendBytes:"0",videoSendFrameRate:"0",videoSendPackets:"0",videoSendPacketsLost:"0",videoSendResolutionHeight:"0",videoSendResolutionWidth:"0"};try{(await r.getStats()).forEach(t=>{"outbound-rtp"===t.type?"video"===t.mediaType?(e.videoSendBytes=t.bytesSent.toString(),e.videoSendPackets=t.packetsSent.toString(),e.videoSendFrameRate=t.framesPerSecond.toString()):"audio"===t.mediaType&&(e.audioSendBytes=t.bytesSent.toString(),e.audioSendPackets=t.packetsSent.toString()):"candidate-pair"===t.type?"number"==typeof t.currentRoundTripTime&&(e.accessDelay=(1e3*t.currentRoundTripTime).toString()):"track"===t.type?void 0!==t.frameWidth&&(e.videoSendResolutionWidth=t.frameWidth.toString(),e.videoSendResolutionHeight=t.frameHeight.toString()):"remote-inbound-rtp"===t.type&&("audio"===t.kind?e.audioSendPacketsLost=t.packetsLost.toString():"video"===t.kind&&(e.videoSendPacketsLost=t.packetsLost.toString()))})}catch(e){this.logger.error("failed to get localStats",e.name,e.message)}return e}}getAudioStream(){return this.mediaHelper?(this.client.apiFrequencyControl({name:"setExternalAudioRender",code:0,param:JSON.stringify({},null," ")}),this.mediaHelper.audio.audioStream):null}async init(){rtcSupport_1.isHttpProtocol()&&this.logger.warn("The current protocol is HTTP");const e=await this.client.operationQueue.enqueue({caller:this,method:"init",options:null}),t=()=>{e();const t={audio:this.audio,video:this.video,screen:this.screen,screenAudio:this.screenAudio};(this.audio||this.screenAudio)&&(t.audioProfile=this.audioProfile,t.audioProcessing=this.audioProcessing),this.video&&(t.videoProfile=this.mediaHelper.video.captureConfig.high,t.videoEncoder=this.mediaHelper.video.encoderConfig.high),this.screen&&(t.screenProfile=this.mediaHelper.screen.captureConfig.high,t.screenEncoder=this.mediaHelper.screen.encoderConfig.high),this.client.apiFrequencyControl({name:"init",code:0,param:Object.assign({streamID:this.stringStreamID},t)}),this.client.apiFrequencyControl({name:"_trackSettings",code:0,param:JSON.stringify(this.mediaHelper.getTrackSettings())})};let i=null;if(this.state="INITING",this.logger.log("init() 初始化音视频流对象"),this.client.adapterRef.channelInfo.sessionConfig.maxVideoQuality=videoQuality_1.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_1080p,this.videoProfile&&(this.client.adapterRef.channelInfo.sessionConfig.videoQuality=this.videoProfile.resolution,this.client.adapterRef.channelInfo.sessionConfig.videoFrameRate=this.videoProfile.frameRate),this.client.adapterRef.isAudioBanned&&this.client.adapterRef.isVideoBanned){const e="服务器禁止发送音视频流";this.logger.error(e),this.client.apiFrequencyControl({name:"init",code:-1,param:JSON.stringify({reason:e},null," ")}),this.audio=!1,this.screenAudio=!1,this.video=!1,this.screen=!1;let t="localStream.init: audio and video are banned by server",i="localStream.init: audio 和 video 被服务器禁言",r=env.IS_ZH?i:t;throw new rtcError_1.default({code:errorCode_1.default.BANNED_BY_SERVER,message:r})}if(this.client.adapterRef.isAudioBanned&&!this.client.adapterRef.isVideoBanned){const e="服务器禁止发送音频流";this.logger.error(e),this.client.apiFrequencyControl({name:"init",code:-1,param:JSON.stringify({reason:e},null," ")}),this.audio=!1,this.screenAudio=!1}if(!this.client.adapterRef.isAudioBanned&&this.client.adapterRef.isVideoBanned){const e="服务器禁止发送视频流";this.logger.error(e),this.client.apiFrequencyControl({name:"init",code:-1,param:JSON.stringify({reason:e},null," ")}),this.video=!1,this.screen=!1}try{this.audio&&await this.mediaHelper.getStream({audio:this.audio,audioDeviceId:this.microphoneId,audioSource:this.audioSource})}catch(e){this.logger.log("init() 打开mic失败: "+e.message),i=e,this.audio=!1}try{this.video&&(await this.mediaHelper.getStream({video:this.video,videoSource:this.videoSource,videoDeviceId:this.cameraId,facingMode:this.facingMode}),this.mediaHelper.video.preProcessingEnabled&&this.mediaHelper.enablePreProcessing("video"))}catch(e){this.logger.log("init() 打开camera失败: "+e.message),i=e,this.video=!1}try{if(this.screen){const e={sourceId:this.sourceId,screen:this.screen,screenVideoSource:this.screenVideoSource,screenAudio:this.screenAudio,screenAudioSource:this.screenAudioSource};await this.mediaHelper.getStream(e),this.mediaHelper.screen.preProcessingEnabled&&this.mediaHelper.enablePreProcessing("screen")}}catch(e){this.logger.log("init() 打开screen失败: "+e.message),i=e,this.screen=!0}if(this.audio||this.video||this.screen)this.state="INITED";else{if(i)throw this.state="UNINIT",this.logger.error("localStream.init失败:",i.name,i.message,i),t(),i;if(!parameters_1.getParameters().allowEmptyMedia){this.state="UNINIT",this.logger.warn("init() localStream不允许初始化时无任何音视频"),t();let e="init: localStream is not allowed to init without audio or video",i="init: localStream init 缺失 audio/video 参数",r="please make sure audio or video exists when init localStream",s="请输入正确的参数",a=env.IS_ZH?i:e,o=env.IS_ZH?s:r;throw new rtcError_1.default({code:errorCode_1.default.LOCALSTREAM_ERROR,message:a,advice:o})}this.logger.log("init() 当前模式下localStream允许初始化时无任何音视频"),this.state="INITED"}t()}getAudioTrack(){return this.mediaHelper.getAudioInputTracks()[0]||null}getVideoTrack(){if(this.mediaHelper)return this.mediaHelper.video.cameraTrack||this.mediaHelper.screen.screenVideoTrack||this.mediaHelper.video.videoSource}async play(e,t={}){param_1.isExistOptions({tag:"Stream.playOptions.audio",value:t.audio}).result||(t.audio=!1),t.audio&&!t.audioType&&(t.audioType="mixing"),param_1.isExistOptions({tag:"Stream.playOptions.video",value:t.video}).result||(t.video=!0),param_1.isExistOptions({tag:"Stream.playOptions.screen",value:t.screen}).result||(t.screen=!0),this.logger.log(`uid ${this.stringStreamID} Stream.play::`,JSON.stringify(t)),t.audio&&this._play&&this.mediaHelper.getAudioInputTracks().length>0&&(this.logger.log(`uid ${this.stringStreamID} 开始播放本地音频: `,t.audioType),"voice"===t.audioType?(this._play.playAudioStream(this.mediaHelper.audio.micStream,t.muted),this.audioPlay_=!0):"music"===t.audioType?(this._play.playAudioStream(this.mediaHelper.audio.musicStream,t.muted),this.audioPlay_=!0):"mixing"===t.audioType&&(this._play.playAudioStream(this.mediaHelper.audio.audioStream,t.muted),this.audioPlay_=!0));let i=null;if("string"==typeof e?i=document.getElementById(e):e&&(i=e),i){if(t.video&&(this.videoView=i,this._play&&this.mediaHelper.video.videoStream.getVideoTracks().length)){this.logger.log(`uid ${this.stringStreamID} 开始启动视频播放 主流 本地`);try{let e="local";await this._play.playVideoStream(this.mediaHelper.video.renderStream,i,e),"width"in this.renderMode.local.video&&this._play.setVideoRender(this.renderMode.local.video),this.videoPlay_=!0}catch(e){this.videoPlay_=!1,this.logger.log("localStream play video error ",e)}await this.resumeVideoPostProcess()}if(t.screen&&(this.screenView=i,this._play&&this.mediaHelper.screen.screenVideoStream.getVideoTracks().length)){this.logger.log(`uid ${this.stringStreamID} 开始启动视频播放 辅流 本地`);try{await this._play.playScreenStream(this.mediaHelper.screen.renderStream,i),"width"in this.renderMode.local.screen&&this._play.setScreenRender(this.renderMode.local.screen),this.screenPlay_=!1}catch(e){this.screenPlay_=!1,this.logger.log("localStream play screen error ",e)}}}if(t.audio){let e;e=this.client.adapterRef.isAudioBanned?{enable:!1}:{enable:!0},this.client.apiFrequencyControl({name:"enableEarback",code:e.enable?0:1,param:JSON.stringify(e,null," ")})}this.client.apiFrequencyControl({name:"play",code:0,param:JSON.stringify({streamID:this.stringStreamID,playOptions:t,isRemote:!1},null," ")})}async resume(){this._play&&(await this._play.resume(),this._play.audioDom&&!this._play.audioDom.paused&&(this.audioPlay_=!0),this._play.videoDom&&!this._play.videoDom.paused&&(this.videoPlay_=!0),this._play.screenDom&&!this._play.screenDom.paused&&(this.screenPlay_=!0)),this.client.apiFrequencyControl({name:"resume",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1},null," ")})}setLocalRenderMode(e,t){const i={options:e,mediaType:t};if(!(e&&e.width-0&&e.height-0))return this.logger.warn("setLocalRenderMode 参数错误"),this.client.apiFrequencyControl({name:"setLocalRenderMode",code:-1,param:JSON.stringify(i,null," ")}),"INVALID_ARGUMENTS";this.logger.log(`uid ${this.stringStreamID} 设置本地视频播放窗口大小: `,t||"video+screen",JSON.stringify(e)),t&&"video"!==t||(this._play&&this._play.setVideoRender(e),this.renderMode.local.video=e,this.replaceCanvas()),t&&"screen"!==t||(this.renderMode.local.screen=e,this._play&&this._play.setScreenRender(e)),this.client.apiFrequencyControl({name:"setLocalRenderMode",code:0,param:Object.assign({streamID:this.stringStreamID,mediaType:t},i)})}stop(e){this.logger.log(`stop() uid ${this.stringStreamID} 停止播放 ${e||"音视频流"}`),this._play&&("audio"===e?(this._play.stopPlayAudioStream(),this.audioPlay_=!1):"video"===e?(this._play.stopPlayVideoStream(),this.videoPlay_=!1):"screen"===e?(this._play.stopPlayScreenStream(),this.screenPlay_=!1):(this._play.audioDom&&(this._play.stopPlayAudioStream(),this.audioPlay_=!1),this._play.videoDom&&(this._play.stopPlayVideoStream(),this.videoPlay_=!1),this._play.screenDom&&(this._play.stopPlayScreenStream(),this.screenPlay_=!1)),this.client.apiFrequencyControl({name:"stop",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1,audio:this.audio,video:this.video,screen:this.screen,type:e},null," ")}))}async isPlaying(e){let t=!1;if(this._play)if("audio"===e)t=await this._play.isPlayAudioStream();else if("video"===e)t=await this._play.isPlayVideoStream();else{if("screen"!==e){this.logger.warn("isPlaying: unknown type");let e="localStream.isPlaying: The type of parameter(uid) is unknown",t="localStream.isPlaying: uid 参数类型非法",i="please make sure the parameter(type) is correct",r="请输入正确的参数类型",s=env.IS_ZH?t:e,a=env.IS_ZH?r:i;return Promise.reject(new rtcError_1.default({code:errorCode_1.default.UNKNOWN_TYPE_ERROR,message:s,advice:a}))}t=await this._play.isPlayScreenStream()}else;return this.client.apiFrequencyControl({name:"isPlaying",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1,type:e},null," ")}),this.logger.log(`检查${this.stringStreamID}的${e}播放状态: ${t}`),t}async open(e){var t,i,r,s;let{type:a,deviceId:o,sourceId:n,facingMode:d,screenAudio:c,audioSource:l,videoSource:u,screenAudioSource:h,screenVideoSource:p}=e;const m=await this.client.operationQueue.enqueue({caller:this,method:"open",options:e}),f=t=>{m();const i=utils_1.makePrintable(Object.assign({},e,t.param),1);this.client.apiFrequencyControl({name:"open",code:t.code,param:Object.assign({streamID:this.stringStreamID},i)}),this.client.apiFrequencyControl({name:"_trackSettings",code:t.code,param:JSON.stringify(this.mediaHelper.getTrackSettings())})};if(1===this.client._roleInfo.userRole){const e="观众不允许打开设备";this.logger.error(e),f({code:-1,param:{reason:e,type:a}});let t="Stream.open: invalid operation",i="Stream.open: 操作异常",r="audience is not allowed to open",s="观众模式不允许打开设备",o=env.IS_ZH?i:t,n=env.IS_ZH?s:r;return Promise.reject(new rtcError_1.default({code:errorCode_1.default.INVALID_OPERATION_ERROR,message:o,advice:n}))}try{switch(this.getAdapterRef()||(this.logger.log("Stream.open: 绑定 localStream ",a),this.client.bindLocalStream(this)),a){case"audio":if(this.client.adapterRef.isAudioBanned){const e="服务器禁止发送音频流";this.logger.error(e),f({code:-1,param:{reason:e,type:a}});let t="localStream.open.audio: audio is banned by server",i="localStream.open.audio: audio 被服务器禁言",r=env.IS_ZH?i:t;return Promise.reject(new rtcError_1.default({code:errorCode_1.default.BANNED_BY_SERVER,message:r}))}if(this.logger.log("open(): 开启 "+(l?l.label:"mic设备")),this.mediaHelper.audio.micTrack||this.mediaHelper.audio.audioSource){this.logger.warn("请先关闭麦克风"),f({code:-1,param:{reason:"请先关闭麦克风",type:a}});let e="Stream.open: invalid operation",t="Stream.open: 操作异常",i="please close mic first",r="请先关闭麦克风",s=env.IS_ZH?t:e,o=env.IS_ZH?r:i;return Promise.reject(new rtcError_1.default({code:errorCode_1.default.INVALID_OPERATION_ERROR,message:s,advice:o}))}if(this.audio=!0,this.mediaHelper){const e={audio:!0,audioDeviceId:o,audioSource:l};await this.mediaHelper.getStream(e),this.audioLevelHelper&&this.mediaHelper.audio.audioStream&&this.audioLevelHelper.updateStream(this.mediaHelper.audio.audioStream),o&&(this.microphoneId=o),"CONNECTED"!==this.client.adapterRef.connectState.curState?this.logger.log("Stream.open:client不在频道中，无需发布。",e):(this.logger.log("Stream.open:开始发布",e),await(null===(t=this.client.adapterRef._mediasoup)||void 0===t?void 0:t.createProduce(this,"audio")))}break;case"screenAudio":if(this.client.adapterRef.isAudioBanned){const e="服务器禁止发送音频流";this.logger.error(e),f({code:-1,param:{reason:e,type:a}});let t="localStream.open.screenAudio: audio is banned by server",i="localStream.open.screenAudio: audio 被服务器禁言",r=env.IS_ZH?i:t;return Promise.reject(new rtcError_1.default({code:errorCode_1.default.BANNED_BY_SERVER,message:r}))}if(!h)return void this.logger.error("open(): 不允许单独开启屏幕共享音频功能。");if(this.logger.log("open(): 开启自定义屏幕共享音频 "+h.label),this.mediaHelper.screenAudio.screenAudioTrack||this.mediaHelper.screenAudio.screenAudioSource){this.logger.error("请先关闭屏幕共享音频"),f({code:-1,param:{reason:"请先关闭屏幕共享音频",type:a}});let e="Stream.open: invalid operation",t="Stream.open: 操作异常",i="Please close screenAudio first",r="请先关闭 screenAudio",s=env.IS_ZH?t:e,o=env.IS_ZH?r:i;return Promise.reject(new rtcError_1.default({code:errorCode_1.default.INVALID_OPERATION_ERROR,message:s,advice:o}))}if(this.screenAudio=!0,this.mediaHelper){const e={screenAudio:!0,screenAudioSource:h};await this.mediaHelper.getStream(e),this.audioLevelHelperSlave&&this.mediaHelper.screenAudio.screenAudioStream&&this.audioLevelHelperSlave.updateStream(this.mediaHelper.screenAudio.screenAudioStream),"CONNECTED"!==this.client.adapterRef.connectState.curState?this.logger.log("Stream.open:client不在频道中，无需发布。",e):(this.logger.log("Stream.open:开始发布",e),await(null===(i=this.client.adapterRef._mediasoup)||void 0===i?void 0:i.createProduce(this,"audioSlave")))}break;case"video":case"screen":if(this.client.adapterRef.isVideoBanned){const e="服务器禁止发送视频流";this.logger.error(e),f({code:-1,param:{reason:e,type:a}});let t="localStream.open.video: video is banned by server",i="localStream.open.video: video 被服务器禁言",r=env.IS_ZH?i:t;return Promise.reject(new rtcError_1.default({code:errorCode_1.default.BANNED_BY_SERVER,message:r}))}if(e.screenAudio&&this.client.adapterRef.isAudioBanned){const t="服务器禁止发送音频流";this.logger.error(t),f({code:-1,param:{reason:t,type:a,screenAudio:e.screenAudio}});let i="localStream.open.screenAudio: audio is banned by server",r="localStream.open.screenAudio: audio 被服务器禁言",s=env.IS_ZH?r:i;return Promise.reject(new rtcError_1.default({code:errorCode_1.default.BANNED_BY_SERVER,message:s}))}if(this.logger.log(`开启${"video"===a?"camera":"screen"}设备`),this[a]){if("video"===a){this.logger.warn("请先关闭摄像头"),f({code:-1,param:{reason:"请先关闭摄像头",type:a}});let e="Stream.open: invalid operation",t="Stream.open: 操作异常",i="please close video first",r="请先关闭摄像头",s=env.IS_ZH?t:e,o=env.IS_ZH?r:i;return Promise.reject(new rtcError_1.default({code:errorCode_1.default.INVALID_OPERATION_ERROR,message:s,advice:o}))}{this.logger.warn("请先关闭屏幕共享"),this.client.apiFrequencyControl({name:"open",code:-1,param:JSON.stringify({reason:"请先关闭屏幕共享",type:a},null," ")}),f({code:-1,param:{reason:"请先关闭屏幕共享",type:a}});let e="Stream.open: invalid operation",t="Stream.open: 操作异常",i="please close screen-sharing first",r="请先关闭屏幕共享",s=env.IS_ZH?t:e,o=env.IS_ZH?r:i;return Promise.reject(new rtcError_1.default({code:errorCode_1.default.INVALID_OPERATION_ERROR,message:s,advice:o}))}}if(e.screenAudio&&(this.mediaHelper.screenAudio.screenAudioTrack||this.mediaHelper.screenAudio.screenAudioSource)){this.logger.warn("请先关闭屏幕共享音频"),f({code:-1,param:{reason:"请先关闭屏幕共享音频",type:a}});let e="Stream.open: invalid operation",t="Stream.open: 操作异常",i="please close screenAudio first",r="请先关闭屏幕共享音频",s=env.IS_ZH?t:e,o=env.IS_ZH?r:i;return Promise.reject(new rtcError_1.default({code:errorCode_1.default.INVALID_OPERATION_ERROR,message:s,advice:o}))}this[a]=!0;const c={videoDeviceId:o,sourceId:n,videoSource:u,screenAudioSource:h,screenVideoSource:p,facingMode:d};c[a]=!0,"screen"===a&&e.screenAudio&&(c.screenAudio=!0,this.screenAudio=!0),await this.mediaHelper.getStream(c),this.screenAudio&&this.audioLevelHelperSlave&&this.mediaHelper.screenAudio.screenAudioStream&&this.audioLevelHelperSlave.updateStream(this.mediaHelper.screenAudio.screenAudioStream),"video"===a&&this.mediaHelper.video.preProcessingEnabled&&this.mediaHelper.enablePreProcessing("video"),"screen"===a&&this.mediaHelper.screen.preProcessingEnabled&&this.mediaHelper.enablePreProcessing("screen"),o&&"video"===a&&(this.cameraId=o),"CONNECTED"!==this.client.adapterRef.connectState.curState?this.logger.log("Stream.open:client不在频道中，无需发布。",c):(this.logger.log("Stream.open:开始发布",c),await(null===(r=this.client.adapterRef._mediasoup)||void 0===r?void 0:r.createProduce(this,a)),e.screenAudio&&await(null===(s=this.client.adapterRef._mediasoup)||void 0===s?void 0:s.createProduce(this,"audioSlave")));break;default:this.logger.error("非法参数")}f({code:0,param:{type:a}})}catch(t){if(["audio","video","screen"].indexOf(a)>-1&&(this[a]=!1,"screen"===a&&e.screenAudio&&(this.screenAudio=!1)),this.logger.log(a+" 开启失败: ",t.name,t.message),f({code:-1,param:{type:a,reason:t.message}}),t.message&&t.message.indexOf("ermission")>-1&&t.message.indexOf("denied")>-1){let e="Please enable media permissions and try again",i="请开启媒体权限重试",r=env.IS_ZH?i:e;return Promise.reject(new rtcError_1.default({code:errorCode_1.default.NOT_SUPPORT_ERROR,message:"open: "+t.message,advice:r}))}return Promise.reject(t)}}async switchScreenStream(e){var t;let i=null,r=!1,s=null,a="";if("video"===(null===(t=e.screenVideoSource)||void 0===t?void 0:t.kind))i=e.screenVideoSource,r=!0;else{i=(await this.mediaHelper.getScreenSource({screen:this.screen})).getVideoTracks()[0]}i?(s=await this.replaceTrack({mediaType:"screen",track:i,external:r}),s?(this.client.adapterRef.logger.log(`switchScreenStream: 已从 ${s.external?"自定义辅流":"屏幕共享"} 切换到 ${r?"自定义辅流":"屏幕共享"}`),s.external||s.oldTrack.stop()):(a="当前没有screen流",this.client.adapterRef.logger.error(`switchScreenStream: 无法切换到${r?"自定义辅流":"屏幕共享"}: ${a}`))):(a="无法获得新的screenVideoTrack",this.client.adapterRef.logger.error("switchScreenStream: ",a)),this.client.adapterRef.instance.apiEventReport("setFunction",{name:"switch_to_custom_screen",oper:"1",value:a||"success"}),this.client.apiFrequencyControl({name:"switchScreenStream",code:a?-1:0,param:JSON.stringify({external:r,reason:a},null," ")})}async close(e){var t,i,r,s;e||(e={type:"all"});const a=await this.client.operationQueue.enqueue({caller:this,method:"close",options:e});let o=e.type,n=null;switch(o){case"audio":if(this.logger.log("关闭mic设备"),!this.audio){this.logger.log("没有开启过麦克风"),n="NOT_OPEN_MIC_YET";break}this.audio=!1,this.mediaHelper.stopStream("audio"),this.getAdapterRef()?this.mediaHelper.getAudioInputTracks().length>0?this.logger.log("Stream.close:关闭音频，保留发布：",o):(this.logger.log("Stream.close:停止发布音频"),await(null===(t=this.client.adapterRef._mediasoup)||void 0===t?void 0:t.destroyProduce("audio"))):this.logger.log("Stream.close:未发布音频，无需停止发布");break;case"screenAudio":if(this.logger.log("关闭屏幕共享音频"),!this.screenAudio){this.logger.log("没有开启过屏幕共享音频"),n="NOT_OPEN_SCREENAUDIO_YET";break}this.screenAudio=!1,this.mediaHelper.stopStream("screenAudio"),this.getAdapterRef()?(this.logger.log("Stream.close:停止发布音频辅流"),await(null===(i=this.client.adapterRef._mediasoup)||void 0===i?void 0:i.destroyProduce("audioSlave"))):this.logger.log("Stream.close:未发布音频，无需停止发布");break;case"video":if(this.logger.log("关闭camera设备"),!this.video){this.logger.log("没有开启过摄像头"),n="NOT_OPEN_CAMERA_YET";break}if(await this.suspendVideoPostProcess(),this._transformedTrack&&this._cameraTrack&&(this._cameraTrack.stop(),this._cameraTrack=null),this._transformedTrack&&(this._transformedTrack.stop(),this._transformedTrack=null),this.video=!1,this.mediaHelper.stopStream("video"),this.mediaHelper.video.preProcessingEnabled&&this.mediaHelper.disablePreProcessing("video",!0),!this._play){a();let e="localStream.close.video: Play is not start",t="localStream.close.video: 播放未开始",i="Please start playing first",r="请先开启播放",s=env.IS_ZH?t:e,o=env.IS_ZH?r:i;throw new rtcError_1.default({code:errorCode_1.default.PLAY_NOT_START_ERROR,message:s,advice:o})}this._play.stopPlayVideoStream(),this.getAdapterRef()?(this.logger.log("Stream.close:停止发布视频"),await(null===(r=this.client.adapterRef._mediasoup)||void 0===r?void 0:r.destroyProduce("video"))):this.logger.log("Stream.close:未发布视频，无需停止发布"),this.replaceTags.isMuted&&(this.replaceTags.isMuted=!1,this.virtualBackground.emptyFrame=!1);break;case"screen":if(this.logger.log("关闭屏幕共享"),!this.screen){this.logger.log("没有开启过屏幕共享"),n="NOT_OPEN_SCREEN_YET";break}if(this.screen=!1,this.mediaHelper.screen.preProcessingEnabled&&this.mediaHelper.disablePreProcessing("screen",!0),this.mediaHelper.stopStream("screen"),!this._play){let e="localStream.close.screen: Play is not start",t="localStream.close.creen: 播放未开始",i="Please start playing first",r="请先开启播放",s=env.IS_ZH?t:e,a=env.IS_ZH?r:i;throw new rtcError_1.default({code:errorCode_1.default.PLAY_NOT_START_ERROR,message:s,advice:a})}this._play.stopPlayScreenStream(),this.getAdapterRef()?(this.logger.log("Stream.close:停止发布辅流"),await(null===(s=this.client.adapterRef._mediasoup)||void 0===s?void 0:s.destroyProduce("screen"))):this.logger.log("Stream.close:未发布辅流，无需停止发布");break;case"all":this.logger.log(`Stream.close:关闭所有设备：audio ${this.audio}, video ${this.video}, screen ${this.screen}, screenAudio ${this.screenAudio}`),this.audio&&await this.close({type:"audio"}),this.video&&await this.close({type:"video"}),this.screen&&await this.close({type:"screen"}),this.screenAudio&&await this.close({type:"screenAudio"}),this.logger.log(`Stream.close:关闭所有设备成功：audio ${this.audio}, video ${this.video}, screen ${this.screen}, screenAudio ${this.screenAudio}`);break;default:this.logger.log("不能识别type"),n="INVALID_ARGUMENTS"}if(n){if(this.client.apiFrequencyControl({name:"close",code:-1,param:JSON.stringify({reason:n,streamID:this.stringStreamID,audio:this.audio,video:this.video,screen:this.screen,type:e.type},null," ")}),"NOT_OPEN_MIC_YET"===n){a();let e="Stream.close: invalid operation",t="Stream.close: 操作异常",i="mic is not open",r="麦克风没有开启",s=env.IS_ZH?t:e,o=env.IS_ZH?r:i;return Promise.reject(new rtcError_1.default({code:errorCode_1.default.INVALID_OPERATION_ERROR,message:s,advice:o}))}if("NOT_OPEN_CAMERA_YET"===n){a();let e="Stream.close: invalid operation",t="Stream.close: 操作异常",i="camera is not open",r="摄像头没有开启",s=env.IS_ZH?t:e,o=env.IS_ZH?r:i;return Promise.reject(new rtcError_1.default({code:errorCode_1.default.INVALID_OPERATION_ERROR,message:s,advice:o}))}if("NOT_OPEN_SCREEN_YET"===n){a();let e="Stream.close: invalid operation",t="Stream.close: 操作异常",i="screen-sharing is not open",r="屏幕共享没有开启",s=env.IS_ZH?t:e,o=env.IS_ZH?r:i;return Promise.reject(new rtcError_1.default({code:errorCode_1.default.INVALID_OPERATION_ERROR,message:s,advice:o}))}{a();let e="Stream.close: invalid operation",t="Stream.close: 操作异常",i="Type is unidentified",r="Type 不能识别",s=env.IS_ZH?t:e,o=env.IS_ZH?r:i;return Promise.reject(new rtcError_1.default({code:errorCode_1.default.INVALID_OPERATION_ERROR,message:s,advice:o}))}}return a(),void this.client.apiFrequencyControl({name:"close",code:0,param:JSON.stringify({reason:n,streamID:this.stringStreamID,audio:this.audio,video:this.video,screen:this.screen,screenAudio:this.screenAudio,type:e.type},null," ")})}async unmuteAudio(){var e,t;this.logger.log("启用音频轨道: ",this.stringStreamID);try{this.getAdapterRef()&&await(null===(e=this.client.adapterRef._mediasoup)||void 0===e?void 0:e.unmuteAudio());const i=this.mediaHelper.audio.audioStream.getAudioTracks();i&&i.length&&i.forEach(e=>{e.enabled=!0}),this.mediaHelper.getAudioInputTracks().forEach(e=>{e.enabled=!0}),(null===(t=this.mediaHelper.audio.webAudio)||void 0===t?void 0:t.gainFilter)&&(this.mediaHelper.audio.webAudio.gainFilter.gain.value=1),this.muteStatus.audio.send=!1,this.client.apiFrequencyControl({name:"unmuteAudio",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1},null," ")})}catch(e){this.logger.error("API调用失败：Stream:unmuteAudio",e.name,e.message,e),this.client.apiFrequencyControl({name:"unmuteAudio",code:-1,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1,reason:e.message},null," ")})}}async muteAudio(){var e,t;this.logger.log("禁用音频轨道: ",this.stringStreamID);try{this.getAdapterRef()&&await(null===(e=this.client.adapterRef._mediasoup)||void 0===e?void 0:e.muteAudio());const i=this.mediaHelper.audio.audioStream.getAudioTracks();i&&i.length&&i.forEach(e=>{e.enabled=!1}),this.mediaHelper.getAudioInputTracks().forEach(e=>{e.enabled=!1}),(null===(t=this.mediaHelper.audio.webAudio)||void 0===t?void 0:t.gainFilter)&&(this.mediaHelper.audio.webAudio.gainFilter.gain.value=0),this.muteStatus.audio.send=!0,this.client.apiFrequencyControl({name:"muteAudio",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1},null," ")})}catch(e){this.logger.error("API调用失败：Stream:muteAudio",e.name,e.message,e),this.client.apiFrequencyControl({name:"muteAudio",code:-1,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1,reason:e.message},null," ")})}}async unmuteAudioSlave(){var e;this.logger.log("启用音频辅流轨道: ",this.stringStreamID);try{this.getAdapterRef()&&await(null===(e=this.client.adapterRef._mediasoup)||void 0===e?void 0:e.unmuteAudioSlave());const t=this.mediaHelper.screenAudio.screenAudioStream.getAudioTracks();t&&t.length&&t.forEach(e=>{e.enabled=!0}),this.muteStatus.audioSlave.send=!1,this.client.apiFrequencyControl({name:"unmuteAudioSlave",code:0,param:JSON.stringify({streamID:this.stringStreamID},null," ")})}catch(e){this.logger.error("API调用失败：Stream:unmuteAudio",e.name,e.message,e),this.client.apiFrequencyControl({name:"unmuteAudioSlave",code:-1,param:JSON.stringify({streamID:this.stringStreamID,reason:e},null," ")})}}async muteAudioSlave(){var e;this.logger.log("禁用音频辅流轨道: ",this.stringStreamID);try{this.getAdapterRef()&&await(null===(e=this.client.adapterRef._mediasoup)||void 0===e?void 0:e.muteAudioSlave());const t=this.mediaHelper.screenAudio.screenAudioStream.getAudioTracks();t&&t.length&&t.forEach(e=>{e.enabled=!1}),this.muteStatus.audioSlave.send=!0,this.client.apiFrequencyControl({name:"muteAudioSlave",code:0,param:JSON.stringify({streamID:this.stringStreamID},null," ")})}catch(e){this.logger.error("API调用失败：Stream:muteAudioSlave",e.name,e.message,e),this.client.apiFrequencyControl({name:"muteAudioSlave",code:-1,param:JSON.stringify({streamID:this.stringStreamID,reason:e},null," ")})}}hasAudio(){return this.mediaHelper.getAudioInputTracks().length>0}hasAudioSlave(){return this.mediaHelper.getAudioSlaveInputTracks().length>0}getAudioLevel(e="audio"){var t,i;if("audio"===e){if(!this.audioLevelHelper&&this.mediaHelper.audio.audioStream.getAudioTracks().length){const e=webAudio_1.getAudioContext();e&&e.audioWorklet&&e.audioWorklet.addModule||(this.logger.error("getAudioLevel is not supported in this browser"),this.client.safeEmit("error","AUDIOLEVEL_NOT_SUPPORTED")),this.audioLevelHelper=new audioLevel_1.AudioLevel({stream:this.mediaHelper.audio.audioStream,logger:this.logger})}return(null===(t=this.audioLevelHelper)||void 0===t?void 0:t.getAudioLevel())||0}return!this.audioLevelHelperSlave&&this.mediaHelper.screenAudio.screenAudioStream.getAudioTracks().length&&(this.audioLevelHelperSlave=new audioLevel_1.AudioLevel({stream:this.mediaHelper.screenAudio.screenAudioStream,logger:this.logger})),(null===(i=this.audioLevelHelperSlave)||void 0===i?void 0:i.getAudioLevel())||0}getAudioSlaveLevel(){return this.mediaHelper.getGain()}setAudioProfile(e){this.logger.log("设置音频属性: ",e),this.audioProfile=e,this.client.apiFrequencyControl({name:"setAudioProfile",code:0,param:{streamID:this.stringStreamID,profile:e}})}setAudioVolume(e=100){let t=null;if(Number.isInteger(e)?e<0?e=0:e>100?e=255:e*=2.55:(this.logger.log("volume 为 0 - 100 的整数"),t="INVALID_ARGUMENTS"),this.logger.log(`调节${this.stringStreamID}的音量大小: ${e}`),this.audio){if(!this._play){let e="localStream.setAudioVolume: Play is not start",t="localStream.setAudioVolume: 播放未开始",i="Please start playing first",r="请先开启播放",s=env.IS_ZH?t:e,a=env.IS_ZH?r:i;throw new rtcError_1.default({code:errorCode_1.default.PLAY_NOT_START_ERROR,message:s,advice:a})}this._play.setPlayVolume(e)}else this.logger.log("没有音频流，请检查是否有发布过音频"),t="INVALID_OPERATION";if(t)return this.client.apiFrequencyControl({name:"setAudioVolume",code:-1,param:{streamID:this.stringStreamID,isRemote:!1,volume:e,reason:t}}),t;this.client.apiFrequencyControl({name:"setAudioVolume",code:0,param:{streamID:this.stringStreamID,isRemote:!1,volume:e}})}setCaptureVolume(e,t){let i=null;if(Number.isInteger(e)?e<0?e=0:e>100&&(e=100):(this.logger.log("volume 为 0 - 100 的整数"),i="INVALID_ARGUMENTS"),this.logger.log(`调节${this.stringStreamID}的音量大小: ${e}`),this.mediaHelper.audio.audioRoutingEnabled||this.mediaHelper.enableAudioRouting(),this.mediaHelper.setGain(e/100,t),i)return this.client.apiFrequencyControl({name:"setCaptureVolume",code:-1,param:JSON.stringify({streamID:this.stringStreamID,volume:e,audioType:t,reason:i},null," ")}),i;this.client.apiFrequencyControl({name:"setCaptureVolume",code:0,param:JSON.stringify({streamID:this.stringStreamID,audioType:t,volume:e},null," ")})}async setAudioOutput(e,t){if(this._play){try{await this._play.setAudioOutput(e)}catch(e){throw t&&setTimeout(()=>{t(e)},0),this.logger.error("设置输出设备失败",e.name,e.message),e}t&&setTimeout(t,0)}this.client.apiFrequencyControl({name:"setAudioOutput",code:0,param:JSON.stringify({streamID:this.stringStreamID,deviceId:e,isRemote:!1},null," ")})}async switchDevice(e,t){this.logger.log(`切换媒体输入设备: ${e}, deviceId: ${t}`);let i={};if(this.inSwitchDevice[e]){this.logger.error("switchDevice：正在切换中，重复",e);let t="switchDevice: invalid operation",i="switchDevice: 操作异常",r="switching "+e,s="正在切换中 "+e,a=env.IS_ZH?i:t,o=env.IS_ZH?s:r;return Promise.reject(new rtcError_1.default({code:errorCode_1.default.INVALID_OPERATION_ERROR,message:a,advice:o}))}if(this.inSwitchDevice[e]=!0,"audio"===e){if(this.client.adapterRef.isAudioBanned){let e="switchDevice: audio is banned by server",t="switchDevice: audio 被服务器禁言",i=env.IS_ZH?t:e;return Promise.reject(new rtcError_1.default({code:errorCode_1.default.BANNED_BY_SERVER,message:i}))}const r=this.mediaHelper.audio.micTrack;if("live"===(null==r?void 0:r.readyState)&&(null==r?void 0:r.getSettings().deviceId)===t)return this.logger.log("切换相同的麦克风设备，不处理"),this.inSwitchDevice[e]=!1,Promise.resolve();if(!this.hasAudio()){this.logger.log("当前没有开启音频输入设备，无法切换"),this.inSwitchDevice[e]=!1;let t="switchDevice: invalid operation",i="switchDevice: 操作异常",r="no audio input device",s="当前没有开启音频输入设备，无法切换",a=env.IS_ZH?i:t,o=env.IS_ZH?s:r;return Promise.reject(new rtcError_1.default({code:errorCode_1.default.INVALID_OPERATION_ERROR,message:a,advice:o}))}if(this.audioSource){this.logger.log("自定义音频输入不支持，无法切换"),this.inSwitchDevice[e]=!1;let t="switchDevice: invalid operation",i="switchDevice: 操作异常",r="user-defined audio is not support",s="自定义音频输入不支持，无法切换",a=env.IS_ZH?i:t,o=env.IS_ZH?s:r;return Promise.reject(new rtcError_1.default({code:errorCode_1.default.INVALID_OPERATION_ERROR,message:a,advice:o}))}this.mediaHelper.audio.micConstraint&&this.mediaHelper.audio.micConstraint.audio?this.mediaHelper.audio.micConstraint.audio.deviceId={exact:t}:this.mediaHelper.audio.micConstraint?(this.mediaHelper.audio.micConstraint.audio={},this.mediaHelper.audio.micConstraint.audio.deviceId={exact:t}):this.mediaHelper.audio.micConstraint={audio:{deviceId:{exact:t}}},i=this.mediaHelper.audio.micConstraint,this.microphoneId=t}else{if("video"!==e){this.logger.error("switchDevice: unknown type "+e);let t="switchDevice: invalid operation",i="switchDevice: 操作异常",r="unknown type "+e,s="未知 type "+e,a=env.IS_ZH?i:t,o=env.IS_ZH?s:r;return Promise.reject(new rtcError_1.default({code:errorCode_1.default.INVALID_OPERATION_ERROR,message:a,advice:o}))}{if(this.client.adapterRef.isVideoBanned){let e="switchDevice: video is banned by server",t="switchDevice: video 被服务器禁言",i=env.IS_ZH?t:e;return Promise.reject(new rtcError_1.default({code:errorCode_1.default.BANNED_BY_SERVER,message:i}))}const r=this.mediaHelper.video.cameraTrack;if(await this.suspendVideoPostProcess(),this._transformedTrack&&(this._transformedTrack.stop(),this._transformedTrack=null),"live"===(null==r?void 0:r.readyState)&&(null==r?void 0:r.getSettings().deviceId)===t)return this.logger.log("切换相同的摄像头设备，不处理"),this.inSwitchDevice[e]=!1,Promise.resolve();if(!this.hasVideo()){this.logger.log("当前没有开启视频输入设备，无法切换"),this.inSwitchDevice[e]=!1,this.client.apiFrequencyControl({name:"switchDevice",code:-1,param:{reason:"INVALID_OPERATION: 当前没有开启视频输入设备，无法切换",type:e,deviceId:t,streamID:this.stringStreamID}}),this.client.apiFrequencyControl({name:"_trackSettings",code:0,param:JSON.stringify(this.mediaHelper.getTrackSettings())});let i="switchDevice: invalid operation",r="switchDevice: 操作异常",s="no video input device",a="当前没有开启视频输入设备，无法切换",o=env.IS_ZH?r:i,n=env.IS_ZH?a:s;return Promise.reject(new rtcError_1.default({code:errorCode_1.default.INVALID_OPERATION_ERROR,message:o,advice:n}))}if(this.videoSource){this.logger.log("自定义视频输入不支持，无法切换"),this.inSwitchDevice[e]=!1,this.client.apiFrequencyControl({name:"switchDevice",code:-1,param:{reason:"INVALID_OPERATION: 自定义视频输入不支持，无法切换",type:e,deviceId:t,streamID:this.stringStreamID}}),this.client.apiFrequencyControl({name:"_trackSettings",code:0,param:JSON.stringify(this.mediaHelper.getTrackSettings())});let i="switchDevice: invalid operation",r="switchDevice: 操作异常",s="user-defined video is not support",a="自定义视频输入不支持，无法切换",o=env.IS_ZH?r:i,n=env.IS_ZH?a:s;return Promise.reject(new rtcError_1.default({code:errorCode_1.default.INVALID_OPERATION_ERROR,message:o,advice:n}))}this.mediaHelper.video.cameraConstraint&&this.mediaHelper.video.cameraConstraint.video&&(this.mediaHelper.video.cameraConstraint.video.deviceId={exact:t},i=this.mediaHelper.video.cameraConstraint),this.cameraId=t,this.replaceTags.isMuted&&(this.replaceTags.isMuted=!1,this.virtualBackground.emptyFrame=!1)}}try{const r=this.mediaHelper.video.preProcessingEnabled;r&&this.mediaHelper.disablePreProcessing("video"),await this.mediaHelper.getSecondStream(i),this.inSwitchDevice[e]=!1,r&&this.mediaHelper.enablePreProcessing("video"),"video"===e&&(this.client.apiFrequencyControl({name:"switchDevice",code:0,param:{type:e,deviceId:t,streamID:this.stringStreamID}}),await this.resumeVideoPostProcess()),this.client.apiFrequencyControl({name:"_trackSettings",code:0,param:JSON.stringify(this.mediaHelper.getTrackSettings())})}catch(i){return this.logger.error("API调用失败：Stream:switchDevice",i.name,i.message,i),this.inSwitchDevice[e]=!1,"video"===e&&this.client.apiFrequencyControl({name:"switchDevice",code:-1,param:{reason:i.message,type:e,deviceId:t,streamID:this.stringStreamID}}),this.client.apiFrequencyControl({name:"_trackSettings",code:0,param:JSON.stringify(this.mediaHelper.getTrackSettings())}),Promise.reject(i)}}async unmuteVideo(){var e,t;this.logger.log(`启用 ${this.stringStreamID} 的视频轨道`);try{if(this.virtualBackground&&(this.virtualBackground.emptyFrame=!1),this.getAdapterRef()&&(null===(e=this.client.adapterRef._mediasoup)||void 0===e||e.unmuteVideo()),this.mediaHelper.video.videoSource&&(this.mediaHelper.video.videoSource.enabled=!0),this.mediaHelper.video.cameraTrack&&(this.mediaHelper.video.cameraTrack.enabled=!0),this.videoPostProcess.sourceTrack&&(this.videoPostProcess.sourceTrack.enabled=!0),env.IS_SAFARI){const e=null===(t=this._play)||void 0===t?void 0:t.getVideoDom;e&&(e.style.backgroundColor="")}this.muteStatus.video.send=!1,this.client.apiFrequencyControl({name:"unmuteVideo",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1},null," ")}),this.replaceTags.isMuted=!1}catch(e){this.logger.error("API调用失败：Stream:unmuteVideo",e.name,e.message,e),this.client.apiFrequencyControl({name:"unmuteVideo",code:-1,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1,reason:e.message},null," ")})}}async muteVideo(){var e,t;this.logger.log(`禁用 ${this.stringStreamID} 的视频轨道`);try{if(this.virtualBackground&&(this.virtualBackground.emptyFrame=!0),env.IS_SAFARI){const t=null===(e=this._play)||void 0===e?void 0:e.getVideoDom;t&&(t.style.backgroundColor="black")}this.getAdapterRef()&&await(null===(t=this.client.adapterRef._mediasoup)||void 0===t?void 0:t.muteVideo()),this.mediaHelper.video.videoSource&&(this.mediaHelper.video.videoSource.enabled=!1),this.mediaHelper.video.cameraTrack&&(this.mediaHelper.video.cameraTrack.enabled=!1),this.videoPostProcess.sourceTrack&&(this.videoPostProcess.sourceTrack.enabled=!1),this.muteStatus.video.send=!0,this.client.apiFrequencyControl({name:"muteVideo",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1},null," ")}),this.replaceTags.isMuted=!0}catch(e){this.logger.error("API调用失败：Stream:muteVideo",e.name,e.message,e),this.client.apiFrequencyControl({name:"muteVideo",code:-1,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1,reason:e.message},null," ")}),this.replaceTags.isMuted=!1}}async unmuteScreen(){var e;this.logger.log(`启用 ${this.stringStreamID} 的视频轨道`);try{this.getAdapterRef()&&(null===(e=this.client.adapterRef._mediasoup)||void 0===e||e.unmuteScreen()),this.mediaHelper.screen.screenVideoTrack&&(this.mediaHelper.screen.screenVideoTrack.enabled=!0),this.mediaHelper.screen.screenVideoSource&&(this.mediaHelper.screen.screenVideoSource.enabled=!0),this.muteStatus.screen.send=!1,this.client.apiFrequencyControl({name:"unmuteScreen",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1},null," ")})}catch(e){this.logger.error("API调用失败：Stream:unmuteScreen",e.name,e.message,e),this.client.apiFrequencyControl({name:"unmuteScreen",code:-1,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1,reason:e.message},null," ")})}}async muteScreen(){var e;this.logger.log(`禁用 ${this.stringStreamID} 的辅流轨道`);try{this.getAdapterRef()&&await(null===(e=this.client.adapterRef._mediasoup)||void 0===e?void 0:e.muteScreen()),this.mediaHelper.screen.screenVideoSource&&(this.mediaHelper.screen.screenVideoSource.enabled=!1),this.mediaHelper.screen.screenVideoTrack&&(this.mediaHelper.screen.screenVideoTrack.enabled=!1),this.muteStatus.screen.send=!0,this.client.apiFrequencyControl({name:"muteScreen",code:0,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1},null," ")})}catch(e){this.logger.error("API调用失败：Stream:muteScreen",e,...arguments),this.client.apiFrequencyControl({name:"muteScreen",code:-1,param:JSON.stringify({streamID:this.stringStreamID,isRemote:!1,reason:e.message},null," ")})}}hasVideo(){return this.logger.log("获取视频 flag"),this.mediaHelper.video.videoStream.getVideoTracks().length>0}async setVideoProfile(e){e.resolution>-1&&(this.videoProfile.resolution=e.resolution),e.frameRate>-1&&(this.videoProfile.frameRate=e.frameRate),this.mediaHelper.video.captureConfig.high=this.mediaHelper.convert(this.videoProfile),this.mediaHelper.video.encoderConfig.high.maxBitrate=this.getVideoBW()||this.mediaHelper.video.encoderConfig.high.maxBitrate,this.logger.log(`setVideoProfile ${JSON.stringify(e)} 视频采集参数 ${JSON.stringify(this.mediaHelper.video.captureConfig.high)} 编码参数 ${JSON.stringify(this.mediaHelper.video.encoderConfig.high)}`),this.client.adapterRef.channelInfo.sessionConfig.maxVideoQuality=videoQuality_1.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_1080p,this.client.adapterRef.channelInfo.sessionConfig.videoQuality=this.videoProfile.resolution,this.client.adapterRef.channelInfo.sessionConfig.videoFrameRate=this.videoProfile.frameRate;let t=this.mediaHelper.video.cameraTrack;null==t||t.getSettings();if(this.videoPostProcess.hasAnyTask&&(this.logger.log("setVideoProfile 侦测到美颜在开启状态"),t=this.videoPostProcess.sourceTrack),t)try{this.logger.log(`setVideoProfile 尝试动态修改分辨率【${t.label}】`),await applyResolution_1.applyResolution({track:t,targetWidth:this.mediaHelper.video.captureConfig.high.width,targetHeight:this.mediaHelper.video.captureConfig.high.height,keepAspectRatio:parameters_1.getParameters().keepAspectRatio,logger:this.logger});const e=t.getSettings();e.width&&e.height&&(this.mediaHelper.video.cameraConstraint.video.width=e.width,this.mediaHelper.video.cameraConstraint.video.height=e.height)}catch(e){this.logger.error("无法使用动态分辨率:",e.name,e.message)}const i=this.getSender("video","high");if(i){const e=i.getParameters(),t=e.encodings&&e.encodings[0];if((null==t?void 0:t.maxBitrate)!==this.mediaHelper.video.encoderConfig.high.maxBitrate){this.logger.log(`setVideoProfile调整上行码率 ${t.maxBitrate} => ${this.mediaHelper.video.encoderConfig.high.maxBitrate}`),t.maxBitrate=this.mediaHelper.video.encoderConfig.high.maxBitrate;try{i.setParameters(e)}catch(e){this.logger.error("setVideoProfile无法调整上行码率",e.name,e.message)}}else this.logger.log("setVideoProfile无需调整上行码率 "+(null==t?void 0:t.maxBitrate))}this.client.apiFrequencyControl({name:"setVideoProfile",code:0,param:Object.assign({streamID:this.stringStreamID},e)}),this.replaceCanvas()}setVideoEncoderConfiguration(e){if(e.mediaType=e.mediaType||"video",e.streamType=e.streamType||"high",this.logger.log("自定义视频编码配置",e),this.mediaHelper[e.mediaType].encoderConfig[e.streamType]){if(e.maxBitrate){const t=1e3*e.maxBitrate;this.logger.log(`setVideoEncoderConfiguration:设置maxBitrate ${e.mediaType} ${e.streamType} ${this.mediaHelper[e.mediaType].encoderConfig[e.streamType].maxBitrate} => ${t}`),this.mediaHelper[e.mediaType].encoderConfig[e.streamType].maxBitrate=t}else this.logger.log("setVideoEncoderConfiguration:未设定maxBitrate。保留目前的值：",e.mediaType,e.streamType,this.mediaHelper[e.mediaType].encoderConfig[e.streamType].maxBitrate);"string"==typeof e.contentHint?(this.logger.log(`setVideoEncoderConfiguration: 应用 contentHint ${e.mediaType} ${e.streamType} ${this.mediaHelper[e.mediaType].encoderConfig[e.streamType].contentHint} => ${e.contentHint}`),this.mediaHelper[e.mediaType].encoderConfig[e.streamType].contentHint=e.contentHint):this.logger.log("setVideoEncoderConfiguration: 未设定 contentHint。保留目前的值：",e.mediaType,e.streamType,this.mediaHelper[e.mediaType].encoderConfig[e.streamType].contentHint)}else this.logger.error("无法识别的媒体类型：",e.mediaType,e.streamType);this.getSender(e.mediaType,e.streamType)&&this.applyEncoderConfig(e.mediaType,e.streamType),this.client.apiFrequencyControl({name:"setVideoEncoderConfiguration",code:0,param:{streamID:this.stringStreamID,options:e}})}async replaceTrack(e){let t,i=!1,r=!1,s="video";if("screen"===e.mediaType)r=this.mediaHelper.screen.preProcessingEnabled,s=e.mediaType,r&&this.mediaHelper.disablePreProcessing("screen"),this.mediaHelper.screen.screenVideoTrack?(t=this.mediaHelper.screen.screenVideoTrack,this.mediaHelper.screen.screenVideoTrack=null):this.mediaHelper.screen.screenVideoSource&&(i=!0,t=this.mediaHelper.screen.screenVideoSource,this.mediaHelper.screen.screenVideoSource=null),t&&(e.external?this.mediaHelper.screen.screenVideoSource=e.track:this.mediaHelper.screen.screenVideoTrack=e.track,gum_1.emptyStreamWith(this.mediaHelper.screen.screenVideoStream,e.track),gum_1.emptyStreamWith(this.mediaHelper.screen.renderStream,e.track),this.mediaHelper.screen.screenVideoStream.getVideoTracks().length&&"string"==typeof this.mediaHelper.screen.encoderConfig.high.contentHint&&this.mediaHelper.screen.screenVideoStream.getVideoTracks()[0].contentHint!==this.mediaHelper.screen.encoderConfig.high.contentHint&&(this.logger.log("应用 contentHint screen high",this.mediaHelper.screen.encoderConfig.high.contentHint),this.mediaHelper.screen.screenVideoStream.getVideoTracks()[0].contentHint=this.mediaHelper.screen.encoderConfig.high.contentHint));else if("video"===e.mediaType){const r=this.mediaHelper.video.preProcessingEnabled;s=e.mediaType,r&&this.mediaHelper.disablePreProcessing("video"),this.mediaHelper.video.cameraTrack?(t=this.mediaHelper.video.cameraTrack,this.mediaHelper.video.cameraTrack=null):this.mediaHelper.video.videoSource&&(i=!0,t=this.mediaHelper.video.videoSource,this.mediaHelper.video.videoSource=null),t&&(e.external?this.mediaHelper.video.videoSource=e.track:this.mediaHelper.video.cameraTrack=e.track,gum_1.emptyStreamWith(this.mediaHelper.video.videoStream,e.track),gum_1.emptyStreamWith(this.mediaHelper.video.renderStream,e.track),this.mediaHelper.video.videoStream.getVideoTracks().length&&"string"==typeof this.mediaHelper.video.encoderConfig.high.contentHint&&this.mediaHelper.video.videoStream.getVideoTracks()[0].contentHint!==this.mediaHelper.video.encoderConfig.high.contentHint&&(this.logger.log("应用 contentHint video high",this.mediaHelper.video.encoderConfig.high.contentHint),this.mediaHelper.video.videoStream.getVideoTracks()[0].contentHint=this.mediaHelper.video.encoderConfig.high.contentHint),this.mediaHelper.video.preProcessingEnabled&&this.mediaHelper.enablePreProcessing("video"))}if(!t)return this.logger.error(`replaceTrack ${e.mediaType} 当前没有可替换的流`),null;if(this.logger.log(`replaceTrack ${e.mediaType}【external: ${i} ${t.label}】=>【external: ${e.external} ${e.track.label}】`),gum_1.watchTrack(e.track),this.mediaHelper.listenToTrackEnded(e.track),r)this.mediaHelper.enablePreProcessing(s);else{const t=this.getSender(e.mediaType,"high");t&&(t.replaceTrack(e.track),this.logger.log(`replaceTrack ${e.mediaType} 成功替换上行`))}return this.replaceTags.isMuted&&this.mediaHelper.video.cameraTrack&&(this.mediaHelper.video.cameraTrack.enabled=!1),{oldTrack:t,external:i}}hasScreen(){return this.mediaHelper.screen.screenVideoStream.getVideoTracks().length>0}setScreenProfile(e){e.frameRate>-1&&(this.screenProfile.frameRate=e.frameRate),e.resolution>-1&&(this.screenProfile.resolution=e.resolution),this.mediaHelper.screen.captureConfig.high=this.mediaHelper.convert(this.screenProfile),this.mediaHelper.screen.encoderConfig.high.maxBitrate=this.getScreenBW(),this.logger.log(`setScreenProfile ${JSON.stringify(e)} 屏幕共享采集参数 ${JSON.stringify(this.mediaHelper.screen.captureConfig.high)} 编码参数 ${JSON.stringify(this.mediaHelper.screen.encoderConfig.high)}`),this.client.adapterRef.channelInfo.sessionConfig.screenQuality=e,this.mediaHelper.screen.screenVideoTrack&&applyResolution_1.applyResolution({track:this.mediaHelper.screen.screenVideoTrack,targetWidth:this.mediaHelper.screen.captureConfig.high.width,targetHeight:this.mediaHelper.screen.captureConfig.high.height,keepAspectRatio:parameters_1.getParameters().keepAspectRatio,logger:this.logger});const t=this.getSender("screen","high");if(t){const e=t.getParameters(),i=e.encodings&&e.encodings[0];if((null==i?void 0:i.maxBitrate)!==this.mediaHelper.screen.encoderConfig.high.maxBitrate){this.logger.log(`setScreenProfile 调整上行码率 ${i.maxBitrate} => ${this.mediaHelper.screen.encoderConfig.high.maxBitrate}`),i.maxBitrate=this.mediaHelper.screen.encoderConfig.high.maxBitrate;try{t.setParameters(e)}catch(e){this.logger.error("setScreenProfile 无法调整上行码率",e.name,e.message)}}else this.logger.log("setScreenProfile 无需调整上行码率 "+(null==i?void 0:i.maxBitrate))}this.client.apiFrequencyControl({name:"setScreenProfile",code:0,param:Object.assign({streamID:this.stringStreamID},e)})}getSender(e,t){var i,r,s;const a=null===(s=null===(r=null===(i=this.getAdapterRef())||void 0===i?void 0:i._mediasoup)||void 0===r?void 0:r._sendTransport)||void 0===s?void 0:s.handler._pc;let o=null;return a&&("audio"===e&&(o="high"===t?a.audioSender:null),"video"===e?o="high"===t?a.videoSender:a.videoSenderLow:"screen"===e?o="high"===t?a.screenSender:a.screenSenderLow:"audioSlave"===e&&(o=a.audioSlaveSender)),o||null}applyEncoderConfig(e,t){let i=this.mediaHelper[e].encoderConfig[t].maxBitrate;if(!i)return;let r=this.getSender(e,t);if(!r)return void this.logger.error("localStream.applyEncoderConfig: cannot find sender for ",e,t);let s=this.mediaHelper[e].encoderConfig[t].contentHint;"string"==typeof s&&r.track&&r.track.contentHint!==s&&(this.logger.log(`applyEncoderConfig 应用 contentHint：${e} ${t} ${r.track.contentHint} => ${s}`),r.track.contentHint=s);const a=r.getParameters();let o=void 0;a.encodings&&a.encodings.length?(o=a.encodings[0].maxBitrate,a.encodings[0].maxBitrate=i):a.encodings=[{maxBitrate:i}],r.setParameters(a).then(()=>{this.logger.log(`最大编码码率：${e} ${t} ${o?o+"=>":""}${i}`)}).catch(r=>{this.logger.error(`应用最大编码码率失败：${e} ${t} ${i}`,a,r.name,r.message,r)})}getVideoBW(){if(!this.videoProfile){let e="getVideoBW: videoProfile is not found",t="getVideoBW: 未找到 videoProfile",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=env.IS_ZH?t:e,a=env.IS_ZH?r:i;throw new rtcError_1.default({code:errorCode_1.default.NOT_FOUND_ERROR,message:s,advice:a})}return this.videoProfile.resolution==videoQuality_1.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_180p?3e5:this.videoProfile.resolution==videoQuality_1.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_480p?8e5:this.videoProfile.resolution==videoQuality_1.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_720p?12e5:this.videoProfile.resolution==videoQuality_1.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_1080p?15e5:(this.logger.warn("发现不支持的 NERTC_VIDEO_QUALITY "+this.videoProfile.resolution),8e5)}getScreenBW(){if(!this.screenProfile){let e="getScreenBW: screenProfile is not found",t="getScreenBW: 未找到 screenProfile",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=env.IS_ZH?t:e,a=env.IS_ZH?r:i;throw new rtcError_1.default({code:errorCode_1.default.NOT_FOUND_ERROR,message:s,advice:a})}return this.screenProfile.resolution==videoQuality_1.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_180p?3e5:this.screenProfile.resolution==videoQuality_1.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_480p?8e5:this.screenProfile.resolution==videoQuality_1.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_720p?12e5:(this.screenProfile.resolution==videoQuality_1.NERTC_VIDEO_QUALITY.VIDEO_QUALITY_1080p||this.logger.warn("发现不支持的 NERTC_VIDEO_QUALITY "+this.screenProfile.resolution),15e5)}async takeSnapshot(e){if(!this.video&&!this.screen)return this.logger.log("没有视频流，请检查是否有 发布 过视频"),this.client.apiFrequencyControl({name:"takeSnapshot",code:-1,param:JSON.stringify(Object.assign(Object.assign({streamID:this.stringStreamID,isRemote:!1},e),{reason:"没有视频流，请检查是否有 发布 过视频"}),null," ")}),"INVALID_OPERATION";if(!this._play){let e="localStream.takeSnapshot: Play is not start",t="localStream.takeSnapshot: 播放未开始",i="Please start playing first",r="请先开启播放",s=env.IS_ZH?t:e,a=env.IS_ZH?r:i;throw new rtcError_1.default({code:errorCode_1.default.PLAY_NOT_START_ERROR,message:s,advice:a})}await this._play.takeSnapshot(e,this.streamID),this.client.apiFrequencyControl({name:"takeSnapshot",code:0,param:Object.assign({streamID:this.stringStreamID,isRemote:!1},e)})}takeSnapshotBase64(e){if(this.video||this.screen){if(!this._play){let e="localStream.takeSnapshotBase64: Play is not start",t="localStream.takeSnapshotBase64: 播放未开始",i="Please start playing first",r="请先开启播放",s=env.IS_ZH?t:e,a=env.IS_ZH?r:i;throw new rtcError_1.default({code:errorCode_1.default.PLAY_NOT_START_ERROR,message:s,advice:a})}let t=this._play.takeSnapshotBase64(e);return this.client.apiFrequencyControl({name:"takeSnapshotBase64",code:0,param:Object.assign({streamID:this.stringStreamID,isRemote:!1},e)}),t}return this.logger.log("没有视频流，请检查是否有 发布 过视频"),this.client.apiFrequencyControl({name:"takeSnapshotBase64",code:-1,param:JSON.stringify(Object.assign(Object.assign({streamID:this.stringStreamID,isRemote:!1},e),{reason:"没有视频流，请检查是否有 发布 过视频"}),null," ")}),"INVALID_OPERATION"}async startMediaRecording(e){const t=[];switch(e.type){case"screen":t.push(this.mediaHelper.screen.screenVideoStream),t.push(this.mediaHelper.audio.audioStream);break;case"camera":case"video":t.push(this.mediaHelper.video.videoStream),t.push(this.mediaHelper.audio.audioStream);break;case"audio":if(t.push(this.mediaHelper.audio.audioStream),this.client.adapterRef.remoteStreamMap)for(var i in this.client.adapterRef.remoteStreamMap){const e=this.client.adapterRef.remoteStreamMap[i];t.push(e.mediaHelper.audio.audioStream)}}if(0!==t.length){if(!this._record||!this.streamID||!t){let e="localStream_startMediaRecording: invalid parameter when start recording",t="localStream_startMediaRecording: 开始录制时参数异常",i="Please contact CommsEase technical support",r="请联系云信技术支持",s=env.IS_ZH?t:e,a=env.IS_ZH?r:i;throw new rtcError_1.default({code:errorCode_1.default.RECORDING_ERROR,message:s,advice:a})}return this._record&&this._record.start({uid:"string"===this.client.adapterRef.channelInfo.uidType?this.stringStreamID:this.streamID,type:e.type,reset:e.reset,stream:t})}this.logger.log("没有没发现要录制的媒体流")}stopMediaRecording(e){if(!this._record){let e="localStream.stopMediaRecording: recording is not start",t="localStream.stopMediaRecording: 录制未开始",i="Please start recording first",r="请先开启录制",s=env.IS_ZH?t:e,a=env.IS_ZH?r:i;throw new rtcError_1.default({code:errorCode_1.default.RECORDING_NOT_START_ERROR,message:s,advice:a})}return this._record.stop({})}playMediaRecording(e){if(!this._record){let e="localStream.playMediaRecording: recording is not start",t="localStream.playMediaRecording: 录制未开始",i="Please start recording first",r="请先开启录制",s=env.IS_ZH?t:e,a=env.IS_ZH?r:i;throw new rtcError_1.default({code:errorCode_1.default.RECORDING_NOT_START_ERROR,message:s,advice:a})}return this._record.play(e.view)}listMediaRecording(){let e=[];if(!this._record){let e="localStream.listMediaRecording: recording is not start",t="localStream.listMediaRecording: 录制未开始",i="Please start recording first",r="请先开启录制",s=env.IS_ZH?t:e,a=env.IS_ZH?r:i;throw new rtcError_1.default({code:errorCode_1.default.RECORDING_NOT_START_ERROR,message:s,advice:a})}const t=this._record.getRecordStatus();return"init"!==t.status&&e.push(t),e}cleanMediaRecording(e){if(!this._record){let e="localStream.cleanMediaRecording: recording is not start",t="localStream.cleanMediaRecording: 录制未开始",i="Please start recording first",r="请先开启录制",s=env.IS_ZH?t:e,a=env.IS_ZH?r:i;throw new rtcError_1.default({code:errorCode_1.default.RECORDING_NOT_START_ERROR,message:s,advice:a})}return this._record.clean()}downloadMediaRecording(e){if(!this._record){let e="localStream.downloadMediaRecording: recording is not start",t="localStream.downloadMediaRecording: 录制未开始",i="Please start recording first",r="请先开启录制",s=env.IS_ZH?t:e,a=env.IS_ZH?r:i;throw new rtcError_1.default({code:errorCode_1.default.RECORDING_NOT_START_ERROR,message:s,advice:a})}return this._record.download()}startAudioMixing(e){if(this.client.adapterRef.isAudioBanned){let e="startAudioMixing: audio is banned by server",t="startAudioMixing: audio 被服务器禁言",i=env.IS_ZH?t:e;return Promise.reject(new rtcError_1.default({code:errorCode_1.default.BANNED_BY_SERVER,message:i}))}return this.logger.log("开始伴音"),this.mediaHelper.startAudioMixing(e)}stopAudioMixing(){return this.logger.log("停止伴音"),this.mediaHelper.stopAudioMixing()}pauseAudioMixing(){return this.logger.log("暂停伴音"),this.mediaHelper.pauseAudioMixing()}resumeAudioMixing(){return this.logger.log("恢复伴音"),this.mediaHelper.resumeAudioMixing()}adjustAudioMixingVolume(e){return this.logger.log("调节伴音音量:",e),this.mediaHelper.setAudioMixingVolume(e)}getAudioMixingDuration(){return this.logger.log("获取伴音总时长"),this.mediaHelper.getAudioMixingTotalTime()}getAudioMixingCurrentPosition(){return this.mediaHelper.getAudioMixingPlayedTime()}setAudioMixingPosition(e){return this.logger.log("设置伴音音频文件的播放位置:",e),this.mediaHelper.setAudioMixingPlayTime(e)}async playEffect(e){if(this.client.adapterRef.isAudioBanned){let e="playEffect: audio is banned by server",t="playEffect: audio 被服务器禁言",i=env.IS_ZH?t:e;return Promise.reject(new rtcError_1.default({code:errorCode_1.default.BANNED_BY_SERVER,message:i}))}return this.logger.log("开始播放音效: ",JSON.stringify(e,null," ")),this.mediaHelper.playEffect(e)}async stopEffect(e){return this.logger.log("停止播放音效: ",e),this.mediaHelper.stopEffect(e)}async pauseEffect(e){return this.logger.log("暂停播放音效：",e),this.mediaHelper.pauseEffect(e)}async resumeEffect(e){return this.logger.log("恢复播放音效文件: ",e),this.mediaHelper.resumeEffect(e)}async setVolumeOfEffect(e,t){return this.logger.log(`调节 ${e} 音效文件音量为: ${t}`),this.mediaHelper.setVolumeOfEffect(e,t)}async preloadEffect(e,t){return this.logger.log(`预加载 ${e} 音效文件地址: ${t}`),this.mediaHelper.preloadEffect(e,t)}async unloadEffect(e){return this.logger.log("释放指定音效文件 "+e),this.mediaHelper.unloadEffect(e)}getEffectsVolume(){return this.logger.log("获取所有音效文件播放音量"),this.mediaHelper.getEffectsVolume()}setEffectsVolume(e){return this.logger.log("设置所有音效文件播放音量:",e),this.mediaHelper.setEffectsVolume(e)}async stopAllEffects(){return this.logger.log("停止播放所有音效文件"),this.mediaHelper.stopAllEffects()}async pauseAllEffects(){return this.logger.log("暂停播放所有音效文件"),this.mediaHelper.pauseAllEffects()}async resumeAllEffects(){return this.logger.log("恢复播放所有音效文件"),this.mediaHelper.resumeAllEffects()}getAudioEffectsDuration(e){return this.logger.log("获取音效总时长"),this.mediaHelper.getAudioEffectsTotalTime(e)}getAudioEffectsCurrentPosition(e){return this.mediaHelper.getAudioEffectsPlayedTime(e)}setCanvasWatermarkConfigs(e){if(this._play){let t=null;if(e.mediaType&&"video"!==e.mediaType?"screen"===e.mediaType&&(t=this._play.watermark.screen.canvasControl):t=this._play.watermark.video.canvasControl,!t)return void this.logger.error("setCanvasWatermarkConfigs：播放器未初始化",e.mediaType);const i={TEXT:10,TIMESTAMP:1,IMAGE:4};if(e.textWatermarks&&e.textWatermarks.length>i.TEXT){this.logger.error(`目前的文字水印数量：${e.textWatermarks.length}。允许的数量：${i.TEXT}`);let t="localStream_setCanvasWatermarkConfigs: The number of text watermarks exceeds the limit",r="localStream_setCanvasWatermarkConfigs: 文字水印数量超限",s="The number of text watermarks can be set up to 10, please make sure not to exceed the limit",a="最多可以设置 10 个文字水印",o=env.IS_ZH?r:t,n=env.IS_ZH?a:s;throw new rtcError_1.default({code:errorCode_1.default.WATERMARKS_EXCEEDED_ERROR,message:o,advice:n})}if(e.imageWatermarks&&e.imageWatermarks.length>i.IMAGE){this.logger.error(`目前的图片水印数量：${e.imageWatermarks.length}。允许的数量：${i.IMAGE}`);let t="localStream_setCanvasWatermarkConfigs: The number of image watermarks exceeds the limit",r="localStream_setCanvasWatermarkConfigs: 文字水印数量超限",s="The number of image watermarks can be set up to 4, please make sure not to exceed the limit",a="最多可以设置 4 个文字水印",o=env.IS_ZH?r:t,n=env.IS_ZH?a:s;throw new rtcError_1.default({code:errorCode_1.default.WATERMARKS_EXCEEDED_ERROR,message:o,advice:n})}t.checkWatermarkParams(e),t.updateWatermarks(e),this.canvasWatermarkOptions=e,this.client.apiFrequencyControl({name:"setLocalCanvasWatermarkConfigs",code:0,param:{streamID:this.stringStreamID,isRemote:!1,mediaType:e.mediaType}})}else this.logger.error("setCanvasWatermarkConfigs：播放器未初始化")}setEncoderWatermarkConfigs(e){var t,i,r,s;if(this._play&&this._play){let a=null;if(e.mediaType&&"video"!==e.mediaType?"screen"===e.mediaType&&(a=this._play.watermark.screen.encoderControl,(null===(r=e.textWatermarks)||void 0===r?void 0:r.length)||e.timestampWatermarks||(null===(s=e.imageWatermarks)||void 0===s?void 0:s.length)?(this._play.watermark.screen.encoderControl.handler.enabled=!0,this.mediaHelper.screen.preProcessingEnabled||this.mediaHelper.enablePreProcessing("screen")):(this._play.watermark.screen.encoderControl.handler.enabled=!1,this.mediaHelper.canDisablePreProcessing("screen")&&this.mediaHelper.disablePreProcessing("screen"))):(a=this._play.watermark.video.encoderControl,(null===(t=e.textWatermarks)||void 0===t?void 0:t.length)||e.timestampWatermarks||(null===(i=e.imageWatermarks)||void 0===i?void 0:i.length)?(this._play.watermark.video.encoderControl.handler.enabled=!0,this.mediaHelper.video.preProcessingEnabled||this.mediaHelper.enablePreProcessing("video")):(this._play.watermark.video.encoderControl.handler.enabled=!1,this.mediaHelper.canDisablePreProcessing("video")&&this.mediaHelper.disablePreProcessing("video"))),!a)return void this.logger.error("setEncoderWatermarkConfigs：播放器未初始化",e.mediaType);const o={TEXT:10,TIMESTAMP:1,IMAGE:4};if(e.textWatermarks&&e.textWatermarks.length>o.TEXT){this.logger.error(`目前的文字水印数量：${e.textWatermarks.length}。允许的数量：${o.TEXT}`);let t="localStream_setEncoderWatermarkConfigs: The number of text watermarks exceeds the limit",i="localStream_setEncoderWatermarkConfigs: 文字水印数量超限",r="The number of text watermarks can be set up to 10, please make sure not to exceed the limit",s="最多可以设置 10 个文字水印",a=env.IS_ZH?i:t,n=env.IS_ZH?s:r;throw new rtcError_1.default({code:errorCode_1.default.WATERMARKS_EXCEEDED_ERROR,message:a,advice:n})}if(e.imageWatermarks&&e.imageWatermarks.length>o.IMAGE){this.logger.error(`目前的图片水印数量：${e.imageWatermarks.length}。允许的数量：${o.IMAGE}`);let t="localStream_setEncoderWatermarkConfigs: The number of image watermarks exceeds the limit",i="localStream_setEncoderWatermarkConfigs: 文字水印数量超限",r="The number of image watermarks can be set up to 4, please make sure not to exceed the limit",s="最多可以设置 4 个文字水印",a=env.IS_ZH?i:t,n=env.IS_ZH?s:r;throw new rtcError_1.default({code:errorCode_1.default.WATERMARKS_EXCEEDED_ERROR,message:a,advice:n})}a.checkWatermarkParams(e),a.updateWatermarks(e),this.encoderWatermarkOptions=e,this.client.apiFrequencyControl({name:"setEncoderWatermarkConfigs",code:0,param:JSON.stringify(e,null,2)})}else this.logger.error("setEncoderWatermarkConfigs：播放器未初始化")}getMuteStatus(e){return"audio"===e?{muted:this.muteStatus.audio.send}:"video"===e?{muted:this.muteStatus.video.send}:{muted:this.muteStatus.screen.send}}WebGLSupportError(){if(0===this.videoPostProcess.availableCode)throw new rtcError_1.default({code:errorCode_1.default.WEBGL_NOT_SUPPORT_ERROR,message:env.IS_ZH?"当前环境不支持 WebGL。":"the current environment does not support webgl.",advice:env.IS_ZH?"请尝试升级浏览器版本、显卡驱动或开启浏览器忽略显卡黑名单选项。":"please try to upgrade the browser version, graphics card driver or enable the browser ignore the graphics card blacklist option."})}setBeautyEffectOptions(e){if(this.logger.log("set basic beauty parameters:",e),!(this.videoPostProcess.availableCode<1)){this.basicBeauty.isEnable||this.logger.warn("basic beauty is not opened.");for(const t in e)try{e[t]=Math.min(Math.max(parseFloat(e[t]+""),0),1)}catch(i){e[t]=0,this.logger.error("setBeautyEffectOptions:"+i.message)}this.lastEffects=Object.assign(Object.assign({},this.lastEffects),e),this.basicBeauty.setBeautyOptions(e)}}async setBeautyEffect(e,t=!1){if(this.logger.log((e?"start":"close")+" basic beauty."),this.WebGLSupportError(),e&&this.videoPostProcess.availableCode<2)return this.logger.error(this.videoPostProcess.glErrorTip);const i=this.basicBeauty;if(!t){if(e&&i.isEnable)return this.logger.warn("basic beauty is already opened");if(!e&&!i.isEnable)return this.logger.warn("basic beauty is already closed")}if(this.mediaHelper&&this.mediaHelper.video.cameraTrack){this.replaceTags.waterMark&&this.mediaHelper.disablePreProcessing("video",!0),this.videoPostProcessTags.isBeautyTrack=e,this._cameraTrack=this.mediaHelper.video.cameraTrack;let r=0;try{this._transformedTrack=await i.setBeauty(e,this._cameraTrack),await this.replacePluginTrack({mediaType:"video",track:this._transformedTrack,external:!1})}catch(e){r=-1,this.logger.error("setBeautyEffect:"+e.message)}if(this.mediaHelper.video.preProcessingEnabled&&this.mediaHelper.enablePreProcessing("video"),e&&0===r){let e;e=this.lastEffects?this.lastEffects:{brightnessLevel:0,rednessLevel:0,smoothnessLevel:0},i.setBeautyOptions(e)}t||this.client.apiFrequencyControl({name:"setBeautyEffect",code:r,param:{streamID:this.stringStreamID,isRemote:!1,isEnable:e}})}else this.logger.warn("setBeautyEffect:video track not ready.")}setFilter(e,t){if(this.logger.log("set beauty filter parameters:"+JSON.stringify([e,t])),!(this.videoPostProcess.availableCode<1)){this.basicBeauty.isEnable||this.logger.warn("basic beauty is not opened.");try{void 0!==t&&(t=Math.min(Math.max(parseFloat(t+""),0),1))}catch(e){t=void 0,this.logger.error("setFilter:"+e.message)}this.lastFilter=e,this.basicBeauty.setFilter(e,t)}}async enableBodySegment(){return this.logger.log("start virtual background."),this.WebGLSupportError(),this.videoPostProcess.availableCode<2?this.logger.error(this.videoPostProcess.glErrorTip):this.videoPostProcess.getPlugin("VirtualBackground")?this._segmentProcessor?this.logger.warn("virtual background is already opened."):(this._segmentProcessor=this.virtualBackground,this._segmentProcessor.init(),this._segmentProcessor.once("segment-load",async()=>{var e;let t=0;try{await this._startBodySegment()}catch(i){null===(e=this._segmentProcessor)||void 0===e||e.destroy(),this._segmentProcessor=null,t=-1,this.logger.error("enableBodySegment:"+i.message)}this.client.apiFrequencyControl({name:"enableBodySegment",code:t,param:{streamID:this.stringStreamID}})}),void(env.IS_ANY_SAFARI&&parseFloat(env.SAFARI_VERSION||"0")<15&&this.logger.warn("In the current version of Safari, wasm has low execution efficiency, which will result in low frame rate when background-segmentation is enabled."))):this.logger.warn("virtual background plugin is not register.")}async disableBodySegment(){if(this.logger.log("close virtual background."),this.WebGLSupportError(),this._segmentProcessor){let e=0;try{await this._cancelBodySegment(),this._segmentProcessor.destroy(),this._segmentProcessor=null}catch(t){e=-1,this.logger.error("disableBodySegment:"+t.message)}this.client.apiFrequencyControl({name:"disableBodySegment",code:e,param:{streamID:this.stringStreamID}})}else this.logger.warn("virtual background is already closed.")}async _startBodySegment(){this.videoPostProcess.availableCode<2||this._segmentProcessor&&(await this.transformTrack(!0,this._segmentProcessor),this.videoPostProcessTags.isBodySegmentTrack=!0)}async _cancelBodySegment(){this.videoPostProcess.availableCode<1||this._segmentProcessor&&(await this.transformTrack(!1,this._segmentProcessor),this.videoPostProcessTags.isBodySegmentTrack=!1)}setBackground(e){this.logger.log("set virtual background parameters:"+JSON.stringify(e)),this.videoPostProcess.availableCode<1||(this.virtualBackground.isEnable||this.logger.warn("virtual background is not opened."),this.virtualBackground.setVirtualBackGround(e))}setBackGround(e){this.setBackground(e)}async enableAdvancedBeauty(e){return this.logger.log("start advanced beauty."),this.WebGLSupportError(),this.videoPostProcess.availableCode<2?this.logger.error(this.videoPostProcess.glErrorTip):this.videoPostProcess.getPlugin("AdvancedBeauty")?this._advancedBeautyProcessor?this.logger.warn("advanced beauty is already opened."):(this._advancedBeautyProcessor=this.advancedBeauty,this._advancedBeautyProcessor.init(e),this._advancedBeautyProcessor.once("facePoints-load",async()=>{var e;let t=0;try{await this._startAdvancedBeauty()}catch(i){null===(e=this._advancedBeautyProcessor)||void 0===e||e.destroy(),this._advancedBeautyProcessor=null,t=-1,this.logger.error("enableAdvancedBeauty:"+i.message)}this.client.apiFrequencyControl({name:"enableAdvancedBeauty",code:t,param:{streamID:this.stringStreamID}})}),void(env.IS_ANY_SAFARI&&parseFloat(env.SAFARI_VERSION||"0")<15&&this.logger.warn("In the current version of Safari, wasm has low execution efficiency, which will result in low frame rate when advanced-beauty is enabled."))):this.logger.warn("advanced beauty plugin is not register.")}async disableAdvancedBeauty(){if(this.logger.log("close advanced beauty."),this.WebGLSupportError(),this._advancedBeautyProcessor){let e=0;try{await this._cancelAdvancedBeauty(),this._advancedBeautyProcessor.destroy(),this._advancedBeautyProcessor=null}catch(t){e=-1,this.logger.error("disableAdvancedBeauty:"+t.message)}this.client.apiFrequencyControl({name:"disableAdvancedBeauty",code:e,param:{streamID:this.stringStreamID}})}else this.logger.warn("advanced beauty is already closed.")}async _startAdvancedBeauty(){this.videoPostProcess.availableCode<2||this._advancedBeautyProcessor&&(await this.transformTrack(!0,this._advancedBeautyProcessor),this.videoPostProcessTags.isAdvBeautyTrack=!0)}async _cancelAdvancedBeauty(){this.videoPostProcess.availableCode<1||this._advancedBeautyProcessor&&(await this.transformTrack(!1,this._advancedBeautyProcessor),this.videoPostProcessTags.isAdvBeautyTrack=!1)}async enableAIDenoise(){let e;if(this.logger.log("start ai denoise."),this.mediaHelper.audio.stageAIProcessing){if(e=this.mediaHelper.audio.stageAIProcessing,e.enabled&&"INITED"===e.state)return this.logger.warn("ai denoise is already opened."),!0}else{const t=webAudio_1.getAudioContext();if(!t)return this.logger.error("当前环境不支持AudioContext"),!1;e=new StageAIProcessing_1.StageAIProcessing(t,this.logger),this.mediaHelper.audio.stageAIProcessing=e}return e.hasPlugin("AIDenoise")?(e.enabled=!0,"UNINIT"===e.state&&await e.init(),this.mediaHelper.audio.audioRoutingEnabled||this.mediaHelper.enableAudioRouting(),this.mediaHelper.updateWebAudio(),this.client.apiFrequencyControl({name:"enableAIDenoise",code:0,param:{streamID:this.stringStreamID}}),!0):(this.logger.warn("AIDenoise plugin is not register."),!1)}async disableAIDenoise(){this.logger.log("close ai denoise.");const e=this.mediaHelper.audio.stageAIProcessing;return e?e.enabled?(e.enabled=!1,this.mediaHelper.updateWebAudio(),this.mediaHelper.canDisableAudioRouting()&&this.mediaHelper.disableAudioRouting(),this.client.apiFrequencyControl({name:"disableAIDenoise",code:0,param:{streamID:this.stringStreamID}}),!1):(this.logger.warn("ai denoise is already closed."),!0):(this.logger.warn("disableAIDenoise: ai denoise is not created"),!0)}async replacePluginTrack(e){if(this.videoPostProcess.availableCode<1)return;let t,i=!1;if("screen"===e.mediaType?(this.mediaHelper.screen.screenVideoTrack?(t=this.mediaHelper.screen.screenVideoTrack,this.mediaHelper.screen.screenVideoTrack=null):this.mediaHelper.screen.screenVideoSource&&(i=!0,t=this.mediaHelper.screen.screenVideoSource,this.mediaHelper.screen.screenVideoSource=null),t&&(e.external?this.mediaHelper.screen.screenVideoSource=e.track:this.mediaHelper.screen.screenVideoTrack=e.track,gum_1.emptyStreamWith(this.mediaHelper.screen.screenVideoStream,e.track),gum_1.emptyStreamWith(this.mediaHelper.screen.renderStream,e.track),this.mediaHelper.screen.screenVideoStream.getVideoTracks().length&&"string"==typeof this.mediaHelper.screen.encoderConfig.high.contentHint&&this.mediaHelper.screen.screenVideoStream.getVideoTracks()[0].contentHint!==this.mediaHelper.screen.encoderConfig.high.contentHint&&(this.logger.log("应用 contentHint screen high",this.mediaHelper.screen.encoderConfig.high.contentHint),this.mediaHelper.screen.screenVideoStream.getVideoTracks()[0].contentHint=this.mediaHelper.screen.encoderConfig.high.contentHint))):"video"===e.mediaType&&(this.mediaHelper.video.cameraTrack?(t=this.mediaHelper.video.cameraTrack,this.mediaHelper.video.cameraTrack=null):this.mediaHelper.video.videoSource&&(i=!0,t=this.mediaHelper.video.videoSource,this.mediaHelper.video.videoSource=null),t&&(e.external?this.mediaHelper.video.videoSource=e.track:this.mediaHelper.video.cameraTrack=e.track,gum_1.emptyStreamWith(this.mediaHelper.video.videoStream,e.track),gum_1.emptyStreamWith(this.mediaHelper.video.renderStream,e.track),this.mediaHelper.video.videoStream.getVideoTracks().length&&"string"==typeof this.mediaHelper.video.encoderConfig.high.contentHint&&this.mediaHelper.video.videoStream.getVideoTracks()[0].contentHint!==this.mediaHelper.video.encoderConfig.high.contentHint&&(this.logger.log("应用 contentHint video high",this.mediaHelper.video.encoderConfig.high.contentHint),this.mediaHelper.video.videoStream.getVideoTracks()[0].contentHint=this.mediaHelper.video.encoderConfig.high.contentHint))),!t)return this.logger.error(`replaceTrack ${e.mediaType} 当前没有可替换的流`),null;this.logger.log(`replaceTrack ${e.mediaType}【external: ${i} ${t.label}】=>【external: ${e.external} ${e.track.label}】`),gum_1.watchTrack(e.track),this.mediaHelper.listenToTrackEnded(e.track);const r=this.getSender(e.mediaType,"high");return r&&(r.replaceTrack(e.track),this.logger.log(`replaceTrack ${e.mediaType} 成功替换上行`)),this.replaceTags.isMuted&&this.mediaHelper.video.cameraTrack&&(this.mediaHelper.video.cameraTrack.enabled=!1),{oldTrack:t,external:i}}async transformTrack(e,t){if(!(this.videoPostProcess.availableCode<1)&&t)if(this.mediaHelper&&this.mediaHelper.video.cameraTrack){this.replaceTags.waterMark&&this.mediaHelper.disablePreProcessing("video",!0),this._cameraTrack=this.mediaHelper.video.cameraTrack;let i=null;try{this._transformedTrack=await t.setTrack(e,this._cameraTrack),await this.replacePluginTrack({mediaType:"video",track:this._transformedTrack,external:!1})}catch(e){i=e}if(this.mediaHelper.video.preProcessingEnabled&&this.mediaHelper.enablePreProcessing("video"),i)throw i}else this.logger.error("transformTrack:video track not ready.")}async registerPlugin(options){if(this.logger.log("register plugin:"+options.key),this.videoPostProcess.getPlugin(options.key))return this.logger.warn(`plugin ${options.key} already exists.`);const stageAIProcessing=this.mediaHelper.audio.stageAIProcessing;if(stageAIProcessing&&stageAIProcessing.hasPlugin(options.key))return this.logger.warn(`plugin ${options.key} already exists.`),!1;let plugin=null;options.adapterRef=this.client.adapterRef;try{if(options.pluginUrl?(await plugin_1.loadPlugin(options.key,options.pluginUrl),plugin=eval(`new window.${options.key}(options)`)):options.pluginObj&&(plugin=new options.pluginObj(options)),!plugin)throw new Error("unsupport plugin "+options.key);plugin.once("plugin-load",()=>{if(this.logger.log(`plugin ${options.key} loaded`),-1!==plugin_list_1.videoPlugins.indexOf(options.key))this.WebGLSupportError(),this.videoPostProcess.registerPlugin(options.key,plugin);else{if(-1===plugin_list_1.audioPlugins.indexOf(options.key))throw new Error("unsupport plugin "+options.key);if("AIDenoise"===options.key){let e;if(this.mediaHelper.audio.stageAIProcessing)e=this.mediaHelper.audio.stageAIProcessing;else{const t=webAudio_1.getAudioContext();if(!t)return this.logger.error("当前环境不支持AudioContext"),!1;e=new StageAIProcessing_1.StageAIProcessing(t,this.logger),this.mediaHelper.audio.stageAIProcessing=e}e.registerPlugin(options.key,plugin,options.wasmUrl)}}this.emit("plugin-load",options.key),this.client.apiFrequencyControl({name:"registerPlugin",code:0,param:{streamID:this.stringStreamID,plugin:options.key}})}),plugin.once("plugin-load-error",()=>{throw this.emit("plugin-load-error",{key:options.key,msg:`load ${options.wasmUrl} error.`}),new rtcError_1.default({code:errorCode_1.default.PLUGIN_LOADED_ERROR,message:env.IS_ZH?`插件加载失败：${options.wasmUrl}。`:`load plugin error:${options.wasmUrl}.`,advice:env.IS_ZH?"请检查网络是否开启或资源地址是否正确。":"please check network or resource address."})}),plugin.once("error",e=>{throw new rtcError_1.default({code:errorCode_1.default.PLUGIN_LOADED_ERROR,message:env.IS_ZH?`插件 ${options.key} 内部错误：${e}。`:`plugin '${options.key}' runtime error:${e}.`})})}catch(e){this.emit("plugin-load-error",{key:options.key,msg:e.message}),this.client.apiFrequencyControl({name:"registerPlugin",code:-1,param:{streamID:this.stringStreamID,plugin:options.key}})}}async unregisterPlugin(e){if(this.logger.log("unRegister plugin:"+e),-1===plugin_list_1.audioPlugins.indexOf(e))this.WebGLSupportError(),this.videoPostProcess&&("VirtualBackground"===e&&this._segmentProcessor?await this.disableBodySegment():"AdvancedBeauty"===e&&this._advancedBeautyProcessor&&await this.disableAdvancedBeauty(),this.videoPostProcess.unregisterPlugin(e));else if("AIDenoise"===e){const e=this.mediaHelper.audio.stageAIProcessing;e&&(e.enabled=!1,this.mediaHelper.updateWebAudio(),this.mediaHelper.canDisableAudioRouting()&&this.mediaHelper.disableAudioRouting(),e.unregisterAIDenoise(),this.mediaHelper.audio.stageAIProcessing=null)}}async suspendVideoPostProcess(){if(this.videoPostProcess.availableCode<1)return;const{isBeautyTrack:e,isBodySegmentTrack:t,isAdvBeautyTrack:i}=this.videoPostProcessTags;e&&(await this.setBeautyEffect(!1,!0),this.videoPostProcessTags.isBeautyTrack=!0),t&&(await this._cancelBodySegment(),this.videoPostProcessTags.isBodySegmentTrack=!0),i&&(await this._cancelAdvancedBeauty(),this.videoPostProcessTags.isAdvBeautyTrack=!0)}async resumeVideoPostProcess(){if(!(this.videoPostProcess.availableCode<1))try{const{isBeautyTrack:e,isBodySegmentTrack:t,isAdvBeautyTrack:i}=this.videoPostProcessTags;e&&(await this.setBeautyEffect(!0,!0),this.lastEffects&&this.setBeautyEffectOptions(this.lastEffects),this.lastFilter&&this.setFilter(this.lastFilter)),t&&await this._startBodySegment(),i&&await this._startAdvancedBeauty()}catch(e){this.logger.log("开启失败: "+e)}}async replaceCanvas(){var e,t;if(this.videoPostProcess.availableCode<1)return;if(!this._play)return;if(!env.IS_ANY_SAFARI)return;if(env.SAFARI_VERSION&&parseFloat(env.SAFARI_VERSION)>15.2)return;const i=null===(e=this._play.getVideoDom)||void 0===e?void 0:e.querySelector("video"),r=this._play.getVideoDom;if(i&&r){const e=this.videoPostProcess.filters,s=this.videoPostProcess.video,a=this.replaceTags.videoPost,o=this.replaceTags.waterMark;if(a){const t=e.canvas;if(t.style.height="0px",t.style.width="0px",document.body.appendChild(t),env.SAFARI_MAJOR_VERSION<14&&s&&(s.style.height="0px",s.style.width="0px",document.body.appendChild(s)),o||e.canvas.parentElement===r)o&&(i.style.display="");else{const t=e.canvas;i.style.display="none",t.style.position="absolute";const s=r.getBoundingClientRect(),a=s.width/s.height,o=t.width/t.height,{width:n,height:d,cut:c}=this.renderMode.local.video,l=n/d;if(c)if(l>o){t.style.width="100%",t.style.left="0px";const e=s.width/o/s.height;t.style.height=100*e+"%",t.style.top=50*-(e-1)+"%"}else{t.style.height="100%",t.style.top="0px";const e=s.height*o/s.width;t.style.width=100*e+"%",t.style.left=50*-(e-1)+"%"}else if(a>o){t.style.height="100%",t.style.top="0px";const e=s.height*o/s.width;t.style.width=100*e+"%",t.style.left=50*(1-e)+"%"}else{t.style.width="100%",t.style.left="0px";const e=s.width/o/s.height;t.style.height=100*e+"%",t.style.top=50*(1-e)+"%"}r.appendChild(e.canvas)}}else i.style.display="",null===(t=e.canvas.parentNode)||void 0===t||t.removeChild(e.canvas)}}loseContext(){var e,t;try{null===(t=null===(e=this.videoPostProcess.filters)||void 0===e?void 0:e.webglLostContext)||void 0===t||t.loseContext()}catch(e){}}restoreContext(){var e,t;try{null===(t=null===(e=this.videoPostProcess.filters)||void 0===e?void 0:e.webglLostContext)||void 0===t||t.restoreContext()}catch(e){}}async destroy(){this.client&&(this.client.apiFrequencyControl({name:"destroy",code:0,param:{streamID:this.stringStreamID,isRemote:!1}}),this.logger.log(`uid ${this.stringStreamID} 销毁 Stream 实例`),this.stop(),this._reset(),this.destroyed=!0,this.lastEffects=null,this.lastFilter=null,this._segmentProcessor&&(this._segmentProcessor.destroy(),this._segmentProcessor=null),this._advancedBeautyProcessor&&(this._advancedBeautyProcessor.destroy(),this._advancedBeautyProcessor=null),this._cameraTrack&&(this._cameraTrack.stop(),this._cameraTrack=null),this._transformedTrack&&(this._transformedTrack.stop(),this._transformedTrack=null),this.videoPostProcess.destroy())}}exports.LocalStream=LocalStream},function(e,t,i){var r=this&&this.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){void 0===r&&(r=i),e[r]=t[i]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&r(t,e,i);return s(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=i(13),d=a(i(2)),c=o(i(297)),l=i(298);class u extends n.EventEmitter{constructor(e){super(),this.pluginModules={VirtualBackground:null,AdvancedBeauty:null},this.isAlive=!0,this.filters=null,this.video=null,this.frameRate=15,this.timerId=-1,this.taskSet=new Set,this.taskSnapshot=new Set,this.readyTaskSet=new Set(["BasicBeauty"]),this.sourceMap=null,this.maskData=null,this.advBeautyData=[],this.sourceTrack=null,this.trackInstance=null,this.videoSizeTag="",this.frameCount=[0,0],this.update=(e=!0)=>{if(this.availableCode<2)return;if(d.IS_ANY_SAFARI&&"hidden"===document.visibilityState)return;const t=this.filters;if(!this.taskSet.size)return t?t.update(!1):c.default.clearTimeout(this.timerId);if(e&&(this.frameCount[0]+=1),this.taskReady){let e=!1,i=!1;if(this.taskSet.has("VirtualBackground")&&(t.virtualBackground.setMaskMap(this.maskData),this.maskData=null,e=!0,i=!0),this.taskSet.has("AdvancedBeauty")?(t.advBeauty.setAdvData(this.advBeautyData),this.advBeautyData=[],e=!0):i=!1,this.taskSnapshot=new Set(this.taskSet),this.readyTaskSet.clear(),this.readyTaskSet.add("BasicBeauty"),this.frameCount[1]=this.frameCount[0],e?(t.update(!1),this.sourceMap=t.normal.getImageData(t.srcMap)):t.update(!0),this.taskSet.has("VirtualBackground")){const e=this.pluginModules.VirtualBackground;if(e){const{width:r,height:s}=t.canvas;r>16&&s>16?e.process(i?this.sourceMap.slice():this.sourceMap,r,s,e=>{const t=(e.data||e).length;this.maskData=this.taskSet.has("VirtualBackground")&&t>0?e:null,this.readyTaskSet.add("VirtualBackground"),this.frameCount[1]<this.frameCount[0]&&(this.updateTimer(),this.update(!1))},d.IS_CHROME&&(d.CHROME_MAJOR_VERSION||0)>=104):this.readyTaskSet.add("VirtualBackground")}}if(this.taskSet.has("AdvancedBeauty")){const e=this.pluginModules.AdvancedBeauty;if(e){const{width:i,height:r}=t.canvas;e.process(this.sourceMap,i,r,e=>{this.advBeautyData=this.taskSet.has("AdvancedBeauty")?e:[],this.readyTaskSet.add("AdvancedBeauty"),this.frameCount[1]<this.frameCount[0]&&(this.updateTimer(),this.update(!1))},d.IS_CHROME&&(d.CHROME_MAJOR_VERSION||0)>=104)}}}},this.setTaskAndTrack=(e,t,i)=>new Promise((r,s)=>{if(this.availableCode<1)return s(this.glErrorTip);if(t){if(this.hasTask(e))return r(this.track);this.createTrack(i).then(t=>{this.addTask(e),setTimeout(()=>{r(this.track)},t)}).catch(e=>{s(e)})}else{if(!this.hasTask(e))return r(this.track);this.removeTask(e),r(this.track)}}),this.logger=e;try{this.filters=new l.Filters;const e=this.filters.canvas;e.addEventListener("webglcontextlost",e=>{e.preventDefault(),this.emit("contextLost")},!1),e.addEventListener("webglcontextrestored",e=>{var t;e.preventDefault();let i=!0;this.filters=(null===(t=this.filters)||void 0===t?void 0:t.clone())||null,this.filters||(i=!1),this.emit("contextRestored",i)},!1)}catch(e){}}registerPlugin(e,t){this.pluginModules[e]=t}getPlugin(e){return this.pluginModules[e]}unregisterPlugin(e){this.pluginModules[e]=null}get availableCode(){return this.isAlive?this.filters&&this.filters.gl?this.filters.gl.isContextLost()?1:2:0:-1}get glErrorTip(){switch(this.availableCode){case-1:return"localStream is already destroyed.";case 0:return"the current environment does not support webgl.";case 1:return"webgl context has been lost."}return""}get taskReady(){for(const e of this.taskSnapshot)if(!this.readyTaskSet.has(e))return!1;return!0}addTask(e){this.taskSet.has(e)||(this.taskSet.add(e),this.logger.log(`task ${e} is added.`),this.update(),1===this.taskSet.size&&(this.updateTimer(),this.emit("taskSwitch",!0)))}removeTask(e){var t;this.taskSet.delete(e),this.logger.log(`task ${e} is removed.`),0===this.taskSet.size&&(c.default.clearTimeout(this.timerId),this.timerId=-1,this.sourceMap=null,null===(t=this.trackInstance)||void 0===t||t.stop(),this.trackInstance=null,this.emit("taskSwitch",!1)),this.update(),this.taskSnapshot.delete(e)}hasTask(e){return this.taskSet.has(e)}get hasAnyTask(){return this.taskSet.size>0}videoSizeChange(e,t){if(d.IS_ANY_SAFARI&&this.filters){const i=`${e}-${t}`;this.videoSizeTag!==i&&(this.videoSizeTag=i,this.emit("safariVideoSizeChange"))}}createTrack(e){return new Promise((t,i)=>{var r,s;if(this.trackInstance&&this.trackInstance===e)return this.logger.log("VideoPostProcess track transform unnecessary"),t(0);this.logger.log("VideoPostProcess track transform");const a=e.getSettings();this.frameRate=a.frameRate||15,this.frameRate>30&&(this.logger.warn("In chrome, webgl drawing video which framerate greater than 30fps may cause memory leak."),this.frameRate=30),this.sourceTrack=e,this.trackInstance&&(this.trackInstance.stop(),this.trackInstance=null),a.width&&a.height&&(null===(r=this.filters)||void 0===r||r.setSize(a.width,a.height),this.videoSizeTag||(this.videoSizeTag=`${a.width}-${a.height}`));const o=(null===(s=this.filters)||void 0===s?void 0:s.canvas).captureStream(this.frameRate);this.trackInstance=o.getVideoTracks()[0],this.video=this.video||document.createElement("video");const n=new MediaStream([this.sourceTrack]);this.video.srcObject=n;const d=e=>{var t;const{videoWidth:i,videoHeight:r}=e;null===(t=this.filters)||void 0===t||t.setSize(i,r),this.videoSizeChange(i,r)};this.video.onloadedmetadata=()=>{this.video.play().then(()=>{this.filters.mapSource=this.video,d(this.video),t(0)}).catch(e=>{i(e)})},this.video.onresize=()=>{d(this.video)}})}get track(){return this.taskSet.size?(this.logger.log("return video post procss track."),this.trackInstance):(this.logger.log("return origin track."),this.sourceTrack)}updateTimer(){c.default.clearTimeout(this.timerId),this.timerId=c.default.setTimeout(()=>{this.updateTimer(),this.update()},1e3/(1.1*this.frameRate),null)}destroy(){var e,t,i;this.isAlive=!1,c.default.clearTimeout(this.timerId),this.removeAllListeners(),this.taskSet.clear(),this.readyTaskSet.clear(),this.taskSnapshot.clear(),null===(e=this.sourceTrack)||void 0===e||e.stop(),this.sourceTrack=null,null===(t=this.trackInstance)||void 0===t||t.stop(),this.trackInstance=null,this.video=null,null===(i=this.filters)||void 0===i||i.destroy(),this.filters=null,this.sourceMap=null,this.maskData=null,this.advBeautyData=null,this.pluginModules=null,this.frameCount=[0,0]}}t.default=u},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0});const r=i(125);const s=new class{constructor(){this.id=0,this.callbacks={},this.worker=null}getWorker(){return this.worker||(this.worker=new Worker(r.getBlobUrl("webWorkerTimer")),this.worker.onmessage=e=>{switch(e.data.message){case"interval:tick":case"timeout:tick":{const t=this.callbacks[e.data.id];t&&t.fn&&t.fn.apply(t.context);break}case"interval:cleared":case"timeout:cleared":delete this.callbacks[e.data.id]}}),this.worker}setInterval(e,t,i){this.id++;const r=this.id;return this.callbacks[r]={fn:e,context:i},this.getWorker().postMessage({command:"interval:start",interval:t,id:r}),r}setTimeout(e,t,i){this.id++;const r=this.id;return this.callbacks[r]={fn:e,context:i},this.getWorker().postMessage({command:"timeout:start",timeout:t,id:r}),r}clearInterval(e){this.getWorker().postMessage({command:"interval:clear",id:e})}clearTimeout(e){this.getWorker().postMessage({command:"timeout:clear",id:e})}};t.default=s},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.Filters=void 0;const r=i(158),s=i(299),a=i(114),o=i(198),n=i(308),d=i(312),c=i(313),l=i(314),u=i(315);class h{constructor(e){this._alive=!0,this.time=-1,this.lastTimer=performance.now(),this.webglLostContext=null,this._renderer=new s.Renderer({canvas:e,antialias:!0}),this.map=a.createTexture(this._renderer.gl,null);const t=this._renderer.gl;this.webglLostContext=t.getExtension("WEBGL_lose_context");const{posArray:i,uvArray:h,advBeautyIndicesArray:p,advBeautyPosArray:m,advBeautyZindexArray:f,advFaceMaskUVArray:g,advEyeTeethPosArray:v,advEyeTeethIndicesArray:_,advEyeTeethZindexArray:S,advEyeTeethUVArray:y}=l.typedArray,R=r.createAttributeBuffer(t,"position",i,2),b=r.createAttributeBuffer(t,"uv",h,2),T=r.createAttributeBuffer(t,"position",m,2),w=r.createAttributeBuffer(t,"zIndex",f,1),I=r.createAttributeBuffer(t,"indices",p,1,"ELEMENT_ARRAY_BUFFER"),E=r.createAttributeBuffer(t,"uv",g,2),A=r.createAttributeBuffer(t,"tPosition",v,2),C=r.createAttributeBuffer(t,"indices",_,1,"ELEMENT_ARRAY_BUFFER"),P=r.createAttributeBuffer(t,"zIndex",S,1),k=r.createAttributeBuffer(t,"uv",y,2);this.advBeauty=new o.AdvBeautyFilter(this._renderer,this.map,T,w,I,E,R,b,A,C,P,k),this.beauty=new n.BeautyFilter(this._renderer,this.map,R,b),this.lut=new d.LutFilter(this._renderer,this.map,R,b),this.normal=new c.NormalFilter(this._renderer,this.map,R,b),this.virtualBackground=new u.VirtualBackFilter(this._renderer,this.map,R,b)}clone(){var e;try{const t=new h(this._renderer.canvas);t.mapSource=(null===(e=this.srcMap)||void 0===e?void 0:e.source)||null,this.advBeauty.remove(),t.advBeauty.presetAdvEffect(Object.assign({},this.advBeauty.params));const i=this.virtualBackground.lastSetInfo;return"bk"===i.type?t.virtualBackground.setBackground(i.value):"blur"===i.type&&t.virtualBackground.setBlurIntensity(i.value),t}catch(e){return null}}get filters(){return[this.advBeauty,this.beauty,this.lut,this.virtualBackground,this.normal]}get canvas(){return this._renderer.canvas}get gl(){return this._renderer.gl}get srcMap(){return this.map}set mapSource(e){const t=this.map;t&&(t.source=e,t.refresh())}get isAlive(){return this._alive}setSize(e,t){this._renderer.setSize(e,t),this.filters.forEach(e=>{e.updateSize()})}render(){const e=this.filters;e[0].map=this.map,e[0].render(),e[1].faceMask=e[0].faceMask,e[1].featureParas=e[0].featureParas;for(let t=1;t<e.length;t++)e[t].map=e[t-1].output,e[t].render()}update(e=!0){var t;if(this._alive){if(this.time<0)this.time=0,this.lastTimer=performance.now();else{const e=performance.now(),t=Math.min(e-this.lastTimer,100);this.lastTimer=e,this.time+=t/1e3}e&&(null===(t=this.map)||void 0===t||t.refresh()),this.render()}}destroy(){this._alive=!1,this.time=-1;const e=this._renderer.gl;this.filters.forEach(e=>{e.destroy()}),null==e||e.deleteTexture(this.map.glTexture)}}t.Filters=h},function(e,t,i){var r=this&&this.__rest||function(e,t){var i={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(i[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var s=0;for(r=Object.getOwnPropertySymbols(e);s<r.length;s++)t.indexOf(r[s])<0&&Object.prototype.propertyIsEnumerable.call(e,r[s])&&(i[r[s]]=e[r[s]])}return i};Object.defineProperty(t,"__esModule",{value:!0}),t.Renderer=void 0;const s=i(139);t.Renderer=class{constructor(e){this._gl=null,this._pixelRatio=1,this._viewport={x:0,y:0,width:640,height:480};const t=Object.assign({preserveDrawingBuffer:!0,powerPreference:"high-performance"},e),{canvas:i=document.createElement("canvas"),width:a=640,height:o=480}=t,n=r(t,["canvas","width","height"]);this._canvas=i,this._gl=s.getWebGLContext(i,n);const d=this.setSize(a,o);this.setViewport(0,0,d.width,d.height)}get canvas(){return this._canvas}get gl(){return this._gl}getPixelRatio(){var e;return null!==(e=this._pixelRatio)&&void 0!==e?e:1}setPixelRatio(e){const t=this.getPixelRatio();if(t===e)return;const i=this.getSize();i.width/=t,i.height/=t,this._pixelRatio=e,this.setSize(i.width,i.height)}getSize(){return{width:this.canvas.width,height:this.canvas.height}}setSize(e,t,i=!1){const r=this.canvas,s=this.getPixelRatio();return r.width=e*s,i&&(r.style.width=e+"px"),r.height=t*s,i&&(r.style.height=t+"px"),this.getSize()}getViewport(){return this._viewport}setViewport(e,t,i,r){var s;this._viewport={x:e,y:t,width:i,height:r},null===(s=this.gl)||void 0===s||s.viewport(e,t,i,r)}resize(e,t,i,r){const s=this.setSize(e,t);i&&this.setPixelRatio(i),r?this.setViewport(r.x,r.y,r.width,r.height):this.setViewport(0,0,s.width,s.height)}render(e){if(!this.gl)return;const t=this.gl;t.enable(t.CULL_FACE),e.render()}}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.defaultShader=void 0,t.defaultShader={vShader:"\n    attribute vec4 position;\n    void main() {\n        gl_Position = position;\n    }\n",fShader:"\n    #ifdef GL_FRAGMENT_PRECISION_HIGH\n        precision highp float;\n    #else\n        precision mediump float;\n    #endif\n\n    void main() {\n        gl_FragColor = vec4(1.0, 0.0, 1.0, 1.0);\n    }\n"}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.createShader=void 0,t.createShader=function(e,t,i){const r=e.createShader({VERTEX:e.VERTEX_SHADER,FRAGMENT:e.FRAGMENT_SHADER}[i]);if(!r)return console.error(i+"Shader was not created successfully."),null;if(e.shaderSource(r,t),e.compileShader(r),e.getShaderParameter(r,e.COMPILE_STATUS))return r;const s=t.split("\n").map((e,t)=>`${t+1}${e}`).join("\n");return console.error(`${e.getShaderInfoLog(r)}\n%cshader source code\n${s}\n`,"color: #008040"),e.deleteShader(r),null}},function(e,t,i){function r(e,t,i,r,s,a){var o;if(i===e.FLOAT)return r?i=>e.uniform1fv(t,i):i=>e.uniform1f(t,i);const n={[e.FLOAT_VEC2]:i=>e.uniform2fv(t,i),[e.FLOAT_VEC3]:i=>e.uniform3fv(t,i),[e.FLOAT_VEC4]:i=>e.uniform4fv(t,i)}[i];if(n)return n;if(i===e.INT||i===e.BOOL)return r?i=>e.uniform1iv(t,i):i=>e.uniform1i(t,i);const d={[e.BOOL_VEC2]:e.INT_VEC2,[e.BOOL_VEC3]:e.INT_VEC3,[e.BOOL_VEC4]:e.INT_VEC4},c={[e.INT_VEC2]:i=>e.uniform2iv(t,i),[e.INT_VEC3]:i=>e.uniform3iv(t,i),[e.INT_VEC4]:i=>e.uniform4iv(t,i)}[null!==(o=d[i])&&void 0!==o?o:i];if(c)return c;const l={[e.FLOAT_MAT2]:i=>e.uniformMatrix2fv(t,!1,i),[e.FLOAT_MAT3]:i=>e.uniformMatrix3fv(t,!1,i),[e.FLOAT_MAT4]:i=>e.uniformMatrix4fv(t,!1,i)}[i];if(l)return l;if(i===e.SAMPLER_2D||i===e.SAMPLER_CUBE){const o=i===e.SAMPLER_2D?e.TEXTURE_2D:e.TEXTURE_CUBE_MAP;if(r){const i=[];for(let e=0;e<s;e++)i.push(a.value++);return r=>{e.uniform1iv(t,i),r.forEach((t,r)=>{var s;e.activeTexture(e.TEXTURE0+i[r]),e.bindTexture(o,null!==(s=null==t?void 0:t.glTexture)&&void 0!==s?s:null)})}}{const i=a.value++;return r=>{var s;e.uniform1i(t,i),e.activeTexture(e.TEXTURE0+i),e.bindTexture(o,null!==(s=null==r?void 0:r.glTexture)&&void 0!==s?s:null)}}}return()=>{console.warn("no matching uniform setter.")}}Object.defineProperty(t,"__esModule",{value:!0}),t.parseUniforms=void 0,t.parseUniforms=function(e,t){const i={value:0},s=e.getProgramParameter(t,e.ACTIVE_UNIFORMS),a={};for(let o=0;o<s;o++){const s=e.getActiveUniform(t,o);if(s){const o=s.size>1,n=o?s.name.replace("[0]",""):s.name,d=s.type,c=e.getUniformLocation(t,n);if(null!==c){const t=r(e,c,d,o,s.size,i);a[n]={type:d,size:s.size,value:null,setter:e=>{void 0!==e?a[n].value=e:t(a[n].value)}}}else console.warn(`uniform:[${n}] is null.`)}}return a}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.advBeautyEyeShader=void 0,t.advBeautyEyeShader={fShader:"\n    #ifdef GL_FRAGMENT_PRECISION_HIGH\n        precision highp float;\n    #else\n        precision mediump float;\n    #endif\n\n    uniform sampler2D map;\n    uniform vec2 eyeCenter;\n    uniform vec2 rdDir;\n    uniform float rdIntensity;\n    uniform float lgIntensity;\n    uniform float intensRatio;\n    uniform float range;\n\n    varying vec2 vuv;\n\n    mat3 scaleByNormal(vec2 normal, float k, float refx, float refy){\n        float a = 1.0 + (k - 1.0) * normal.x * normal.x;\n        float b = (k - 1.0) * normal.x * normal.y;\n        float c = 1.0 + (k - 1.0) * normal.y * normal.y;\n        return mat3(\n            a, b, 0.0,\n            b, c, 0.0,\n            (1.0 - a) * refx - b * refy, (1.0 - c) * refy - b * refx, 1.0\n        );\n    }\n\n    vec2 lgEye(vec2 uv, vec2 center, float range, float strength, float powRatio) {\n        float dist = distance(uv, center);\n        if(dist > range){\n            return uv;\n        }\n        vec2 dir = normalize(uv - center);\n        float scale = 1. - strength + strength * pow(smoothstep(0., 1., dist / range), powRatio);\n        float newDist = dist * scale;\n        return center + newDist * dir;\n    }\n\n    vec2 rdEye(vec2 uv, vec2 center, float range, float strength, float powRatio){\n        float dist = distance(uv, center);\n        if(dist > range){\n            return uv;\n        }\n        float scale = 1. - strength + strength * pow(smoothstep(0., 1., dist / range), powRatio);\n        return (scaleByNormal(rdDir, scale, center.x, center.y) * vec3(uv, 1.0)).xy;\n    }\n\n    void main() {\n        vec2 uv = vuv;\n        if(intensRatio > 0.0){\n            if(rdIntensity > 0.0){\n                float maxRdIntens = mix(1.0, 0.5, lgIntensity);\n                float rdIntens = mix(0.0, maxRdIntens, rdIntensity * intensRatio);\n                uv = lgEye(uv, eyeCenter, range * 2.0, rdIntens, 0.075);\n                uv = rdEye(uv, eyeCenter, range * 2.0, rdIntens, 0.1);\n            }\n            if(lgIntensity > 0.0){\n                float lgIntens = lgIntensity * intensRatio;\n                uv = lgEye(uv, eyeCenter, range * 2.5, lgIntens, 0.1);\n                uv = rdEye(uv, eyeCenter, range * 2.5, lgIntens, 0.05);\n            }\n        }\n        gl_FragColor = texture2D(map, uv);\n    }\n"}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.advBeautyShader=void 0,t.advBeautyShader={vShader:"\n    uniform vec2 size;\n\n    attribute vec2 position;\n    attribute vec2 tPosition;\n    attribute float zIndex;\n\n    varying vec2 vuv;\n\n    vec2 npos(vec2 pos){\n        return pos / size;\n    }\n\n    float ndcx(float x){\n        return (x - 1.0) * 2.0 + 1.0;\n    }\n\n    float ndcy(float y){\n        return (1.0 - y) * 2.0 - 1.0;\n    }\n\n    vec2 ndcpos(vec2 pos){\n        return vec2(ndcx(pos.x), ndcy(pos.y));\n    }\n\n    void main() {\n        vec2 nPos = position;\n        vec2 ntPos = tPosition;\n        if(zIndex > -0.000001){\n            nPos = npos(nPos);\n            ntPos = npos(ntPos);\n        }\n        vec2 ndcPos = ndcpos(ntPos);\n        gl_Position = vec4(ndcPos, zIndex, 1.0);\n\n        vuv = nPos;\n        vuv.y = 1.0 - vuv.y;\n    }\n",fShader:"\n    #ifdef GL_FRAGMENT_PRECISION_HIGH\n        precision highp float;\n    #else\n        precision mediump float;\n    #endif\n\n    uniform float showWire;\n    uniform vec2 size;\n    uniform sampler2D map;\n    uniform sampler2D wireMap;\n    uniform sampler2D eyeTeethMaskMap;\n    uniform sampler2D teethLut;\n    uniform float eyeIntensity;\n    uniform float teethIntensity;\n    varying vec2 vuv;\n\n    vec3 lut64(vec3 color, sampler2D lut){\n        float blue = color.b * 63.0;\n\n        vec2 q1;\n        float fb = floor(blue);\n        q1.y = floor(fb * 0.125);\n        q1.x = fb - (q1.y * 8.0);\n\n        vec2 q2;\n        float cb = ceil(blue);\n        q2.y = floor(cb * 0.125);\n        q2.x = cb - (q2.y * 8.0);\n\n        vec2 t = 0.123 * color.rg + vec2(0.000976563);\n        vec2 t1 = q1 * 0.125 + t;\n        vec3 p1 = texture2D(lut, t1).rgb;\n\n        vec2 t2 = q2 * 0.125 + t;\n        vec3 p2 = texture2D(lut, t2).rgb;\n\n        return mix(p1, p2, fract(blue));\n    }\n\n    void main() {\n        vec4 color = texture2D(map, vuv);\n        if(eyeIntensity > 0.0 || teethIntensity > 0.0){\n            vec4 eyeTeethMask = texture2D(eyeTeethMaskMap, vuv);\n            float teethInten = eyeTeethMask.r > 0.0 ? teethIntensity * eyeTeethMask.a : 0.0;\n            float eyeInten = eyeTeethMask.g > 0.0 ? eyeIntensity * eyeTeethMask.a : 0.0;\n            if(teethInten>0.0){\n                color.rgb = mix(color.rgb, lut64(color.rgb, teethLut), teethInten);\n            }\n            if(eyeInten>0.0){\n                vec2 step1 = vec2(size.x / 640.0 / size.x, 0.0);\n                vec2 step2 = vec2(0.0, size.y / 480.0 /size.y);\n                vec3 sumColor = vec3(0.0, 0.0, 0.0);\n                sumColor += texture2D(map, vuv - 2.0 * step1 - 2.0 * step2).rgb;\n                sumColor += texture2D(map, vuv - 2.0 * step1 - 1.0 * step2).rgb;\n                sumColor += texture2D(map, vuv - 2.0 * step1).rgb;\n                sumColor += texture2D(map, vuv - 2.0 * step1 + 1.0 * step2).rgb;\n                sumColor += texture2D(map, vuv - 2.0 * step1 + 2.0 * step2).rgb;\n                sumColor += texture2D(map, vuv - 1.0 * step1 - 2.0 * step2).rgb;\n                sumColor += texture2D(map, vuv - 1.0 * step1 - 1.0 * step2).rgb;\n                sumColor += texture2D(map, vuv - 1.0 * step1).rgb;\n                sumColor += texture2D(map, vuv - 1.0 * step1 + 1.0 * step2).rgb;\n                sumColor += texture2D(map, vuv - 1.0 * step1 + 2.0 * step2).rgb;\n                sumColor += texture2D(map, vuv - 2.0 * step2).rgb;\n                sumColor += texture2D(map, vuv - 1.0 * step2).rgb;\n                sumColor += texture2D(map, vuv).rgb;\n                sumColor += texture2D(map, vuv + 1.0 * step2).rgb;\n                sumColor += texture2D(map, vuv + 2.0 * step2).rgb;\n                sumColor += texture2D(map, vuv + 1.0 * step1 - 2.0 * step2).rgb;\n                sumColor += texture2D(map, vuv + 1.0 * step1 - 1.0 * step2).rgb;\n                sumColor += texture2D(map, vuv + 1.0 * step1).rgb;\n                sumColor += texture2D(map, vuv + 1.0 * step1 + 1.0 * step2).rgb;\n                sumColor += texture2D(map, vuv + 1.0 * step1 + 2.0 * step2).rgb;\n                sumColor += texture2D(map, vuv + 2.0 * step1 - 2.0 * step2).rgb;\n                sumColor += texture2D(map, vuv + 2.0 * step1 - 1.0 * step2).rgb;\n                sumColor += texture2D(map, vuv + 2.0 * step1).rgb;\n                sumColor += texture2D(map, vuv + 2.0 * step1 + 1.0 * step2).rgb;\n                sumColor += texture2D(map, vuv + 2.0 * step1 + 2.0 * step2).rgb;\n\n                sumColor = sumColor * 0.04;\n                sumColor = clamp(sumColor + (color.rgb - sumColor) * 2.0, 0.0, 1.0);\n                sumColor = max(color.rgb, sumColor);\n                color.rgb = mix(color.rgb, sumColor, eyeInten);\n                eyeInten = 1.0 + eyeInten * 0.25;\n                color.rgb = (color.rgb - vec3(0.5)) * eyeInten + vec3(0.5);\n            }\n        }\n        if(showWire > 0.5){\n            vec4 wire = texture2D(wireMap, vuv);\n            gl_FragColor = mix(color, wire, wire.a);\n        }else{\n            gl_FragColor = color;\n        }\n    }\n"}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.advBeautyWireShader=void 0,t.advBeautyWireShader={vShader:"\n    uniform vec2 size;\n\n    attribute vec2 position;\n\n    vec2 npos(vec2 pos){\n        return pos / size;\n    }\n\n    float ndcx(float x){\n        return (x - 1.0) * 2.0 + 1.0;\n    }\n\n    float ndcy(float y){\n        return (1.0 - y) * 2.0 - 1.0;\n    }\n\n    vec2 ndcpos(vec2 pos){\n        return vec2(ndcx(pos.x), ndcy(pos.y));\n    }\n\n    void main() {\n        vec2 nPos = npos(position);\n        vec2 ndcPos = ndcpos(nPos);\n        gl_Position = vec4(ndcPos, 0.0, 1.0);\n    }\n",fShader:"\n    #ifdef GL_FRAGMENT_PRECISION_HIGH\n        precision highp float;\n    #else\n        precision mediump float;\n    #endif\n    void main() {\n        gl_FragColor = vec4(0.0, 1.0, 0.0, 1.0);\n    }\n"}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.advFaceMaskShader=void 0,t.advFaceMaskShader={vShader:"\n    uniform vec2 size;\n\n    attribute vec2 tPosition;\n    attribute vec2 uv;\n    attribute float zIndex;\n\n    varying vec2 vuv;\n\n    vec2 npos(vec2 pos){\n        return pos / size;\n    }\n\n    float ndcx(float x){\n        return (x - 1.0) * 2.0 + 1.0;\n    }\n\n    float ndcy(float y){\n        return (1.0 - y) * 2.0 - 1.0;\n    }\n\n    vec2 ndcpos(vec2 pos){\n        return vec2(ndcx(pos.x), ndcy(pos.y));\n    }\n\n    void main() {\n        vec2 nPos = tPosition;\n        if(zIndex > -0.000001){\n            nPos = npos(nPos);\n        }\n        vec2 ndcPos = ndcpos(nPos);\n        gl_Position = vec4(ndcPos, zIndex, 1.0);\n        vuv = uv;\n    }\n",fShader:"\n    #ifdef GL_FRAGMENT_PRECISION_HIGH\n        precision highp float;\n    #else\n        precision mediump float;\n    #endif\n\n    uniform sampler2D map;\n    uniform sampler2D maskMap;\n    uniform int index;\n    varying vec2 vuv;\n\n    void main() {\n      vec4 color = index == 0 ? vec4(0.0) : texture2D(map, vuv);\n      vec4 mask = texture2D(maskMap, vuv);\n      float a = 1.0 - (1.0 - color.a) * (1.0 - mask.a);\n      vec3 rgb = max(color.rgb, mask.rgb);\n      gl_FragColor = vec4(rgb, a);\n    }\n"}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.handlers=t.preHandle=t.Matrix3x3=t.Vector2=void 0;class r{constructor(e,t){this.value=[0,0],this.value=[e,t]}get x(){return this.value[0]}set x(e){this.value[0]=e}get y(){return this.value[1]}set y(e){this.value[1]=e}get lengthPow2(){return Math.pow(this.x,2)+Math.pow(this.y,2)}get length(){return Math.sqrt(this.lengthPow2)}static getVec(e,t){const i=2*t;if(i<0)throw new Error("index out range");const s=i+1;if(s>=e.length)throw new Error("index out range");return new r(e[i],e[s])}static setPoint(e,t,i){const r=2*t;if(r<0)throw new Error("index out range");const s=r+1;if(s>=e.length)throw new Error("index out range");e[r]=i.value[0],e[s]=i.value[1]}static normalize(e){const t=Math.sqrt(e.value[0]*e.value[0]+e.value[1]*e.value[1]);return new r(e.value[0]/t,e.value[1]/t)}static add(e,t){return new r(e.value[0]+t.value[0],e.value[1]+t.value[1])}static sub(e,t){return new r(e.value[0]-t.value[0],e.value[1]-t.value[1])}static scale(e,t){return new r(e.value[0]*t,e.value[1]*t)}static scaleByAxis(e,t,i){return new r(e.x*t,e.y*i)}static disPow2(e,t){const i=e.value,r=t.value,s=i[0]-r[0],a=i[1]-r[1];return s*s+a*a}static dis(e,t){return Math.sqrt(r.disPow2(e,t))}static lerp(e,t,i){if(!e||!t)return e||t;const s=e.value,a=t.value;return new r(s[0]+(a[0]-s[0])*i,s[1]+(a[1]-s[1])*i)}static intersectPoint(e,t,i,s){const a=e.value,o=t.value,n=i.value,d=s.value,c=n[0]-d[0],l=a[0]-o[0],u=n[1]-d[1],h=a[1]-o[1],p=l*u-h*c;if(0==p)return null;const m=a[0]*o[1]-a[1]*o[0],f=n[0]*d[1]-n[1]*d[0];return new r((m*c-l*f)/p,(m*u-h*f)/p)}static center(...e){const t=e.length;if(!t)return new r(0,0);if(1===t)return new r(...e[0].value);if(2===t)return new r((e[0].value[0]+e[1].value[0])/2,(e[0].value[1]+e[1].value[1])/2);let i=0,s=0,a=0;for(let r=t-1,o=0;o<t;r=o,o++){const t=e[r].value,n=e[o].value,d=t[0]*n[1]-n[0]*t[1];i+=d,s+=(n[0]+t[0])*d,a+=(n[1]+t[1])*d}let o=0,n=0;return 0!=i&&(o=s/(3*i),n=a/(3*i)),new r(o,n)}static dot(e,t){return e.x*t.x+e.y*t.y}static cross(e,t){return e.x*t.y-t.x*e.y}static angle(e,t){const i=r.normalize(e),s=r.normalize(t);return Math.acos(Math.min(1,Math.max(-1,r.dot(i,s))))}static fromToAngle(e,t){return r.cross(e,t)<0?-r.angle(e,t):r.angle(e,t)}}t.Vector2=r;class s{constructor(e,t,i,r,s,a,o,n,d){this.matrix=[[e,t,i],[r,s,a],[o,n,d]]}get a(){return this.matrix[0][0]}set a(e){this.matrix[0][0]=e}get b(){return this.matrix[1][0]}set b(e){this.matrix[1][0]=e}get c(){return this.matrix[0][1]}set c(e){this.matrix[0][1]=e}get d(){return this.matrix[1][1]}set d(e){this.matrix[1][1]=e}get e(){return this.matrix[0][2]}set e(e){this.matrix[0][2]=e}get f(){return this.matrix[1][2]}set f(e){this.matrix[1][2]=e}get transpose(){let e=this.matrix;return new s(e[0][0],e[1][0],e[2][0],e[0][1],e[1][1],e[2][1],e[0][2],e[1][2],e[2][2])}multiplyPoint(e){let t=e.x,i=e.y,s=t*this.matrix[0][0]+i*this.matrix[0][1]+this.matrix[0][2],a=t*this.matrix[1][0]+i*this.matrix[1][1]+this.matrix[1][2],o=t*this.matrix[2][0]+i*this.matrix[2][1]+this.matrix[2][2];return new r(s/o,a/o)}multiplyVector(e){let t=e.x,i=e.y,s=t*this.matrix[0][0]+i*this.matrix[0][1],a=t*this.matrix[1][0]+i*this.matrix[1][1];return new r(s,a)}static identity(){return new s(1,0,0,0,1,0,0,0,1)}static rotate(e,t,i){let r=Math.cos(e),a=Math.sin(e),o=s.identity();return o.matrix[0][0]=r,o.matrix[0][1]=-a,o.matrix[1][0]=a,o.matrix[1][1]=r,o.matrix[0][2]=t*(1-r)+i*a,o.matrix[1][2]=i*(1-r)-t*a,o}static scaleByNormal(e,t,i,a){e=r.normalize(e);let o=1+(t-1)*Math.pow(e.x,2),n=(t-1)*e.x*e.y,d=1+(t-1)*Math.pow(e.y,2);return new s(o,n,(1-o)*i-n*a,n,d,(1-d)*a-n*i,0,0,1)}}t.Matrix3x3=s;let a,o,n=!0;t.preHandle=e=>{a=r.getVec(e,74),o=r.getVec(e,77)},t.handlers={eyeAngle:(e,t)=>{const i=.06*(t-.5)*Math.PI,n=s.rotate(i,a.x,a.y);[52,53,54,55,56,57,72,73].forEach(t=>{const i=n.multiplyPoint(r.getVec(e,t));r.setPoint(e,t,i)});const d=s.rotate(-i,o.x,o.y);[58,59,60,61,62,63,75,76].forEach(t=>{const i=d.multiplyPoint(r.getVec(e,t));r.setPoint(e,t,i)})},openCanthus:(e,t)=>{t*=.05;const i=r.getVec(e,43),s=r.getVec(e,46);let a=r.getVec(e,55),o=r.getVec(e,58);const n=r.intersectPoint(i,s,a,o)||i;a=r.lerp(a,n,t),o=r.lerp(o,n,t),r.setPoint(e,55,a),r.setPoint(e,58,o),[54,56,59,63].forEach(i=>{let s=r.getVec(e,i);s=r.lerp(s,i<57?a:o,.05*t),r.setPoint(e,i,s)})},eyeDistance:(e,t)=>{t=.1*(t-.5);const i=r.getVec(e,43),s=r.scale(r.sub(a,i),t),n=r.scale(r.sub(o,i),t);[52,53,54,55,56,57,72,73,74].forEach(t=>{const i=r.add(r.getVec(e,t),s);r.setPoint(e,t,i)}),[58,59,60,61,62,63,75,76,77].forEach(t=>{const i=r.add(r.getVec(e,t),n);r.setPoint(e,t,i)}),a=r.getVec(e,74),o=r.getVec(e,77)},roundedEye:(e,t)=>(n=!1,a=r.center(...[52,53,54,55,56,57,72,73].map(t=>r.getVec(e,t))),o=r.center(...[58,59,60,61,62,63,75,76].map(t=>r.getVec(e,t))),{lEyeCenter:a,rEyeCenter:o}),enlargeEye:(e,t)=>(n?(a=r.center(...[52,53,54,55,56,57,72,73].map(t=>r.getVec(e,t))),o=r.center(...[58,59,60,61,62,63,75,76].map(t=>r.getVec(e,t)))):n=!0,{lEyeCenter:a,rEyeCenter:o}),shrinkNose:(e,t)=>{t*=.15;const i=r.getVec(e,46);[80,81,82,83].forEach(s=>{r.setPoint(e,s,r.lerp(r.getVec(e,s),i,t))});const s=r.getVec(e,49);[47,51].forEach(i=>{r.setPoint(e,i,r.lerp(r.getVec(e,i),s,t))})},lengthenNose:(e,t)=>{t=.25*(t-.5);const i=[80,81,82,83,47,51],s=r.getVec(e,46),a=[];i.forEach(t=>{a.push(r.sub(r.getVec(e,t),s))});const o=r.getVec(e,49),n=r.lerp(o,r.getVec(e,87),t);r.setPoint(e,49,n);const d=r.sub(n,o),c=r.add(s,d);r.setPoint(e,46,c),a.forEach((t,s)=>{const a=r.add(c,t);r.setPoint(e,i[s],a)})},shrinkMouth:(e,t)=>{const i=1+.25*(t-=.65),s=1+.2*t,a=[1,.7,.2,0,.2,.7,1,.66,.33,0,.33,.66],o=[1,.66,0,.66,1,.66,0,.66],n=[84,85,86,87,88,89,90,91,92,93,94,95],d=[96,97,98,99,100,101,102,103],c=[],l=[];n.forEach(t=>{c.push(r.getVec(e,t))}),d.forEach(t=>{l.push(r.getVec(e,t))});const u=r.center(...c);c.forEach((t,o)=>{const d=a[o],c=i*d+s*(1-d);r.setPoint(e,n[o],r.add(u,r.scale(r.sub(t,u),c)))}),l.forEach((t,a)=>{const n=o[a],c=i*n+s*(1-n);r.setPoint(e,d[a],r.add(u,r.scale(r.sub(t,u),c)))})},widenMouth:(e,t)=>{t-=.5,t*=t<0?.3:.2;const i=r.getVec(e,90),a=r.getVec(e,84),o=r.getVec(e,87),n=r.getVec(e,93),d=r.intersectPoint(i,a,o,n)||r.center(o,n),c=s.scaleByNormal(r.sub(d,a),t+1,d.x,d.y),l=s.scaleByNormal(r.sub(d,i),t+1,d.x,d.y);[84,96,85,95,97,103,86,94].forEach(t=>{r.setPoint(e,t,c.multiplyPoint(r.getVec(e,t)))}),[90,100,89,91,99,101,88,92].forEach(t=>{r.setPoint(e,t,l.multiplyPoint(r.getVec(e,t)))})},mouthCorners:(e,t)=>{const i=.06*(t-.5)*Math.PI,a=r.center(...[84,85,86,87,88,89,90,91,92,93,94,95].map(t=>r.getVec(e,t)));let o=s.rotate(i,a.value[0],a.value[1]),n=s.rotate(.66*i,a.value[0],a.value[1]),d=s.rotate(.33*i,a.value[0],a.value[1]),c=s.rotate(.1*i,a.value[0],a.value[1]),l=[o,n,c,d,n,o,n,n];[84,85,86,94,95,96,97,103].forEach((t,i)=>{const s=l[i].multiplyPoint(r.getVec(e,t));r.setPoint(e,t,s)}),o=s.rotate(-i,a.value[0],a.value[1]),n=s.rotate(.66*-i,a.value[0],a.value[1]),d=s.rotate(.33*-i,a.value[0],a.value[1]),c=s.rotate(.1*-i,a.value[0],a.value[1]),l=[o,n,c,d,n,o,n,n],[90,89,88,92,91,100,99,101].forEach((t,i)=>{const s=l[i].multiplyPoint(r.getVec(e,t));r.setPoint(e,t,s)})},adjustPhiltrum:(e,t)=>{t=.25*(t-.5);const i=r.getVec(e,87),s=r.scale(r.sub(r.getVec(e,49),i),t);for(let t=84;t<104;t++)r.setPoint(e,t,r.add(r.getVec(e,t),s))},shrinkUnderjaw:(e,t)=>{const i=t*=.1,s=t,a=r.getVec(e,16),o=r.getVec(e,49),n=r.getVec(e,0),d=r.getVec(e,32),c=[[6,26],[8,24],[10,22],[12,20],[14,18]],l=[],u=[],h=[];c.forEach(t=>{const i=r.getVec(e,t[0]),s=r.getVec(e,t[1]);l.push([i,s]),u.push(r.intersectPoint(i,o,n,a)),h.push(r.intersectPoint(s,o,d,a))});const p=[.33,.66,1,.66,.33];l.forEach((t,a)=>{const o=r.lerp(t[0],u[a],i*p[a]),n=r.lerp(t[1],h[a],s*p[a]);r.setPoint(e,c[a][0],o),r.setPoint(e,c[a][1],n)})},shrinkCheekbone:(e,t)=>{const i=t*=.08,s=t,a=r.getVec(e,43),o=r.getVec(e,49),n=[[0,32],[2,30],[4,28],[6,26],[8,24]],d=[],c=[];n.forEach(t=>{const i=r.getVec(e,t[0]),s=r.getVec(e,t[1]);d.push([i,s]),c.push(r.intersectPoint(i,s,a,o))});const l=[.33,.66,.33,.22,.11];d.forEach((t,a)=>{const o=r.lerp(t[0],c[a],i*l[a]),d=r.lerp(t[1],c[a],s*l[a]);r.setPoint(e,n[a][0],o),r.setPoint(e,n[a][1],d)})},lengthenJaw:(e,t)=>{t=.1*(.5-t);const i=r.getVec(e,16),s=r.sub(r.getVec(e,49),i),a=[.5,.5];[12,20,14,16,18].forEach((i,o)=>{r.setPoint(e,i,r.add(r.getVec(e,i),r.scale(s,t*(a[o]||1))))})},narrowedFace:(e,t)=>{const i=t*=.05,s=t,a=r.getVec(e,43),o=r.getVec(e,16),n=[.33,.66,1];[[106,111],[0,32],[2,30],[4,28],[6,26],[8,24],[10,22],[12,20],[14,18]].forEach((t,d)=>{let c=r.getVec(e,t[0]),l=r.getVec(e,t[1]),u=r.intersectPoint(c,l,a,o);const h=n[d]||1;c=r.lerp(c,u,i*h),l=r.lerp(l,u,s*h),r.setPoint(e,t[0],c),r.setPoint(e,t[1],l)})},shrinkFace:(e,t)=>{const i=t*=.1,s=t,a=r.getVec(e,43),o=r.getVec(e,16);let n=[[2,30],[4,28],[6,26],[8,24],[10,22],[12,20],[14,18]],d=[.1,.325,.55,.775,1,.9,.8,.7];n.forEach((t,n)=>{let c=r.getVec(e,t[0]),l=r.getVec(e,t[1]),u=r.intersectPoint(c,l,a,o);c=r.lerp(c,u,i*d[n]),l=r.lerp(l,u,s*d[n]),r.setPoint(e,t[0],c),r.setPoint(e,t[1],l)});const c=r.getVec(e,93);n=[[14,18],[12,20]],d=[.4,.2],n.forEach((t,a)=>{let o=r.getVec(e,t[0]),n=r.getVec(e,t[1]);o=r.lerp(o,c,i*d[a]),n=r.lerp(n,c,s*d[a]),r.setPoint(e,t[0],o),r.setPoint(e,t[1],n)}),r.setPoint(e,16,r.lerp(r.getVec(e,16),c,.6*Math.max(i,s)))},vShapedFace:(e,t)=>{const i=t*=.2,s=t,a=r.getVec(e,16),o=r.getVec(e,2),n=r.getVec(e,30),d=[[4,28],[6,26],[8,24],[10,22],[12,20],[14,18]],c=[],l=[],u=[];d.forEach(t=>{const i=r.getVec(e,t[0]),s=r.getVec(e,t[1]);c.push([i,s]),l.push(r.intersectPoint(i,s,o,a)),u.push(r.intersectPoint(s,i,n,a))});const h=[.33,.66];c.forEach((t,a)=>{const o=r.lerp(t[0],l[a],i*(h[a]||1)),n=r.lerp(t[1],u[a],s*(h[a]||1));r.setPoint(e,d[a][0],o),r.setPoint(e,d[a][1],n)})},minifyFace:(e,t)=>{t*=.1;const i=r.getVec(e,43),s=r.getVec(e,49),a=r.getVec(e,2),o=r.getVec(e,30),n=r.lerp(r.intersectPoint(i,s,a,o),i,t);let d=[.1,.25,.4,.55,.7,.85];[4,6,8,10,12,14,84,85,86,94,95,96,97,103,47,80,82].forEach((i,s)=>{const a=r.lerp(r.getVec(e,i),n,t*(d[s]||.65));r.setPoint(e,i,a)}),[28,26,24,22,20,18,88,89,90,91,92,99,100,101,51,81,83].forEach((i,s)=>{const a=r.lerp(r.getVec(e,i),n,t*(d[s]||.65));r.setPoint(e,i,a)}),d=[1],[16,93,102,98,87,49,46].forEach((i,s)=>{const a=r.lerp(r.getVec(e,i),n,t*(d[s]||.65));r.setPoint(e,i,a)})},shortenFace:(e,t)=>{t*=.1;const i=r.getVec(e,43),a=r.getVec(e,49),o=r.center(i,a)||r.getVec(e,45),n=s.scaleByNormal(r.sub(i,a),1-t,o.x,o.y);for(let t=4;t<30;t+=2)r.setPoint(e,t,n.multiplyPoint(r.getVec(e,t)));for(let t=80;t<84;t++)r.setPoint(e,t,n.multiplyPoint(r.getVec(e,t)));for(let t=46;t<52;t++)r.setPoint(e,t,n.multiplyPoint(r.getVec(e,t)));for(let t=84;t<104;t++)r.setPoint(e,t,n.multiplyPoint(r.getVec(e,t)))},whitenTeeth:(e,t)=>{let i=r.dis(r.getVec(e,98),r.getVec(e,102))/(r.dis(r.getVec(e,96),r.getVec(e,100))||1);return t*Math.max(0,Math.min(1,Math.pow(5*i,2)))}}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.BeautyFilter=void 0;const r=i(128),s=i(129),a=i(114),o=i(130),n=i(309),d=i(310),c=i(311),l=i(199),u=i(131),h={};class p extends u.Filter{constructor(e,t,i,r){super(e,t,i,r),this._smooth=0,this._whiten=0,this._redden=0,this._faceMask=null,this._featureParas={forehead:0,eyeRim:0,noseLine:0},this.featureEnable=!1,this.whitenMap=a.createTexture(e.gl,null,{flipY:!1}),this.reddenMap=a.createTexture(e.gl,null,{flipY:!1});const{programs:s,framebuffers:o}=this.initProgramsBuffers();this.programs=s,this.framebuffers=o,this.initUniforms()}initProgramsBuffers(){const e=this.renderer.gl,t=this.renderer.getSize(),i={},a={},u={blurX:{vShader:d.beautyBlurShader.vShader,fShader:d.beautyBlurShader.fShader,size:{width:t.width>>1,height:t.height>>1}},blurY:{vShader:d.beautyBlurShader.vShader,fShader:d.beautyBlurShader.fShader,size:{width:t.width>>1,height:t.height>>1}},highPass:{vShader:o.baseTextureShader.vShader,fShader:c.beautyHighPassShader.fShader,size:t},hBlurX:{vShader:d.beautyBlurShader.vShader,fShader:d.beautyBlurShader.fShader,size:t},hBlurY:{vShader:d.beautyBlurShader.vShader,fShader:d.beautyBlurShader.fShader,size:t},beauty:{vShader:o.baseTextureShader.vShader,fShader:n.beautyShader.fShader,size:t},whiten:{vShader:o.baseTextureShader.vShader,fShader:l.lutShader.fShader,size:t},redden:{vShader:o.baseTextureShader.vShader,fShader:l.lutShader.fShader,size:t}};for(const t in u){const{vShader:o,fShader:n,size:d}=u[t],c=new s.Program(e);c.setShader(o,"VERTEX"),c.setShader(n,"FRAGMENT"),c.setAttributeBuffer(this.posBuffer),c.setAttributeBuffer(this.uvBuffer),i[t]=c;const l=r.createFrameBuffer(e,d.width,d.height);a[t]=l}return{programs:i,framebuffers:a}}initUniforms(){const e=this.programs,t=this.framebuffers,i=this.map,{width:r,height:s}=this.renderer.getSize(),a=[r,s],o=[r>>1,s>>1];e.blurX.setUniform("map",i),e.blurX.setUniform("size",o),e.blurY.setUniform("map",t.blurX.targetTexture),e.blurY.setUniform("size",o),e.blurY.setUniform("isVertical",1),e.highPass.setUniform("map",i),e.highPass.setUniform("blurMap",t.blurY.targetTexture),e.hBlurX.setUniform("map",t.highPass.targetTexture),e.hBlurX.setUniform("size",a),e.hBlurY.setUniform("map",t.hBlurX.targetTexture),e.hBlurY.setUniform("size",a),e.hBlurY.setUniform("isVertical",1),e.beauty.setUniform("size",a),e.beauty.setUniform("map",i),e.beauty.setUniform("blurMap",t.blurY.targetTexture),e.beauty.setUniform("highPassMap",t.hBlurY.targetTexture),e.beauty.setUniform("intensity",0);const n=this.featureParas;for(const t in n)e.beauty.setUniform(t+"Inten",this._featureParas[t]);e.whiten.setUniform("map",i),e.whiten.setUniform("lut",this.whitenMap),e.whiten.setUniform("intensity",0),e.redden.setUniform("map",i),e.redden.setUniform("lut",this.reddenMap),e.redden.setUniform("intensity",0)}get map(){return super.map}set map(e){e!==this._map&&(this._map=e,["blurX","highPass","beauty"].forEach(e=>{this.programs[e].setUniform("map",this._map)}),this.mapChange())}setLutsSrc(e,t){const{whiten:i,redden:r}=e;let s=2;const o=[],n=()=>{s-=1,s<=0&&(null==t||t(o))};if(h.whiten){this.whitenMap.source=h.whiten,this.whitenMap.refresh();const e=this._whiten;this._whiten=0,this.whiten=e,n()}else a.retryLoadImage(i,3,e=>{h.whiten=e,this.whitenMap.source=e,this.whitenMap.refresh();const t=this._whiten;this._whiten=0,this.whiten=t,n()},()=>{o.push(i),n()});if(h.redden){this.reddenMap.source=h.redden,this.reddenMap.refresh();const e=this._redden;this._redden=0,this.redden=e,n()}else a.retryLoadImage(r,3,e=>{h.redden=e,this.reddenMap.source=e,this.reddenMap.refresh();const t=this._redden;this._redden=0,this.redden=t,n()},()=>{o.push(r),n()})}get smoothOut(){return this.smooth||this.featureEnable?this.framebuffers.beauty.targetTexture:this.map}get whitenOut(){return this.whiten?this.framebuffers.whiten.targetTexture:this.smoothOut}mapChange(){this.programs.whiten.setUniform("map",this.smoothOut),this.programs.redden.setUniform("map",this.whitenOut)}get smooth(){return this._smooth}set smooth(e){this._smooth!==e&&(this._smooth=e,this.programs.beauty.setUniform("intensity",this._smooth),this.mapChange())}get whiten(){return this._whiten}set whiten(e){this._whiten!==e&&(this._whiten=e,this.programs.whiten.setUniform("intensity",this.whitenMap&&this.whitenMap.source?this._whiten:0),this.mapChange())}get redden(){return this._redden}set redden(e){this._redden!==e&&(this._redden=e,this.programs.redden.setUniform("intensity",this.reddenMap&&this.reddenMap.source?this._redden:0))}set faceMask(e){this._faceMask!==e&&(this.programs.beauty.setUniform("maskMap",e),this.programs.beauty.setUniform("hasMask",e?1:0),this._faceMask=e)}set featureParas(e){let t=0;for(const i in e){const r=e[i];t+=r,this._featureParas[i]!==r&&(this.programs.beauty.setUniform(i+"Inten",r),this._featureParas[i]=r)}this.featureEnable=t>0,this.mapChange()}get output(){return this.redden?this.framebuffers.redden.targetTexture:this.whiten?this.framebuffers.whiten.targetTexture:this.smooth||this.featureEnable?this.framebuffers.beauty.targetTexture:super.output}updateSize(){const e=this.renderer.getSize(),t=[e.width,e.height],i=[e.width>>1,e.height>>1];["blurX","blurY"].forEach(e=>{const t=this.framebuffers[e];t.targetTexture.opts.width=i[0],t.targetTexture.opts.height=i[1],t.targetTexture.refresh();this.programs[e].setUniform("size",i)}),["highPass","hBlurX","hBlurY","beauty","whiten","redden"].forEach(e=>{const i=this.framebuffers[e];if(i.targetTexture.opts.width=t[0],i.targetTexture.opts.height=t[1],i.targetTexture.refresh(),["highPass","whiten","redden"].indexOf(e)<0){this.programs[e].setUniform("size",t)}})}render(){const e=this.renderer,{width:t,height:i}=e.getSize(),r=this.programs,s=this.framebuffers;(this.smooth||this.featureEnable)&&(e.setViewport(0,0,t>>1,i>>1),s.blurX.bind(),e.render(r.blurX),s.blurY.bind(),e.render(r.blurY),e.setViewport(0,0,t,i),s.highPass.bind(),e.render(r.highPass),s.hBlurX.bind(),e.render(r.hBlurX),s.hBlurY.bind(),e.render(r.hBlurY),s.beauty.bind(),e.render(r.beauty)),this.whiten&&(s.whiten.bind(),e.render(r.whiten)),this.redden&&(s.redden.bind(),e.render(r.redden))}destroy(){super.destroy();const e=this.renderer.gl;null==e||e.deleteTexture(this.whitenMap.glTexture),null==e||e.deleteTexture(this.reddenMap.glTexture)}}t.BeautyFilter=p},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.beautyShader=void 0,t.beautyShader={fShader:"\n    #ifdef GL_FRAGMENT_PRECISION_HIGH\n        precision highp float;\n    #else\n        precision mediump float;\n    #endif\n\n    uniform vec2 size;\n\n    uniform sampler2D map;\n    uniform sampler2D blurMap;\n    uniform sampler2D highPassMap;\n    uniform sampler2D maskMap;\n    uniform int hasMask;\n\n    // 磨皮度\n    uniform float intensity;\n    uniform float foreheadInten;\n    uniform float eyeRimInten;\n    uniform float noseLineInten;\n\n    varying vec2 vuv;\n\n    void main() {\n        vec4 originColor = texture2D(map, vuv);\n        float _intensity = intensity;\n        if(hasMask > 0){\n            vec4 mask = texture2D(maskMap, vuv);\n            float intens = max(max(mask.r * noseLineInten, mask.g * foreheadInten), mask.b * eyeRimInten);\n            if(intens > 0.0){\n              _intensity = mix(_intensity, 1.5, intens);\n            }else{\n              _intensity *= mask.a;\n            }\n        }\n        if(_intensity > 0.0){\n            vec2 stepOffset = 0.5 / size;\n            float uOffsetX = stepOffset.x;\n            float uOffsetY = stepOffset.y;\n            float strength = _intensity * 1.0;\n\n            vec4 meanColor = texture2D(blurMap, vuv);\n            vec4 varColor = texture2D(highPassMap, vuv);\n\n            float value = clamp((min(originColor.r, meanColor.r - 0.1) - 0.2) * 4.0, 0.0, 1.0);\n            float meanValue = (varColor.r + varColor.g + varColor.b) / 3.0;\n            float currentIntensity = (1.0 - meanValue / (meanValue + 0.1)) * value * strength;\n            vec3 resultColor = mix(originColor.rgb, meanColor.rgb, currentIntensity);\n            float sum = 0.25*originColor.g;\n            sum += 0.125 *texture2D(map,vec2(vuv.x-uOffsetX, vuv.y)).g;\n            sum += 0.125 *texture2D(map,vec2(vuv.x+uOffsetX, vuv.y)).g;\n            sum += 0.125 *texture2D(map,vec2(vuv.x, vuv.y-uOffsetY)).g;\n            sum += 0.125 *texture2D(map,vec2(vuv.x, vuv.y+uOffsetY)).g;\n            sum += 0.0625*texture2D(map,vec2(vuv.x+uOffsetX, vuv.y+uOffsetY)).g;\n            sum += 0.0625*texture2D(map,vec2(vuv.x+uOffsetX, vuv.y-uOffsetY)).g;\n            sum += 0.0625*texture2D(map,vec2(vuv.x-uOffsetX, vuv.y+uOffsetY)).g;\n            sum += 0.0625*texture2D(map,vec2(vuv.x-uOffsetX, vuv.y-uOffsetY)).g;\n\n            float hPass = originColor.g - sum + 0.5;\n            float flag = step(0.5, hPass);\n            vec3 color = mix(max(vec3(0.0), (2.0*hPass + resultColor - 1.0)), min(vec3(1.0), (resultColor + 2.0*hPass - 1.0)), flag);\n\n            gl_FragColor = vec4(mix(resultColor.rgb, color.rgb, _intensity), 1.0);\n        }else{\n            gl_FragColor = originColor;\n        }\n    }"}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.beautyBlurShader=void 0,t.beautyBlurShader={vShader:"\n    uniform vec2 size;\n    uniform float isVertical;\n\n    attribute vec4 position;\n    attribute vec2 uv;\n\n    varying vec2 vuv;\n    varying vec4 vTextureShift1;\n\tvarying vec4 vTextureShift2;\n\tvarying vec4 vTextureShift3;\n\tvarying vec4 vTextureShift4;\n\n    void main() {\n        gl_Position = position;\n        vuv = uv;\n        // 偏移步距\n        vec2 stepOffset = 1.0 / size;\n        if(isVertical> 0.5){\n            stepOffset.x = 0.0;\n        }else{\n            stepOffset.y = 0.0;\n        }\n\n        vTextureShift1 = vec4(uv - stepOffset, uv + stepOffset);\n\t\tvTextureShift2 = vec4(uv- 2.0 * stepOffset, uv + 2.0 * stepOffset);\n\t\tvTextureShift3 = vec4(uv - 3.0 * stepOffset, uv + 3.0 * stepOffset);\n\t\tvTextureShift4 = vec4(uv - 4.0 * stepOffset, uv + 4.0 * stepOffset);\n    }\n",fShader:"\n    #ifdef GL_FRAGMENT_PRECISION_HIGH\n        precision highp float;\n    #else\n        precision mediump float;\n    #endif\n\n    uniform sampler2D map;\n\n    varying vec2 vuv;\n    varying vec4 vTextureShift1;\n\tvarying vec4 vTextureShift2;\n\tvarying vec4 vTextureShift3;\n\tvarying vec4 vTextureShift4;\n\n    void main() {\n        vec4 color = texture2D(map, vuv);\n\n        vec3 sum = color.rgb;\n        sum += texture2D(map, vTextureShift1.xy).rgb;\n\t\tsum += texture2D(map, vTextureShift1.zw).rgb;\n\t\tsum += texture2D(map, vTextureShift2.xy).rgb;\n\t\tsum += texture2D(map, vTextureShift2.zw).rgb;\n\t\tsum += texture2D(map, vTextureShift3.xy).rgb;\n\t\tsum += texture2D(map, vTextureShift3.zw).rgb;\n\t\tsum += texture2D(map, vTextureShift4.xy).rgb;\n\t\tsum += texture2D(map, vTextureShift4.zw).rgb;\n\n        gl_FragColor = vec4(sum * 0.1111, 1.0);\n    }\n"}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.beautyHighPassShader=void 0,t.beautyHighPassShader={fShader:"\n    #ifdef GL_FRAGMENT_PRECISION_HIGH\n        precision highp float;\n    #else\n        precision mediump float;\n    #endif\n\n    uniform sampler2D map;\n    uniform sampler2D blurMap;\n\n    varying vec2 vuv;\n\n    void main() {\n        vec4 color = texture2D(map, vuv);\n        vec4 blurColor = texture2D(blurMap, vuv);\n        vec3 diffColor = (color.rgb - blurColor.rgb) * 6.0;\n        diffColor = diffColor * diffColor;\n        diffColor = min(diffColor, 1.0);\n        gl_FragColor = vec4(diffColor, 1.0);\n    }\n"}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.LutFilter=void 0;const r=i(128),s=i(129),a=i(114),o=i(130),n=i(199),d=i(131),c={};class l extends d.Filter{constructor(e,t,i,r){super(e,t,i,r),this.lutImgs={},this.curLutName=null,this.lutMap=a.createTexture(e.gl,null,{flipY:!1});const{program:s,framebuffer:o}=this.initProgramBuffer();this.programs.main=s,this.framebuffers.main=o}initProgramBuffer(){const e=this.renderer.gl,t=this.renderer.getSize(),i=new s.Program(e);i.setShader(o.baseTextureShader.vShader,"VERTEX"),i.setShader(n.lutShader.fShader,"FRAGMENT"),i.setAttributeBuffer(this.posBuffer),i.setAttributeBuffer(this.uvBuffer);const a=r.createFrameBuffer(e,t.width,t.height);return i.setUniform("map",this.map),i.setUniform("lut",this.lutMap),i.setUniform("intensity",0),{program:i,framebuffer:a}}getLutImg(e){var t;return e&&null!==(t=this.lutImgs[e])&&void 0!==t?t:null}get map(){return this._map}set map(e){this._map!==e&&(this._map=e,this.programs.main.setUniform("map",this._map))}setLutsSrc(e,t){let i=Object.keys(e).length;const r=[],s=()=>{i-=1,i<=0&&(null==t||t(r))};for(const t in e){const{src:i,intensity:o=.5}=e[t];this.lutImgs[t]={img:null,intensity:o},c[t]?(this.lutImgs[t].img=c[t],t===this.curLutName&&(this.curLutName=null,this.setlut(t)),s()):a.retryLoadImage(i,3,e=>{c[t]=e,this.lutImgs[t].img=e,t===this.curLutName&&(this.curLutName=null,this.setlut(t)),s()},()=>{r.push(i),s()})}}get output(){return this.intensity?this.framebuffers.main.targetTexture:super.output}updateSize(){const e=this.renderer.getSize(),t=this.framebuffers.main;t.targetTexture.opts.width=e.width,t.targetTexture.opts.height=e.height,t.targetTexture.refresh()}setlut(e,t){if(e!==this.curLutName){this.curLutName=e;const t=this.getLutImg(this.curLutName);t&&(this.lutMap.source=t.img,this.lutMap.refresh())}t=null!=t?t:this.intensity,this.intensity=t}get intensity(){const e=this.getLutImg(this.curLutName);return e?e.intensity:0}set intensity(e){const t=this.getLutImg(this.curLutName);t?(t.intensity=e,t.img?this.programs.main.setUniform("intensity",this.intensity):this.programs.main.setUniform("intensity",0)):this.programs.main.setUniform("intensity",0)}render(){this.intensity&&(this.framebuffers.main.bind(),this.renderer.render(this.programs.main))}destroy(){var e;super.destroy(),null===(e=this.renderer.gl)||void 0===e||e.deleteTexture(this.lutMap.glTexture)}}t.LutFilter=l},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.NormalFilter=void 0;const r=i(128),s=i(129),a=i(130),o=i(131);class n extends o.Filter{constructor(e,t,i,r){super(e,t,i,r),this._srcMap=null,this.pixels=null,this.initProgram()}initProgram(){const e=this.renderer.gl;let t=this.renderer.getSize();const i=new s.Program(e);i.setShader(a.baseTextureShader.vShader,"VERTEX"),i.setShader(a.baseTextureShader.yFlipFShader,"FRAGMENT"),i.setAttributeBuffer(this.posBuffer),i.setAttributeBuffer(this.uvBuffer);const o=r.createFrameBuffer(e,t.width,t.height);i.setUniform("map",this._srcMap),this.programs.imgData=i,this.framebuffers.imgData=o;const n=new s.Program(e);n.setShader(a.baseTextureShader.vShader,"VERTEX"),n.setShader(a.baseTextureShader.fShader,"FRAGMENT"),n.setAttributeBuffer(this.posBuffer),n.setAttributeBuffer(this.uvBuffer),n.setUniform("map",this._map),this.programs.main=n}getImageData(e){e!==this._srcMap&&(this._srcMap=e,this.programs.imgData.setUniform("map",this._srcMap)),this._srcMap&&this._srcMap.refresh();const t=this.renderer,{width:i,height:r}=t.getSize(),s=t.gl;return this.framebuffers.imgData.bind(),t.render(this.programs.imgData),this.pixels&&this.pixels.length===i*r*4||(this.pixels=new Uint8Array(i*r*4)),s.readPixels(0,0,i,r,s.RGBA,s.UNSIGNED_BYTE,this.pixels),this.framebuffers.imgData.bind(!0),this.pixels}get map(){return this._map}set map(e){this._map!==e&&(this._map=e,this.programs.main.setUniform("map",this._map))}updateSize(){const e=this.renderer.getSize(),t=this.framebuffers.imgData;t&&(t.targetTexture.opts.width=e.width,t.targetTexture.opts.height=e.height,t.targetTexture.refresh())}render(){const e=this.renderer,{width:t,height:i}=e.getSize(),r=e.gl;e.setViewport(0,0,t,i),r.bindFramebuffer(r.FRAMEBUFFER,null),e.render(this.programs.main)}}t.NormalFilter=n},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.typedArray=void 0,t.typedArray={posArray:new Int8Array([-1,1,-1,-1,1,1,1,-1]),uvArray:new Uint8Array([0,1,0,0,1,1,1,0]),advBeautyPosArray:new Int16Array((()=>{const e=[];for(let t=0;t<145;t++)e.push(0,0);return e.push(0,0,0,1,1,1,1,0),e})()),advBeautyZindexArray:new Int16Array((()=>{const e=[];for(let t=0;t<145;t++)e.push(0);return e.push(-1,-1,-1,-1),e})()),advBeautyIndicesArray:new Uint16Array([145,146,147,145,147,148,0,2,52,52,2,57,57,2,4,57,4,73,73,4,80,73,80,56,56,80,55,55,80,43,67,55,43,67,54,55,66,54,67,66,72,54,65,72,66,65,53,72,64,53,65,64,52,53,33,52,64,0,52,33,33,64,34,34,64,65,34,65,35,35,65,66,35,66,36,36,66,67,36,67,37,53,52,57,53,57,73,53,73,72,72,73,56,72,56,54,54,56,55,37,67,43,37,43,38,38,43,68,68,43,58,58,43,81,43,46,81,81,46,83,46,51,83,46,49,51,46,47,49,46,82,47,80,82,46,43,80,46,43,55,80,67,55,43,38,68,39,39,68,69,39,69,40,40,69,70,40,70,41,41,70,71,41,71,42,32,61,30,30,61,62,30,62,28,62,76,28,76,81,28,63,81,76,58,81,63,43,81,58,43,58,68,68,58,59,68,59,69,69,59,75,69,75,70,70,75,60,70,60,71,71,60,61,71,61,42,42,61,32,59,58,63,59,63,76,59,76,75,75,76,62,75,62,60,60,62,61,4,82,80,4,6,82,6,8,82,82,8,84,8,10,84,84,10,12,84,12,95,95,12,14,95,14,94,94,14,93,93,14,16,93,16,18,93,18,92,92,18,20,92,20,91,91,20,90,90,20,22,90,22,24,90,24,83,83,24,26,83,26,28,83,28,81,106,0,33,106,33,34,107,106,34,107,34,35,108,107,35,108,35,36,109,108,36,109,36,37,110,109,37,116,110,37,116,37,38,115,116,38,114,115,38,114,38,39,113,114,39,113,39,40,112,113,40,112,40,41,111,112,41,111,41,42,111,42,32,82,84,47,47,84,85,47,85,86,47,86,49,49,86,87,49,87,88,49,88,51,51,88,89,51,89,90,83,51,90,85,84,96,85,96,97,85,97,86,86,97,87,87,97,98,87,98,99,87,99,88,88,99,89,89,99,100,89,100,90,100,91,90,101,91,100,101,92,91,102,92,101,102,93,92,102,94,93,103,94,102,103,95,94,96,95,103,84,95,96,96,103,97,97,103,102,97,102,98,98,102,99,99,102,101,99,101,100,0,117,118,0,118,2,2,118,119,2,119,4,4,119,120,4,120,6,6,120,121,6,121,8,8,121,122,8,122,10,10,122,123,10,123,12,12,123,124,12,124,14,14,124,125,14,125,16,16,125,126,16,126,18,18,126,127,18,127,20,20,127,128,20,128,22,22,128,129,22,129,24,24,129,130,24,130,26,26,130,131,26,131,28,28,131,132,28,132,30,30,132,133,30,133,32,106,134,117,106,117,0,107,135,134,107,134,106,108,136,135,108,135,107,109,137,136,109,136,108,110,138,137,110,137,109,116,144,138,116,138,110,115,143,144,115,144,116,114,142,143,114,143,115,113,141,142,113,142,114,112,140,141,112,141,113,111,139,140,111,140,112,32,133,139,32,139,111]),advFaceMaskUVArray:new Float32Array([.30859375,.58203125,.30859375,.5546875,.310546875,.52734375,.3125,.5,.314453125,.47265625,.318359375,.4453125,.322265625,.41796875,.330078125,.392578125,.337890625,.369140625,.349609375,.34765625,.365234375,.328125,.380859375,.310546875,.400390625,.296875,.419921875,.28515625,.44140625,.27734375,.46484375,.271484375,.486328125,.26953125,.509765625,.271484375,.533203125,.275390625,.5546875,.283203125,.578125,.29296875,.59765625,.306640625,.6171875,.32421875,.634765625,.341796875,.650390625,.36328125,.662109375,.388671875,.669921875,.4140625,.67578125,.44140625,.6796875,.46875,.68359375,.49609375,.685546875,.525390625,.6875,.552734375,.6875,.580078125,.33984375,.634765625,.36328125,.66796875,.392578125,.673828125,.421875,.671875,.451171875,.6640625,.521484375,.666015625,.55078125,.671875,.58203125,.673828125,.611328125,.666015625,.63671875,.634765625,.486328125,.60546875,.484375,.568359375,.482421875,.533203125,.482421875,.498046875,.443359375,.47265625,.462890625,.46875,.484375,.46484375,.505859375,.470703125,.52734375,.474609375,.369140625,.599609375,.384765625,.611328125,.421875,.611328125,.4375,.59765625,.419921875,.591796875,.384765625,.591796875,.537109375,.59765625,.552734375,.611328125,.591796875,.611328125,.607421875,.59765625,.591796875,.591796875,.5546875,.591796875,.36328125,.646484375,.392578125,.650390625,.421875,.6484375,.451171875,.642578125,.521484375,.642578125,.55078125,.6484375,.580078125,.6484375,.611328125,.64453125,.40234375,.615234375,.400390625,.58984375,.40234375,.6015625,.57421875,.615234375,.57421875,.58984375,.572265625,.6015625,.4609375,.6015625,.51171875,.6015625,.443359375,.521484375,.5234375,.5234375,.431640625,.490234375,.537109375,.4921875,.416015625,.392578125,.44140625,.41796875,.470703125,.427734375,.486328125,.427734375,.5,.4296875,.53125,.419921875,.55859375,.39453125,.537109375,.375,.51171875,.36328125,.484375,.361328125,.4609375,.36328125,.4375,.375,.421875,.392578125,.453125,.408203125,.484375,.412109375,.51953125,.41015625,.552734375,.39453125,.51953125,.388671875,.484375,.38671875,.453125,.38671875,.40234375,.599609375,.57421875,.599609375,.3046875,.634765625,.31640625,.685546875,.341796875,.734375,.380859375,.7734375,.431640625,.802734375,.6875,.638671875,.671875,.693359375,.642578125,.7421875,.599609375,.78125,.546875,.806640625,.48828125,.81640625,.25390625,.576171875,.2578125,.50390625,.26171875,.43359375,.271484375,.36328125,.29296875,.298828125,.328125,.24609375,.373046875,.205078125,.427734375,.1796875,.486328125,.169921875,.546875,.177734375,.60546875,.19921875,.65625,.240234375,.69921875,.291015625,.724609375,.357421875,.736328125,.427734375,.744140625,.501953125,.74609375,.57421875,.25,.64453125,.263671875,.7109375,.296875,.7734375,.34765625,.82421875,.4140625,.86328125,.74609375,.650390625,.7265625,.720703125,.689453125,.783203125,.6328125,.833984375,.564453125,.8671875,.48828125,.880859375,0,0,0,0,0,0,0,0]),advEyeTeethPosArray:new Int16Array(48),advEyeTeethZindexArray:new Int16Array(24),advEyeTeethUVArray:new Float32Array([.927,.789,.772,.877,.49,.91,.269,.872,.078,.764,.272,.61,.506,.559,.738,.611,.927,.789,.772,.877,.49,.91,.269,.872,.078,.764,.272,.61,.506,.559,.738,.611,.067,.28,.267,.389,.512,.364,.754,.389,.933,.29,.76,.159,.497,.112,.243,.156]),advEyeTeethIndicesArray:new Uint16Array([1,0,7,1,7,6,1,6,2,2,6,5,2,5,3,3,5,4,11,12,13,11,13,14,11,14,10,10,14,15,10,15,9,9,15,8,16,23,17,17,23,22,17,22,18,18,22,19,19,22,21,19,21,20]),advForeheadPosArray:new Int16Array(98),advForeheadZindexArray:new Int16Array(49),advForeheadUVArray:new Float32Array([.12,.564,.181,.619,.26,.628,.341,.616,.41,.592,.597,.592,.666,.616,.747,.628,.827,.619,.887,.564,.051,.638,.101,.753,.154,.853,.236,.933,.355,.955,.504,.956,.652,.955,.771,.933,.853,.853,.907,.753,.956,.638,.155,.266,.281,.306,.441,.371,.598,.395,.694,.334,.763,.247,.134,.379,.242,.427,.401,.49,.604,.522,.749,.455,.87,.3,.306,.251,.397,.232,.497,.217,.593,.23,.673,.262,.356,.104,.491,.024,.652,.11,.306,.251,.397,.232,.497,.217,.593,.23,.673,.262,.356,.104,.491,.024,.652,.11]),advForeheadIndicesArray:new Uint16Array([18,0,1,11,18,1,11,1,2,12,11,2,12,2,3,13,12,3,13,3,4,14,13,4,14,4,15,15,4,5,16,15,5,17,16,5,17,5,6,17,6,18,18,6,7,19,18,7,19,7,8,20,19,8,20,8,9,27,21,28,28,21,22,29,28,22,29,22,23,30,29,23,30,23,24,31,30,24,31,24,25,32,31,25,32,25,26])}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.VirtualBackFilter=void 0;const r=i(128),s=i(316),a=i(129),o=i(114),n=i(130),d=i(317),c=i(318),l=i(131);class u extends l.Filter{constructor(e,t,i,r){super(e,t,i,r),this.intensity=.1,this.lastSetInfo={},this.sourceMap=t,this.maskMap=o.createTexture(e.gl,null),this.bkColor=new s.GlColor("#e7ad3c"),this.bkMap=o.createTexture(e.gl,null),this.initProgramBuffer()}initProgramBuffer(){const e=this.renderer.gl,t=this.renderer.getSize(),i=[o.toNthPower(t.width),o.toNthPower(t.height)],s=new a.Program(e);s.setShader(n.baseTextureShader.vShader,"VERTEX"),s.setShader(n.baseTextureShader.fShader,"FRAGMENT"),s.setAttributeBuffer(this.posBuffer),s.setAttributeBuffer(this.uvBuffer);const l=r.createFrameBuffer(e,i[0],i[1],!0);s.setUniform("map",this.sourceMap),this.programs.mip=s,this.framebuffers.mip=l;const u=new a.Program(e);u.setShader(n.baseTextureShader.vShader,"VERTEX"),u.setShader(d.mipMapBlurShader.fShader,"FRAGMENT"),u.setAttributeBuffer(this.posBuffer),u.setAttributeBuffer(this.uvBuffer);const h=r.createFrameBuffer(e,t.width,t.height);u.setUniform("map",l.targetTexture),u.setUniform("radius",.25*Math.max(t.width,t.height)),u.setUniform("intensity",.1),this.programs.blur=u,this.framebuffers.blur=h;const p=new a.Program(e);p.setShader(n.baseTextureShader.vShader,"VERTEX"),p.setShader(c.virtualBackShader.fShader,"FRAGMENT"),p.setAttributeBuffer(this.posBuffer),p.setAttributeBuffer(this.uvBuffer);const m=r.createFrameBuffer(e,t.width,t.height);p.setUniform("map",this.map),p.setUniform("maskMap",this.maskMap),p.setUniform("backColor",this.bkColor.value),p.setUniform("backMap",this.bkMap),p.setUniform("size",[t.width,t.height]),p.setUniform("bkSize",[0,0]),p.setUniform("backType",0),p.setUniform("emptyFrame",0),this.programs.main=p,this.framebuffers.main=m}get map(){return this._map}set map(e){this._map!==e&&(this._map=e,this.programs.main.setUniform("map",this._map))}set emptyFrame(e){this.programs.main.setUniform("emptyFrame",e?1:0)}setMaskMap(e){const t=this.maskMap;t&&(t.source=e,t.refresh())}setBkColor(e){this.bkColor.setValue(e||"#e7ad3c"),this.programs.main.setUniform("backColor",this.bkColor.value)}getBkInfo(){const e=this.bkMap,t=e?e.source:null,i={type:"color",size:[0,0]};return t&&("videoWidth"in t?(i.type="video",i.size=[t.videoWidth,t.videoHeight]):t instanceof Image&&(i.type="image",i.size=[t.naturalWidth,t.naturalHeight])),i}setBkMap(e){const t=this.bkMap;t&&(e instanceof Image||null===e?(t.source=e,t.refresh()):"readyState"in e&&(e.readyState<2?setTimeout(()=>{this.setBkMap(e)},16.7):(t.source=e,t.refresh())))}setBackground(e){const t=typeof e;"string"===t||null===e?(this.setBkColor(e),this.setBkMap(null)):"object"===t&&(this.setBkColor(null),this.setBkMap(e));const i=this.getBkInfo();this.programs.main.setUniform("backType","color"===i.type?0:1),"color"!==i.type&&(this.programs.main.setUniform("backMap",this.bkMap),this.programs.main.setUniform("bkSize",i.size)),this.lastSetInfo={type:"bk",value:e}}setBlurIntensity(e){const t=this.renderer.getSize();e=Math.max(.1,Math.min(1,e)),this.programs.blur.setUniform("intensity",e),this.programs.main.setUniform("backMap",this.framebuffers.blur.targetTexture),this.programs.main.setUniform("bkSize",[t.width,t.height]),this.programs.main.setUniform("backType",1),this.lastSetInfo={type:"blur",value:e}}get output(){return this.maskMap&&this.maskMap.source?this.framebuffers.main.targetTexture:super.output}updateSize(){const e=this.renderer.getSize(),t=[o.toNthPower(e.width),o.toNthPower(e.height)];["blur","main"].forEach(t=>{const i=this.framebuffers[t];i.targetTexture.opts.width=e.width,i.targetTexture.opts.height=e.height,i.targetTexture.refresh()});const i=this.framebuffers.mip;i.targetTexture.opts.width=t[0],i.targetTexture.opts.height=t[1],i.targetTexture.refresh(),this.programs.main.setUniform("size",[e.width,e.height]),this.programs.blur.setUniform("radius",.25*Math.max(e.width,e.height)),this.programs.main.getUniform("backMap").value===i.targetTexture&&this.programs.main.setUniform("bkSize",t)}render(){var e;if(this.maskMap&&this.maskMap.source){const t=this.renderer;if(this.programs.main.getUniform("backMap").value===this.framebuffers.blur.targetTexture){const e=t.getSize(),i=this.framebuffers.mip.targetTexture;t.setViewport(0,0,i.opts.width,i.opts.height),this.framebuffers.mip.bind(),this.programs.mip.render(),this.framebuffers.mip.targetTexture.updateMipMap(),t.setViewport(0,0,e.width,e.height),this.framebuffers.blur.bind(),this.programs.blur.render()}else{"video"===this.getBkInfo().type&&(null===(e=this.bkMap)||void 0===e||e.refresh())}this.framebuffers.main.bind(),this.programs.main.render()}}destroy(){var e,t;super.destroy(),null===(e=this.renderer.gl)||void 0===e||e.deleteTexture(this.maskMap.glTexture),null===(t=this.renderer.gl)||void 0===t||t.deleteTexture(this.bkMap.glTexture)}}t.VirtualBackFilter=u},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.GlColor=void 0;t.GlColor=class{constructor(e){this._color=[1,1,1,1],this.convert(e)}convert(e){if("string"==typeof e){if(/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/i.test(e)){if(4===e.length){let t="#";for(let i=1;i<4;i+=1)t+=e.slice(i,i+1).concat(e.slice(i,i+1));e=t}const t=[];for(let i=1;i<7;i+=2)t.push(parseInt("0x"+e.slice(i,i+2)));return void this.convert(t)}console.error(`color:[${e}] format is error.`)}else this._color=e.map((e,t)=>t<3?Math.min(Math.max(Number(e),0),255)/255:Math.min(Math.max(Number(Number(null!=e?e:1)),0),1))}get value(){return this._color}setValue(e){this.convert(e)}}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.mipMapBlurShader=void 0,t.mipMapBlurShader={fShader:"\n    #ifdef GL_FRAGMENT_PRECISION_HIGH\n        precision highp float;\n    #else\n        precision mediump float;\n    #endif\n\n    uniform sampler2D map;\n    uniform float intensity;\n    uniform float radius;\n    varying vec2 vuv;\n\n    float weight(float t, float log2radius, float gamma)\n    {\n        return exp(-gamma*pow(log2radius-t,2.));\n    }\n\n    vec3 sample_blured(vec2 uv, float radius, float gamma)\n    {\n        vec3 pix = vec3(0.);\n        float norm = 0.;\n        for(float i = 0.; i < 10.; i += 0.5)\n        {\n            float k = weight(i, log2(radius), gamma);\n            pix += k * texture2D(map, uv, i).rgb;\n            norm += k;\n        }\n        return pix*pow(norm,-0.95);\n    }\n\n    void main() {\n        gl_FragColor = vec4(sample_blured(vuv, mix(8.0, radius, intensity), intensity), 1.0);\n    }\n"}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.virtualBackShader=void 0,t.virtualBackShader={fShader:"\n    #ifdef GL_FRAGMENT_PRECISION_HIGH\n        precision highp float;\n    #else\n        precision mediump float;\n    #endif\n\n    uniform sampler2D map;\n    uniform sampler2D maskMap;\n    uniform sampler2D backMap;\n    uniform vec3 backColor;\n    uniform vec2 size;\n    uniform vec2 bkSize;\n    uniform int backType;\n    uniform int emptyFrame;\n\n    varying vec2 vuv;\n\n    void main() {\n        if(emptyFrame > 0){\n            gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n        }else{\n            vec3 color = texture2D(map, vuv).rgb;\n            float alpha = texture2D(maskMap, vuv).a;\n\n            vec3 bk = backColor;\n            // 背景图\n            if(backType == 1){\n                float ratio = size.x / size.y;\n                float bkRatio = bkSize.x / bkSize.y;\n                vec2 suv = vuv;\n                if(ratio > bkRatio){\n                    suv.y = (suv.y - 0.5) * bkRatio / ratio + 0.5;\n                }else{\n                    suv.x = (suv.x - 0.5) * ratio / bkRatio + 0.5;\n                }\n                bk = texture2D(backMap, suv).rgb;\n            }\n\n            gl_FragColor = vec4(mix(bk, color, alpha), 1.0);\n        }\n    }\n"}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0});const r=i(13),s=i(198);class a extends r.EventEmitter{constructor(e){var t;super(),this.setAdvEffect=(...e)=>{var t;this.videPostProcess.availableCode<1||(this.logger.log(`set advbeauty effect：[${e[0]}, ${e[1]}]`),null===(t=this.videPostProcess.filters)||void 0===t||t.advBeauty.setAdvEffect(...e))},this.presetAdvEffect=(...e)=>{var t;this.videPostProcess.availableCode<1||(this.logger.log("preset advbeauty effect："+JSON.stringify(e[0])),null===(t=this.videPostProcess.filters)||void 0===t||t.advBeauty.presetAdvEffect(...e))},this.videPostProcess=e,null===(t=this.videPostProcess.filters)||void 0===t||t.advBeauty.on("advBeautyResComplete",e=>{this.videPostProcess.emit("advBeautyResComplete",e)})}get advancedBeautyProcess(){const e=this.videPostProcess.getPlugin("AdvancedBeauty");return e||this.logger.error("Can not get AdvancedBeauty plugin"),e}init(e){this.videPostProcess.availableCode<1||(this.advancedBeautyProcess.on("facePoints-load",()=>{this.emit("facePoints-load"),this.advancedBeautyProcess.setFaceSize(Math.min(5,Math.max(1,e||1)))}),this.advancedBeautyProcess.init())}destroy(){this.videPostProcess.availableCode<1||(this.advancedBeautyProcess.removeAllListeners(),this.advancedBeautyProcess.destroy())}get logger(){return this.videPostProcess.logger}setTrack(e,t){var i;return e&&a.configStaticRes(s.resSet,null===(i=this.videPostProcess.filters)||void 0===i?void 0:i.advBeauty),new Promise((i,r)=>{this.videPostProcess.setTaskAndTrack("AdvancedBeauty",e,t).then(t=>{var r;e||null===(r=this.videPostProcess.filters)||void 0===r||r.advBeauty.setAdvData([]),i(t)}).catch(e=>{r(e)})})}get isEnable(){return this.videPostProcess.hasTask("AdvancedBeauty")}}t.default=a,a.configStaticRes=(e,t)=>{s.AdvBeautyFilter.configStaticRes(e,t)}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0});const r={beauty:{whiten:"https://yx-web-nosdn.netease.im/common/cab8e4f0696d3d8e29ee10d6dccc1204/meibai.png",redden:"https://yx-web-nosdn.netease.im/common/c614e2af82da88807067926d7ff3be3d/hongrun.png"},filters:{ziran:{src:"https://yx-web-nosdn.netease.im/common/c89328281947fceabdc71d5fa08b2345/ziran.png",intensity:1},baixi:{src:"https://yx-web-nosdn.netease.im/common/3a22a55384b0bd5b07fca3509bfc981a/baixi.png",intensity:.5},fennen:{src:"https://yx-web-nosdn.netease.im/common/db5befdae1f46dad2e5a6d702bad19ea/fennen.png",intensity:.5},weimei:{src:"https://yx-web-nosdn.netease.im/common/cf8bfec70d7998bb0033757276c6559a/weimei.png",intensity:.5},langman:{src:"https://yx-web-nosdn.netease.im/common/1c50a14532bfa3ad503a82ddd13f0ec8/langman.png",intensity:.5},rixi:{src:"https://yx-web-nosdn.netease.im/common/c414819383913b5db0d9b686276e3d57/rixi.png",intensity:.5},landiao:{src:"https://yx-web-nosdn.netease.im/common/4c77522852dc14448603be21abc571c8/landiao.png",intensity:.5},qingliang:{src:"https://yx-web-nosdn.netease.im/common/1150e94f831d24148239001588a7ca7d/qingliang.png",intensity:.5},huaijiu:{src:"https://yx-web-nosdn.netease.im/common/6a38caeab164d1b5cc086391d6a11a74/huaijiu.png",intensity:.5},qingcheng:{src:"https://yx-web-nosdn.netease.im/common/3b3332c5ae4306312b6f3c4c552a464a/qingcheng.png",intensity:1},wuhou:{src:"https://yx-web-nosdn.netease.im/common/200fc7a12177774f4eb23f55d72643ee/wuhou.png",intensity:1},zhigan:{src:"https://yx-web-nosdn.netease.im/common/848bd44506cf8e10ecabf564e3d74809/zhigan.png",intensity:1},mopian:{src:"https://yx-web-nosdn.netease.im/common/c454efa119520f0793ce51327951ed0a/mopian.png",intensity:1},dianying:{src:"https://yx-web-nosdn.netease.im/common/3a6a22adad29c5844fc829f4f889a79f/dianying.png",intensity:1},heibai:{src:"https://yx-web-nosdn.netease.im/common/941270f2948218ea19f2d79db5e7d349/heibai.png",intensity:1}}},s=new Set;t.default=class{constructor(e){this.lutLoaded=!1,this.videPostProcess=e,this.videPostProcess.on("contextLost",()=>{this.lutLoaded=!1}),s.add(this)}startLut(){if(this.lutLoaded)return;const e=this.videPostProcess.filters;if(!e)return;let t=2;const i=[],s=()=>{t-=1,t<=0&&this.videPostProcess.emit("beautyResComplete",i)};e.beauty.setLutsSrc(r.beauty,e=>{i.push(...e),s()}),e.lut.setLutsSrc(r.filters,e=>{i.push(...e),s()}),this.lutLoaded=!0}setFilter(e,t){var i;null===(i=this.videPostProcess.filters)||void 0===i||i.lut.setlut(e,t)}setBeauty(e,t){return e&&this.startLut(),new Promise((i,r)=>{this.videPostProcess.setTaskAndTrack("BasicBeauty",e,t).then(t=>{if(!e){const e=this.videPostProcess.filters;if(!e)return;e.beauty.whiten=0,e.beauty.redden=0,e.beauty.smooth=0,e.lut.setlut(null)}i(t)}).catch(e=>{r(e)})})}setBeautyOptions(e){const t=this.videPostProcess.filters;t&&("smoothnessLevel"in e&&(t.beauty.smooth=e.smoothnessLevel),"brightnessLevel"in e&&(t.beauty.whiten=e.brightnessLevel),"rednessLevel"in e&&(t.beauty.redden=e.rednessLevel))}get isEnable(){return this.videPostProcess.hasTask("BasicBeauty")}static configStaticRes(e){let t=!1;e.beauty&&(r.beauty=Object.assign({},e.beauty),t=!0),e.filters&&(r.filters=Object.assign({},e.filters),t=!0),t&&s.forEach(e=>{try{e.lutLoaded=!1,e.startLut()}catch(e){}})}}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0});const r=i(13),s=i(114);class a extends r.EventEmitter{constructor(e){super(),this.bgOption={type:"color",color:"#e7ad3c"},this.videPostProcess=e}get segmentProcess(){return this.videPostProcess.getPlugin("VirtualBackground")}init(){this.segmentProcess.on("segment-load",()=>{this.emit("segment-load")}),this.segmentProcess.init()}destroy(){this.segmentProcess.removeAllListeners(),this.segmentProcess.destroy()}setVirtualBackGround(e){this.bgOption=e;const{type:t}=e;switch(t){case"image":const{source:t}=e;if("object"==typeof t)this.setBackGround(t);else if("string"==typeof t)if(t.includes("data:image")){const e=new Image;e.onload=()=>{this.setBackGround(e)},e.src=t}else if(t.includes("http"))s.loadImage(t,e=>{this.setBackGround(e)});else{const e=new Image;e.onload=()=>{this.setBackGround(e)},e.src=t}break;case"color":this.setBackGround(e.color);break;case"blur":this.setBlurIntensity(e.level/10)}}setTrack(e,t){return new Promise((i,r)=>{this.videPostProcess.setTaskAndTrack("VirtualBackground",e,t).then(t=>{var r;e||null===(r=this.videPostProcess.filters)||void 0===r||r.virtualBackground.setMaskMap(null),i(t)}).catch(e=>{r(e)})})}setBackGround(e){var t;null===(t=this.videPostProcess.filters)||void 0===t||t.virtualBackground.setBackground(e)}setBlurIntensity(e){var t;null===(t=this.videPostProcess.filters)||void 0===t||t.virtualBackground.setBlurIntensity(e)}get isEnable(){return this.videPostProcess.hasTask("VirtualBackground")}set emptyFrame(e){this.videPostProcess.filters.virtualBackground.emptyFrame=e}}t.default=a},function(e,t,i){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.loadPlugin=void 0;const s=r(i(200));t.loadPlugin=function(e,t){return new Promise((i,r)=>{-1==s.default.indexOf(e)&&r("unsupport plugin "+e);const a=document.createElement("script");a.defer=!0,a.src=t,document.body.appendChild(a),a.onload=function(){i()},a.onerror=function(e){r(`Load plugin ${t} error`)}})}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.applyResolution=void 0,t.applyResolution=async function(e){const{track:t,targetWidth:i,targetHeight:r,keepAspectRatio:s,logger:a}=e,o=t.getSettings();if(o.width&&o.height)if(o.width!==i||o.height!==r){let e;s?(e={aspectRatio:o.width/o.height},o.width/o.height>=i/r?e.width=i:e.height=r):e={width:i,height:r},await t.applyConstraints(e),await new Promise(e=>{setTimeout(e,100)});const n=t.getSettings();o.width!==n.width||o.height!==n.height?a.log(`applyResolution 成功修改分辨率 保留长宽比：${s} ${o.width}x${o.height} => ${n.width}x${n.height} (constraints: ${JSON.stringify(e)})【${t.label}】`):a.warn(`applyResolution 无法修改分辨率为${i}x${r}，目前的分辨率：${o.width}x${o.height} (constraints: ${JSON.stringify(e)})【${t.label}】`)}else a.log(`applyResolution 无需修改分辨率 ${o.width}x${o.height} 【${t.label}】`);else a.log(`applyResolution 摄像头不支持动态修改分辨率 【${t.label}】`)}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.serverError=t.clientNotYetPublished=t.STREAM_HAS_NO_MEDIA_ATTRIBUTES=t.clientNotYetUninitialized=t.invalidArguments=t.ok=void 0,t.ok={name:"OK",code:200,desc:"success"},t.invalidArguments={name:"invalid arguments",code:1,desc:"请检查参数的有效性"},t.clientNotYetUninitialized={name:"client not yet uninitialized",code:2,desc:"请先调用createClient创建Client"},t.STREAM_HAS_NO_MEDIA_ATTRIBUTES={name:"STREAM_HAS_NO_MEDIA_ATTRIBUTES",code:10,desc:"stream不合法，没有audio、video或者screen属性"},t.clientNotYetPublished={name:"client not yet published",code:11,desc:"请先publish"},t.serverError={name:"server error code",code:414,desc:""}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.LIVE_STREAM_AUDIO_CODEC_PROFILE=t.LIVE_STREAM_AUDIO_SAMPLE_RATE=void 0,t.LIVE_STREAM_AUDIO_SAMPLE_RATE={SAMPLE_RATE_32000:32e3,SAMPLE_RATE_44100:44100,SAMPLE_RATE_48000:48e3},t.LIVE_STREAM_AUDIO_CODEC_PROFILE={LC_AAC:0,HE_AAC:1}},function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.NETWORK_STATUS=void 0,t.NETWORK_STATUS={0:"UNKNOWN",1:"EXCELLENT",2:"GOOD",3:"POOR",4:"BAD",5:"VERYBAD",6:"DOWN"}}])}));
}, function(modId) {var map = {}; return __REQUIRE__(map[modId], modId); })
return __REQUIRE__(1670910583241);
})()
//miniprogram-npm-outsideDeps=[]
//# sourceMappingURL=index.js.map